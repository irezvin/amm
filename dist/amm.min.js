Amm={id:"amm",domHolderAttribute:"data-amm-iid",_counter:1,_functions:{},_namespaces:{},_bootstrapped:!1,lang:{},optionsObjectId:"ammOptions",autoBuildSelector:"[data-amm-build]",defaultBuilderOptions:{topLevelComponent:"root"},_autoBuilder:null,_items:{},itemDebugInfo:{},itemDebugTag:[],r:null,_root:null,_eventStack:[],event:{origin:null,name:"",args:[],parent:null},getRoot:function(){return this._root||(this._root=new this.Root,this.r=this._root),this._root},registerItem:function(t){if(!t._amm_id)return t._amm_id=this.id+"_"+this._counter++,this._items[t._amm_id]=t,this.itemDebugTag.length&&(this.itemDebugInfo[t._amm_id]=this.itemDebugTag[this.itemDebugTag.length-1]),!0},unregisterItem:function(t){if(t._amm_id){if("string"==typeof t&&(t=this._items[t]),t._amm_id&&this._items[t._amm_id]!==t)throw Error("Mismatch of _amm_id detected during the item de-registration");delete this._items[t._amm_id],delete this.itemDebugInfo[t._amm_id],t._amm_id=null}},getItem:function(t,e){if(t instanceof Array){for(var i,r=[],n=0,s=t.length;n<s;n++){t[n]&&t[n].length&&((i=this.getItem(t[n],e))&&r.push(i))}return r}var o=this._items[t];if(!o&&e)throw Error("Item '"+t+"' not found");return o},extend:function(t,e,i){if("function"!=typeof t)throw Error("Amm.extend: `subClass` is not a function");if("function"!=typeof e)throw Error("Amm.extend: `parentClass` is not a function");var r=!1;if("function"==typeof e.beforeExtend&&(r=e.beforeExtend(t,e,i)),!r)for(var n in e.prototype)n in t.prototype||(t.prototype[n]=e.prototype[n]),i||"__CLASS__"!==t.prototype[n]||(t.prototype[n]="__PARENT__");"function"==typeof e.afterExtend&&e.afterExtend(t,e,i)},augment:function(t,e,i){var r;if("string"==typeof e&&(e=Amm.getFunction(e)),"object"!=typeof t)throw Error("`instance` must be an object");if("function"==typeof e)r=new e;else{if("object"!=typeof e)throw Error("`trait` must be an object or a function (constructor)");r=e}var n=this.getInterfaces(t,r);if(n.length)throw Error("Cannot augment: `instance` already implements same interfaces as the `traitInstance`: "+n.join(", ")+")");for(var s in r)"__"!==s.slice(0,2)&&(void 0!==t[s]&&"function"!=typeof t[s]||(t[s]=r[s]));"function"==typeof r.__augment&&r.__augment.call(t,r,i)},override:function(t,e,i){for(var r=0,n=arguments.length;r<n;r++)for(var s in arguments[r])arguments[r].hasOwnProperty(s)&&(t[s]=arguments[r][s]);return t},overrideRecursive:function(t,e,i,r){if("object"!=typeof t||"object"!=typeof e)throw Error("Both modifiedObject and overrider must be objects");for(var n in e)if(e.hasOwnProperty(n))if(t[n]instanceof Array&&e[n]instanceof Array){if(!r||!t[n].length){t[n]=t[n].concat(e[n]);continue}for(var s=0,o=e[n].length;s<o;s++)0<=Amm.Array.indexOf(e[n][s],t[n])||t[n].push(e[n][s])}else"object"==typeof t[n]&&"object"==typeof e[n]?this.overrideRecursive(t[n],e[n],i,r):i&&n in t||(t[n]=e[n]);return t},meetsRequirements:function(t,e,i){e instanceof Array||(e=[[e]]);for(var r=0,n=e.length;r<n;r++){var s=e[r],o=!0;s instanceof Array||(s=[s]);for(var a=0,h=s.length;a<h;a++){var l,u=s[a];if(!("function"==typeof u?t instanceof u:"__CLASS__"===(l=t[u])||"__INTERFACE__"===l||"__PARENT__"===l||"function"==typeof l)){o=!1;break}}if(o)return!0}if(i)throw Error("["+Amm.describeType(t)+"] `"+i+"` doesn't meet following requirement(s): "+Amm.describeRequirements(e));return!1},describeRequirements:function(t){for(var e=[],i=0;i<t.length;i++){var r,n=t[i];n instanceof Array||(n=[n]);for(var s=0;s<n.length;s++)n[s][0].toLowerCase()===n[s][0]&&(n[s]+="()");r=1<n.length?"( "+n.join(" & ")+" )":n[0],e.push(r)}return e.join(" || ")},getClass:function(t,e){var i;for(var r in e&&(i=[]),t)if("__CLASS__"===t[r]||e&&"__PARENT__"===t[r]){if(!e)return r;i.push(r)}return e?i:null},getInterfaces:function(t,e){var i=[];for(var r in t)"__INTERFACE__"===t[r]&&(e&&!e[r]||i.push(r));return i},hasInterfaces:function(t,e,i){if(!e)return!0;e instanceof Array||(e=[e]);for(var r=e.length-1;0<=r;r--)if(!t||"__INTERFACE__"!==t[e[r]]){if(i){var n="string"==typeof i?i:"`item`";throw Error(n+=" must implement all following interfaces: "+e.join(",")+" but it doesn't implement interface "+e[r])}return!1}return!0},is:function(t,e,i){if(e instanceof Array){for(var r=0,n=r.length;r<n;r++)if(Amm.is(t,e[r]))return!0;if(i){var s="string"==typeof i?i:"`item`";throw Error(s+" must be an instance of "+e.join("|")+"; given: "+Amm.describeType(t))}return a}if("function"==typeof e){if(t instanceof e)return!0;var o=Amm.getClass(e.prototype);if(!o)return!1;e=o}var a=t&&("__CLASS__"===t[e]||"__PARENT__"===t[e]||"__INTERFACE__"===t[e]);if(a||!i)return a;s="string"==typeof i?i:"`item`";throw Error(s+" must be an instance of "+e+"; given: "+Amm.describeType(t))},init:function(t,e,i,r){if(e){var n=null;if(i instanceof Array)for(var s=0,o=i.length;s<o;s++)i[s]in e&&((n=n||{})[i[s]]=e[i[s]],delete e[i[s]]);else n=e;if(n)for(var a in n)if(n.hasOwnProperty(a)){if("_"===a[0])throw Error("Use of pseudo-private identifiers is prohibited in `optToSet`, encountered: '"+a+"'");if(a in t&&"function"==typeof t[a]){if("function"!=typeof n[a])throw Error("Only function is allowed to override the function (`"+a+"` provided is "+typeof n[a]+")");t[a]=n[a]}var h=n[a],l="set"+(""+a).slice(0,1).toUpperCase()+(""+a).slice(1);if("function"==typeof t[l])t[l](h);else if(a in t)t[a]=h;else if("function"==typeof h)t[a]=h;else{var u=!0;if("function"==typeof r&&(u=!r.call(t,a,h)),u)throw Error("No such property: '"+a+"' in "+(this.getClass(t)||"`object`"))}}}},getFunction:function(t,e){if("function"==typeof t)return t;if("string"!=typeof t)throw Error("`strName` must be a string, given: "+this.describeType(t));if(this._functions[t])return this._functions[t];for(var i=t.split("."),r=this._namespaces,n=[];i.length&&r;){var s=i.splice(0,1)[0];n.push(s),r=r[s]}if(r)return r;if(e)return null;throw i.length?Error("Unknown namespace '"+n.join(".")+"' (when trying to locate function '"+t+"')"):Error("Unknown function '"+n.join(".")+"'")},registerNamespace:function(t,e){if("string"!=typeof t)throw Error("`ns` must be a string");if(!e||"object"!=typeof e&&"function"!=typeof e)throw Error("Amm.registerNamespace: `hash` must be an object or a function");this._namespaces[t]=e},registerFunction:function(t,e){if("string"!=typeof t)throw Error("`name` must be a string");if(!e||"function"!=typeof e)throw Error("`fn` must be a function");this._functions[t]=e},pushEvent:function(t){var e=this.event;t.parent=e,this._eventStack.push(this.event),this.event=t},popEvent:function(){this.event=this._eventStack.pop()},detectProperty:function(t,e,i){var r=e[0].toUpperCase()+e.slice(1),n="get"+r,s="set"+r,o=e+"Change";"function"!=typeof t[n]&&(n=null),"function"!=typeof t[s]&&(s=null),"function"==typeof t.hasEvent&&t.hasEvent(o)||(o=null);var a=o&&n&&s;return i&&"object"==typeof i&&(i.getterName=n,i.setterName=s,i.eventName=o),a},getProperty:function(t,e,i,r){if("object"!=typeof t||!t)return i;if(t instanceof Array){for(var n=[],s=0;s<t.length;s++)n.push(this.getProperty(t[s],e,i));return n}if(e instanceof Array){for(n={},s=0;s<e.length;s++)n[e[s]]=this.getProperty(t,e[s],i);return n}var o="get"+((""+e)[0].toUpperCase()+e.slice(1));return null!=r&&(r instanceof Array||(r=[r])),"function"==typeof t[o]?r?t[o].apply(t,r):t[o]():e in t?t[e]:"class"===e?Amm.getClass(t):i},setProperty:function(t,e,i,r,n){if(!(t instanceof Array)){if(void 0===i&&e&&"object"==typeof e){var s={};for(var o in e)e.hasOwnProperty(o)&&(s[o]=Amm.setProperty(t,o,e[o],r));return s}var a="set"+((""+e[0]).toUpperCase()+e.slice(1));if(null!=n&&(n=n instanceof Array?[].concat(n):[n]).unshift(i),"function"==typeof t[a])s=n?t[a].apply(t,n):t[a](i);else if(e in t)t[e]=i;else if(r)throw Error("No setter for property: `"+e+"`");return s}for(var o=0,h=t.length;o<h;o++)Amm.setProperty(t[o],e,i,r,n)},createProperty:function(t,r,e,i,n){if(!t||"object"!=typeof t)throw Error("`target` must be an object");var s=r.slice(1),o=r[0].toUpperCase()+s,a=r[0].toLowerCase()+s,h="get"+o,l="set"+o,u="out"+o+"Change",c=a+"Change",m="_"+a;m in t||(t[m]=e),h in t||(t[h]=function(){return this[m]});var _=i?i.before:null,d=i?i.after||i:null;"function"!=typeof d&&(d=null),l in t||(t[l]=function(t){var e,i=this[m];if(_&&void 0!==(e=_.call(this,t,i,r))&&(t=e),i!==t)return this[m]=t,d?(d.call(this,t,i,r),this[m]!==i&&this[u](this[m],i)):this[u](t,i),!0}),!u||u in t||(t[u]=function(t,e){"function"==typeof this._out&&this._out(c,t,e)}),n&&Object.defineProperty(t,a,{enumerable:!0,get:t[h],set:t[l]})},decorate:function(t,e,i){if(e){if("function"==typeof e)return i?e.call(i,t):e(t);if("object"!=typeof e&&"string"!=typeof e)throw Error("`decorator` must be either function or an object with .decorate() method");return e.class||"function"!=typeof e.decorate?Amm.Decorator.construct(e).decorate(t):e.decorate(t,i)}return t},cleanup:function(t,e){var i=!1,r=0;"boolean"==typeof t&&(i=t[0],r=1);for(var n=r,s=arguments.length;n<s;n++)if(t=arguments[n]){var o=!1;if("function"==typeof t.cleanup&&(t.cleanup(),o=!0),t instanceof Array){for(var a=r,h=t.length;a<h;a++)this.cleanup(t[a]);return}if("_amm_id"in t)this.unregisterItem(t);else if(!o&&!i)throw Error("`itemOrItems` must be either an object with .cleanup() method or an Array")}},keys:function(t){var e=[];for(var i in t)t.hasOwnProperty(i)&&e.push(i);return e},values:function(t){var e=[];for(var i in t)t.hasOwnProperty(i)&&e.push(t[i]);return e},bootstrap:function(){if(!jQuery)throw Error("Amm.bootstrap: jQuery not found");var t=this;jQuery(function(){t._doBootstrap()})},getBootstrapped:function(){return this._bootstrapped},_doBootstrap:function(){var t,e;this._bootstrapped||(this._bootstrapped=!0,this.optionsObjectId&&window[this.optionsObjectId]&&("object"==typeof(t=window[this.optionsObjectId])&&this.init(this,t)),this.registerNamespace("v",this.View.Html),this.registerNamespace("t",this.Trait),this.autoBuildSelector&&(e=this.autoBuildSelector,this._autoBuilder=new this.Builder(e,this.defaultBuilderOptions),this._autoBuilder.build()),this.getRoot().raiseEvent("bootstrap"))},constructInstance:function(t,e,i,r,n){var s;if("string"==typeof t||"function"==typeof t)t={class:t};else if(t){if("object"!=typeof t)throw Error("`options` must be a string, an object, a function or FALSEable value")}else t={};if(Amm.getClass(t))s=t,r&&i&&"object"==typeof i&&Amm.setProperty(s,i);else{if(t=Amm.override({},t),i){if("string"==typeof i)i={class:i};else if("object"!=typeof i)throw Error("`defaults` must be a string, an object or FALSEable value");for(var o in i)o in t||!i.hasOwnProperty(o)||(t[o]=i[o])}var a=t.class||e;if("function"==typeof t&&(a=t),!(a=Amm.getFunction(a)))throw Error("Either options.class or baseClass are required");delete t.class,s=new a(t)}if(e&&Amm.is(s,e,"created instance"),n&&!Amm.meetsRequirements(s,n))throw Error("created instance doesn't meet specified requirements");return s},constructMany:function(t,e,i,r,n,s){var o,a=[];if(t instanceof Array)o=t;else{if(!t||"object"!=typeof t)throw Error("`options` must be either Array or a hash");for(var h in o=[],t)t.hasOwnProperty(h)&&(a.push(h),o.push(t[h]))}for(var l=[],u=i?r?Amm.override({},i):i:{},h=0,c=o.length;h<c;h++)try{r&&u&&(a[h]?u[r]=a[h]:r in i?u[r]=i[r]:delete u[r]);var m=new Amm.constructInstance(o[h],e,u,n,s);m===o[h]&&r&&a[h]&&!n&&Amm.setProperty(m,r,a[h]),l.push(m)}catch(t){throw"string"==typeof t?t=Error("item #'"+(a[h]||h)+"': "+t):t instanceof Error&&(t.message="item #'"+(a[h]||h)+"': "+t.message),t}return l},translate:function(t,e){var i=t;Amm.lang[i]&&(i=Amm.lang[i]);for(var r=1,n=arguments.length;r<n;r+=2)i=i.replace(new RegExp(Amm.Util.regexEscape(arguments[r]),"g"),arguments[r+1]);return i},defineLangStrings:function(t,e){for(var i in t)t.hasOwnProperty(i)&&(!e&&i in this.lang||(this.lang[i]=t[i]))},describeType:function(t){var e=typeof t;if("object"!=e)return e;if(!t)return"null";var i=Amm.getClass(t);return i||(t.constructor&&t.constructor.name?t.constructor.name:"object")},findElement:function(t){var e=Amm.DomHolder.find(t);return e[0]&&e[0]["Amm.View.Abstract"]?e[0].getElement():null},callMethods:function(t,e){var i,r=e instanceof RegExp,n={};for(var s in t)"function"==typeof t[s]&&(r?s.match(r):0===s.indexOf(e))&&(i=i||Array.prototype.slice.call(arguments,2),n[s]=t[s].apply(t,i));return n},html:function(t,e,i,r){void 0===e&&(e=0),void 0===i&&(i=4);for(var n,s,o="",a=0;a<e;a++)o+=" ";for(a=0;a<i;a++)0;if(!t||"object"!=typeof t)return o+t;if(t instanceof Array){for(n="",a=0,s=t.length;a<s;a++)0<a&&(n+="\n"),n+=Amm.html(t[a],e,i,r);return n}if(!t.$)throw Error("`$` (tag name) must be present in attribute definition");for(a in n=o+"<"+t.$,t)if(t.hasOwnProperty(a)){if("$"===a[0])continue;var h,l=t[a];if(!1===l)continue;!0===l&&(l=a),"object"==typeof l&&l&&(l="style"===a?(h=function(t,e){var i="";if(!e||"object"!=typeof e)return t+": "+e+"; ";if(e instanceof Array)return e.join(" ");for(var r in t.length&&(t+="-"),e)e.hasOwnProperty(r)&&(i+=h(t+r,e[r]));return i})("",l):JSON.stringify(l).replace(/'/g,"&#39;")),r||(a=a.replace(/_/g,"-")),n+=" "+a+"='"+l+"'"}if(null===t.$$)return n+=" />";if(!t.$$)return n+="></"+t.$+">";var u=t.$noIndent?0:e+i;return n+=">",u&&(n+="\n"),n+=Amm.html(t.$$,u,i,r),u&&(n+="\n"+o),n+="</"+t.$+">"},getHtmlElements:function(t){if(t instanceof window.HTMLElement&&(elementOrDOMNode=Amm.findElement(t)),!t)return[];for(var e=t.getUniqueSubscribers("Amm.View.Html"),i=[],r=0;r<e.length;r++){var n=e[r].getHtmlElement();n&&i.push(n)}return i=Amm.Array.unique(i)},event:null},Amm.registerNamespace("Amm",Amm),window.jQuery&&Amm.bootstrap(),Amm.WithEvents=function(t,e){var i;this._subscribers={},t&&((i=this._extractOnHandlers(t))&&this._initOnHandlers(i),e||Amm.init(this,t))},Amm.WithEvents.invokeHandler=function(t,e,i,r,n,s){return Amm.WithEvents.invokeHandlers.call(this,t,e,[[i,r,n]],s)},Amm.WithEvents.invokeHandlers=function(t,e,i,r){r||Amm.pushEvent({origin:this,name:t,args:e});try{for(var n=i.length,s=n<2?i:i.slice(),o=0;o<n;o++){var a=s[o],h=a[0]||null,l=a[1]||this,u=a[2]||void 0;if("string"!=typeof l||(l="function"==typeof this.getByPath?this.getByPath(l):Amm.getByPath(l))){l=l||this,"string"==typeof h&&(h=l[h]);var c=[].concat(e);if(void 0!==u&&c.push(u),!h||"function"!=typeof h&&"function"!=typeof h.apply)throw Error("Cannot call non-function handler or handler without .apply");h.apply(l,c)}}}catch(t){throw r||Amm.popEvent(),t}return r||Amm.popEvent(),!0},Amm.WithEvents.prototype={"Amm.WithEvents":"__CLASS__",_subscribers:null,strictEvents:!0,listEvents:function(){var t=[];for(var e in this)"out"===(""+e).slice(0,3)&&"function"==typeof this[e]&&(e=(e=""+e).slice(3,4).toLowerCase()+e.slice(4,e.length)).length&&t.push(e);return t},hasEvent:function(t){var e=t.charAt(0),i=e.toUpperCase();if(e===i)return null;var r="",n="out"+i+t.slice(1);return"function"==typeof this[n]&&(r=n),r},_out:function(t){var e,i;!this._subscribers||(e=this._subscribers[t])&&e.length&&(i=Array.prototype.slice.call(arguments,1),Amm.WithEvents.invokeHandlers.call(this,t,i,e))},subscribe:function(t,e,i,r){if("string"!=typeof t||!t.length)throw Error("`eventName` must be a non-empty string");if(i=i||null,r=r||null,this.strictEvents&&!this.hasEvent(t)){var n=this._handleMissingEvent(t,e,i,r);if(void 0===n)throw Error("No such out event: '"+t+"'");if(!1===n)return!0}var s,o,a=!1;return this._subscribers[t]||(this._subscribers[t]=[],a=!0),this.getSubscribers(t,e,i,r).length||(this._subscribers[t].push([e,i,r]),s=!0),!a||this[o="_subscribeFirst_"+t]&&"function"==typeof this[o]&&this[o](),s},_handleMissingEvent:function(t,e,i,r){},getSubscribers:function(t,e,i,r){var n=[],s=null;for(var o in void 0===t?s=this._subscribers:(s={})[t]=!0,s)if(this._subscribers.hasOwnProperty(o))for(var a=this._subscribers[o],h=a.length,l=0;l<h;l++)void 0!==e&&e!==a[l][0]||void 0!==i&&i!==a[l][1]||void 0!==r&&r!==a[l][2]||n.push([].concat(a[l],[o,l]));return n},getUniqueSubscribers:function(t,e){var i=[],r=null;for(var n in void 0===e?r=this._subscribers:(r={})[e]=!0,r)if(this._subscribers.hasOwnProperty(n))for(var s=this._subscribers[n],o=s.length,a=0;a<o;a++){var h=s[a][1];h&&(void 0!==t&&!Amm.is(h,t)||i.push(h))}return Amm.Array.unique(i)},unsubscribeByIndex:function(t,e){if(!(this._subscribers[t]&&e in this._subscribers[t]))return[];var i,r=[[].concat(this._subscribers[t][e],[t,e])];return this._subscribers[t].splice(e,1),this._subscribers[t].length||(delete this._subscribers[t],this[i="_unsubscribeLast_"+t]&&"function"==typeof this[i]&&this[i]()),r},unsubscribe:function(t,e,i,r){for(var n=t instanceof Array&&1===arguments.length?t:this.getSubscribers(t,e,i,r),s=n.length-1;0<=s;s--){var o,a=n[s];this._subscribers[a[3]].splice(a[4],1),this._subscribers[a[3]].length||(delete this._subscribers[a[3]],this[o="_unsubscribeLast_"+t]&&"function"==typeof this[o]&&this[o]())}return n},cleanup:function(){this._subscribers={},Amm.unregisterItem(this)},_extractOnHandlers:function(t){var e,i,r=[];for(var n in t){"o"===n[0]&&"n"===n[1]&&"_"===n[2]&&"_"===n[3]&&t.hasOwnProperty(n)&&((e=t[n])instanceof Array||(e=[e]),i=n.split("__")[1],r.push([i,e[0],e[1],e[2]]),delete t[n])}return r.length?r:null},_initOnHandlers:function(t){for(var e=0,i=t.length;e<i;e++)this.subscribe(t[e][0],t[e][1],t[e][2],t[e][3])}},Amm.Array=function(t){var e,i=arguments;i[0]instanceof Array?(e=i[0],t=i[1]):i[0]instanceof Amm.Array&&(e=i[0].getItems(),t=i[1]),Amm.WithEvents.call(this,t),void 0!==e&&this.setItems(e)},Amm.Array.indexOf=function(t,e,i){if(i=i||0,e instanceof Array&&e.indexOf)return e.indexOf(t,i);for(var r=i,n=e.length;r<n;r++)if(t===e[r])return r;return-1},Amm.Array.nonStrictIndexOf=function(t,e,i){for(var r=i=i||0,n=e.length;r<n;r++)if(t==e[r])return r;return-1},Amm.Array.arrayChangeEvents={appendItems:"outAppendItems",insertItem:"outInsertItem",deleteItem:"outDeleteItem",replaceItem:"outReplaceItem",spliceItems:"outSpliceItems",reorderItems:"outReorderItems",moveItem:"outMoveItem",clearItems:"outClearItems",itemsChange:"outItemsChange"},Amm.Array.costlyEvents={reorderItems:"outReorderItems",moveItem:"outMoveItem"},Amm.Array.prototype={"Amm.Array":"__CLASS__",_unique:!1,_comparison:null,_diff:!0,_sparse:!1,_updateLevel:0,_noTrigger:0,_preUpdateItems:null,_evCache:null,_costlyEvents:!1,length:0,push:function(t,e){var i=Array.prototype.slice.apply(arguments);this._unique&&this._checkDuplicates("push()",i);var r=i.length;if(!r)return this.length;for(var n=0;n<r;n++)this[this.length++]=i[n];return this._updateLevel||this.outAppendItems(i),this.length},pop:function(){if(this.length){--this.length;var t=this[this.length];return delete this[this.length],this._updateLevel||this.outDeleteItem(this.length,t),t}},slice:function(t,e){(t=t||0)<0&&(t=this.length+t),t<0&&(t=0),void 0===e&&(e=this.length),(e=e||0)<0&&(e=this.length+e),e<0&&(e=0),e>this.length&&(e=this.length);for(var i=[],r=t;r<e;r++)i.push(this[r]);return i},sort:function(t,e){if((e=e||{}).changed=!1,this.length<=1)return this;var i,r=this.getItems(),n=[].concat(r),s=this.length;r.sort(t);var o=!1;if(this._comparison)for(i=0;i<s;i++)o=o||this._comparison(this[i],r[i]),!this._sparse||i in r?this[i]=r[i]:delete this[i];else for(i=0;i<s;i++)o=o||this[i]!==r[i],this[i]=r[i],!this._sparse||i in r?this[i]=r[i]:delete this[i];return o&&(this._updateLevel||this.outReorderItems(0,this.length,n),e.changed=!0),this},reverse:function(){if(this.length<=1)return this;for(var t,e,i=this.getItems(),r=this.length-1,n=(r-r%2)/2,s=0;s<=n;s++)if(!this._sparse||s in this&&r-s in this)t=this[s],this[s]=this[r-s],this[r-s]=t;else{if(e=r-s in this,!(s in this)&&!e)continue;e?(this[s]=this[r-s],delete this[r-s]):(this[r-s]=this[s],delete this[s])}return this._updateLevel||this.outReorderItems(0,this.length,i),this},_rotate:function(t,e,i){if(e){for(var r=e<0?t-e:this.length-1,n=e<0?this.length:t-1,s=e<0?1:-1;s*r<s*n;)r in this?this[r+e]=this[r]:delete this[r+e],r+=s;if(e<0)for(var o=this.length+e;o<this.length;o++)delete this[o];this.length+=e}},_innerShift:function(t,e){for(var i=e<t?-1:1,r=t;r*i<e*i;r+=i)this[r]=this[r+i]},_checkDuplicates:function(t,e,i,r,n,s){void 0===s&&(s=this._comparison);var o=this.getItems();r&&o.splice(i,r);var a=e.concat(o),h=Amm.Array.findDuplicates(a,!0,s,n?null:e.length);if(h.length){var l=this._describeIdx(h[0][0],e.length,i||0,r||0),u=this._describeIdx(h[0][1],e.length,i||0,r||0);throw Error("Cannot "+t+": duplicates found ("+l+" and "+u+")")}},_describeIdx:function(t,e,i,r){var n,s;this.length;return t<e?(n="items",s=t):t<i+e?(n="this",s-=e):(n="this",s=t-e+(r||0)),n+"["+s+"]"},splice:function(t,e,i,r){var n=Array.prototype.slice.call(arguments,2),s=n.length,o=[];this.length;if((t=+t||0)<0?(t=this.length+t)<0&&(t=0):t>this.length&&(t=this.length),(e=+e||0)<0&&(e=0),e>this.length-t&&(e=this.length-t),this._unique&&s&&this._checkDuplicates("splice()",n,t,e),t===this.length)return this.push.apply(this,n),o;for(var a=s-e,h=0;h<e;h++)o.push(this[t+h]);for(this._rotate(t,a),h=0;h<s;h++)this[t+h]=n[h];return this._updateLevel||this._outSmartSplice(t,o,n),o},shift:function(){if(this.length){var t=this[0];return this._rotate(0,-1),this._updateLevel||this.outDeleteItem(0,t),t}},unshift:function(t,e){var i=Array.prototype.slice.apply(arguments),r=i.length;if(!r)return this.length;this.length;this._unique&&this._checkDuplicates("unshift()",i),this.length?this._rotate(0,r):this.length=r;for(var n=0;n<r;n++)this[n]=i[n];return this._updateLevel||this._outSmartSplice(0,[],i),this.length},indexOf:function(t,e){(e=e||0)<0&&(e=this.length+e)<0&&(e=0);var i=-1;if(this._comparison){for(var r=e,n=this.length;r<n;r++)if(!this._comparison(t,this[r])){i=r;break}}else for(r=e,n=this.length;r<n;r++)if(t===this[r]){i=r;break}return i},getItems:function(){return Array.prototype.slice.apply(this)},getItem:function(t){return this[t]},getIndexExists:function(t){return t in this},setItem:function(t,e){if(this[t]&&this._comparison?this._comparison(this[t],e):this[t]!==e){if(this._unique&&this._checkDuplicates("setItem()",[e],t,1),t<0)throw Error("`index` must be >= 0");var i;return t>=this.length&&(this._sparse||(t=this.length),this.length=t+1),t in this?(i=this[t],this[t]=e,this._updateLevel||this.outReplaceItem(t,e,i)):(this[t]=e,this._updateLevel||this.outInsertItem(e,t)),t}},removeAtIndex:function(t,e){if(this._sparse||(e=!1),!(t in this))return!1;if(t<0)throw Error("`index` must be >= 0");var i=this[t];return e?delete this[t]:this._rotate(t,-1),this._updateLevel||this.outDeleteItem(t,i),!0},moveItem:function(t,e){if(t<0)throw Error("`index` must be >= 0");if(t>=this.length)throw Error("No item with index "+t);if(e<0)throw Error("`newIndex` must be >= 0");var i;e>=this.length&&!this._sparse&&(e=this.length-1),e!==t&&(i=this[t],this._innerShift(t,e),this[e]=i,this._updateLevel||this.outMoveItem(t,e,i))},insertItem:function(t,e){if(void 0===e||e>=this.length&&!this._sparse)return this.push(t)-1;if(e<0)throw Error("`index` must be >= 0");return this._unique&&this._checkDuplicates("insertItem()",[t]),e<this.length&&this._rotate(e,1),e>=this.length&&(this.length=e),this[e]=t,this._updateLevel||this.outInsertItem(t,e),e},insertItemBefore:function(t,e){if(void 0===e)return this.insertItem(t);var i=this.indexOf(e);if(i<0)throw Error("cannot insertItemBefore: `otherItem` not found");return this.insertItem(t,i)},removeItem:function(t,e){this._unique&&(e=!1);for(var i=0,r=0;0<=(r=this.indexOf(t,r))&&(this.removeAtIndex(r),i++,e););return i},setItems:function(t){if(!t instanceof Array)throw Error("`items` must be an array");this._unique&&this._checkDuplicates("setItems()",t,0,this.length);for(var e=this.getItems(),i=t.length,r=this.length,n=0,s=0;n<i;n++)n in t?(this[s]=t[n],s++):this._sparse&&(delete this[s],s++);for(this.length=s;s<r;)delete this[s++];return this._updateLevel||(this._diff?this._doDiff(e,t):this._outSmartSplice(0,e,t)),this.length},clearItems:function(){this.setItems([])},setSparse:function(t){if(this._sparse!==t)return this._sparse=t,!0},getSparse:function(){return this._sparse},setUnique:function(t){if(t=!!t,this._unique!==t)return t&&this._checkDuplicates("setUnique()",[],0,0,!0),this._unique=t,!0},getUnique:function(){return this._unique},setComparison:function(t){if(this._comparison!==t)return this._unique&&this._checkDuplicates("setComparison()",[],0,0,!0,t),this._comparison=t,!0},getComparison:function(){return this._comparison},setDiff:function(t){if(this._diff!==t)return this._diff=t,!0},getDiff:function(){return this._diff},_doBeginUpdate:function(){this._preUpdateItems=this.getItems()},_doEndUpdate:function(){this._diff?this._doDiff():this._updateLevel||this.outItemsChange(this._getItems,this._preUpdateItems),this._preUpdateItems=null},beginUpdate:function(){this._updateLevel++,1===this._updateLevel&&this._doBeginUpdate()},endUpdate:function(){if(!this._updateLevel)throw Error("endUpdate() before beginUpdate()!");this._updateLevel--,0===this._updateLevel&&this._doEndUpdate()},getUpdateLevel:function(){return this._updateLevel},_buildEvCache:function(){var t=[{}],e=[null];for(var i in e.indexOf||(e.indexOf=this.indexOf),this._subscribers)if(this._subscribers.hasOwnProperty(i)&&Amm.Array.arrayChangeEvents[i])for(var r,n,s=this._subscribers[i].length,o=0;o<s;o++)(r=this._subscribers[i][o])[1]?(n=e.indexOf(r[1]))<0&&(n=e.length,e.push(r[1]),t.push({})):n=0,t[n][i]||(t[n][i]=[]),t[n][i].push(r);return this._evCache=t,this._evCache},_outChain:function(t){if(!this._noTrigger&&!this._updateLevel&&(this._evCache||this._buildEvCache(),this._evCache.length)){var e,i=[];for(l in t)t.hasOwnProperty(l)&&i.push(l);for(var r=i.length,n=0,s=this._evCache.length;n<s;n++)for(var o=0;o<r;o++){var a,h,l=i[o];if(this._evCache[n][l])if((a=t[l])||(a=[],"itemsChange"===l&&(a=[this.getItems()],this._preUpdateItems?a.push(this._preUpdateItems):(e=t.spliceItems)&&((h=[].concat(a[0])).splice.apply(h,[e[0],e[2].length].concat(e[1])),a.push(h)))),Amm.WithEvents.invokeHandlers.call(this,l,a,this._evCache[n][l]),0!==n)break}this._checkLengthChange()}},_checkLengthChange:function(){var t;this._oldLength!==this.length&&(t=this._oldLength,this._oldLength=this.length,this.outLengthChange(this.length,t))},getLength:function(){return this.length},setLength:function(t){console.warn("Array.setLength() has no effect")},outLengthChange:function(t,e){return this._out("lengthChange",t,e)},outClearItems:function(t){return this._outChain({clearItems:null,spliceItems:[0,t,[]],itemsChange:[[],t]})},outDeleteItem:function(t,e){return this._outChain({deleteItem:[t,e],spliceItems:[t,[e],[]],itemsChange:null})},outInsertItem:function(t,e){return this._outChain({insertItem:[t,e],spliceItems:[e,[],[t]],itemsChange:null})},outReplaceItem:function(t,e,i){return this._outChain({replaceItem:[t,e,i],spliceItems:[t,[i],[e]],itemsChange:null})},outAppendItems:function(t){return this._outChain({appendItems:[t],spliceItems:[this.length-t.length,[],t],itemsChange:null})},outSpliceItems:function(t,e,i){return this._outChain({spliceItems:[t,e,i],itemsChange:null})},outMoveItem:function(t,e,i){var r,n,s;if(!this._noTrigger)return t<e?(s=e-(n=t)+1,(r=this.slice(t,e)).unshift(i)):(s=t-(n=e)+1,(r=this.slice(e+1,t+1)).push(i)),this._outChain({moveItem:[t,e,this[e]],reorderItems:[n,s,r],spliceItems:[n,r,this.slice(n,n+s)],itemsChange:null})},outReorderItems:function(t,e,i){return this._outChain({reorderItems:[t,e,i],spliceItems:[t,i,this.slice(t,t+e)],itemsChange:null})},outItemsChange:function(t,e){return this._outChain({itemsChange:[t,e]})},_outSmartSplice:function(t,e,i){if(!this._noTrigger&&!this._updateLevel&&(e.length||i.length)){if(0===t&&!i.length&&!this.length)return this.outClearItems(e);if(!e.length&&t>=this.length-i.length)return this.outAppendItems(i);if(!e.length&&1===i.length)return this.outInsertItem(i[0],t);if(1===e.length&&1===i.length)return this.outReplaceItem(t,i[0],e[0]);if(1===e.length&&!i.length)return this.outDeleteItem(t,e[0]);if(e.length===i.length){var r=e.length-1;if(Amm.Array.equal(e,i,void 0,void 0,void 0,this._comparison))return;if(this._comparison?this._comparison(e[0],i[r]):e[0]!==i[r]){if((this._comparison?!this._comparison(e[r],i[0]):e[r]===i[0])&&Amm.Array.equal(e,i,0,1,r,this._comparison))return this.outMoveItem(t+r,t,e[r])}else if(Amm.Array.equal(e,i,1,0,r,this._comparison))return this.outMoveItem(t,t+r,e[0]);if(!Amm.Array.symmetricDiff(e,i,this._comparison).length)return this.outReorderItems(t,e.length,e)}return this.outSpliceItems(t,e,i)}},_doDiff:function(t,e){t=t||this._preUpdateItems,e=e||this.getItems();var i=Amm.Array.smartDiff(t,e,null,!this._costlyEvents);if(i)return"splice"===i[0]?this._outSmartSplice(i[1],t.slice(i[1],i[1]+i[2]),i[3]):"move"===i[0]?this.outMoveItem(i[1],i[2],this[i[2]]):"reorder"===i[0]?this.outReorderItems(i[1],i[2],i[3]):void 0},subscribe:function(t,e,i,r,n){return this._evCache=null,!this._costlyEvents&&Amm.Array.costlyEvents[t]&&(this._costlyEvents=!0),Amm.WithEvents.prototype.subscribe.call(this,t,e,i,r,n)},unsubscribe:function(t,e,i){this._evCache=null;var r=Amm.WithEvents.prototype.unsubscribe.call(this,t,e,i);if(this._costlyEvents&&!this._subscribers[t]&&Amm.Array.costlyEvents[t]){var n=!1;for(var s in this._subscribers)if(this._subscribers.hasOwnProperty(s)&&Amm.Array.costlyEvents[s]){n=!0;break}n||(this._costlyEvents=!0)}return r},cleanup:function(){var t=Amm.WithEvents.prototype.unsubscribe.call(this);return this._evCache=null,this._updateLevel=1,this.setItems([]),this._preUpdateItems=null,this._updateLevel=0,t}},Amm.extend(Amm.Array,Amm.WithEvents),Amm.Array.equal=function(t,e,i,r,n,s){if(t===e)return!0;if(i||r||void 0!==n){if((i=i||0)<0&&(i=t.length+i),i<0&&(i=0),(r=r||0)<0&&(r=e.length+r),r<0&&(r=0),void 0===n&&(n=t.length-i),n<0&&(n=0),0===n)return!0;var o=n,a=n;if(i+n>t.length&&(o=t.length-i),r+n>e.length&&(a=e.length-r),o<=0&&a<=0)return!0;if(o!==a)return!1}else{if(t.length!==e.length)return!1;r=i=0,n=t.length}if(s){for(var h=0;h<n;h++)if(s(t[i+h],e[r+h]))return!1}else for(h=0;h<n;h++)if(t[i+h]!==e[r+h])return!1;return!0},Amm.Array.smartDiff=function(t,e,i,r,n){var s,o,a=t.length,h=e.length,l=h-a,u=h<a?a:h;if(n&&n instanceof Array&&(n.length=0),!a&&!h)return null;if(!a)return["splice",0,0,[].concat(e)];if(!h)return["splice",0,a,[]];for(o=0;o<u&&(i?!i(t[o],e[o]):t[o]===e[o]);o++);for(var c=0<l?o+l-1:o,m=a-1;c<=m&&(i?!i(t[m],e[m+l]):t[m]===e[m+l]);m--);var _=++m-o,d=_+l,p=d?e.slice(o,o+d):[];if(!_&&!d)return null;if(_==d&&!r){var f=t.slice(o,o+_),g=0,A=0,v=!0;if((i?i(f[0],p[d-1]):f[0]!==p[d-1])?(i?i(f[_-1],p[0]):f[_-1]!==p[0])||(A=1):g=1,g||A){for(s=0;s<_-1;s++)if(i?i(f[s+g],p[s+A]):f[s+g]!==p[s+A]){v=!1;break}if(v)return g?["move",o,o+_-1]:["move",m-1,m-_]}if(!Amm.Array.symmetricDiff(f,p,i,n).length)return["reorder",o,_,f]}return["splice",o,_,p]},Amm.Array._optArrayDiff=!0,Amm.Array.symmetricDiff=function(t,e,i,r){if(!t.length||!e.length)return[].concat(t);r instanceof Array||(r=[]);var n,s,o=t.length,a=e.length,h={},l=[].concat(e);if(r.length=o,i)for(n=[],s=0;s<o;s++){for(var u=t[s],c=null,m=0;m<a;m++)if(l[m]!==h&&!i(u,l[m])){l[c=m]=h;break}a<=m&&n.push(u),r[s]=c}else if(t.filter&&e.indexOf&&Amm.Array._optArrayDiff)n=t.filter(function(t,e){var i=l.indexOf(t);return 0<=i?(r[e]=i,l[i]=h,!1):!(r[e]=null)});else for(n=[],s=0;s<o;s++){u=t[s];for(c=null,m=0;m<a;m++)if(u===l[m]){l[m]=h,c=m;break}a<=m&&n.push(u),r[s]=m}return n},Amm.Array.findNonMatched=function(t,e,i){var r,n,s={},o=[];for(i=i||0,r=0,n=t.length;r<n;r++)s[t[r]]=!0;for(r=0;r<e;r++)r in s||o.push(r+i);return o},Amm.Array.diff=function(t,e,i){if(!t.length||!e.length)return[].concat(t);var r,n,s=t.length,o=e.length;if(i)for(r=[],n=0;n<s;n++){for(var a=t[n],h=0;h<o&&i(a,e[h]);h++);o<=h&&r.push(a)}else if(t.filter&&e.indexOf&&Amm.Array._optArrayDiff)r=t.filter(function(t){return e.indexOf(t)<0});else for(r=[],n=0;n<s;n++){a=t[n];for(h=0;h<o&&a!==e[h];h++);o<=h&&r.push(a)}return r},Amm.Array.findDuplicates=function(t,e,i,r,n,s){var o,a,h,l=t.length,u=[];if((!r||r<0||l<r)&&(r=l),n&&l<=r&&!s)return[];for(var c=0;c<r;c++){a=!0;for(var m,_=n?r:c+1;_<l;_++){if(i?!i(t[c],t[_]):t[c]===t[_]){if(a=!1,o){if(o.indexOf)m=0<=o.indexOf(_);else for(var d=0;d<o.length;d++)if(o[d]===_){m=!0;break}if(m)continue}else o=[c];if((h=h||[c]).push(_),e)return[h];o.push(_)}}if(h)u.push(h),h=null;else if(s&&a){if(o){if(o.indexOf)p=0<=o.indexOf(c);else for(d=0;d<o.length;d++)if(o[d]===c){p=!0;break}}else p=!1;p||u.push([c])}}if(n&&s)for(var p,f=r;f<l;f++){if(o){if(o.indexOf)p=0<=o.indexOf(f);else for(d=0;d<o.length;d++)if(o[d]===f){p=!0;break}}else p=!1;p||u.push([f])}return u},Amm.Array.calcChanges=function(t,e,i,r,n){var s=t.length,o=n?s:null,a=!!n;r=r||0;var h,l,u,c=Amm.Array.findDuplicates(t.concat(e),!1,i,o,a,!0),m={added:[],deleted:[],moved:[],same:[]},_=c.length;if(n){for(h=0;h<_;h++){1!==c[h].length?(l=c[h][0])===(u=c[h][1]-s)?m.same.push([t[l],l+r]):m.moved.push([t[l],l+r,u+r]):c[h][0]>=s?m.added.push([e[c[h][0]-s],c[h][0]-s+r]):m.deleted.push([t[c[h][0]],c[h][0]+r])}return m}for(h=0;h<_;h++){for(var d=[],p=[],f={},g=[],A=0,v=c[h].length;A<v;A++){var y=c[h][A],E=s<=y,C=E?y-s:y;f[C]?(f[C]++,g.push(C)):f[C]=1,E?p.push(C):d.push(C)}if(g.length){for(A=d.length;0<=A;A--)1<f[d[A]]&&d.splice(A,1);for(A=p.length;0<=A;A--)1<f[p[A]]&&p.splice(A,1);for(A=0;A<g.length;A++)m.same.push([t[g[A]],g[A]+r])}var b=d.length<p.length?d.length:p.length;for(A=0;A<b;A++)p[A]===d[A]?m.same.push([t[d[A]],d[A]+r]):m.moved.push([t[d[A]],d[A]+r,p[A]+r]);for(A=b;A<p.length;A++)m.added.push([e[p[A]],p[A]+r]);for(A=b;A<d.length;A++)m.deleted.push([t[d[A]],d[A]+r])}return m},Amm.Array.intersect=function(t,e,i){if(!(t instanceof Array||t["Amm.Array"]))throw Error("`a` must be an Array");if(!(e instanceof Array||e["Amm.Array"]))throw Error("`b` must be an Array");if(!t.length||!e.length)return[];for(var r=[].concat(t).concat(e),n=Amm.Array.findDuplicates(r,!1,i,t.length,!0),s=[],o=0,a=n.length;o<a;o++)for(var h=0,l=n[o].length;h<l;h++)if(n[o][h]<t.length){s.push(r[n[o][h]]);break}return s},Amm.Array.unique=function(t,e){if(!(t instanceof Array||t["Amm.Array"]))throw Error("`arr` must be an Array");for(var i=t["Amm.Array"]?t.getItems():[].concat(t),r=0;r<i.length;r++)for(var n=i.length-1;r<n;n--)(e?e(i[n],i[r]):i[n]!==i[r])||i.splice(n,1);return i},Amm.Instantiator=function(){if("__CLASS__"===this["Amm.Instantiator"])throw Error("Attempt to instantiate abstract class")},Amm.Instantiator.prototype={"Amm.Instantiator":"__CLASS__"},Amm.Instantiator.Proto=function(t,e,i){Amm.Instantiator.call(this),("object"!=typeof t||t&&!t.proto)&&(t={proto:t}),t&&Amm.Builder.isPossibleBuilderSource(t.proto)&&(this.isElement=!0),e&&(t.assocProperty=e),i&&(t.revAssocProperty=i),Amm.init(this,t)},Amm.Instantiator.Proto.prototype={"Amm.Instantiator.Proto":"__CLASS__",proto:null,overrideProto:!1,isElement:!1,assocProperty:null,revAssocProperty:null,construct:function(t){if(!this.proto)throw Error("`proto` must be set");var e,i=this.proto;return this.overrideProto&&"object"==typeof t&&(i=Amm.override({},i),Amm.override(i,t)),e=this.isElement?new Amm.Element(i):Amm.constructInstance(i,null),this.assocProperty&&Amm.setProperty(e,this.assocProperty,t),this.revAssocProperty&&Amm.setProperty(t,this.revAssocProperty,e),e},destruct:function(t){t.cleanup&&t.cleanup()}},Amm.extend(Amm.Instantiator.Proto,Amm.Instantiator),Amm.Instantiator.Variants=function(t){this._prototypes={},this._matches=[],this._objects=[],this._instances=[],Amm.Instantiator.call(this),Amm.WithEvents.call(this,t)},Amm.Instantiator.Variants.prototype={"Amm.Instantiator.Variants":"__CLASS__",_defaultPrototype:null,_prototypes:null,_overrideDefaultPrototype:!1,_matches:null,_objects:null,_instances:null,_filter:null,_filterIsAggregate:!1,_subscribeFilter:!0,_allowNullInstance:!1,_assocProperty:null,_revAssocProperty:null,setPrototypes:function(t,e){if(!t||"object"!=typeof t)throw Error("`prototypes` must be a non-null object");void 0===e?this._prototypes=Amm.override({},t):this._prototypes[e]=Amm.override({},t)},getPrototypes:function(t){return void 0===t?this._prototypes:this._prototypes[t]},setDefaultPrototype:function(t){if("object"!=typeof t)throw Error("`defaultPrototype` must be a null or an object");this._defaultPrototype=t?Amm.override({},t):null},getDefaultPrototype:function(){return this._defaultPrototype},setOverrideDefaultPrototype:function(t){if(t=!!t,this._overrideDefaultPrototype!==t)return this._overrideDefaultPrototype=t,!0},getOverrideDefaultPrototype:function(){return this._overrideDefaultPrototype},construct:function(t,e){var i=this._findObject(t);void 0===e&&this._filter&&this._subscribeFilter&&0<=i?e=this._filter.getMatch(t):void 0===e&&this._filter&&(e=this._filter.evaluateMatch(t));var r=this._build(t,e);return t&&(0<=i?this._matches[i]=e:(i=this._objects.length,this._objects.push(t),this._matches.push(e),this._instances[i]=[],this._subscribeObject(t),this._filter&&this._subscribeFilter&&this._filter.observeObject(t)),r||null===this._instances[i][0]||this._instances[i].unshift(null),r&&(null===this._instances[i][0]&&this._instances[i].splice(0,1),this._instances[i].push(r),this._subscribeInstance(r))),r},_build:function(t,e){var i,r=this._defaultPrototype;if(this._prototypes[e])i=this._prototypes[e],Amm.Builder.isPossibleBuilderSource(i)&&(i=Amm.Builder.calcPrototypeFromSource(i,!1)),i=r&&this._overrideDefaultPrototype?(r=this._defaultPrototype,Amm.Builder.isPossibleBuilderSource(r)&&(r=Amm.Builder.calcPrototypeFromSource(r,!1)),Amm.override({},r,i)):Amm.override({},i);else{if(!this._defaultPrototype){if(!this._allowNullInstance)throw Error("No prototype for match '"+e+"' and `defaultPrototype` not set!");return null}Amm.Builder.isPossibleBuilderSource(r)?r=Amm.Builder.calcPrototypeFromSource(r,!1):i=Amm.override({},r)}var n=this._assocProperty,s=this._revAssocProperty;"__assocProperty"in i&&(n=i.__assocProperty,delete i.__assocProperty),"__revAssocProperty"in i&&(s=i.__revAssocProperty,delete i.__revAssocProperty);var o=Amm.constructInstance(i);return n&&Amm.setProperty(o,n,t),s&&"object"==typeof t&&t&&Amm.setProperty(t,s,o),o},destruct:function(t){this.forgetInstance(t),t.cleanup&&t.cleanup()},setMatches:function(t,e){if(t.length&&this._objects.length){if(e.length!==t.length)throw Exception("`objects` and `matches` must have same length (are: "+t.length+" and "+e.length+")");var i=[],r=[],n=Amm.Array.findDuplicates([].concat(this._objects,t),!1,null,this._objects.length);if(n.length){for(var s=0,o=n.length;s<o;s++){var a,h,l=n[s][0],u=n[s][1]-this._objects.length;this._matches[l]!==e[u]&&(a=this._matches[l]in this._prototypes,h=e[u]in this._prototypes,this._matches[l]=e[u],(h||a)&&(i.push(this._objects[l]),r.push(this._matches[l])))}i.length&&this.outNeedRebuild(i,r,this)}}},outNeedRebuild:function(t,e,i){this._out("needRebuild",t,e,i)},cleanup:function(){this._filter&&this.setFilter(null),Amm.WithEvents.prototype.cleanup.call(this),this._objects=[],this._matches=[];for(var t=0,e=this._instances.length;t<e;t++)this._instances[t]=[];this._instances=[],this._prototypes={},this._defaultPrototype={}},setFilter:function(t){var e=!1;if(t?"object"!=typeof t||t["Amm.Filter"]||(t=Amm.constructInstance(t,"Amm.Filter"),e=!0):t=null,this._filter!==t)return this._filter&&(this._filterIsAggregate?this._filter.cleanup():this._subscribeFilter&&this._subFilter(!0)),this._filterIsAggregate=e,this._filter=t,this._filter&&this._subscribeFilter&&(this._subFilter(),this.setMatches(this._filter.getObservedObjects(),this._filter.getMatches())),!0},getFilter:function(){return this._filter},setSubscribeFilter:function(t){if(t=!!t,this._subscribeFilter!==t)return this._subscribeFilter=t,this._filter&&this._subFilter(!this._subscribeFilter),!0},getSubscribeFilter:function(){return this._subscribeFilter},getFilterIsAggregate:function(){return this._filterIsAggregate},hasObject:function(t){return 0<=this._findObject(t)},hasInstance:function(t){return!!this._findInstance(t)},forgetObject:function(t){var e=this._findObject(t);if(!(e<0))return this._forgetObject(e),!0},forgetInstance:function(t){if(t){var e=this._findInstance(t);if(e)return this._unsubscribeInstance(t),this._instances[e[0]].splice(e[1],1),this._instances[e[0]].length||this._forgetObject(e[0]),!0}},getInstances:function(t){var e=this._findObject(t);return e<0?[]:[].concat(this._instances[e])},_subFilter:function(t){if(t)return this._filter.unsubscribe("matchesChange",this.handleFilterMatchesChange,this),void this._filter.setObservedObjects([]);this._filter.setObservedObjects(this._objects),this._filter.subscribe("matchesChange",this.handleFilterMatchesChange,this)},handleFilterMatchesChange:function(t,e,i){for(var r=[],n=[],s=0,o=t.length;s<o;s++)void 0!==i[s]&&void 0!==e[s]&&(r.push(t[s]),n.push(e[s]));r.length&&this.setMatches(r,n)},_findObject:function(t){return"object"==typeof t&&t?Amm.Array.indexOf(t,this._objects):-1},_findInstance:function(t){for(var e,i,r=0,n=this._instances.length;r<n;r++)for(e=0,i=this._instances[r].length;e<i;e++)if(this._instances[r][e]===t)return[r,e];return null},_forgetObject:function(t){var e=this._objects[t],i=this._instances[t];this._filter&&this._filter.unobserveObject(e),this._objects.splice(t,1),this._instances.splice(t,1),i.length&&this._unsubscribeInstance(i,!0),this._unsubscribeObject(e)},_subscribeObject:function(t){t&&"object"==typeof t&&t["Amm.WithEvents"]&&t.hasEvent("cleanup")&&t.subscribe("cleanup",this._handleObjectCleanup,this)},_unsubscribeObject:function(t){t["Amm.WithEvents"]&&t.hasEvent("cleanup")&&t.unsubscribe("cleanup",this._handleObjectCleanup,this)},_forgetObjectsWithoutInstances:function(){for(var t=this._objects.length-1;0<=t;t--)null===this._instances[t][0]&&(this._instances[t].splice(0,1),this._instances[t].length||this._forgetObject(t))},_unsubscribeInstance:function(t,e){if(e)for(var i=0,r=t.length;i<r;i++)this._unsubscribeInstance(t[i]);else t["Amm.WithEvents"]&&t.hasEvent("cleanup")&&t.unsubscribe("cleanup",this._handleInstanceCleanup,this)},_subscribeInstance:function(t){t["Amm.WithEvents"]&&t.hasEvent("cleanup")&&t.subscribe("cleanup",this._handleInstanceCleanup,this)},_handleObjectCleanup:function(){this.forgetObject(Amm.event.origin)},_handleInstanceCleanup:function(){this.forgetInstance(Amm.event.origin)},setAllowNullInstance:function(t){if(t=!!t,this._allowNullInstance!==t)return(this._allowNullInstance=t)||this._forgetObjectsWithoutInstances(),!0},getAllowNullInstance:function(){return this._allowNullInstance},setAssocProperty:function(t){if(t=t||null,this._assocProperty!==t)return this._assocProperty=t,!0},getAssocProperty:function(){return this._assocProperty},setRevAssocProperty:function(t){if(t=t||null,this._revAssocProperty!==t)return this._revAssocProperty=t,!0},getRevAssocProperty:function(){return this._revAssocProperty}},Amm.extend(Amm.Instantiator.Variants,Amm.Instantiator),Amm.extend(Amm.Instantiator.Variants,Amm.WithEvents),Amm.Operator=function(){this._subs=[]},Amm.Operator.CONTEXT_ID=1,Amm.Operator.getNextContextId=function(){return""+Amm.Operator.CONTEXT_ID++},Amm.Operator.NON_CACHEABLE_VALUE=1,Amm.Operator.NON_CACHEABLE_CONTENT=2,Amm.Operator.CONTENT_NOTIFIED=1,Amm.Operator.CONTENT_PERIODICALLY_CHECKED=2,Amm.Operator.CONTENT_OPERAND_REPORTED=4,Amm.Operator.prototype={"Amm.Operator":"__CLASS__",id:null,_parent:null,_parentOperand:null,_expression:null,_subs:null,_defSub:null,_value:void 0,_hasValue:!1,_lockChange:0,_isEvaluating:0,_contentChanged:null,_evaluated:0,_nonCacheable:0,_hasNonCacheable:0,_destChanged:0,_level:null,_checkArrayChange:!1,OPERANDS:[],supportsAssign:!1,beginPos:null,endPos:null,STATE_SHARED:{_contextState:!0,_contextId:!0,_numCtx:!0,_parent:!0,_parentOperand:!0,_expression:!0,_level:!0,_instanceStateShared:!0,beginPos:!0,endPos:!0,STATE_SHARED:!0,STATE_VARS:!0,STATE_PROTO:!0,OPERANDS:!0,_parenthesis:!0},STATE_PROTO:{},STATE_VARS:[],_instanceStateShared:null,_contextState:null,_contextId:"0",_numCtx:1,_parenthesis:!1,setExpression:function(t){if(Amm.is(t,"Amm.Expression","Expression"),this._expression!==t){this._expression&&Error("Can setExpression() only once"),this._expression=t;for(var e=0,i=this.OPERANDS.length;e<i;e++){var r=this["_"+this.OPERANDS[e]+"Operator"];r&&r.setExpression(t)}return this._defSub&&this._subscribeDeferreds(),!0}},_subscribeDeferreds:function(){for(var t=0;t<this._defSub.length;t++)this._expression.subscribeOperator(this._defSub[t][0]||this._expression,this._defSub[t][1],this,this._defSub[t][2]);this._defSub=null},getExpression:function(){return this._expression},setParent:function(t,e){this._parent=t,void 0!==e&&(this._parentOperand=e);var i=t.getExpression();i&&this.setExpression(i)},getParent:function(){return this._parent},getParentOperand:function(){return this._parentOperand},getLevel:function(){return null===this._level&&this._parent&&(this._level=this._parent?this._parent.getLevel()+1:0),this._level},_sub:function(t,e,i,r,n){var s=this._expression||(this["Amm.Expression"]?this:null);if(s||this._defSub||(this._defSub=[]),t?Amm.Array.indexOf(t,this._subs)<0&&this._subs.push(t):(t=s||null,s||(n=!0)),r=r||null,i=i||this._defaultHandler,"string"!=typeof e)if(e instanceof Array)for(var o=0,a=e.length;o<a;o++)(n||t.hasEvent(e[o]))&&(s?s.subscribeOperator(t,e[o],this,i,r):this._defSub.push([t,e[o],i,r]));else for(var o in e)e.hasOwnProperty(o)&&(n||t.hasEvent(o))&&(s?s.subscribeOperator(t,o,this,e[o],r):this._defSub.push([t,o,e[o],r]));else{if(!n&&!t.hasEvent(e))return;s?s.subscribeOperator(t,e,this,i,r):this._defSub.push([t,e,i,r])}},_unsub:function(t,e,i,r){if(void 0===r&&arguments.length<4&&(r=null),t=t||null,this._defSub)for(var n=this._defSub.length-1;0<=n;n--)(this._defSub[n][0]===t&&void 0===e||e===this._defSub[n][1]&&void 0===i||i===this._defSub[n][2]&&void 0===r||r===this._defSub[n][3])&&this._defSub.splice(n,1);else{var s,o=this._expression||(this["Amm.Expression"]?this:null);if(!o)return;o.unsubscribeOperator(t,e,this,i,r)||0<=(s=Amm.Array.indexOf(t,this._subs))&&this._subs.splice(s,1)}},notifyOperandChanged:function(t,e,i,r){this._propagateContext(t,r,!1),this._lockChange||this._setOperandValue(t,e)},notifyOperandContentChanged:function(t,e,i){if(null===this._contentChanged){if(!this._isEvaluating){var r=this._expression||(this["Amm.Expression"]?this:null);if(!r||!r.getUpdateLevel())return this.evaluate(),!0;r.queueUpdate(this)}}else this._contentChanged++},_observeOperandContent:function(t,e,i){var r="_"+t+"Observe",n=this[r],s=!1,o=!1;if(n&&i?(o=this._implObserveOperandContent(t,e,i),this[r]=!1,s=n===Amm.Operator.CONTENT_PERIODICALLY_CHECKED):n||i||(s=(o=this[r]=this._implObserveOperandContent(t,e,i))===Amm.Operator.CONTENT_PERIODICALLY_CHECKED),!s)return o;if(i){for(var a=!1,h=0,l=this.OPERANDS.length;h<l&&!(a=this["_"+this.OPERANDS[h]+"Observe"]===Amm.Operator.CONTENT_PERIODICALLY_CHECKED);h++);a||this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_CONTENT)}else{var u=this._nonCacheable|Amm.Operator.NON_CACHEABLE_CONTENT;this._setNonCacheable(u)}return o},_isValueObservable:function(t,e){if(e&&"object"==typeof e)return e["Amm.Array"]||e instanceof Array},_implObserveOperandContent:function(t,e,i){if(e&&"object"==typeof e)return e["Amm.Array"]?(i?this._unsub(e,"spliceItems",this._handleAmmArraySplice,t):this._sub(e,"spliceItems",this._handleAmmArraySplice,t,!0),Amm.Operator.CONTENT_NOTIFIED):e instanceof Array?(this["_"+t+"Old"]=i?void 0:[].concat(e),Amm.Operator.CONTENT_PERIODICALLY_CHECKED):void 0},_handleAmmArraySplice:function(t,e,i,r){var n=this._makeChangeInfoForSplice(t,e,i);r=arguments[arguments.length-1],this.notifyOperandContentChanged(r,n,!0)},_checkContentChanged:function(t){var e,i,r,n="_"+t+"Old",s=this[n],o=this["_"+t+"Value"];o instanceof Array?(this[n]=[].concat(o),s instanceof Array&&((e=Amm.Array.smartDiff(s,o,null,!0))&&("splice"!==e[0]&&Error("Assertion - should receive only 'splice' event (spliceOnly === true)"),i=e[2]?s.slice(e[1],e[1]+e[2]):[],r=this._makeChangeInfoForSplice(e[1],i,e[3]),this.notifyOperandContentChanged(t,r,!0)))):this[n]=null},_makeChangeInfoForSplice:function(t,e,i){return{"Amm.SpliceInfo":"__STRUCT__",type:"splice",index:t,cut:e,insert:i}},getReportsContentChanged:function(){return!1},getValue:function(t){return!t&&this._hasValue||this.evaluate(t),this._value},setValue:function(t,e){if(!this.supportsAssign)throw Error(Amm.getClass(this)+" cannot be used as lvalue");var i=this._doSetValue(t);if(!i)return!0;if(e)throw i;return!1},_doSetValue:function(t,e){if(e)return"assignment not supported";Error("Call to abstract method _doSetValue")},getReadonly:function(){return(this.supportsAssign?this._doSetValue(void 0,!0):"assignment not supported")||!1},_doEvaluate:function(t){Error("Call to abstract method _doEvaluate")},toFunction:function(){Error("Call to abstract method toFunction")},assignmentFunction:function(){Error("Call to abstract method assignmentFunction")},_operandFunction:function(t){var e="_"+t+"Operator";if(this[e])return this[e].toFunction();var i=this._getOperandValue(t);return function(){return i}},_reportChange:function(t){this._parent&&this._parent.notifyOperandChanged(this._parentOperand,this._value,t,this)},_checkNonCacheableOperators:function(){if(!(this._hasNonCacheable<=!!this._nonCacheable))for(var t=0,e=this.OPERANDS.length;t<e;t++){var i="_"+this.OPERANDS[t]+"Operator";this[i]&&(this[i]._contextId!==this._contextId&&this._propagateContext(i,this[i],!0),this[i]._hasNonCacheable&&this[i].checkForChanges())}},checkForChanges:function(){if(this._hasNonCacheable){var t=this._evaluated;if(this._checkNonCacheableOperators(),this._nonCacheable&Amm.Operator.NON_CACHEABLE_CONTENT){for(var e=this._contentChanged=0,i=this.OPERANDS.length;e<i;e++)this["_"+this.OPERANDS[e]+"Observe"]===Amm.Operator.CONTENT_PERIODICALLY_CHECKED&&this._checkContentChanged(this.OPERANDS[e]);this._contentChanged&&this.evaluate(),this._contentChanged=null}this._nonCacheable&Amm.Operator.NON_CACHEABLE_VALUE&&this._evaluated===t&&this.evaluate()}},evaluate:function(t){this._isEvaluating++,this._evaluated++,this._hasValue=!0;var e=this._doEvaluate(t),i=this._value,r=this._hasValue&&this._value!==e;return r&&this._checkArrayChange&&e instanceof Array&&this._value instanceof Array&&Amm.Array.equal(this._value,e)&&(r=!1,e=this._value),this._value=e,r&&this._reportChange(i),this._destChanged&&(this._destChanged=!1,this._parent.notifyWriteDestinationChanged(this)),this._isEvaluating--,this._value},_defaultHandler:function(){var t=this._expression||(this["Amm.Expression"]?this:null);t&&t.getUpdateLevel()?t.queueUpdate(this):this.evaluate()},hasOperand:function(t){return!(!this["_"+t+"Exists"]&&!this["_"+t+"Operator"])},_setOperand:function(t,e){var i,r="_"+t+"Operator",n="_"+t+"Value",s="_"+t+"Exists",o="_"+t+"Observe",a=e&&"object"==typeof e&&e["Amm.Operator"];if(this[r]){if(this[r]===e)return;this[r]._hasNonCacheable&&this._setHasNonCacheable(this._hasNonCacheable-1),this[r].cleanup()}if(a){if(this[o]&&this._observeOperandContent(t,this[n],!0),e.getReportsContentChanged()&&(this[o]=Amm.Operator.CONTENT_OPERAND_REPORTED),(this[r]=e)._hasNonCacheable&&this._setHasNonCacheable(this._hasNonCacheable+1),!this[s])return this[r].setParent(this,t),void(this[n]=void 0);this._lockChange++,this[r].setParent(this,t),i=this[r].getValue(),this._lockChange--;var h=t+"OperatorChange";"function"==typeof this[h]&&this[h](this[r])}else i=e;this._setOperandValue(t,i)},_setOperandValue:function(t,e){var i,r,n,s,o="_"+t+"Value",a="_"+t+"Exists",h="_"+t+"Change",l="_"+t+"Events",u=this[o],c=this[a],m=!c||this[o]!==e;this[l]&&(i=e&&e["Amm.WithEvents"]?e:null,r=this[a]&&this[o]&&this[o]["Amm.WithEvents"]?this[o]:null),this[a]=!0,this[o]=e,(i||r)&&this[l](i,r),m&&(this[n="_"+t+"Observe"]!==Amm.Operator.CONTENT_OPERAND_REPORTED&&(this[n]&&this._observeOperandContent(t,u,!0),this._isValueObservable(t,e)&&this._observeOperandContent(t,e)),this.supportsAssign&&this._parent&&this._parent["Amm.Expression"]&&(this._destChanged=!0),this[h]&&this[h](e,u,c),this._isEvaluating||((s=this._expression||(this["Amm.Expression"]?this:null))&&s.getUpdateLevel()?s.queueUpdate(this):this.evaluate()))},finishUpdate:function(){this.evaluate()},_propagateContext:function(t,e,i){i?e.setContextId(this._contextId):this.setContextId(e._contextId)},_getOperandValue:function(t,e){var i=this["_"+t+"Operator"],r="_"+t+"Value",n="_"+t+"Exists";if(i&&i._contextId!==this._contextId&&this._propagateContext(t,i,!0),i&&(e||!this[n]||i._hasNonCacheable)&&this._setOperandValue(t,i.getValue(e)),this[n])return this[r]},_setNonCacheable:function(t){if(this._nonCacheable!==t)return(this._nonCacheable=t)?this._setHasNonCacheable(this._hasNonCacheable+1):this._setHasNonCacheable(this._hasNonCacheable-1),!0},getNonCacheable:function(){return this._nonCacheable},_setHasNonCacheable:function(t){(t=parseInt(t))<0&&(t=0);var e=this._hasNonCacheable;if(e!==t)return!!e!=!!(this._hasNonCacheable=t)&&this._reportNonCacheabilityChanged(!!t),!0},_reportNonCacheabilityChanged:function(t){this._parent&&this._parent.notifyOperandNonCacheabilityChanged(this._parentOperand,t,this)},notifyOperandNonCacheabilityChanged:function(t,e,i){this._contextId!==i._contextId&&this._propagateContext(t,i),e?this._setHasNonCacheable(this._hasNonCacheable+1):this._setHasNonCacheable(this._hasNonCacheable-1)},getHasNonCacheable:function(){return this._hasNonCacheable},getOperator:function(t){t?"number"==typeof t&&(t=this.OPERANDS[t]):t=this.OPERANDS[0];var e,i="_"+t+"Operator";if(!(i in this))throw Error("No such operand: '"+t+"' in '"+Amm.getClass(this));return(e=this[i])&&1<arguments.length?e.getOperator.apply(e,Array.prototype.slice.call(arguments,1)):e},deleteContext:function(t){if(void 0===t)t=this._contextId;else if(t!==this._contextId){if(!this._contextState[t])return;this.setContextId(t)}this._partialCleanup(),null!==this._contextState&&(this._contextState[t]=null);for(var e=0,i=this.OPERANDS.length;e<i;e++){var r=this["_"+this.OPERANDS[e]+"Operator"];r&&r.deleteContext(t)}this._numCtx--},_partialCleanup:function(){var t=this._subs;this._subs=[];var e=this._expression||(this["Amm.Expression"]?this:null);if(e)for(var i=t.length-1;0<=i;i--)e.unsubscribeOperator(t[i],void 0,this,void 0,void 0)},cleanup:function(){this._partialCleanup(),this._parent=null;this._expression||this["Amm.Expression"];this._expression=null,this._defSub=null,this._contextState={};for(var t=0,e=this.OPERANDS.length;t<e;t++){var i=this.OPERANDS[t],r="_"+i+"Operator";this["_"+i+"Value"]=null,this[r]&&(this[r].cleanup(),this[r]=null)}},getSrc:function(){var t=this._expression;if(!t)for(t=this._parent;t&&!t["Amm.Expression"];)t=t._parent;if(t&&null!==this.beginPos)return t.getSrc(this.beginPos,this.endPos)},createContext:function(t){var e=Amm.Operator.getNextContextId();return this.setContextId(e),t&&"object"==typeof t&&Amm.init(this,t),e},setContextIdToDispatchEvent:function(t,e,i){this.setContextId(t)},setContextId:function(t){var e,i;this._contextId!==t&&(this._contextState||(this._contextState={},this._populateInstanceStateShared()),null!==this._contextState[this._contextId]&&(this._contextState[this._contextId]=this._getContextState()),i=!1,t in this._contextState?null===(e=this._contextState[t])&&Error("Attempt to setContextId() of already destroyed context"):(e=this._constructContextState(),i=!0,this._numCtx++),this._contextId=t,this._setContextState(e,i))},getContextId:function(){return this._contextId},hasContext:function(t){return this._contextId===t||this._contextState&&this._contextState[t]},listContexts:function(){var t=[];for(var e in this._contextState)this._contextState.hasOwnProperty(e)&&null!==this._contextState[e]&&t.push(e);return this._contextId in this._contextState||t.push(this._contextId),t},_getContextState:function(){for(var t={},e=0,i=this.STATE_VARS.length;e<i;e++){var r=this.STATE_VARS[e];this._instanceStateShared&&this._instanceStateShared[r]||(t[r]=this[r])}return t},_constructContextState:function(){for(var t={},e=0,i=this.STATE_VARS.length;e<i;e++){var r=this.STATE_VARS[e];this._instanceStateShared&&this._instanceStateShared[r]||(t[r]=this.STATE_PROTO[r])}return t._subs=[],t},_setContextState:function(t,e){for(var i in e&&!this._allSubs&&(this._allSubs=[].concat(this._subs)),this.getExpression(),t)t.hasOwnProperty(i)&&(this[i]=t[i]);e&&this._initContextState(this._contextId,!0),this._defSub&&this._expression&&this._subscribeDeferreds()},_initContextState:function(t,e){if(e){this._isEvaluating++;for(var i=0,r=this.OPERANDS.length;i<r;i++){var n,s="_"+this.OPERANDS[i],o=s+"Operator",a=s+"Value",h=s+"Exists";this[h]&&!this[o]?(n=this[a],this[a]=this.STATE_PROTO[a],this[h]=!1,this._setOperandValue(this.OPERANDS[i],n)):this[o]&&this[o]._initContextState(t)}this._isEvaluating--}else this.setContextId(t)},destroyContext:function(){this._partialCleanup();var t=0;if(!(t in this._contextState))for(t in t=null,this._contextState)if(this._contextState.hasOwnProperty(t))break;null!==t&&this._setContextState(this._contextState[t])},_populateInstanceStateShared:function(){this._instanceStateShared||(this._instanceStateShared={});for(var t=0,e=this.OPERANDS.length;t<e;t++){var i=this.OPERANDS[t],r="_"+i+"Operator",n="_"+i+"Value",s="_"+i+"Exists",o="_"+i+"Observe";this._instanceStateShared[r]=!0,this[r]||(this._instanceStateShared[n]=!0,this._instanceStateShared[s]=!0,this._instanceStateShared[o]=!0)}},getNonCacheableChildren:function(t){if(!this._hasNonCacheable)return[];for(var e=[],i=0,r=this.OPERANDS.length;i<r;i++){var n=this.getOperator(this.OPERANDS[i]);n&&(n._nonCacheable&&e.push(n),t&&n._hasNonCacheable&&(e=e.concat(n.getNonCacheableChildren(!0))))}return e}},Amm.Operator.beforeExtend=function(t,e,i){t.prototype.STATE_SHARED||(t.prototype.STATE_SHARED={}),Amm.override(t.prototype.STATE_SHARED||{},this.prototype.STATE_SHARED),t.beforeExtend||(t.beforeExtend=this.beforeExtend),t.prototype.STATE_VARS instanceof Array||(t.prototype.STATE_VARS=[]),t.prototype.STATE_PROTO||(t.prototype.STATE_PROTO={})},Amm.Operator.afterExtend=function(t,e,i){Amm.Operator.populateStateVars(t),t.afterExtend||(t.afterExtend=this.afterExtend)},Amm.Operator.populateStateVars=function(t){var e=t.prototype;for(var i in e)e.hasOwnProperty(i)&&!e.STATE_SHARED[i]&&"function"!=typeof e[i]&&"__CLASS__"!==e[i]&&"__PARENT__"!==e[i]&&"__INTERFACE__"!==e[i]&&(e.STATE_VARS.push(i),e.STATE_PROTO[i]=e[i]);if(e.OPERANDS instanceof Array)for(var i=0,r=e.OPERANDS.length;i<r;i++){var n=e.OPERANDS[i],s="_"+n+"Value",o="_"+n+"Exists",a="_"+n+"Observe";e.STATE_VARS.push(s,o,a),e.STATE_PROTO[s]=null,e.STATE_PROTO[o]=null,e.STATE_PROTO[a]=null}},Amm.Operator.populateStateVars(Amm.Operator),Amm.WithEvents.Proxy=function(){},Amm.WithEvents.Proxy.prototype={subscribeObject:function(t,e,i,r,n,s){return t.subscribe(e,i,r,n,s)},unsubscribeObject:function(t,e,i,r,n,s){return t.unsubscribe(e,i,r,n,s)},getObjectSubscribers:function(t,e,i,r,n,s){return t.getSubscribers(e,i,r,n,s)},getUniqueObjectSubscribers:function(t,e,i){return t.getUniqueSubscribers(e,i)},unsubscribeObjectByIndex:function(t,e,i){return t.unsubscribeByIndex(e,i)}},Amm.WithEvents.Proxy.instance=new Amm.WithEvents.Proxy,Amm.WithEvents.DispatcherProxy=function(t){this._subscriptions=[],Amm.init(this,t)},Amm.WithEvents.DispatcherProxy.ANY={},Amm.WithEvents.DispatcherProxy.SKIP_CALL_HANDLER={},Amm.WithEvents.DispatcherProxy.SimpleCompareExtra=function(t,e){return t===Amm.WithEvents.DispatcherProxy.ANY||e===Amm.WithEvents.DispatcherProxy.ANY||t===e?0:-1},Amm.WithEvents.DispatcherProxy.ArrCompareExtra=function(t,e){if(t===Amm.WithEvents.DispatcherProxy.ANY)return 0;if(e===Amm.WithEvents.DispatcherProxy.ANY)return 0;if(!(t instanceof Array&&e instanceof Array))return-1;if(t.length!==e.length)return-1;for(var i=0,r=t.length;i<r;i++)if(t[i]!==Amm.WithEvents.DispatcherProxy.ANY&&e[i]!==Amm.WithEvents.DispatcherProxy.ANY&&t[i]!==e[i])return-1;return 0},Amm.WithEvents.DispatcherProxy.prototype={"Amm.WithEvents.DispatcherProxy":"__CLASS__",_eventsProxy:Amm.WithEvents.Proxy.instance,_subscriptions:null,scope:null,beforeDispatch:null,afterDispatch:null,beforeCallHandler:null,afterCallHandler:null,beforeCallHandlerReturnsNewExtra:!1,compareExtra:Amm.WithEvents.DispatcherProxy.ArrCompareExtra,setEventsProxy:function(t){Amm.is(t,Amm.WithEvents.Proxy,"eventsProxy"),this._eventsProxy=t},getEventsProxy:function(){return this._eventsProxy},doCallHandler:function(t,e,i,r){var n=t[1],s=t[0],o=[].concat(i);s.apply||(s=n[s]),void 0!==r&&o.push(r),s.apply(n,o)},dispatchEvent:function(){var t=arguments[arguments.length-1],e=Array.prototype.slice.call(arguments,0,-1);t.eventName||Error("Queue array (extra) not provided to Amm.WithEvents.DispatcherProxy.dispatchEvent method");t.eventName;this.beforeDispatch&&(this.scope?this.beforeDispatch.call(this.scope,t.eventName,t,arguments):this.beforeDispatch(t.eventName,t,arguments));for(var i=0;i<t.length;i++){var r=t[i][2];if(this.beforeCallHandler){var n=this.scope?this.beforeCallHandler.call(this.scope,t.eventName,t,arguments,i,r):this.beforeCallHandler(t.eventName,t,arguments,i,r);if(n===Amm.WithEvents.DispatcherProxy.SKIP_CALL_HANDLER)continue;this.beforeCallHandlerReturnsNewExtra&&(r=n)}r=r||void 0,this.doCallHandler(t[i],t.eventName,e,r),this.afterCallHandler&&(this.scope?this.afterCallHandler.call(this.scope,t.eventName,t,arguments,i,r):this.afterCallHandler(t.eventName,t,arguments,i,r))}this.afterDispatch&&(this.scope?this.afterDispatch.call(this.scope,t.eventName,t,arguments):this.afterDispatch(t.eventName,t,arguments))},subscribeObject:function(t,e,i,r,n){var s,o=this._eventsProxy.getObjectSubscribers(t,e,this.dispatchEvent,this);if(1<o.length&&Error("Assertion: Amm.WithEvents.DispatcherProxy.dispatchEvent handler must be subscribed only once"),void 0===n&&(n=null),void 0===r&&(r=null),!o.length)return this._subscriptions.push(t),(s=[[i,r,n]]).eventName=e,void this._eventsProxy.subscribeObject(t,e,this.dispatchEvent,this,s);(s=o[0][2])&&s.eventName===e||Error("Assertion: we found wrong queue array");for(var a=0,h=s.length;a<h;a++)if(s[a][0]===i&&s[a][1]===r&&!this.compareExtra(s[a][2],n))return;s.push([i,r,n])},unsubscribeObject:function(t,e,i,r,n){t||Error("`object` parameter is required");var s=this._eventsProxy.getObjectSubscribers(t,e,this.dispatchEvent,this),o=0;if(!s.length)return 0;if(e&&1<s.length)throw Error("Assertion: Amm.WithEvents.DispatcherProxy.dispatchEvent handler must be subscribed only once");for(var a=0,h=s.length;a<h;a++){var l=s[a][2];l&&l.eventName&&(!e||l.eventName===e)||Error("Assertion: we found wrong queue array");for(var u=l.length-1;0<=u;u--)void 0!==i&&l[u][0]!==i||void 0!==r&&l[u][1]!==r||void 0!==n&&this.compareExtra(l[u][2],n)?o++:l.splice(u,1);l.length||this._removeQueue(t,s[a][3],s[a][4])}return o},getObjectSubscribers:function(t,e,i,r,n){t||Error("`object` parameter is required");var s=this._eventsProxy.getObjectSubscribers(t,e,this.dispatchEvent,this);if(!s.length)return 0;void 0!==e&&1<s.length&&Error("Assertion: Amm.WithEvents.DispatcherProxy.dispatchEvent handler must be subscribed only once");for(var o=[],a=0,h=s.length;a<h;a++){var l=s[a][3],u=s[a][2];u&&u.eventName&&u.eventName===l||Error("Assertion: we found wrong queue array");for(var c=u.length-1;0<=c;c--)void 0!==i&&u[c][0]!==i||void 0!==r&&u[c][1]!==r||void 0!==n&&this.compareExtra(u[c][2],n)||o.push([].concat(u[c],[l,c]))}return o},getUniqueObjectSubscribers:function(t,e,i){for(var r=this.getObjectSubscribers(t,void 0),n=[],s=0,o=r.length;s<o;s++){var a=r[j][1];a&&(void 0!==e&&!Amm.is(a,e)||n.push(a))}return Amm.Array.unique(n)},_removeQueue:function(t,e,i){var r;this._eventsProxy.unsubscribeObjectByIndex(t,e,i),this._eventsProxy.getObjectSubscribers(t,void 0,this.dispatchEvent,this).length||0<=(r=Amm.Array.indexOf(this._subscriptions,t))&&this._subscriptions.splice(r,1)},unsubscribeObjectByIndex:function(t,e,i){var r=this._eventsProxy.getObjectSubscribers(t,e,this.dispatchEvent,this);if(!r.length)return[];1<r.length&&Error("Assertion: Amm.WithEvents.DispatcherProxy.dispatchEvent handler must be subscribed only once");var n=r[0][2];if(!n.eventName||n.eventName!==e)throw Error("Assertion: we found wrong queue array");if(!n[i])return[];var s=[[].concat(n[i],[e,i])];return n.splice(i),n.length||this._removeQueue(t,e,r[0][4]),s}},Amm.extend(Amm.WithEvents.DispatcherProxy,Amm.WithEvents.Proxy),Amm.Operator.VarsProvider=function(t,e){this._isEvaluating++,e&&"object"!=typeof e&&Error("`vars` must be an object"),this._vars=e||{},Amm.Operator.call(this),t&&this.setOperator(t),this._isEvaluating--},Amm.Operator.VarsProvider.prototype={"Amm.Operator.VarsProvider":"__CLASS__",_vars:null,_varsProvider:null,_varsProviderContextId:null,_allVars:null,_operatorOperator:null,_operatorValue:null,_operatorExists:null,_consumers:null,OPERANDS:["operator"],STATE_SHARED:{_varsProvider:!0},setOperator:function(t){this._setOperand("operator",t),this._operatorOperator&&(this.supportsAssign=this._operatorOperator.supportsAssign),this._hasValue||this._operatorOperator._hasValue||(this._value=this._operatorOperator._value)},_doSetValue:function(t,e){return e||this._operatorOperator._doSetValue(t),this._operatorOperator.getReadonly()},_doEvaluate:function(t){return this._getOperandValue("operator",t)},toFunction:function(){var n,t,s=this._operandFunction("operator"),o=this._vars?this._vars:{};return(t=this._operatorOperator&&this._operatorOperator.supportsAssign?(n=this._operatorOperator.assignmentFunction(),function(t,e){var i,r=t.vars;return t.vars=Amm.override({},t.vars,o),i=1<arguments.length?n(t,e):s(t),t.vars=r,i}):function(t){var e=t.vars;t.vars=Amm.override({},t.vars,o);var i=s(t);return t.vars=e,i}).vars=o,t},assignmentFunction:function(){return this._operatorOperator?this._operatorOperator.assignmentFunction():function(){return"`operator` not provided"}},setContextIdToDispatchEvent:function(t,e,i){("varsChange"!==e||i[3]===this._varsProvider&&i[4]===t)&&Amm.Operator.prototype.setContextIdToDispatchEvent.call(this,t,e,i)},notifyProviderVarsChange:function(t,e,i,r){if(i){if(this._vars&&i in this._vars)return;var n=Amm.override({},this._allVars||this.getVars());this._allVars[i]=t,this._providerVars&&(this._providerVars[i]=t),this._consumers&&this._notifyConsumers(t,e,i)}else n=Amm.override({},this._allVars||this.getVars()),this._allVars=Amm.override({},t,this._vars),this._providerVars=t,this._consumers&&this._notifyConsumers(this._allVars,n,"")},setVarsProvider:function(t){var e=this._varsProvider,i=this._varsProviderContextId;if(e!==t||i!==this._varsProviderContextId)return e&&Error("Can setVarsProvider() only once"),t&&t["Amm.Operator.VarsProvider"]||Error("varsProvider must be an instance of Amm.Operator.VarsProvider"),this._varsProvider=t,this._varsProviderContextId=t._contextId,this._varsProvider.addConsumer(this,""),!0},_initContextState:function(t,e){Amm.Operator.prototype._initContextState.call(this,t,e),e&&this._varsProvider&&(this._varsProviderContextId=this._varsProvider._contextId,this._varsProvider.addConsumer(this,""))},getVarsProvider:function(){return this._varsProvider},setVars:function(t,e){this["Amm.Expression"]||this._expression;if(e){if("string"!=typeof e&&Error("setVars(`value`, `name`): `name` must be a string"),t===(i=this._vars[e]))return;this._vars[e]=t,this._varsProvider&&(this._allVars||this.getVars(),this._allVars[e]=t),this._consumers&&this._notifyConsumers(t,i,e)}else{"object"!=typeof t&&Error("setVars(`value`): object required");var i=Amm.override({},this._allVars||this.getVars());t=t||{},this._vars=Amm.override({},t),this._allVars=null,this._consumers&&this._notifyConsumers(this.getVars(),i,"")}return!0},getVars:function(t,e){return e||!this._varsProvider?t?this._vars[t]:this._vars:(this._providerVars||(this._providerVars=this._varsProvider.getVars()),this._allVars||(this._allVars=Amm.override({},this._providerVars,this._vars)),t?this._allVars[t]:this._allVars)},setExpression:function(t){for(var e=Amm.Operator.prototype.setExpression.call(this,t),i=this._parent;i;i=i._parent)if(i["Amm.Operator.VarsProvider"])return void this.setVarsProvider(i);return e},_partialCleanup:function(){var t;this._vars={},this._providerVars=null,this._allVars=null,this._consumers=null,this._varsProvider&&this._varsProvider.hasContext(this._varsProviderContextId)&&(this._varsProviderContextId!==this._varsProvider._contextId&&(t=this._varsProvider._contextId,this._varsProvider.setContextId(this._varsProviderContextId)),this._varsProvider.deleteConsumer(this,""),t&&this._varsProvider.setContextId(t)),Amm.Operator.prototype._partialCleanup.call(this)},cleanup:function(){var t;this._varsProvider&&this._varsProvider.hasContext(this._varsProviderContextId)&&(this._varsProviderContextId!==this._varsProvider._contextId&&(t=this._varsProvider._contextId,this._varsProvider.setContextId(this._varsProviderContextId)),this._varsProvider.deleteConsumer(this,""),t&&this._varsProvider.setContextId(t)),this._varsProvider=null,this._consumers=null,Amm.Operator.prototype.cleanup.call(this)},_constructContextState:function(){var t=Amm.Operator.prototype._constructContextState.call(this);return t._vars={},t._consumers=null,t},addConsumer:function(t,e){e=e||"",this._consumers?this._consumers[e]||(this._consumers[e]=[]):(this._consumers={},this._consumers[e]=[]);var i=t._contextId!==this._contextId?[t,t._contextId]:t;this._consumers[e].push(i)},deleteConsumer:function(t,e){if(this._consumers){e=e||"";var i=t._contextId;if(i===this._contextId&&(i=null),this._consumers[e])for(var r=0,n=this._consumers[e].length;r<n;r++){var s=this._consumers[e][r];if(null===i&&s===t||s[0]===t&&s[1]===i)return void this._consumers[e].splice(r,1)}}},_notifyConsumers:function(t,e,i){if(this._consumers){var r,n,s,o,a,h,l,u,c,m=this._consumers,_=this._contextId,d=!1;""===(i=i||"")?c=Amm.keys(m):(c=["",i],l=t,h=e,u=i);for(var p=0,f=c.length;p<f;p++)if(m[c[p]]){if(r=c[p],""===i){if(""!==r&&e&&t&&e[r]===t[r])continue;u=""!==r?(l=t?t[r]:void 0,h=e?e[r]:void 0,r):(l=t,h=e,"")}for(n=0,s=m[r].length;n<s;n++)a=m[r][n][0]?(o=m[r][n][0],m[r][n][1]):(o=m[r][n],_),d||(d=!0,this._expression?this._expression._beginUpdate():this["Amm.Expression"]&&this._beginUpdate()),o._contextId!==a&&o.setContextId(a),o.notifyProviderVarsChange(l,h,u,this)}d&&(this._expression?this._expression._endUpdate():this["Amm.Expression"]&&this._endUpdate())}}},Amm.extend(Amm.Operator.VarsProvider,Amm.Operator),Amm.Expression=function(t,e,i,r,n){var s;Amm.WithEvents.DispatcherProxy.call(this),t&&"string"==typeof t&&(t={src:t}),t&&t["Amm.Operator"]&&(s=t,t={}),Amm.Operator.VarsProvider.call(this,s),Amm.WithEvents.call(this,t,!0),e&&(t.expressionThis=e),t.writeProperty&&(i=t.writeProperty,delete t.writeProperty),t.writeObject&&(r=t.writeObject,delete t.writeObject),t.writeArgs&&(n=t.writeArgs,delete t.writeArgs),Amm.init(this,t),i&&this.setWriteProperty(i,r,n)},Amm.Expression.compareByContextIdAndLevel=function(t,e){return e[1]!==t[1]?t[1]-e[1]:e[0].getLevel()-t[0].getLevel()},Amm.Expression.THIS_WRITE_NEVER=0,Amm.Expression.THIS_WRITE_ALWAYS=1,Amm.Expression.THIS_WRITE_ONCE=2,Amm.Expression.THIS_WRITE_AUTO=3,Amm.Expression.prototype={"Amm.Expression":"__CLASS__",cleanupWithThis:!0,_expressionThis:null,_writeProperty:null,_writeObject:null,_writeArgs:null,_lockWrite:0,_writeDestinationChanged:!1,_src:null,_updateLevel:0,_updateQueue:null,_updateQueueSorted:!1,_currChangeInfo:null,_writeToExpressionThis:Amm.Expression.THIS_WRITE_AUTO,setWriteToExpressionThis:function(t){if(this._writeToExpressionThis!==t)return this._writeToExpressionThis=t,this._propagateExpressionThis(),!0},getWriteToExpressionThis:function(){return this._writeToExpressionThis},_propagateExpressionThis:function(){if(this._writeToExpressionThis&&this._expressionThis&&this._writeObject&&this._writeObject["Amm.Expression"]){if(this._writeToExpressionThis===Amm.Expression.THIS_WRITE_AUTO){if(this._writeObject.getExpressionThis())return void(this._writeToExpressionThis=Amm.Expression.THIS_WRITE_NEVER);this._writeToExpressionThis=Amm.Expression.THIS_WRITE_ALWAYS}this._writeObject.setExpressionThis(this._expressionThis),this._writeToExpressionThis===Amm.Expression.THIS_WRITE_ONCE&&(this._writeToExpressionThis=Amm.Expression.THIS_WRITE_NEVER)}},STATE_SHARED:{_updateLevel:!0,_updateQueue:!0,_deferredValueChange:!0,_src:!0,_subscriptions:!0,_eventsProxy:!0,scope:!0},setExpressionThis:function(t){var e=this._expressionThis;if(e!==t)return e&&e["Amm.WithEvents"]&&e.hasEvent("cleanup")&&this._unsub(e,"cleanup",this._handleExpressionThisCleanup),(this._expressionThis=t)&&t["Amm.WithEvents"]&&t.hasEvent("cleanup")&&this._sub(t,"cleanup",this._handleExpressionThisCleanup,void 0,!0),this._propagateExpressionThis(),this.outExpressionThisChange(t,e),!0},getExpressionThis:function(){return this._expressionThis},outExpressionThisChange:function(t,e){this._out("expressionThisChange",t,e)},setWriteProperty:function(t,e,i){1===arguments.length&&t instanceof Array&&(e=(t=t[0])[1],i=t[2]),this._writeProperty&&Error("Can setWriteProperty() only once"),t||Error("writeProperty must be non-falseable"),"string"==typeof t&&(t.match(/^\w+$/)||(t=new Amm.Expression(t,this._expressionThis))),t["Amm.Expression"]&&((e||i)&&Error("When Amm.Expression is used as writeProperty, don't specify writeObject/writeArgs"),e=t,t="value",this._sub(e,"writeDestinationChanged",this._write,void 0,!0)),null==i?i=null:i instanceof Array||(i=[i]),e||this._expressionThis||Error("setExpressionThis() or provide writeObject when setting writeProperty"),this._writeProperty=t,(this._writeObject=e)&&e["Amm.WithEvents"]&&e.hasEvent("cleanup")&&this._sub(e,"cleanup",this._handleExpressionThisCleanup,void 0,!0),this._writeArgs=i,this._propagateExpressionThis(),this._write()},_write:function(){var t=this._writeObject||this._expressionThis;t&&(this._lockWrite||(this._lockWrite++,Amm.setProperty(t,this._writeProperty,this.getValue(),!1,this._writeArgs),this._lockWrite--))},getWriteProperty:function(t){return t?[this._writeProperty,this._writeObject,this._writeArgs]:this._writeProperty},getWriteObject:function(){return this._writeObject},getWriteArgs:function(){return this._writeArgs},outVarsChange:function(t,e,i,r,n){this._out("varsChange",t,e,i,r,n)},setOperator:function(t){Amm.Operator.VarsProvider.prototype.setOperator.call(this,t),this._operatorOperator&&this._operatorOperator.setExpression(this)},_deferredValueChange:null,_reportChange:function(t){var e="ctx_"+this._contextId;this._currChangeInfo=null,this._updateLevel&&this._deferredValueChange?this._deferredValueChange[e]||(this._deferredValueChange[e]={contextId:this._contextId,old:t},this._deferredValueChange.ids?this._deferredValueChange.ids.push(e):this._deferredValueChange.ids=[e]):(this.outValueChange(this._value,t),this._writeProperty&&this._write())},notifyOperandContentChanged:function(t,e,i){var r=this["_"+t+"Operator"];r&&r._contextId!==this._contextId&&this._propagateContext(t,r),this._currChangeInfo=e;var n=Amm.Operator.VarsProvider.prototype.notifyOperandContentChanged.call(this,t,e,i);return this._currChangeInfo&&(this.outValueChange(this._value,this._value,e),this._currChangeInfo=null),n},_reportNonCacheabilityChanged:function(t){Amm.Operator.VarsProvider.prototype._reportNonCacheabilityChanged.call(this,t),t?this._sub(Amm.getRoot(),"interval",this.checkForChanges,void 0,!0):this._unsub(Amm.getRoot(),"interval",this.checkForChanges)},notifyWriteDestinationChanged:function(){return this._updateLevel?this._writeDestinationChanged=!0:(this._writeDestinationChanged=!1,this._operatorOperator._contextId!==this._contextId&&this._propagateContext("operator",this._operatorOperator),this.outWriteDestinationChanged())},outWriteDestinationChanged:function(){this._out("writeDestinationChanged")},outValueChange:function(t,e,i){this._out("valueChange",t,e,i)},deleteContext:function(t){Amm.Operator.VarsProvider.prototype.deleteContext.call(this,t),this._numCtx||this.cleanup()},_handleExpressionThisCleanup:function(){this.cleanupWithThis?this.deleteContext():this.setExpressionThis(null)},cleanup:function(){for(var t=this._subscriptions.length-1;0<=t;t--)this._eventsProxy.unsubscribeObject(this._subscriptions[t],void 0,this.dispatchEvent,this);Amm.WithEvents.prototype.cleanup.call(this),this._subscriptions=[],this._numCtx=0,this._writeObject&&this._writeObject["Amm.Expression"]&&this._writeObject.cleanup(),Amm.Operator.VarsProvider.prototype.cleanup.call(this)},getIsCacheable:function(){return!this._hasNonCacheable},setSrc:function(t){this.parse(t)},setDest:function(t){return this.setWriteProperty(t,null)},getDest:function(){return this._writeObject&&this._writeObject["Amm.Expression"]?this._writeObject:this._writeProperty?this._writeProperty:void 0},getSrc:function(t,e){return arguments.length&&this._src?this._src.slice(t,e):this._src},parse:function(t){this._src&&Error("Already parsed"),this._src=t,Amm.Expression._builder||(Amm.Expression._parser=new Amm.Expression.Parser,Amm.Expression._builder=new Amm.Expression.Builder,Amm.Expression._builder.configureParser(Amm.Expression._parser)),this.setOperator(Amm.Expression._builder.unConst(Amm.Expression._parser.parse(t)))},subscribeOperator:function(t,e,i,r,n){var s=i._contextId;void 0===n&&(n=null),this.subscribeObject(t,e,r,i,[s,n])},unsubscribeOperator:function(t,e,i,r,n,s){var o=s?Amm.WithEvents.DispatcherProxy.ANY:i._contextId;return void 0===n&&(n=arguments.length<5?null:Amm.WithEvents.DispatcherProxy.ANY),this.unsubscribeObject(t,e,r,i,[o,n])},beforeDispatch:function(t,e,arguments){1<e.length&&this._beginUpdate()},afterDispatch:function(t,e,arguments){1<e.length&&this._endUpdate()},beforeCallHandler:function(t,e,arguments,i,r){var n=r[0],s=r[1],o=e[i][1];return o._contextId!==n&&o.setContextIdToDispatchEvent(n,t,arguments),s},beforeCallHandlerReturnsNewExtra:!0,getUpdateLevel:function(){return this._updateLevel},_beginUpdate:function(){this._updateLevel||(this._updateQueue=[]),this._updateLevel++,this._lockWrite++},_sortUpdateQueue:function(t){var e;this._updateQueueSorted=!0,t?t>=this._updateQueue.length-1||((e=this._updateQueue.splice(t,this._updateQueue.length-t)).sort(Amm.Expression.compareByContextIdAndLevel),this._updateQueue.push.apply(this._updateQueue,e)):this._updateQueue.sort(Amm.Expression.compareByContextIdAndLevel)},_endUpdate:function(){if(this._updateLevel||Error("Amm.Expression: _endUpdate() without _beginUpdate!"),1<this._updateLevel)return this._updateLevel--,void this._lockWrite--;this._deferredValueChange={};for(var t=0;t<this._updateQueue.length;t++){this._updateQueueSorted||this._sortUpdateQueue(t);var e=this._updateQueue[t][1],i=this._updateQueue[t][0];i._contextId!==e&&i.setContextId(e),i.finishUpdate()}this._updateLevel=0,this._lockWrite--;var r=this._deferredValueChange;if(this._deferredValueChange=null,r.ids)for(var t=0,n=r.ids.length;t<n;t++){var s=r[r.ids[t]];this._contextId!==s.contextId&&this.setContextId(s.contextId),this._reportChange(s.old)}this._writeDestinationChanged&&this.notifyWriteDestinationChanged()},queueUpdate:function(t){this._updateQueue.push([t,t._contextId]),this._updateQueueSorted=!1},_constructContextState:function(){var t=Amm.Operator.VarsProvider.prototype._constructContextState.call(this);return t._subscribers={},t},toFunction:function(){var r,t,n=this._operandFunction("operator"),s={vars:this._vars,expressionThis:this._expressionThis};return(t=this._operatorOperator&&this._operatorOperator.supportsAssign?(r=this._operatorOperator.assignmentFunction(),function(t,e){if(arguments.length){var i=r(s,t);if(i&&e)throw i;return!i}return n(s)}):function(){return n(s)}).env=s,t},findContext:function(t){if(this._expressionThis===t)return this._contextId;for(var e in this._contextState)if(this._contextState.hasOwnProperty(e)&&this._contextState[e]&&this._contextState[e]._expressionThis===t)return e}},Amm.Expression.getAllWatchers=function(){for(var t=[],e=Amm.getRoot().getUniqueSubscribers(Amm.Expression,"interval"),i=0,r=e.length;i<r;i++)t.push({expr:e[i],nc:e[i].getNonCacheableChildren(!0)});return t},Amm.Expression._builder=null,Amm.Expression._parser=null,Amm.extend(Amm.Expression,Amm.WithEvents.DispatcherProxy),Amm.extend(Amm.Expression,Amm.WithEvents),Amm.extend(Amm.Expression,Amm.Operator.VarsProvider),Amm.ArrayMapper=function(t){this._srcEntries=[],this._destEntries=[],this.beginUpdate(),Amm.WithEvents.call(this,t),this.endUpdate()},Amm.ArrayMapper.SORT_NONE=0,Amm.ArrayMapper.SORT_DIRECT=1,Amm.ArrayMapper.SORT_REVERSE=-1,Amm.ArrayMapper._SRC_ITEM=0,Amm.ArrayMapper._SRC_INDEX=1,Amm.ArrayMapper._SRC_REF_TO_DEST=2,Amm.ArrayMapper._DEST_REF_TO_SRC=0,Amm.ArrayMapper._DEST_PASS=1,Amm.ArrayMapper._DEST_SORT_VALUE=2,Amm.ArrayMapper._DEST_IN_SLICE=3,Amm.ArrayMapper._DEST_ITEM=4,Amm.ArrayMapper.prototype={"Amm.ArrayMapper":"__CLASS__",_src:null,_srcIsOwn:null,_dest:null,_destIsOwn:!1,_srcPrototype:null,_destPrototype:null,srcClass:"Amm.Array",destClass:"Amm.Array",_filter:null,_filterIsFn:null,_sort:Amm.ArrayMapper.SORT_DIRECT,_sortIsFn:null,_offset:0,_length:void 0,_hasSlice:!1,_instantiator:null,_instantiatorIsFn:null,_srcEntries:null,_destEntries:null,_destExtra:null,_updateLevel:0,_applyFilter:!1,_applySort:!1,_applySlice:!1,setSrc:function(t){if(t instanceof Array){if(this._src&this._srcIsOwn)return this._src.setItems(t);t=this._createSrc(t)}else t=t||this._createSrc();var e=this._src;if(e!==t)return Amm.is(t,this.srcClass,"src"),Amm.is(t,"Amm.Array","src"),this._srcIsOwn=t._ammArrayMapper===this,(this._src=t)&&this._subscribeSrc(t),this._dest&&this._rebuild(),t&&this._subscribeSrc(t),this.outSrcChange(t,e),e&&this._cleanupCollectionIfOwn(e),!0},getSrc:function(){return this._src||this.setSrc(null),this._src},outSrcChange:function(t,e){this._out("srcChange",t,e)},setSrcPrototype:function(t){if(this._srcPrototype!==t)return this._srcPrototype=t,!0},getSrcPrototype:function(){return this._srcPrototype},getSrcIsOwn:function(){return this._srcIsOwn},_createSrc:function(t){var e=this._srcPrototype?Amm.override({},this._srcPrototype):{};t&&(e.items=t);var i=Amm.constructInstance(e,this.srcClass);return i._ammArrayMapper=this,i},setDest:function(t){t=t||this._createDest();var e=this._dest;if(e!==t)return Amm.is(t,this.destClass,"dest"),Amm.is(t,"Amm.Array","dest"),this._destIsOwn=t._ammArrayMapper===this,this._dest=t,this._rebuild(),this.outDestChange(t,e),e&&this._cleanupCollectionIfOwn(e),!0},setDestExtra:function(t){t!==this._destExtra&&(t=(!(t instanceof Array)||t.length)&&t||null,this._destExtra instanceof Array&&t instanceof Array&&Amm.Array.equal(t,this._destExtra)||(this._destExtra=t,this._remap()))},getDestExtra:function(){return this._destExtra},getDest:function(){return this._dest||this.setDest(null),this._dest},outDestChange:function(t,e){this._out("destChange",t,e)},setDestPrototype:function(t){if(this._destPrototype!==t)return this._destPrototype=t,!0},getDestPrototype:function(){return this._destPrototype},getDestIsOwn:function(){return this._destIsOwn},_createDest:function(){var t=this._destPrototype?this._destPrototype:{},e=Amm.constructInstance(t,this.destClass);return e._ammArrayMapper=this,e},setFilter:function(t){if(t=t||null,this._filter!==t){if(t)if("object"==typeof t)t=Amm.constructInstance(t,"Amm.Filter",t),this._filterIsFn=!1;else{if("function"!=typeof t)throw Error("`filter` must be an object, a function or a null");this._filterIsFn=!0}else;return this._filter&&!this._filterIsFn&&this._unsubscribeFilter(),this._filter=t,this._filter&&!this._filterIsFn&&this._subscribeFilter(),this.applyFilter(),!0}},_subscribeFilter:function(){this._src&&this._filter.setObservedObjects(this._src.getItems()),this._filter.subscribe("matchesChange",this._handleFilterMatchesChange,this)},_unsubscribeFilter:function(){this._filter.unsubscribe("matchesChange",this._handleFilterMatchesChange,this),this._filter.setObservedObjects([])},_subscribeSort:function(){this._src&&this._sort.setObservedObjects(this._src.getItems()),this._sort.subscribe("matchesChange",this._handleSortMatchesChange,this),this._sort.subscribe("needSort",this._handleSortNeedSort,this)},_unsubscribeSort:function(){this._sort.unsubscribe("matchesChange",this._handleFilterMatchesChange,this),this._sort.unsubscribe("needSort",this._handleSortNeedSort,this),this._sort.setObservedObjects([])},_handleFilterMatchesChange:function(t,e){var i,r;for(1<t.length&&this.beginUpdate(),i=0,r=t.length;i<r;i++){var n=t[i],s=e[i];void 0!==s&&this.applyFilter(n,s)}1<t.length&&this.endUpdate()},_handleSortMatchesChange:function(t,e){var i,r;for(1<t.length&&this.beginUpdate(),i=0,r=t.length;i<r;i++){var n=t[i],s=e[i];void 0!==s&&this.applySort(n,s)}1<t.length&&this.endUpdate()},_handleSortNeedSort:function(){this._remap()},getFilter:function(){return this._filter},applyFilter:function(t,e){if(this._src)if(void 0!==t){if(this._filter)for(var i=0;0<=(i=Amm.Array.indexOf(t,this._src,i));){var r=this._srcEntries[i][Amm.ArrayMapper._SRC_REF_TO_DEST],n=r[Amm.ArrayMapper._DEST_PASS],s=void 0===e?this._getFilterValue(r[Amm.ArrayMapper._DEST_ITEM]):e;if(n!=s&&this._instantiator&&this._instantiator["Amm.Instantiator.Variants"]&&!this._instantiator.getFilter()&&this._instantiator.setMatches([t],[s]),!!n!=!!s&&(r[Amm.ArrayMapper._DEST_PASS]=s,this._updateLevel||this._remap()),this._src.getUnique())break}}else this._updateLevel?this._applyFilter=!0:(this._recalcAllFilter(),this._remap())},setSort:function(t){if(t=t||null,this._sort!==t){if(t){if("object"==typeof t)t=Amm.constructInstance(t,"Amm.Sorter"),this._sortIsFn=!1,this._sort&&this._sort["Amm.Sorter"]&&this._unsubscribeSort();else if("function"==typeof t)this._sortIsFn=!0;else if(t!==Amm.ArrayMapper.SORT_DIRECT&&t!==Amm.ArrayMapper.SORT_REVERSE)throw Error("`sort` must be an object, a function, Amm.ArrayMapper.SORT_ constant or a null")}else;return(this._sort=t)&&t["Amm.Sorter"]&&this._subscribeSort(),this.applySort(),!0}},getSort:function(){return this._sort},applySort:function(t,e){if(this._src)if(void 0!==t){if(this._sort)for(var i=-1;0<=(i=Amm.Array.indexOf(t,this._src,i+1));){var r=this._srcEntries[i][Amm.ArrayMapper._SRC_REF_TO_DEST];if(r[Amm.ArrayMapper._DEST_SORT_VALUE]!==(void 0===e?this._getSortValue(i):e)&&(r[Amm.ArrayMapper._DEST_SORT_VALUE]=e,this._updateLevel||this._remap()),this._src.getUnique())break}}else this._updateLevel?this._applySort=!0:(this._recalcAllSort(),this._remap())},_recalcAllSort:function(){for(var t,e,i,r=0,n=this._destEntries.length;r<n;r++)t=this._destEntries[r][Amm.ArrayMapper._DEST_REF_TO_SRC],i=this._sort?this._getSortValue(t[Amm.ArrayMapper._SRC_ITEM],t[Amm.ArrayMapper._SRC_INDEX]):null,e=this._destEntries[r][Amm.ArrayMapper._DEST_SORT_VALUE]!==i,this._destEntries[r][Amm.ArrayMapper._DEST_SORT_VALUE]=i;this._applySort=!1,this._sort&&e&&!this._updateLevel&&this._remap()},_recalcAllFilter:function(){for(var t,e,i,r=[],n=[],s=this._instantiator&&this._instantiator["Amm.Instantiator.Variants"]&&!this._instantiator.getFilter(),o=0,a=this._destEntries.length;o<a;o++)t=this._destEntries[o][Amm.ArrayMapper._DEST_REF_TO_SRC],i=!this._filter||this._getFilterValue(t[Amm.ArrayMapper._SRC_ITEM]),(e=this._destEntries[o][Amm.ArrayMapper._DEST_PASS]!==i)&&s&&(r.push(t[Amm.ArrayMapper._SRC_ITEM]),n.push(i)),this._destEntries[o][Amm.ArrayMapper._DEST_PASS]=i;this._applyFilter=!1,r.length&&this._instantiator.setMatches(r,n),e&&!this._updateLevel&&this._remap()},_getSortValue:function(t,e){return this._sort?this._sort===Amm.ArrayMapper.SORT_DIRECT?e:this._sort===Amm.ArrayMapper.SORT_REVERSE?-e:this._sortIsFn?this._sort(t,e):this._sort.calcSortValue(t,e):null},setOffset:function(t){if("number"!=typeof(t=t||0)&&(t=parseInt(t)),isNaN(t))throw Error("`offset` must be a number");var e=this._offset;if(e!==t){this._offset=t;var i=this._hasSlice;return this._hasSlice=!(!this._offset&&null===this._length),(this._hasSlice||i)&&(this._updateLevel?this._applySlice=!0:this._remap()),this.outOffsetChange(t,e),!0}},getOffset:function(){return this._offset},outOffsetChange:function(t,e){this._out("offsetChange",t,e)},setLength:function(t){if(null==t||!1===t||""===t?t=null:"number"!=typeof t&&(t=parseInt(t)),isNaN(t))throw Error("`length` must be null/undefined/false/empty string or a number");var e=this._length;if(e!==t){this._length=t;var i=this._hasSlice;return this._hasSlice=!(!this._offset&&null===this._length),(this._hasSlice||i)&&(this._updateLevel?this._applySlice=!0:this._remap()),this.outLengthChange(t,e),!0}},getLength:function(){return this._length},outLengthChange:function(t,e){this._out("lengthChange",t,e)},setInstantiator:function(t){var e,i=this._instantiator;if(t)if("function"==typeof t)e=!0;else{if("object"!=typeof t)throw Error("`instantiator` must be an object, a function or a null");t.class&&(t=Amm.constructInstance(t)),Amm.meetsRequirements(t,[["construct","destruct"]],"instantiator"),e=!1}else t=null;if(i!==t)return this.beginUpdate(),this._destructAll(),this._unsubscribeInstantiator(),this._instantiatorIsFn=e,this._instantiator=t,this._subscribeInstantiator(),this._constructAll(),this.endUpdate(),!0},_subscribeInstantiator:function(){this._instantiator&&this._instantiator["Amm.Instantiator.Variants"]&&(this._instantiator.subscribe("needRebuild",this._handleInstantiatorNeedRebuild,this),this._filter&&this._filter["Amm.Filter"]&&this._filter.subscribe("matchesChange",this._setInstantiatorMatches,this))},_unsubscribeInstantiator:function(){this._instantiator&&this._instantiator["Amm.Instantiator.Variants"]&&(this._instantiator.unsubscribe("needRebuild",this._handleInstantiatorNeedRebuild,this),this._filter&&this._filter["Amm.Filter"]&&this._filter.unsubscribe("matchesChange",this._setInstantiatorMatches,this))},_setInstantiatorMatches:function(t,e,i){this._instantiator.getFilter()||this._instantiator.handleFilterMatchesChange(t,e,i)},_handleInstantiatorNeedRebuild:function(t,e){var i,r,n,s,o,a,h,l,u=-1,c=this._src.getUnique();for((1<t.length||!c)&&this._dest.beginUpdate(),i=0,r=t.length;i<r;i++)if(h=e[i])for(a=t[i];0<=(n=Amm.Array.indexOf(a,this._src,n))&&(!(o=(s=this._srcEntries[n][Amm.ArrayMapper._SRC_REF_TO_DEST])[Amm.ArrayMapper._DEST_ITEM])||(u=Amm.Array.indexOf(o,this._dest,u))<0||(l=this._construct(a,h),this._dest.setItem(u,l),this._destruct(o),s[Amm.ArrayMapper._DEST_ITEM]=l,!c)););(1<t.length||!this._src.getUnique())&&this._dest.endUpdate()},_construct:function(t,e){return this._instantiator?this._instantiatorIsFn?this._instantiator(t,this):(!this._instantiator.getFilter||(i=this._instantiator.getFilter())&&i!==this._filter&&(e=void 0),this._instantiator.construct(t,e,this)):t;var i},_destruct:function(t){if(this._instantiator&&!this._instantiatorIsFn)return this._instantiator.destruct(t,this)},_destructAll:function(t){if(t=t||this._destEntries)for(var e=0,i=this._destEntries.length;e<i;e++){var r=this._destEntries[e][Amm.ArrayMapper._DEST_ITEM];r&&(this._instantiator&&this._destruct(r),t[e][Amm.ArrayMapper._DEST_ITEM]=null)}},_constructAll:function(t){if(t=t||this._destEntries)for(var e,i,r,n=0,s=t.length;n<s;n++){t[n][Amm.ArrayMapper._DEST_ITEM]||t[n][Amm.ArrayMapper._DEST_IN_SLICE]&&(e=t[n][Amm.ArrayMapper._DEST_REF_TO_SRC][Amm.ArrayMapper._SRC_ITEM],i=t[n][Amm.ArrayMapper._DEST_PASS],r=this._instantiator?this._construct(e,i):e,t[n][Amm.ArrayMapper._DEST_ITEM]=r)}},getInstantiator:function(){return this._instantiator},_cleanupCollectionIfOwn:function(t){if(t&&t._ammArrayMapper===this)return delete t._ammArrayMapper,t.cleanup(),!0},_subscribeSrc:function(t,e){t[e?"unsubscribe":"subscribe"]("spliceItems",this._handleSrcSpliceItems,this)},_getFilterValue:function(t){return!this._filter||(this._filterIsFn?this._filter(t,this):this._filter.getMatch(t))},getUpdateLevel:function(){return this._updateLevel},beginUpdate:function(){this._updateLevel++,this._dest&&this._dest.beginUpdate()},endUpdate:function(){if(!this._updateLevel)throw Error("Call to endUpdate() w/o corresponding beginUpdate()");this._updateLevel--,this._updateLevel||(this._applyFilter&&this._recalcAllFilter(),this._applySort&&this._recalcAllSort(),this._remap()),this._dest&&this._dest.getUpdateLevel()>this._updateLevel&&this._dest.endUpdate()},_handleSrcSpliceItems:function(t,e,i){this.beginUpdate(),this._filter&&!this._filterIsFn&&this._filter.beginUpdate(),this._sort&&"object"==typeof this._sort&&this._sort.beginUpdate();var r,n,s,o,a,h,l,u,c,m,_=Amm.Array.calcChanges(e,i,this._src.getComparison(),t,this._src.getUnique()),d=[];for(d.length=i.length,r=0,n=_.added.length;r<n;r++)h=[s=_.added[r][0],o=_.added[r][1],null],s&&"object"==typeof s&&(this._filter&&!this._filterIsFn&&this._filter.observeObject(s),this._sort&&this._sort["Amm.Sorter"]&&this._sort.observeObject(s)),(l=[h,!this._filter||this._getFilterValue(s),this._getSortValue(s,o),!this._hasSlice||void 0,null])[Amm.ArrayMapper._DEST_ITEM]=null,this._destEntries.push(l),h[Amm.ArrayMapper._SRC_REF_TO_DEST]=l,d[o-t]=h;for(r=0,n=_.deleted.length;r<n;r++)s=_.deleted[r][0],o=_.deleted[r][1],void 0!==(c=(l=(h=this._srcEntries[o])[Amm.ArrayMapper._SRC_REF_TO_DEST])[Amm.ArrayMapper._DEST_REF_TO_SRC])&&c!==s&&this._instantiator&&this._destruct(c),l.splice(0,l.length),u=Amm.Array.indexOf(l,this._destEntries),h.splice(0,h.length),0<=u&&this._destEntries.splice(u,1),s&&"object"==typeof s&&(this._filter&&!this._filterIsFn&&this._filter.unobserveObject(s),this._sort&&this._sort["Amm.Sorter"]&&this._sort.unobserveObject(s));for(r=0,n=_.moved.length;r<n;r++)s=_.moved[r][0],o=_.moved[r][1],a=_.moved[r][1],(h=this._srcEntries[o])[Amm.ArrayMapper._SRC_INDEX]=a,(l=h[Amm.ArrayMapper._SRC_REF_TO_DEST])[Amm.ArrayMapper._DEST_SORT_VALUE]=this._getSortValue(s,a),d[a-t]=h;for(r=0,n=_.same.length;r<n;r++)o=_.same[r][1],h=this._srcEntries[o],d[o-t]=h;if(e.length!==i.length)for(m=i.length-e.length,r=t+e.length;r<this._srcEntries.length;r++)(h=this._srcEntries[r])[Amm.ArrayMapper._SRC_INDEX]=r+m,this._sort&&(s=h[Amm.ArrayMapper._SRC_ITEM],(l=h[Amm.ArrayMapper._SRC_REF_TO_DEST])[Amm.ArrayMapper._DEST_SORT_VALUE]=this._getSortValue(s,r+m));this._srcEntries.splice.apply(this._srcEntries,[t,e.length].concat(d)),this._remap(),this._sort&&"object"==typeof this._sort&&this._sort.endUpdate(),this._filter&&!this._filterIsFn&&this._filter.endUpdate(),this.endUpdate()},_cleanAll:function(){if(this._srcEntries){for(var t,e,i,r=this._srcEntries.length-1;0<=r;r--)i=(e=(t=this._srcEntries[r])[Amm.ArrayMapper._SRC_REF_TO_DEST])[Amm.ArrayMapper._DEST_ITEM],this._instantiator&&!this._instantiatorIsFn&&i&&i!==t[Amm.ArrayMapper._SRC_ITEM]&&this._destruct(i),t.splice(0,t.length),e.splice(0,e.length),this._dest&&this._dest.setItems([]);this._srcEntries=[],this._destEntries=[]}},_rebuild:function(){this.beginUpdate(),this._cleanAll(),this._src&&this._handleSrcSpliceItems(0,[],this._src.getItems()),this.endUpdate()},_remap:function(){if(this._destEntries){this._applySort=!1,this._applyFilter=!1,this._applySlice=!1;var t,e,i,r,n=[],s=Amm.ArrayMapper._DEST_PASS,o=Amm.ArrayMapper._DEST_IN_SLICE,a=Amm.ArrayMapper._DEST_ITEM,h=Amm.ArrayMapper._DEST_REF_TO_SRC,l=Amm.ArrayMapper._SRC_ITEM;this._sort&&(r=Amm.ArrayMapper._DEST_SORT_VALUE,this._sort["Amm.Sorter"]?(i=this._sort,this._destEntries.sort(function(t,e){return i.compareMatches(t[r],e[r])})):this._destEntries.sort(function(t,e){return t[r]-e[r]}));var u,n=[];for(this._hasSlice&&(u=[]),_=0,d=this._destEntries.length;_<d;_++)e=this._destEntries[_],(t=!this._filter||e[s])?this._hasSlice?(e[o]=void 0,u.push(e)):(e[o]=!0,e[a]||(e[a]=this._instantiator?this._construct(e[h][l],t):e[h][l]),n.push(e[a])):(e[o]=!1,e[a]&&(this._instantiator&&this._destruct(e[a]),e[a]=null));if(!this._hasSlice)return this._destExtra&&(n=this._destExtra.concat(n)),void this.getDest().setItems(n);for(var c=this._getSlice(u.length),m=u.splice(c[0],c[1]-c[0]),_=0,d=m.length;_<d;_++)(e=m[_])[o]=!0,e[a]||(e[a]=this._instantiator?this._construct(e[h][l],e[s]):e[h][l]),n.push(e[a]);for(_=0,d=u.length;_<d;_++)(e=u[_])[o]=!1,e[a]&&(this._instantiator&&this._destruct(e[a]),e[a]=null);this._destExtra&&(n=this._destExtra.concat(n)),this.getDest().setItems(n)}},_getSlice:function(t){var e=this._offset,i=this._length;if(0===i)return[0,0];var r,n=e||0;return n<0&&(n=t+n),n<0&&(n=0),i?i<0?(r=t+i)<0&&(r=0):r=n+i:r=t,r<n?[0,0]:[n,r]},cleanup:function(){this._filter&&!this._filterIsFn&&(this._unsubscribeFilter(),this._filter=null),this._sort&&this._sort["Amm.Sorter"]&&(this._unsubscribeSort(),this._sort=null),this._cleanAll(),this._src&&this._cleanupCollectionIfOwn(this._src),this._dest&&this._cleanupCollectionIfOwn(this._dest),Amm.WithEvents.prototype.cleanup.call(this)},_getArrayItems:function(t,e){return t.map(function(t){return t?t[e]:void 0})}},Amm.extend(Amm.ArrayMapper,Amm.WithEvents),Amm.Collection=function(t){var i=this;this._compareWithProps=function(t,e){return i._implCompareWithProps(t,e)},this._sortWithProps=function(t,e){return i._implSortWithProps(t,e)},this._itemUpdateQueue=[],this.k={},Amm.Array.call(this,t)},Amm.Collection.ERR_NOT_AN_OBJECT="Not an object.",Amm.Collection.ERR_NOT_MEETING_REQUIREMENTS="Doesn't meet requirements.",Amm.Collection.ERR_DUPLICATE_UPDATE_NOT_ALLOWED="Duplicate; update not allowed.",Amm.Collection.ERR_ADD_DISALLOWED="Adding new items disallowed",Amm.Collection.ERR_DELETE_DISALLOWED="Deleting items disallowed",Amm.Collection.ERR_REORDER_DISALLOWED="Reordering (and inserting/deleting items not at the end) disallowed",Amm.Collection.ERR_KEY_PROPERTY_MISSING="Key property missing",Amm.Collection.ERR_KEY_PROPERTY_INVALID="Invalid key property value (must be scalar)",Amm.Collection.binSearch=function(t,e,i,r,n){var s,o,a,h,l="number"==typeof r?r:0,u="number"==typeof n?n:t.length-1;if(l<0&&(l=0),u>t.length-1&&(u=t.length-1),l>t.length-1)return[r,!1];if(0===(o=i?i(e,t[l]):-(e<t[l])||e!==t[l]|0))return[l,!0];if(o<0)return[l-1,!1];if(0===(a=i?i(e,t[u]):-(e<t[u])||e!==t[u]|0))return[u,!0];if(0<a)return[u+1,!1];for(;1<u-l;){if(s=Math.floor((l+u)/2),0===(h=i?i(e,t[s]):-(e<t[s])||e!==t[s]|0))return[s,!0];h<0?u=s:l=s}return[u,!1]},Amm.Collection.prototype={"Amm.Collection":"__CLASS__",k:null,_unique:!0,_sparse:!1,_requirements:null,_assocProperty:null,_assocInstance:null,_indexProperty:null,_observeIndexProperty:!0,_indexPropertyIsWatched:!1,_defaults:null,_undefaults:null,_changeEvents:null,_comparisonProperties:null,_onlyStrict:!1,_ignoreExactMatches:null,_recheckUniqueness:!1,_custComparison:null,_compareWithProps:null,_sortWithProps:null,_sortProperties:null,_sortReverse:!1,_sortFn:null,_sorted:!1,_sorter:null,_needSort:!1,_lockSort:0,_sorterIsAggregate:!1,_updateProperties:null,_itemUpdateLevel:0,_endItemsUpdateLock:!1,_itemUpdateQueue:null,_updateFn:null,_allowUpdate:!1,_suppressDeleteEvent:0,_suppressIndexEvents:0,_allowAdd:!0,_allowDelete:!0,_allowChangeOrder:!0,_cleanupOnDissociate:!1,_assocEvents:null,_instantiator:null,_instantiateOnAccept:!1,_keyProperty:null,_byKeyChange:!1,setUnique:function(t){if(!t)throw Error("setUnique(false) is never supported by Amm.Collection");return Amm.Array.prototype.setUnique.call(this,t)},setSparse:function(t){if(t)throw Error("setSparse(true) is never supported by Amm.Collection");return Amm.Array.prototype.setSparse.call(this,t)},setRequirements:function(t){if(!(t instanceof Array||"string"==typeof t||"function"==typeof t))throw Error("requirements must be an Array, a string or a function");if(this._requirements!==t){if(t)for(var e=0,i=this.length;e<i;e++)if(!Amm.meetsRequirements(this[e],t))throw Error("Cannot setRequirements(): at least one item ("+e+") doesn't meet new `requirements`");return this._requirements=t,!0}},setInstantiator:function(t){if(t=t||null,this._instantiator!==t)return this._instantiator=t,!0},getInstantiator:function(){return this._instantiator},setInstantiateOnAccept:function(t){if(t=!!t,this._instantiateOnAccept!==t)return this._instantiateOnAccept=t,!0},getInstantiateOnAccept:function(){return this._instantiateOnAccept},createItem:function(t){if(!this._instantiator)throw Error("Cannot createItem() when `instantiator` not provided");var e=this._instantiator.construct(t);return this.accept(e),e},getRequirements:function(){return this._requirements},canAccept:function(t,e,i){if(i=i||{},!this._allowAdd)return i.error=Amm.Collection.ERR_ADD_DISALLOWED,!1;if("object"!=typeof t||!t)return i.error=Amm.Collection.ERR_NOT_AN_OBJECT,!1;if(this._requirements&&!Amm.meetsRequirements(t,this._requirements))return i.error=Amm.Collection.ERR_NOT_MEETING_REQUIREMENTS,!1;if(this._keyProperty){if(!Amm.detectProperty(t,this._keyProperty))return i.error=Amm.Collection.ERR_KEY_PROPERTY_MISSING,!1;var r=Amm.getProperty(t,this._keyProperty);if(r&&"object"==typeof r)return i.error=Amm.Collection.ERR_KEY_PROPERTY_INVALID,!1}if(!e&&!this._allowUpdate){var n=this.indexOf(t);if(0<=n)return i.error=Amm.Collection.ERR_DUPLICATE_UPDATE_NOT_ALLOWED,i.index=n,!1}return i.index=null,i.error=null,this.outOnCanAccept(t,i),!i.error},_instantiateIfNeeded:function(t){var e=!1;return this._requirements?e=!Amm.meetsRequirements(t,this._requirements):"object"==typeof t&&Amm.getClass(t)||(e=!0),e?this._instantiator.construct(t):t},_preAccept:function(t,e,i){(e=e||0)<0&&(e=this.length+e),e>this.length&&(e=this.length);var r=e+(i=i||0);i<0&&(r=this.length+i,i=0);for(var n,s=t.concat(this.getItems()),o=i?this.slice(e,r):[],a=[],h=0,l=e;l<r;l++)a.push(l);if(this._instantiator&&this._instantiateOnAccept)for(l=0,n=t.length;l<n;l++)t[l]=this._instantiateIfNeeded(t[l]);for(l=0,n=t.length;l<n;l++){var u={};if(!this.canAccept(t[l],!0,u))throw Error("Cannot accept items["+l+"]: "+u.error)}var c=Amm.Array.findDuplicates(s,!1,this._comparison);if(!c.length)return[[].concat(t),[],[],[],o,[].concat(t),a];var m=c.length,_=[],d=[],p=[].concat(t),f=0,g=[],A=[].concat(t);for(l=0;l<m;l++){var v=c[l];if(2<v.length){var y=[];for(j=0;j<v.length;j++)y.push(this._describeIdx(v[j],t.length));throw Error("Multiple instances of same item: "+y.join(", "))}var E=s[v[0]]===s[v[1]];if(v[0]>=t.length)throw Error("WTF: we found two duplicates in `this`: "+this._describeIdx(v[0],t.length)+(E?" === ":" ~= ")+this._describeIdx(v[1],t.length));if(v[1]<t.length)throw Error("There are at least two duplicates in `items`: "+this._describeIdx(v[0],t.length)+(E?" === ":" ~= ")+this._describeIdx(v[1],t.length));var C=v[1]-t.length,b=e<=C&&C<r;if(E||this._allowUpdate||(b=!1),E&&!b&&!this._ignoreExactMatches)throw Error("Item already in collection: "+this._describeIdx(v[0],t.length)+" === "+this._describeIdx(v[1],t.length)+". setIgnoreExactMatches(true) next time.");if(!E&&!b&&!this._allowUpdate)throw Error("Added item matches existing one, but no update routine provided: "+this._describeIdx(v[0],t.length)+" ~= "+this._describeIdx(v[1],t.length)+". setUpdateProperties() and/or setUpdateFn() may help.");b&&(o[C-e]=void 0,a[C-e]=void 0,h++),b||A.splice(v[0]-_.length,1),p.splice(v[0]-f,1),f++,g.push(v[0]),_.push(s[v[0]]),d.push(s[v[1]])}if(h)for(l=o.length-1;0<=l;l--)void 0===o[l]&&(o.splice(l,1),a.splice(l,1));return[p,_,d,g,o,A,a]},_addNew:function(t,e){void 0===e||e>=this._length?(e=this.length,this.length+=t.length):this._rotate(e,t.length);for(var i=0,r=t.length;i<r;i++)this[e+i]=t[i]},_addNewToSorted:function(t){for(var e=[].concat(t),i=this._locateManyItemIndexesInSortedArray(e),r=0;r<i.length;r++)i[r]<this.length?(this._rotate(i[r],1),this[i[r]]=e[r]):this[this.length++]=e[r];return[e,i]},accept:function(t,e){var i,r,n=this._preAccept([t]);if(this._sorted&&void 0!==e)throw Error("`index` must not be used with sorted Collection - check for getIsSorted() next time");return void 0===e&&(e=this.length),e<0&&(e=this.length+e),e>this.length&&(e=this.length),n[0].length?((void 0===(r=this._sorted?this._locateItemIndexInSortedArray(t):e)||r<=0)&&(r=0),t=i=n[0][0],r<this.length?(this._rotate(r,1),this[r]=t):this[this.length++]=t,this._associate(t,r),this._outSmartSplice(r,[],[t]),this._subscribe(t),this._indexProperty&&r<this.length-1&&this._reportIndexes(null,r+1)):(i=n[2][0],this._updateItem(n[2][0],n[1][0])),i},acceptMany:function(t,e){var i=this._sorted;if(i&&void 0!==e)throw Error("`index` must not be used with sorted Collection - check for getIsSorted() next time");if(!t.length)return[];if(1===t.length)return[this.accept(t[0])];this._byKeyChange=1;var r=this._preAccept([].concat(t));if(r[0].length){var n,s=this.getItems();if(i){var o=this._addNewToSorted(r[0]);for(h=0;h<o[0].length;h++)this._associate(o[0][h],o[1][h]);this._outFragmentedInsert(this._getInsertFragments(o[0],o[1])),n=o[1][0]}else{for(e<0&&(e=this.length+e),(void 0===e||e>this.length)&&(e=this.length),n=e,this._addNew(r[0],e),h=0;h<r[0].length;h++)this._associate(r[0][h],e+h);this._outSmartSplice(e,[],r[0])}for(h=0;h<r[0].length;h++)this._subscribe(r[0][h]);this._indexProperty&&n<this.length-r[0].length-1&&this._reportIndexes(s,n)}for(var a=[].concat(r[0]),h=0;h<r[1].length;h++)this._updateItem(r[2][h],r[1][h]),a.splice(r[3][h],0,r[2][h]);return!0===this._byKeyChange?(this._byKeyChange=!1,this.outByKeyChange()):this._byKeyChange=!1,a},hasItem:function(t,e){return e?0<=this.indexOf(t):0<=Amm.Array.indexOf(t,this)},strictIndexOf:function(t){return Amm.Array.indexOf(t,this)},intersect:function(t,e,i){if(i&&!(i instanceof Array))throw Error("`groups` must be an Array (or falseable value)");if(!t.length)return[];for(var r=this.getItems().concat(t),n=Amm.Array.findDuplicates(r,!1,e?null:this._comparison,this.length,!0),s=[],o=0,a=n.length;o<a;o++)for(var h=0,l=n[o].length;h<l;h++)if(n[o][h]<this.length){s.push(r[n[o][h]]),i&&i.push([n[o][h]].concat(n.slice(0,h)));break}return s},reject:function(t,e){if(!this._suppressDeleteEvent&&!this._allowDelete)throw Error(Amm.Collection.ERR_DELETE_DISALLOWED);var i,r;if("object"!=typeof t){if(i=parseInt(t),isNaN(i))throw Error("itemOrIndex must be an object or a number");if(i<0&&(i=this.length+i),i>=this.length)throw Error("index ["+i+"] doesn't exist");r=this[i]}else{if(r=t,(i=e?this.indexOf(r):this.strictIndexOf(r))<0)throw Error("itemOrIndex specifies non-existing item");r=this[i]}if(!this._suppressDeleteEvent&&!this._allowChangeOrder&&i<this.length-1)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);return this._rotate(i,-1),this._dissociate(r),this._indexProperty&&i<this.length&&this._reportIndexes(null,i),this._suppressDeleteEvent||this._updateLevel||this.outDeleteItem(i,r),r},push:function(t,e){if(!this._allowAdd)throw Error(Amm.Collection.ERR_ADD_DISALLOWED);var i=Array.prototype.slice.apply(arguments);return 1===i.length?this.accept(i[0]):this.acceptMany(i),this.length},pop:function(){if(!this._allowDelete)throw Error(Amm.Collection.ERR_DELETE_DISALLOWED);if(this.length)return this.reject(this.length-1)},unshift:function(t,e){if(!this._allowAdd)throw Error(Amm.Collection.ERR_ADD_DISALLOWED);if(!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);var i=Array.prototype.slice.apply(arguments),r=this._sorted?void 0:0;return 1===i.length?this.accept(i[0],r):this.acceptMany(i,r),this.length},shift:function(){if(!this._allowDelete)throw Error(Amm.Collection.ERR_DELETE_DISALLOWED);if(!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);if(this.length)return this.reject(0)},splice:function(t,e,i,r){var n=Array.prototype.slice.call(arguments,2);if(n.length&&!this._allowAdd)throw Error(Amm.Collection.ERR_ADD_DISALLOWED);if(e&&!this._allowDelete)throw Error(Amm.Collection.ERR_DELETE_DISALLOWED);if(t<0?(t=this.length+t)<0&&(t=0):t>this.length&&(t=this.length),t<this.length-e&&!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);e<0&&(e=0);var s,o,a,h,l,u=this.slice(t,t+e),c=this._preAccept(n,t,e),m=c[0],_=c[4],d=c[6],p=c[5];if(this._sorted){a=this._addNewToSorted(c[0]);for(var f=d.length-1;0<=f;f--)for(var g=a[1].length-1;0<=g&&a[1][g]>d[f];g--)a[1][g]--;o=this._getInsertFragments(a[0],a[1]),h=_.length?this._getCutFragments(t,_):[],l=this._getGoodSplice(h,o)}else l=[t,u,p];for(!0!==this._byKeyChange&&(this._byKeyChange=1),l&&this._suppressDeleteEvent++,f=0,s=_.length;f<s;f++)this.reject(_[f]);l&&this._suppressDeleteEvent--;var A=this.getItems();if(this._sorted){for(f=0;f<a[0].length;f++){var v=a[1][f];this._associate(a[0][f],v)}l?this._outSmartSplice(l[0],l[1],l[2]):this._outFragmentedInsert(o)}else{var y=p.length-(u.length-_.length);for(this._rotate(t,y),g=0,s=p.length,m.length,f=0;f<s;f++){for(g=0;g<=f&&p[f]!==m[g];)g++;this[t+f]=p[f],p[f]===m[g]&&this._associate(this[t+f],t+f)}this._outSmartSplice(t,u,p)}for(f=0;f<c[0].length;f++)this._subscribe(c[0][f]);!0===this._byKeyChange?(this._byKeyChange=!1,this.outByKeyChange()):this._byKeyChange=!1,this._indexProperty&&this._reportIndexes(A);for(f=0;f<c[1].length;f++)c[2][f]!==c[1][f]&&this._updateItem(c[2][f],c[1][f]);return u},setItems:function(t){var e=[0,this.length].concat(t);return this.splice.apply(this,e),this.length},reverse:function(){if(!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);if(this._sorted)return this.setSortReverse(!this.getSortReverse()),this.getItems();var t=this.getItems(),e=Amm.Array.prototype.reverse.apply(this);return this._indexProperty&&this._reportIndexes(t),e},setItem:function(t,e){return this.splice(t,1,e),this[t]===e?t:this.indexOf(e)},removeAtIndex:function(t,e){return this.reject(t),!0},moveItem:function(t,e){if(!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);if(this._sorted)throw Error("Cannot moveItem() on sorted Collection. Check with getIsSorted() next time");var i,r=t<=e?(i=t,e):(i=e,t),n=Amm.Array.prototype.moveItem.call(this,t,e);return this._indexProperty&&this._reportIndexes(null,i,r+1),n},_getCutFragments:function(t,e){for(var i=[],r=0,n=t,s=0,o=e.length,a=this.length;r<o&&n<a;)e[r]===this[n]?(s++,r++):(s&&i.push([n-s,s,e.slice(r-s,r)]),s=0),n++;return s&&i.push([n-s,s,e.slice(r-s,r)]),i},_getInsertFragments:function(t,e){if(!t.length)return[];for(var i=[],r=[e[0],[t[0]]],n=1,s=t.length;n<s;n++)e[n]===r[0]+r[1].length?r[1].push(t[n]):(i.push(r),r=[e[n],[t[n]]]);return i.push(r),i},_getGoodSplice:function(t,e){var i=t.length,r=e.length;return!(1<i||1<r)&&(i||r)?!i&&r?[e[0][0],[],e[0][1]]:i&&!r?[t[0][0],t[0][2],[]]:i&&r&&t[0][0]===e[0][0]?[e[0][0],t[0][2],e[0][1]]:null:null},_outFragmentedInsert:function(t){for(var e=0;e<t.length;e++)this._outSmartSplice(t[e][0],[],t[e][1])},insertItem:function(t,e){if(e<0)throw Error("`index` must be >= 0");void 0===e||e>=this.length||this._sorted?this.accept(t):this.accept(t,e);return this.strictIndexOf(t)},getIsSorted:function(){return this._sorted},_associate:function(t,e,i){if(this[e]!==t)throw Error("WTF - this[`index`] !== `item`");var r;this._assocProperty&&Amm.setProperty(t,this._assocProperty,this._assocInstance||this),this._assocEvents&&this._associateEvents([t]),this._indexProperty&&Amm.setProperty(t,this._indexProperty,e),this._defaults&&Amm.setProperty(t,this._defaults),i&&this._subscribe(t),this.outOnAssociate(t,e),!this._keyProperty||null!=(r=Amm.getProperty(t,this._keyProperty))&&(this.k[r]=t,this.outByKeyChange())},outOnAssociate:function(t,e){return this._out("onAssociate",t,e)},_subscribe:function(t){if(this._changeEvents)for(var e=0,i=this._changeEvents.length;e<i;e++)t.subscribe(this._changeEvents[e],this._reportItemChangeEvent,this);var r;this._indexPropertyIsWatched&&(r=this._indexProperty+"Change",t.subscribe(r,this._reportItemIndexPropertyChange,this)),this._keyProperty&&t.subscribe(this._keyProperty+"Change",this._handleKeyChange,this)},_dissociate:function(t){var e,i;this._changeEvents&&t.unsubscribe(void 0,this._reportItemChangeEvent,this),this._assocProperty&&Amm.getProperty(t,this._assocProperty)===(this._assocInstance||this)&&Amm.setProperty(t,this._assocProperty,null),this._assocEvents&&this._associateEvents([t],!0),this._indexPropertyIsWatched&&this._indexPropertyIsWatched&&(e=this._indexProperty+"Change",t.unsubscribe(e,this._reportItemIndexPropertyChange,this)),this._keyProperty&&(!1!==(i=Amm.getProperty(t,this._keyProperty))&&void 0!==i&&this.k[i]===t&&(delete this.k[i],this.outByKeyChange()),t.unsubscribe(this._keyProperty+"Change",this._handleKeyChange,this)),this._undefaults&&Amm.setProperty(t,this._undefaults),this._sorter&&(this._lockSort++,this._sorter.unobserveObject(t),this._lockSort--),this.outOnDissociate(t),this._cleanupOnDissociate&&(t.cleanup,1)&&t.cleanup()},outOnDissociate:function(t){return this._out("onDissociate",t)},outOnCanAccept:function(t,e){return e=e||{},this._out("onCanAccept",t,e)},setAssocProperty:function(t){t=t||null;var e=this._assocProperty;if(e!==t){this._assocProperty=t,this._beginItemsUpdate();var i,r=this.length;if(e)for(i=0;i<r;i++)Amm.setProperty(this[i],e,null);if(t)for(i=0;i<r;i++)Amm.setProperty(this[i],t,this._assocInstance||this);return this._endItemsUpdate(),!0}},getAssocProperty:function(){return this._assocProperty},setAssocInstance:function(t){if(this._assocInstance!==t){if(this._assocEvents&&this._associateEvents(this,!0),this._assocInstance=t,this._assocEvents&&this._associateEvents(this),this._assocProperty)for(var e=0,i=this.length;e<i;e++)Amm.setProperty(this[e],this._assocProperty,this._assocInstance||this);return!0}},getAssocInstance:function(){return this._assocInstance},setIndexProperty:function(t){if(t=t||null,this._indexProperty!==t){this._indexProperty=t;var e=this.getObserveIndexProperty();if(e&&this.setObserveIndexProperty(!1),this._indexProperty)for(var i=0,r=this.length;i<r;i++)Amm.setProperty(this[i],this._indexProperty,i);return e&&this.setObserveIndexProperty(e),this._checkIndexPropertyWatched(),!0}},getIndexProperty:function(){return this._indexProperty},setObserveIndexProperty:function(t){if(t=!!t,this._observeIndexProperty!==t)return this._observeIndexProperty=t,this._checkIndexPropertyWatched(),!0},getObserveIndexProperty:function(){return this._observeIndexProperty},_checkIndexPropertyWatched:function(){var t=!1;if(this._observeIndexProperty&&(t=!this._sorted&&null!==this._indexProperty),this._indexPropertyIsWatched!==t){var e=this._indexProperty+"Change";if(this._indexPropertyIsWatched=t,this._indexPropertyIsWatched)for(var i=0,r=this.length;i<r;i++)this[i].subscribe(e,this._reportItemIndexPropertyChange,this);else for(i=0,r=this.length;i<r;i++)this[i].unsubscribe(e,this._reportItemIndexPropertyChange,this)}},_reportItemIndexPropertyChange:function(t,e){if(!this._suppressIndexEvents){var i=Amm.event.origin,r=e,n=t;if(n<0?n=0:n>=this.length&&(n=this.length-1),this[r]!==i){if(this[n]===i)return;if((r=this.strictIndexOf(i))<0)throw Error("WTF - received item indexProperty change event from item not belonging to this Collection")}r!==n&&this.moveItem(r,n)}},setDefaults:function(t){if(t&&"object"!=typeof t)throw Error("`defaults` must be an object");if(t=t||null,this._defaults!==t)return this._defaults=t,!0},getDefaults:function(){return this._defaults},setUndefaults:function(t){if(t&&"object"!=typeof t)throw Error("`undefaults` must be an object");if(t=t||null,this._undefaults!==t)return this._undefaults=t,!0},getUndefaults:function(){return this._undefaults},getObservesItems:function(){return!!this._changeEvents},setChangeEvents:function(t){t?t instanceof Array?t.length||(t=null):t=[t]:t=null;var e=this._changeEvents;if(e!==t&&(!this._changeEvents||!t||Amm.Array.diff(t,this._changeEvents).length||Amm.Array.diff(this._changeEvents,t).length)){if(e)for(var i=0,r=this.length;i<r;i++)this[i].unsubscribe(void 0,this._reportItemChangeEvent,this);if(t)for(var n=t.length,i=0,r=this.length;i<r;i++)for(var s=0;s<n;s++)this[i].subscribe(t[s],this._reportItemChangeEvent,this);return this._changeEvents=t,!0}},_reportItemChangeEvent:function(){var t=Amm.event.origin;this._itemUpdateLevel?Amm.Array.indexOf(t,this._itemUpdateQueue)<0&&this._itemUpdateQueue.push(t):(this._recheckUniqueness&&this._performRecheckUniqueness(t),this._sorted&&this._checkItemPosition(t),this.outItemChange(t))},outItemChange:function(t){return this._out("itemChange",t)},getChangeEvents:function(){return this._changeEvents},setComparison:function(t){if(this._comparison!==t){var e=this._custComparison,i=this._comparison;this._custComparison=t,this._onlyStrict=!(this._keyProperty||this._comparisonProperties||t),this._onlyStrict?this._comparison=null:this._comparison=this._compareWithProps;try{this._custComparison=t,this._checkDuplicates("setComparison()",[],0,0,!0,this._comparison)}catch(t){throw this._custComparison=e,this._comparison=i,t}return!0}},setComparisonProperties:function(t){t?t instanceof Array?t.length||(t=null):t=[t]:t=null;var e=this._comparisonProperties;if(e!==t&&(!e||!t||e.length!==t||Amm.Array.equal(e,t).length)){var i=this._comparisonProperties,r=this._comparison;this._onlyStrict=!(this._keyProperty||t||this._custComparison),this._onlyStrict?this._comparison=null:this._comparison=this._compareWithProps;try{this._comparisonProperties=t,this._checkDuplicates("setComparisonProperties()",[],0,0,!0,this._comparison)}catch(t){throw this._comparisonProperties=i,this._comparison=r,t}return!0}},getComparisonProperties:function(){return this._comparisonProperties?this._comparisonProperties:[]},setIgnoreExactMatches:function(t){if(this._ignoreExactMatches!==t)return this._ignoreExactMatches=t,!0},getIgnoreExactMatches:function(){return this._ignoreExactMatches},setRecheckUniqueness:function(t){if(this._recheckUniqueness!==t)return this._recheckUniqueness=t,!0},getRecheckUniqueness:function(){return this._recheckUniqueness},_implCompareWithProps:function(t,e){var i,r,n;if(t===e)return 0;if(this._comparisonProperties)for(var s=0,o=this._comparisonProperties.length;s<o;s++)if(i=this._comparisonProperties[s],(r=Amm.getProperty(t,i))!==(n=Amm.getProperty(e,i)))return-1;if(this._keyProperty){if("object"==typeof(r=Amm.getProperty(t,this._keyProperty)))throw this._keyPropertyError(t,r);if(null!=r&&null!=(n=Amm.getProperty(e,this._keyProperty))){if("object"==typeof n)throw this._keyPropertyError(e,n);if(""+r!=""+n)return-1}}return this._custComparison?this._custComparison(t,e):0},_keyPropertyError:function(t,e,i){return void 0===i&&(i=this._keyProperty),new Error("Invalid value of keyProperty '"+this._keyProperty+"': object value isn't allowed")},setSortProperties:function(t){t?t instanceof Array?t.length||(t=null):t=[t]:t=null;var e=this._sortProperties;if(e!==t&&!(e&&t&&Amm.Array.equal(e,t)))return this._sortProperties=t,this._sorted=!!(this._sortFn||this._sortProperties||this._sorter),this._checkIndexPropertyWatched(),this._sorted&&this._sort(),!0},getSortProperties:function(){return this._sortProperties?this._sortProperties:[]},setSortReverse:function(t){if(t=!!t,this._sortReverse!==t)return this._sortReverse=t,this._sorted&&this._sort(),!0},getSortReverse:function(){return this._sortReverse},_implSortWithProps:function(t,e){if(t===e)return 0;var i=this._sortReverse?-1:1;if(this._sortProperties)for(var r=0,n=this._sortProperties.length;r<n;r++){var s=this._sortProperties[r],o=Amm.getProperty(t,s),a=Amm.getProperty(e,s);if(o<a)return-1*i;if(a<o)return i}return this._sortFn?this.sortFn(t,e)*i:void 0},setSortFn:function(t){if(t){if("function"!=typeof t)throw Error("sortFn must be a function or a null")}else t=null;if(this._sortFn!==t)return this._sortFn=t,this._sorted=!!(this._sortFn||this._sortProperties||this._sorter),this._checkIndexPropertyWatched(),this._sorted&&this._sort(),!0},getSortFn:function(){return this._sortFn},setSorter:function(t){var e=!1;if(t?"object"!=typeof t||t["Amm.Sorter"]||(t=Amm.constructInstance(t,"Amm.Sorter"),e=!0):t=null,this._sorter!==t)return this._sorter&&(this._sorterIsAggregate?this._sorter.cleanup():this._subSorter(!0)),this._sorterIsAggregate=e,this._sorter=t,this._sorter&&this._subSorter(),this._sorted=!!(this._sortFn||this._sortProperties||this._sorter),this._checkIndexPropertyWatched(),this._sorted&&this._sort(),!0},_subSorter:function(t){var e=t?"unsubscribe":"subscribe";this._sorter[e]("matchesChange",this._handleSorterNeedSort,this),this._sorter[e]("needSort",this._handleSorterNeedSort,this),this._sorter.setObservedObjects(t?[]:this.getItems())},_handleSorterNeedSort:function(){this._lockSort||(this._updateLevel?this._needSort=!0:this._sort())},getSorter:function(){return this._sorter},sort:function(t){if(this._needSort=!1,t instanceof Array){var i={_sortReverse:this._sortReverse,_sortWithProps:this._implSortWithProps,_sortProperties:t,_sortFn:null};return r=this.sort(function(t,e){return i._sortWithProps(t,e)})}if(this._sorter||this._sortFn){if(t)throw Error("Cannot sort(fn) when `sortFn` or `sorter` is set; use sort() with no parameters");return this._sort()}if(this._sortProperties)throw Error("Cannot sort() when `sortProperties` is set");var e,r,n={};return this._indexProperty&&(e=this.getItems()),r=this._sorter?Amm.Array.prototype.sort.call(this,this._sorter.getCompareClosureFn(),n):Amm.Array.prototype.sort.call(this,t,n),this._indexProperty&&n.changed&&e&&this._reportIndexes(e),r},_doEndUpdate:function(){this._needSort&&this._sort(),this._indexProperty&&this._reportIndexes(this._preUpdateItems),Amm.Array.prototype._doEndUpdate.call(this),this._byKeyChange&&(this._byKeyChange=!1,this.outByKeyChange())},_reportIndexes:function(t,e,i){this._suppressIndexEvents++;var r=i||this.length,e=e||0;try{for(var n=e;n<r;n++)t&&this[n]===t[n]||Amm.setProperty(this[n],this._indexProperty,n)}catch(t){throw this._suppressIndexEvents--,t}this._suppressIndexEvents--},_sort:function(){if(this._needSort=!1,!(this._sortFn||this._sortProperties||this._sorter))throw Error("WTF - call to _sort() w/o _sorter, _sortFn or _sortProperties");var t,e={};return this._indexProperty&&(t=this.getItems()),Amm.Array.prototype.sort.call(this,this._sorter?this._sorter.getCompareClosureFn():this._sortWithProps,e),this._indexProperty&&e.changed&&t&&this._reportIndexes(t),e.changed},_locateItemIndexInSortedArray:function(t){return this.length?(this._sorter&&(this._lockSort++,this._sorter.observeObject(t),this._lockSort--),Amm.Collection.binSearch(this,t,this._sorter?this._sorter.getCompareClosureFn():this._sortWithProps)[0]):0},_locateManyItemIndexesInSortedArray:function(t){var e=t.length,i=this._sorter?this._sorter.getCompareClosureFn():this._sortWithProps;if(this._sorter){for(this._lockSort++,s=0;s<e;s++)this._sorter.observeObject(t[s]);this._lockSort--}t.sort(i);for(var r=0,n=[],s=0;s<e;s++)(r=Amm.Collection.binSearch(this,t[s],i,r)[0])<0&&(r=0),n.push(r+s);return n},getAllowUpdate:function(){return this._allowUpdate},setUpdateProperties:function(t){if(t?t instanceof Array?t.length||(t=null):t=[t]:t=null,this._updateProperties!==t)return this._updateProperties=t,this._allowUpdate=this._updateProperties||this._updateFn,!0},getUpdateProperties:function(){return this._updateProperties?this._updateProperties:[]},_updateItem:function(t,e){this._beginItemsUpdate();try{if(this._updateProperties&&t!==e)for(var i=0,r=this._updateProperties.length;i<r;i++){var n=this._updateProperties[i];Amm.setProperty(t,n,Amm.getProperty(e,n))}this._updateFn?this._updateFn(t,e):t===e&&console.warn("updateFn not set; exactly matching items won't be update()'d)")}catch(t){throw this._endItemsUpdate(),t}this._endItemsUpdate()},_beginItemsUpdate:function(){this._itemUpdateLevel++},_endItemsUpdate:function(){if(this._itemUpdateLevel--,!this._endItemsUpdateLock){if(this._endItemsUpdateLock=!0,this._recheckUniqueness&&this._itemUpdateQueue.length&&this._performRecheckUniqueness(this._itemUpdateQueue,!0),!this._itemUpdateLevel&&this._itemUpdateQueue.length){for(var t=0;t<this._itemUpdateQueue.length;t++)this.outItemChange(this._itemUpdateQueue[t]);this._itemUpdateQueue=[]}this._endItemsUpdateLock=!1,this._byKeyChange&&(this._byKeyChange=!1,this.outByKeyChange()),this._sorted&&this._sort()}},_checkItemPosition:function(t,e){if(void 0===e&&(this._indexProperty&&("number"!=typeof(e=Amm.getProperty(t,this._indexProperty))||this[e]===t)||(e=this.strictIndexOf(t)),e<0))throw Error("WTF: `item` not found in this");if(this[e]!==t)throw Error("WTF: this[`index`] !== `item`");var i,r,n,s=void 0,o=!1;0<e&&0<this._sortWithProps(this[e-1],t)&&((n=Amm.Collection.binSearch(this,t,this._sortWithProps,0,e-1))[0]+1>=e?o=!0:(s=i=n[0]+1,r=e)),e<this.length-1&&0<this._sortWithProps(t,this[e+1])&&((n=Amm.Collection.binSearch(this,t,this._sortWithProps,e+1,this.length-1))[0]+1<=e?o=!0:(s=r=n[0]+1,i=e)),o?this._sort():void 0!==s&&(Amm.Array.prototype.moveItem.call(this,e,s),r>=this.length&&(r=this.length-1),this._indexProperty&&this._reportIndexes(null,i,r))},_performRecheckUniqueness:function(t,e){if(this._custComparison||this._comparisonProperties)for(var i=e?t:[t],r=0,n=i.length;r<n;r++){for(var s=-1,o=[],a=null;0<=(s=this.indexOf(i[r],s+1))&&(i[r]!==this[s]?o.push(s):a=s),0<=s;);if(null===a&&console.warn("Item that was changed is no more in the collection"),o.length){if(a||1!==o.length)throw Error("After the change of this["+a+"], duplicate(s) appeared: this["+o.join("], this[")+"]");console.warn("Item that was changed has a duplicate, but is no more in the collection. Not throwing the exception since the collection is still unique.")}}else console.warn("having setRecheckUniqueness(true) w/o prior setComparsion() or setComparisonProperies() makes no sense - refusing to re-check")},setUpdateFn:function(t){if(t&&"function"!=typeof t)throw Error("updateFn must be a function");if(this._updateFn!==t)return this._updateFn=t,this._allowUpdate=this._updateProperties||this._updateFn,!0},getUpdateFn:function(){return this._updateFn},setCleanupOnDissociate:function(t){if(t=!!t,this._cleanupOnDissociate!==t)return this._cleanupOnDissociate=t,!0},getCleanupOnDissociate:function(){return this._cleanupOnDissociate},setAllowAdd:function(t){if(t=!!t,this._allowAdd!==t)return this._allowAdd=t,!0},getAllowAdd:function(){return this._allowAdd},setAllowDelete:function(t){if(t=!!t,this._allowDelete!==t)return this._allowDelete=t,!0},getAllowDelete:function(){return this._allowDelete},setAllowChangeOrder:function(t){if(t=!!t,this._allowChangeOrder!==t)return this._allowChangeOrder=t,!0},getAllowChangeOrder:function(){return this._allowChangeOrder},cleanup:function(){var t=this._allowDelete;t||this.setAllowDelete(!0),this._sorterIsAggregate&&(this._sorter.cleanup(),this._sorter=null),Amm.Array.prototype.cleanup.call(this),t||this.setAllowDelete(t)},setAssocEvents:function(t){var e=null;if(t){if("object"!=typeof t)throw Error("`assocEvents` must be an object");for(var i in e=[],t)t.hasOwnProperty(i)&&e.push([i,t[i]])}return this._assocEvents&&this.length&&this._associateEvents(this,!0),this._assocEvents=e,t&&this._associateEvents(this),!0},_associateEvents:function(t,e){if(this._assocEvents&&t.length)for(var i=this._assocInstance||this,r=this._assocEvents.length,n=e?"unsubscribe":"subscribe",s=0,o=t.length;s<o;s++)for(var a=0;a<r;a++)(e||t[s].hasEvent(this._assocEvents[a][0]))&&t[s][n](this._assocEvents[a][0],this._assocEvents[a][1],i)},getAssocEvents:function(){if(!this._assocEvents)return{};for(var t={},e=0,i=this._assocEvents.length;e<i;e++)t[this._assocEvents[e][0]]=this._assocEvents[e][1];return t},setKeyProperty:function(t){t=t||null;var e=this._keyProperty;if(e!==t){var i=this._keyProperty,r=this._comparison;this._onlyStrict=!(t||this._comparisonProperties||this._custComparison),this._onlyStrict?this._comparison=null:this._comparison=this._compareWithProps;try{this._keyProperty=t,this._checkDuplicates("setKeyProperty()",[],0,0,!0,this._comparison)}catch(t){throw this._keyProperty=i,this._comparison=r,t}return e&&this._unobserveKeyProperty(),this._keyProperty=t,this._observeKeyProperty(),this._rebuildKeys(),this.outKeyPropertyChange(t,e),!0}},_unobserveKeyProperty:function(){for(var t=this._keyProperty+"Change",e=0,i=this.length;e<i;e++)this[e].unsubscribe(t,this._handleKeyChange,this)},_observeKeyProperty:function(){for(var t=this._keyProperty+"Change",e=0,i=this.length;e<i;e++)this[e].subscribe(t,this._handleKeyChange,this)},_lockKeyValueChange:!1,_revertKeyValue:function(t,e){var i=this._lockKeyValueChange;this._lockKeyValueChange=t;try{Amm.setProperty(t,this._keyProperty,e)}catch(t){throw this._lockKeyValueChange=i,t}this._lockKeyValueChange=i},_handleKeyChange:function(t,e){var i=Amm.event.origin;if(!this._lockKeyValueChange||this._lockKeyValueChange!==i){if("object"==typeof t)throw this._revertKeyValue(i,e),this._keyPropertyError(i,t);if(null!=t){if(this.k[t]&&this.k[t]!==i)throw this._revertKeyValue(i,e),Error("Duplicate value of keyProperty '"+this._keyProperty+"': object with key '"+t+"' already exists in the collection");this.k[t]=i}if(null!=e){if(this.k[e]!==i)return void this._rebuildKeys();delete this.k[e]}this.outByKeyChange()}},_rebuildKeys:function(){this.k={};for(var t=0,e=this.length;t<e;t++){var i=Amm.getProperty(this[t],this._keyProperty);if(null!=i){if("object"==typeof i)throw this._keyPropertyError(this[t],i);this.k[i]=this[t]}}this.outByKeyChange()},getKeyProperty:function(){return this._keyProperty},outKeyPropertyChange:function(t,e){this._out("keyPropertyChange",t,e)},getByKey:function(t){return this.k[t]},setByKey:function(t){console.warn("byKey is read-only property")},outByKeyChange:function(){this._updateLevel||this._itemUpdateLevel||this._byKeyChange?this._byKeyChange=!0:this._out("byKeyChange")}},Amm.extend(Amm.Collection,Amm.Array),Amm.Selection=function(t){Amm.Collection.call(this,t)},Amm.Selection.ERR_NOT_IN_OBSERVED_COLLECTION="Not in observed collection.",Amm.Selection.prototype={"Amm.Selection":"__CLASS__",_multiple:!0,_valueProperty:null,_selectedProperty:null,_sameOrder:!1,_collection:null,_unselectOnItemValueChange:!1,_cacheValue:!0,_value:void 0,_suppressValueChangeEvent:0,_selfSubscribed:!1,setCollection:function(t){var e,i=this._collection;if(i!==t)return i&&this._unobserveCollection(),this._collection=t,e=this._selectedProperty?this._findSelectedItems():[],this._multiple||e.splice(1,e.length),this.setItems(e),this.outCollectionChange(t,i),t&&this._observeCollection(),!0},getCollection:function(){return this._collection},outCollectionChange:function(t,e){this._out("collectionChange",t,e)},setMultiple:function(t){t=!!t;var e=this._multiple;if(e!==t){var i=void 0===this._value?this.getValue(!0):this._value;!(this._multiple=t)&&1<this.length&&(this._suppressValueChangeEvent++,this.splice(1,this.length-1),this._suppressValueChangeEvent--);var r=this.getValue(!0);return this._valueProperty&&(this._value=r),this._subscribers.valueChange&&this.outValueChange(r,i),this.outMultipleChange(t,e),!0}},getMultiple:function(){return this._multiple},outMultipleChange:function(t,e){this._out("multipleChange",t,e)},setValue:function(t){var e,i;this.beginUpdate(),null==t?(e=!0,this._multiple&&(t=[])):!(t instanceof Array||t["Amm.Array"])||this._findItemsWithValue([t]).length?t=[t]:e=!t.length,i=e?[]:this._findItemsWithValue(t),this.setItems(i),this.endUpdate()},getValue:function(t){return this.length?(this._valueProperty?e=!this._cacheValue||t||void 0===this._value?this._value=this._collectValueProperty(this,!0):this._value:(e=this.getItems(),this._multiple||(e=e[0])),e):this._multiple?[]:null;var e},outValueChange:function(t,e){this._suppressValueChangeEvent||this._updateLevel||this._out("valueChange",t,e)},setValueProperty:function(t){var e=this._valueProperty;if(e!==t)return this._collection&&e&&this._unsubscribeCollectionItems(this._collection,!1,!0),this._valueProperty=t,this.clearItems(),this._valueProperty||(this._value=void 0),this._collection&&t&&this._subscribeCollectionItems(this._collection,!1,!0),!0},getValueProperty:function(){return this._valueProperty},setCacheValue:function(t){if(t=!!t,this._cacheValue!==t)return this._cacheValue=t,!0},getCacheValue:function(){return this._cacheValue},setUnselectOnItemValueChange:function(t){if(this._unselectOnItemValueChange!==t)return this._unselectOnItemValueChange=t,!0},getUnselectOnItemValueChange:function(){return this._unselectOnItemValueChange},setSelectedProperty:function(t){var e=this._selectedProperty;if(e!==t)return e&&this._collection&&this._unsubscribeCollectionItems(this._collection,!0),(this._selectedProperty=t)&&this._collection&&(this.length?this._setItemsSelectedProperty():this.setItems(this._findSelectedItems()),this._subscribeCollectionItems(this._collection,!0)),!0},getSelectedProperty:function(){return this._selectedProperty},setSameOrder:function(t){if(t=!!t,this._sameOrder!==t)return this._sameOrder=t,this._sameOrder?(this.setSortProperties(null),this.setSortFn(null),this._collection&&(this._collection.subscribe("reorderItems",this._handleCollectionReorderItems,this),this._maintainOrder())):this._collection&&this._collection.unsubscribe("reorderItems",this._handleCollectionReorderItems,this),!0},getSameOrder:function(){return this._sameOrder},sort:function(t){return this._sameOrder&&Error("Refusing to sort() when `sameOrder` === true"),Amm.Collection.prototype.sort.call(this,t)},_collectValueProperty:function(t,e,i){for(var r=[],n=(t=t||this).length,s=0;s<n;s++){var o,a=t[s];a===i||null!=(o=Amm.getProperty(a,this._valueProperty))&&r.push(o)}return e&&!this._multiple&&(r=r.length?r[0]:null),r},_findItemsWithValue:function(t){if(this._multiple||t instanceof Array||(t=null==t?[]:[t]),!this._collection||!t.length)return[];if(!this._valueProperty)return this._collection.intersect(t,!0);for(var e=[],i=0,r=this._collection.length;i<r;i++){var n=this._collection[i],s=Amm.getProperty(n,this._valueProperty);0<=Amm.Array.indexOf(s,t)&&e.push(n)}return e},_findSelectedItems:function(){if(!this._collection)return[];for(var t=[],e=0,i=this._collection.length;e<i;e++){var r=this._collection[e];Amm.getProperty(r,this._selectedProperty)&&t.push(r)}return t},_setItemsSelectedProperty:function(){for(var t=0,e=this._collection.length;t<e;t++)Amm.setProperty(this._collection[t],this._selectedProperty,this.hasItem(this._collection[t]))},_handleCollectionSpliceItems:function(t,e,i){var r=Amm.Array.symmetricDiff(e,i),n=Amm.Array.symmetricDiff(i,e);this._unsubscribeCollectionItems(r),this._subscribeCollectionItems(n);var s=this.intersect(r,!0),o=Amm.Array.diff(n,this);if(o.length||s.length){var a=o.length&&(this._selectedProperty||this._valueProperty&&this.length&&this._multiple);this.beginUpdate();for(var h=0,l=s.length;h<l;h++)this.reject(s[h],!1);if(a){for(var u=[],c=this._valueProperty?this.getValue():null,h=0,l=o.length;h<l;h++){var m=o[h];(this._selectedProperty&&Amm.getProperty(m,this._selectedProperty)||this._valueProperty&&c&&0<=Amm.Array.indexOf(Amm.getProperty(m,this._valueProperty),c))&&u.push(m)}u.length&&(this.acceptMany(u),this._sameOrder&&this._maintainOrder(!0))}this.endUpdate()}},_handleCollectionReorderItems:function(t,e,i){var r;this.length&&(r=this.getItems(),Amm.Array.findDuplicates(r.concat(this._collection.slice(t,t+e)),!0,void 0,this.length).length&&this._maintainOrder())},_maintainOrder:function(t){if(this._sameOrder&&this.length){var e=this.getItems(),i=this._collection.intersect(e,!0),r=null,n=null;if(e.length!==i.length)return console.warn("We have problem: it turned some elements disappeared from `collection` when only order might change"),void this.setItems(i);for(var s=0,o=e.length;s<o;s++)e[s]!==i[s]&&(null===r&&(r=s),this[n=s]=i[s]);null===r||t||(this._indexProperty&&this._reportIndexes(e,r,n+1),this._updateLevel||this.outReorderItems(r,n-r+1,e.slice(r,n+1)))}},_observeCollection:function(){this._collection.subscribe("spliceItems",this._handleCollectionSpliceItems,this),this._sameOrder&&this._collection.subscribe("reorderItems",this._handleCollectionReorderItems,this),this._subscribeCollectionItems(this._collection)},_unobserveCollection:function(){this._collection.unsubscribe("spliceItems",this._handleCollectionSpliceItems,this),this._sameOrder&&this._collection.unsubscribe("reorderItems",this._handleCollectionReorderItems,this),this._unsubscribeCollectionItems(this._collection)},_subscribeCollectionItems:function(t,e,i,r){var n,s,o;if(this._valueProperty||(e=!0),o=r?"unsubscribe":"subscribe",this._selectedProperty||(i=!0),!e||!i){e||(n=this._valueProperty+"Change"),i||(s=this._selectedProperty+"Change");for(var a=0,h=t.length;a<h;a++){var l=t[a];l[o]&&(r||l.hasEvent)&&(n&&(r||l.hasEvent(n))&&l[o](n,this._handleItemValuePropertyChange,this),s&&(r||l.hasEvent(s))&&l[o](s,this._handleItemSelectedPropertyChange,this))}}},canAccept:function(t,e,i){return i=i||{},this._collection&&this._collection.hasItem(t)?Amm.Collection.prototype.canAccept.call(this,t,e,i):(i.error=Amm.Selection.ERR_NOT_IN_OBSERVED_COLLECTION,!1)},_unsubscribeCollectionItems:function(t,e,i){return this._subscribeCollectionItems(t,e,i,!0)},_handleItemValuePropertyChange:function(t,e){var i=Amm.event.origin,r=this.hasItem(i),n=this._value,s=0<=Amm.Array.indexOf(t,this._collectValueProperty(this,!1,i));s&&!r?this.accept(i):!s&&r&&(this._unselectOnItemValueChange?this.reject(i):(this._value=this._collectValueProperty(this,!0),this._valueProperty&&this._subscribers.valueChange&&this.outValueChange(this._value,n)))},_handleItemSelectedPropertyChange:function(t,e){this.beginUpdate();var i=Amm.event.origin,r=this.hasItem(i);if(r&&!t)return this.reject(i),void this.endUpdate();!r&&t&&(this._multiple?this.accept(i):this.setItems([i])),this.endUpdate()},_subscribeFirst_valueChange:function(){this._valueProperty&&(this._value=this._collectValueProperty(this.getItems(),!0)),this._selfSubscribed=!0,this.subscribe("itemsChange",this._handleSelfItemsChange,this)},_unsubscribeLast_valueChange:function(){this._selfSubscribed=!1,this.unsubscribe("itemsChange",this._handleSelfItemsChange,this)},_handleSelfItemsChange:function(t,e){var i,r;this._valueProperty?(i=void 0!==this._value?this._value:this._collectValueProperty(e,!0),this._value=r=this._collectValueProperty(t,!0)):this._multiple?(r=t,i=e):(i=e[0]||null,r=t[0]||null),this.outValueChange(r,i)},_associate:function(t,e,i){var r=Amm.Collection.prototype._associate.call(this,t,e,i);return this._selfSubscribed||(this._value=void 0),this._selectedProperty&&Amm.setProperty(t,this._selectedProperty,!0),r},_dissociate:function(t){var e=Amm.Collection.prototype._dissociate.call(this,t);return this._selfSubscribed||(this._value=void 0),this._selectedProperty&&Amm.setProperty(t,this._selectedProperty,!1),e},_oldValue:null,_doBeginUpdate:function(){Amm.Collection.prototype._doBeginUpdate.call(this),this._oldValue=this.getValue(),this._oldValue instanceof Array&&(this._oldValue=[].concat(this._oldValue))},_doEndUpdate:function(){var t,e;this._suppressValueChangeEvent++,Amm.Collection.prototype._doEndUpdate.call(this),this._suppressValueChangeEvent--,this._updateLevel||(t=this.getValue(),e=this._oldValue,t instanceof Array&&e instanceof Array&&Amm.Array.equal(t,e)||t!==e&&this.outValueChange(t,e))}},Amm.extend(Amm.Selection,Amm.Collection),Amm.Remote={},Amm.Decorator=function(t){t&&"__CLASS__"===this["Amm.Decorator"]&&t.decorate&&"function"==typeof t.decorate&&(this.decorate=t.decorate,delete t.decorate),Amm.init(this,t)},Amm.Decorator.construct=function(t,e,i,r){return"function"==typeof t&&(t={decorate:t}),Amm.constructInstance(t,"Amm.Decorator",e,i,r)},Amm.Decorator.prototype={"Amm.Decorator":"__CLASS__",decorate:function(t){return t}},Amm.Decorator.cr=function(t){return t&&t["Amm.Decorator"]?t:Amm.Decorator.construct(t)},Amm.Decorator.d=function(t,e,i){var r=(e=e||this)[i=i||"decorator"];return r?(r["Amm.Decorator"]||(r=e[i]=Amm.Decorator.construct(r)),r.decorate(t)):t},Amm.Translator=function(t){Amm.init(this,t)},Amm.Translator.prototype={"Amm.Translator":"__CLASS__",lastError:null,errInValue:null,errOutValue:null,reverseMode:null,field:void 0,trimInStrings:!1,decorateBeforeValidate:!1,_inDecorator:null,_outDecorator:null,_inValidator:null,_outValidator:null,_implTranslate:function(t,e,i,r,n,s,o){var a;if(this.lastError=null,r&&"object"==typeof r||(r={}),r.error=null,n&&this.trimInStrings&&"string"==typeof t&&(t=Amm.Util.trim(t)),o&&this.decorateBeforeValidate)try{t=o.decorate(t)}catch(t){return r.error=this.lastError=t,e}if(s&&(this.lastError=s.getError(t,this.field),this.lastError))return r.error=this.lastError,e;if(o&&!this.decorateBeforeValidate)try{t=o.decorate(t)}catch(t){return r.error=this.lastError=t,e}try{a=this[i](t)}catch(t){this.lastError=t}return this.lastError&&(a=e),r.error=this.lastError,a},decorate:function(t){return this.translateIn(t)},translateIn:function(t,e){return this.reverseMode?this._implTranslate(t,this.errOutValue,"_doTranslateOut",e,!1,this._outValidator,this._outDecorator):this._implTranslate(t,this.errInValue,"_doTranslateIn",e,!0,this._inValidator,this._inDecorator)},translateOut:function(t,e){return this.reverseMode?this._implTranslate(t,this.errInValue,"_doTranslateIn",e,!1,this._inValidator,this._inDecorator):this._implTranslate(t,this.errOutValue,"_doTranslateOut",e,!1,this._outValidator,this._outDecorator)},_doTranslateIn:function(t){return t},_doTranslateOut:function(t){return t},setInDecorator:function(t){if(this._inDecorator!==t)return t=t&&Amm.Decorator.construct(t,"Amm.Decorator"),this._inDecorator=t,!0},getInDecorator:function(){return this._inDecorator},setOutDecorator:function(t){if(this._outDecorator!==t)return t=t&&Amm.Decorator.construct(t,"Amm.Decorator"),this._outDecorator=t,!0},getOutDecorator:function(){return this._outDecorator},setInValidator:function(t){if(this._inValidator!==t)return t=t&&Amm.Validator.construct(t),this._inValidator=t,!0},getInValidator:function(){return this._inValidator},setOutValidator:function(t){if(this._outValidator!==t)return t=t&&Amm.Validator.construct(t),this._outValidator=t,!0},getOutValidator:function(){return this._outValidator}},Amm.extend(Amm.Translator,Amm.Decorator),Amm.Translator.Bool=function(t){Amm.Translator.call(this,t)},Amm.Translator.Bool.prototype={"Amm.Translator.Bool":"__CLASS__",trueValue:"lang.Amm.True",falseValue:"lang.Amm.False",errorMsg:"lang.Amm.Translator.Bool.msg",caseSensitive:!1,trimInStrings:!0,guess:!0,defaultValue:!1,setStrictMode:function(t){t?(this.caseSensitive=!0,this.trimInStrings=!1,this.defaultValue=void 0,this.guess=!1):(this.caseSensitive=!1,this.trimInStrings=!0,this.defaultValue=!1,this.guess=!0)},getStrictMode:function(){return!(!this.caseSensitive||this.trimInStrings||void 0!==this.defaultValue||this.guess)||!(!this.caseSensitive&&this.trimInStrings&&void 0!==this.defaultValue&&this.guess)&&void 0},_doTranslateOut:function(t){return Amm.translate(t?this.trueValue:this.falseValue)},_doTranslateIn:function(t){var e;return this._cmp(t,Amm.translate(this.trueValue))?e=!0:this._cmp(t,Amm.translate(this.falseValue))?e=!1:this.guess?e="0"!==t&&!!t:void 0!==this.defaultValue?e=this.defaultValue:this.lastError=Amm.translate(this.errorMsg,"%value",t),e},_cmp:function(t,e){return this.caseSensitive||(t=(""+t).toLowerCase(),e=(""+e).toLowerCase()),t===e}},Amm.extend(Amm.Translator.Bool,Amm.Translator),Amm.defineLangStrings({"lang.Amm.True":"True","lang.Amm.False":"False","lang.Amm.Translator.Bool.msg":"'%value' isn't allowed Boolean value"}),Amm.Translator.RequiredMark=function(t){Amm.Translator.Bool.call(this,t)},Amm.Translator.RequiredMark.prototype={"Amm.Translator.RequiredMark":"__CLASS__",trueValue:'<span class="required">*</span>',falseValue:""},Amm.extend(Amm.Translator.RequiredMark,Amm.Translator.Bool),Amm.Translator.List=function(t){Amm.Translator.call(this,t)},Amm.Translator.List.prototype={"Amm.Translator.List":"__CLASS__",_enclosureElement:"<ul></ul>",_itemElement:"<li></li>",emptyOutValue:null,itemSelector:null,_cachedItemSelector:null,allowHTML:!0,strict:!1,msgInvalidInValueStrict:"Amm.Translator.List.msgInvalidInValueStrict",msgInvalidInValueNonStrict:"Amm.Translator.List.msgInvalidInValueNonStrict",msgInvalidOutValue:"Amm.Translator.List.msgInvalidOutValue",_cacheValues:null,_lastInValue:null,_lastOutValue:null,setCacheValues:function(t){if(this._cacheValues!==t)return this._cacheValues=t,!0},getCacheValues:function(){return this._cacheValues},setItemElement:function(t){if(this._itemElement!==t)return t||Error("itemElement is required"),"string"!=typeof t&&Error("itemElement must be a string"),t.match(/^<.*>$/)||Error("itemElement must be a jQuery-compatible HTML element definition"),this._itemElement=t,!(this._cachedItemSelector=null)},getItemElement:function(){return this._itemElement},setEnclosureElement:function(t){if(this._enclosureElement!==t)return t?("string"!=typeof t&&Error("enclosureElement must be a string"),t.match(/^<.*>$/)||Error("enclosureElement must be a jQuery-compatible HTML element definition")):t="",this._enclosureElement=t,!0},getEnclosureElement:function(){return this._enclosureElement},_doTranslateOut:function(t){if(this.strict||(t?"string"==typeof t&&(t=[t]):t=[]),t instanceof Array||t["Amm.Array"]){if(!t.length&&null!==this.emptyOutValue)return this.emptyOutValue;var e=[];if(!this._itemElement)throw Error("itemElement not set");for(var i="",r=0,n=t.length;r<n;r++){var s=jQuery(this._itemElement);this.allowHTML?s.html(t[r]):s.text(t[r]),this._enclosureElement?e.push(s):i+=s[0].outerHTML}return s&&s[0]&&!this._cachedItemSelector&&!this.itemSelector&&this._extractItemSelector(s[0]),this._enclosureElement?jQuery(this._enclosureElement).append(e)[0].outerHTML:i}var o=this.strict?this.msgInvalidInValueStrict:this.msgInvalidInValueNonStrict;this.lastError=Amm._msg(o,"%type",Amm.describeType(t))},_doTranslateIn:function(t){if(t===this.emptyOutValue)return[];if(!t)return[];t&&(t.jquery||t.nodeName||"string"==typeof t)||(this.lastError=Amm._msg(this.msgInvalidOutValue,"%type",Amm.describeType(t)));var e,i=this.itemSelector||this._cachedItemSelector;i||(e=jQuery(this._itemElement),i=this._extractItemSelector(e[0]));var r=[],n=this.allowHTML;jQuery(t).find(i).addBack(i).each(function(t,e){r.push(n?jQuery(e).html():jQuery(e).text())});return r},_extractItemSelector:function(t){var e;return this._cachedItemSelector=t.tagName.toLowerCase(),(e=t.getAttribute("class"))&&(this._cachedItemSelector+="."+e),(e=t.getAttribute("id"))&&(this._cachedItemSelector+="#"+e),this._cachedItemSelector}},Amm.extend(Amm.Translator.List,Amm.Translator),Amm.defineLangStrings({"Amm.Translator.List.msgInvalidInValueStrict":"unsupported external value: %type provided, Array or Amm.Array expected","Amm.Translator.List.msgInvalidInValueNonStrict":"unsupported external value: %type provided, Array, Amm.Array, string or FALSEable value expected","Amm.Translator.List.msgInvalidOutValue":"internal value must be either string or FALSEable value or jQuery result or DOM Element, but %type was provided"}),Amm.Translator.Errors=function(t){Amm.Translator.List.call(this,t)},Amm.Translator.Errors.prototype={"Amm.Translator.Errors":"__CLASS__",_enclosureElement:'<ul class="errors"></ul>',_itemElement:'<li class="error"></li>',emptyOutValue:"",itemSelector:".error",strict:!1,allowHTML:!1},Amm.extend(Amm.Translator.Errors,Amm.Translator.List),Amm.Decorator.Loop=function(t){Amm.Decorator.call(this,t)},Amm.Decorator.Loop.prototype={"Amm.Decorator.Loop":"__CLASS__",decorator:null,decorate:function(t){if(!this.decorator||!t||"object"!=typeof t)return t;var e,i;if(t instanceof Array){for(e=[],i=0;i<t.length;i++)e.push(Amm.Decorator.d(t[i],this,"decorator"));return e}for(i in e={},t)t.hasOwnProperty(i)&&(e[i]=Amm.Decorator.d(t[i],this,"decorator"));return e}},Amm.extend(Amm.Decorator.Loop,Amm.Decorator),Amm.Decorator.WrapObject=function(t){Amm.Decorator.call(this,t)},Amm.Decorator.WrapObject.prototype={"Amm.Decorator.WrapObject":"__CLASS__",decorate:function(t){var e,i;if(!t||"object"!=typeof t)return t;if(Amm.getClass(t))return t;if(t instanceof Array){for(var r=[],n=!0,s=0,o=t.length;s<o;s++)t[s]&&"object"==typeof t[s]||(n=!1),r.push(this.wrapObject(t[s]));return e=n?new Amm.Collection(r):new Amm.Array(r)}for(var s in e=new Amm.WithEvents,t){t.hasOwnProperty(s)&&((i=t[s])&&"object"==typeof i&&(i=this.wrapObject(i)),Amm.createProperty(e,s,i,function(t,e,i){t&&"object"==typeof t&&(this[i]=this.wrapObject(t))},!0))}return e}},Amm.extend(Amm.Decorator.WrapObject,Amm.Decorator),Amm.Decorator.Data=function(t){Amm.Decorator.call(this,t)},Amm.Decorator.Data.prototype={"Amm.Decorator.Data":"__CLASS__",_filter:null,_conditions:null,setConditions:function(t){if(!t&&"object"==typeof t)throw Error("`conditions` must be a non-null object");return Amm.keys(t).length||(t=null),t&&this._actions&&this._checkActions(t,this._actions),this._conditions=t,this._filter&&(this._filter.cleanup(),this._filter=null),!0},getConditions:function(){return this._conditions},_actions:null,setActions:function(t){if(!t&&"object"==typeof t)throw Error("`actions` must be a non-null object");if(Amm.keys(t).length)return this._conditions&&t&&this._checkActions(this._conditions,t),this._actions=t,!0;this._actions=null},_checkActions:function(t,e){var i=Amm.keys(t),r=Amm.keys(e),n=Amm.Array.diff(i,r);if(n.length)throw Error("Mismatch in `critera` and `action` keys: some conditions ('"+n.join("', '")+"') don't have corresponding actions");if(Amm.Array.diff(r,i.concat(["default"])).length)throw Error("Mismatch in `critera` and `action` keys: some actions ('"+n.join("', '")+"') don't have corresponding conditions")},getActions:function(){return this._actions},decorate:function(t){if(!this._conditions||!this._actions)return t;if(!this._filter){var e,i=[];for(var r in this._conditions)this._conditions.hasOwnProperty(r)&&("string"==typeof(e=this._conditions[r])&&(e={_expr:e}),i.push(Amm.override({_id:r},e)));this._filter=new Amm.Filter({conditions:i})}var n=this._filter.evaluateMatch(t);if(this._actions[n]||(n="default"),!this._actions[n])return t;var s={};return this._applyActions(t,this._actions,n,s),s},_applyActions:function(t,e,i,r){if((i=e[i])instanceof Array)for(var n=0,s=i.length;n<s;n++)this._applyActions(t,i,n,r);else i["Amm.Decorator.Data.Action"]||(i=e[i]=Amm.constructInstance(i,"Amm.Decorator.Data.Action")).apply(t,r)}},Amm.extend(Amm.Decorator.Data,Amm.Decorator),Amm.Decorator.Data.Action=function(t){Amm.init(this,t)},Amm.Decorator.Data.Action.prototype={"Amm.Decorator.Data.Action":"__CLASS__",_src:null,_dest:null,def:void 0,decorator:null,merge:!1,setSrc:function(t){if(t=t?Amm.Util.pathToArray(t):null,this._src!==t)return this._src=t,!0},getSrc:function(){return this._src},setDest:function(t){if(t=null!==t&&!1!==t&&void 0!==t?Amm.Util.pathToArray(t):null,this._dest!==t)return this._dest=t,!0},getDest:function(){return this._dest},apply:function(t,e){if(!t||"object"!=typeof t)throw Error("srcObject must be a non-null object");if(!e||"object"!=typeof e)throw Error("destObject must be a non-null object");var i,r=void 0;void 0!==(r=this._src?Amm.Util.getByPath(t,this._src,this.def):void 0!==this.def?this.def:t)&&void 0!==(r=Amm.Decorator.d(r,this,"decorator"))&&(null===(i=this._dest)&&this.merge?r&&"object"==typeof r&&Amm.override(e,r):Amm.Util.setByPath(e,i,r,{},this.merge))}},Amm.Element=function(t){if(this._beginInit(),this._cleanupList=[],this._expressions={},!t)return Amm.WithEvents.call(this),void this._endInit();var e;(t=Amm.Element._checkAndApplyOptionsBuilderSource(t))&&"object"==typeof t&&(t=Amm.override({},t));var i=this._getDefaultTraits(t),r=t.traits,n=[];if("expressions"in t&&(e=t.expressions,delete t.expressions),Amm.Element._checkAndApplyOptionsViews(t,n,r?null:i),t.extraTraits){if(r)throw Error("extraTraits and traits options cannot be used simultaneously");i=i.concat(t.extraTraits),delete t.extraTraits}if(r&&(t.traits instanceof Array?i=i.concat(t.traits):i.push(t.traits),delete t.traits),i.length)for(var s=[],o=0;o<i.length;o++){var a=Amm.getFunction(i[o]);0<=Amm.Array.indexOf(a,s)||(s.push(a),Amm.augment(this,a,t))}var h,l=[];for(var o in t)t.hasOwnProperty(o)&&("i"===o[0]&&"_"===o[2]&&"in__"===o.slice(0,4)&&(l.push([o.slice(4),t[o],Amm.Element.EXPROP_IN]),delete t[o]),"s"===o[0]&&"_"===o[4]&&"sync__"===o.slice(0,6)&&(l.push([o.slice(6),t[o],Amm.Element.EXPROP_SYNC]),delete t[o]),"e"===o[0]&&"_"===o[4]&&"expr__"===o.slice(0,6)?(l.push([o.slice(6),t[o],Amm.Element.EXPROP_EXPR]),delete t[o]):"p"===o[0]&&"_"===o[4]&&"prop__"===o.slice(0,6)&&((h=h||{})[o.slice(6)]=t[o],delete t[o]));Amm.WithEvents.call(this);var u=this._extractOnHandlers(t);if(Amm.init(this,t,["id","properties"]),Amm.init(this,t),h&&this.setProperties(h),l.length&&this._initInProperties(l),u&&this._initOnHandlers(u),e&&this.setExpressions(e),this._endInit(),n.length)for(var o=0,c=n.length;o<c;o++)n[o].setElement(this)},Amm.Element.EXPROP_IN=0,Amm.Element.EXPROP_SYNC=1,Amm.Element.EXPROP_EXPR=2,Amm.Element._checkAndApplyOptionsBuilderSource=function(t){if(Amm.Builder.isPossibleBuilderSource(t)&&(t={builderSource:t}),!t.builderSource)return t;var e=Amm.Builder.calcPrototypeFromSource(t.builderSource),i=t.builderPriority?Amm.override({},t,e):Amm.override(e,t);return delete i.builderSource,delete i.builderPriority,delete i.class,i},Amm.Element._checkAndApplyOptionsViews=function(t,e,i){if(t.views){for(var r=0,n=t.views.length;r<n;r++){var s=t.views[r];if(!Amm.getClass(s)){"string"==typeof s&&(s={class:s});var o=s.class;if(!o)throw Error("views["+r+"].class not provided");var a=Amm.getFunction(o);if(!a.prototype["Amm.View.Abstract"])throw Error("View class must be a descendant of Amm.View.Abstract");var h=s.class,l=s;delete s.class,s=new a(s),l.class=h}if(!s["Amm.View.Abstract"])throw Error("Created instance isn't a descendant of Amm.View.Abstract");e.push(s),i&&i.push.apply(i,s.getSuggestedTraits())}delete t.views}},Amm.Element.regInit=function(t,e,i){!1===t._initLevel&&i.call(t),t._init=t._init||{},t._init[e]=i},Amm.Element.prototype={"Amm.Element":"__CLASS__",_id:null,_cleanupList:null,_cleanupWithComponent:!0,defaultProperty:null,_init:null,_initLevel:0,_component:null,_closestComponent:null,_beginInit:function(){if(!1===this._initLevel)return!1;this._initLevel++,this._init=this._init||{}},_endInit:function(){if(!1===this._initLevel)return!1;if(0<this._initLevel&&this._initLevel--,!this._initLevel){if(this._init){this._initLevel=!1;var t=[];for(var e in this._init)this._init.hasOwnProperty(e)&&"function"==typeof this._init[e]&&t.push(e);t.sort();for(var e=0,i=t.length;e<i;e++)this._init[t[e]].call(this)}this._init=null}},setId:function(t){if(this._id!==t){var e=this._id;return this._id=t,this._callOwnMethods("_setId_",t,e),this.outIdChange(t,e),!0}},getId:function(){return this._id},outIdChange:function(t,e){this._out("idChange",t,e)},outCleanup:function(){this._out("cleanup",this)},setCleanupWithComponent:function(t){if(t=!!t,this._cleanupWithComponent!==t)return this._cleanupWithComponent=t,!0},getCleanupWithComponent:function(){return this._cleanupWithComponent},createProperty:function(t,e,i,r){return Amm.createProperty(this,t,e,i,r)},cleanup:function(){this.setComponent(null),this._callOwnMethods("_cleanup_");for(var t=this._cleanupList.length-1;0<=t;t--)"function"==typeof this._cleanupList[t].cleanup&&this._cleanupList[t].cleanup();this.outCleanup(),Amm.WithEvents.prototype.cleanup.call(this)},_callOwnMethods:function(t){var e,i=t instanceof RegExp,r={};for(var n in this)"function"==typeof this[n]&&(i?n.match(i):0===n.indexOf(t))&&(e=e||Array.prototype.slice.call(arguments,1),r[n]=this[n].apply(this,e));return r},setComponent:function(t){"root"===(t=t||null)&&(t=Amm.getRoot()),t&&(Amm.is(t,"Component","component"),t.getIsComponent()||(t=t.getClosestComponent()||null));var e=this._component;if(e!==t)return(this._component=t)&&t.acceptElements([this]),this._callOwnMethods("_setComponent_",t,e),this._setClosestComponent(),this.outComponentChange(t,e),!0},getComponent:function(){return this._component},outComponentChange:function(t,e){this._out("componentChange",t,e)},getClosestComponent:function(){return this._component},_setClosestComponent:function(){var t=this._closestComponent;this._closestComponent=this.getClosestComponent(),t!==this._closestComponent&&(this._callOwnMethods("_setClosestComponent_",this._closestComponent,t),this.outClosestComponentChange(this._closestComponent,t))},outClosestComponentChange:function(t,e){return this._out("closestComponentChange",t,e)},_findChildElementsRecursive:function(t){for(var e=[],i=0,r=t.length;i<r;i++){var n=t[i];n.Component&&n.getIsComponent()||(e=e.concat(n.findChildElements(!0)))}return e},findChildElements:function(t){var e=[];return this._callOwnMethods("_findChildElements_",e),t&&(e=e.concat(this._findChildElementsRecursive(e))),e},setProperties:function(t){if(!t||"object"!=typeof t)throw Error("`properties` must be an object");var e,i,r=[];for(var n in t){t.hasOwnProperty(n)&&(e=t[n],i=void 0,"in__"===n.slice(0,4)?(n=n.slice(4),r.push([n,e,Amm.Element.EXPROP_IN]),e=void 0):e&&"object"==typeof e&&("onChange"in e||"defaultValue"in e||"in__"in e)&&("in__"in e&&r.push([n,e.in__]),i=e.onChange,e=e.defaultValue),Amm.createProperty(this,n,e,i))}r.length&&this._initInProperties(r)},_initInProperties:function(t){for(var e=0,i=t.length;e<i;e++){var r=t[e][0],n=t[e][1],s=t[e][2],o=1<(o=r.split("__")).length?(r=o[0],o.slice(1)):void 0;this._createExpression(n,r,o,s)}},_createExpression:function(t,e,i,r){var n,s,o;if("function"==typeof t)s=t;else if("string"==typeof t&&"javascript:"===t.slice(0,11))s=t.slice(11);else if("string"==typeof t)o={src:t};else{if(!t||"object"!=typeof t)throw Error("Expression-property (in__`prop`, sync__`prop`, expr__`prop`) must be a string, function or Amm.Expression prototype");o=t}if(s){if(r!==Amm.Element.EXPROP_IN)throw Error("javascript function handler can be used only for in__`prop` expressions");return n=new Amm.Expression.FunctionHandler(s,this,e,void 0,i)}if(!o)throw Error("Logic error");if(o["Amm.Expression"])return o;var a=r===Amm.Element.EXPROP_SYNC?Amm.Expression.Sync:Amm.Expression;o.class&&(a=Amm.getFunction(o.class),delete o.class);var h=e;return r===Amm.Element.EXPROP_EXPR&&(h=void 0),n=new a(o,this,h,void 0,i),r===Amm.Element.EXPROP_EXPR&&this._configureExprExpression(n,e),Amm.is(n,r===Amm.Element.EXPROP_SYNC?"Amm.Expression.Sync":"Amm.Expression","expression"),n},_configureExprExpression:function(e,r){var t=r.charAt(0).toUpperCase()+r.slice(1),i="get"+t,n="set"+t,s="out"+t+"Change",o="_"+r,a=[];if(i in this&&a.push(i),n in this&&a.push(n),s in this&&a.push(s),o in this&&a.push(o),a.length)throw Error("Cannot define expr__"+r+" expression-property: memeber(s) '"+a.join("', '")+" already defined");this[i]=function(){return e.getValue()},this[n]=function(t){return e.setValue(t)},this[s]=function(t,e,i){return this._out(r+"Change",t,e,i)},e.subscribe("valueChange",this[s],this),this[o]=e},outViewAdded:function(t){this._out("viewAdded",t)},outViewDeleted:function(t){this._out("viewDeleted",t)},outViewReady:function(t){this._out("viewReady",t)},findView:function(t,e){for(var i=this.getUniqueSubscribers("Amm.View.Abstract"),r=0,n=i.length;r<n;r++)if((void 0===t||i[r].id===t)&&(void 0===e||Amm.is(i[r],e)))return i[r]},_getDefaultTraits:function(){return[]},constructDefaultViews:function(){}},Amm.extend(Amm.Element,Amm.WithEvents),Amm.FilterSorter=function(t){this._observers=[],this._objects=[],this._matches=[],this._deferredChanges=[],Amm.WithEvents.DispatcherProxy.call(this),Amm.WithEvents.call(this,t)},Amm.FilterSorter.prototype={"Amm.FilterSorter":"__CLASS__",_observers:null,_objects:null,_matches:null,_deferredChanges:null,_updateLevel:0,_compareMatch:null,_requireAll:!1,_cacheMatches:!1,_cacheProp:null,getObservedObjects:function(){return[].concat(this._objects)},setObservedObjects:function(t){var e,i;t=t?Amm.Array.unique(t):[];var r=Amm.Array.calcChanges(this._objects,t,null,0,!0);if(r.added.length||r.deleted.length){if(this.beginUpdate(),r.deleted.length){for(var n=[],s=[],o={},a=r.deleted.length-1;0<=a;a--)n.unshift(r.deleted[a][0]),i=this._matches[r.deleted[a][1]],s.unshift(i),this._objects.splice(a,1),this._matches.splice(a,1),o[r.deleted[a][1]]=!0,this._deferredChanges.push([void 0,i,r.deleted[a]]);for(a=this._deferredChanges.length-r.deleted.length;0<=a;a--)o[this._deferredChanges[a][0]]&&this._deferredChanges.splice(a,1);this._cacheMatches&&this._deleteCachedMatches(n),this._unsubObservers(n,void 0,!0),this.outObjectsUnobserved(n,s)}if(r.added.length){var h=[],l=[],u=[];for(a=0,e=r.added.length;a<e;a++)h.push(r.added[a][0]),i=this.evaluateMatch(r.added[a][0]),this._matches.push(i),l.push(i),u.push(this._objects.length+a),this._deferredChanges.push([this._objects.length+a,void 0,r.added[a][0]]);this._objects.push.apply(this._objects,h),this._cacheMatches&&this._saveCachedMatches(u),this._subObservers(h,void 0,!1,!0),this.outObjectsObserved(h,l)}this.endUpdate()}},getMatches:function(){return[].concat(this._matches)},_subObservers:function(t,e,i,r){t=t||this._objects;for(var n=i?"unobserve":"observe",s=0,o=(e=e||this._observers).length;s<o;s++)e[s][n](t);if(r)for(n=i?"unsubscribeObject":"subscribeObject",s=0,o=t.length;s<o;s++){var a=t[s];a["Amm.WithEvents"]&&a.hasEvent("cleanup")&&this[n](a,"cleanup",this._handleObjectCleanup,this)}},_handleObjectCleanup:function(){var t=Amm.event.origin;this.unobserveObject(t)},beforeDispatch:function(t,e,arguments){(1<e.length||e[0][1]&&e[0][1]["Amm.Expression"])&&this.beginUpdate()},afterDispatch:function(t,e,arguments){(1<e.length||e[0][1]&&e[0][1]["Amm.Expression"])&&this.endUpdate()},_unsubObservers:function(t,e,i){return this._subObservers(t,e,!0,i)},beginUpdate:function(){this._updateLevel++},_hasChangeSubscribers:function(){return this._subscribers.matchesChange},endUpdate:function(){if(!this._updateLevel)throw Error("call to endUpdate() without prior beginUpdate()");if(1<this._updateLevel)this._updateLevel--;else{if(!this._hasChangeSubscribers())return this._deferredChanges=[],void this._updateLevel--;for(var t,e={},i=[],r=[],n=[],s=this._deferredChanges.length-1;0<=s;s--){if(void 0!==(t=this._deferredChanges[s][0])){if(e[t])continue;e[t]=!0}var o=this._deferredChanges[s][1],a=this._deferredChanges[s][2],h=this._matches[t];o===h||this._compareMatch&&!this._compareMatch(o,h)||(i.unshift(a),n.unshift(o),r.unshift(h))}this._deferredChanges=[],this._updateLevel--,i.length&&(this.outMatchesChange(i,r,n),this._doOnEndUpdateChange())}},_doOnEndUpdateChange:function(){},getUpdateLevel:function(){return this._updateLevel},getMatch:function(t,e){if(this._cacheMatches){var i=this._getCachedMatch(t);if(void 0!==i)return i}var r=Amm.Array.indexOf(t,this._objects);return 0<=r?this._matches[r]:e?this.evaluateMatch(t):void 0},refresh:function(t){if(t){var e=Amm.Array.indexOf(t,this._objects);if(e<0)throw Error("`object` not observed, cannot refresh()");var i=this.evaluateMatch(t);this._updateMatch(e,i)}else{this.beginUpdate(),this._deferredChanges=[];for(var r=0,n=this._objects.length;r<n;r++){var s=this.evaluateMatch(this._objects[r]);this._updateMatch(r,s)}this.endUpdate()}},_doOnUpdateMatch:function(t,e,i){},_updateMatch:function(t,e){var i=this._matches[t];i===e||this._compareMatch&&!this._compareMatch(i,e)||(this._updateLevel&&this._deferredChanges.push([t,i,this._objects[t]]),this._matches[t]=e,this._cacheMatches&&this._saveCachedMatches([t]),this._updateLevel||(this.outMatchesChange([this._objects[t]],[e],[i]),this._doOnUpdateMatch(t,i,e)))},evaluateMatch:function(t){return null},observeObject:function(t){var e,i=Amm.Array.indexOf(t,this._objects);if(0<=i)return this._matches[i];this._objects.push(t),this._subObservers([t],void 0,!1,!0),e=this.evaluateMatch(t);for(var r=this._deferredChanges.length-1;0<=r;r--)void 0===this._deferredChanges[r][0]&&this._deferredChanges[r][2]===t&&(this._matches[this._objects.length-1]=this._deferredChanges[r][1],this._deferredChanges.splice(r,1));return this._updateMatch(this._objects.length-1,e),this.outObjectsObserved([t],[e]),e},unobserveObject:function(t){var e,i=Amm.Array.indexOf(t,this._objects);if(!(i<0)){this._cacheMatches&&this._deleteCachedMatches([t]);var r=this._matches[i];this._objects.splice(i,1),this._matches.splice(i,1),r&&(e=this._matchingObjects,this._matchingObjects=null);for(var n=this._deferredChanges.length-1;0<=n;n--)this._deferredChanges[n][0]>i?this._deferredChanges[n][0]--:this._deferredChanges[n][0]===i&&this._deferredChanges.splice(n,1);if(this._updateLevel?this._deferredChanges.push([void 0,r,t]):this.outMatchesChange([t],[void 0],[r]),this._unsubObservers([t]),!this._updateLevel)return r&&this._subscribers.matchingObjectsChange&&this.outMatchingObjectsChange(this.getMatchingObjects(),e),this.outObjectsUnobserved([t],[r]),r}},hasObservedObject:function(t){return 0<=Amm.Array.indexOf(t,this._objects)},outObjectsObserved:function(t,e){this._out("objectsObserved",t,e)},outObjectsUnobserved:function(t,e){this._out("objectsUnobserved",t,e)},outMatchesChange:function(t,e,i){this._out("matchesChange",t,e,i)},_saveCachedMatches:function(t){if(this._cacheMatches){void 0===t||t instanceof Array||(t=[t]),this._cacheProp||(Amm.registerItem(this),this._cacheProp="_Amm.FilterSorter."+this._amm_id,Amm.unregisterItem(this));for(var e=0,i=t?t.length:this._objects.length;e<i;e++){var r=t?t[e]:e,n=this._objects[r],s=this._matches[r];n[this._cacheProp]=s}}},_getCachedMatch:function(t){if(t&&this._cacheProp)return t[this._cacheProp]},_deleteCachedMatches:function(t){if(this._cacheProp)for(var e=0,i=t.length;e<i;e++)delete t[e][this._cacheProp]},setCacheMatches:function(t){if(t=!!t,this._cacheMatches!==t)return(this._cacheMatches=t)?this._saveCachedMatches():this._deleteCachedMatches(this._objects),!0},getCacheMatches:function(){return this._cacheMatches},cleanup:function(){Amm.WithEvents.prototype.cleanup.apply(this),this._matches=[],this._unsubObservers();for(var t=0,e=this._observers.length;t<e;t++)this._observers[t].cleanup();this._observers=[],this.setObservedObjects([])}},Amm.extend(Amm.FilterSorter,Amm.WithEvents.DispatcherProxy),Amm.extend(Amm.FilterSorter,Amm.WithEvents),Amm.Sorter=function(t){var i;this._compareClosureFn=(i=this,function(t,e){return i.compareObjects(t,e)}),Amm.FilterSorter.call(this,t)},Amm.Sorter.ascendingDescRx=/\s+(asc|desc)$/i,Amm.Sorter.propNameRx=/^\w+$/,Amm.Sorter.prototype={"Amm.Sorter":"__CLASS__",_needReorderCriteria:!1,_parseAscendingDesc:!0,_allowExpressions:!0,_cacheMatches:!0,_lockIndexes:0,_compareClosureFn:null,_directions:null,_oldDirections:null,_deleteCriterion:function(t,e){var i;this._observers[t]&&(i=this._observers[t],this._unsubObservers(this._objects,[i]),i.cleanup(),e&&this._innerShift(t,this._observers.length))},setCriteria:function(t,e){if(void 0!==e){this._directions=null;var i=e;if(i<0&&(i=0),i>this._observers.length&&(i=this._observers.length),t){this._lockIndexes++;try{t=this._getCriterionPrototype(t,i)}catch(t){throw this._lockIndexes--,t}this._lockIndexes--}else t=null;if(this._observers[i]){if(this._observers[i]===t)return;if(0<=e)return this._deleteCriterion(i,!t),this._directions=null,void this.refresh()}return t?(e<0&&this._innerShift(this._observers.length,0,!0),this._observers[i]=t,this._directions=null,this.refresh(),!0):(this._directions=null,this.refresh(),!0)}var r,n;try{this.beginUpdate(),this._lockIndexes++;var s,o=[];for(t instanceof Array||(t=[t]),this._directions=null,r=0,n=t.length;r<n;r++)s=this._getCriterionPrototype(t[r],r),o.push(s);var a=Amm.constructMany(o,"Amm.Sorter.Criterion");for(a.sort(function(t,e){return t.getIndex()-e.getIndex()}),r=0,n=a.length;r<n;r++)a[r].setIndex(r);for(r=0,n=this._observers.length;r<n;r++)this._observers[r].cleanup();this._observers=a,this._objects.length&&this._subObservers(this._objects)}catch(t){throw this._lockIndexes--,this.endUpdate(),t}this._lockIndexes--,this._directions=null,this.refresh(),this.endUpdate()},getCriteria:function(t){return void 0===t?[].concat(this._observers):this._observers[t]},_getCriterionPrototype:function(t,e){if(t&&"object"==typeof t){if(t["Amm.Sorter.Criterion"]){if(t.getFilterSorter()!==this)throw Error("setCriteria(): `criteria["+e+"]` doesn't belong to current Sorter");null===t.getIndex()&&t.setIndex(e),n=t}else"number"!=typeof(n={}.override(t)).index&&(n.index=e);return n.filterSorter=this,n}var i,r=!0,n={};if("string"!=typeof t)throw Error("`criteria["+e+"]` should be either string or object; given: "+Amm.describeType(t));return this._parseAscendingDesc&&(i=Amm.Sorter.ascendingDescRx.exec(t))&&(r="asc"===i[1].toLowerCase(),t=t.slice(0,-i[0].length)),this._allowExpressions&&!Amm.Sorter.propNameRx.exec(t)?(n.expression=t,n.class=Amm.Sorter.Expression):(n.class=Amm.Sorter.Property,n.property=t),"index"in n||(n.index=e),n.ascending=r,n.filterSorter=this,n},compareObjects:function(t,e){var i=this.getMatch(t,!0),r=this.getMatch(e,!0);return this.compareMatches(i,r)},calcSortValue:function(t,e){return this.getMatch(t,!0)},getCompareClosureFn:function(){return this._compareClosureFn},_innerShift:function(t,e,i){this._lockIndexes++;for(var r=e<t?-1:1,n=t;n*r<e*r;n+=r)this._observers[n]=this._observers[n+r],i&&this._observers[n].setIndex(n);this._lockIndexes--},notifyCriterionIndexChanged:function(t,e,i){if(!this._lockIndexes){if(this._observers[i]!==t&&(i=Amm.Array.indexOf(t,this._observers))<0)throw Error("Provided criterion is not registered observer");e<0&&(e=0),e>=this._observers.length&&(e=this._observers.length-1),e!==i&&(this._innerShift(i,e,!0),(this._observers[e]=t).setIndex(e),this._lockIndexes--,this.refresh())}},notifyCriterionDirectionChanged:function(t,e,i){this._directions&&(this._directions=null,this.outNeedSort())},compareMatches:function(t,e){var i,r,n;if(!(t instanceof Array)&&e instanceof Array)throw Error("both matches must be Arrays");if(t.length!==e.length)throw Error("both matches must have same length");for(this._directions||(this._directions=this._getDirections()),i=0,r=t.length;i<r;i++)if(t[i]!==e[i])return n=t[i]<e[i]?-1:t[i]>e[i]?1:0,this._directions[i]||(n*=-1),n;return 0},_compareMatch:function(t,e){return t===e?0:t&&e&&(t instanceof Array||t["Amm.Array"])&&(e instanceof Array||e["Amm.Array"])?!Amm.Array.equal(t,e):1},outNeedSort:function(){return this._oldDirections=null,this._out("needSort")},sort:function(t){var e;if(t&&t["Amm.Array"])e=t.getItems();else{if(!(t&&t instanceof Array))throw Error("`objects` must be Array or Amm.Array");e=t.slice()}return e.sort(this._compareClosureFn)},evaluateMatch:function(t){if(!this._observers.length)return[];for(var e=[],i=0,r=this._observers.length;i<r;i++)e.push(this._observers[i].getValue(t));return e},_doOnEndUpdateChange:function(){this.outNeedSort()},_doOnUpdateMatch:function(t,e,i){this.outNeedSort()},_hasChangeSubscribers:function(){return this._subscribers.matchesChange||this._subscribers.needSort},_getDirections:function(){if(this._directions)return this._directions;for(var t=[],e=0,i=this._observers.length;e<i;e++)t.push(this._observers[e].getAscending());return t},beginUpdate:function(){Amm.FilterSorter.prototype.beginUpdate.call(this),1===this._updateLevel&&(this._oldDirections=this._getDirections())},endUpdate:function(){Amm.FilterSorter.prototype.endUpdate.call(this),!this._oldDirections||this._directions||Amm.Array.equal(this._getDirections(),this._oldDirections)||(this._directions=null,this.outNeedSort())}},Amm.extend(Amm.Sorter,Amm.FilterSorter),Amm.FilterSorter.Observer=function(t,e){this._filterSorter=t,Amm.WithEvents.call(this,e,!0)},Amm.FilterSorter.Observer.prototype={"Amm.FilterSorter.Observer":"__CLASS__",_filterSorter:null,match:function(t){return!0},cleanup:function(t){this.unsubscribe(),this._filterSorter=null,Amm.WithEvents.prototype.cleanup.call(this)},observe:function(t){},unobserve:function(t){}},Amm.extend(Amm.FilterSorter.Observer,Amm.WithEvents),Amm.Sorter.Criterion=function(t,e){void 0===e&&t&&"object"==typeof t&&t.filterSorter&&(t=(e=t).filterSorter,delete e.filterSorter),Amm.FilterSorter.Observer.call(this,t,e),Amm.init(this,e)},Amm.Sorter.Criterion.prototype={"Amm.Sorter.Criterion":"__CLASS__",_index:null,_ascending:!0,_defaultValue:null,setIndex:function(t){var e=this._index;if(e!==t)return this._index=t,this._filterSorter.notifyCriterionIndexChanged(this,t,e),this.outIndexChange(t,e),!0},getIndex:function(){return this._index},outIndexChange:function(t,e){this._out("indexChange",t,e)},setAscending:function(t){t=!!t;var e=this._ascending;if(e!==t)return this._ascending=t,this._filterSorter.notifyCriterionDirectionChanged(this,t,e),this.outAscendingChange(t,e),!0},getAscending:function(){return this._ascending},outAscendingChange:function(t,e){this._out("ascendingChange",t,e)},setDefaultValue:function(t){var e=this._defaultValue;if(e!==t)return this._defaultValue=t,this.outDefaultValueChange(t,e),this._filterSorter.refresh(),!0},getDefaultValue:function(){return this._defaultValue},outDefaultValueChange:function(t,e){this._out("defaultValueChange",t,e)},getValue:function(t){var e=this._doGetValue(t);return void 0===e&&(e=this._defaultValue),e},_doGetValue:function(t){}},Amm.extend(Amm.Sorter.Criterion,Amm.FilterSorter.Observer),Amm.Sorter.Expression=function(t,e){if(Amm.Sorter.Criterion.call(this,t,e),!this._expression)throw Error("Need to provide options.expression")},Amm.Sorter.Expression.prototype={"Amm.Sorter.Expression":"__CLASS__",_expression:null,_evaluator:null,setExpression:function(t){if(this._expression!==t){if(this._expression)throw Error("Can setExpression() only once");if("string"!=typeof t)throw Error("`expression` must be a string");return this._expression=new Amm.Expression(t),this._expression.setEventsProxy(this._filterSorter),!0}},getExpression:function(){return this._expression},observe:function(t){for(var e=0,i=t.length;e<i;e++){var r=t[e];void 0===this._expression.findContext(r)&&(this._expression.createContext({expressionThis:r}),this._expression.subscribe("valueChange",this._handleExpressionChanged,this))}},unobserve:function(t){for(var e=0,i=t.length;e<i;e++){var r=this._expression.findContext(t[e]);void 0!==r&&this._expression.deleteContext(r)}},_handleExpressionChanged:function(t,e){var i=this._expression.getExpressionThis();this._filterSorter.refresh(i)},_doGetValue:function(t){if(t===this._expression.getExpressionThis())return this._expression.getValue();var e=this._expression.findContext(t);return void 0!==e?(this._expression.setContextId(e),this._expression.getValue()):(this._evaluator||(this._evaluator=this._expression.toFunction()),this._evaluator.env.expressionThis=t,this._evaluator())},cleanup:function(){Amm.Sorter.Criterion.prototype.cleanup.call(this),this._expression.cleanup(),this._evaluator=null,this._expression=null}},Amm.extend(Amm.Sorter.Expression,Amm.Sorter.Criterion),Amm.Sorter.Property=function(t,e){if(Amm.Sorter.Criterion.call(this,t,e),!this._property)throw Error("Need to specify options.property")},Amm.Sorter.Property.prototype={"Amm.Sorter.Property":"__CLASS__",_property:null,setProperty:function(t){if(this._property!==t){if(this._property)throw Error("Can setProperty() only once");return this._property=t,!0}},getProperty:function(){return this._property},observe:function(t){for(var e,i=t||this._filterSorter._objects,r=i.length,n=this._property+"Change",s=0;s<r;s++)(e=i[s])["Amm.WithEvents"]&&e.hasEvent(n)&&this._filterSorter.subscribeObject(e,n,this._handleChange,this)},unobserve:function(t){for(var e,i=t||this._filterSorter._objects,r=i.length,n=this._property+"Change",s=0;s<r;s++)(e=i[s])["Amm.WithEvents"]&&e.hasEvent(n)&&this._filterSorter.unsubscribeObject(e,n,this._handleChange,this)},_handleChange:function(){var t;this._filterSorter&&(t=Amm.event.origin,this._filterSorter.refresh(t))},_doGetValue:function(t){return Amm.getProperty(t,this._property)}},Amm.extend(Amm.Sorter.Property,Amm.Sorter.Criterion),Amm.DomHolder=function(){},Amm.DomHolder.find=function(t,e,i){var r,s=Amm.domHolderAttribute,n=[],o={};for(var a in jQuery(t)[e?"find":"closest"]("["+s+"]").each(function(t,e){for(var i=e.getAttribute(s).split(" "),r=0,n=i.length;r<n;r++)i[r].length&&(o[i[r]]=1)}),o){!o.hasOwnProperty(a)||(r=Amm.getItem(a,i))&&n.push(r)}return n},Amm.DomHolder.prototype={"Amm.DomHolder":"__CLASS__",_domExclusive:!0,_notifyDomNodeConflict:function(t,e){if(this._domExclusive&&!this._domCompat(e)){var i="Element already acquired by a different DomHolder";throw console.error(i,this,t,e),Error(i)}},_domCompat:function(t){return this["Amm.ElementBound"]&&t["Amm.ElementBound"]&&this._element&&t._element===this._element},_acquireDomNode:function(t){Amm.registerItem(this);var o=this,a=Amm.domHolderAttribute;jQuery(t).each(function(t,e){var i=e.getAttribute(a)||"";if(i.indexOf(" "+o._amm_id)<0){for(var r=i.split(" "),n=Amm.getItem(r),t=0,s=n.length;t<s;t++)o._notifyDomNodeConflict(e,n[t]),n[t]._notifyDomNodeConflict(e,o);r.push(o._amm_id),e.setAttribute(a,r.join(" "))}})},_releaseDomNode:function(t){var r=" "+this._amm_id,n=Amm.domHolderAttribute;jQuery(t).each(function(t,e){var i;e.hasAttribute(n)&&((i=e.getAttribute(n).replace(r,"")).length?e.setAttribute(n,i):e.removeAttribute(n))})}},Amm.Validator=function(t){Amm.override(this,t)},Amm.Validator.construct=function(t,e,i,r){return"function"==typeof t?Amm.constructInstance({func:t},"Amm.Validator.Function",e,i,r):Amm.constructInstance(t,"Amm.Validator",e,i,r)},Amm.Validator.instantiate=function(t,e){return t[e]["Amm.Validator"]||(t[e]=Amm.Validator.construct(t[e])),t[e]},Amm.Validator.iErr=function(t,e,i,r){return Amm.Validator.instantiate(t,e).getError(i,r)},Amm.Validator.prototype={"Amm.Validator":"__CLASS__",_msg:function(t){for(var e=1,i=arguments.length;e<i;e+=2)if("%field"===arguments[e]&&void 0===arguments[e+1]){arguments[e+1]=Amm.translate("lang.Amm.Validator.value");break}var r=Array.prototype.slice.apply(arguments);return Amm.translate.apply(Amm,r)},isEmpty:function(t){return""===t||null==t},getError:function(t,e){return null}},Amm.defineLangStrings({"lang.Amm.Validator.value":"Value"}),Amm.Validator.Number=function(t){Amm.Validator.call(this,t)},Amm.Validator.Number.prototype={"Amm.Validator.Number":"__CLASS__",allowEmpty:!0,strict:!0,allowFloat:!0,gt:null,ge:null,lt:null,le:null,msgMustBeNumber:"lang.Amm.Validator.Number.msgMustBeNumber",msgMustBeInteger:"lang.Amm.Validator.Number.msgMustBeInteger",msgMustBeGt:"lang.Amm.Validator.Number.msgMustBeGt",msgMustBeGe:"lang.Amm.Validator.Number.msgMustBeGe",msgMustBeLt:"lang.Amm.Validator.Number.msgMustBeLt",msgMustBeLe:"lang.Amm.Validator.Number.msgMustBeLe",getError:function(t,e){if(this.isEmpty(t)){if(this.allowEmpty)return;return this._msg(this.msgMustBeNumber,"%field",e)}var i=parseInt(t),r=parseFloat(t),n=r!=t&&i!=t;if(isNaN(i)||this.strict&&n)return this._msg(this.msgMustBeNumber,"%field",e);if(i!=r&&!this.allowFloat)return this._msg(this.msgMustBeInteger,"%field",e);var s=this.allowFloat?r:i,o=this.gt;return null===o||o<s?null===(o=this.ge)||o<=s?null===(o=this.lt)||s<o?null===(o=this.le)||s<=o?void 0:this._msg(this.msgMustBeLe,"%field",e,"%val",o):this._msg(this.msgMustBeLt,"%field",e,"%val",o):this._msg(this.msgMustBeGe,"%field",e,"%val",o):this._msg(this.msgMustBeGt,"%field",e,"%val",o)}},Amm.extend(Amm.Validator.Number,Amm.Validator),Amm.defineLangStrings({"lang.Amm.Validator.Number.msgMustBeNumber":"%field must be a number","lang.Amm.Validator.Number.msgMustBeInteger":"%field must be an integer number","lang.Amm.Validator.Number.msgMustBeGt":"%field must be higher than %val","lang.Amm.Validator.Number.msgMustBeGe":"%field must not be less than %val","lang.Amm.Validator.Number.msgMustBeLt":"%field must be less than %val","lang.Amm.Validator.Number.msgMustBeLe":"%field must not exceed %val"}),Amm.Validator.Function=function(t){Amm.Validator.call(this,t)},Amm.Validator.Function.prototype={"Amm.Validator.Function":"__CLASS__",element:null,func:null,message:"lang.Amm.Validator.Function.msg",getError:function(t,e){var i={message:null},r=null;if("function"==typeof this.func)if("string"==typeof(r=this.func(t,e,i,this.element)))r=Amm.translate(r,"%field",e);else{if(r||void 0===r)return;r=Amm.translate(i.message||this.message,"%field",e)}else Error("Amm.Validator.Function: this.`func` not set (or not a function)");return r}},Amm.extend(Amm.Validator.Function,Amm.Validator),Amm.defineLangStrings({"lang.Amm.Validator.Function.msg":"%field is invalid"}),Amm.Validator.Required=function(t){Amm.Validator.call(this,t)},Amm.Validator.Required.prototype={"Amm.Validator.Required":"__CLASS__",message:"lang.Amm.Validator.Required.msg",getError:function(t,e){if(this.isEmpty(t))return this._msg(this.message,"%field",e)}},Amm.extend(Amm.Validator.Required,Amm.Validator),Amm.defineLangStrings({"lang.Amm.Validator.Required.msg":"%field is required"}),Amm.Validator.Email=function(t){Amm.Validator.call(this,t)},Amm.Validator.Email.getRegExp=function(){return Amm.Validator._emailRegExp||(Amm.Validator._emailRegExp=Amm.Validator.Email._buildRegExp()),Amm.Validator._emailRegExp},Amm.Validator.Email._buildRegExp=function(){return new RegExp("^([^\\x00-\\x20\\x22\\x28\\x29\\x2c\\x2e\\x3a-\\x3c\\x3e\\x40\\x5b-\\x5d\\x7f-\\xff]+|\\x22([^\\x0d\\x22\\x5c\\x80-\\xff]|\\x5c\\x00-\\x7f)*\\x22)(\\x2e([^\\x00-\\x20\\x22\\x28\\x29\\x2c\\x2e\\x3a-\\x3c\\x3e\\x40\\x5b-\\x5d\\x7f-\\xff]+|\\x22([^\\x0d\\x22\\x5c\\x80-\\xff]|\\x5c\\x00-\\x7f)*\\x22))*\\x40([^\\x00-\\x20\\x22\\x28\\x29\\x2c\\x2e\\x3a-\\x3c\\x3e\\x40\\x5b-\\x5d\\x7f-\\xff]+|\\x5b([^\\x0d\\x5b-\\x5d\\x80-\\xff]|\\x5c\\x00-\\x7f)*\\x5d)(\\x2e([^\\x00-\\x20\\x22\\x28\\x29\\x2c\\x2e\\x3a-\\x3c\\x3e\\x40\\x5b-\\x5d\\x7f-\\xff]+|\\x5b([^\\x0d\\x5b-\\x5d\\x80-\\xff]|\\x5c\\x00-\\x7f)*\\x5d))*$")},Amm.Validator.Email.prototype={"Amm.Validator.Email":"__CLASS__",msgMustBeEmail:"lang.Amm.Validator.Email.msgMustBeEmail",getError:function(t,e){if(!this.isEmpty(t))return!Amm.Validator.Email.getRegExp().exec(t)&&this._msg(this.msgMustBeEmail,e)}},Amm.extend(Amm.Validator.Email,Amm.Validator),Amm.defineLangStrings({"lang.Amm.Validator.Email.msgMustBeEmail":"%field must be a valid e-mail address"}),Amm.View={},Amm.JQueryListener=function(t){Amm.init(this,t)},Amm.JQueryListener.prototype={_handler:null,_onJQuery:null,_onArgs:null,elementPass:null,eventPass:null,_eventName:null,_selector:null,_delegateSelector:null,_htmlRoot:null,setEventName:function(t){this._eventName!==t&&(this._eventName=t,this._bind())},getEventName:function(){return this._eventName},setSelector:function(t){this._selector!==t&&(this._selector=t,this._bind())},getSelector:function(){return this._selector},setDelegateSelector:function(t){this._delegateSelector!==t&&(this._delegateSelector=t,this._bind())},getDelegateSelector:function(){return this._delegateSelector},setHtmlRoot:function(t){this._htmlRoot!==t&&(this._htmlRoot=t,this._bind())},getHtmlRoot:function(){return this._htmlRoot},_bind:function(){this._onJQuery&&(this._onJQuery.off.apply(this._onJQuery,this._onArgs),this._onJQuery=null,this._onArgs=null),this._selector&&this._eventName&&this._handler&&(this._onArgs=[this._handler],this._delegateSelector&&this._onArgs.unshift(this._delegateSelector),this._onArgs.unshift(this._eventName),this._onJQuery=this._htmlRoot?jQuery(this._htmlRoot).find(this._selector):jQuery(this._selector),this._onJQuery.on.apply(this._onJQuery,this._onArgs))},cleanup:function(){this._handler=null,this._bind()},setHandler:function(t){if(this._handler!==t)return this._handler=t,this._bind(),!0},getHandler:function(){return this._handler}},Amm.Expression.Sync=function(t,e,i,r,n,s,o,a){Amm.Expression.call(this,t,e,i,r,n)},Amm.Expression.Sync.prototype={"Amm.Expression.Sync":"__CLASS__",_translator:null,_errProperty:null,_errObject:null,_writeGetter:null,_writeSetter:null,_writeEvent:null,_lastError:!1,setTranslator:function(t){if(t?Amm.getClass(t)?Amm.is(t,"Amm.Translator","translator"):t=Amm.constructInstance(t,"Amm.Translator"):t=null,this._translator!==t)return this._translator=t,this._write(),!0},getTranslator:function(){return this._translator},setErrProperty:function(t){if(this._errProperty!==t)return this._errProperty=t,!0},getErrProperty:function(){return this._errProperty},setErrObject:function(t){if(this._errObject!==t)return this._errObject=t,this._handleTranslationError(this._lastError,!1,!0),!0},getErrObject:function(){return this._errObject},setWriteProperty:function(t,e,i){var r=Amm.Expression.prototype.setWriteProperty.call(this,t,e,i);if(this._writeObject&&this._writeObject["Amm.Expression"])return this._writeObject.subscribe("valueChange",this._handleWriteValueChange,this),r;if(this._writeEvent||this._detectWriteProperty(),!this._writeEvent)throw Error("writeObject doesn't have event for change of writeProperty '"+this._writeProperty+"' so Amm.Expression.Sync cannot function");(this._writeObject||this._expressionThis).subscribe(this._writeEvent,this._handleWriteValueChange,this)},_detectWriteProperty:function(){var t=this._writeObject||this._expressionThis,e={};Amm.detectProperty(t,this._writeProperty,e),this._writeGetter=e.getterName,this._writeSetter=e.setterName,this._writeEvent=e.eventName},_write:function(){var t=this._writeObject||this._expressionThis;if(t&&!this._lockWrite){this._lockWrite++;var e,i=this.getValue(),r=!0;if(this._translator&&void 0!==i&&(e={},i=this._translator.translateIn(i,e),e.error&&(r=!1),this._handleTranslationError(e.error,!0)),r){this._writeGetter||this._detectWriteProperty();var n=t[this._writeGetter]();if(void 0===i&&void 0!==n)return this._setTranslatedValue(n),void this._lockWrite--;Amm.setProperty(t,this._writeProperty,i,!1,this._writeArgs),this._lockWrite--}else this._lockWrite--}},_setTranslatedValue:function(t){var e,i;this._translator?(e={},i=this._translator.translateOut(t,e),e.error||this.setValue(i),this._handleTranslationError(e.error||null,!1)):this.setValue(t)},_handleTranslationError:function(t,e,i){t===this._lastError&&!i||(this._lastError=t,this._errProperty&&Amm.setProperty(this._errObject||this._expressionThis,this._errProperty,t))},_handleWriteValueChange:function(t,e){this._lockWrite||(this._lockWrite++,this._setTranslatedValue(t),this._lockWrite--)},parse:function(t){if(Amm.Expression.prototype.parse.call(this,t),!this.supportsAssign)throw Error("Amm.Expression.Sync must be assignable, but '"+t+"' is not")},notifyWriteDestinationChanged:function(){if(Amm.Expression.prototype.notifyWriteDestinationChanged.call(this))return!0;var t,e;this._writeGetter&&this._hasValue&&void 0===this._value&&((t=this._writeObject||this._expressionThis)&&void 0!==(e=t[this._writeGetter]())&&this._setTranslatedValue(e))}},Amm.extend(Amm.Expression.Sync,Amm.Expression),Amm.Expression.FunctionHandler=function(t){var e;Amm.WithEvents.call(this,t,!0),this._expressions={},this._get={},this._set={};var i=null,r=this;this._getter=function(t,e){return r.get(t,e)},this._setter=function(t,e){return r.set(t,e)},"string"==typeof t&&(t=Amm.Expression.FunctionHandler.prepareFunctionHandlerBody(t)),"function"==typeof t?2<=arguments.length||"object"==typeof arguments[2]&&!(arguments[2]instanceof Array)?((e=arguments[6]||{}).fn=t,e.expressionThis=arguments[1],i=!0):((e=arguments[2]||{}).fn=t,e.expressionThis=arguments[1]):e=t,Amm.init(this,e),i&&this.setWriteProperty(arguments[2],arguments[3],arguments[4])},Amm.Expression.FunctionHandler.prototype={cleanupWithThis:!0,_fn:null,_expressionThis:null,_isRun:0,_get:null,_set:null,_again:!1,_writeObject:null,_writeProperty:null,_writeArgs:null,_lockWrite:0,_value:null,_gotValue:!1,setFn:function(t){if(this._fn!==t){if(this._fn)throw Error("Can setFn() only once");if("function"!=typeof t)throw Error("fn must be a function");return this._fn=t,!0}},getFn:function(){return this._fn},setExpressionThis:function(t){var e=this._expressionThis;if(e!==t){if(e&&e["Amm.WithEvents"]&&e.hasEvent("cleanup")&&t.unsubscribe("cleanup",this._handleExpressionThisCleanup,this),"object"!=typeof t||!t)throw Error("expressionThis must be a non-null object");for(var i in this._expressionThis=t,this._lockWrite++,this._expressions)this._expressions.hasOwnProperty(i)&&this._expressions[i].setExpressionThis(null);return t["Amm.WithEvents"]&&t.hasEvent("cleanup")&&t.subscribe("cleanup",this._handleExpressionThisCleanup,this),this._lockWrite--,this._lockWrite||this._run(),!0}},getExpressionThis:function(){return this._expressionThis},_setValue:function(t){var e=this._value;if(e!==t)return this._gotValue=!0,this._value=t,this._writeProperty&&this._write(),this.outValueChange(t,e),!0},getValue:function(t){return!t&&this._gotValue||this._run(t),this._value},outValueChange:function(t,e){this._out("valueChange",t,e)},_run:function(t){var e;this._fn&&(this._isRun||(this._isRun++,this._again=!!t,e=this._fn.call(this,this._getter,this._setter),this._setValue(e),this._cleanExpressions(),this._isRun--))},setWriteProperty:function(t,e,i){1===arguments.length&&t instanceof Array&&(e=(t=t[0])[1],i=t[2]),this._writeProperty&&Error("Can setWriteProperty() only once"),t||Error("writeProperty must be non-falseable"),t["Amm.Expression"]&&((e||i)&&Error("When Amm.Expression is used as writeProperty, don't specify writeObject/writeArgs"),e=t,t="value",e.subscribe("writeDestinationChanged",this._write,this)),null==i?i=null:i instanceof Array||(i=[i]),e||this._expressionThis||Error("setExpressionThis() or provide writeObject when setting writeProperty"),this._writeProperty=t,(this._writeObject=e)&&e["Amm.WithEvents"]&&e.hasEvent("cleanup")&&e.subscribe("cleanup",this.cleanup,this),this._writeArgs=i,this._write()},_write:function(){var t;!this._lockWrite&&this._writeProperty&&(this._lockWrite++,t=this._writeObject||this._expressionThis,Amm.setProperty(t,this._writeProperty,this.getValue(),!1,this._writeArgs),this._lockWrite--)},getWriteProperty:function(t){return t?[this._writeProperty,this._writeObject,this._writeArgs]:this._writeProperty},getWriteObject:function(){return this._writeObject},getWriteArgs:function(){return this._writeArgs},_handleExpressionValueChange:function(t,e){this._lockWrite||this._run()},_handleExpressionDestinationChange:function(){this._lockWrite||this._run()},_access:function(t,e){return this._isRun&&(this[e?"_set":"_get"][t]=!0),this._expressions[t]||(this._expressions[t]=new Amm.Expression(t,this._expressionThis),this._expressions[t].cleanupWithThis=!1,e?this._expressions[t].subscribe("writeDestinationChanged",this._handleExpressionDestinationChange,this):this._expressions[t].subscribe("valueChange",this._handleExpressionValueChange,this)),this._expressions[t]},get:function(t,e){return void 0===e&&(e=this._again),this._access(t).getValue(e)},set:function(t,e){return this._access(t,!0).setValue(e)},_handleExpressionThisCleanup:function(){this.cleanupWithThis?this.cleanup():this.setExpressionThis(null)},_cleanExpressions:function(t){for(var e in this._expressions)this._expressions.hasOwnProperty(e)&&(!t&&(this._get[e]||this._set[e])||(this._expressions[e].unsubscribe(void 0,void 0,this),this._expressions[e].cleanup(),delete this._expressions[e]));this._get={},this._set={}},cleanup:function(){this._cleanExpressions(!0),this._writeObject&&this._writeObject["Amm.Expression"]&&this._writeObject.cleanup(),Amm.WithEvents.prototype.cleanup.call(this)}},Amm.extend(Amm.Expression.FunctionHandler,Amm.WithEvents),Amm.Expression.FunctionHandler.prepareFunctionHandlerBody=function(t){var i=!1,r="",e=t.replace(/([{]:|:[}]|:|[{}]|[^:{}]+)/g,function(t){if("{:"===t){if(i)throw Error("Cannot nest {: in function template");return i=!0,""}if(":}"!==t)return i?(r+=t,""):t;if(!i)throw Error(":} without opening {: in function template");i=!1;var e="g('"+r.replace(/(['"\\])/g,"\\$1")+"')";return r="",e});return Function("g","s",e)},Amm.Util={regexEscape:function(t){return t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},trim:function(t){return t.replace(/^\s+|\s+$/g,"")},getByPath:function(t,e,i){e instanceof Array||(e=Amm.Util.pathToArray(e));for(var r,n=t,s=[].concat(e);s.length;){if(r=s.shift(),!(n&&"object"==typeof n&&r in n))return i;n=n[r]}return s.length?i:n},setByPath:function(t,e,i,r,n){if(t||void 0!==i){e instanceof Array||(e=Amm.Util.pathToArray(e));var s=e.length;if((r=r||{}).changed=!1,!s)return i;"object"==typeof t&&null!==t||(t={},r.changed=!0);for(var o={dummy:t},a=o,h="dummy",l=0;l<s;l++){var u,c=s-1<=l,m=a[h],_=""+e[l],d=parseInt(_);if(!_.length){if(m instanceof Array)d=m.length;else for(var p in d=0,m){!m.hasOwnProperty(p)||d<=(u=parseInt(p))&&(d=u+1)}_=d}0<=d&&""+d==_?(c?m[d]!==i&&(n&&i&&"object"==typeof i&&m[d]&&"object"==typeof m[d]?Amm.override(m[d],i):m[d]=i,r.changed=!0):void 0===m[d]&&(m[d]=[],r.changed=!0),a=m,h=d):(m instanceof Array&&(r.changed=!0,a[h]=Amm.Util.arrayToHash(a[h]),m=a[h]),c?m[_]!==i&&(r.changed=!0,n&&i&&"object"==typeof i&&m[_]&&"object"==typeof m[_]?Amm.override(m[_],i):m[_]=i):(void 0===m[_]&&(m[_]=[],r.changed=!0),a=m,h=_))}return o.dummy}},arrayToHash:function(t){for(var e={},i=t.length,r=0;r<i;r++)void 0!==t[r]&&(e[r]=t[r]);return e},pathToArray:function(t){return t.length?t instanceof Array?t:t.replace(/\]/g,"").split("["):[]},arrayToPath:function(t){if(!t.length)return"";var e=t;return t instanceof Array&&(e=1<t.length?t.join("][")+"]":t[0]),""+e},swapKeysValues:function(t){if(!t||"object"!=typeof t)throw Error("`hash` must be a non-null object");var e={};for(var i in t)t.hasOwnProperty(i)&&(e[t[i]]=i);return e}},Amm.Expression.Token=function(t,e,i,r){this.string=t,this.type=e,this.value=i,this.offset=r},Amm.Expression.Token.Type={WHITESPACE:1,SYMBOL:2,WORD:3,INTEGER:4,FLOAT:5,ILLEGAL:6,SINGLE_QUOTED_STRING:15,DOUBLE_QUOTED_STRING:16,REGEXP:17},Amm.Expression.Token.Keyword={NEW:"new",INSTANCEOF:"instanceof",TYPEOF:"typeof"},Amm.Expression.Token._swappedKeywords=Amm.Util.swapKeysValues(Amm.Expression.Token.Keyword),Amm.Expression.Token.prototype={string:void 0,type:void 0,value:void 0,offset:void 0,toArray:function(){return[this.string,this.type,this.value]},isSymbol:function(t){if(this.type!==Amm.Expression.Token.Type.SYMBOL)return!1;if(!t)return!0;if(t instanceof Array)return 0<=Amm.Array.indexOf(this.string,t);if(1===arguments.length)return this.string===t;var e=Array.prototype.slice.apply(arguments);return 0<=Amm.Array.indexOf(this.string,e)},isIdentifier:function(){return this.type===Amm.Expression.Token.Type.WORD},isConstant:function(){return this.type===Amm.Expression.Token.Type.INTEGER||this.type===Amm.Expression.Token.Type.FLOAT||this.type===Amm.Expression.Token.Type.SINGLE_QUOTED_STRING||this.type===Amm.Expression.Token.Type.DOUBLE_QUOTED_STRING||this.type===Amm.Expression.Token.Type.REGEXP}},Amm.Expression.Parser=function(){},Amm.Expression.Parser.prototype={"Amm.Expression.Parser":"__CLASS__",tokensRx:/^(?:(\s+)|(typeof|instanceof|new|!!|\?\?|\.\.|::|->|&&|\|\||!==|!=|===|==|>=|<=|=>|[-&|+><\{\}$?!.,:\[\]()'"%*/])|([_a-zA-Z][_a-zA-Z0-9]*)|(0[xX]?[0-9]+)|([0-9]+(?:\.[0-9+])?(?:e[+-]?[0-9]+)?)|(.))/,regexTokens:/^(?:(\.)|([[\]()\/])|([^\\\[n\]()\/]+))/,regexFlags:/^[a-zA-Z]+/,stringSingleQuoteRx:/^((?:\\.)|')|[^\\']+/,stringDoubleQuoteRx:/^((?:\\.)|")|[^\\"]+/,unescapes:{'\\"':'"',"\\'":"'","\\n":"\n","\\r":"\r","\\t":"\t","\\v":"\v","\\0":"\0","\\f":"\f","\\\\":"\\"},genFn:null,genObj:null,decorateFn:null,decorateObj:null,src:null,_lastNonWhitespace:null,_tokens:void 0,_oldPos:0,_pos:0,_ignoreWhitespace:!0,_fetches:0,getString:function(t,e){for(var i="",r=""+t,n=e?'"':"'",s=e?this.stringDoubleQuoteRx:this.stringSingleQuoteRx;r;){var o=s.exec(r);if(o||Error("Assertion: cannot match string part (shouldn't happen)"),o[1]===n)break;o[1]?i+=this.unescapes[o[1]]||o[1][1]:i+=o[0],r=r.slice(o[0].length)}return[i,t.length-r.length]},getRegex:function(t){var e,i,r=!1,n=""+t,s="",o="",a="",h=!1;if(n&&"/"!==!n[0]){for(s+=n[0],n=n.slice(1);n&&!h;)(e=this.regexTokens.exec(n))||Error("Assertion - shouldn't happen"),e[2]&&("["!==e[2]||r?"]"===e[2]&&r?r=!1:"/"!==e[2]||r||(h=!0):r=!0),h||(o+=e[0]),s+=e[0],n=n.slice(e[0].length);if(h){h&&(e=this.regexFlags.exec(n))&&(s+=e[0],a=e[0],n=n.slice(e[0]));try{i=new RegExp(o,a)}catch(t){throw{msg:"Cannot parse regex: "+t,origException:t,pos:0}}return new Amm.Expression.Token(s,Amm.Expression.Token.Type.REGEXP,i)}}},getToken:function(t,e){e=e||this._lastNonWhitespace;var i,r,n=this.tokensRx.exec(t);if(n||Error("Assertion: match next token (shouldn't happen)"),n[1])i=Amm.Expression.Token.Type.WHITESPACE;else if(n[2]){if('"'===n[2]||"'"===n[2]){var s=this.getStringConstantToken(t);if(s)return s}else if("/"===n[2]&&(!e||this.regexPossible(e))){var o=this.getRegex(t);if(o)return o}i=Amm.Expression.Token.Type.SYMBOL}else n[3]?i=Amm.Expression.Token.Type.WORD:n[4]?(i=Amm.Expression.Token.Type.INTEGER,r="0"===n[4][0]&&"x"!==n[4][1]&&"X"!==n[4][1]?parseInt(n[4],8):parseInt(n[4])):n[5]?(i=Amm.Expression.Token.Type.FLOAT,r=parseFloat(n[5])):n[6]&&(i=Amm.Expression.Token.Type.ILLEGAL);return new Amm.Expression.Token(n[0],i,r)},regexPossible:function(t){var e=!1;return t.type===Amm.Expression.Token.Type.SYMBOL&&(e=!0),e},getStringConstantToken:function(t,e){var e=t[0],i=t.slice(1);if(("'"===e||'"'===e)&&i.length){var r='"'===e,n=this.getString(i,r),s=!1;if((i=i.slice(n[1]))[0]===e&&(s=!0,i=i.slice(1)),!s)throw{message:"Unmatched "+(r?"double":"single")+" quote",pos:t.length-i.length,string:t};var o=r?Amm.Expression.Token.Type.DOUBLE_QUOTED_STRING:Amm.Expression.Token.Type.SINGLE_QUOTED_STRING;return new Amm.Expression.Token(t.slice(0,t.length-i.length),o,n[0])}},getAllTokens:function(e){var t=0,i=""+e,r=[];for(this._lastNonWhitespace=null;i.length;)try{var n=this.getToken(i);n.offset=t,n.string.length||Error("WTF"),i=i.slice(n.string.length),t+=n.string.length,r.push(n),n.type!==Amm.Expression.Token.Type.WHITESPACE&&(this._lastNonWhitespace=n)}catch(t){throw t.pos?(t.pos+=e.length-i.length,t.string=e):t={message:t,pos:e.length-i.length,string:e},t}return r},begin:function(t){this._tokens=this.getAllTokens(t),this._pos=-1,this._fetches=0},_binaryPriority:[["||"],["&&"],["!==","===","!=","=="],[">","<",">=","<="],["+","-"],["*","/","%"],["instanceof"]],genOp:function(t,e){var i=Array.prototype.slice.apply(arguments),r=this.genFn?this.genFn.apply(this.genObj||this,i):i;if(this.decorateFn){var n=this._oldPos+1,s=this._tokens.slice(n,this._pos+1);if(s.length){var o=s[s.length-1],a=0;if(this._ignoreWhitespace)for(;s[a].type===Amm.Expression.Token.Type.WHITESPACE;)a++;var h=s[a].offset,l=o.offset+o.string.length;this.decorateFn.call(this.decorateObj||this,r,h,l,this.src,s.slice(a))}}return r},parseExpression:function(){return this.parsePart("Conditional")},parseConditional:function(){var t,e,i=this.parsePart("Binary");if(i){var r=this.fetch();if(r&&r.isSymbol("?")){if((t=this.parsePart("Expression"))||Error("Expected: expression"),(r=this.fetch())&&r.isSymbol(":"))return(e=this.parsePart("Expression"))||Error("Expected: expression"),this.genOp("Conditional",i,t,e);Error("Expected: ':'")}else r&&this.unfetch();return i}},parseBinary:function(t){if((t=t||0)>=this._binaryPriority.length)return this.parsePart("Unary");var e,i,r=this.parsePart("Binary",t+1),n=this.fetch();return n?n.isSymbol(this._binaryPriority[t])?(e=n,(i=this.parsePart("Binary",t))||Error("Expected: binary "+this._binaryPriority[t].join(", ")+" operand"),this.genOp("Binary",r,e.string,i)):(this.unfetch(),r):r},parseUnary:function(){var t=this.fetch();if(t){if(t.isSymbol("!","-","!!","typeof")){var e=this.parsePart("Unary");return e||Error("Expected: unary"),this.genOp("Unary",t.string,e)}return this.unfetch(),this.parsePart("New")}},parseList:function(){var t=[],e=this.parsePart("Expression");if(e){for(t.push(e);;){if(!this.fetch().isSymbol(",")){this.unfetch();break}(e=this.parsePart("Expression"))||Error("Expected: expression"),t.push(e)}return this.genOp("List",t)}},parseNew:function(){if(!this.fetch().isSymbol(Amm.Expression.Token.Keyword.NEW))return this.unfetch(),this.parsePart("Item");var t=this.parseNew();if(!(t=t||this.parsePart("Item")))throw Error("Expected: new or value");return this.genOp("New",t)},parseItem:function(){var t=this.parsePart(!0,"Value"),e=this.parsePart(!0,"AccessOperator",t);return e||t},parseAccessOperator:function(t){var e=this.parsePart(!0,"FunctionCall",t)||this.parsePart(!0,"PropertyAccess",t)||this.parsePart(!0,"ComponentElement",t)||this.parsePart(!0,"Range",t);if(e){var i=this.parsePart(!0,"AccessOperator",e);return i?i:e}},parseFunctionCall:function(t){if(e=this.fetch()){if(e.isSymbol("(")){var e,i=this.parsePart("List")||[];(e=this.fetch())&&e.isSymbol(")")||Error("Expected: ')'");var r=this.parsePart("CacheabilityModifier");return this.genOp("FunctionCall",t,i,void 0===r?null:r)}this.unfetch()}},parsePropertyAccess:function(t){var e,i,r,n=!1;if(s=this.fetch()){if(s.isSymbol(".")){var s,o=this._oldPos;this._oldPos=this._pos,(s=this.fetch())&&s.isIdentifier()?e=this.genOp("Constant",s.string):(this._oldPos=o,Error("Expected: identifier")),this._oldPos=o}else{if(this.unfetch(),!(e=this.parsePart("Subexpression")))return;n=!0}return i=this.parsePart("PropertyArgs"),r=this.parsePart("CacheabilityModifier"),this.genOp("PropertyAccess",t,e||null,i||null,n,r||null)}},parseCacheabilityModifier:function(){var t=this.fetch();if(t)return t.isSymbol("!!","??")?this.genOp("CacheabilityModifier",t.string):void this.unfetch()},parseSubexpression:function(){if(t=this.fetch()){if(t.isSymbol("[")){var t,e=this.parsePart("Expression");return e||Error("Expected: expression"),(t=this.fetch())&&t.isSymbol("]")||Error("Expected: ']'"),this.genOp("Subexpression",e)}this.unfetch()}},parsePropertyArgs:function(){var t=this.fetch();if(t){if(t.isSymbol("::")){for(var e,i=!1,r=[];;){if(!(t=this.fetch()))break;if(t.isSymbol("{")){(r=this.parsePart("List"))||Error("Expected: list"),(t=this.fetch())&&t.isSymbol("}")||Error("Expected: '}'"),i=!0;break}if(t.isSymbol("::"))e=this.genOp("Constant",void 0);else if(t.isIdentifier())e=this.genOp("Constant",t.string);else{if(!t.isConstant()){this.unfetch();break}e=this.genOp("Constant",t.value)}r.push(e)}return i||r.length||(r=[void 0]),this.genOp("PropertyArgs",r,i)}this.unfetch()}},parseComponentElement:function(t){if(e=this.fetch()){if(e.isSymbol("->")){var e,i=void 0,r=!1;(e=this.fetch())&&(e.isSymbol("{","[")||e.isIdentifier())||Error("Expected: identifier, subexpression or range"),"{"===e.string&&(r=!0),e.isIdentifier()||this.unfetch(),!r&&e.isIdentifier()?i=this.genOp("Constant",e.string):r||(i=this.parsePart("Subexpression"))||Error("Expected: subexpression");var n=this.genOp("ComponentElement",t,i,null);return this.parsePart("Range",n)||n}this.unfetch()}},parseLoopIdentifiers:function(){var t,e=this.parsePart("Variable",!0);if(e){var i=this.fetch();if(i)return i.isSymbol("=>")?(t=e,(i=this.fetch()).isSymbol(":")?e=null:(this.unfetch(),(e=this.parsePart("Variable",!0))||Error("Expected: variable"),(i=this.fetch())&&i.isSymbol(":")||Error("Expected: ':'")),this.genOp("LoopIdentifiers",e,t)):i.isSymbol(":")?this.genOp("LoopIdentifiers",e,null):(this.unfetch(),void(e&&(this.unfetch(),this.unfetch())))}},parseRange:function(t){if(e=this.fetch()){if(e.isSymbol("{")){var e,i,r,n=null,s=null;return(e=this.fetch()).isSymbol("*")?i="All":e.isConstant()&&e.type===Amm.Expression.Token.Type.INTEGER?(i="Index",n=this.genOp("Constant",e.value)):e.isConstant()&&e.type===Amm.Expression.Token.Type.REGEXP?(i="RegExp",n=this.genOp("Constant",e.value)):e.isSymbol("..")?(i="Slice",n=null,(e=this.fetch()).isSymbol("}")?(s=null,this.unfetch()):(this.unfetch(),s=this.parsePart("Expression"))):(this.unfetch(),r=this.parsePart("LoopIdentifiers"),(n=this.parsePart("Expression"))||Error("Expected: expression"),r?(i="Condition",s=r):(e=this.fetch()).isSymbol("..")?(i="Slice",s=this.parsePart("Expression")):(this.unfetch(),i="Index")),(e=this.fetch())&&e.isSymbol("}")||Error("Expected: '}'"),this.genOp("Range",i,t,n,s)}this.unfetch()}},parseVariable:function(t){var e=this.fetch();if(e)if(e.isSymbol("$")){if((e=this.fetch())&&e.isIdentifier())return t?this.genOp("Constant",e.string):this.genOp("Variable",e.string);Error("Expected: identifier")}else this.unfetch()},parseValue:function(){var t=this.parsePart("Variable");if(t)return t;var e=this.fetch();if(e.isSymbol("(")){var i=this.parsePart("Expression");return i||Error("Expected: expression"),(e=this.fetch())&&e.isSymbol(")")||Error("Expected: ')'"),this.genOp("Parenthesis",i)}if(e.isConstant())return this.genOp("Constant",e.value);if(e.isIdentifier()){var r=e.string.toLowerCase();return"true"===r?this.genOp("Constant",!0):"false"===r?this.genOp("Constant",!1):"null"===r?this.genOp("Constant",null):"undefined"===r?this.genOp("Constant",void 0):this.genOp("Identifier",e.string)}this.unfetch()},unfetch:function(){return this.fetch(!1,!0)},fetch:function(t,e){if(1e4<this._fetches++&&Error("Guard: too much fetches (TODO: remove)"),!this._tokens)return null;for(var i=null,r=e?-1:1,n=this._pos;((i=this._tokens[n+r]||null)||e)&&(n+=r),i&&this._ignoreWhitespace&&i.type===Amm.Expression.Token.Type.WHITESPACE;);return!i&&!e||t||(this._pos=n),i},parsePart:function(t,e){var i,r=Array.prototype.slice.call(arguments,1),n=!1;!0===t&&(n=!0,t=r.shift()),t||Error("`part` is required to be non-empty string");var s="parse"+t;"function"!=typeof this[s]&&Error("Amm.Expression.Parser: no such method: '"+s+"'"),"Part"===t&&Error("WTF");var o=this._oldPos;return n||(this._oldPos=this._pos),i=r.length?1===r.length?this[s](r[0]):this[s].apply(this,r):this[s](),n||(this._oldPos=o),i},parse:function(t){var e;return this.src=t,this._oldPos=0,this.begin(t),e=this.parsePart("Expression"),this.fetch()&&Error("Expected: eof"),e}},Amm.Expression.Builder=function(){},Amm.Expression.Builder.prototype={build:function(t,e){var i=Array.prototype.slice.call(arguments,1),r=t;if(!this[r])throw Error("Uknown/unsupported lexeme: "+r);return this[r].apply(this,i)},decorate:function(t,e,i,r,n){t&&t["Amm.Operator"]&&(t.beginPos=e,t.endPos=i)},configureParser:function(t){t.genFn=this.build,t.genObj=this,t.decorateFn=this.decorate,t.decorateObj=this},const:function(t){return t&&t.Const?t:{Const:!0,const:t}},unConst:function(t,e){if(t&&t.Const)return t.const;if(e&&t instanceof Array){for(var i=[],r=0,n=t.length;r<n;r++)i.push(this.unConst(t[r]));return i}return t},Identifier:function(t){return"this"===t?new Amm.Operator.ExpressionThis:"root"===t?new Amm.getRoot:new Amm.Operator.ScopeElement(new Amm.Operator.ExpressionThis,this.unConst(t))},Conditional:function(t,e,i){return new Amm.Operator.Conditional(this.unConst(t),this.unConst(e),this.unConst(i))},binaryFn:function(t,e,i){switch(e){case"!==":return t!==i;case"===":case"==":return t===i;case"!=":return t!=i;case"+":return t+i;case"-":return t-i;case"*":return t*i;case"/":return t/i;case"%":return t%i;case">":return i<t;case"<":return t<i;case"<=":return t<=i;case">=":return i<=t}throw Error("Unknown operator: "+e)},Binary:function(t,e,i){return t&&t.Const&&i&&i.Const?this.const(this.binaryFn(this.unConst(t),e,this.unConst(i))):new Amm.Operator.Binary(this.unConst(t),this.unConst(e),this.unConst(i))},Unary:function(t,e){if(e.Const){if("!"===t)return this.const(!this.unConst(e));if("-"===t)return this.const(-this.unConst(e));if("!!"===t)return this.const(!!this.unConst(e));if("typeof"===t)return typeof this.unConst(e);throw Error("Unknown unary operator: '"+t+"'")}return new Amm.Operator.Unary(t,this.unConst(e))},List:function(t){return new Amm.Operator.List(this.unConst(t,!0))},Constant:function(t){return this.const(t)},FunctionCall:function(t,e,i){return t&&t["Amm.Operator.Property"]&&!t.hasArguments()?(t.promoteToCall(e,i),t):new Amm.Operator.FunctionCall(this.unConst(t),e,i)},New:function(t){return t&&t["Amm.Operator.Property"]&&!t._parenthesis&&t.getIsCall()?(t.promoteToNew(),t):t&&t["Amm.Operator.FunctionCall"]&&!t._parenthesis?(t._isNew=!0,t):new Amm.Operator.FunctionCall(this.unConst(t),null,!0,!0)},PropertyAccess:function(t,e,i,r,n){return new Amm.Operator.Property(this.unConst(t),this.unConst(e),this.unConst(i),n)},CacheabilityModifier:function(t){return"!!"===t},Subexpression:function(t){return t},Parenthesis:function(t){return t["Amm.Operator"]&&(t._parenthesis=!0),t},Variable:function(t){return new Amm.Operator.Var(t)},PropertyArgs:function(t,e){return this.unConst(t,!0)},ComponentElement:function(t,e,i){return new Amm.Operator.ComponentElement(this.unConst(t),this.unConst(e),this.unConst(i),!1,void 0===e)},LoopIdentifiers:function(t,e){return{keyVar:e,valueVar:t}},Range:function(t,e,i,r){var n,s=e&&(e["Amm.Operator.ComponentElement"]||e["Amm.Operator.ScopeElement"]);return"All"===t?n=s?(e._setOperand("range","*"),e):new Amm.Operator.Range.All(this.unConst(e)):"Index"===t?n=s?(e._setOperand("range",this.unConst(i)),e):new Amm.Operator.Range.Index(this.unConst(e),this.unConst(i)):"RegExp"===t?n=new Amm.Operator.Range.RegExp(this.unConst(e),this.unConst(i)):"Slice"===t?n=new Amm.Operator.Range.Slice(this.unConst(e),this.unConst(i),this.unConst(r)):"Condition"===t?n=new Amm.Operator.Range.Condition(this.unConst(e),this.unConst(i),this.unConst(r.keyVar),this.unConst(r.valueVar)):Error("Uknown range type: '"+t+"'"),s&&(e._rangeOperator||null!==e._rangeValue||e._setOperand("range","*")),n}},Amm.Remote.Mapper=function(t){this.patterns=[]},Amm.Remote.Mapper.prototype={setPatterns:function(t){}},Amm.Remote.Uri=function(t){null==t&&(t=""),"string"==typeof t?t={uri:t}:t&&t["Amm.Remote.Uri"]?(this._clone(t),t=void 0):t&&"function"==typeof[t.toString]?t={uri:t.toString()}:t.uri&&(t=Amm.override({},t),this.setUri(t.uri),delete t.uri),Amm.WithEvents.call(this,t)},Amm.Remote.Uri.PART_SCHEME="SCHEME",Amm.Remote.Uri.PART_USER="USER",Amm.Remote.Uri.PART_PASSWORD="PASSWORD",Amm.Remote.Uri.PART_HOST="HOST",Amm.Remote.Uri.PART_PORT="PORT",Amm.Remote.Uri.PART_PATH="PATH",Amm.Remote.Uri.PART_QUERY="QUERY",Amm.Remote.Uri.PART_FRAGMENT="FRAGMENT",Amm.Remote.Uri._current=null,Amm.Remote.Uri.getCurrent=function(){return Amm.Remote.Uri._current?new Amm.Remote.Uri(Amm.Remote.Uri._current):window.location&&window.location.href?new Amm.Remote.Uri(window.location.href):void 0},Amm.Remote.Uri.setCurrent=function(t){Amm.Remote.Uri._current=t?new Amm.Remote.Uri(""+t):null},Amm.Remote.Uri._const={SCHEME:"_scheme",USER:"_user",PASSWORD:"_pass",HOST:"_host",PORT:"_port",PATH:"_path",QUERY:"_query",FRAGMENT:"_fragment"},Amm.Remote.Uri.prototype={"Amm.Remote.Uri":"__CLASS__",RequestProvider:"__INTERFACE__",_scheme:null,_user:null,_pass:null,_host:null,_port:null,_path:null,_query:null,_fragment:null,_uri:null,_updateLevel:0,_oldUri:null,_strQuery:null,setUri:function(t,e){if(null!=e&&""!==e){if(Amm.Remote.Uri._const[e])return this.beginUpdate(),"QUERY"===e&&"object"!=typeof t?(this._strQuery=t||"",this._query=this._parseQuery(t)):this[Amm.Remote.Uri._const[e]]=""+t,void this.endUpdate();this.beginUpdate();var i={};this._query=Amm.Util.setByPath(this._query,Amm.Util.pathToArray(e),t,i),i.changed&&(this._strQuery=null),this.endUpdate()}else t&&t["Amm.Remote.Uri"]?this._clone(t):this._parse(t)},getUri:function(t,e){return t?e&&t===Amm.Remote.Uri.PART_QUERY?(null===this._strQuery&&(this._strQuery=this._buildQuery(this._query,"",!0)),this._strQuery):Amm.Remote.Uri._const[t]?this[Amm.Remote.Uri._const[t]]:Amm.Util.getByPath(this._query,Amm.Util.pathToArray(t)):null!==this._uri?this._uri:this._build()},setUriOverrides:function(t){if(t){if("object"!=typeof t)throw Error("uriOverrides must be an object");var e=t?Amm.override({},t):{};for(var i in this.beginUpdate(),e)e.hasOwnProperty(i)&&Amm.Remote.Uri._const[i]&&(this.setUri(e[i],i),delete e[i]);this._query||(this._query={}),Amm.overrideRecursive(this._query,e),this.endUpdate()}},_clone:function(t){for(var e in this._subscribers&&this.beginUpdate(),Amm.Remote.Uri._const)Amm.Remote.Uri._const.hasOwnProperty(e)&&(this[Amm.Remote.Uri._const[e]]=t[Amm.Remote.Uri._const[e]]),this._strQuery=t._strQuery,this._uri=null;this._subscribers&&this.endUpdate()},outRequestChangeNotify:function(){return this._out("requestChangeNotify",this)},outUriChange:function(t,e){return this._out("uriChange",t,e)},produceRequest:function(){return new Amm.Remote.ConstRequest({uri:this.getUri(),method:Amm.Remote.ConstRequest.METHOD_GET})},beginUpdate:function(){this._updateLevel||(this._oldUri=this.getUri()),this._updateLevel++},endUpdate:function(){if(!this._updateLevel)throw Error("call to endUpdate() without prior beginUpdate()");var t,e;this._updateLevel--,this._updateLevel||(t=this._build(),e=this._oldUri,this._oldUri=null,t!==e&&(this.outUriChange(t,e),this.outRequestChangeNotify()))},_isSimpleNumArray:function(t,e){if(!(t instanceof Array))return!1;for(var i="",r=0,n=t.length;r<n;r++){if(!(r in t)||void 0===t[r]||"object"==typeof t[r])return!1;i+="&"+e+"[]="+encodeURIComponent(t[r])}return i},_buildQuery:function(t,e,i){var r,n,s="";if(void 0===t)return"";if(!1!==(n=this._isSimpleNumArray(t,e)))s=n;else if(t instanceof Array)if(t.length)for(r=0;r<t.length;r++)s+=this._buildQuery(t[r],e?e+"["+r+"]":r);else s="&"+e+"=";else if("object"==typeof t)for(r in t)t.hasOwnProperty(r)&&(s+=this._buildQuery(t[r],e?e+"["+r+"]":r));else s="&"+e+"="+encodeURIComponent(t);return i&&s.length&&(s=s.slice(1)),s},_parseQuery:function(t,e,i){if(null==t)return null;if(!t.length)return{};void 0===e&&(e="&"),void 0===i&&(i="=");for(var r=t.split(e),n=r.length,s=[],o=0;o<n;o++){var a=r[o].split(i,2),h=(h=a[0].replace("]","")).replace(/\]/g,"").split("[");a.length<2&&a.push(""),s=Amm.Util.setByPath(s,h,a[1])}return s},toString:function(){return this.getUri()},_parse:function(t){"m"===(t=""+t)[0]&&":"===t[6]&&(t=t.replace(/^mailto:/,"mailto://")),this.beginUpdate();for(var e=[".source","_scheme",".authority",".userInfo","_user","_pass","_host","_port",".relative","_path",".directory",".file","_strQuery","_fragment"],i={},r=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?(((\/?(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/.exec(t),n=e.length-1;0<=n;n--){var s=e[n];"."!==s[0]&&(void 0===r[n]?this[s]=null:this[s]=r[n]),i[s]=r[n]}this._query=this._parseQuery(this._strQuery),this.endUpdate()},_build:function(t){void 0===t&&(t=!0);var e,i="";return this._scheme&&(i+=this._scheme+":"),this._host&&("mailto"!==this._scheme&&(i+="//"),(this._user||this._pass)&&(i+=this._user,this._pass&&(i+=":"+this._pass),i+="@"),i+=this._host,i+=this._port?":"+this._port:""),this._path&&(i&&"/"!==this._path[0]&&(i+="/"),i+=this._path),t&&this._query&&(null!==this._strQuery?e=this._strQuery:(e=this._buildQuery(this._query,"",!0),this._strQuery=e),i+="?"+e),null!==this._fragment&&(i+="#"+this._fragment),t&&(this._uri=i),i},isFullyQualified:function(){return this._scheme&&this._host},isRelative:function(){return this._path&&"/"!==this._path[0]},resolve:function(t){var e,i,r,n,s;if(this.isFullyQualified())return new Amm.Remote.Uri(this);if(e=(t=t||Amm.Remote.Uri.getCurrent())["Amm.Remote.Uri"]?t:new Amm.Remote.Uri(t),""===this.getUri())return(i=new Amm.Remote.Uri(e))._fragment="",i;if("#"===this.getUri().charAt(0))return(i=new Amm.Remote.Uri(e)).setUri(this._fragment,Amm.Remote.Uri.PART_FRAGMENT),i;if((i=new Amm.Remote.Uri(this))._scheme||(i._scheme=e._scheme),i._host||(i._host=e._host),i._path&&"/"===i._path.charAt(0))return i;if(r=e._path,!i._path)return i._path=r,i;if(!(r=r.replace(/\/[^/]*$/,"").replace(/\/{2,}/,"/")+"/"+i._path.replace(/^\//,"")).match(/(^|\/)\.\.?(\/|)/))return i._path=r,i;for(r=r.split("/"),s=0;s<r.length;)"."!==(n=r[s])&&""!==n?".."===n?1<s?(r.splice(s-1,2),s--):r.splice(s,1):s++:r.splice(s,1);return r="/"+r.join("/"),i._path=r,i}},Amm.extend(Amm.Remote.Uri,Amm.WithEvents),Amm.Remote.RequestProducer=function(t){this._data={},Amm.Remote.Uri.call(this,t)},Amm.Remote.RequestProducer._allowedMethods={GET:"Amm.Remote.ConstRequest.METHOD_GET",POST:"Amm.Remote.ConstRequest.METHOD_POST",PUT:"Amm.Remote.ConstRequest.METHOD_PUT",DELETE:"Amm.Remote.ConstRequest.METHOD_DELETE",PATCH:"Amm.Remote.ConstRequest.METHOD_PATCH",HEAD:"Amm.Remote.ConstRequest.METHOD_HEAD",CONNECT:"Amm.Remote.ConstRequest.METHOD_CONNECT",OPTIONS:"Amm.Remote.ConstRequest.METHOD_OPTIONS"},Amm.Remote.RequestProducer.prototype={"Amm.Remote.RequestProducer":"__CLASS__",_method:"GET",_data:null,setMethod:function(t){if(!((t=(""+t).toUpperCase())in Amm.Remote.RequestProducer._allowedMethods))throw Error("Invalid 'method' value '"+t+"'; allowed values are "+Amm.keys(Amm.Remote.RequestProducer._allowedMethods).join("|"));var e=this._method;if(e!==t)return this._method=t,this.outMethodChange(t,e),this.outRequestChangeNotify(),!0},getMethod:function(){return this._method},outMethodChange:function(t,e){this._out("methodChange",t,e)},produceRequest:function(){var t={uri:this.getUri(),method:this._method};return this._data&&(t.data=this._data),new Amm.Remote.ConstRequest(t)},setData:function(t,e){if(void 0===e){if(void 0!==t&&!1!==t||(t=null),t===this._data)return;if(n=this._data?Amm.override({},this._data):this._data,JSON.stringify(n)===JSON.stringify(t))return;this._data=t}else{if(null==t&&null===this._data)return;var i=Amm.Util.pathToArray(e),r={},n=this._data?Amm.override({},this._data):this._data;this._data||(this._data={}),Amm.Util.setByPath(this._data,i,t,r);var s=!1;for(var o in this._data)this._data.hasOwnProperty(o)&&(s=!0);if(s||(this._data=null),this._data===n)return;if(!r.changed)return}return this.outDataChange(t,n),this.outRequestChangeNotify(),!0},getData:function(t){if(void 0===t)return this._data;if(this._data){var e=Amm.Util.pathToArray(t);return this._getByPath(this._data,e)}},setDataOverrides:function(t){if(t){if("object"!=typeof t)throw Error("dataOverrides must be an object");var e=Amm.overrideRecursive({},this._data);Amm.overrideRecursive(e,t),this.setData(e)}},outDataChange:function(t,e){return this._out("dataChange",t,e)}},Amm.extend(Amm.Remote.RequestProducer,Amm.Remote.Uri),Amm.Remote.Transport=function(t){Amm.init(this,t)},Amm.Remote.Transport._default=null,Amm.Remote.Transport.getDefault=function(){return this._default||(this._default=new Amm.Remote.Transport.JqXhr),this._default},Amm.Remote.Transport.setDefault=function(t){t?Amm.is(t,"Amm.Remote.Transport","defaultTransport"):t=null,this._default=t},Amm.Remote.Transport.prototype={"Amm.Remote.Transport":"__CLASS__",_history:null,_historySize:null,setHistorySize:function(t){if(this._historySize!==t)return this._historySize=t,this._historySize?(this._history?this._history.length>this._historySize&&this._history.splice(this._historySize,this._history.length-this._historySize):this._history=[],!0):!(this._history=null)},getHistorySize:function(){return this._historySize},getHistory:function(){this._history&&[].concat(this._history)},_push:function(t){this._history.unshift(t),this._history.length>this._historySize&&this._history.pop()},makeRequest:function(t,e,i,r){var n=new Amm.Remote.RunningRequest(t,e,i,r,this);return this._doPrepareRunningRequest(n,t,e,i,r),this._historySize&&this._push(n),n},abortRunningRequest:function(t){this._doAbortRunningRequest(t)},_doPrepareRunningRequest:function(t,e,i,r,n){}},Amm.Remote.Transport.JqXhr=function(t){Amm.Remote.Transport.call(this,t)},Amm.Remote.Transport.JqXhr.prototype={"Amm.Remote.Transport.JqXhr":"__CLASS__",_doPrepareRunningRequest:function(t,e,i,r,n){var s=e.getJqXhrOptions();s.context=t;var o=jQuery.ajax(e.getUri(),s).done(t.success).fail(this._failure);t.setExtra(o)},_failure:function(t,e,i){this.failure(e,i,this.getExtra().status,t)},_doAbortRunningRequest:function(t){t.getExtra().abort()}},Amm.extend(Amm.Remote.Transport.JqXhr,Amm.Remote.Transport),Amm.Remote.Transport.JqXhr.parseResponseHeaders=function(t){for(var e,i,r,n=t.split(/[\n\r]+/),s={},o=0;o<n.length;o++){n[o]=n[o].replace(/(^\s+)|(\s+$)/g,""),n[o].length&&(r=(i=n[o].match(/^([^:]+)\s*:\s*(.*)$/))?(e=i[1].toLowerCase().replace(/(^\s+)|(\s+$)/g,""),i[2]):(e="",n[o]),s[e]?("Array"!=typeof s[e]&&(s[e]=[s[e]]),s[e].push(r)):s[e]=r)}return s},Amm.Remote.Transport.Debug=function(t){Amm.Remote.Transport.call(this,{}),Amm.WithEvents.call(this,t);var r=this;this._successClosure=function(t,e){return r.success.apply(r,Array.prototype.slice.call(arguments))},this._failureClosure=function(t,e,i){return r.failure.apply(r,Array.prototype.slice.call(arguments))}},Amm.Remote.Transport.Debug.prototype={"Amm.Remote.Transport.Debug":"__CLASS__",eventTime:0,replyTime:10,_pendingSuccess:null,_pendingFailure:null,_request:null,_successClosure:null,_failureClosure:null,reply:function(t,e,i,r){var n,s;this._pendingSuccess=null,this._pendingFailure=null,t.getAborted()||(null==i&&(i=this.replyTime),n=Array.prototype.slice.call(arguments,3),s=function(){(e?t.success:t.failure).apply(t,n)},0<i?t._timeout=window.setTimeout(s,this.replyTime):s(),this._request=null)},success:function(t,e,i){if(!this._request)return this._pendingSuccess=Array.prototype.slice.call(arguments),void(this._pendingFailure=null);"function"==typeof t&&(t=t(this._request));var r=Array.prototype.slice.call(arguments);r.splice(2,1),r.unshift(this._request,!0,i),this.reply.apply(this,r)},failure:function(t,e,i,r){if(!this._request)return this._pendingFailure=Array.prototype.slice.call(arguments),void(this._pendingSuccess=null);var n=Array.prototype.slice.call(arguments);n.splice(3,1),n.unshift(this._request,!1,r),this.reply.apply(this,n)},outRequest:function(t,e,i){this._request=t;var r=this._out("request",t,e,i);return this._pendingSuccess?this.success.apply(this,this._pendingSuccess):this._pendingFailure&&this.failure.apply(this,this._pendingFailure),r},getRequest:function(){return this._request},outAbortRequest:function(t){return this._out("abortRequest",t)},_doPrepareRunningRequest:function(t,e,i,r,n){function s(){o.outRequest(t,o._successClosure,o._failureClosure)}var o=this;this.eventTime<=0?s():t._timeout=window.setTimeout(s,this.eventTime)},_doAbortRunningRequest:function(t){t._timeout&&(window.clearTimeout(t._timeout,null),t._timeout=null),this.outAbortRequest(t)}},Amm.extend(Amm.Remote.Transport.Debug,Amm.Remote.Transport),Amm.extend(Amm.Remote.Transport.Debug,Amm.WithEvents),Amm.Remote.MapperPattern=function(t){if("string"!=typeof t||!t.length)throw Error("`definition` must be non-empty string");this._parseDefinition(t)},Amm.Remote.MapperPattern._parseRx=/([^{}]+)|(\{\w+(\.\.\.)?)|[{}]/g,Amm.Remote.MapperPattern.prototype={definition:null,regex:null,args:null,segments:null,_parseDefinition:function(t){var e=(this._definition=t).match(Amm.Remote.MapperPattern._parseRx);if(e.join("")!==t)throw console.log(e,t),Error("MapperPattern definition wasn't fully matched");var i,r,n,s=0;for(this.regex="",this.args=[],this.segments=[];void 0!==(curr=e.shift());){if(n=curr.length,"{"===curr[0]){if(i)throw Error("Error at position "+s+" of definition '"+t+"': arguments must be always separated by non-argument string");if("}"!==e[0])throw Error("Unmatched '{' at position "+s+"of definition '"+t+"'");e.shift(),n++,"..."===(i=curr.slice(1)).slice(-3)&&(r=!0,i=i.slice(1,-3)),this.args.push(i),this.regex+=r?"(.+)":"([-\\w]+)",this.segments.push([i])}else i=null,this.regex+=Amm.Util.regexEscape(curr),this.segments.push(curr);s+=n}this.regex="^"+this.regex+"$"},parse:function(t,e){e=e||{},"string"==typeof this.regex&&(this.regex=new RegExp(this.regex));var i=this.regex.exec(t);if(!i)return!1;for(var r=0,n=this.args.length;r<n;r++)e[this.args[r]]=i[r+1];return!0},build:function(t,e){for(var i=0,r=this.args.length;i<r;i++){var n=t[this.args[i]];if(null==n||""===n||""+n=="")return}var s="";for(i=0,r=this.segments.length;i<r;i++)this.segments[i]instanceof Array?(s+=""+t[this.segments[i][0]],e&&delete t[this.segments[i][0]]):s+=this.segments[i];return s}},Amm.Remote.Fetcher=function(t){Amm.WithEvents.call(this,t)},Amm.Remote.Fetcher.STATE_CONFIGURING="configuring",Amm.Remote.Fetcher.STATE_IDLE="idle",Amm.Remote.Fetcher.STATE_PREINIT="preinit",Amm.Remote.Fetcher.STATE_STARTED="started",Amm.Remote.Fetcher.STATE_SENT="sent",Amm.Remote.Fetcher.STATE_RECEIVED="received",Amm.Remote.Fetcher.STATE_ERROR="error",Amm.Remote.Fetcher.AUTO_NONE=0,Amm.Remote.Fetcher.AUTO_BOOTSTRAP=1,Amm.Remote.Fetcher.AUTO_ALWAYS=2,Amm.Remote.Fetcher.prototype={"Amm.Remote.Fetcher":"__CLASS__",_requestProducer:null,_requestProducerIsOwn:!1,_response:void 0,_state:Amm.Remote.Fetcher.STATE_CONFIGURING,_error:null,_auto:Amm.Remote.Fetcher.AUTO_NONE,_firstDelay:10,_throttleDelay:500,_timeout:null,_waitingForBootstrap:!1,_constRequest:null,_runningRequest:null,_starting:0,_gotResultOnStart:!1,_prevRequest:null,_timeoutCallback:null,_transport:null,_poll:!1,_detectChanges:!0,_lastResponseJson:void 0,_lastErrorJson:void 0,run:function(){this._doRequest()},setRequestProducer:function(t){var e=this._requestProducer;if(e!==t)return e&&(e.unsubscribe("requestChangeNotify",this._requestChangeNotify,this),this._requestProducerIsOwn&&e.cleanup()),"string"==typeof t&&(t=new Amm.Remote.RequestProducer(t)),t?"object"!=typeof t||Amm.getClass(t)?Amm.meetsRequirements(t,"RequestProvider","request"):(t=Amm.constructInstance(t,"Amm.Remote.RequestProducer",void 0,!1,"RequestProvider"),this._requestProducerIsOwn=!0):t=null,(this._requestProducer=t)&&t.subscribe("requestChangeNotify",this._requestChangeNotify,this),this.setConstRequest(t.produceRequest()),this.outRequestProducerChange(t,e),this._updateState(),!0},getRequestProducer:function(){return this._requestProducer},outRequestProducerChange:function(t,e){this._out("requestProducerChange",t,e)},_requestChangeNotify:function(){var t=this._requestProducer.produceRequest();this.setConstRequest(t)},setConstRequest:function(t){t=t||null;var e=this._constRequest;if(e!==t)return this._constRequest=t,this.outConstRequestChange(t,e),this._scheduleAutoRequest(),this._updateState(),!0},getConstRequest:function(){return this._constRequest},outConstRequestChange:function(t,e){return this._out("constRequestChange",t,e)},setTransport:function(t){t?"object"==typeof t&&Amm.getClass(t)?Amm.is(t,"Amm.Remote.Transport","transport"):t=Amm.constructInstance(t,"Amm.Remote.Transport"):t=null;var e=this._transport;if(e!==t)return this._transport=t,this.outTransportChange(t,e),!0},outTransportChange:function(t,e){return this._out("transportChange",t,e)},getTransport:function(){return this._transport},_doGetTransport:function(){return this._transport||Amm.Remote.Transport.getDefault()},_runOnBootstrap:function(){this._waitingForBootstrap&&(this._scheduleAutoRequest(),this._updateState())},_scheduleAutoRequest:function(t){if(this._auto){if(this._auto===Amm.Remote.Fetcher.AUTO_BOOTSTRAP&&!Amm.getBootstrapped())return Amm.getRoot().subscribe("bootstrap",this._runOnBootstrap,this),void(this._waitingForBootstrap=!0);var e,i;this._constRequest&&(e=this._runningRequest||t?this._throttleDelay:this._firstDelay,(i=this)._timeout&&window.clearTimeout(this._timeout),this._runningRequest&&this._abort(),0<e?(this._timeoutCallback||(this._timeoutCallback=function(){i._doRequest()}),this._timeout=window.setTimeout(this._timeoutCallback,e)):(this._timeout=null,this._doRequest()))}},_abort:function(){this._runningRequest&&(this._prevRequest=this._runningRequest,this._runningRequest=null,this._prevRequest.abort())},_doRequest:function(){if(!this._constRequest)throw Error("Cannot _doRequest() without _constRequest");this._waitingForBootstrap=!1,this._runningRequest&&this._abort(),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null),this._starting++,this._runningRequest=this._doGetTransport().makeRequest(this._constRequest,this._requestDone,this._requestFail,this),this._starting--,this.setError(null),this._gotResultOnStart&&(this._prevRequest=this._runningRequest,this._runningRequest=null),this._updateState()},_requestDone:function(t,e){(this._runningRequest||this._starting)&&(this._runningRequest&&(this._prevRequest=this._runningRequest,this._runningRequest=null),this.setResponse(t))},_requestFail:function(t,e,i){(this._runningRequest||this._starting)&&(this._runningRequest&&(this._prevRequest=this._runningRequest,this._runningRequest=null),this.setError({textStatus:t,errorThrown:e,httpCode:i}))},_setState:function(t){var e=this._state;if(e!==t)return this._state=t,this.outStateChange(t,e),!0},getState:function(){return this._state},outStateChange:function(t,e){this._out("stateChange",t,e)},isDataChanged:function(t,e){var i="_last"+e.charAt(0).toUpperCase()+e.slice(1)+"Json",r=JSON.stringify(t);return this[i]!==r&&(this[i]=r,!0)},setResponse:function(t){var e=this._response;if(e!==t){this._runningRequest&&this._abort(),this._starting&&(this._gotResultOnStart=!0);var i=!this._detectChanges||this.isDataChanged(t,"response");return i&&(this._response=t),this._updateState(),i?(this.outResponseChange(t,e),!0):void 0}},getResponse:function(){return this._response},outResponseChange:function(t,e){this._out("responseChange",t,e)},setError:function(t){var e=this._error;if(e!==t&&(!this._detectChanges||this.isDataChanged(t,"error")))return t&&(this._runningRequest&&this._abort(),this.setResponse(void 0)),this._error=t,this._starting&&(this._gotResultOnStart=!0),this._updateState(),this.outErrorChange(t,e),!0},getError:function(){return this._error},outErrorChange:function(t,e){this._out("errorChange",t,e)},setThrottleDelay:function(t){var e=this._throttleDelay;if(e!==t)return this._throttleDelay=t,this.outThrottleDelayChange(t,e),!0},getThrottleDelay:function(){return this._throttleDelay},outThrottleDelayChange:function(t,e){this._out("throttleDelayChange",t,e)},setFirstDelay:function(t){var e=this._firstDelay;if(e!==t)return this._firstDelay=t,this.outFirstDelayChange(t,e),!0},getFirstDelay:function(){return this._firstDelay},outFirstDelayChange:function(t,e){this._out("firstDelayChange",t,e)},setAuto:function(t){var e=this._auto;if(e!==t)return this._auto=t,this.outAutoChange(t,e),t&&this._constRequest&&this._scheduleAutoRequest(),!0},getAuto:function(){return this._auto},outAutoChange:function(t,e){this._out("autoChange",t,e)},cleanup:function(){this.reset(),this._requestProducer&&this._requestProducerIsOwn&&this._requestProducer.cleanup&&(this._requestProducer.cleanup(),this._requestProducer=null),Amm.WithEvents.prototype.cleanup.call(this)},reset:function(){this._poll&&this.setPoll(!1),this._runningRequest&&this._abort(),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null),this.setResponse(void 0),this._updateState()},_updateState:function(){var t=this._runningRequest?Amm.Remote.Fetcher.STATE_SENT:this._timeout?Amm.Remote.Fetcher.STATE_STARTED:this._error?Amm.Remote.Fetcher.STATE_ERROR:void 0!==this._response?Amm.Remote.Fetcher.STATE_RECEIVED:this._constRequest?this._waitingForBootstrap?Amm.Remote.Fetcher.STATE_PREINIT:Amm.Remote.Fetcher.STATE_IDLE:Amm.Remote.Fetcher.STATE_CONFIGURING;!this._poll||t!==Amm.Remote.Fetcher.STATE_IDLE&&t!==Amm.Remote.Fetcher.STATE_RECEIVED&&t!==Amm.Remote.Fetcher.STATE_ERROR||this._scheduleAutoRequest(!0),this._setState(t)},setPoll:function(t){t=!!t;var e=this._poll;if(e!==t)return this._poll=t,this.outPollChange(t,e),t&&this._scheduleAutoRequest(),!0},getPoll:function(){return this._poll},outPollChange:function(t,e){this._out("pollChange",t,e)},setDetectChanges:function(t){if(t=!!t,this._detectChanges!==t)return this._detectChanges=t,!0},getDetectChanges:function(){return this._detectChanges}},Amm.extend(Amm.Remote.Fetcher,Amm.WithEvents),Amm.Remote.ConstRequest=function(t){t&&(t.uri&&(this._uri=t.uri),t.method&&(this._method=t.method),t.data&&(this._data=t.data),t.headers&&(this._headers=t.headers),t.misc&&(this._misc=t.misc))},Amm.Remote.ConstRequest.METHOD_GET="GET",Amm.Remote.ConstRequest.METHOD_POST="POST",Amm.Remote.ConstRequest.METHOD_PUT="PUT",Amm.Remote.ConstRequest.METHOD_DELETE="DELETE",Amm.Remote.ConstRequest.METHOD_PATCH="PATCH",Amm.Remote.ConstRequest.METHOD_HEAD="HEAD",Amm.Remote.ConstRequest.METHOD_CONNECT="CONNECT",Amm.Remote.ConstRequest.METHOD_OPTIONS="OPTIONS",Amm.Remote.ConstRequest.prototype={ConstRequest:"__INTERFACE__",_uri:void 0,_method:void 0,_data:null,_headers:void 0,_misc:void 0,getUri:function(){return this._uri},getMethod:function(){return this._method},getData:function(){return this._data},getHeaders:function(){return this._headers},getMisc:function(){return this._misc},getJqXhrOptions:function(){var t={};return this._misc&&"object"==typeof this._misc&&Amm.override(t,this._misc),this._data&&(t.data=this._data),this._headers&&(t.headers=this._headers),this._method&&(t.method=this._method),t},getAll:function(){var t=this.getJqXhrOptions();return this._uri&&(t.uri=this._uri),t}},Amm.Remote.RunningRequest=function(t,e,i,r,n,s){this._constRequest=t,this._success=e,this._failure=i,this._scope=r,this._transport=n,this._extra=s},Amm.Remote.RunningRequest.ERROR_TIMEOUT="timeout",Amm.Remote.RunningRequest.ERROR_SERVER_ERROR="error",Amm.Remote.RunningRequest.ERROR_ABORT="abort",Amm.Remote.RunningRequest.ERROR_PARSER_ERROR="parsererror",Amm.Remote.RunningRequest.prototype={"Amm.Remote.RunningRequest":"__CLASS__",_constRequest:null,_success:null,_failure:null,_scope:null,_transport:null,_extra:void 0,_finished:!1,_result:null,_error:null,getConstRequest:function(){return this._constRequest},getSuccess:function(){return this._success},getFailure:function(){return this._failure},getScope:function(){return this._scope},getTransport:function(){return this._transport},getExtra:function(){return this._extra},setExtra:function(t){if(this._extra!==t){if(void 0!==this._extra)throw Error("Cant setExtra() only once");this._extra=t}},getFinished:function(){return this._finished},success:function(t,e){if(this._result=Array.prototype.slice.call(arguments),this._finished||(this._finished=1),this._success)return this._success.apply(this._scope||window,this._result)},failure:function(t,e,i){if(this._error=Array.prototype.slice.call(arguments),this._finished||(this._finished=-1),this._failure)return this._failure.apply(this._scope||window,this._error)},abort:function(){this._transport.abortRunningRequest(this),this._finished=-3},getRunning:function(){return!this._finished},getAborted:function(){return-3===this._finished}},Amm.Operator.ScopeElement=function(t,e,i,r,n){this._isEvaluating++,Amm.Operator.call(this),this._componentOnly=r,void 0!==t&&this._setOperand("origin",t),void 0!==e&&this._setOperand("id",e),void 0!==i&&this._setOperand("range",i),void 0!==n&&(this._allElements=!!n),this._isEvaluating--},Amm.Operator.ScopeElement.prototype={"Amm.Operator.ScopeElement":"__CLASS__",_componentOnly:!1,_allElements:!1,_originOperator:null,_originValue:null,_originExists:null,_idOperator:null,_idValue:null,_idExists:null,_rangeOperator:null,_rangeValue:null,_rangeExists:null,_component:null,OPERANDS:["origin","id","range"],STATE_SHARED:{_componentOnly:!0},supportsAssign:!1,getReportsContentChanged:function(){return!0},_originEvents:function(t,e){e&&e["Amm.Element"]&&this._unsub(e,"closestComponentChange"),t&&t["Amm.Element"]&&this._sub(t,"closestComponentChange",this._originComponentChange)},_originChange:function(t){t&&t["Amm.Element"]&&this._setComponent(t.getClosestComponent())},_originComponentChange:function(t){this._setComponent(t)},_rangeChange:function(t){this._checkArrayChange="*"===t},_setComponent:function(t){t=t||null;var e,i=this._component;i!==t&&(i&&(this._unsub(i,"acceptedInScope"),this._unsub(i,"rejectedInScope"),this._unsub(i,"renamedInScope"),this._unsub(i,"componentStackChange"),this._componentOnly&&this._unsub(i,"childComponentStatusChangeInScope")),this._component=t,this._component&&(e={acceptedInScope:this._acceptedInScope,rejectedInScope:this._rejectedInScope,renamedInScope:this._renamedInScope,componentStackChange:this._componentStackChange},this._componentOnly&&(e.childComponentStatusChangeInScope=this._childComponentStatusChangeInScope),this._sub(t,e)),this._isEvaluating||this.evaluate())},_acceptedInScope:function(t,e){if(!this._isEvaluating)if(this._allElements)this.evaluate();else if(this._idExists&&this._idValue){for(var i=!1,r=0,n=e.length;r<n;r++)if(e[r].getId()===this._idValue){i=!0;break}i&&this.evaluate()}},_rejectedInScope:function(t,e){return this._acceptedInScope(t,e)},_renamedInScope:function(t,e,i,r){this._isEvaluating||(this._allElements?this.evaluate():this._idExists&&this._idValue&&(i!==this._idValue&&r!==this._idValue||this.evaluate()))},_componentStackChange:function(){this._isEvaluating||this.evaluate()},_childComponentStatusChangeInScope:function(t,e,i){this._isEvaluating||(this._allElements?this.evaluate():this._idExists&&this._idValue&&(e.getId()!==this._idValue&&e.getInternalId()!==this._idValue||this.evaluate()))},setOrigin:function(t){this._setOperand("origin",t)},setId:function(t){this._setOperand("id",t)},_doEvaluate:function(t){var e=this._getOperandValue("range",t),i=this._getOperandValue("id",t),r=this._getOperandValue("origin",t);return Amm.Operator.ScopeElement._eval(r,i,e,this._componentOnly,this._allElements)},toFunction:function(){var n=this._operandFunction("origin"),s=this._operandFunction("id"),o=this._operandFunction("range"),a=this._allElements,h=this._componentOnly;return function(t){var e=o(t),i=s(t),r=n(t);return Amm.Operator.ScopeElement._eval(r,i,e,h,a)}}},Amm.Operator.ScopeElement._eval=function(t,e,i,r,n){var s="*"===i||!e&&n,o=s?[]:void 0;if(!t||!t["Amm.Element"])return o;if(!e&&!n)return o;var a=t.getClosestComponent();if(!a)return o;if(r){if(!e&&n){var h=a.getAllNamedElements(),l=[];for(var u in h)h.hasOwnProperty(u)&&(l=l.concat(h[u]))}else l=a.getAllNamedElements(e,!0);for(var c=[],u=0;u<l.length;u++)l[u].Component&&l[u].getIsComponent()&&c.push(l[u]);return s?c:c[i]}return s?a.getAllNamedElements(e,!0):a.getNamedElement(e,i,!0)},Amm.extend(Amm.Operator.ScopeElement,Amm.Operator),Amm.Operator.ExpressionThis=function(){Amm.Operator.call(this)},Amm.Operator.ExpressionThis.prototype={"Amm.Operator.ExpressionThis":"__CLASS__",setExpression:function(t){Amm.Operator.prototype.setExpression.call(this,t),this._sub(t,"expressionThisChange"),this._defaultHandler()},_initContextState:function(t,e){Amm.Operator.prototype._initContextState.call(this,t,e),e&&this._expression&&(this._sub(this._expression,"expressionThisChange"),this._defaultHandler())},_doEvaluate:function(t){if(this._expression)return this._expression.getExpressionThis();this._hasValue=!1},toFunction:function(){return function(t){return t.expressionThis}}},Amm.extend(Amm.Operator.ExpressionThis,Amm.Operator),Amm.Operator.Conditional=function(t,e,i){this._isEvaluating++,Amm.Operator.call(this),void 0!==t&&this._setOperand("condition",t),void 0!==e&&this._setOperand("trueValue",e),void 0!==i&&this._setOperand("falseValue",i),this._isEvaluating--},Amm.Operator.Conditional.prototype={"Amm.Operator.Condition":"__CLASS__",_conditionOperator:null,_conditionValue:null,_conditionExists:null,_trueValueOperator:null,_trueValueValue:null,_trueValueExists:null,_falseValueOperator:null,_falseValueValue:null,_falseValueExists:null,OPERANDS:["condition","trueValue","falseValue"],supportsAssign:!1,_doEvaluate:function(t){return this._getOperandValue("condition",t)?this._getOperandValue("trueValue",t):this._getOperandValue("falseValue",t)},setCondition:function(t){this._setOperand("condition",t)},setTrueValue:function(t){this._setOperand("trueValue",t)},setFalseValue:function(t){this._setOperand("falseValue",t)},toFunction:function(){var e=this._operandFunction("condition"),i=this._operandFunction("trueValue"),r=this._operandFunction("falseValue");return function(t){return(e(t)?i:r)(t)}}},Amm.extend(Amm.Operator.Conditional,Amm.Operator),Amm.Operator.Unary=function(t,e){this._isEvaluating++,Amm.Operator.call(this),this._setOperator(t),void 0!==e&&this._setOperand("operand",e),this._isEvaluating--},Amm.Operator.Unary.Unary_OPERATORS={"!!":function(t){return!!t},"!":function(t){return!t},"-":function(t){return-t},typeof:function(t){return typeof t}},Amm.Operator.Unary.prototype={"Amm.Operator.Unary":"__CLASS__",_operandOperator:null,_operandValue:null,_operandExists:null,_operator:null,_operatorFn:null,OPERANDS:["operand"],STATE_SHARED:{_operator:!0,_operatorFn:!0},supportsAssign:!1,_setOperator:function(t){var e=Amm.Operator.Unary.Unary_OPERATORS[t];e||Error("Unsupported Unary operator type: '"+t+"'"),this._operator=t,this._operatorFn=e},_doEvaluate:function(t){var e=this._getOperandValue("operand",t);return this._operatorFn(e)},setOperand:function(t){this._setOperand("operand",t)},toFunction:function(){var e=this._operandFunction("operand"),i=this._operatorFn;return function(t){return i(e(t))}}},Amm.extend(Amm.Operator.Unary,Amm.Operator),Amm.Operator.Property=function(t,e,i,r,n,s){this._isEvaluating++,Amm.Operator.call(this),(n||s)&&(this._isCall=!0,this.supportsAssign=!1),null!=r&&(this._cacheability=!!r),this._isNew=!!s,void 0!==t&&this._setOperand("object",t),void 0!==e&&this._setOperand("property",e),void 0!==i&&this._setOperand("arguments",i),this._isEvaluating--},Amm.Operator.Property.prototype={"Amm.Operator.Property":"__CLASS__",_objectOperator:null,_objectValue:null,_objectExists:null,_propertyOperator:null,_propertyValue:null,_propertyExists:null,_argumentsOperator:null,_argumentsValue:null,_argumentsExists:null,_isCall:!1,_isNew:!1,_cacheability:null,_eventName:!1,supportsAssign:!0,OPERANDS:["object","property","arguments"],STATE_SHARED:{_isCall:!0,_cacheability:!0,supportsAssign:!0,_isNew:!0},setObject:function(t){this._setOperand("object",t)},promoteToCall:function(t,e){this._hasValue&&Error("Cannot promoteToCall(): already evaluated"),this._isEvaluating++,this._isCall=!0,this.supportsAssign=!1,(this._argumentsOperator||null!==this._arguments&&void 0!==this._arguments)&&Error("Getter arguments already defined - cannot promote to call"),null!=e&&(this._cacheability=!!e),void 0!==t&&this._setOperand("arguments",t),this._isEvaluating--},getIsCall:function(){return this._isCall},getIsNew:function(){return this._isNew},promoteToNew:function(){this._hasValue&&Error("Cannot promoteToNew(): already evaluated"),this._isCall||Error("Cannot promoteToNew(): not is call"),this._isNew=!0},hasArguments:function(){return this._argumentsOperator||!(null===this._arguments||void 0===this._arguments)},setProperty:function(t){this._setOperand("property",t)},setArguments:function(t){this._setOperand("arguments",t)},_handleObjectCleanup:function(){this._setOperandValue("object",null)},_objectChange:function(t,e){!t||t["Amm.WithEvents"]||this._isCall||null!==this._cacheability||this._setNonCacheable(this._nonCacheable|Amm.Operator.NON_CACHEABLE_VALUE)},_objectEvents:function(t,e){var i;e&&this._unsub(e),t?this._isCall&&!this._isNew||t&&!t["Amm.WithEvents"]?(null===(i=this._cacheability)&&(i=this._isCall),i?this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_CONTENT):this._setNonCacheable(this._nonCacheable|Amm.Operator.NON_CACHEABLE_CONTENT)):(this._subToProp(this._propertyValue),t.outCleanup&&this._sub(t,"cleanup",this._handleObjectCleanup,void 0,!0)):this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_VALUE)},getReportsContentChanged:function(){return this._cacheability},_subToProp:function(t){var e;!t&&0!==t||this._objectValue["Amm.Array"]&&parseInt(t)==t?this._nonCacheable&&this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_VALUE):(e=t+"Change",this._objectValue.hasEvent(e)||(e=null),e?(this._sub(this._objectValue,e,void 0,void 0,!0),this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_VALUE)):this._setNonCacheable(this._nonCacheable|Amm.Operator.NON_CACHEABLE_VALUE),this._eventName=e)},_propertyChange:function(t,e){var i;this._objectValue&&this._objectValue["Amm.WithEvents"]&&("spliceItems"===this._eventName&&parseInt(t)==t||(this._eventName&&this._unsub(this._objectValue,this._eventName),this._isCall?(null===(i=this._cacheability)&&(i=!0),i?this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_VALUE):this._setNonCacheable(this._nonCacheable|Amm.Operator.NON_CACHEABLE_VALUE)):this._subToProp(t)))},_doEvaluate:function(t){var e=this._getOperandValue("property",t);if(e||0===e){e=""+e;var i=this._getOperandValue("object",t);if(i){if(this._isCall&&!this._isNew){if("function"!=typeof i[e])throw Error("cannot call a non-function property");var r=this._getOperandValue("arguments",t);return null==r?i[e]():r instanceof Array?i[e].apply(i,r):i[e](r)}var n="get"+e[0].toUpperCase()+e.slice(1);if(this._isNew){var s="function"!=typeof i[n]?i[e]:i[n]();if(!s)return;return s=Amm.Operator.FunctionCall.getFunction(s),r=this._getOperandValue("arguments",t),Amm.Operator.FunctionCall.newVarArgs(s,r)}return"function"!=typeof i[n]?i[e]:(null==(r=this._getOperandValue("arguments",t))||(r instanceof Array?r.length||(r=null):r=[r]),r?i[n].apply(i,r):i[n]())}}},toFunction:function(){var s=this._operandFunction("property"),o=this._operandFunction("object"),a=this._operandFunction("arguments"),n=this._isNew;return this._isCall?function(t){var e=s(t);if(e||0===e){e=""+e;var i=o(t);if(i){"function"!=typeof i[e]&&Error("cannot call a non-function property");var r=a(t);return n?Amm.Operator.FunctionCall.newVarArgs(i[e],r):null==r?i[e]():r instanceof Array?i[e].apply(i,r):i[e](r)}}}:function(t){var e=s(t);if(e||0===e){e=""+e;var i=o(t);if(i){var r="get"+e[0].toUpperCase()+e.slice(1);if("function"!=typeof i[r])return i[e];var n=a(t);return null==n||(n instanceof Array?n.length||(n=null):n=[n]),n?i[r].apply(i,n):i[r]()}}}},_doSetValue:function(t,e){var i=this._getOperandValue("property");if(i||0===i){if("_"===(i=""+i)[0])return"cannot assign to pseudo-private properties(beginning with '_')";var r=this._getOperandValue("object");if(!r)return"`object` is empty";i[0].toUpperCase(),i.slice(1);var n=i[0].toUpperCase()+i.slice(1),s="set"+n,o="function"==typeof r["get"+n],a="function"==typeof r[s];if(o&&!a)return"property is read-only (has getter but no setter)";if(e)return!1;if(a){var h=this._getOperandValue("arguments");if(null==h||(h instanceof Array?h.length||(h=null):h=[h]),h)return h=[].concat([t],h),void r[s].apply(r,h);r[s](t)}else r[i]=t}},assignmentFunction:function(){var l=this._operandFunction("property"),u=this._operandFunction("object"),c=this._operandFunction("arguments");return function(t,e){var i=l(t);if(!i)return"`property` is empty";if("_"===(i=""+i)[0])return"cannot assign to pseudo-private properties(beginning with '_')";var r=u(t);if(!r)return"`object` is empty";var n=i[0].toUpperCase()+i.slice(1),s="set"+n,o="function"==typeof r["get"+n],a="function"==typeof r[s];if(o&&!a)return"property is read-only (has getter but no setter)";if(a){var h=c(t);if(null==h||(h instanceof Array?h.length||(h=null):h=[h]),h)return h.unshift(e),void r[s].apply(r,h);r[s](e)}else r[i]=e}},_isValueObservable:function(t,e){return"arguments"!==t&&Amm.Operator.prototype._isValueObservable.call(this,t,e)},_reportChange:function(t){Amm.Operator.prototype._reportChange.call(this,t),this._isNew&&t&&"function"==typeof t.cleanup&&t.cleanup()}},Amm.extend(Amm.Operator.Property,Amm.Operator),Amm.Operator.Binary=function(t,e,i){this._isEvaluating++,Amm.Operator.call(this),this._setOperator(e),void 0!==t&&this._setOperand("left",t),void 0!==i&&this._setOperand("right",i),this._isEvaluating--},Amm.Operator.Binary.BINARY_OPERATORS={"!==":function(t,e){return t!==e},"===":function(t,e){return t===e},"==":function(t,e){return t==e},"!=":function(t,e){return t!=e},"+":function(t,e){return t+e},"-":function(t,e){return t-e},"*":function(t,e){return t*e},"%":function(t,e){return t%e},"/":function(t,e){return t/e},">":function(t,e){return e<t},"<":function(t,e){return t<e},"<=":function(t,e){return t<=e},">=":function(t,e){return e<=t},"&":function(t,e){return t&e},"|":function(t,e){return t|e},"&&":function(t,e){return t&&e},"||":function(t,e){return t||e},instanceof:function(t,e){return Amm.Operator.Binary.instanceof(t,e)}},Amm.Operator.Binary.prototype={"Amm.Operator.Binary":"__CLASS__",_leftOperator:null,_leftValue:null,_leftExists:null,_operator:null,_operatorFn:null,_rightOperator:null,_rightValue:null,_rightExists:null,OPERANDS:["left","right"],STATE_SHARED:{_operator:!0,_operatorFn:!0},supportsAssign:!1,_setOperator:function(t){var e=Amm.Operator.Binary.BINARY_OPERATORS[t];e||Error("Unsupported binary operator type: '"+t+"'"),this._operator=t,this._operatorFn=e},_doEvaluate:function(t){var e=this._getOperandValue("left",t),i=this._getOperandValue("right",t);return this._operatorFn(e,i)},setLeft:function(t){this._setOperand("left",t)},setRight:function(t){this._setOperand("right",t)},toFunction:function(){var e=this._operandFunction("left"),i=this._operandFunction("right"),r=this._operatorFn;return function(t){return r(e(t),i(t))}}},Amm.extend(Amm.Operator.Binary,Amm.Operator),Amm.Operator.Binary.instanceof=function(t,e){if(!e)return!1;if(!t&&"object"!=typeof t)return!1;if("string"==typeof e&&!(e=Amm.Operator.FunctionCall.getFunction(e,!0)))return!1;if("function"!=typeof e)throw Error("right-side of instanceof must be either string or function");return t instanceof e||Amm.is(t,e)},Amm.Operator.ComponentElement=function(t,e,i,r,n){this._isEvaluating++,Amm.Operator.call(this),this._componentOnly=r,void 0!==t&&this._setOperand("component",t),void 0!==e&&this._setOperand("id",e),void 0!==i&&this._setOperand("range",i),void 0!==n&&(this._allElements=!!n),this._isEvaluating--},Amm.Operator.ComponentElement.prototype={"Amm.Operator.ComponentElement":"__CLASS__",_componentOnly:!1,_allElements:!1,_componentOperator:null,_componentValue:null,_componentExists:null,_idOperator:null,_idValue:null,_idExists:null,_rangeOperator:null,_rangeValue:null,_rangeExists:null,OPERANDS:["component","id","range"],STATE_SHARED:{_componentOnly:!0},supportsAssign:!1,getReportsContentChanged:function(){return!0},_componentEvents:function(t,e){var i;e&&e.Component&&this._unsub(e),t&&t.Component&&(i={acceptedElements:this._acceptedElements,rejectedElements:this._rejectedElements,renamedElement:this._renamedElement},this._componentOnly&&(i.childComponentStatusChange=this._childComponentStatusChange),this._sub(t,i))},_rangeChange:function(t){this._checkArrayChange="*"===t},_acceptedElements:function(t){if(!this._isEvaluating)if(this._allElements)this.evaluate();else if(this._allElements||this._idExists&&this._idValue){for(var e=!1,i=0,r=t.length;i<r;i++)if(t[i].getId()===this._idValue){e=!0;break}e&&this.evaluate()}},_rejectedElements:function(t){return this._acceptedElements(t)},_renamedElement:function(t,e,i){this._isEvaluating||(this._allElements?this.evaluate():this._idExists&&this._idValue&&(e!==this._idValue&&i!==this._idValue||this.evaluate()))},_childComponentStatusChange:function(t,e){this._isEvaluating||(this._allElements?this.evaluate():this._idExists&&this._idValue&&(t.getId()!==this._idValue&&t.getInternalId()!==this._idValue||this.evaluate()))},setComponent:function(t){this._setOperand("component",t)},setId:function(t){this._setOperand("id",t)},_doEvaluate:function(t){var e=this._getOperandValue("range",t),i=this._getOperandValue("id",t),r=this._getOperandValue("component",t);return Amm.Operator.ComponentElement._eval(r,i,e,this._componentOnly,this._allElements)},toFunction:function(){var n=this._operandFunction("component"),s=this._operandFunction("id"),o=this._operandFunction("range"),a=this._componentOnly,h=this._allElements;return function(t){var e=o(t),i=s(t),r=n(t);return Amm.Operator.ComponentElement._eval(r,i,e,a,h)}}},Amm.Operator.ComponentElement._eval=function(t,e,i,r,n){var s="*"===i||!e&&n,o=s?[]:void 0;if(!t||!t.Component||!t.getIsComponent())return o;if(r){for(var a=!e&&n?t.getElements():t.getAllNamedElements(e),h=[],l=0;l<a.length;l++)a[l].Component&&a[l].getIsComponent()&&h.push(a[l]);return s?h:h[i]}return s?!e&&n?t.getElements():t.getAllNamedElements(e):t.getNamedElement(e,i)},Amm.extend(Amm.Operator.ComponentElement,Amm.Operator),Amm.Operator.Var=function(t){this._isEvaluating++,Amm.Operator.call(this),void 0!==t&&this._setOperand("varName",t),this._isEvaluating--},Amm.Operator.Var.prototype={"Amm.Operator.Var":"__CLASS__",_varNameOperator:null,_varNameValue:null,_varNameExists:null,_varsProvider:null,_varsProviderContextId:null,OPERANDS:["varName"],STATE_SHARED:{_varsProvider:!0},supportsAssign:!0,notifyProviderVarsChange:function(t,e,i,r){this._varNameValue&&i&&this._varNameValue!==i&&Error("WTF - we shouldn't received wrong varsChange notification"),this._expression&&this._expression.getUpdateLevel()?this._expression.queueUpdate(this):this.evaluate()},setExpression:function(t){Amm.Operator.prototype.setExpression.call(this,t),this._varsProvider=t,this._varsProviderContextId=t._contextId;for(var e=this._parent;e;e=e._parent)if(e["Amm.Operator.VarsProvider"]){this._varsProvider=e,this._varsProviderContextId=e._contextId;break}this._varsProvider&&this._varNameExists&&this._varNameValue&&this._varsProvider.addConsumer(this,this._varNameValue+"")},_initContextState:function(t,e){Amm.Operator.prototype._initContextState.call(this,t,e),e&&this._varsProvider&&(this._varsProviderContextId=this._varsProvider._contextId)},_doEvaluate:function(t){var e,i=this._getOperandValue("varName",t);if(i){if(this._varsProvider){this._varsProviderContextId&&this._varsProviderContextId!==this._varsProvider._contextId&&(e=this._varsProvider._contextId,this._varsProvider.setContextId(this._varsProviderContextId));var r=this._varsProvider.getVars(i);return e&&this._varsProvider.setContextId(e),r}this._hasValue=!1}},_varNameChange:function(t,e,i){var r;this._varsProvider&&(this._varsProviderContextId&&this._varsProviderContextId!==this._varsProvider._contextId&&(r=this._varsProvider._contextId,this._varsProvider.setContextId(this._varsProviderContextId)),e&&this._varsProvider.deleteConsumer(this,e),t&&this._varsProvider.addConsumer(this,t),r&&this._varsProvider.setContextId(r))},_doSetValue:function(t,e){var i,r=this._getOperandValue("varName");return r||0===r?this._varsProvider?e?"":(this._varsProviderContextId&&this._varsProviderContextId!==this._varsProvider._contextId&&(i=this._varsProvider._contextId,this._varsProvider.setContextId(this._varsProviderContextId)),this._varsProvider.setVars(t,r),void(i&&this._varsProvider.setContextId(i))):"expression not provided":"`varName` is empty"},setVarName:function(t){this._setOperand("varName",t)},toFunction:function(){var i=this._operandFunction("varName");return function(t){var e=i(t);if(e)return t.vars[e]}},assignmentFunction:function(){var r=this._operandFunction("varName");return function(t,e){var i=r(t);if(!i&&0!==i)return"`varName` is empty";t.vars[i]=e}},_partialCleanup:function(){var t;this._expression&&this._varsProvider&&this._expression.unsubscribeOperator(this._expression,"varsChange",this),this._varsProvider&&this._varsProvider.hasContext(this._varsProviderContextId)&&(this._varsProviderContextId&&this._varsProviderContextId!==this._varsProvider._contextId&&(t=this._varsProvider._contextId,this._varsProvider.setContextId(this._varsProviderContextId)),this._varsProvider.deleteConsumer(this,this._varNameValue+""),t&&this._varsProvider.setContextId(t)),Amm.Operator.prototype._partialCleanup.call(this)}},Amm.extend(Amm.Operator.Var,Amm.Operator),Amm.Operator.Range=function(t){this._isEvaluating++,Amm.Operator.call(this),void 0!==t&&this._setOperand("source",t),this._isEvaluating--},Amm.Operator.Range.prototype={"Amm.Operator.Range":"__CLASS__",_sourceOperator:null,_sourceValue:null,_sourceExists:null,OPERANDS:["source"],supportsAssign:!1,getReportsContentChanged:function(){return!0},_setSource:function(t){this._setOperand("source",t)},_doEvaluate:function(t){Error("Call to abstract function")},toFunction:function(){Error("Call to abstract function")}},Amm.extend(Amm.Operator.Range,Amm.Operator),Amm.Operator.Range.Condition=function(t,e,i,r){this._isEvaluating++,this._map=[],Amm.Operator.Range.call(this,t),this._value=[],this._nonCacheableIteratorContexts={},void 0!==i&&(this.keyVar=i),void 0!==r&&(this.valueVar=r);var n=new Amm.Operator.Range.Iterator(e,i,r);this._setOperand("iterator",n),this._isEvaluating--},Amm.Operator.Range.Condition.prototype={"Amm.Operator.Range.Condition":"__CLASS__",_iteratorOperator:null,_iteratorValue:null,_iteratorExists:null,_checkArrayChange:!0,keyVar:null,valueVar:null,_nonCacheableIteratorContexts:null,_numNonCacheableIteratorContexts:0,_map:null,OPERANDS:["source","iterator"],STATE_SHARED:{keyVar:!0,valueVar:!0},supportsAssign:!1,_setSource:function(t){this._setOperand("source",t)},_sourceEvents:function(t,e){},_sortMap:function(t){var e=t?this._map.slice(0,t):[];e.length=this._map.length;for(var i=t||0,r=this._map.length;i<r;i++)this._map[i]?e[this._map[i].i]=this._map[i]:e.length--;this._map=e},_doEvaluate:function(t){for(var e=[],i=!0,r=0,n=this._map.length;r<n;r++){!i||this._map[r]&&this._map[r].i===r||(i=!1,this._sortMap(r),n=this._map.length,r--);var s,o=this._map[r].c;t?(this._iteratorOperator.setContextId(o),this._map[r].v=this._iteratorOperator.getValue(t)):(s=this._iteratorOperator._contextId===o?this._iteratorOperator:this._iteratorOperator._contextState[o])._hasValue?this._map[r].v=s._value:(this._iteratorOperator.setContextId(o),this._map[r].v=this._iteratorOperator.getValue()),this._map[r].v&&e.push(this._map[r].o)}return e},toFunction:function(){var h=this._operandFunction("source"),l=this._operandFunction("iterator"),u=this.keyVar||"",c=this.valueVar||"";return function(t){var e=h(t),i=e.length;if(!i)return[];for(var r=l.vars,n=r[u],s=r[c],o=[],a=0;a<i;a++)r[u]=a,r[c]=e[a],l(t)&&o.push(e[a]);return r[u]=n,r[c]=s,o}},_clearIteratorContexts:function(){for(var t in this._isEvaluating++,this._map=[],this._iteratorOperator._contextState)"0"!==t&&this._iteratorOperator._contextState.hasOwnProperty(t)&&this._iteratorOperator._contextState[t]&&this._iteratorOperator.deleteContext(t);this._isEvaluating--},notifyOperandChanged:function(t,e,i,r){if(r!==this._iteratorOperator)Amm.Operator.Range.prototype.notifyOperandChanged.call(this,t,e,i,r);else{if(null!==r.parentContextId&&r.parentContextId!==this._contextId&&this.setContextId(r.parentContextId),this._lockChange)return;var n=r.index;this._map[n]&&this._map[n].c===r._contextId&&this._map[n].v!==e&&(this._map[n].v=e,this._isEvaluating||this.evaluate())}},_buildIteratorContexts:function(){this._isEvaluating++;var t=this._sourceValue,e=t.length;this._iteratorOperator;this._map.length=t.length;for(var i=0;i<e;i++){var r={};null!==this.keyVar&&(r[this.keyVar]=i),null!==this.valueVar&&(r[this.valueVar]=t[i]),this._iteratorOperator.createContext({index:i,parentContextId:this._contextId,vars:r}),this._map[i]={c:this._iteratorOperator._contextId,i:i,o:t[i],v:void 0}}this._isEvaluating--},_adjustIteratorContexts:function(t,e){var i=this._sourceValue||[];if(void 0===e&&(e=t.cut.length===t.insert.length||i.length<t.insert.length),t.cut.length&&t.insert.length||(e=!1),i.length){if(!(t.cut.length&&e||t.insert.length!==i.length))return this._map.length&&this._clearIteratorContexts(),void this._buildIteratorContexts();this._isEvaluating++;var r=t.index,n=[];if(e)for(var s=[],o=(Amm.Array.symmetricDiff(t.cut,t.insert,null,s),Amm.Array.findNonMatched(s,t.insert.length)),a=[],h=0,l=s.length;h<l;h++)null===s[h]?n.push(h):s[h]!==h&&a.push([h,s[h]]);else{o=[];for(h=0;h<t.cut.length;h++)n.push(h);for(h=0;h<t.insert.length;h++)o.push(h);a=[]}var u,c=this._map,m=t.insert.length-t.cut.length;if(m)for(h=r+t.cut.length;h<c.length;h++)a.push([h-r,h+m-r]);for(var _=this._iteratorOperator,h=0,l=a.length;h<l;h++)(u=c[a[h][0]+r]).i=a[h][1]+r,u.c===_._contextId?_.index=u.i:_._contextState[u.c].index=u.i,this.keyVar&&(_.setContextId(u.c),_.setVars(u.i,this.keyVar));for(var d=n.length<o.length?n.length:o.length,h=0;h<d;h++){(u=c[n[h]+r]).i=o[h]+r,u.o=t.insert[o[h]],_.setContextId(u.c),_.index=u.i;var p={};this.keyVar&&(p[this.keyVar]=u.i),this.valueVar&&(p[this.valueVar]=u.o),_.setVars(p)}for(h=o.length;h<n.length;h++)_.deleteContext(c[n[h]+r].c),c[n[h]+r]=null;for(h=n.length;h<o.length;h++){p={};null!==this.keyVar&&(p[this.keyVar]=o[h]+r),null!==this.valueVar&&(p[this.valueVar]=t.insert[o[h]]),_.createContext({index:o[h]+r,parentContextId:this._contextId,vars:p}),c.push({c:_._contextId,i:o[h]+r,o:t.insert[o[h]],v:void 0})}this._map=c,this._sortMap(),this._isEvaluating--}else this._clearIteratorContexts()},_sourceChange:function(t,e){var i,r,n,s=t&&t.length?t:null,o=e&&e.length?e:null;if(o)if(s){var a=Amm.Array.smartDiff(o,s,null,!0);if(!a)return;"splice"!==a[0]&&Error("Assertion - should receive only 'splice' event (spliceOnly === true)"),r=a[2]?e.slice(a[1],a[1]+a[2]):[],n=a[3],i=a[1]}else r=o?o.slice(0,o.length):[],n=[],i=0;else{if(!s)return;r=[],n=s,i=0}var h=this._makeChangeInfoForSplice(i,r,n);this._adjustIteratorContexts(h)},notifyOperandContentChanged:function(t,e,i){return"source"===t&&this._adjustIteratorContexts(e,!0),Amm.Operator.prototype.notifyOperandContentChanged.call(this,t,e,i)},_constructContextState:function(){var t=Amm.Operator.Range.prototype._constructContextState.call(this);return t._map=[],t._value=[],t._nonCacheableIteratorContexts={},t},_propagateContext:function(t,e,i){return e===this._iteratorOperator?this._contextId!==e.parentContextId?void(i||this.setContextId(e.parentContextId)):void 0:Amm.Operator.Range.prototype._propagateContext.call(this,t,e,i)},notifyOperandNonCacheabilityChanged:function(t,e,i){if(i===this._iteratorOperator){if(i.parentContextId!==this._contextId)return;var r=i._contextId;e?(this._nonCacheableIteratorContexts[r]=!0,this._numNonCacheableIteratorContexts++):(delete this._nonCacheableIteratorContexts[r],this._numNonCacheableIteratorContexts--)}return Amm.Operator.prototype.notifyOperandNonCacheabilityChanged.call(this,t,e,i)},_checkNonCacheableIterator:function(){for(var t in this._nonCacheableIteratorContexts)this._nonCacheableIteratorContexts.hasOwnProperty(t)&&(this._iteratorOperator.setContextId(t),this._iteratorOperator.checkForChanges())},_checkNonCacheableOperators:function(){if(!(this._hasNonCacheable<=!!this._nonCacheable))for(var t=0,e=this.OPERANDS.length;t<e;t++){var i="_"+this.OPERANDS[t]+"Operator";this[i]!==this._iteratorOperator?this[i]&&(this[i]._contextId!==this._contextId&&this._propagateContext(i,this[i],!0),this[i]._hasNonCacheable&&this[i].checkForChanges()):this._numNonCacheableIteratorContexts&&this._checkNonCacheableIterator()}}},Amm.extend(Amm.Operator.Range.Condition,Amm.Operator.Range),Amm.Operator.Range.Slice=function(t,e,i){this._isEvaluating++,Amm.Operator.Range.call(this),void 0!==t&&this._setOperand("source",t),void 0!==e&&this._setOperand("start",e),void 0!==i&&this._setOperand("end",i),this._isEvaluating--},Amm.Operator.Range.Slice.prototype={"Amm.Operator.Range.Slice":"__CLASS__",_startOperator:null,_startValue:null,_startExists:null,OPERANDS:["source","start","end"],supportsAssign:!1,_doEvaluate:function(t){var e=this._getOperandValue("source",t),i=this._getOperandValue("start",t),r=this._getOperandValue("end",t);if(i||"number"==typeof i||(i=null),r||"number"==typeof r||(r=null),e&&(e instanceof Array||e["Amm.Array"]))return e.slice(i,r)},toFunction:function(){var n=this._operandFunction("source"),s=this._operandFunction("start"),o=this._operandFunction("end");return function(t){var e=n(t),i=s(t),r=o(t);if(i||"number"==typeof i||(i=null),r||"number"==typeof r||(r=null),e&&(e instanceof Array||e["Amm.Array"]))return e.slice(i,r)}}},Amm.extend(Amm.Operator.Range.Slice,Amm.Operator.Range),Amm.Operator.Range.RegExp=function(t,e){this._isEvaluating++,Amm.Operator.Range.call(this),void 0!==t&&this._setOperand("source",t),void 0!==e&&this._setOperand("regexp",e),this._isEvaluating--},Amm.Operator.Range.RegExp.prototype={"Amm.Operator.Range.RegExp":"__CLASS__",_regexpOperator:null,_regexpValue:null,_regexpExists:null,OPERANDS:["source","regexp"],supportsAssign:!1,_doEvaluate:function(t){var e=this._getOperandValue("source",t),i=this._getOperandValue("regexp",t);if(e&&(e instanceof Array||e["Amm.Array"])&&i instanceof RegExp){for(var r=[],n=0,s=e.length;n<s;n++)i.exec(""+e[n])&&r.push(e[n]);return r}},toFunction:function(){var o=this._operandFunction("source"),a=this._operandFunction("regexp");return function(t){var e=o(t),i=a(t);if(e&&(e instanceof Array||e["Amm.Array"])&&i instanceof RegExp){for(var r=[],n=0,s=e.length;n<s;n++)i.exec(""+e[n])&&r.push(e[n]);return r}}}},Amm.extend(Amm.Operator.Range.RegExp,Amm.Operator.Range),Amm.Operator.Range.All=function(t){Amm.Operator.Range.call(this,t)},Amm.Operator.Range.All.prototype={"Amm.Operator.Range.All":"__CLASS__",_sourceOperator:null,_sourceValue:null,_sourceExists:null,OPERANDS:["source"],supportsAssign:!1,_doEvaluate:function(t){var e=this._getOperandValue("source",t);return null===e?[]:void 0!==e?e instanceof Array||e["Amm.Array"]?e:[e]:void 0},toFunction:function(){var i=this._operandFunction("source");return function(t){var e=i(t);return null===e?[]:void 0!==e?e instanceof Array||e["Amm.Array"]?e:[e]:void 0}}},Amm.extend(Amm.Operator.Range.All,Amm.Operator.Range),Amm.Operator.Range.Iterator=function(t,e,i){this._isEvaluating++,Amm.Operator.VarsProvider.call(this,t),this.keyVar=e||null,this.valueVar=i||null,this._isEvaluating--},Amm.Operator.Range.Iterator.prototype={"Amm.Operator.Range.Iterator":"__CLASS__",keyVar:null,valueVar:null,index:null,parentContextId:null,supportsAssign:!1,STATE_SHARED:{keyVar:!0,valueVar:!0},_doEvaluate:function(t){var e=this._getOperandValue("operator",t);return void 0===e?e:!!e}},Amm.extend(Amm.Operator.Range.Iterator,Amm.Operator.VarsProvider),Amm.Operator.Range.Index=function(t,e){this._isEvaluating++,Amm.Operator.Range.call(this),void 0!==t&&this._setOperand("source",t),void 0!==e&&this._setOperand("index",e),this._isEvaluating--},Amm.Operator.Range.Index.prototype={"Amm.Operator.Range.Index":"__CLASS__",_indexOperator:null,_indexValue:null,_indexExists:null,OPERANDS:["source","index"],supportsAssign:!1,_doEvaluate:function(t){var e=this._getOperandValue("source",t),i=this._getOperandValue("index",t);return e&&(e instanceof Array||e["Amm.Array"])?e[i]:i?void 0:e},toFunction:function(){var r=this._operandFunction("source"),n=this._operandFunction("index");return function(t){var e=r(t),i=n(t);return e&&(e instanceof Array||e["Amm.Array"])?e[i]:i?void 0:e}}},Amm.extend(Amm.Operator.Range.Index,Amm.Operator.Range),Amm.Operator.List=function(t){this._isEvaluating++,this.OPERANDS=[],Amm.Operator.call(this),void 0!==t&&this.setItems(t),this._isEvaluating--},Amm.Operator.List.prototype={"Amm.Operator.List":"__CLASS__",_length:0,OPERANDS:null,STATE_SHARED:{_length:!0},_getContextState:function(){for(var t=Amm.Operator.prototype._getContextState.call(this),e=0;e<this._length;e++){var i="_"+e+"Value",r="_"+e+"Operator",n="_"+e+"Exists",s="_"+e+"Observe";t[i]=this[i],t[0]=this[r],t[n]=this[n],t[s]=this[s]}return t},getReportsContentChanged:function(){return!0},setItems:function(t){t instanceof Array||Error("items must be an Array");for(var e=this._length,i=t.length,r=i;r<e;r++){var n="_"+r+"Value",s="_"+r+"Operator",o="_"+r+"Exists",a="_"+r+"Observe";this[s]&&this[s].cleanup(),delete this[s],delete this[n],delete this[o],delete this[a]}this._isEvaluating++,this.OPERANDS=[];for(r=0;r<i;r++)this._setOperand(r,t[r]),this.OPERANDS.push(r);this._length=i,this._isEvaluating--},_doEvaluate:function(t){for(var e,i=[],r=!!this._value&&this._length===this._value.length,n=0;n<this._length;n++)i.push(e=this._getOperandValue(n,t)),r=r&&this._value[n]===e;return r?this._value:i},toFunction:function(){for(var r=[],t=0;t<this._length;t++)r.push(this._operandFunction(t));var n=r.length;return function(t){for(var e=[],i=0;i<n;i++)e.push(r[i]());return e}}},Amm.extend(Amm.Operator.List,Amm.Operator),Amm.Operator.FunctionCall=function(t,e,i,r){this._isEvaluating++,Amm.Operator.call(this),this._cacheability=!!i||!!r,this._isNew=!!r,void 0!==e&&this._setOperand("args",e),void 0!==t&&this._setOperand("func",t),null==i||i||this._setNonCacheable(Amm.Operator.NON_CACHEABLE_VALUE),this._isEvaluating--},Amm.Operator.FunctionCall.WINDOW_PASSTHROUGH=["RegExp","Intl","JSON","Math","Date","isNaN","isFinite","parseInt","parseFloat"],Amm.Operator.FunctionCall.prototype={"Amm.Operator.FunctionCall":"__CLASS__",_isNew:!1,_funcOperator:null,_funcValue:null,_funcExists:null,_argsOperator:null,_argsValue:null,_argsExists:null,_cacheability:null,OPERANDS:["func","args"],STATE_SHARED:{_cacheability:!0,_isNew:!0},getReportsContentChanged:function(){return this._cacheability},_doEvaluate:function(t){var e=this._getOperandValue("func",t);if(e){e=Amm.Operator.FunctionCall.getFunction(e);var i=this._getOperandValue("args",t);return this._isNew?Amm.Operator.FunctionCall.newVarArgs(e,i):null==i||i instanceof Array&&!i.length?e():i instanceof Array?e.apply(window,i):e(i)}},toFunction:function(){var r=this._operandFunction("func"),n=this._operandFunction("args"),s=this._isNew;return function(t){var e=r(t);if(e){e=Amm.Operator.FunctionCall.getFunction(e);var i=n(t);return s?Amm.Operator.FunctionCall.newVarArgs(e,i):null==i||i instanceof Array&&!i.length?e():i instanceof Array?e.apply(window,i):e(i)}}},_isValueObservable:function(t,e){return"args"!==t&&Amm.Operator.prototype._isValueObservable.call(this,t,e)},_reportChange:function(t){Amm.Operator.prototype._reportChange.call(this,t),this._isNew&&t&&"function"==typeof t.cleanup&&t.cleanup()}},Amm.extend(Amm.Operator.FunctionCall,Amm.Operator),Amm.Operator.FunctionCall.getFunction=function(t,e){var i;if("function"==typeof t)return t;if("string"==typeof t)return(i=Amm.getFunction(t,!0))||0<=Amm.Array.indexOf(t,Amm.Operator.FunctionCall.WINDOW_PASSTHROUGH)&&(i=window[t]),i||e||Amm.getFunction(t),i;if(!e)throw Error("Callee must be either function or string, given: "+Amm.describeType(t))},Amm.Operator.FunctionCall.newVarArgs=function(t,e){if(null==e||e instanceof Array&&!e.length)return new t;if(!(e instanceof Array))return new t(e);var i=e.length;if(!i)return new t;if(1===i)return new t(e[0]);if(2===i)return new t(e[0],e[1]);if(3===i)return new t(e[0],e[1],e[2]);if(4===i)return new t(e[0],e[1],e[2],e[3]);if(5===i)return new t(e[0],e[1],e[2],e[3],e[4]);if(6===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5]);if(7===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6]);if(8===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7]);if(9===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]);if(10===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9]);if(11===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10]);if(12===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11]);if(13===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12]);if(14===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13]);if(15===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14]);if(16===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]);if(17===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15],e[16]);if(18===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15],e[16],e[17]);if(19===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15],e[16],e[17],e[18]);if(20===i)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15],e[16],e[17],e[18],e[19]);throw Error("Only argument arrays of size up to 20 are supported")},Amm.ElementBound=function(t){Amm.init(this,t)},Amm.ElementBound.prototype={"Amm.ElementBound":"__CLASS__",requiredElementClass:"Amm.Element",requiredElementInterfaces:null,_element:null,_isElementCleanup:0,cleanupWithElement:!0,_doElementChange:function(t,e){e&&!this._isElementCleanup&&e.unsubscribe("cleanup",this._handleElementCleanup,this),this._element=t,this._element&&this._element.subscribe("cleanup",this._handleElementCleanup,this)},setElement:function(t){null!==t&&(this.requiredElementClass&&Amm.is(t,this.requiredElementClass,"element"),this.requiredElementInterfaces&&Amm.hasInterfaces(t,this.requiredElementInterfaces,"element"));var e=this._element;if(t!==e)return this._doElementChange(t,e),!0},getElement:function(){return this._element},_handleElementCleanup:function(){return this._isElementCleanup++,this.cleanupWithElement&&this.cleanup(),this.setElement(null),this._isElementCleanup--,!0},cleanup:function(){this._element&&(this._isElementCleanup||this._element.unsubscribe(void 0,void 0,this),this.setElement(null)),Amm.callMethods(this,"_cleanup_"),Amm.unregisterItem(this)},_requireInterfaces:function(t,e){var i=Array.prototype.slice.call(arguments);this.requiredElementInterfaces instanceof Array||(this.requiredElementInterfaces=this.requiredElementInterfaces?[this.requiredElementInterfaces]:[]),this.requiredElementInterfaces=this.requiredElementInterfaces.concat(i)}},Amm.View.Abstract=function(t){Amm.callMethods(this,"_preInit_",t),Amm.ElementBound.call(this,t),Amm.init(this,t,["element","elementPath"]),this.id||(this.id=Amm.getClass(this))},Amm.View.Abstract.waitForView=function(e,i,r,n,s){var o=e.findView(i,r);if(o&&o.getObserving())return n.call(s,o,e),null;var a,t=a=function(t){void 0!==i&&t.id!==i||void 0!==r&&!Amm.is(t,r)||(n.call(s,o,e),e.unsubscribe("viewReady",a))};return e.subscribe("viewReady",t),t},Amm.View.Abstract.stopWaitingForView=function(t,e){t.unsubscribe("viewReady",e)},Amm.View.Abstract.prototype={"Amm.View.Abstract":"__CLASS__",twoWayInit:!0,_presentationProperty:null,_observing:null,id:null,getIsReady:function(){return this.getObserving()},getObserving:function(){return this._observing},_doElementChange:function(t,e){this._observing&&this._endObserve(),e&&e.outViewDeleted(this),Amm.ElementBound.prototype._doElementChange.call(this,t,e),t&&t.outViewAdded(this),Amm.callMethods(this,"_elementChange_",t,e),this._observeElementIfPossible()},_canObserve:function(){return!!this._presentationProperty&&!(!this._element||!this[this._presentationProperty])},_endObserve:function(){this._observing=!1,this._element&&this._element.unsubscribe(void 0,void 0,this),this._releaseResources()},_observeElementIfPossible:function(){if(this._canObserve()){if(!this._observing){this._observing=!0,this._acquireResources();var t,e,i,r=[],n={};for(var s in this){"function"==typeof this[s]&&("setV"===(t=(""+s).slice(0,4))||"getV"===t?n[e=s[4].toLowerCase()+s.slice(5)]||(n[e]=!0,this._observeProp(e,"setV"+s.slice(4),r)):"_handleElement"===(""+s).slice(0,14)&&(i=s[14].toLowerCase()+s.slice(15),this._element.hasEvent(i)&&this._element.subscribe(i,this[s],this)))}return this._initProperties(r),this._element.outViewReady(this),!0}}else this._observing&&this._endObserve()},_acquireResources:function(){},_releaseResources:function(){},_observeProp:function(t,e,i){var r={};Amm.detectProperty(this._element,t,r),this[e]&&r.eventName&&this._element.subscribe(r.eventName,e,this),r.getterName&&(r.propName=t,i.push(r))},_initProperties:function(t){for(var e=0;e<t.length;e++){var i,r=t[e],n=r.propName,s="setV"+(n=n[0].toUpperCase()+n.slice(1)),o="getV"+n,a=this._element[r.getterName]();this.twoWayInit&&void 0===a&&r.setterName&&"function"==typeof this[o]?void 0!==(i=this[o]())&&this._element[r.setterName](i):"function"==typeof this[s]&&this[s](a)}},getSuggestedTraits:function(){return[]}},Amm.extend(Amm.View.Abstract,Amm.ElementBound),Amm.View.Html=function(t){Amm.DomHolder.call(this,{})},Amm.View.Html.prototype={"Amm.View.Html":"__CLASS__",_presentationProperty:"_htmlElement",_htmlElement:null,_deferHtmlElementRef:null,_resolveHtmlElement:!0,_relativeToView:null,_waitHandler:null,_preInit_htmlView:function(t){t&&t.relativeToView&&this.setRelativeToView(t.relativeToView)},setHtmlSource:function(t){var e=jQuery(t);if(!e.length)throw Error("Cannot setHtmlSource: selector '"+t+"' doesn't return any elements");var i=jQuery.parseHTML(e[0].innerHTML.replace(/^\s+|\s+$/g,""))[0];this.setHtmlElement(i)},setHtmlElement:function(t){(this._resolveHtmlElement||this._relativeToView)&&(t=this._implResolveHtmlElement(t));var e=this._htmlElement;if(e!==t)return e&&this._releaseDomNode(e),this._htmlElement=t,this._doSetHtmlElement(t,e),this._observeElementIfPossible(),!0},_implResolveHtmlElementRelativeToView:function(t){var e,i=this._deferHtmlElementRef["Amm.Builder.Ref"]?(this._deferHtmlElementRef.setNode(t.getHtmlElement()),this._deferHtmlElementRef.resolve(!0)):(i=(e=jQuery(t.getHtmlElement())).find(this._deferHtmlElementRef)[0])||e.closest(this._deferHtmlElementRef)[0];i&&(i instanceof HTMLElement||i.nodeType)?this.setHtmlElement(i):console.warn(Amm.getClass(this)+" of "+Amm.getClass(this._element)+": cannot resolve HTMLElement relative to view '"+t.id+"' using selector '"+this._deferHtmlElementRef),this._deferHtmlElementRef=null},_elementChange_htmlView:function(t,e){e&&this._waitHandler&&(Amm.View.Abstract.stopWaitingForView(e,this._waitHandler),this._waitHandler=null),t&&this._deferHtmlElementRef&&this._resolveOrDeferHtmlElementRelativeToView(this._deferHtmlElementRef)},_resolveOrDeferHtmlElementRelativeToView:function(t){if(this._deferHtmlElementRef=t,!this._element)return null;var e,i=!0===this._relativeToView?void 0:this._relativeToView;this._element&&(e=Amm.View.Abstract.waitForView(this._element,i,"Amm.View.Html",this._implResolveHtmlElementRelativeToView,this),this._waitHandler=e)},_implResolveHtmlElement:function(t){if(!t)return null;if(t instanceof HTMLElement||t.nodeType)return t;if("string"==typeof t||t["Amm.Builder.Ref"]||"$ref"in t)return t.$ref&&(t=new Amm.Builder.Ref(t)),this._relativeToView?this._resolveOrDeferHtmlElementRelativeToView(t):t["Amm.Builder.Ref"]?t.resolve(!0):jQuery(t)[0]||null;if(t.jquery)return t[0]||null;throw Error("`htmlElement` of Amm.View.Html is expected to be HTMLElement instance, string or jQuery result or FALSEable value; provided: "+Amm.describeType(t))},_doSetHtmlElement:function(t,e){},setRelativeToView:function(t){if(this._relativeToView!==t)return this._relativeToView=t,!0},getRelativeToView:function(){return this._relativeToView},getHtmlElement:function(){return this._htmlElement},_acquireResources:function(){this._acquireDomNode(this._htmlElement)},_releaseResources:function(){this._htmlElement&&this._releaseDomNode(this._htmlElement)},_cleanup_AmmViewHtml:function(){this.setHtmlElement(null)}},Amm.extend(Amm.View.Html,Amm.DomHolder),Amm.View.Abstract.Visual=function(t){Amm.View.Abstract.call(this,t),this._requireInterfaces("Visual","ClassName")},Amm.View.Abstract.Visual.prototype={"Amm.View.Abstract.Visual":"__CLASS__",setVVisible:function(t){},getVVisible:function(){},setVDisplayParent:function(t){},getVDisplayParent:function(){},setVDisplayOrder:function(t){},getVDisplayOrder:function(){},setVClassName:function(t){},getVClassName:function(){}},Amm.extend(Amm.View.Abstract.Visual,Amm.View.Abstract),Amm.View.Abstract.Annotated=function(t){this._childViews=[],Amm.View.Abstract.call(this,t),this._requireInterfaces("Annotated")},Amm.View.Abstract.Annotated.prototype={"Amm.View.Abstract.Annotated":"__CLASS__",_childViews:null,enumerateExisting:!0,_observeElementIfPossible:function(){var t=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);return t&&this.enumerateExisting&&this._createExisting(),t},_createExisting:function(){},_doElementChange:function(t,e){if(Amm.View.Abstract.prototype._doElementChange.call(this,t,e),e&&e.getAnnotationsContainer().unsubscribe(void 0,void 0,this),this._clearChildViews(),t){var i=t.getAnnotationsContainer();i.subscribe("acceptedElements",this._onAnnotationAdded,this);for(var r=i.getElements(),n=0;n<r.length;n++)this._createChildViewsOrDefer(r[n])}},_clearChildViews:function(){for(var t=this._childViews.length-1;0<=t;t--)this._childViews[t].cleanup(),delete this._childViews[t]},_createViewOnChildContentChange:function(t,e){var i=Amm.event.origin;t&&i._annotated_needCreateViews&&this._createChildViews(i)&&(i.unsubscribe("contentChange",this._createViewOnChildContentChange,this),i._annotated_needCreateViews=!1)},_createChildViewsOrDefer:function(t){this._createChildViews(t)||(t._annotated_needCreateViews=!0,t.subscribe("contentChange",this._createViewOnChildContentChange,this))},_onAnnotationAdded:function(t){for(var e=0,i=t.length;e<i;e++)this._createChildViewsOrDefer(t[e])},_createChildViews:function(t,e){},cleanup:function(){this._clearChildViews(),Amm.View.Abstract.prototype.cleanup.call(this)}},Amm.extend(Amm.View.Abstract.Annotated,Amm.View.Abstract),Amm.View.Abstract.Input=function(t){Amm.View.Abstract.call(this,t),this._requireInterfaces("Focusable","Editor","Lockable")},Amm.View.Abstract.Input.prototype={"Amm.View.Abstract.Input":"__CLASS__",setVFocused:function(t){},getVFocused:function(){},setVReadOnly:function(t){},getVReadOnly:function(){},setVEnabled:function(t){},getVEnabled:function(){},setVValue:function(t){},getVValue:function(){},setVLocked:function(t){}},Amm.extend(Amm.View.Abstract.Input,Amm.View.Abstract),Amm.View.Abstract.Collection=function(t){Amm.View.Abstract.call(this,t)},Amm.View.Abstract.Collection.prototype={"Amm.View.Abstract.Collection":"__CLASS__",_observesCollection:!1,_collection:null,_requiresElement:!1,_collectionProperty:null,_colEv:null,_canObserveCollection:function(){var t=this._collection&&(!this._requiresElement||this._element);return this._presentationProperty&&(t=t&&this[this._presentationProperty]),!!t},_observeCollectionIfPossible:function(){this._canObserveCollection()?this._observesCollection||this._beginObserveCollection():this._observesCollection&&this._endObserveCollection()},_beginObserveCollection:function(){if(!this._observesCollection){this._observesCollection=!0,this._colEv=[];var t,e="_handleCollection",i=e.length;for(var r in this){"_"===r[0]&&r.slice(0,i)===e&&"function"==typeof this[r]&&(t=r.charAt(i).toLowerCase()+r.slice(i+1),this._collection.subscribe(t,this[r],this),this._colEv.push(t))}}},_endObserveCollection:function(){if(this._observesCollection&&(this._observesCollection=!1,this._colEv))for(var t=0,e=this._colEv.length;t<e;t++)this._collection.unsubscribe(this._colEv[t],void 0,this)},setCollection:function(t){var e=this._collection;if(e!==t)return e&&this._endObserveCollection(),this._collection=t,this._observeCollectionIfPossible(),!0},getCollection:function(){return this._collection},setRequiresElement:function(t){if(this._requiresElement!==t)return this._requiresElement=t,this._observeCollectionIfPossible(),!0},getRequiresElement:function(){return this._requiresElement},getObservesCollection:function(){return this._observesCollection},setCollectionProperty:function(t){var e=this._collectionProperty;if(e!==t){this._element&&e&&this._element.unsubscribe(e+"Change",void 0,this);var i=(this._collectionProperty=t)+"Change";return this._element&&this._element.hasEvent(i)&&this._element.subscribe(i,this._onElementCollectionPropertyChange,this),this._checkCollectionProperty(),!0}},_checkCollectionProperty:function(t){var e;(this._element||t)&&(e=null,this._element&&(this._collectionProperty?e=Amm.getProperty(this._element,this._collectionProperty):Amm.is(this._element,"Amm.Collection")&&(e=this._element)),this.setCollection(e))},getCollectionProperty:function(){return this._collectionProperty},_onElementCollectionPropertyChange:function(t,e){this.setCollection(t)},_doElementChange:function(t,e){Amm.View.Abstract.prototype._doElementChange.call(this,t,e),this._checkCollectionProperty(!!e)},_observeElementIfPossible:function(){var t,e=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);return this._observeCollectionIfPossible(),e&&this._collectionProperty&&(t=this._collectionProperty+"Change",this._element&&this._element.hasEvent(t)&&this._element.subscribe(t,this._onElementCollectionPropertyChange,this)),e}},Amm.extend(Amm.View.Abstract.Collection,Amm.View.Abstract),Amm.View.Abstract.Content=function(t){Amm.View.Abstract.call(this,t),this._requireInterfaces("Content")},Amm.View.Abstract.Content.prototype={"Amm.View.Abstract.Content":"__CLASS__",_elementContentTranslator:null,_contentTranslator:null,_lastContent:void 0,setContentTranslator:function(t){if(t=t?Amm.constructInstance(t,"Amm.Translator"):null,this._contentTranslator!==t)return this._contentTranslator=t,this._observing&&void 0!==this._lastContent&&this.setVContent(this._lastContent),!0},getContentTranslator:function(){return this._contentTranslator},setVContentTranslator:function(t){this._elementContentTranslator=t,!this._contentTranslator&&void 0!==this._lastContent&&this._observing&&this.setVContent(this._lastContent)},_doHandleInTranslationError:function(t,e){},_doHandleOutTranslationError:function(t,e){},setVContent:function(t){this._lastContent=t;var e,i=this._contentTranslator||this._elementContentTranslator,r={};i?(e=i.translateOut(t,r),r.error&&(e=this._doHandleInTranslationError(t,r.error))):e=t,this._doSetContent(e)},getVContent:function(){var t,e=this._doGetContent(),i=this._contentTranslator||this._elementContentTranslator,r={};return i?(t=i.translateIn(e,r),r.error&&(t=this._doHandleInTranslationError(e,r.error))):t=e,t},_doSetContent:function(t){},_doGetContent:function(){}},Amm.extend(Amm.View.Abstract.Content,Amm.View.Abstract),Amm.View.Abstract.Select=function(t){Amm.View.Abstract.call(this,t),this._requireInterfaces("Select")},Amm.View.Abstract.Select.prototype={"Amm.View.Abstract.Select":"__CLASS__",_fieldView:null,_collectionView:null,_observeElementIfPossible:function(){var t=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);return t&&this._doObserveSelect(),t},_createFieldView:function(){},_createCollectionView:function(){},_doObserveSelect:function(){this._collectionView||this._createCollectionView(),this._collectionView.setElement(this._element),this._fieldView||this._createFieldView(),this._fieldView.setElement(this._element)},_endObserve:function(){this._fieldView.setElement(null),this._collectionView.setElement(null)}},Amm.extend(Amm.View.Abstract.Select,Amm.View.Abstract),Amm.View.Html.Visual=function(t){Amm.View.Abstract.Visual.call(this,t),Amm.View.Html.call(this)},Amm.View.Html.Visual.defaultDelay=250,Amm.View.Html.Visual.prototype={"Amm.View.Html.Visual":"__CLASS__",delay:void 0,setVVisible:function(t){var e=this.delay;void 0===e&&(e=Amm.View.Html.Visual.defaultDelay),jQuery(this._htmlElement)[t?"show":"hide"](e)},getVVisible:function(){if(this._htmlElement)return"none"!==this._htmlElement.style.display},setVDisplayParent:function(t){},getVDisplayParent:function(){},setVDisplayOrder:function(t){},getVDisplayOrder:function(){},setVToggleClass:function(t,e){jQuery(this._htmlElement)[e?"addClass":"removeClass"](t)},getVToggleClass:function(t){return jQuery(this._htmlElement).hasClass(t)},setVClassName:function(t){jQuery(this._htmlElement).attr("class",t)},getVClassName:function(){return jQuery(this._htmlElement).attr("class")},cleanup:function(){Amm.View.Abstract.Visual.prototype.cleanup.call(this),this._htmlElement&&this._releaseDomNode(this._htmlElement)},_acquireResources:function(){this._acquireDomNode(this._htmlElement)},getSuggestedTraits:function(){return[Amm.Trait.Visual]}},Amm.extend(Amm.View.Html.Visual,Amm.View.Html),Amm.extend(Amm.View.Html.Visual,Amm.View.Abstract.Visual),Amm.View.Html.Annotated=function(t){Amm.DomHolder.call(this),Amm.View.Abstract.Annotated.call(this,t)},Amm.View.Html.Annotated.prototype={"Amm.View.Html.Annotated":"__CLASS__",annotationClass:"annotation",annotationClassPrefix:"a_",createNodesOnDemand:!0,classToId:function(t,e){if(e){for(var i=t.replace(/^\s+|\s+$/g,"").split(/\s+/),r=0;r<i.length;r++){var n=this.classToId(i[r]);if(n)return n}return null}if(t===this.annotationClass)return null;var s=this.annotationClassPrefix.length,o=null;return s?t.slice(0,s)===this.annotationClassPrefix&&(o=t.slice(s)):o=t,o},idToClass:function(t){return this.annotationClassPrefix+t},locateChildHtmlElement:function(t,e){if(!this._htmlElement)return null;var i=this.idToClass(t),r="."+this.idToClass(t);this.annotationClass&&(r="."+this.annotationClass+r);var n=jQuery(this._htmlElement).find(r);return n.length||(e?(n=jQuery('<div class="'+this.annotationClass+" "+i+'"></div>'),jQuery(this._htmlElement).append(n)):n=null),n},_createExisting:function(){if(!this._htmlElement)return null;var n=this;return jQuery(this._htmlElement).find("."+this.annotationClass).each(function(t,e){var i=n.classToId(e.getAttribute("class"),!0),r=n._element.getAnnotationsContainer().getAnnotationElement(i);n._createChildViews(r,!0,e)}),{}},_createChildViews:function(t,e,i){if(!(i=i||this.locateChildHtmlElement(t.getId(),this.createNodesOnDemand))){if(e)throw Error("Cannot locate child htmlElement for child with id "+t.getId());return this.createNodesOnDemand&&(t._annotated_needCreateViews=!0),null}var r=[];return t.Visual&&r.push(new Amm.View.Html.Visual({element:t,htmlElement:i})),r.push(new Amm.View.Html.Content({element:t,htmlElement:i})),r},_acquireResources:function(){this._acquireDomNode(this._htmlElement)},getSuggestedTraits:function(){return[Amm.Trait.Annotated]}},Amm.extend(Amm.View.Html.Annotated,Amm.View.Html),Amm.extend(Amm.View.Html.Annotated,Amm.View.Abstract.Annotated),Amm.View.Html.Collection=function(t){Amm.registerItem(this),Amm.View.Html.call(this),this._mappingProp="_map_vhc_"+this._amm_id,Amm.View.Abstract.Collection.call(this,t)},Amm.View.Html.Collection.prototype={"Amm.View.Html.Collection":"__CLASS__",debug:!1,itemHtmlElementsMustBeOrphans:!0,_mappingProp:null,createItemHtml:function(t){return"<div>Overwrite createItemHtml!</div>"},updateItemHtml:function(t,e){return jQuery(this.createItemHtml(t))[0]},_doSetHtmlElement:function(t,e){!this._canObserve()&&this._canObserveCollection()&&this._acquireResources()},getItemHtmlElement:function(t){if(t[this._mappingProp])return t[this._mappingProp];var e=this._createAndBindHtmlNode(t);return e[this._mappingProp]||((e[this._mappingProp]=t)[this._mappingProp]=e),e},getHtmlElementItem:function(t){return t[this._mappingProp]},rebuild:function(){return this._rebuild()},_canObserve:function(){return!!this._presentationProperty&&!(!this._element||!this[this._presentationProperty])},_createAndBindHtmlNode:function(t){var e=this.createItemHtml(t);return"string"==typeof e&&(e=jQuery(e)[0]),e&&e.nodeType||Error("Cannot reliabliy create and bind Html Node"),e.parentNode&&11!==e.parentNode.nodeType&&(this.itemHtmlElementsMustBeOrphans?Error("createItemHtml() is supposed to create new nodes, but this one already has parentNode"):e.parentNode.removeChild(e)),(e[this._mappingProp]=t)[this._mappingProp]=e},_beginObserveCollection:function(){this._rebuild(),Amm.View.Abstract.Collection.prototype._beginObserveCollection.call(this)},_clearContainer:function(){var i=jQuery(this._htmlElement),r=this._mappingProp;i.contents().each(function(t,e){e[r]&&(e[r][r]===e&&delete e[r][r],delete e[r]),i[0].removeChild(e)})},_rebuild:function(){this.debug&&console.log(this.debug,"_rebuild"),this._clearContainer(),this._insertToContainer()},_insertToContainer:function(t,e,i){i=i||!1,t=t||this._collection;for(var r=0;r<t.length;r++){var n=this.getItemHtmlElement(t[r],!i);n&&(e?this._htmlElement.insertBefore(n,e):this._htmlElement.appendChild(n))}},_handleCollectionAppendItems:function(t){this.debug&&console.log(this.debug,"_handleCollectionAppendItems",t.length),this._insertToContainer(t)},_handleCollectionDeleteItem:function(t,e){this.debug&&console.log(this.debug,"_handleCollectionDeleteItem",t,e._amm_id);var i=this._mappingProp,r=e[i];r&&(r.parentNode===this._htmlElement&&this._htmlElement.removeChild(r),r[i]&&delete r[i],delete e[i])},refreshAllItems:function(){if(this._collection&&this._htmlElement)for(var t=0,e=this._collection.length;t<e;t++)this.refreshItem(this._collection[t])},refreshItem:function(t){var e,i,r,n;this._collection&&this._htmlElement&&(i=t[e=this._mappingProp],!(r=this.updateItemHtml(t,i))||(n=jQuery(r)[0])&&n!==i&&(n.nodeType||Error("updateItemHtml() returned something that is not an HTML Node"),n.parentNode&&11!==n.parentNode.nodeType&&(this.itemHtmlElementsMustBeOrphans?Error("updateItemHtml() is supposed to create new nodes, but this one already has parentNode"):n.parentNode.removeChild(n)),jQuery(n).has(i).length||jQuery(i).replaceWith(n),i[e]=null,(n[e]=t)[e]=n))},_handleCollectionItemChange:function(t){this.refreshItem(t)},_handleCollectionSpliceItems:function(t,e,i){if(e.length>=this._htmlElement.childNodes.length)this._rebuild();else{for(var r=this._htmlElement.childNodes,n=t,s=Math.min(t+e.length,r.length);n<s;n++)this._htmlElement.removeChild(r[t]);this._insertToContainer(i,r[t]);for(var o=this._mappingProp,n=0,s=e.length;n<s;n++)e[n][o]&&!e[n][o].parentNode&&(e[n][o][o]&&delete e[n][o][o],delete e[n][o])}},_handleCollectionMoveItem:function(t,e,i){this.debug&&console.log(this.debug,"_handleCollectionMoveItem",t,e,i._amm_id);var r=this._htmlElement.childNodes,n=r[t];this._htmlElement.removeChild(n);var s=r[e];s?this._htmlElement.insertBefore(n,s):this._htmlElement.appendChild(n)},_handleCollectionClearItems:function(){this.debug&&console.log(this.debug,"_handleCollectionClearItems"),this._clearContainer()},_handleCollectionItemsChange:function(t,e){this.debug&&console.log(this.debug,"_handleCollectionItemsChange",t.length,e.length),this._rebuild()}},Amm.extend(Amm.View.Html.Collection,Amm.View.Html),Amm.extend(Amm.View.Html.Collection,Amm.View.Abstract.Collection),Amm.View.Html.DisplayParent=function(t){this.requiredElementInterfaces=this.requiredElementInterfaces||[],this.requiredElementInterfaces.push("DisplayParent"),delete this._handleCollectionItemChange,Amm.View.Html.Collection.call(this,t)},Amm.View.Html.DisplayParent.prototype={"Amm.View.Html.DisplayParent":"__CLASS__",debug:!1,_collectionProperty:"displayChildren",itemHtmlElementsMustBeOrphans:!1,scanForItems:!0,buildItems:!1,scanForDisplayOrder:!0,getItemHtmlElement:function(t,e){var i=this._getItemView(t,e),r=null;return i&&(r=i.getHtmlElement()),r||e||Error("Collection item doesn't have view with htmlElement"),r[this._mappingProp]||((r[this._mappingProp]=t)[this._mappingProp]=r),r},updateItemHtml:function(t,e){},_getItemView:function(t,e){var i=t.getUniqueSubscribers("Amm.View.Html.Visual");return i.length?(1<!i.length&&console.warn("Collection item have more than one Amm.View.Html.Visual view"),i[0]):(e||Error("Collection item doesn't have respective Amm.View.Html.Visual view"),null)},_getHtmlElementsWithItems:function(){var t=Amm.domHolderAttribute;return jQuery(this._htmlElement).children("["+t+"]").toArray()},_getElementOfHtmlElement:function(t){for(var e=Amm.domHolderAttribute,i=(t.getAttribute(e)+"").split(" "),r=Amm.getItem(i),n=null,s=0,o=r.length;s<o;s++)if(Amm.is(r[s],"Amm.View.Html.Visual")&&(n=r[s].getElement()))return n;return null},_getItemsInContainer:function(){for(var t=this._getHtmlElementsWithItems(),e=[],i=0,r=t.length;i<r;i++){var n=this._getElementOfHtmlElement(t[i]);n&&e.push(n)}return e},_updateCollectionWithFoundItems:function(t){var e,i=this.scanForItems,r=this.scanForDisplayOrder;if(i&&r){(e=Amm.Array.diff(t,this._collection)).length&&this._collection.push.apply(this._collection,e);for(var n=0;n<t.length;n++)t[n].setDisplayOrder(n)}else if(i){(e=Amm.Array.diff(t,this._collection)).length&&this._collection.push.apply(this._collection,this._collection.length,t)}else for(n=0;n<t.length;n++)t[n].setDisplayOrder(n)},_scanForItems:function(){this.buildItems&&new Amm.Builder(jQuery(this._htmlElement)).build();var t,e=this.scanForItems,i=this.scanForDisplayOrder;!e&&!i||(t=this._getItemsInContainer()).length&&this._updateCollectionWithFoundItems(t)},_beginObserveCollection:function(){this._scanForItems(),Amm.View.Html.Collection.prototype._beginObserveCollection.call(this)},getSuggestedTraits:function(){return[Amm.Trait.DisplayParent]}},Amm.extend(Amm.View.Html.DisplayParent,Amm.View.Html.Collection),Amm.View.Html.StaticDisplayParent=function(t){Amm.View.Html.DisplayParent.call(this,t)},Amm.View.Html.StaticDisplayParent.prototype={"Amm.View.Html.StaticDisplayParent":"__CLASS__",_oldAllowAdd:null,_oldAllowDelete:null,_oldAllowChangeOrder:null,_scanForItems:function(){return this.scanForItems||(console.warn("Setting Amm.View.Html.StaticDisplayParent::scanForItems to FALSE has no effect; property was reset back to TRUE"),this.scanForItems=!0),this.scanForDisplayOrder||(console.warn("Setting Amm.View.Html.StaticDisplayParent::scanForDisplayOrder to FALSE has no effect; property was reset back to TRUE"),this.scanForDisplayOrder=!0),Amm.View.Html.DisplayParent.prototype._scanForItems.apply(this)},_beginObserveCollection:function(){return this._oldAllowAdd=this._collection.getAllowAdd(),this._oldAllowDelete=this._collection.getAllowDelete(),this._oldAllowChangeOrder=this._collection.getAllowChangeOrder(),this._oldAllowAdd||this._collection.setAllowAdd(!0),this._oldAllowDelete||this._collection.setAllowDelete(!0),this._oldAllowChangeOrder||this._collection.setAllowChangeOrder(!0),Amm.View.Html.DisplayParent.prototype._beginObserveCollection.apply(this)},_freezeCollection:function(){this._collection.setAllowAdd(!1),this._collection.setAllowDelete(!1),this._collection.setAllowChangeOrder(!1)},_endObserveCollection:function(){return this._collection.setAllowAdd(this._oldAllowAdd),this._collection.setAllowDelete(this._oldAllowDelete),this._collection.setAllowChangeOrder(this._oldAllowChangeOrder),Amm.View.Html.DisplayParent.prototype._endObserveCollection.apply(this)},_getHtmlElementsWithItems:function(){var t=Amm.domHolderAttribute,e=jQuery(this._htmlElement).find("["+t+"]");return e.not(e.find("["+t+"]"))},_updateCollectionWithFoundItems:function(t){this._collection.length&&!Amm.Array.equal(this._collection,t)&&console.warn("Pre-populated display children are replaced by Amm.View.Html.StaticDisplayParent detection routine"),this._collection.setItems(t),this._freezeCollection()},_rebuild:function(){}},Amm.extend(Amm.View.Html.StaticDisplayParent,Amm.View.Html.DisplayParent),Amm.View.Html.StaticDisplayParent.WithContainers=function(t){Amm.View.Html.StaticDisplayParent.call(this,t)},Amm.View.Html.StaticDisplayParent.WithContainers.prototype={"Amm.View.Html.StaticDisplayParent.WithContainers":"__CLASS__"},Amm.extend(Amm.View.Html.StaticDisplayParent.WithContainers,Amm.View.Html.StaticDisplayParent),Amm.View.Html.Input=function(t){var e=this;this._handler=function(t){return e._receiveEvent(t,this)},Amm.View.Abstract.Input.call(this,t),Amm.View.Html.call(this),Amm.JQueryListener.call(this,{})},Amm.View.Html.Input.prototype={"Amm.View.Html.Input":"__CLASS__",_eventName:"change focus blur",_blurTimeoutHandler:null,_resolveHtmlElement:!1,_watchKeys:!1,_receiveEvent:function(t){if(this._element){if("focus"===t.type)return this._element.setFocusedView(this),!0;if("blur"!==t.type)return this._element.getReadOnly()||this._element.setValue(this.getVValue()),!0;var e=this;return this._blurTimeoutHandler||(this._blurTimeoutHandler=function(){e._element.getFocusedView()===e&&e._element.setFocusedView(null)}),window.setTimeout(this._blurTimeoutHandler,1),!0}},setVFocusedView:function(t){var e=t===this,i=jQuery(this._htmlElement);i[0]&&(e&&!i.is(":focus")?i.focus():!e&&i.is(":focus")&&i.blur())},getVFocusedView:function(){if(jQuery(this._htmlElement).is(":focus"))return this},setVReadOnly:function(t){var e=jQuery(this._htmlElement);e[0]&&(t&&!e[0].hasAttribute("readonly")?e[0].setAttribute("readonly","readonly"):!t&&e[0].hasAttribute("readonly")&&e[0].removeAttribute("readonly"))},getVReadOnly:function(){var t=jQuery(this._htmlElement)[0];if(t)return t.getAttribute("readonly")},_doSetEnabled:function(t,e){void 0===t&&(t=this._element.getEnabled()),void 0===e&&(e=this._element.getLocked());var i=jQuery(this._htmlElement),r=!t||e;i[0]&&(r&&!i[0].hasAttribute("disabled")?i[0].setAttribute("disabled","disabled"):!r&&i[0].hasAttribute("disabled")&&i[0].removeAttribute("disabled"))},setVEnabled:function(t){this._doSetEnabled(t,void 0)},getVEnabled:function(){var t=jQuery(this._htmlElement)[0];if(t)return!t.hasAttribute("disabled")},setVValue:function(t){this._htmlElement&&jQuery(this._htmlElement).val(t)},setVLocked:function(t){this._doSetEnabled(void 0,t)},getVValue:function(){if(this._htmlElement)return jQuery(this._htmlElement).val()},_doSetHtmlElement:function(t){this.setSelector(t)},cleanup:function(){Amm.View.Abstract.Input.prototype.cleanup.call(this),Amm.JQueryListener.prototype.cleanup.call(this),this._htmlElement&&this._releaseDomNode(this._htmlElement)},_acquireResources:function(){this._acquireDomNode(this._htmlElement)},getSuggestedTraits:function(){return[Amm.Trait.Input]},setUpdateOnKeyUp:function(t){t=!!t;var e=this._eventName,i=this.getUpdateOnKeyUp();t!==i&&(t&&!i?e+=" keyup":e=e.replace(/\bkeyup\b/g,"").replace(/ +/," ").replace(/^ +| +$/g,""),this.setEventName(e))},getUpdateOnKeyUp:function(){return!!this._eventName.match(/\bkeyup\b/)}},Amm.extend(Amm.View.Html.Input,Amm.View.Html),Amm.extend(Amm.View.Html.Input,Amm.JQueryListener),Amm.extend(Amm.View.Html.Input,Amm.View.Abstract.Input),Amm.View.Html.Variants=function(t){Amm.View.Abstract.call(this,t),Amm.View.Html.call(this,t),Amm.DomHolder.call(this),this._requireInterfaces("InstantiatorOrRepeater")},Amm.View.Html.Variants.ERROR_BOTH_ATTRIBS="HTML definition of variant prototype cannot have both data-amm-default and data-amm-condition",Amm.View.Html.Variants.ERROR_DEFAULT_DEFINED="Default variant prototype was already defined",Amm.View.Html.Variants.ERROR_INVALID_ATTRIBUTE="Attribute data-amm-condition should contain hash value",Amm.View.Html.Variants.prototype={"Amm.View.Html.Variants":"__CLASS__",_observeElementIfPossible:function(){var t=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);return t&&this._scanHtmlElementAndConfigureInstantiator(),t},_scanHtmlElementAndConfigureInstantiator:function(){var t=Amm.View.Html.Variants.scanNodeForVairants(this._htmlElement);t&&this._element.reportInstantiatorOptions(t.default,t.conditions,t.prototypes)}},Amm.extend(Amm.View.Html.Variants,Amm.View.Html),Amm.extend(Amm.View.Html.Variants,Amm.View.Abstract),Amm.View.Html.Variants.builderExtension_build=function(t,e,i){var r=Amm.View.Html.Variants.scanNodeForVairants(t);r&&(e.initialInstantiatorOptions=[r.default,r.conditions,r.prototypes])},Amm.View.Html.Variants.scanNodeForVairants=function(t){for(var e,i=[],r={},n=null,s=0;s<t.childNodes.length;s++){var o=t.childNodes[s];if(o.hasAttribute){var a=o.hasAttribute("data-amm-default"),h=o.hasAttribute("data-amm-condition");if(a&&h)throw console.error(Amm.View.Html.Variants.ERROR_BOTH_ATTRIBS,o),Error(Amm.View.Html.Variants.ERROR_BOTH_ATTRIBS);if(a){if(n)throw console.error(Amm.View.Html.Variants.ERROR_DEFAULT_DEFINED,o,n),Error(Amm.View.Html.Variants.ERROR_DEFAULT_DEFINED);n=o}else{var l=(window.RJSON||window.JSON).parse(o.getAttribute("data-amm-condition"));if(!l||"object"!=typeof l)throw console.error(Amm.View.Html.Variants.ERROR_INVALID_ATTRIBUTE,o),Error(o);e=l._id||"condition_"+i.length,l._id=e,i.push(l),r[e]=o}}}if(i.length||n)return{default:n,conditions:i,prototypes:r}},Amm.View.Html.Toggle=function(t){Amm.View.Html.Input.call(this,t)},Amm.View.Html.Toggle.prototype={"Amm.View.Html.Toggle":"__CLASS__",getVIsRadio:function(){return"radio"===jQuery(this._htmlElement).attr("type")||void 0},setVIsRadio:function(t){jQuery(this._htmlElement).attr("type",t?"radio":"checkbox")},getVChecked:function(){var t=jQuery(this._htmlElement)[0];if(t)return t.checked},setVChecked:function(t){var e=jQuery(this._htmlElement)[0];e&&(e.checked=!!t)},setVValue:function(){},getVValue:function(){},getVCheckedValue:function(){var t=jQuery(this._htmlElement)[0];if(t)return t.value},setVCheckedValue:function(t){var e=jQuery(this._htmlElement)[0];e&&(e.value=t)},_receiveEvent:function(t){if(this._element){if("change"!==t.type)return Amm.View.Html.Input.prototype._receiveEvent.call(this,t);if(this._element.getReadOnly()){if(this.setVChecked(this._element.getChecked()),this._element.getIsRadio())for(var e=this._element.findGroupItems(!0,!0),i=0,r=e.length;i<r;i++)if(e[i].getChecked())for(var n=e[i].getUniqueSubscribers("Amm.View.Html.Toggle"),s=0,o=n.length;s<o;s++)n[s].setVChecked(!0)}else this._element.setChecked(this._htmlElement.checked);return!0}},getVGroupName:function(){return jQuery(this._htmlElement).attr("name")},getVGroupParent:function(){return jQuery(this._htmlElement).closest("form")[0]},getSuggestedTraits:function(){return[Amm.Trait.Toggle]}},Amm.extend(Amm.View.Html.Toggle,Amm.View.Html.Input),Amm.View.Html.Content=function(t){Amm.View.Abstract.Content.call(this,t),Amm.DomHolder.call(this)},Amm.View.Html.Content.prototype={"Amm.View.Html.Content":"__CLASS__",_doSetContent:function(t){jQuery(this._htmlElement).html(t)},_doGetContent:function(){return jQuery(this._htmlElement).html()},getSuggestedTraits:function(){return[Amm.Trait.Content]}},Amm.extend(Amm.View.Html.Content,Amm.View.Html),Amm.extend(Amm.View.Html.Content,Amm.View.Abstract.Content),Amm.Builder=function(t,e){this.selIgnore+=", ["+Amm.domHolderAttribute+"]",this.elements=[],this.topLevel=[],this.problems=[],t&&t.jquery||"string"==typeof t?this.selector=t:!e&&t&&"object"==typeof t&&(e=t,t=null),e&&Amm.init(this,e)},Amm.Builder._EXT_NOT_FOUND={},Amm.Builder.PROBLEM_SILENT=0,Amm.Builder.PROBLEM_CONSOLE=1,Amm.Builder.PROBLEM_HTML=2,Amm.Builder.TOP_LEVEL_ROOT="root",Amm.Builder.problemReportMode=Amm.Builder.PROBLEM_SILENT,Amm.Builder._scanId=1,Amm.Builder.prototype={_globalIds:null,selector:null,problemReportMode:void 0,sel:"[data-amm-id], [data-amm-e], [data-amm-v], [data-amm-x]",selIgnore:"[data-amm-dont-build], [data-amm-dont-build] *, [data-amm-built]",topLevelComponent:null,rememberElements:!1,rememberProblems:!1,elements:null,topLevel:null,reportMode:Amm.Builder.PROBLEM_CONSOLE|Amm.Builder.PROBLEM_HTML,problems:null,_parent:null,calcPrototypes:function(){return this.build(!0)},calcViewPrototypes:function(t){var e,i,r,n=this._parent;t?(this._parent=new Amm.Builder.Node({e:t}),Amm.getClass(t)?(Amm.is(t,"Amm.Element","forElement"),this._parent.id=t.getId()):this._parent.id=t.id||null):this._parent=new Amm.Builder.Node({e:{}});try{if(1!==(r=this.build(!0)).length||!r[0].views||!r[0].views.length)throw console.log({fe:t,ep:r}),1!==r.length?i="found "+r.length+" top-level elements":r[0].views&&r[0].views.length||(i="no views defined for top-level element"),new Error("Amm.Builder: cannot calcViewPrototypes(): "+i);if(e=r[0].views,t)for(var s=0;s<e.length;s++)e[s].element=t}catch(t){throw this._parent=n,t}return this._parent=n,e},build:function(t){var e=this.selector,i=this._globalIds;this._globalIds={};var r=this._scanNodes(e),n=[],s=[];this._detectConnectedRecursive(r);for(var o=0,a=r.length;o<a;o++)n=n.concat(this._buildElements(r[o],s,t));return this.rememberElements&&(n.length&&this.elements.push.apply(this.elements,n),s.length&&this.topLevel.push.apply(this.topLevel,s)),this._globalIds=i,t?s:n},clear:function(){this.elements=[],this.topLevel=[],this.problems=[]},_scanNodes:function(t){t=t||window.document.documentElement;var r="_amm_builder_scn_"+Amm.Builder._scanId++,e=[],n=[],s=this;jQuery(t).filter(this.sel).add(jQuery(t).find(this.sel)).not(this.selIgnore).each(function(t,e){var i=s._createNode(e);e[r]=n.length,n.push(i)}),this._parent&&e.push(this._parent);for(var i=0,o=n.length;i<o;i++){var a=n[i],h=a.htmlElement,l=jQuery(h).parent().closest(this.sel)[0];l&&void 0!==l[r]?(a.parent=n[l[r]],n[l[r]].children.push(a)):(this._parent&&(a.parent=this._parent,this._parent.children.push(a)),e.push(a))}return e},getExtData:function(t,e,i){void 0===i&&(i=Amm.Builder._EXT_NOT_FOUND),e instanceof Array||(e=(""+e).split("."));for(var r,n=t,s=[].concat(e);void 0!==(r=s.shift());){if("object"!=typeof n||!(r in n))return i;n=n[r]}return n},_replaceRefsAndInstaniateObjects:function(t,e){if(!(t&&"object"==typeof t&&t instanceof Object))return t;var i,r,n;if("$ref"in t)return new Amm.Builder.Ref(t,e);if("$ext"in t){var s=this.getExtData(window,t.$ext);if(s===Amm.Builder._EXT_NOT_FOUND)throw Error("Cannot resolve '$ext' "+t.$ext);if(!t.$resolve)return s;t=s}if(t instanceof Array)for(i=0,r=t.length;i<r;i++)t[i]&&"object"==typeof t[i]&&(t[i]=this._replaceRefsAndInstaniateObjects(t[i],e));else{for(i in t)t.hasOwnProperty(i)&&t[i]&&"object"==typeof t[i]&&(t[i]=this._replaceRefsAndInstaniateObjects(t[i],e));"__construct"in t&&(n=t.__construct,delete t.__construct,t=Amm.constructInstance(t,n))}return t},_createNode:function(t){var e,i=window.RJSON||window.JSON,r=new Amm.Builder.Node;if((e=(r.htmlElement=t).getAttribute("data-amm-v"))&&e.length){r.v=this._replaceRefsAndInstaniateObjects(i.parse(e),r.htmlElement),r.v instanceof Array||(r.v=r.v?[r.v]:[]);for(var n=0,s=r.v.length;n<s;n++)"string"==typeof r.v[n]&&(r.v[n]={class:r.v[n]}),r.v[n].htmlElement=t}return(e=t.getAttribute("data-amm-e"))&&e.length&&(r.e=this._replaceRefsAndInstaniateObjects(i.parse(e),r.htmlElement)),(e=t.getAttribute("data-amm-id"))&&e.length&&"@"===(e=e.replace(/^\s+|\s+$/g,""))[0]&&e[1]&&(r.global=!0,e=e.slice(1),this._globalIds[e]?this._globalIds[e].push(r):this._globalIds[e]=[r]),e&&e.length&&(r.id=e,r.connected.id=e),(e=t.getAttribute("data-amm-x"))&&e.length&&(r.x=this._replaceRefsAndInstaniateObjects(i.parse(e),r.htmlElement)),r},_connect:function(t,e){(t.e||e.e)&&(t.connected.groupHasElement=!0);var i=t.connected.length,r=Amm.Array.diff(e.connected,t.connected);t.connected.push.apply(t.connected,r),e.connected.groupHasElement&&(t.connected.groupHasElement=!0),e.connected.id&&!t.connected.id&&(t.connected.id=e.connected.id),e.connected.alreadyBuilt&&(t.connected.alreadyBuilt=e.connected.alreadyBuilt),e.connected=t.connected;for(var n=i,s=t.connected.length;n<s;n++)e.connected[n].conIdx=n,e.connected[n].connected=e.connected},_detectChildrenConnectedByIds:function(t,e){if(t.id)for(var i=0,r=e.children.length;i<r;i++){var n=e.children[i];n!==t&&(n.id&&n.id!==t.id||(n.id===t.id&&this._connect(t,n),this._detectChildrenConnectedByIds(t,n)))}},_detectConnectedNodes:function(t){var e,i,r,n;if(t.id){if(t.global&&(i=this._globalIds[t.id]))for(var s=0,o=i.length;s<o;s++)i[s]!==t&&this._connect(t,i[s]);for(e=t.parent;e;e=e.parent)"__parent"===t.id&&(t.id=null,this._connect(t,e)),e.id===t.id&&this._connect(t,e),this._detectChildrenConnectedByIds(t,e)}this._detectConnectedRecursive(t.children),(e=t.parent)&&((t.v||t.x)&&!t.e||(e.v||e.x)&&!e.e)&&e&&1===e.children.length&&(r=!(!t.e&&!t.connected.groupHasElement),n=!(!e.e&&!e.connected.groupHasElement),!!(r&&n)||e.id&&t.id||!(e.e||e.v||e.x)||(this._connect(e,t),t.conParent=!0,e.conChild=!0))},_getAllViews:function(t){for(var e=(e=t.v)||[],i=0,r=t.connected.length;i<r;i++)t.connected[i]!==t&&t.connected[i].v&&(e=e.concat(t.connected[i].v));return e},_detectConnectedRecursive:function(t){for(var e=0,i=t.length;e<i;e++)this._detectConnectedNodes(t[e])},_buildElements:function(t,e,i){for(var r=[],n=0,s=t.children.length;n<s;n++)r=r.concat(this._buildElements(t.children[n],e,i));if(!t.e&&1<t.connected.length){if(void 0!==t.connected.id&&(t.id=t.connected.id),t.connected.groupHasElement)return r;if(t.conIdx<t.connected.length-1)return r;if(t.connected.alreadyBuilt)return r}var o=t.e||{},a=o["Amm.Element"]?(t.connected.views||(t.connected.views=[]),t.connected.views):(o.views||(o.views=[]),o.views);a.push.apply(a,this._getAllViews(t)),a.length||a.push({class:"Amm.View.Html.Default",reportMode:this.reportMode});for(var h,n=0,s=a.length;n<s;n++)a[n].htmlElement||(a[n].htmlElement=t.htmlElement);return t.id&&!o.id&&(o.id=t.id),t.parent||!this.topLevelComponent||"component"in o||(o.component=this.topLevelComponent),this._applyExtensions(o,t),h=o["Amm.Element"]?{class:"Amm.Element",views:a}:Amm.override({class:"Amm.Element"},o),i||(h=Amm.constructInstance(o,"Amm.Element")),e&&(!t.parent||t.parent===this._parent||t.conParent&&!t.parent.parent)&&e.push(h),r.push(h),t.connected.alreadyBuilt=!0,r},_applyExtensions:function(t,e){for(var i=0,r=e.connected.length;i<r;i++)if(e.connected[i].x)for(var n=this._parseExtensions(e.connected[i].x),s=0,o=n.length;s<o;s++){var a=n[s].fn(e.connected[i].htmlElement,t,n[s].arg);a&&"object"==typeof a&&Amm.overrideRecursive(t,a)}},_getExtension:function(t){return t=t.replace(/(\.|^)(\w+)$/,"$1builderExtension_$2"),Amm.getFunction(t)},_parseExtensions:function(t){if("string"==typeof t)return[{fn:this._getExtension(t),arg:void 0}];if("object"!=typeof t)throw Error("data-amm-x must contain either string or an object");var e=[];for(var i in t)t.hasOwnProperty(i)&&e.push({fn:this._getExtension(i),arg:t[i]});return e},_regProblem:function(t,e){if(t instanceof Array)for(var i=0,r=t.length;i<r;i++)this._regProblem(t[i],e);else t.htmlElement.hasAttribute(Amm.domHolderAttribute)||t.htmlElement.setAttribute(Amm.domHolderAttribute,""),this.rememberProblems&&this.problems.push({element:t.htmlElement,problem:e}),this.reportMode&Amm.Builder.PROBLEM_CONSOLE&&console.warn("Amm.Builder problem with HTML element",t.htmlElement,e),this.reportMode&Amm.Builder.PROBLEM_HTML&&this._annotate(t,e)},_annotate:function(t,e){t.htmlElement.setAttribute("data-amm-warning",e)}},Amm.Builder.isPossibleBuilderSource=function(t){return!!t&&(!!t["Amm.Builder.Ref"]||("object"==typeof t&&"parentNode"in t&&"tagName"in t||(!!t.jquery||!("string"!=typeof t||!t.match(/^\<(?:.|[\n])*\>$/)))))},Amm.Builder.calcPrototypeFromSource=function(t,e,i){if(!t)throw Error("`builderSource` is required");var r;if("string"==typeof t)t.match(/\s*<(?:.|[\n])*>\s*$/)&&(e=!0),r=t;else if(t["Amm.Builder.Ref"])r=t.resolve();else{if(!t.tagName&&!t.jquery)throw Error("Unsupported builderSource type: "+Amm.describeType(t));r=t}var n=jQuery(r);if(!n.length)throw Error("Cannot resolve builderSource reference");void 0===e&&(e=void 0===n.attr("data-amm-dont-build")),e||(n=n.clone()),n.removeAttr("data-amm-dont-build");var s=new Amm.Builder(n),o=i?s.calcViewPrototypes():s.calcPrototypes(!0);if(!o.length)throw Error("Builder returned no prototypes");if(i)return o;if(1<o.length)throw Error("Builder returned more than one prototype");return o[0].class||(o[0].class="Amm.Element"),o[0]},Amm.View.Html.Default=function(t){Amm.View.Abstract.call(this,t),Amm.View.Html.call(this)},Amm.View.Html.Default.prototype={"Amm.View.Html.Default":"__CLASS__",_defaultViews:null,_replacedMyElement:!1,_ownHtmlElement:null,_viewHtmlElements:null,_replaceOwnHtmlElement:!0,reportMode:Amm.Builder.PROBLEM_CONSOLE|Amm.Builder.PROBLEM_HTML,setReplaceOwnHtmlElement:function(t){if(this._replaceOwnHtmlElement!==t){if(this._observing)throw new Error("Cannot Amm.View.Html.Default::setReplaceOwnHtmlElement() while getObserving()");return this._replaceOwnHtmlElement=t,!0}},getReplaceOwnHtmlElement:function(){return this._replaceOwnHtmlElement},getOwnHtmlElement:function(){return this._ownHtmlElement},setDefaultViews:function(){if(null!==this._defaultViews)throw Error("can setDefaultViews() only once, before element observation")},getDefaultViews:function(){return this._defaultViews?[].concat(this._defaultViews):[]},_observeElementIfPossible:function(){var t,e=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);if(!e)return e;if(!(t=this._defaultViews?this._defaultViews:this._element.constructDefaultViews())||"Array"==typeof t&&!t.length)return this.reportMode&Amm.Builder.PROBLEM_HTML&&this._htmlElement.setAttribute("data-amm-warning","Element has no default view(s)"),void(this.reportMode&Amm.Builder.PROBLEM_CONSOLE&&console.warn("Element has no default view(s): ",this._element));this._defaultViews=[],"Array"!=typeof t&&(t=[t]);for(var i=[],r=0,n=t.length;r<n;r++){var s,o=t[r];if(o){if("object"==typeof o&&("class"in o||Amm.is(o,"Amm.View.Abstract")))s=[o];else{if(!Amm.Builder.isPossibleBuilderSource(o))throw new Error("incorrect result returned by Amm.Element.consturctDefaultViews() - cannot construct view");s=Amm.Builder.calcPrototypeFromSource(o,!1,!0)}for(var a=0,h=s.length;a<h;a++){s[a]=Amm.constructInstance(s[a],null,{element:this._element},!0,["Amm.View.Html"]),this._defaultViews.push(s[a]);var l=s[a].getHtmlElement();l&&i.push(l)}}}return this._deleteNonTopNodes(i),this._setViewHtmlElements(i),e},_deleteNonTopNodes:function(t){for(var e=t.length-1;0<=e;e--)t[e].parentNode&&t[e].parentNode.tagName&&t.splice(e,1)},_replaceHtmlNodes:function(t,e){if(this._htmlElement===t[0]&&(this._ownHtmlElement||(this._ownHtmlElement=this._htmlElement),this._htmlElement=e[0]),t[0].parentNode){for(var i=e.length-1;0<=i;i--)t[0].parentNode.insertBefore(e[i],t[0]);for(i=0;i<t.length;i++)t[i].parentNode.removeChild(t[i])}},_setViewHtmlElements:function(t){var e,i=t;if(!this._replaceOwnHtmlElement)return this._replaceContents(t);i&&i.length||(i=this._ownHtmlElement?[this._ownHtmlElement]:[]),(e=this._viewHtmlElements)&&e.length||(e=[this._htmlElement]),Amm.Array.equal(e,i)||i.length&&(this._observing&&(e.length&&this._releaseDomNode(i),this._acquireDomNode(i)),e[0]!==this._htmlElement||this._ownHtmlElement||(this._ownHtmlElement=e[0]),this._replaceHtmlNodes(e,i),this._viewHtmlElements=t&&t.length?t:null,this._htmlElement=i[0])},_doSetHtmlElement:function(t,e){var i,r;t&&e&&this._observing&&(!(i=this._ownHtmlElement)||this._viewHtmlElements?(r=[].concat(this._viewHtmlElements),this._setViewHtmlElements([]),this._releaseResources(i),this._htmlElement=t,this._ownHtmlElement=null,this._setViewHtmlElements(r)):this._releaseDomNode(this._ownHtmlElement))},_replaceContents:function(t){for(var e,i=this._htmlElement.firstChild;i;)e=i.nextSibling,this._htmlElement.removeChild(i),i=e;if(this._viewHtmlElements=t||null,t)for(var r=0;r<t.length;r++)this._htmlElement.appendChild(t[r])},_releaseResources:function(){if(this._setViewHtmlElements([]),this._defaultViews){for(var t=0,e=this._defaultViews.length;t<e;t++)this._defaultViews[t].setElement(null),this._defaultViews[t].setHtmlElement(null),this._defaultViews[t].cleanup();this._defaultViews=null,Amm.View.Html.prototype._releaseResources.call(this)}}},Amm.extend(Amm.View.Html.Default,Amm.View.Html),Amm.extend(Amm.View.Html.Default,Amm.View.Abstract),Amm.View.Html.Select=function(t){Amm.View.Html.call(this),Amm.View.Abstract.Select.call(this,t)},Amm.View.Html.Select.prototype={"Amm.View.Html.Select":"__CLASS__",_fieldView:null,_collectionView:null,_createFieldView:function(){var t={getVReadOnly:this._fieldView_getVReadOnly,setVReadOnly:this._fieldView_setVReadOnly,htmlElement:this._htmlElement,getVValue:this._fieldView_getVValue,setVValue:this._fieldView_setVValue};this._fieldView=new Amm.View.Html.Input(t),(this._fieldView._selectView=this)._fieldView._receiveEvent=this._fieldView_receiveEvent},_fieldView_getVReadOnly:function(){return!1},_fieldView_setVReadOnly:function(t){},_fieldView_receiveEvent:function(t){if(this._element)return"change"===t.type&&this._element.getReadOnly()?(this.setVValue(this._element.getValue()),!0):Amm.View.Html.Input.prototype._receiveEvent.call(this,t)},_fieldView_setVValue:function(t){if(this._selectView._element){var e,i,r=this._selectView._collectionView;if(!r)return Amm.View.Html.Input.prototype.getVValue.call(this);if(this._element.getMultiple())for(e=0,i=this._htmlElement.options.length;e<i;e++){(n=r.getHtmlElementItem(this._htmlElement.options[e]))&&(this._htmlElement.options[e].selected=0<=Amm.Array.indexOf(n.getValue(),t))}else for(e=0,i=this._htmlElement.options.length;e<i;e++){var n=r.getHtmlElementItem(this._htmlElement.options[e]);this._htmlElement.options[e].selected=n.getValue()===t}}},_fieldView_getVValue:function(){if(void 0!==this._element.getOptions()||!this._htmlElement){var t=[],e=this._element.getMultiple(),i=this._selectView._collectionView;if(!i)return Amm.View.Html.Input.prototype.getVValue.call(this);for(var r=0,n=this._htmlElement.options.length;r<n;r++)if(this._htmlElement.options[r].selected){var s=i.getHtmlElementItem(this._htmlElement.options[r]);if(s){var o=s.getValue();if(!e)return o;t.push(o)}}return e?t:null}this._element.setOptions(this._detectOptions(this._htmlElement))},_detectOptions:function(t){jQuery(t);for(var e=[],i=0;i<t.options.length;i++){var r=t.options[i],n={label:jQuery(r).html(),value:r.value};r.disabled&&(n.disabled=!0),n.selected=!!r.selected,e.push(n)}return e},_createCollectionView:function(){void 0===this._element.getOptions()&&this._element.setOptions(this._detectOptions(this._htmlElement));var s=this,t={collectionProperty:"optionsCollection",htmlElement:this._htmlElement,createItemHtml:function(t){var e=jQuery("<option>"+t.getLabel()+"</option>"),i=t.getValue();return"object"!=typeof i?e.attr("value",i):e.removeAttr("value"),t.getDisabled()&&e.attr("disabled","disabled"),t.getSelected()&&e.attr("selected","selected"),t.getVisible()?e[0]:e.wrap("<span>").parent()[0]},updateItemHtml:function(t,e){var i=!1;"SPAN"===e.tagName&&(i=!0,e=e.firstChild);var r=!!t.getSelected();e.selected=r,e.disabled=s._element.getReadOnly()&&!r||!!t.getDisabled();var n=t.getValue();return"object"!=typeof n?e.value=n:e.removeAttribute("value"),jQuery(e).html(t.getLabel()),t.getVisible()?i&&e.parentNode.removeChild(e):e=i?e.parentNode:jQuery(e).wrap("<span></span>").parent()[0],e}};this._collectionView=new Amm.View.Html.Collection(t)},_doObserveSelect:function(){Amm.View.Abstract.Select.prototype._doObserveSelect.call(this),this._fieldView.setElement(this._element),this._collectionView.setElement(this._element)},_endObserve:function(){this._fieldView.setElement(null),this._collectionView.setElement(null)},setHtmlElement:function(t){return t&&"SELECT"!==t.tagName&&Error("<select> element must be provided"),Amm.View.Html.prototype.setHtmlElement.call(this,t)},_doSetHtmlElement:function(t,e){this._fieldView&&this._fieldView.setHtmlElement(this._htmlElement),this._collectionView&&this._collectionView.setHtmlElement(this._htmlElement)},getVMultiple:function(){var t=jQuery(this._htmlElement);if(t[0])return!!t.attr("multiple")},setVMultiple:function(t){var e=jQuery(this._htmlElement);e[0]&&e.attr("multiple",t?"multiple":null)},setVReadOnly:function(t){this._collectionView&&this._collectionView.refreshAllItems()},getVSelectSize:function(){var t=jQuery(this._htmlElement);if(t[0])return t[0].size||1},setVSelectSize:function(t){var e=jQuery(this._htmlElement);e[0]&&e.attr("size",t)},getSuggestedTraits:function(){return[Amm.Trait.Select]}},Amm.extend(Amm.View.Html.Select,Amm.View.Html),Amm.extend(Amm.View.Html.Select,Amm.View.Abstract.Select),Amm.View.Html.Expressions=function(t){Amm.View.Abstract.call(this,t),Amm.View.Html.call(this,t)},Amm.View.Html.Expressions.TARGET_TYPE={HTML:"Html",CLASS:"Class",STYLE:"Style",ATTR:"Attr"},Amm.View.Html.Expressions.IDX={TYPE:0,TARGET:1,SOURCE_OBJECT:2,IDX:3},Amm.View.Html.Expressions.prototype={"Amm.View.Html.Expressions":"__CLASS__",_links:null,updateWhenEmpty:!1,_subbed:!1,_jqHtmlElement:null,setMap:function(t){if(!t||"object"!=typeof t)throw Error("map must be a non-null object");if(null!==this._links)throw Error("can setMap() only once");for(var e in this._links=[],t)t.hasOwnProperty(e)&&this._createLink(e,t[e])},_createLink:function(t,e){var i,r,n,s="_html"===t?(i=Amm.View.Html.Expressions.TARGET_TYPE.HTML,""):"class__"===t.slice(0,7)?(i=Amm.View.Html.Expressions.TARGET_TYPE.CLASS,t.slice(7)):"style__"===t.slice(0,7)?(i=Amm.View.Html.Expressions.TARGET_TYPE.STYLE,t.slice(7)):(i=Amm.View.Html.Expressions.TARGET_TYPE.ATTR,t);if("object"==typeof e)r=Amm.constructInstance(e,"Amm.Expression");else if("function"==typeof e)r=new Amm.Expression.FunctionHandler(e);else{if("string"!=typeof e)throw Error("Map entry '"+t+" must be object, function or string; given: "+Amm.describeType(e));r="j"===e[0]&&"javascript:"===e.slice(0,11)?new Amm.Expression.FunctionHandler(e.slice(11)):e.match(/^\w+$/)?e:new Amm.Expression(e)}n=[i,s,r,this._links.length],r["Amm.WithEvents"]&&r.subscribe("valueChange",this._handleChange,this,n),this._links.push(n)},_doSetHtmlElement:function(t,e){Amm.View.Html.prototype._doSetHtmlElement.call(this,t,e),this._jqHtmlElement=t?jQuery(t):null},_observeElementIfPossible:function(){var t=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);return t&&this._subscribe(),t},_endObserve:function(){var t=Amm.View.Abstract.prototype._endObserve.call(this);return this._unsubscribe(),t},_subscribe:function(){var t=this._element;this._subbed=!0;for(var e=0,i=this._links.length;e<i;e++){var r=this._links[e][Amm.View.Html.Expressions.IDX.SOURCE_OBJECT];if("string"==typeof r){var n=r+"Change";if(!t.hasEvent(n))continue;t.subscribe(n,this._handleChange,this,this._links[e]),this._handleChange(Amm.getProperty(t,r),void 0,this._links[e])}else r.setExpressionThis(t),this._handleChange(r.getValue(),void 0,this._links[e])}},_unsubscribe:function(){this._subbed=!1;for(var t=this._element,e=0,i=this._links.length;e<i;e++){var r,n=this._links[e][Amm.View.Html.Expressions.IDX.SOURCE_OBJECT];"string"==typeof n?(r=n+"Change",t.unsubscribe(r,this._handleChange,this,this._links[e])):n.setExpressionThis(null)}},_handleChange:function(t){var e=arguments[arguments.length-1],i=e[Amm.View.Html.Expressions.IDX.TYPE],r=e[Amm.View.Html.Expressions.IDX.TARGET];this._jqHtmlElement&&(this._subbed||this.updateWhenEmpty)&&this._applyTarget(this._jqHtmlElement,i,r,t)},_applyTarget:function(t,e,i,r){this["_assign"+e](t,i,r)},_assignHtml:function(t,e,i){t.html(i)},_assignAttr:function(t,e,i){t.attr(e,i)},_assignStyle:function(t,e,i){t.css(e,i)},_assignClass:function(t,e,i){i?t.addClass(e):t.removeClass(e)},_cleanup_AmmViewHtmlExpressions:function(){for(var t=0,e=this._links.length;t<e;t++){var i=this._links[t][Amm.View.Html.Expressions.IDX.SOURCE_OBJECT];i.cleanup&&i.cleanup()}this._links=null}},Amm.extend(Amm.View.Html.Expressions,Amm.View.Html),Amm.extend(Amm.View.Html.Expressions,Amm.View.Abstract),Amm.Root=function(t){Amm.augment(this,Amm.Trait.Component),Amm.Element.call(this,t)},Amm.Root.prototype={"Amm.Root":"__CLASS__",_id:"^",_internalId:"root",_intervalDelay:250,_interval:null,_counter:0,strictEvents:!1,setId:function(t){"^"!==t&&Error("Cannot setId() of root to anything other than '^'")},raiseEvent:function(t){var e=Array.prototype.slice.call(arguments,0),i=this._out.apply(this,e);return"bootstrap"===t&&Amm.getBootstrapped()&&delete this._subscribers.bootstrap,i},outInterval:function(){this._out("interval",this._counter++)},_subscribeFirst_bootstrap:function(){Amm.getBootstrapped()&&this.raiseEvent("bootstrap")},_subscribeFirst_interval:function(){var t=this;this._interval=window.setInterval(function(){t.outInterval()},this._intervalDelay)},_unsubscribeLast_interval:function(){this._interval&&(window.clearInterval(this._interval),this._interval=null)},subscribe:function(t,e,i,r,n){return Amm.itemDebugTag&&Amm.itemDebugTag.length&&Amm.getClass(i)&&(i._root_sub||(i._root_sub={}),i._root_sub[t]=Amm.itemDebugTag[Amm.itemDebugTag.length-1]),Amm.WithEvents.prototype.subscribe.call(this,t,e,i,r,n)}},Amm.extend(Amm.Root,Amm.Element),Amm.Trait={},Amm.Trait.Field=function(){this._validators=[]},Amm.Trait.Field.VALIDATE_NEVER=0,Amm.Trait.Field.VALIDATE_BLUR=1,Amm.Trait.Field.VALIDATE_CHANGE=2,Amm.Trait.Field.VALIDATE_BLUR_CHANGE=3,Amm.Trait.Field.VALIDATE_EXPRESSIONS=4,Amm.Trait.Field.VALIDATE_INSTANT=8,Amm.Trait.Field.TRANSLATION_ERROR_IN=1,Amm.Trait.Field.TRANSLATION_ERROR_OUT=-1,Amm.Trait.Field.prototype={Field:"__INTERFACE__",_form:null,_fieldName:void 0,_fieldLabel:void 0,_validators:null,_validateMode:Amm.Trait.Field.VALIDATE_CHANGE|Amm.Trait.Field.VALIDATE_EXPRESSIONS,_fieldLocalErrors:void 0,_fieldRemoteErrors:void 0,_fieldErrors:void 0,_needValidate:!1,_fieldApplied:!0,_fieldRequired:void 0,fieldRequiredMessage:"lang.Amm.Validator.Required.msg",_fieldRequiredValidator:null,_fieldEmpty:void 0,_fieldValue:void 0,_fieldSyncsValue:!1,_lockFieldValueChange:0,_lockAnnotationSync:0,_fieldTranslator:null,_translationErrorState:null,_fieldSyncWithAnnotations:!0,_fieldInSyncWithAnnotations:!1,_initValidationExpressions:null,_validationExpressions:null,_fieldIndex:void 0,__augment:function(t,e){Amm.Element.regInit(this,"99.Amm.Trait.Field",function(){var t;this._fieldSyncsValue=!!Amm.detectProperty(this,"value"),this._fieldSyncsValue&&this.subscribe("valueChange",this._handleFormExtValueChange,this),Amm.detectProperty(this,"focused")&&this.subscribe("focusedChange",this._handleFieldFocusedChange,this),"__INTERFACE__"===this.Annotated&&this._fieldSyncWithAnnotations&&this._syncWithAnnotations(),this._fieldSyncsValue&&(void 0===this._fieldValue?void 0!==(t=this.getValue())&&this._handleFormExtValueChange(t,void 0):this._syncFieldValueToElement(this._fieldValue))})},_syncWithAnnotations:function(){this._fieldInSyncWithAnnotations||(this.subscribe("requiredChange",this._handleSelfAnnotationRequiredChange,this),this.subscribe("labelChange",this._handleSelfAnnotationLabelChange,this),this.subscribe("errorChange",this._handleSelfAnnotationErrorChange,this),this._fieldInSyncWithAnnotations=!0),void 0!==this._fieldRequired?this.setRequired(this._fieldRequired):void 0!==this._required&&this.setFieldRequired(this._required),void 0!==this._fieldLabel?this.setLabel(this._fieldLabel):void 0!==this._label&&this.setFieldLabel(this._label),void 0!==this._fieldErrors?this.setError(this._fieldErrors):void 0!==this._error&&this.setFieldRemoteErrors(this._error)},getFieldSyncsValue:function(){return this._fieldSyncsValue},_handleSelfAnnotationRequiredChange:function(t,e){this._lockAnnotationSync||this._fieldInSyncWithAnnotations&&void 0===this._fieldRequired&&this.setFieldRequired(t)},_handleSelfAnnotationLabelChange:function(t,e){this._lockAnnotationSync||this._fieldInSyncWithAnnotations&&void 0===this._fieldLabel&&this.setFieldLabel(t)},_handleSelfAnnotationErrorChange:function(t,e){this._lockAnnotationSync||this._fieldInSyncWithAnnotations&&void 0===this._fieldLocalErrors&&this.setFieldLocalErrors(t)},setForm:function(t){t?Amm.is(t,"Form","form"):t=null;var e,i=this._form;if(i!==t)return!i||0<=(e=i.fields.strictIndexOf(this))&&i.fields.removeAtIndex(e),t&&t.fields.strictIndexOf(this)<0&&t.fields.accept(this),this._form=t,this._callOwnMethods("_setForm_",this._form,i),this.outFormChange(t,i),!0},outFormChange:function(t,e){return this._out("formChange",t,e)},getForm:function(){return this._form},setFieldName:function(t){var e=this._fieldName;if(e!==t)return this._fieldName=t,this.outFieldNameChange(t,e),!0},getFieldName:function(){return void 0===this._fieldName?this._id:this._fieldName},_setId_Field:function(t,e){void 0===this._fieldName&&this.outFieldNameChange(t,e)},outFieldNameChange:function(t,e){this._callOwnMethods("_fieldNameChange_",t,e),this._out("fieldNameChange",t,e)},setFieldIndex:function(t){var e=this._fieldIndex;if(e!==t)return this._fieldIndex=t,this.outFieldIndexChange(t,e),!0},getFieldIndex:function(){return this._fieldIndex},outFieldIndexChange:function(t,e){this._out("fieldIndexChange",t,e)},setFieldLabel:function(t){var e=this._fieldLabel;if(e!==t)return this._fieldLabel=t,this._fieldTranslator&&this._fieldTranslator.field===e&&(this._fieldTranslator.field=t),this._fieldLocalErrors&&this._revalidate(),this._fieldInSyncWithAnnotations&&!this._lockAnnotationSync&&this.hasAnnotation("label")&&(this._lockAnnotationSync++,this.setLabel(this._fieldLabel),this._lockAnnotationSync--),this.outFieldLabelChange(t,e),!0},getFieldLabel:function(){return this._fieldLabel},outFieldLabelChange:function(t,e){return this._out("fieldLabelChange",t,e)},setValidators:function(t){if(Amm.cleanup(!0,this.validators),this._validators=[],t){t instanceof Array||Error("`validators` must be an Array");for(var e=0;e<t.length;e++){var i=Amm.Validator.construct(t[e]);"function"==typeof i.setElement?i.setElement(this):"element"in i&&(i.element=this),this._validators.push(i)}this.setNeedValidate(!0)}},validate:function(t){if(!this._fieldApplied)return!t||[];if(this._translationErrorState)return!!t&&(this._fieldLocalErrors?[].concat(this._fieldLocalErrors):[]);var e=[],i=this.getFieldEmpty(),r=this.getFieldValue(),n=this.getFieldLabel();return this._doValidate(e,r,i,n),t?e:(this.setFieldLocalErrors(e),this.setNeedValidate(!1),this.outAfterFieldValidate(!e.length,e),!e.length)},outAfterFieldValidate:function(t,e){return this._out("afterFieldValidate",t,e)},_doValidate:function(t,e,i,r){var n;if(this._fieldRequiredValidator?i=!!(n=this._fieldRequiredValidator.getError(e,this.getFieldLabel()))&&(this._fieldRequired&&t.push(n),!0):i&&this._fieldRequired&&t.push(Amm.translate(this.fieldRequiredMessage,"%field",r)),!i){this.outOnValidate(e,t),this._validationExpressions&&this._applyValidationExpressions(t);for(var s=0;s<this._validators.length;s++)(n=this._validators[s].getError(e,r))&&t.push(n)}},_revalidate:function(){var t;this._fieldSyncsValue&&this._translationErrorState===Amm.Trait.Field.TRANSLATION_ERROR_IN?(t=this.getValue(),this._handleFormExtValueChange(t,t)):this._fieldSyncsValue&&this._translationErrorState===Amm.Trait.Field.TRANSLATION_ERROR_OUT?this._syncFieldValueToElement(this._fieldValue):this.validate()},outOnValidate:function(t,e){return this._out("onValidate",t,e)},getValidators:function(){return this._validators},setValidateMode:function(t){if(this._validateMode!==t)return this._validateMode=t,this._needValidate&&t&Amm.Trait.Field.VALIDATE_INSTANT&&this.validate(),!0},getValidateMode:function(){return this._validateMode},_setFieldErrorsArray:function(t,e,i){var r=this[t],n=!1;if(e?e instanceof Array?e.length||(e=null):e=[e]:void 0!==e&&(e=null),i&&this[t]){if(!e)return!1;var s=Amm.Array.diff(e,this[t]);if(!s.length)return!1;e=[].concat(this[t],s)}else r instanceof Array&&e instanceof Array&&(r.length!==e.length||Amm.Array.symmetricDiff(r,e).length||Amm.Array.symmetricDiff(e,r).length||(n=!0));return r!==e&&!n&&(this[t]=e,r)},_updateFieldErrors:function(){var t=this._fieldErrors;this._fieldErrors=[].concat(this.getFieldLocalErrors()||[],this._fieldRemoteErrors||[]),this._fieldErrors=Amm.Array.unique(this._fieldErrors),this._fieldErrors.length||(this._fieldErrors=null),t===this._fieldErrors||t&&this._fieldErrors&&Amm.Array.equal(this._fieldErrors,t)?this._fieldErrors=t:(this.outFieldErrorsChange(this._fieldErrors,t),this._fieldInSyncWithAnnotations&&!this._lockAnnotationSync&&this.hasAnnotation("error")&&(this._lockAnnotationSync++,this.setError(this._fieldErrors&&this._fieldErrors.length?[].concat(this._fieldErrors):null),this._lockAnnotationSync--))},getFieldErrors:function(){return this._fieldApplied?(this._fieldErrors||(this._fieldErrors=[].concat(this.getFieldLocalErrors()||[],this._fieldRemoteErrors||[]),this._fieldErrors=Amm.Array.unique(this._fieldErrors)),this._fieldErrors&&this._fieldErrors.length?[].concat(this._fieldErrors):null):[]},setFieldErrors:function(t,e){e||this.setFieldRemoteErrors(null),this.setFieldLocalErrors(t,e)},outFieldErrorsChange:function(t,e){return this._out("fieldErrorsChange",t,e)},setFieldLocalErrors:function(t,e){var i=this._setFieldErrorsArray("_fieldLocalErrors",t,e);return this._updateFieldErrors(),this.outFieldLocalErrorsChange(t,i),!0},getFieldLocalErrors:function(){return this._fieldApplied?(void 0===this._fieldLocalErrors&&this.validate(),this._fieldLocalErrors?[].concat(this._fieldLocalErrors):null):[]},outFieldLocalErrorsChange:function(t,e){this._out("fieldLocalErrorsChange",t,e)},setFieldRemoteErrors:function(t,e){var i=this._setFieldErrorsArray("_fieldRemoteErrors",t,e);if(!1!==i)return this._updateFieldErrors(),this.outFieldRemoteErrorsChange(t,i),!0},getFieldRemoteErrors:function(){return this._fieldApplied?(void 0===this._fieldRemoteErrors&&this.validate(),this._fieldRemoteErrors?[].concat(this._fieldRemoteErrors):null):[]},outFieldRemoteErrorsChange:function(t,e){this._out("fieldRemoteErrorsChange",t,e)},setFieldApplied:function(t){t=!!t;var e=this._fieldApplied;if(e!==t)return this._fieldApplied=t,this.outFieldAppliedChange(t,e),this.setNeedValidate(!0),!0},outFieldAppliedChange:function(t,e){this._out("fieldAppliedChange",t,e)},getFieldApplied:function(){return this._fieldApplied},setFieldSyncWithAnnotations:function(t){if(t=!!t,this._fieldSyncWithAnnotations!==t)return this._fieldSyncWithAnnotations=t,this._fieldSyncWithAnnotations&&this._syncWithAnnotations(),!0},getFieldSyncWithAnnotations:function(){return this._fieldSyncWithAnnotations},getFieldInSyncWithAnnotations:function(){return this._fieldInSyncWithAnnotations},setFieldRequired:function(t){t=!!t;var e=this._fieldRequired;if(e!==t)return this._fieldRequired=t,this._fieldInSyncWithAnnotations&&!this._lockAnnotationSync&&this.hasAnnotation("required")&&(this._lockAnnotationSync++,this.setRequired(this._fieldRequired),this._lockAnnotationSync--),this.outFieldRequiredChange(t,e),this.setNeedValidate(!0),!0},outFieldRequiredChange:function(t,e){return this._out("fieldRequiredChange",t,e)},getFieldRequired:function(){return this._fieldRequired},setFieldRequiredValidator:function(t){if(this._fieldRequiredValidator!==t)return t&&(t="function"==typeof t?new Amm.Validator.Function({func:t}):Amm.constructInstance(t,"Amm.Validator"),Amm.setField(t,"element",this)),this._fieldRequiredValidator=t,this.setNeedValidate(!0),!0},getFieldRequiredValidator:function(){return this._fieldRequiredValidator},setFieldEmpty:function(t){var e=this._fieldEmpty;if(e!==t)return this._fieldEmpty=t,this.outFieldEmptyChange(t,e),!0},_handleFormExtValueChange:function(t,e){var i,r;this._lockFieldValueChange||(this._lockFieldValueChange=1,this._translationErrorState=0,i={},r=t,this._fieldTranslator&&(r=this._fieldTranslator.translateIn(t,i)),i.error?this._setInTranslationErrorState(r,i.error):this.setFieldValue(r),this._lockFieldValueChange=0)},setFieldValue:function(t){var e=this._fieldValue;if(e!==t)return this._fieldValue=t,this.setFieldEmpty(this._isFieldEmpty(t)),this.setNeedValidate(!0),this.outFieldValueChange(t,e),this._validateMode&Amm.Trait.Field.VALIDATE_CHANGE&&this._needValidate&&this.validate(),!this._lockFieldValueChange&&this._fieldSyncsValue&&this._syncFieldValueToElement(t),!0},_syncFieldValueToElement:function(t){var e,i;!this._lockFieldValueChange&&this._fieldSyncsValue&&(this._translationErrorState=0,this._lockFieldValueChange=1,e=t,i={},this._fieldTranslator&&(e=this._fieldTranslator.translateOut(t,i)),i.error?this._setOutTranslationErrorState(e,i.error):this.setValue(e),this._lockFieldValueChange=0)},_setInTranslationErrorState:function(t,e){this._translationErrorState=Amm.Trait.Field.TRANSLATION_ERROR_IN,this.setFieldValue(t),this.setFieldLocalErrors(e,!1)},_setOutTranslationErrorState:function(t,e){this._translationErrorState=Amm.Trait.Field.TRANSLATION_ERROR_OUT,this.setValue(t),this.setFieldLocalErrors(e,!1)},getFieldValue:function(){return this._fieldValue},outFieldValueChange:function(t,e){this._out("fieldValueChange",t,e)},_handleFieldFocusedChange:function(t,e){e&&this._needValidate&&!t&&this._validateMode&Amm.Trait.Field.VALIDATE_BLUR&&this.validate()},_isFieldEmpty:function(t){return null==t||""===t},getFieldEmpty:function(){var t;return void 0===this._fieldEmpty&&(t=this._isFieldEmpty(this.getFieldValue()),this.setFieldEmpty(t)),this._fieldEmpty},outFieldEmptyChange:function(t,e){this._out("fieldEmptyChange",t,e)},setNeedValidate:function(t){if(t=!!t,this._needValidate!==t){var e=this._needValidate;return this._needValidate=t,this._out("needValidateChange",t,e),(t&&this._validateMode&Amm.Trait.Field.VALIDATE_INSTANT||this._fieldLocalErrors&&this._validateMode)&&this.validate(),!0}},outNeedValidateChange:function(t,e){this._out("needValidateChange",t,e)},getNeedValidate:function(){return this._needValidate},setFieldTranslator:function(t){if(t=t?Amm.constructInstance(t,"Amm.Translator"):null,this._fieldTranslator!==t)return t&&void 0===t.field&&(t.field=this.getFieldLabel()),this._fieldTranslator=t,this._translationErrorState&&this._revalidate(),!0},getFieldTranslator:function(){return this._fieldTranslator},getTranslationErrorState:function(){return this._translationErrorState},setValidationExpressions:function(t){if(this._validationExpressions&&Amm.cleanup(this._validationExpressions),this._validationExpressions=null,t){if(!(t instanceof Array))throw Error("`validationExpressions` must be an Array or FALSEable, provided: "+Amm.describeType(t));if(t.length){this._validationExpressions=[];for(var e=0,i=t.length;e<i;e++){var r=this._createExpression(t[e]);this._validationExpressions.push(r),r.subscribe("valueChange",this._handleValidationExpressionChange,this,e)}}}},_handleValidationExpressionChange:function(t,e){this.setNeedValidate(!0),this._needValidate&&this._validateMode&Amm.Trait.Field.VALIDATE_EXPRESSIONS&&this.validate()},_applyValidationExpressions:function(t){if(this._validationExpressions)for(var e=this.getFieldLabel(),i=0,r=this._validationExpressions.length;i<r;i++){var n,s=this._validationExpressions[i].getValue();s&&(n=Amm.translate(s+"","%field",e),t.push(n))}}},Amm.Trait.Form=function(t){Amm.Trait.Field.call(this,t)},Amm.Trait.Form.prototype={Form:"__INTERFACE__",invalidFieldsMessage:"lang.Amm.Trait.Form.invalidFieldsMsg",fields:null,_setFormFields:null,_elementsAreFields:!0,_displayChildrenAreFields:!0,_fieldsUpdateLevel:0,_fieldMap:null,_setFieldMap:null,_fieldsChanged:!1,_lastNum:null,_beginUpdateFields:function(){this._fieldsUpdateLevel++,this.fields.beginUpdate()},_endUpdateFields:function(){this._fieldsUpdateLevel||Error("Call to _endUpdateFields() w/o corresponding _beginUpdateFields()"),this.fields.endUpdate(),this._fieldsUpdateLevel--,!this._fieldsUpdateLevel&&this._fieldsChanged&&(this._fieldsChanged=!1,this._recalcFields())},__augment:function(t,e){Amm.Trait.Field.prototype.__augment.call(this,t,e);var i={indexProperty:"fieldIndex",assocProperty:"form",assocInstance:this,assocEvents:{fieldNameChange:this._softRecalc,fieldValueChange:this._softRecalc,fieldAppliedChange:this._softRecalc,needValidateChange:this._fieldNeedValidate},on__spliceItems:[this._softRecalc,this]};this._setFormFields&&(i.items=this._setFormFields.slice(),this._setFormFields=null),"fieldsPrototype"in e&&("object"==typeof e.fieldsPrototype&&e.fieldsPrototype&&Amm.override(i,e.fieldsPrototype),delete e.fieldsPrototype),this.fields=new Amm.Collection(i),Amm.Element.regInit(this,"99.Amm.Trait.Form",function(){this._beginUpdateFields(),this._elementsAreFields&&this.setElementsAreFields(!0,!0),this._displayChildrenAreFields&&this.setDisplayChildrenAreFields(!0,!0),this._endUpdateFields()})},_softRecalc:function(){this._recalcFields()},_fieldNeedValidate:function(t){this.setNeedValidate(!0)},_recalcFields:function(t){if(this._fieldsUpdateLevel&&!t)return this._fieldsChanged=!0;var e={},i=[],r=0,n=0,s=this._fieldsChanged=!1,o=!this._fieldValue,a=0;this._fieldMap={},this._setFieldMap={};for(var h=0,l=this.fields.length;h<l;h++){var u=this.fields[h],c=u.getFieldValue(),m=u.getFieldName();if(null==m){if(this._setFieldMap[n]=u,n++,!u.getFieldApplied())continue;a++,i.push(c),e[r]=c,this._fieldMap[r]=u,o||this._fieldValue[r]===c||(o=!0),r++}else{if(!(this._setFieldMap[m]=u).getFieldApplied())continue;a++,s=!0,e[m]=c,this._fieldMap[m]=u,o||this._fieldValue[m]===e[m]||(o=!0)}}if(o||a!==this._lastNum){this._lastNum=a;var _=this._fieldValue;return this._fieldValue=s?e:i,window.Object&&window.Object.freeze&&window.Object.freeze(this._fieldValue),this.outFieldValueChange(this._fieldValue,_),!0}},_addFields:function(t){for(var e=t.slice(),i=e.length-1;0<=i;i--)"__INTERFACE__"!==e[i].Field&&e.splice(i,1);return(e=Amm.Array.diff(e,this.fields)).length&&(1<e.length&&this._beginUpdateFields(),this.fields.acceptMany(e),1<e.length&&this._endUpdateFields()),e},_delFields:function(t,e,i){for(var r=[],n=0,s=t.length;n<s;n++)"__INTERFACE__"===t[n].Field&&r.push(t[n]);if(e&&r.length&&this._elementsAreFields&&this.Component&&this._elements.length&&(r=Amm.Array.diff(r,this._elements)),i&&r.length&&this._displayChildrenAreFields&&this.DisplayParent&&this.displayChildren.length&&(r=Amm.Array.diff(r,this.displayChildren)),r.length){this._beginUpdateFields();for(var o=[],n=0,s=r.length;n<s;n++){var a=this.fields.indexOf(r[n]);0<=a&&(this.fields.removeAtIndex(a),o.push(r[n]))}return this._endUpdateFields(),o}},setElementsAreFields:function(t,e){if(t=!!t,this._elementsAreFields!==t||e){if(this._elementsAreFields=t,!this.fields||"__INTERFACE__"!==this.Component)return!0;var i=t?"subscribe":"unsubscribe";return this[i]("acceptedElements",this._handleFieldComponentAcceptedElements,this),this[i]("rejectedElements",this._handleFieldComponentRejectedElements,this),this._elements.length&&(t?this._addFields(this._elements):this._delFields(this._elements,!1,!0)),!0}},_handleFieldComponentAcceptedElements:function(t){this._addFields(t)},_handleFieldComponentRejectedElements:function(t){t.length&&this._displayChildrenAreFields&&this.DisplayParent&&this.displayChildren.length&&(t=Amm.Array.diff(t,this.displayChildren)),t.length&&this._delFields(t,!1,!0)},getElementsAreFields:function(){return this._elementsAreFields},setDisplayChildrenAreFields:function(t,e){if(t=!!t,this._displayChildrenAreFields!==t||e){if(this._displayChildrenAreFields=t,!this.fields||"__INTERFACE__"!==this.DisplayParent)return!0;var i=t?"subscribe":"unsubscribe";return this.displayChildren[i]("spliceItems",this._handleFieldDisplayChildrenSpliceItems,this),this.displayChildren.length&&(t?this._addFields(this.displayChildren):this._delFields(this.displayChildren,!0,!1)),!0}},_handleFieldDisplayChildrenSpliceItems:function(t,e,i){var r=Amm.Array.symmetricDiff(e,i),n=Amm.Array.symmetricDiff(i,e);r.length&&n.length&&this._beginUpdateFields(),r.length&&this._delFields(r,!0,!1),n.length&&this._addFields(n),r.length&&n.length&&this._endUpdateFields()},getDisplayChildrenAreFields:function(){return this._displayChildrenAreFields},_cleanup_Model:function(){this.fields.cleanup()},_acquirePossibleFields:function(t){pp=[];for(var e=0,i=t.length;e<i;e++){var r=t[e];r&&"__INTERFACE__"===r.Field&&(!r._parentModel&&r!==this||pp.push(r))}pp.length&&this.fields.push.apply(this.fields,pp)},setFields:function(t){if(this.fields){var e=Amm.Array.diff(this.fields,t),i=Amm.Array.diff(t,this.fields);(e.length||i.length)&&(this._beginUpdateFields(),e.length&&this._delFields(e,!0,!0),t.length&&this.fields.acceptMany(t),this._endUpdateFields())}else if(this._setFormFields){if(t){if(!(t instanceof Array||t["Amm.Array"]))throw Error("`fields` must be an Array or Amm.Array")}else this._setFormFields=null;this._setFormFields=t}else this._setFormFields=t},getFields:function(){return this.fields?this.fields:(this._setFormFields||(this._setFormFields=[]),this._setFormFields)},_parseKeyArgs:function(t,e,i){var r=e[t];if(void 0!==r){var n,s=r;return e.length>t+1&&(s instanceof Array||(s=[s]),s=s.concat(Array.prototype.slice.call(e,t+1))),s instanceof Array?(n=s.shift(),s.length||(s=void 0)):(n=s,s=void 0),[i?this._setFieldMap[n]:this._fieldMap[n],n,s]}},setFieldValue:function(t,e){if(this._fieldMap||this._recalcFields(!0),void 0!==e){var i=this._parseKeyArgs(1,arguments,!0),r=i[0];return r?r.setFieldValue(t,i[2]):void 0}if(this._beginUpdateFields(),"object"!=typeof t||!t)throw Error("`value` must be a hash or an Array; provided: "+Amm.describeType(t));for(var n in t)t.hasOwnProperty(n)&&this._setFieldMap[n]&&this._setFieldMap[n].setFieldValue(t[n]);this._endUpdateFields()},getFieldValue:function(t){if(void 0===this._fieldValue&&this._recalcFields(!0),void 0===t)return this._fieldValue;var e=this._parseKeyArgs(0,arguments,!1),i=(e[0],e[1]),r=e[2],n=this._fieldValue[i];if(r){do{var s=r.shift(),n="object"==typeof n&&(n instanceof Array||n)&&s in n?n[s]:void 0}while(r.length);r.length&&(n=void 0)}return n},_doValidate:function(t,e,i,r){Amm.Trait.Field.prototype._doValidate.call(this,t,e,i,r);for(var n=!1,s=0,o=this.fields.length;s<o;s++)this.fields[s].validate()||(n=!0);n&&t.push(Amm.translate(this.invalidFieldsMessage,"%field",r||Amm.translate("lang.Amm.Trait.Form.form")))}},Amm.extend(Amm.Trait.Form,Amm.Trait.Field),Amm.defineLangStrings({"lang.Amm.Trait.Form.invalidFieldsMsg":"One or more fields of %field are filled with errors","lang.Amm.Trait.Form.form":"the form"}),Amm.Trait.Instantiator=function(){},Amm.Trait.Instantiator.prototype={Instantiator:"__INTERFACE__",InstantiatorOrRepeater:"__INTERFACE__",__augment:function(t,e){Amm.Element.regInit(this,"99.Amm.Trait.Instantiator",function(){if("__INTERFACE__"!==this.DisplayParent)throw Error("Instantiator must be also a DisplayParent")}),e&&e.initialInstantiatorOptions&&(this._reportedInstantiatorOptions=e.initialInstantiatorOptions,delete e.initialInstantiatorOptions)},_instantiator:null,_src:null,_dest:null,_instantiatorOptions:null,_reportedInstantiatorOptions:null,_construct:function(){var t;this._instantiator&&this._src&&(t=this._instantiator.construct(this._src),this.setDest(t))},_destruct:function(){this._dest&&(this._dest.setDisplayParent(null),this._instantiator&&this._instantiator.destruct(this._dest),this._dest=null)},setInstantiator:function(t){t=t?Amm.constructInstance(t,"Amm.Instantiator"):null;var e=this._instantiator;if(e!==t)return e&&e["Amm.WithEvents"]&&e.unsubscribe("needRebuild",this._handleInstantiatorNeedRebuild,this),(this._instantiator=t)&&t["Amm.WithEvents"]&&t.hasEvent("needRebuild")&&t.subscribe("needRebuild",this._handleInstantiatorNeedRebuild,this),this._reportedInstantiatorOptions=null,this._destruct(),this.outInstantiatorChange(t,e),this._construct(),!0},getInstantiator:function(){return this._instantiator},outInstantiatorChange:function(t,e){this._out("instantiatorChange",t,e)},setSrc:function(t){var e=this._src;if(e!==t)return this._src=t,this._construct(),this.outSrcChange(t,e),!0},getSrc:function(){return this._src},outSrcChange:function(t,e){this._out("srcChange",t,e)},setDest:function(t){var e=this._dest;if(e!==t)return t&&Amm.is(t,"Visual","dest"),this._destruct(),this._dest=t,this._dest&&this._dest.setDisplayParent(this),this.outDestChange(t,e),!0},getDest:function(){return this._dest},outDestChange:function(t,e){this._out("destChange",t,e)},_handleInstantiatorNeedRebuild:function(t,e,i){this._src&&i===this._instantiator&&(Amm.Array.indexOf(this._src,t)<0||this._construct())},_cleanup_Instantiator:function(){this.setInstantiator(null),this.setSrc(null)},setInstantiatorOptions:function(t){if(t=t||null,this._instantiatorOptions!==t)return this._instantiatorOptions=t,this._reportedInstantiatorOptions&&this.reportInstantiatorOptions.apply(this,this._reportedInstantiatorOptions),!0},getInstantiatorOptions:function(){return this._instantiatorOptions},reportInstantiatorOptions:function(t,e,i){var r;this._reportedInstantiatorOptions=[t,e,i],r=e&&e.length?{class:Amm.Instantiator.Variants,defaultPrototype:t,filter:{conditions:e},prototypes:i,allowNullInstance:!0}:{class:Amm.Instantiator.Proto,proto:t},this._instantiatorOptions&&(r=Amm.overrideRecursive(r,this._instantiatorOptions)),this.setInstantiator(Amm.constructInstance(r,Amm.Instantiator.Abstract))}},Amm.Trait.Annotated=function(){this._defaultAnnotations=["label","description","required","error"]},Amm.Trait.Annotated.annotationElementDefaults={BASE:{traits:["Amm.Trait.Content","Amm.Trait.Visual"]},required:{contentTranslator:{class:"Amm.Translator.RequiredMark"}},error:{contentTranslator:{class:"Amm.Translator.Errors"}}},Amm.Trait.Annotated.mergePrototypes=function(t,e,i,r){var n,s;return t&&e&&e in t&&(n=t[e]),e?t&&e in t&&(n=t[e]):n=t,r?i&&r in i&&(s=i[r]):s=i,null===s?null:s?!n||"object"!=typeof s||"object"!=typeof n?s:Amm.override({},n,s):n},Amm.Trait.Annotated.prototype={Annotated:"__INTERFACE__",_defaultAnnotations:null,_label:void 0,_description:void 0,_required:void 0,_error:void 0,annotationElementDefaults:null,_annotationsContainer:void 0,getAnnotationsContainer:function(){return void 0===this._annotationsContainer&&(0,this._annotationsContainer=new Amm.Trait.Annotated.Container({id:"annotations",component:this.getClosestComponent(),element:this}),this._assignDefaultAnnotations()),this.subscribe("closestComponentChange",this._annotated_onSelfClosestComponentChange,this),this._annotationsContainer},_annotated_onSelfClosestComponentChange:function(t){this._annotationsContainer&&this._annotationsContainer.setComponent(t)},getAnnotationElementPrototype:function(t){var e=Amm.Trait.Annotated.annotationElementDefaults,i=this.annotationElementDefaults,r=Amm.Trait.Annotated.mergePrototypes(e,"BASE",i,"BASE"),n=Amm.Trait.Annotated.mergePrototypes(e,t,i,t),s=Amm.Trait.Annotated.mergePrototypes(r,null,n,null);return Amm.override({},s)},_assignDefaultAnnotations:function(){if(this._defaultAnnotations instanceof Array)for(var t=0,e=this._defaultAnnotations.length;t<e;t++){var i,r=this._defaultAnnotations[t],n=Amm.getProperty(this,r,void 0);void 0!==n?this.getAnnotationsContainer().getAnnotationElement(r).setContent(n):void 0!==(i=this.getAnnotationsContainer().getAnnotationElement(r).getContent())&&Amm.setProperty(this,r,i)}},setLabel:function(t){var e=this._label;if(e!==t)return this._label=t,this.outLabelChange(t,e),!0},getLabel:function(){return this._label},outLabelChange:function(t,e){this._out("labelChange",t,e)},setDescription:function(t){var e=this._description;if(e!==t)return this._description=t,this.outDescriptionChange(t,e),!0},getDescription:function(){return this._description},outDescriptionChange:function(t,e){this._out("descriptionChange",t,e)},setRequired:function(t){var e=this._required;if(e!==t)return this._required=t,this.outRequiredChange(t,e),!0},getRequired:function(){return this._required},outRequiredChange:function(t,e){this._out("requiredChange",t,e)},setError:function(t){var e=this._error;if(e!==t)return this._error=t,this.outErrorChange(t,e),!0},getError:function(){return this._error},outErrorChange:function(t,e){this._out("errorChange",t,e)},listAnnotations:function(){return Amm.keys(this.getAnnotationsContainer().getAllNamedElements())},hasAnnotation:function(t){return!!this.getAnnotationsContainer().getAnnotationElement(t,!0)},getAnnotationValue:function(t){if(t){var e=this.getAnnotationsContainer().getAnnotationElement(t,!0);return e?e.getContent():void 0}for(var i=this.listAnnotations(),r=this.getAnnotationsContainer(),n={},s=0,o=i.length;s<o;s++){var t=i[s],a=r.getAnnotationElement(t,!0);a&&(n[t]=a.getContent())}return n},setAnnotationValue:function(t,e){return this.getAnnotationsContainer().getAnnotationElement(e).setContent(t)}},Amm.Trait.Annotated.Container=function(t){this._requireInterfaces("Annotated"),Amm.ElementBound.call(this),Amm.Element.call(this,t)},Amm.Trait.Annotated.Container.prototype={"Amm.Trait.Annotated.Container":"__CLASS__",setElement:function(t){return null!==this._element&&this._element!==t&&Error("can setElement() only once in Amm.Trait.Annotated.Container"),Amm.ElementBound.prototype.setElement.call(this,t)},_passAnnotatedContentChange:function(t,e){this._element&&Amm.setProperty(this._element,Amm.event.origin.getId(),t)},createAnnotationElement:function(t){var e=this._element.getAnnotationElementPrototype(t);e.id=t,e.component=this;var i,r,n=new Amm.Element(e),s={};return Amm.detectProperty(this._element,t,s)&&(n.subscribe("contentChange",this._passAnnotatedContentChange,this),i=this._element[s.getterName](),r=n.getContent(),void 0!==i?n.setContent(i):void 0===i&&void 0!==r&&this._element[s.setterName](r),this._element.subscribe(s.eventName,n.setContent,n)),n},getAnnotationElement:function(t,e){return this._namedElements[t]||e?this.getNamedElement(t,0,!0):this.createAnnotationElement(t)},_getDefaultTraits:function(){return["Amm.Trait.Component"]}},Amm.extend(Amm.Trait.Annotated.Container,Amm.Element),Amm.extend(Amm.Trait.Annotated.Container,Amm.ElementBound),Amm.Trait.Component=function(){this._namedElements={},this._elements=[],this._components=[],this.e={}},Amm.Trait.Component.changeComponent=function(t,e,i){var r=[];if(void 0!==i)for(var n=0,s=t.length;n<s;n++)t[n].getComponent()===i&&r.push(t[n]);else r=t;if(e)e.acceptElements(r);else for(n=0,s=r.length;n<s;n++)r[n].setComponent(e)},Amm.Trait.Component.prototype={Component:"__INTERFACE__",_internalId:"component",_isComponent:!0,_namedElements:null,_elements:null,e:null,_components:null,setInternalId:function(t){var e=this._internalId;if(e!==t)return this._internalId=t,this.outInternalIdChange(t,e),this.outRenamedElement(this,t,e),this.outRenamedInScope(this,this,t,e),!0},getInternalId:function(){return this._internalId},outInternalIdChange:function(t,e){this._out("internalIdChange",t,e)},getClosestComponent:function(){return this._isComponent?this:this._component},__augment:function(){Amm.Element.regInit(this,"95_Component_setClosestComponent",this._setClosestComponent)},setIsComponent:function(t){t=!!t;var e,i=this._isComponent;if(i!==t)return this._isComponent=t,this._setClosestComponent(),this._callOwnMethods("_setIsComponent_"),t?(e=this.findChildElements()).length&&this.acceptElements(e):this._component?this._component.acceptElements(this.getElements()):this.rejectElements(this.getElements()),this.outIsComponentChange(t,i),!0},getIsComponent:function(){return this._isComponent},outIsComponentChange:function(t,e){this._out("isComponentChange",t,e)},_extractNameEventFromMethodName:function(t){if(0===t.indexOf("handle__")){var e,i=t.slice("handle__".length).split("__"),r=1===i.length?(e="",i[0]):(e=i[0],i.slice(1).join("__"));return[e,r]}},_listHandlersForElements:function(){var t,e={};for(var i in this)if("function"==typeof this[i]){if(!(t=this._extractNameEventFromMethodName(i)))continue;e[t[0]]||(e[t[0]]=[]),e[t[0]].push([t[1],i])}return e},_subscribeElement:function(t,e,i,r){var n=t.getId();if(n&&n.length||!e){var i=i||this._listHandlersForElements(),s=[];!e&&i[""]&&(s=i[""]),i[n]&&(s=s.concat(i[n]));for(var o=0,a=s.length;o<a;o++)if(t.hasEvent(s[o][0])){if(r&&t.getSubscribers(s[o][0],s[o][1],this).length)continue;t.subscribe(s[o][0],s[o][1],this)}}},_unsubscribeElement:function(t,e){for(var i=t.getSubscribers(void 0,void 0,this),r=0,n=i.length;r<n;r++){var s,o=i[r];"string"==typeof o[0]&&(s=this._extractNameEventFromMethodName(o[0]))&&(e&&!s[0]||t.unsubscribe(o[3],o[0],this))}},resubscribeAllElements:function(){for(var t=this._listHandlersForElements(),e=0,i=this._elements.length;e<i;e++)this._subscribeElement(this._elements[e],!1,t,!0)},handle__componentChange:function(t,e){var i=Amm.event.origin;t===this?this.acceptElements([i]):e===this&&this.rejectElements([i])},handle__idChange:function(t,e){var i=Amm.event.origin;e&&(this._deleteNamedElementEntry(i,e),this._unsubscribeElement(i,!0)),t&&(this._namedElements[t]||(this._namedElements[t]=[]),this._namedElements[t].push(i),1===this._namedElements[t].length?this.e[t]=i:this.e[t]=this._namedElements[t],this._subscribeElement(i,!0,void 0)),this.outRenamedElement(i,t,e),this.outRenamedInScope(this,i,t,e)},handle__isComponentChange:function(t,e){var i=Amm.event.origin;t?this._registerComponent(i):this._unregisterComponent(i),this.outChildComponentStatusChange(i,t),this.outChildComponentStatusChangeInScope(this,i,t)},outRenamedElement:function(t,e,i){this._out("renamedElement",t,e,i)},handle__cleanup:function(){var t=Amm.event.origin;this.rejectElements([t])},g:function(t,e,i){return this.getNamedElement(t,e,i)},getNamedElement:function(t,e,i){return(!e||e<0)&&(e=0),this._internalId&&t===this._internalId&&!e?this:(this._namedElements[t]&&(r=this._namedElements[t][e]),r||!i||(n=this.getAllNamedElements(t,i))&&n[e]&&(r=n[e]),r);var r,n},getAllNamedElements:function(t,e){var i;if(t){if(i=[],this._internalId&&t===this._internalId&&i.push(this),this._namedElements[t]&&(i=i.concat(this._namedElements[t])),e&&this._component){var r=this._component.getAllNamedElements(t,e);if(this._internalId===t)for(var n=0,s=r.length;n<s;n++)if(r[n]===this){r.splice(n,1);break}i=i.concat(r)}return i}for(var n in i={},this._internalId&&(i[this._internalId]=[this]),this._namedElements)this._namedElements.hasOwnProperty(n)&&(i[n]=(i[n]||[]).concat(this._namedElements[n]));if(e&&this._component){var r=this._component.getAllNamedElements(void 0,e),o=this._id;if(o&&r[o])for(var a=0,s=r[o].length;a<s;a++)if(r[o][a]===this){r[n].splice(a,1),r[n].length||delete r[n];break}for(var n in r)r.hasOwnProperty(n)&&(i[n]=(this._namedElements[n]||[]).concat(r[n]))}return i},_includeAllChildren:function(t){for(var e,i=[].concat(t),r=0,n=t.length;r<n;r++){t[r].Component&&t[r].getIsComponent()||(e=this._includeAllChildren(t[r].findChildElements()),i=i.concat(e))}return i},acceptElements:function(t){var e=this._includeAllChildren(t),i=[];if((e=Amm.Array.diff(e,this._elements)).length){this._elements.push.apply(this._elements,e);for(var r=this._listHandlersForElements(),n=0,s=e.length;n<s;n++){this._subscribeElement(e[n],!1,r);var o=e[n].getId();o&&(this._namedElements[o]||(this._namedElements[o]=[]),this._namedElements[o].push(e[n]),1===this._namedElements[o].length?this.e[o]=this._namedElements[o][0]:this.e[o]=this._namedElements[o]),"__INTERFACE__"===e[n].Component&&e[n].getIsComponent()&&this._registerComponent(e[n]),e[n].setComponent(this),i.push(e[n])}return i.length&&(this.outAcceptedElements(i),this.outAcceptedInScope(this,i)),i}},_registerComponent:function(t){this._components.push(t)},outAcceptedElements:function(t){return this._out("acceptedElements",t)},_deleteNamedElementEntry:function(t,e){if(e=(e=e||t.getId())||t.getId(),this._namedElements[e]){var i=Amm.Array.indexOf(t,this._namedElements[e]);return 0<=i?(this._namedElements[e].splice(i,1),1===this._namedElements[e].length?this.e[e]=this._namedElements[e][0]:this._namedElements[e].length||(delete this._namedElements[e],delete this.e[e]),!0):void 0}},rejectElements:function(t){for(var e,i,r=[],n=this._includeAllChildren(t),s=this._elements.length,o=Amm.Array.findDuplicates(this._elements.concat(n),!1,null,s,!0),a=o.length-1;0<=a;a--){o[a][0]>=s||((i=(e=this._elements[o[a][0]]).getId())&&this._deleteNamedElementEntry(e,i),this._elements.splice(o[a][0],1),this._unsubscribeElement(e),e.getComponent()===this&&e.setComponent(null),"__INTERFACE__"===n[a].Component&&n[a].getIsComponent()&&this._unregisterComponent(n[a]),r.unshift(e))}return r.length&&(this.outRejectedElements(r),this.outRejectedInScope(this,r)),r},_unregisterComponent:function(t){for(var e=0,i=this._components.length;e<i;e++)if(this._components[e]===t){this._components.splice(e,1);break}},outRejectedElements:function(t){return this._out("rejectedElements",t)},getElements:function(){return[].concat(this._elements)},_listCall:function(t,e,i){for(var r=[],n=0,s=t.length;n<s;n++){var o=t[n];"function"==typeof e?r.push([o,e.apply(o,i)]):"function"==typeof o[e]&&r.push([o,o[e].apply(o,i)])}return r},callElements:function(t,e){return this._listCall(this._elements,t,Array.prototype.slice.call(arguments,1))},callComponents:function(t,e){return this._listCall(this._components,t,Array.prototype.slice.call(arguments,1))},_cleanup_Component:function(){this._namedElements={},this.e={};var t=this._elements;this._elements=[];for(var e=0,i=t.length;e<i;e++)this._unsubscribeElement(t[e]),t[e].setComponent(null),t[e].getCleanupWithComponent()&&t[e].cleanup()},outAcceptedInScope:function(t,e){var i=this._out("acceptedInScope",t,e);return this.callComponents("outAcceptedInScope",t,e),i},outRejectedInScope:function(t,e){var i=this._out("rejectedInScope",t,e);return this.callComponents("outRejectedInScope",t,e),i},outRenamedInScope:function(t,e,i,r){var n=this._out("renamedInScope",t,e,i,r);return this.callComponents("outRenamedInScope",t,e,i,r),n},outChildComponentStatusChange:function(t,e){return this._out("childComponentStatusChange",t,e)},outChildComponentStatusChangeInScope:function(t,e,i){var r=this._out("childComponentStatusChangeInScope",t,e,i);return this.callComponents("outChildComponentStatusChangeInScope",t,e,i),r},_setComponent_Component:function(t){this.outComponentStackChange()},outComponentStackChange:function(){this.callComponents("outComponentStackChange"),this._out("componentStackChange")}},Amm.Trait.Visual=function(){},Amm.Trait.Visual.prototype={Visual:"__INTERFACE__",ClassName:"__INTERFACE__",DisplayChild:"__INTERFACE__",_visible:void 0,_displayParent:void 0,_displayOrder:void 0,_className:void 0,setVisible:function(t){var e=this._visible;if(e!==t)return this._visible=t,this.outVisibleChange(t,e),!0},getVisible:function(){return this._visible},outVisibleChange:function(t,e){this._out("visibleChange",t,e)},setDisplayParent:function(t){t?Amm.is(t,"DisplayParent","displayParent"):t=null;var e,i=this._displayParent;if(i!==t)return this._displayParent=t,!i||0<=(e=i.displayChildren.strictIndexOf(this))&&i.displayChildren.removeAtIndex(e),t&&t.displayChildren.strictIndexOf(this)<0&&t.displayChildren.accept(this),this.outDisplayParentChange(t,i),!0},getDisplayParent:function(){return this._displayParent},outDisplayParentChange:function(t,e){this._out("displayParentChange",t,e)},setDisplayOrder:function(t){if("number"!=typeof t&&(t=parseInt(t),isNaN(t)))throw Error("`displayOrder` must be a number");var e=this._displayOrder;if(e!==t)return this._displayParent&&t>=this._displayParent.displayChildren.length&&(t=this._displayParent.displayChildren.length-1),t<0&&(t=0),this._displayOrder=t,this.outDisplayOrderChange(t,e),!0},getDisplayOrder:function(){return this._displayOrder},outDisplayOrderChange:function(t,e){this._out("displayOrderChange",t,e)},setClassName:function(t,e){var i,r,n=this._className;if(e?(r=new RegExp("\\s*\\b"+Amm.Util.regexEscape(e)+"\\b\\s*","g"),void 0===this._className&&(this._className=""),t?i=r.exec(this._className)?this._className:this._className+" "+e:(void 0===this._className&&(this._className="")," "===(i=this._className.replace(r," ").replace(/ {2,}/g," "))[0]&&(i=i.slice(1))," "===i[i.length-1]&&(i=i.slice(0,-1)))):i=t,i!==n)return this._className=i,this.outClassNameChange(i,n),!0},getClassName:function(t){return t?0<=(" "+this._className+" ").indexOf(" "+t+" "):this._className},outClassNameChange:function(t,e){this._out("classNameChange",t,e)}},Amm.Trait.Input=function(){},Amm.Trait.Input.prototype={Focusable:"__INTERFACE__",Editor:"__INTERFACE__",Lockable:"__INTERFACE__",_readOnly:void 0,_focused:void 0,_enabled:!0,_value:void 0,_locked:!1,_focusedView:null,setValue:function(t){var e=this._value;if(e!==t)return this._value=t,this.outValueChange(t,e),!0},getValue:function(){return this._value},outValueChange:function(t,e){this._out("valueChange",t,e)},setReadOnly:function(t){var e=this._readOnly;if(e!==t)return this._readOnly=t,this.outReadOnlyChange(t,e),!0},getReadOnly:function(){return this._readOnly},outReadOnlyChange:function(t,e){this._out("readOnlyChange",t,e)},setFocused:function(t){t=!!t;var e=this._focused;if(e!==t)return this._focused=t,this.outFocusedChange(t,e),!0},getFocused:function(){return this._focused},outFocusedChange:function(t,e){this._out("focusedChange",t,e)},setFocusedView:function(t){t=t||null;var e=this._focusedView;if(e!==t)return null===(this._focusedView=t)?this.setFocused(!1):this._focused||this.setFocused(!0),this.outFocusedViewChange(t,e),!0},getFocusedView:function(){return this._focusedView},outFocusedViewChange:function(t,e){this._out("focusedViewChange",t,e)},setEnabled:function(t){var e=this._enabled;if(e!==t)return this._enabled=t,this.outEnabledChange(t,e),!0},getEnabled:function(){return this._enabled},outEnabledChange:function(t,e){this._out("enabledChange",t,e)},setLocked:function(t){var e=this._locked;if(e!==t)return this._locked=t,this.outLockedChange(t,e),!0},getLocked:function(){return this._locked},outLockedChange:function(t,e){this._out("lockedChange",t,e)}},Amm.Trait.Toggle=function(){},Amm.Trait.Toggle.prototype={Toggle:"__INTERFACE__",_isRadio:void 0,_groupName:void 0,_groupParent:void 0,_checked:void 0,_checkedValue:void 0,_uncheckedValue:void 0,_valueIsStandalone:!1,_lockGroup:0,_lockGroupSearch:0,_value:void 0,__augment:function(t){Amm.Element.regInit(this,"99.Amm.Trait.Toggle",this._subscribeToggleToRoot)},setIsRadio:function(t){void 0!==t&&(t=!!t);var e=this._isRadio;if(e!==t){var i=void 0!==this._getOwnValue();return this._isRadio=t,i=i||void 0!==this._getOwnValue(),this.outIsRadioChange(t,e),(this._uncheckOtherRadios()||i)&&this._notifyGroup(),!0}},getIsRadio:function(){return this._isRadio},outIsRadioChange:function(t,e){this._out("isRadioChange",t,e)},setGroupName:function(t){t=t||void 0;var e=this._groupName;if(e!==t){var i=this.findGroupItems(!1,!0);return this._groupName=t,i.length&&this._notifyGroup(i),this.outGroupNameChange(t,e),this._notifyGroup(),!0}},getGroupName:function(){return this._groupName},outGroupNameChange:function(t,e){this._out("groupNameChange",t,e)},setGroupParent:function(t){t=t||void 0;var e=this._groupParent;if(e!==t){var i=this.findGroupItems(!1,!0);return this._groupParent=t,i.length&&this._notifyGroup(i),this.outGroupParentChange(t,e),this._notifyGroup(),!0}},getGroupParent:function(){return this._groupParent},outGroupParentChange:function(t,e){this._out("groupParentChange",t,e)},_uncheckOtherRadios:function(){if(this._checked&&this._isRadio){var t=this.findGroupItems(!0),e=!1;if(!(t.length<=1)){for(var i=0,r=t.length;i<r;i++)t[i]!==this&&t[i].getChecked()&&(t[i]._uncheckByGroup(),e=!0);return e}}},_uncheckByGroup:function(){this._lockGroup++,this.setChecked(!1),this._lockGroup--},setEnabled:function(t){var e=void 0!==this._getOwnValue(),i=Amm.Trait.Input.prototype.setEnabled.call(this,t);return i&&(e||void 0!==this._getOwnValue())&&this._reportChange(),i},setChecked:function(t){void 0!==t&&(t=!!t);var e=this._checked;if(t&&this._uncheckOtherRadios()&&this._reportChange(),e!==t)return this._checked=t,this._uncheckOtherRadios(),this._reportChange(),this.outCheckedChange(t,e),!0},getChecked:function(){return this._checked},outCheckedChange:function(t,e){this._out("checkedChange",t,e)},setCheckedValue:function(t){var e=this._checkedValue;if(e!==t)return this._checkedValue=t,this.outCheckedValueChange(t,e),this._checked&&this._reportChange(),!0},getCheckedValue:function(){return this._checkedValue},outCheckedValueChange:function(t,e){this._out("checkedValueChange",t,e)},setUncheckedValue:function(t){var e=this._uncheckedValue;if(e!==t)return this._uncheckedValue=t,this.outUncheckedValueChange(t,e),this._checked||this._reportChange(),!0},getUncheckedValue:function(){return this._uncheckedValue},outUncheckedValueChange:function(t,e){this._out("uncheckedValueChange",t,e)},setValueIsStandalone:function(t){t=!!t;var e=this._valueIsStandalone;if(e!==t){this._valueIsStandalone=t;var i=this._value;return this.outValueIsStandaloneChange(t,e),this._value=t?this._getOwnValue():this._getGroupValue(),Amm.Trait.Select.valuesAreSame(i,this._value)||this.outValueChange(this._value,i),!0}},getValueIsStandalone:function(){return this._valueIsStandalone},outValueIsStandaloneChange:function(t,e){this._out("valueIsStandaloneChange",t,e)},_notifyGroup:function(t,e){t=t||this.findGroupItems(),arguments.length<2&&(e=this._getGroupValue(t));for(var i=0,r=t.length;i<r;i++)t[i]._receiveGroupNotification(e,this)},_reportChange:function(){var t,e;!this._valueIsStandalone||(t=this._getOwnValue())!==this._value&&(e=this._value,this._value=t,this.outValueChange(this._value,e));for(var i=this._getGroupValue(),r=this.findGroupItems(),n=0,s=r.length;n<s;n++)r[n]._receiveGroupNotification(i,this)},setValue:function(t){var e=this._value;if(this._valueIsStandalone?this._setOwnValue(t):this._setGroupValue(t),!Amm.Trait.Select.valuesAreSame(this._value,e))return!0},_receiveGroupNotification:function(t,e){var i;this._valueIsStandalone||Amm.Trait.Select.valuesAreSame(t,this._value)||(i=this._value,this._value=t,this.outValueChange(t,i))},_setGroupValue:function(t){for(var e=t instanceof Array?t:null==t?[]:[t],i=this.findGroupItems(),r=!1,n=!1,s=0,o=i.length;s<o;s++)i[s]._lockGroup++;for(s=0,o=i.length;s<o;s++){var a=i[s];if("__INTERFACE__"!==a.Toggle)return;var h=a.getIsRadio(),l=0<=Amm.Array.nonStrictIndexOf(a.getCheckedValue(),e),u=a.getChecked(),r=r||l&&u&&h;h&&r||!(l&&!u||!l&&u)||(h&&l&&(r=!0),n=!0,a.setChecked(!!l))}for(s=0,o=i.length;s<o;s++)i[s]._lockGroup--;return n&&this._reportChange(),n},_getGroupValue:function(t){for(var e=[],i=0,r=0,n=0,s=(t=t||this.findGroupItems()).length;n<s;n++){var o=t[n],a=o._getOwnValue();"__INTERFACE__"===o.Toggle&&(o.getIsRadio()?r++:i++,void 0!==a&&e.push(a))}return(0===r&&1===i||r&&!i)&&(e=e[0]),e},_setOwnValue:function(t){t==this._checkedValue?this.setChecked(!0):this.setChecked(!1)},_getOwnValue:function(){if(this._enabled)return this._checked?this._checkedValue:this._isRadio?void 0:this._uncheckedValue},findGroupItems:function(t,e){var i=[];return e&&this._lockGroupSearch++,Amm.getRoot().raiseEvent("findToggleGroupItems",this._groupParent,this._groupName,t,i),e&&this._lockGroupSearch--,i},_handleFindToggleGroupItems:function(t,e,i,r){this._lockGroupSearch||t===this._groupParent&&e===this._groupName&&(i&&!this._isRadio||r.push(this))},_subscribeToggleToRoot:function(){Amm.getRoot().subscribe("findToggleGroupItems",this._handleFindToggleGroupItems,this)},_setComponent_Toggle:function(t,e){this._groupParent!==e&&this._groupParent&&!this._groupParent.tagName||this.setGroupParent(t)},_cleanup_Toggle:function(){Amm.getRoot().unsubscribe("findToggleGroupItems",this._handleFindToggleGroupItems,this)}},Amm.extend(Amm.Trait.Toggle,Amm.Trait.Input),Amm.Trait.Content=function(){},Amm.Trait.Content.prototype={Content:"__INTERFACE__",_content:void 0,_contentTranslator:null,setContent:function(t){var e=this._content;if(e!==t)return this._content=t,this.outContentChange(t,e),!0},getContent:function(){return this._content},outContentChange:function(t,e){this._out("contentChange",t,e)},setContentTranslator:function(t){t=t?Amm.constructInstance(t,"Amm.Translator"):null;var e=this._contentTranslator;if(e!==t)return this._contentTranslator=t,this.outContentTranslatorChange(t,e),!0},getContentTranslator:function(){return this._contentTranslator},outContentTranslatorChange:function(t,e){this._out("contentTranslatorChange",t,e)}},Amm.Trait.Select=function(){},Amm.Trait.Select.valuesAreSame=function(t,e){if(void 0===t&&void 0!==e)return!1;if(void 0===e&&void 0!==t)return!1;if(t===e)return!0;t&&t["Amm.Array"]&&(t=t.getItems()),e&&e["Amm.Array"]&&(e=e.getItems());function i(t,e){return t==e?0:1}return t instanceof Array?e instanceof Array&&(!Amm.Array.diff(t,e,i).length&&!Amm.Array.diff(e,t,i).length):!(e instanceof Array)&&!(t!=e)},Amm.Trait.Select.prototype={Select:"__INTERFACE__",options:null,_objectsMapper:null,_selectionCollection:null,_multiple:void 0,_selectSize:void 0,_numChanges:0,_labelProperty:null,_valueProperty:null,_disabledProperty:null,_dummyLabel:null,_dummyValue:null,_dummyOption:null,_optionPrototype:null,_sorter:null,setOptions:function(t){var e=[];if((t=t||[])instanceof Array||t["Amm.Array"])e=t;else if("object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&e.push({label:t[i],value:i});for(var r=[],i=0;i<e.length;i++){var n=this._optionPrototype?Amm.overrideRecursive({},this._optionPrototype):{};"object"!=typeof e[i]?(n.label=e[i],n.value=e[i]):Amm.getClass(e[i])?e[i]:n=Amm.overrideRecursive(n,e[i]),n.component=this.getClosestComponent(),r.push(Amm.constructInstance(n,Amm.Trait.Select.Option))}this._dummyOption&&r.unshift(this._dummyOption);var s=this.getSelectionCollection(),o=this.getValue();o instanceof Array&&(o=[].concat(o)),s.beginUpdate(),this.getOptionsCollection().setItems(r),void 0!==o&&s.setValue(o),s.endUpdate(),this._multiple||null!==this._value&&void 0!==this._value||1!==this._selectSize||this._correctValueForSingleSelect()},_updateDummyOption:function(t){var e=null;t=t||this._objectsMapper,this._multiple||null===this._dummyLabel||void 0===this._dummyLabel||((e=this._dummyOption?this._dummyOption:new Amm.Trait.Select.Option).setLabel(this._dummyLabel),e.setValue(this._dummyValue)),t?t.setDestExtra(e?[e]:null):this.options&&(e&&!this._dummyOption?this.options.splice(0,0,e):!e&&this._dummyOption&&this.options.reject(this._dummyOption),this._dummyOption=e)},getOptions:function(){if(this.options){var t=this.getOptionsCollection().getItems();return this._dummyOption?t.slice(1):t}},getOptionsCollection:function(){if(this.options)return this.options;var t={changeEvents:["labelChange","valueChange","disabledChange","visibleChange","selectedChange"],requirements:["Amm.Trait.Select.Option"],indexProperty:"index",observeIndexProperty:!0,cleanupOnDissociate:!0,sorter:this._sorter};return this.options=new Amm.Collection(t),this._cleanupList&&this._cleanupList.push(this.options),this.getSelectionCollection(),this.options.subscribe("itemsChange",this._handleOptionsChange,this),this.options},outOptionsCollectionChange:function(){},getSelectionCollection:function(){if(this._selectionCollection)return this._selectionCollection;var t={multiple:this._multiple,valueProperty:"value",selectedProperty:"selected"};return this._selectionCollection=new Amm.Selection(t),this._selectionCollection.setCollection(this.getOptionsCollection()),this._selectionCollection.subscribe("valueChange",this._handleSelfSelectionValueChange,this),this._selectionCollection.setValue(this._value),this._cleanupList&&this._cleanupList.push(this._selectionCollection),this._selectionCollection},setSelectSize:function(t){void 0!==t&&(t=parseInt(t)||1)<0&&(t=1);var e=this._selectSize;if(e!==t)return 1!==(this._selectSize=t)||this._multiple||null!==this._value&&void 0!==this._value||this.options&&this.options.length&&this._correctValueForSingleSelect(),this.outSelectSizeChange(t,e),!0},getSelectSize:function(){return this._selectSize},outSelectSizeChange:function(t,e){this._out("selectSizeChange",t,e)},_handleSelfSelectionValueChange:function(t,e){if(void 0===t&&(t=null),!Amm.Trait.Select.valuesAreSame(t,this._value)){var i=this._value;if(this._value=t,!this._multiple&&null===this._value&&1===this._selectSize&&this._correctValueForSingleSelect())return;this._numChanges++,this.outValueChange(t,i)}},_handleOptionsChange:function(t,e){!e.length&&t.length&&1===this._selectSize&&void 0===this._value&&this._correctValueForSingleSelect()},_correctValueForSingleSelect:function(){if(!(this._selectionCollection&&this._selectionCollection.getUpdateLevel()||null!==this._dummyLabel&&null===this._dummyValue))for(var t=this.getOptionsCollection(),e=0,i=t.length;e<i;e++){var r=t[e];if(!r.getDisabled()&&r.getVisible())return this.setValue(r.getValue()),!0}},setMultiple:function(t){t=!!t;var e=this._multiple;if(e!==t)return this._multiple=t,this._updateDummyOption(),this._selectionCollection&&this._selectionCollection.setMultiple(t),this.outMultipleChange(t,e),!0},getMultiple:function(){return this._multiple},outMultipleChange:function(t,e){this._out("multipleChange",t,e)},setObjects:function(t){if(t){if(!(t instanceof Array||Amm.is(t,"Amm.Array")))throw new Error("objects must be FALSEable, Array or Amm.Array; provided: "+Amm.describeType(t));this._objectsMapper||(this._objectsMapper=this._createObjectsMapper(t))}else this._detachObjects()},getObjects:function(){return this._objectsMapper?this._objectsMapper.getSrc():null},getObjectsItems:function(){return this._objectsMapper?this._objectsMapper.getSrc().getItems():[]},_detachObjects:function(t){if(this._objectsMapper){this._objectsMapper.setSrc([]),this._objectsMapper.cleanup();for(var e=0,i=this._cleanupList.length;e<i;e++)if(this._cleanupList[e]===this._objectsMapper){this._cleanupList[e].splice(e,1);break}this._objectsMapper=null}},outObjectsChange:function(t,e){},setValue:function(t){var e=this._numChanges;if(this.getSelectionCollection().setValue(t),this._numChanges!==e)return!0},setLabelProperty:function(t){var e=this._labelProperty;if(e!==t)return this._labelProperty=t,this.outLabelPropertyChange(t,e),this._updateInstantiator(),!0},getLabelProperty:function(){return this._labelProperty},outLabelPropertyChange:function(t,e){this._out("labelPropertyChange",t,e)},setValueProperty:function(t){var e=this._valueProperty;if(e!==t)return this._valueProperty=t,this.outValuePropertyChange(t,e),this._updateInstantiator(),!0},getValueProperty:function(){return this._valueProperty},setDisabledProperty:function(t){var e=this._disabledProperty;if(e!==t)return this._disabledProperty=t,this.outDisabledPropertyChange(t,e),this._updateInstantiator(),!0},getDisabledProperty:function(){return this._disabledProperty},outDisabledPropertyChange:function(t,e){this._out("disabledPropertyChange",t,e)},_objectPropToExp:function(t){return t.match(/^\w+$/)?"this.origin."+t:t},_updateInstantiator:function(){if(this._objectsMapper){var t=Amm.getProperty(this._selectionCollection.getItems(),"origin");if(this._selectionCollection.beginUpdate(),this._objectsMapper.setInstantiator(this._createInstantiator()),t.length){for(var e=[],i=0,r=this.options.length;i<r;i++)Amm.Array.indexOf(this.options[i].getOrigin(),t)<0||e.push(this.options[i]);this._selectionCollection.setItems(e)}this._selectionCollection.endUpdate()}},_createInstantiator:function(){var t={class:"Amm.Trait.Select.Option"};return this._labelProperty&&(t.in__label=this._objectPropToExp(this._labelProperty)),this._disabledProperty&&(t.in__disabled=this._objectPropToExp(this._disabledProperty)),this._valueProperty?t.in__value=this._objectPropToExp(this._valueProperty):t.in__value="this.origin",t.component=this.getClosestComponent(),this._optionPrototype&&(t=Amm.overrideRecursive(t,this._optionPrototype)),new Amm.Instantiator.Proto(t,"origin")},_createObjectsMapper:function(t){var e={instantiator:this._createInstantiator(),dest:this.getOptionsCollection()},i=new Amm.ArrayMapper(e);return i.beginUpdate(),i.setSrc(t),this._updateDummyOption(i),i.endUpdate(),i},outValuePropertyChange:function(t,e){this._out("valuePropertyChange",t,e)},_cleanup_AmmTraitSelect:function(){this._detachObjects()},setDummyLabel:function(t){var e=this._dummyLabel;if(e!==t)return this._dummyLabel=t,this._updateDummyOption(),this.outDummyLabelChange(t,e),!0},getDummyLabel:function(){return this._dummyLabel},outDummyLabelChange:function(t,e){this._out("dummyLabelChange",t,e)},setDummyValue:function(t){var e=this._dummyValue;if(e!==t)return this._dummyValue=t,this._updateDummyOption(),this.outDummyValueChange(t,e),!0},getDummyValue:function(){return this._dummyValue},outDummyValueChange:function(t,e){this._out("dummyValueChange",t,e)},setOptionPrototype:function(t){if("string"==typeof(t=t||null))t={class:t};else if("object"!=typeof t)throw Error("optionProtoype must be null, a string or an object");var e=this._optionPrototype;if(e!==t)return this._optionPrototype=t,this.outOptionPrototypeChange(t,e),this._updateInstantiator(),!0},getOptionPrototype:function(){return this._optionPrototype},outOptionPrototypeChange:function(t,e){this._out("optionPrototypeChange",t,e)},_setClosestComponent_ammTraitSelect:function(t){var e=this.getOptionsCollection();Amm.setProperty(e.getItems(),"component",t)},setSorter:function(t){if(this.options)return this.options.setSorter(t);this._sorter=t},getSorter:function(){return this.options?this.options.getSorter():this._sorter}},Amm.extend(Amm.Trait.Select,Amm.Trait.Input),Amm.Trait.Select.Option=function(t){Amm.Element.call(this,t)},Amm.Trait.Select.Option.prototype={"Amm.Trait.Select.Option":"__CLASS__",_value:null,_label:null,_disabled:!1,_selected:!1,_index:null,_origin:null,_visible:!0,setValue:function(t){var e=this._value;if(e!==t)return this._value=t,this.outValueChange(t,e),!0},getValue:function(){return this._value},outValueChange:function(t,e){this._out("valueChange",t,e)},setLabel:function(t){var e=this._label;if(e!==t)return this._label=t,this.outLabelChange(t,e),!0},getLabel:function(){return this._label},outLabelChange:function(t,e){this._out("labelChange",t,e)},setDisabled:function(t){t=!!t;var e=this._disabled;if(e!==t)return this._disabled=t,this.outDisabledChange(t,e),this._disabled&&this._selected&&this.setSelected(!1),!0},getDisabled:function(){return this._disabled},outDisabledChange:function(t,e){this._out("disabledChange",t,e)},setSelected:function(t){t=!!t,!this._disabled&&this._visible||(t=!1);var e=this._selected;if(e!==t)return this._selected=t,this.outSelectedChange(t,e),!0},getSelected:function(){return this._selected},outSelectedChange:function(t,e){this._out("selectedChange",t,e)},setIndex:function(t){var e=this._index;if(e!==t)return this._index=t,this.outIndexChange(t,e),!0},getIndex:function(){return this._index},outIndexChange:function(t,e){this._out("indexChange",t,e)},setOrigin:function(t){var e=this._origin;if(e!==t)return this._origin=t,this.outOriginChange(t,e),!0},getOrigin:function(){return this._origin},outOriginChange:function(t,e){this._out("originChange",t,e)},setVisible:function(t){t=!!t;var e=this._visible;if(e!==t)return this._visible=t,!this._visible&&this._selected&&this.setSelected(!1),this.outVisibleChange(t,e),!0},getVisible:function(){return this._visible},outVisibleChange:function(t,e){this._out("visibleChange",t,e)}},Amm.extend(Amm.Trait.Select.Option,Amm.Element),Amm.Trait.DisplayParent=function(){},Amm.Trait.DisplayParent.prototype={DisplayParent:"__INTERFACE__",displayChildren:null,_displayChildrenPrototype:null,_passDisplayChildrenToComponent:!0,_displayChildrenObservedForComponent:!1,__augment:function(t,e){var i={requirements:["Visual"],assocInstance:this,assocProperty:"displayParent",indexProperty:"displayOrder",observeIndexProperty:!0,assocEvents:{cleanup:"_handleDisplayChildCleanup"}};this._displayChildrenPrototype&&Amm.overrideRecursive(i,this._displayChildrenPrototype),this.displayChildren=new Amm.Collection(i),Amm.Element.regInit(this,"99_DisplayParent_observe",this._observeDisplayChildrenForComponent)},setDisplayChildrenPrototype:function(t){if(t?"object"!=typeof t&&Error("`displayChildrenPrototype` must be a nullable or an object"):t=null,this._displayChildrenPrototype!==t)return this._displayChildrenPrototype=t,this.displayChildren&&this._displayChildrenPrototype&&Amm.init(this.displayChildren,this._displayChildrenPrototype),!0},getDisplayChildrenPrototype:function(){return this._displayChildrenPrototype},getDisplayChildren:function(){return this.displayChildren},setDisplayChildren:function(t){return this.displayChildren.setItems(t)},_observeDisplayChildrenForComponent:function(t){var e=void 0===t?!(!this._closestComponent||!this._passDisplayChildrenToComponent):!!t;e!=!!this._displayChildrenObservedForComponent&&(e?this.displayChildren.subscribe("spliceItems",this._passDisplayChildrenOnSplice,this):this.displayChildren.unsubscribe("spliceItems",this._passDisplayChildrenOnSplice,this),this._displayChildrenObservedForComponent=!!e)},_passDisplayChildrenOnSplice:function(t,e,i){var r,n;this._passDisplayChildrenToComponent&&this._closestComponent&&(r=Amm.Array.symmetricDiff(e,i),n=Amm.Array.symmetricDiff(i,e),r&&this._closestComponent.rejectElements(r),n&&this._closestComponent.acceptElements(n))},setPassDisplayChildrenToComponent:function(t){t=!!t;var e,i=this._passDisplayChildrenToComponent;if(i!==t)return this._passDisplayChildrenToComponent=t,this._closestComponent&&(e=(e=[]).concat(this.displayChildren.getItems()),this._passDisplayChildrenToComponent?this._closestComponent.acceptElements(e):this._closestComponent.rejectElements(e)),this._observeDisplayChildrenForComponent(),this.outPassDisplayChildrenToComponentChange(t,i),!0},getPassDisplayChildrenToComponent:function(){return this._passDisplayChildrenToComponent},outPassDisplayChildrenToComponentChange:function(t,e){this._out("passDisplayChildrenToComponentChange",t,e)},_findChildElements_DisplayParent:function(t){this._passDisplayChildrenToComponent&&t.push.apply(t,this.displayChildren.getItems())},_setClosestComponent_DisplayParent:function(t,e){this._passDisplayChildrenToComponent&&Amm.Trait.Component.changeComponent(this.displayChildren,t,e),this._observeDisplayChildrenForComponent()},_cleanup_DisplayParent:function(){this.displayChildren.cleanup()},_handleDisplayChildCleanup:function(t){var e,i;t.getDisplayParent()===this&&(e=this.displayChildren.getAllowDelete(),i=this.displayChildren.getAllowChangeOrder(),this.displayChildren.setAllowDelete(!0),this.displayChildren.setAllowChangeOrder(!0),this.displayChildren.reject(t),this.displayChildren.setAllowDelete(e),this.displayChildren.setAllowChangeOrder(i))}},Amm.Trait.Repeater=function(){},Amm.Trait.Repeater.prototype={Repeater:"__INTERFACE__",InstantiatorOrRepeater:"__INTERFACE__",_useFilter:!0,_arrayMapperOptions:null,_reportedInstantiatorOptions:null,_withVariantsView:!1,_assocProperty:null,_revAssocProperty:null,_repeaterItems:null,__augment:function(t,e){var i;"object"==typeof e&&e&&"withVariantsView"in e&&(this._withVariantsView=!!e.withVariantsView,delete e.withVariantsView),Amm.Element.regInit(this,"99.Amm.Trait.Repeater",function(){if("__INTERFACE__"!==this.DisplayParent)throw Error("Repeater must be also a DisplayParent")}),"items"in e&&(i=e.items,Amm.Element.regInit(this,"99.Amm.Trait.Repeater.setItems",function(){this.setItems(i)}),delete e.items),e&&e.initialInstantiatorOptions&&(this._reportedInstantiatorOptions=e.initialInstantiatorOptions,delete e.initialInstantiatorOptions)},setItems:function(t){t?t instanceof Array||t["Amm.Array"]||(t=[t]):t=[],this._withVariantsView&&!this._arrayMapper?this._repeaterItems=t:this.getArrayMapper().setSrc(t)},getItems:function(){return this.getArrayMapper().getSrc()},outItemsChange:function(t,e){return this._out("itemsChange",t,e)},_handleArrayMapperSrcChange:function(t,e){this.outItemsChange(t,e)},getArrayMapper:function(){return this._arrayMapper||this._createArrayMapper(),this._arrayMapper},setArrayMapper:function(t){console.warn("Amm.Trait.Repeater: setArrayMapper() isn't supported; use setArrayMapperOptions() instead")},outArrayMapperChange:function(t,e){return this._out("arrayMapperChange",t,e)},_createArrayMapper:function(){var t,e=this._arrayMapper;this.displayChildren.setCleanupOnDissociate(!0),e&&(t=e.getSrcIsOwn()?e.getSrc().getItems():e.getSrc(),e.cleanup());var i=this._calcArrayMapperOptions.apply(this,this._reportedInstantiatorOptions||[]);t?i.src=t:this._repeaterItems&&(i.src=this._repeaterItems,this._repeaterItems=null),this._arrayMapperOptions&&(i=Amm.overrideRecursive(i,this._arrayMapperOptions));var r=Amm.constructInstance(i,Amm.ArrayMapper);this._arrayMapper=r,this.outArrayMapperChange(this._arrayMapper,e)},_calcArrayMapperOptions:function(t,e,i){var r=e&&e.length||!t?{class:Amm.Instantiator.Variants,prototypes:i||[],defaultPrototype:t||null}:{class:Amm.Instantiator.Proto,isElement:!0,proto:t},n={dest:this.displayChildren,filter:{class:Amm.Filter,conditions:e},instantiator:r};return e&&e.length||delete n.filter,this._assocProperty&&(n.instantiator.assocProperty=this._assocProperty),this._revAssocProperty&&(n.instantiator.revAssocProperty=this._revAssocProperty),n},_cleanup_Repeater:function(){this._arrayMapper.cleanup()},setArrayMapperOptions:function(t){if(t=t||null,this._arrayMapperOptions!==t)return this._arrayMapperOptions=t,this._arrayMapper&&this._createArrayMapper(),!0},getArrayMapperOptions:function(){return this._arrayMapperOptions},reportInstantiatorOptions:function(t,e,i){this._reportedInstantiatorOptions=[t,e,i],this._createArrayMapper()},setAssocProperty:function(t){if(this._assocProperty!==t)return this._assocProperty=t,this._arrayMapper&&this._createArrayMapper(),!0},getAssocProperty:function(){return this._assocProperty},setRevAssocProperty:function(t){if(this._revAssocProperty!==t)return this._revAssocProperty=t,this._arrayMapper&&this._createArrayMapper(),!0},getRevAssocProperty:function(){return this._revAssocProperty}},Amm.Trait.Data=function(){},Amm.Trait.Data.UPDATE_VALIDATE="validate",Amm.Trait.Data.UPDATE_CHANGE="change",Amm.Trait.Data.UPDATE_BLUR="blur",Amm.Trait.Data.UPDATE_NEVER="never",Amm.Trait.Data.LOCK_NEVER=0,Amm.Trait.Data.LOCK_DURING_TRANSACTION=1,Amm.Trait.Data.LOCK_WITHOUT_PROPERTY=2,Amm.Trait.Data._revDataUpdate={validate:"UPDATE_VALIDATE",change:"UPDATE_CHANGE",blur:"UPDATE_BLUR",never:"UPDATE_NEVER"},Amm.Trait.Data.prototype={Data:"__INTERFACE__",_dataObject:void 0,_dataProperty:void 0,_dataHasProperty:void 0,_dataValue:void 0,_dataSyncAnnotations:!0,_dataUpdateMode:void 0,_dataParent:void 0,_dataSyncWithField:void 0,_dataSyncProperties:null,_subDataObject:null,_subDataProperty:null,_dataObjectUpdating:0,_dataControlUpdating:0,_dataLockMode:Amm.Trait.Data.LOCK_DURING_TRANSACTION|Amm.Trait.Data.LOCK_WITHOUT_PROPERTY,_dataModified:void 0,__augment:function(t,e){this._dataSyncProperties={dataObject:void 0===this._dataObject,dataProperty:void 0===this._dataProperty,dataParent:void 0===this._dataParent},Amm.Element.regInit(this,"aa.Amm.Trait.Data",this._initDataSync)},_initDataSync:function(){void 0===this._dataSyncWithField&&(this.setDataSyncWithField("__INTERFACE__"===this.Field),void 0===this._dataUpdateMode&&("__INTERFACE__"===this.Field?this._dataUpdateMode=Amm.Trait.Data.UPDATE_VALIDATE:this._dataUpdateMode=Amm.Trait.Data.UPDATE_CHANGE)),void 0===this._dataProperty&&this._dataSyncProperty(),void 0===this._dataParent&&this._dataSyncParent(),"__INTERFACE__"===this.Focusable&&this.subscribe("focusedChange",this._handleSelfDataFocusedChange,this),this._dataUpdateModified(),this._dataUpdateLock()},_setComponent_Data:function(t){this._dataSyncParent()},_setForm_Data:function(t){this._dataSyncParent()},_setId_Data:function(){this._dataSyncProperty()},_fieldNameChange_Data:function(){this._dataSyncProperty()},_dataSyncParent:function(){var t;this._dataSyncProperties.dataParent&&(t=null,this._dataSyncWithField&&this._form&&"__INTERFACE__"===this._form.Data?t=this._form:this._component&&"__INTERFACE__"===this._component.Data&&(t=this._component),this.setDataParent(t,!0))},_dataSyncProperty:function(){var t=null;this._dataSyncProperties.dataProperty&&(this._dataSyncWithField&&this.getFieldName()?t=this.getFieldName():this._id&&(t=this._id),this.setDataProperty(t,!0))},_dataSyncObject:function(){var t=null;this._dataSyncProperties.dataObject&&(this._dataParent&&(t=this._dataParent.getDataProperty()?this._dataParent.getDataValue():this._dataParent.getDataObject()),t=t||null,this.setDataObject(t,!0))},setDataParent:function(t,e){var i=this._dataParent;if(i!==t)return e||(this._dataSyncProperties.dataParent=void 0===t),i&&(i.unsubscribe("dataObjectChange",this._dataSyncObject,this),i.unsubscribe("dataValueChange",this._dataSyncObject,this)),(this._dataParent=t)&&(t.subscribe("dataObjectChange",this._dataSyncObject,this),t.subscribe("dataValueChange",this._dataSyncObject,this)),this._dataSyncObject(),this.outDataParentChange(t,i),!0},getDataParent:function(){return this._dataParent},outDataParentChange:function(t,e){this._out("dataParentChange",t,e)},setDataObject:function(t,e){t?Amm.is(t,"Amm.Data.Model",t):void 0!==t&&(t=null);var i=this._dataObject;if(i!==t)return this._dataObject=t,i&&(i.mm.unsubscribe("propertiesChanged",this._dataCheckProperty,this),i.mm.unsubscribe("errorsChange",this._handleDataErrorsChange,this),i["Amm.Data.Record"]&&i.mm.unsubscribe("transactionChange",this._handleDataTransactionChange,this),i.mm.unsubscribe("modifiedChange",this._dataUpdateModified,this),i.mm.unsubscribe("metaChange",this._handleDataMetaChange,this)),e||(this._dataSyncProperties.dataObject=void 0===t),t&&(t.mm.subscribe("propertiesChanged",this._dataCheckProperty,this),t.mm.subscribe("errorsChange",this._handleDataErrorsChange,this),t["Amm.Data.Record"]&&t.mm.subscribe("transactionChange",this._handleDataTransactionChange,this),t.mm.subscribe("modifiedChange",this._dataUpdateModified,this),t.mm.subscribe("metaChange",this._handleDataMetaChange,this)),this.outDataObjectChange(t,i),this._dataUpdateModified(),this._dataUpdateLock(),this._dataCheckProperty(),this._dataSyncMeta(),this._dataSyncErrors(),!0},getDataObject:function(){return this._dataObject},outDataObjectChange:function(t,e){this._out("dataObjectChange",t,e)},_handleDataTransactionChange:function(){this._dataUpdateLock()},_handleDataErrorsChange:function(t){this._dataSyncErrors()},_dataSyncErrors:function(){var t=null;!this._dataSyncWithField&&"__INTERFACE__"!==this.Annotated||(this._dataHasProperty&&(t=this._dataObject.mm.getErrors(this._dataProperty)),this._dataSyncWithField?this.setFieldRemoteErrors(t):this.setError(t))},_handleDataMetaChange:function(t,e,i,r,n,s){this._dataHasProperty&&(i&&i!==this._dataProperty||this._dataSyncMeta(t[this._dataProperty]))},_dataSyncMeta:function(t){var e;this._dataHasProperty&&this._dataSyncAnnotations&&(t=t||this._dataObject.mm.getMeta(this._dataProperty),(e=this._dataSyncWithField)?(this.setFieldLabel(t.label),this.setFieldRequired(t.required)):"__INTERFACE__"===this.Annotated&&(e||(this.setLabel(t.label),this.setRequired(t.required)),this.setDescription(t.description,"description")))},setDataProperty:function(t){var e=this._dataProperty;if(e!==t)return this._dataProperty=t,this.outDataPropertyChange(t,e),this._dataCheckProperty(),!0},getDataProperty:function(){return this._dataProperty},outDataPropertyChange:function(t,e){this._out("dataPropertyChange",t,e)},_dataCheckProperty:function(){var t=!1;this._dataObject&&this._dataProperty&&(t=Amm.detectProperty(this._dataObject,this._dataProperty));var e=this._subDataObject===this._dataObject&&this._subDataProperty===this._dataProperty;this._subDataObject&&!e&&(this._subDataObject.unsubscribe(this._subDataProperty+"Change",this._handleDataValueChange,this),this._subDataObject=null,this._subDataProperty=null),t&&!e&&(this._subDataObject=this._dataObject,this._subDataProperty=this._dataProperty,this._subDataObject.subscribe(this._subDataProperty+"Change",this._handleDataValueChange,this),this._dataObjectUpdating++,this.setDataValue(this._subDataObject[this._subDataProperty]),this._dataObjectUpdating--),this.setDataHasProperty(t)},_handleDataValueChange:function(t){this._dataObjectUpdating++,this.setDataValue(t),this._dataUpdateModified(),this._dataObjectUpdating--},setDataHasProperty:function(t){t=!!t;var e=this._dataHasProperty;if(e!==t)return this._dataHasProperty=t,this._dataUpdateLock(),this._dataUpdateModified(),this.outDataHasPropertyChange(t,e),t&&(this._dataUpdateValueSync(),this._dataSyncMeta(this._dataObject.mm.getMeta(this._dataProperty))),!0},getDataHasProperty:function(){return this._dataHasProperty},outDataHasPropertyChange:function(t,e){this._out("dataHasPropertyChange",t,e)},setDataValue:function(t,e){var i=this._dataValue;if(i!==t||e)return this._dataValue=t,!this._dataObjectUpdating&&this._dataHasProperty&&(this._dataObject[this._dataProperty]=t),this._dataControlUpdating||(this._dataSyncWithField?this.setFieldValue(t):this.setValue(t)),e&&i===t||this.outDataValueChange(t,i),!0},getDataValue:function(){return this._dataValue},outDataValueChange:function(t,e){this._out("dataValueChange",t,e)},setDataSyncAnnotations:function(t){if(t=!!t,this._dataSyncAnnotations!==t)return(this._dataSyncAnnotations=t)&&this._dataHasProperty&&this._dataSyncMeta(this._dataObject.mm.getMeta(this._dataProperty)),!0},getDataSyncAnnotations:function(){return this._dataSyncAnnotations},setDataUpdateMode:function(t){if(!Amm.Trait.Data._revDataUpdate[t])throw Error("dataUpdateMode must be one of Amm.Trait.Data.UPDATE_*");if(this._dataUpdateMode!==t)return this._dataUpdateMode=t,this._dataSyncUpdateMode(),!0},getDataUpdateMode:function(){return this._dataUpdateMode},setDataSyncWithField:function(t){if((t=!!t)&&"__INTERFACE__"!==this.Field)throw Error("Need Field trait to enable data sync with field");if(this._dataSyncWithField!==t)return this._dataSyncWithField=t,this._dataUpdateValueSync(),!0},_dataUpdateValueSync:function(){var t="function"==typeof this.outValueChange,e="__INTERFACE__"===this.Field;this._dataSyncWithField?(t&&this.unsubscribe("valueChange",this._handleSelfControlValueChange,this),this.subscribe("fieldValueChange",this._handleSelfControlValueChange,this),this.subscribe("afterFieldValidate",this._handleSelfDataAfterFieldValidate,this)):(t&&this.subscribe("valueChange",this._handleSelfControlValueChange,this),e&&(this.unsubscribe("fieldValueChange",this._handleSelfControlValueChange,this),this.unsubscribe("afterFieldValidate",this._handleSelfDataAfterFieldValidate,this)))},getDataSyncWithField:function(){return this._dataSyncWithField},_updateDataValueFromControl:function(t){this._dataControlUpdating++,arguments.length||(t=this._dataSyncWithField?this.getFieldValue():this.getValue()),this.setDataValue(t),this._dataControlUpdating--},_handleSelfDataAfterFieldValidate:function(t){this._dataUpdateMode===Amm.Trait.Data.UPDATE_VALIDATE&&t&&this._updateDataValueFromControl()},_handleSelfControlValueChange:function(t,e){this._dataObjectUpdating||this._dataUpdateMode===Amm.Trait.Data.UPDATE_CHANGE&&this._updateDataValueFromControl(t)},_handleSelfDataFocusedChange:function(t){t||this._dataUpdateMode===Amm.Trait.Data.UPDATE_BLUR&&this._updateDataValueFromControl()},setDataLockMode:function(t){if("Number"!=typeof(t=t||0))throw Error("dataLockMode must be a number");if(this._dataLockMode!==t)return this._dataLockMode=t,this._dataUpdateLock(),!0},getDataLockMode:function(){return this._dataLockMode},_dataUpdateLock:function(){var t;"__INTERFACE__"===this.Lockable&&this._dataLockMode&&(t=!1,this._dataLockMode&Amm.Trait.Data.LOCK_WITHOUT_PROPERTY&&(this._dataHasProperty||(t=!0)),this._dataLockMode&Amm.Trait.Data.LOCK_DURING_TRANSACTION&&this._dataObject&&this._dataObject["Amm.Data.Record"]&&this._dataObject.mm.getTransaction()&&(t=!0),this.setLocked(t))},setDataModified:function(t,e){t=!!t;var i=this._dataModified;if(i!==t&&(e||!t)){if(e||t||!this._dataHasProperty)return this._dataModified=t,this.outDataModifiedChange(t,i),!0;this.setDataValue(this._dataObject.mm.getOldValue(this._dataProperty))}},outDataModifiedChange:function(t,e){return this._out("dataModifiedChange",t,e)},getDataModified:function(){return this._dataModified},_dataUpdateModified:function(){var t=!1;this._dataHasProperty?t=this._dataObject.mm.getModified(this._dataProperty):this._dataObject&&!this._dataProperty&&(t=this._dataObject.mm.getModified()),this.setDataModified(t,!0)}},Amm.Builder.Node=function(t){this.children=[],this.connected=[this],this.conIdx=0,t&&Amm.override(this,t)},Amm.Builder.Node.prototype={htmlElement:null,v:null,e:null,x:null,id:null,global:!1,parent:null,children:null,connected:null,conIdx:null,conParent:!1,conChild:!1},Amm.Builder.Ref=function(t,e){window.r=this,t&&"$ref"in t&&(!t.$ref||"find"in t||(t.find=t.$ref),delete t.$ref),e&&this.setNode(e),Amm.init(this,t)},Amm.Builder.Ref.prototype={"Amm.Builder.Ref":"__CLASS__",_node:null,_parent:0,_closest:null,_find:null,_index:0,_global:!1,toJSON:function(){var t={$ref:this._find};return null!==this._closest&&(t.closest=this._closest),0!==this._index&&(t.index=this._index),this._global&&(t.global=this._global),this._parent&&(t.parent=this._parent),t},setNode:function(t){if(t){if(!(t instanceof HTMLElement||t.tagName))throw Error("`node` must be an instance of HTMLElement")}else t=null;this._node=t},getNode:function(){return this._node},setGlobal:function(t){t=!!t,this._global=t},getGlobal:function(){return this._global},setParent:function(t){if("number"!=typeof t&&(t=parseInt(t)),isNaN(t)||t<0)throw Error("`parent` must be a number >= 0");this._parent=t},getParent:function(){return this._parent},setClosest:function(t){if(t){if("string"!=typeof t)throw Error("`closest` must be a null or a string")}else t=null;this._closest=t},getClosest:function(){return this._closest},setFind:function(t){this._find=t},getFind:function(){return this._find},setIndex:function(t){if(null!==t&&"number"!=typeof t&&(t=parseInt(t),isNaN(t)||t<0))throw Error("`index` must be a number >= 0");this._index=t},getIndex:function(){return this._index},resolve:function(t){if(!this._global&&!this._node)throw Error("Cannot resolve without `node`");var e=this._global?jQuery:jQuery(this._node);if(this._parent&&!this._global){for(var i=0;i<this._parent&&e.length;i++)e=e.parent();if(!e.length)return null}return this._closest&&!this._global&&!(e=e.closest(this._closest))||this._find&&!(e=e.find(this._find))?null:null!==this._index?e[this._index]||null:t?e[0]||null:e}},Amm.Filter=function(t){Amm.FilterSorter.call(this,t)},Amm.Filter.prototype={"Amm.Filter":"__CLASS__",_oldMatchingObjects:null,_matchingObjects:null,filter:function(t,e){e instanceof Array?e.splice(0,e.length):e=[];for(var i,r=[],n=0,s=t.length;n<s;n++)(i=this.evaluateMatch(t[n]))&&(r.push(t[n]),e.push(i));return r},setConditions:function(t,e){var i,r=null;if(this._subscribers.outConditionsChange&&(i=[].concat(this._observers)),e){if(t){if("object"!=typeof t)throw Error("setConditions(`conditions`, `id`): `conditions` must be a null or an object");t._id=e,r=this._createCondition(t)}for(this.beginUpdate(),o=0,a=this._observers.length;o<a;o++)if(this._observers[o].id===e){this._observers[o].cleanup(),this._observers.splice(o,1);break}return this._observers.push(r),this._subscribers.outConditionsChange&&this.outConditionsChange([].concat(this._observers),i),r.observe(this._objects),this.refresh(),void this.endUpdate()}var n=[];if(t){if(!(t instanceof Array))throw Error("`conditions` must be an Array");for(var s={},o=0,a=t.length;o<a;o++)if(r=this._createCondition(t[o]),n.push(r),r.id){if(r.id in s)throw Error("conditions['"+o+"'].id is same as conditions['"+s[r.id]+"'] ('"+r.id+"')");s[r.id]=o}}for(this.beginUpdate(),o=this._observers.length-1;0<=o;o--)this._observers[o].cleanup();this._observers=n,this._subObservers(this._objects),this._subscribers.outConditionsChange&&this.outConditionsChange([].concat(this._observers),i),this.refresh(),this.endUpdate()},getConditions:function(t){var e,i;if(!t)return[].concat(this._observers);for(e=0,i=this._observers.length;e<i;e++)if(t===e+1||this._observers[e].id===t)return this._observers[e];return null},outConditionsChange:function(t,e){return this._out("conditionsChange",t,e)},outMatchingObjectsChange:function(t,e){return this._out("matchingObjectsChange",t,e)},beginUpdate:function(){this._updateLevel||(this._oldMatchingObjects=this.getMatchingObjects()),Amm.FilterSorter.prototype.beginUpdate.call(this),this._matchingObjects=null},_doOnEndUpdateChange:function(){var t,e;this._subscribers.matchingObjectsChange&&(t=this.getMatchingObjects(),Amm.Array.equal(t,this._oldMatchingObjects)||(e=this._oldMatchingObjects,this._oldMatchingObjects=null,this.outMatchingObjectsChange(t,e)))},_createCondition:function(t){if(t&&"string"==typeof t&&(console.log(t),t={_expr:t}),!t||"object"!=typeof t)throw Error("filter condition must be an object, given: "+Amm.describeType(t));return t._expr?new Amm.Filter.ExpressionCondition(this,t):new Amm.Filter.PropsCondition(this,t)},setRequireAll:function(t){t=!!t;var e=this._requireAll;if(e!==t)return this._requireAll=t,this.outRequireAllChange(t,e),this._observers.length&&this.refresh(),!0},getRequireAll:function(){return this._requireAll},outRequireAllChange:function(t,e){this._out("requireAllChange",t,e)},getMatchingObjects:function(){if(this._matchingObjects)return this._matchingObjects;for(var t=[],e=0,i=this._objects.length;e<i;e++)this._matches[e]&&t.push(this._objects[e]);return this._oldMatchingObjects&&Amm.Array.equal(t,this._oldMatchingObjects)&&(t=this._oldMatchingObjects),this._matchingObjects=t},_doOnUpdateMatch:function(t,e,i){if(!!i!=!!e&&(this._matchingObjects=null,this._subscribers.matchingObjectsChange)){for(var r=[],n=[],s=0,o=this._objects.length;s<o;s++)s===t&&e&&n.push(this._objects[s]),this._matches[s]&&(r.push(this._objects[s]),n.push(this._objects[s]));this._matchingObjects=r,this.outMatchingObjectsChange(r,n)}},evaluateMatch:function(t){if(!this._observers.length)return!0;for(var e,i=0,r=this._observers.length;i<r;i++)if(e=!1,this._observers[i].match(t)&&(e=this._observers[i].id||i+1),this._requireAll){if(!e)return!1}else if(e)return e;return!!this._requireAll&&e},_hasChangeSubscribers:function(){return this._subscribers.matchesChange||this._subscribers.matchingObjectsChange}},Amm.extend(Amm.Filter,Amm.FilterSorter),Amm.Filter.Condition=function(t,e){e&&e._id&&(this.id=e._id,delete e._id),e&&e._class&&(this.requiredClass=e._class,delete e._class),e&&e._not&&(this.not=!0,delete e._not),Amm.FilterSorter.Observer.call(this,t,e,!0)},Amm.Filter.Condition.testValue=function(t,e){var i,r;if(t instanceof Array||t&&t["Amm.Array"]){if("object"==typeof e&&e&&e.only){for(i=0,r=t.length;i<r;i++)if(!Amm.Filter.Condition.testValue(t[i],e.only))return!1;return!0}for(i=0,r=t.length;i<r;i++)if(Amm.Filter.Condition.testValue(t[i],e))return!0;return!1}if(!(e instanceof Array)){if(e instanceof RegExp)return"string"==typeof t&&e.exec(t);if("function"==typeof e)return!!e(t);if("object"==typeof e&&e){if("and"in e){if(!(e.and&&e.and instanceof Array))return Amm.Filter.Condition.testValue(t,e.and);for(i=0,r=e.and.length;i<r;i++)if(!this.testValue(t,e.and[i]))return!1;return!0}if("only"in e)return Amm.Filter.Condition.testValue(t,e.only);if("typeof"in e)return Amm.Filter.Condition.testValue(typeof t,e.typeof);if("function"==typeof e.fn)return e.scope?e.fn.call(e.scope,t):e.fn(t);if("regExp"in e)return Amm.Filter.Condition.testValue(t,new RegExp(e.regExp,e.flags||""));if("validator"in e)return!Amm.Validator.iErr(e,"validator",t);if(e["Amm.Validator"])return!e.getError(t);if("strict"in e)return t===e.strict;if("rq"in e)return Amm.meetsRequirements(t,e.rq);if("not"in e)return!Amm.Filter.Condition.testValue(t,e.not);throw Error("object `test` must contain at least one of following keys: `and`, `only`, `fn`, `regExp`, `validator`, `strict`, `rq`, `not`")}return e==t}for(i=0,r=e.length;i<r;i++)if(this.testValue(t,e[i]))return!0},Amm.Filter.Condition.prototype={"Amm.Filter.Condition":"__CLASS__",id:null,requiredClass:null,not:!1,match:function(t){var e=!0,e=!(this.requiredClass&&!Amm.is(t,this.requiredClass))&&this._doMatch(t);return this.not&&(e=!e),e},_doMatch:function(t){return!0},setProps:function(t,e){},getProps:function(t){},outPropsChange:function(t,e){return this._out("propsChange",t,e)}},Amm.extend(Amm.Filter.Condition,Amm.FilterSorter.Observer),Amm.Filter.PropsCondition=function(t,e){"_allowExpressions"in(e=Amm.override({},e))&&(this.allowExpressions=!!e._allowExpressions,delete e._allowExpressions),this._props={},this._expressions={},this._evaluators={},this._propList=[],Amm.Filter.Condition.call(this,t,e),this.setProps(e)},Amm.Filter.propNameRx=/^\w+$/,Amm.Filter.PropsCondition.prototype={"Amm.Filter.PropsCondition":"__CLASS__",allowExpressions:!0,_props:null,_expressions:null,_evaluators:null,_propList:null,_noRefresh:0,_checkProps:function(t,e){e=e||{};for(var i=0,r=t.length;i<r;i++)if(!Amm.Filter.propNameRx.exec(t[i])){if(!this.allowExpressions)throw Error("'"+t[i]+"' doesn't look like simple property name;  set `allowExpressions` to true to access expression values");this._expressions[t[i]]?e[t[i]]=this._expressions[t[i]]:(e[t[i]]=new Amm.Expression(t[i]),e[t[i]].setEventsProxy(this._filterSorter))}},setProps:function(t,e){this._noRefresh++;var i,r,n,s={};this._subscribers.propsChange&&(i=Amm.override({},this._props)),e?(r=!(e in this._props),this._checkProps([e],s),this._props[e]=t,r&&(this.allowExpressions&&Amm.override(this._expressions,s),this._propList.push(e),this._sub(e))):t?(n=Amm.keys(t),this._checkProps(n,s),this.deleteProps(null,s),this.allowExpressions&&Amm.override(this._expressions,s),this._props=Amm.override({},t),this._propList=n,this._sub()):this.deleteProps(),this._subscribers.propsChange&&this.outPropsChange(this._props,i),this._noRefresh--,this._noRefresh||this._filterSorter.refresh()},_handleChange:function(){var t=Amm.event.origin;this._filterSorter.refresh(t)},_handleExpressionChange:function(t,e){var i=Amm.event.origin.getExpressionThis();this._filterSorter.refresh(i)},_sub:function(t,e){for(var i,r,n,s=e||this._filterSorter._objects,o=s.length,a=(t=t||this._propList).length,h=0;h<o;h++)if((i=s[h])["Amm.WithEvents"])for(n=0;n<a;n++)if(this._expressions[t[n]]){if(void 0!==this._expressions[t[n]].findContext(i))continue;this._expressions[t[n]].createContext({expressionThis:i}),this._expressions[t[n]].subscribe("valueChange",this._handleExpressionChange,this)}else r=t[n]+"Change",this.requiredClass&&!Amm.is(i,this.requiredClass)||i.hasEvent(r)&&this._filterSorter.subscribeObject(i,r,this._handleChange,this)},_unsub:function(t,e){for(var i,r,n,s,o=e||this._filterSorter._objects,a=o.length,h=(t=t||this._propList)?t.length:0,l=0;l<a;l++)if((i=o[l])["Amm.WithEvents"]&&(!this.requiredClass||Amm.is(i,this.requiredClass)))for(n=0;n<h;n++){this._expressions[t[n]]?void 0!==(s=this._expressions[t[n]].findContext(i))&&this._expressions[t[n]].deleteContext(s):(r=t[n]+"Change",this._expressions[t[n]]||i.hasEvent(r)&&this._filterSorter.unsubscribeObject(i,r,this._handleChange,this))}},_doMatch:function(t){for(var e,i,r,n=0,s=this._propList.length;n<s;n++)if(r=(e=this._expressions[this._propList[n]])?e.getExpressionThis()===t?e.getValue():void 0===(i=e.findContext(t))?(this._evaluators[this._propList[n]]||(this._evaluators[this._propList[n]]=e.toFunction()),this._evaluators[this._propList[n]].env.expressionThis=t,this._evaluators[this._propList[n]]()):(e.setContextId(i),e.getValue()):Amm.getProperty(t,this._propList[n]),!Amm.Filter.Condition.testValue(r,this._props[this._propList[n]]))return!1;return!0},observe:function(t){this._sub(this._propList,t)},unobserve:function(t){this._unsub(null,t)},getProps:function(t){return t?this._props[t]:this._props},deleteProps:function(t,e){if(!t||t instanceof Array||(t=[t]),this._unsub(t),t){for(var i=0,r=t.length;i<r;i++)this._props(t[i]),this._expressions[t[i]]&&(e&&e[t[i]]||(this._expressions[t[i]].cleanup(),this._evaluators[[t[i]]]&&(this._evaluators[[t[i]]].env.expressionThis={},delete this._evaluators[[t[i]]]),delete this._expressions[t[i]]));this._propList=Amm.Array.diff(this._propList,t)}else this._props={},this._propList=[];this._noRefresh||this._filterSorter.refresh()},cleanup:function(){for(var t in Amm.Filter.Condition.prototype.cleanup.call(this),this._expressions)this._expressions.hasOwnProperty(t)&&this._expressions[t].cleanup();this._expressions={},this._evaluators={},this._propList=[],this._props={}}},Amm.extend(Amm.Filter.PropsCondition,Amm.Filter.Condition),Amm.Filter.ExpressionCondition=function(t,e){Amm.override({},e);var i=null;if(e._expr&&(i=e._expr,delete e._expr),!i)throw Error("options._expr must be provided for Amm.Filter.ExpressionCondition");Amm.Filter.Condition.call(this,t,e),this._props=Amm.override({},e),this._setExpression(i)},Amm.Filter.ExpressionCondition.prototype={"Amm.Filter.ExpressionCondition":"__CLASS__",_expression:null,_evaluator:null,_props:null,_setExpression:function(t){this._expression=new Amm.Expression(t),this._expression.setEventsProxy(this._filterSorter)},_handleExpressionChanged:function(t,e){var i=this._expression.getExpressionThis();this._filterSorter.refresh(i)},match:function(t){if(t===this._expression.getExpressionThis())return this._expression.getValue();var e=this._expression.findContext(t);return void 0!==e?(this._expression.setContextId(e),this._expression.getValue()):(this._evaluator||(this._evaluator=this._expression.toFunction()),this._evaluator.env.expressionThis=t,this._evaluator.env.vars=this._props,this._evaluator())},observe:function(t){for(var e=0,i=t.length;e<i;e++){var r=t[e];void 0===this._expression.findContext(r)&&(this._expression.createContext({expressionThis:r,vars:this._props}),this._expression.subscribe("valueChange",this._handleExpressionChanged,this))}},unobserve:function(t){for(var e=0,i=t.length;e<i;e++){var r=this._expression.findContext(t[e]);void 0!==r&&this._expression.deleteContext(r)}},cleanup:function(){Amm.Filter.Condition.prototype.cleanup.call(this),this._expression.cleanup(),this._evaluator=null,this._expression=null,this._props={}},setProps:function(t,e){var i;if(this._subscribers.propsChange&&(i=Amm.override({},this._props)),e)this._props[e]=t;else{if(!t||"object"!=typeof t)throw Error("`props` must be a non-null object when `propName` not provided");this._props=e}if(this._expression){this._filterSorter&&this._filterSorter.beginUpdate();for(var r=this._expression.listContexts(),n=0,s=r.length;n<s;n++)this._expression.setContextId(r[n]),this._expression.setVars(t,e);this._filterSorter&&this._filterSorter.endUpdate()}this._subscribers.propsChange&&this.outPropsChange(this._props,i)},getProps:function(t){return void 0!==t?this._props[t]:this._props}},Amm.extend(Amm.Filter.ExpressionCondition,Amm.Filter.Condition),Amm.Data={isEmpty:function(t){if(!t)return!0;if(t instanceof Array)return!t.length;if("object"!=typeof t)return!1;for(var e in t)if(t.hashOwnProperty(e))return!isEmpty(t[e]);return!0},flattenErrors:function(t,e){if(!t)return[];if("object"!=typeof t)return[t];var i,r,n=e||[],e=e||n;if(t instanceof Array)for(i=0,r=t.length;i<r;i++)Amm.Data.isEmpty(t[i])||("object"==typeof t[i]&&t[i]&&Amm.Data.flattenErrors(t[i],n),Amm.Array.indexOf(e,t[i])<0&&e.push(t[i]));else for(i in t)if(t.hasOwnProperty(i)){if(Amm.Data.isEmpty(t[i]))continue;if("object"==typeof t[i]&&t[i]&&Amm.Data.flattenErrors(t[i],n),t[i]instanceof Array&&!t[i].length){delete t[i];continue}Amm.Array.indexOf(e,t[i])<0&&e.push(t[i])}return n}},Amm.Data.STATE_NEW="new",Amm.Data.STATE_EXISTS="exists",Amm.Data.STATE_DELETED="deleted",Amm.Data.StateEnum={},Amm.Data.StateEnum[Amm.Data.STATE_NEW]=Amm.Data.STATE_NEW,Amm.Data.StateEnum[Amm.Data.STATE_EXISTS]=Amm.Data.STATE_EXISTS,Amm.Data.StateEnum[Amm.Data.STATE_DELETED]=Amm.Data.STATE_DELETED,Amm.Data.ERROR_OTHER="ERROR_OTHER",Amm.Data.ERROR_GENERIC="ERROR_GENERIC",Amm.Data.ERROR_EXCEPTION="ERROR_EXCEPTION",Amm.Data.AUTO_CHECK_NEVER=0,Amm.Data.AUTO_CHECK_SMART=1,Amm.Data.AUTO_CHECK_ALWAYS=2,Amm.Data.MetaProvider=function(t){this._meta={},t&&"metaClass"in t&&(this.metaClass=t.metaClass)},Amm.Data.MetaProvider.prototype={MetaProvider:"__INTERFACE__",metaClass:"Amm.Data.FieldMeta",requiredValidatorPrototype:null,_meta:null,_combinedMeta:null,_metaProvider:null,_requiredValidator:null,_modelValidators:null,_metaUpdating:0,_metaChanged:!1,setModelValidators:function(t){if("object"!=typeof t)throw Error("modelValidators must be an object or null");return this._modelValidators=Amm.Data.MetaProvider.checkValidatorsHash(t,"modelValidators"),!0},getModelValidators:function(t){if(!t||!this._metaProvider)return this._modelValidators;var e={};return this._modelValidators&&Amm.override(e,this._modelValidators),this._metaProvider&&Amm.override(e,this._metaProvider.getModelValidators(!0)),e},setMetaProvider:function(t){t=t||null;var e=this._metaProvider;if(e!==t)return e&&e.unsubscribe("metaChange",this._handleProviderMetaChange,this),this._metaProvider=t,this._combinedMeta=null,this._metaProvider&&this._metaProvider.subscribe("metaChange",this._handleProviderMetaChange,this),this.outMetaChange(),!0},getMetaProvider:function(){return this._metaProvider},_combineMeta:function(){return this._combinedMeta?this._combinedMeta:this._metaProvider?(this._combinedMeta={},Amm.override(this._combinedMeta,this._metaProvider.getMeta(),this._meta),this._combinedMeta):(this._combinedMeta=this._meta,this._meta)},beginUpdateMeta:function(){this._metaUpdating++},endUpdateMeta:function(){if(!this._metaUpdating)throw Error("Cannot call endUpdateMeta() without prior call to beginUpdateMeta()");this._metaUpdating--,!this._metaUpdating&&this._metaChanged&&(this._metaChanged=!1,this.outMetaChange())},_createMetas:function(t,e){var i,r={};for(i in t)t.hasOwnProperty(i)&&(r[i]=this._createMeta(t[i],i,!0));if(e)return r;for(i in this.beginUpdateMeta(),this._meta={},r)r.hasOwnProperty(i)&&this._assignMeta(r[i],i);return this.endUpdateMeta(),r},_createMeta:function(t,e,i){var r={};void 0!==e&&(r.name=e),r.metaProvider=this;var n=Amm.constructInstance(t,this.metaClass,r,!0);return e=n.getName(),!i&&e&&this._assignMeta(n,e),n},_assignMeta:function(t,e){this._meta||(this._meta={});var i=this._meta[e];i!==t&&(delete this._meta[e],i&&i.setMetaProvider(null),this._meta[e]=t,this.outMetaChange(this._meta,{},e,void 0,t,i))},setMeta:function(t,e,i){if(!e)return this._createMetas(t),!0;if(!i)return t?this._createMeta(t,e):this._meta[e]&&(this._meta[e].setMetaProvider(null),delete this._meta[e],this.outMetaChange()),!0;var r,n=this._meta[e];if(!n&&(r=this._metaProvider.getMeta(e)))return this.beginUpdateMeta(),n=r.clone(this),this._assignMeta(n,e),n.setProperty(t,i),void this.endUpdateMeta();if(!n)throw Error("Cannot set property of non-existent meta '"+e+"'");n.setProperty(t,i)},getMeta:function(t,e){return this._combinedMeta||this._combineMeta(),t?t in this._combinedMeta?e?this._combinedMeta[t][e]:this._combinedMeta[t]:void 0:Amm.override({},this._combinedMeta)},notifyMetaChange:function(t,e,i,r,n){this._meta&&this._meta[e]===t&&this.outMetaChange(t,null,e,i,r,n)},outMetaChange:function(t,e,i,r,n,s){if(i||(this._combinedMeta=null),!this._metaUpdating)return this._onMetaChange(i,r,n,s),this._out("metaChange",this._combineMeta(),null,i,r,n,s);this._metaChanged=!0},_onMetaChange:function(t,e,i,r,n,s){},getRequiredValidator:function(){if(this._requiredValidator)return this._requiredValidator;var t=this.requiredValidatorPrototype||Amm.Data.MetaProvider.requiredValidatorPrototype;return this._requiredValidator=Amm.constructInstance(Amm.override({},t),"Amm.Validator"),this._requiredValidator},getFieldValidators:function(t){var e=this.getMeta(t);if(!e)return null;var i=[];e.required&&i.push(this.getRequiredValidator());var r=e.validators;return r&&r.length&&(i=i.concat(r)),i.length?i:null},_handleProviderMetaChange:function(t,e,i,r,n,s){i&&this._meta&&this._meta[i]||this.outMetaChange(t,e,i,r,n,s)}},Amm.Data.MetaProvider.checkValidatorsHash=function(t,e){if(!t)return{};var i,r={};for(var n in t)if(t.hasOwnProperty(n)){if(!(i=t[n]))continue;if(i instanceof Array||(i=[i]),!i.length)continue;r[n]=Amm.Data.MetaProvider.checkValidatorsArray(i,e+"['"+n+"']")}return r},Amm.Data.MetaProvider.checkValidatorsArray=function(t,e){for(var i=[],r=t.length,n=0;n<r;n++){var s=t[n];if("function"!=typeof s)if("string"==typeof s)s=Amm.getFunction(s,!0)?Amm.constructInstance(s,"Amm.Validator"):new Amm.Expression(s);else{if(!s||"object"!=typeof s)throw new Error("name["+n+"] must be a function, a string or a non-null object");s.class&&(s=Amm.constructInstance(s)),Amm.meetsRequirements(s,["Amm.Expression","Amm.Validator"],e+"["+n+"]")}i.push(s)}return i},Amm.Data.MetaProvider.requiredValidatorPrototype={class:"Amm.Validator.Required"},Amm.Data.Mapper=function(t){Amm.Data.MetaProvider.call(this,t),Amm.WithEvents.call(this,t)},Amm.Data.Mapper.instances={},Amm.Data.Mapper.get=function(t,e){if(this.instances[t]||e)return this.instances[t]||null;throw Error("No such mapper: '"+t+"'")},Amm.Data.Mapper.transactionDefault=null,Amm.Data.Mapper.prototype={"Amm.Data.Mapper":"__CLASS__",_id:null,_key:"id",_recordPrototype:null,_recordClass:null,_interface:null,_transactionPrototypes:null,_uri:null,requireLoadDataNotEmpty:!0,requireLoadDataHasKey:!0,requireCreateDataHasKey:!0,partialHydrateOnCreate:!0,partialHydrateOnUpdate:!0,setId:function(t){if("string"!=typeof t||!t)throw Error("`id` must be a non-empty string");var e=this._id;if(e!==t){if(null!==e)throw Error("Can setId() only once");if(Amm.Data.Mapper.instances[t])throw Error("Mapper with id '"+t+"' already registered");return this._id=t,!0}},getId:function(){return this._id},setRecordPrototype:function(t){t=t||{};var e=this._recordPrototype;if(e!==t){if(null!==e)throw Error("can setRecordPrototype() only once");return this._recordPrototype=t,!0}},getRecordPrototype:function(){return this._recordPrototype?Amm.override({},this._recordPrototype):{}},setKey:function(t){if(this._key!==t)return this._key=t,!0},getKey:function(){return this._key},setRecordClass:function(t){var e=this._recordClass;if(e!==t){if(e!==t)throw Error("can setRecordClass() only once");return this._recordClass=t,!0}},getRecordClass:function(){return this._recordClass},construct:function(t){if(!t||"object"!=typeof t)throw Error("`objectOrArray` must be an object");if(t instanceof Array||t["Amm.Array"]){for(var e=[],i=0,r=t.length;i<r;i++)e.push(this.construct(t[i]));return e}if(Amm.getClass(t))throw Error("`objectOrArray` must have no class");var n=this.getRecordClass()||Amm.Data.Record,s=Amm.getFunction(n),o=Amm.override({},t);return o._mapper=this,new s(o)},setUri:function(t){if(this._uri!==t)return this._uri=t,!0},getUri:function(){return this._uri},setTransactionPrototypes:function(t){if("object"!=typeof t)throw Error("transactionPrototypes must be an object or null");if(this._transactionPrototypes!==t)return this._transactionPrototypes=t,!0},getTransactionPrototypes:function(){return this._transactionPrototypes},createTransaction:function(t,e,i){var r=this._transactionPrototypes||{},n=Amm.Data.Mapper.transactionDefault?Amm.override({},Amm.Data.Mapper.transactionDefault):{},s=r.default?Amm.overrideRecursive(n,r.default):{};r[t]&&(s=r[t].noDefault?Amm.override({},r[t]):Amm.overrideRecursive(r[t],s)),s.class||(s.class="Amm.Data.HttpTransaction"),!s.uri&&this._uri&&(s.uri=this._uri);var o=Amm.constructInstance(s,"Amm.Data.Transaction",{type:t,key:e||null,data:i||null});return o.subscribe("validateResult",this._validateTransactionResult,this),o},extractKey:function(t){var e=this._key;if(!(e instanceof Array))return e in t?t[e]:void 0;for(var i=[],r=e.length,n=0;n<r&&e[n]in t;n++)i.push(this.o._old[e[n]]);return i.length===r?i:void 0},_validateTransactionResult:function(t,e){var i=t.getData()||{};if(e.getType()===Amm.Data.Transaction.TYPE_LOAD){if(this.requireLoadDataNotEmpty){var r=!0;for(var n in i)if(i.hasOwnProperty(n)){r=!1;break}if(r)throw Error("TYPE_LOAD transaction result contains no data")}if(this.requireLoadDataHasKey&&void 0===this.extractKey(i))throw Error("Data of TYPE_LOAD transaction result contains no key")}else if(e.getType()===Amm.Data.Transaction.TYPE_CREATE&&this.requireCreateDataHasKey&&void 0===this.extractKey(i))throw Error("Data of TYPE_CREATE transaction result contains no key");e.unsubscribe("validateResult",this._validateTransactionResult,this)}},Amm.extend(Amm.Data.Mapper,Amm.WithEvents),Amm.extend(Amm.Data.Mapper,Amm.Data.MetaProvider),Amm.Data.Model=function(t){var e;t=t?Amm.override({},t):{},this._old={},this._data={},this._propNames={},Object.defineProperty(this,"mm",{get:function(){return this.getMm()},set:function(){}});var i=this._preInitOptions(t);void 0!==i&&(t=i);var r=null;t.mm&&"object"==typeof t.mm&&(r=t.mm);var n=this._getMmOptions();for(e in n?r&&(Amm.getClass(r)?n=r:(n=Amm.overrideRecursive({},n),Amm.overrideRecursive(n,r))):n=r,this._mm=new(Amm.getFunction(this._metaClass))(this,n||{}),delete t.mm,Amm.WithEvents.call(this,t,!0),t)t.hasOwnProperty(e)&&"function"==typeof t[e]&&(this[e]=t[e],delete t[e]);var s=!1;for(e in t)if(t.hasOwnProperty(e)){s=!0;break}s&&this._initData(t)},Amm.Data.Model.prototype={_metaClass:"Amm.Data.ModelMeta","Amm.Data.Model":"__CLASS__",_data:null,_old:null,_mm:null,_cu:!1,_state:Amm.Data.STATE_NEW,_propNames:null,_preUpdateValues:null,_errors:null,_oldErrors:null,_preInitOptions:function(t){},_initData:function(t){this.mm.hydrate(t)},_getMmOptions:function(){},getMm:function(){return this._mm},setMm:function(){},outMmChange:function(){},_doOnActual:function(t){},_doOnCheck:function(){},_doOnCompute:function(){},_checkField:function(t,e){},_handleMissingEvent:function(t,e,i,r){if(t.match(/Change$/))return!0},cleanup:function(){this._cu||(this._cu=!0,this.mm.cleanup(),this._data={},this._old={},Amm.WithEvents.prototype.cleanup.call(this))}},Amm.extend(Amm.Data.Model,Amm.WithEvents),Amm.Data.HttpResponse=function(t){this.httpHeaders=[],Amm.init(this,t)},Amm.Data.HttpResponse.prototype={"Amm.Data.HttpResponse":"__CLASS__",isError:!1,errorText:"",rawContent:null,parsedContent:null,httpHeaders:null,httpCode:null},Amm.Data.Record=function(t){Amm.Data.Model.call(this,t)},Amm.Data.Record.prototype={"Amm.Data.Record":"__CLASS__",_metaClass:"Amm.Data.RecordMeta",_mapper:null,_preInitOptions:function(t){var e;if(!t.__mapper)throw Error("__mapper is required");e=t.__mapper["Amm.Data.Mapper"]?t.__mapper:Amm.Data.Mapper.get(t.__mapperId),this._mapper=e;var i=this._mapper.getRecordClass();if(i&&!Amm.is(this,i))throw Error("Cannot use instance of "+Amm.getClass(this)+" with mapper "+e.getId()+"; required class is "+i);return delete(t=Amm.override(this._mapper.getRecordPrototype(),t)).__mapper,t},_doOnActual:function(t){},_doBeforeLoad:function(t){},_doAfterLoad:function(){},_doBeforeDelete:function(){},_doAfterDelete:function(){},_doBeforeSave:function(){},_doAfterSave:function(){}},Amm.extend(Amm.Data.Record,Amm.Data.Model),Amm.Data.Transaction=function(t){var e=!1;if(t&&"run"in t&&(e=(t=Amm.override({},t)).run,delete t.run),"__CLASS__"===this["Amm.Data.Transaction"])throw Error("Attempt to instantiate abstract class: Amm.Data.Transaction");Amm.WithEvents.call(this,t),e&&this.run()},Amm.Data.Transaction.TYPE_CREATE="create",Amm.Data.Transaction.TYPE_LOAD="load",Amm.Data.Transaction.TYPE_UPDATE="update",Amm.Data.Transaction.TYPE_DELETE="delete",Amm.Data.Transaction.STATE_INIT="init",Amm.Data.Transaction.STATE_RUNNING="running",Amm.Data.Transaction.STATE_SUCCESS="success",Amm.Data.Transaction.STATE_FAILURE="failure",Amm.Data.Transaction.STATE_CANCELLED="cancelled",Amm.Data.Transaction.DEFAULT_REQUIREMENTS={},Amm.Data.Transaction.DEFAULT_REQUIREMENTS[Amm.Data.Transaction.TYPE_CREATE]={key:!1,data:!0},Amm.Data.Transaction.DEFAULT_REQUIREMENTS[Amm.Data.Transaction.TYPE_LOAD]={key:!0,data:!1},Amm.Data.Transaction.DEFAULT_REQUIREMENTS[Amm.Data.Transaction.TYPE_UPDATE]={key:!0,data:!0},Amm.Data.Transaction.DEFAULT_REQUIREMENTS[Amm.Data.Transaction.TYPE_DELETE]={key:!0,data:!1},Amm.Data.Transaction.prototype={"Amm.Data.Transaction":"__CLASS__",_type:null,_state:Amm.Data.Transaction.STATE_INIT,key:null,data:null,requirements:null,_unparsedResponseClass:null,setType:function(t){this._type=t},getType:function(){return this._type},setState:function(t){var e=this._state;if(e!==t)return this._state=t,this.outStateChange(t,e),!0},getState:function(){return this._state},outStateChange:function(t,e){return this._out("stateChange",t,e)},setResult:function(e){if(!e||!e["Amm.Data.TransactionResult"])throw Error("`result` must be Amm.Data.TransactionResult");var t=this._result;if(t!==e){if(this._result)throw new Error("can setResult only once");if(!e.getIsError())try{this.outValidateResult(e,this)}catch(t){e.setException(t)}e.makeImmutable(),(this._result=e).getIsError()?this.setState(Amm.Data.Transaction.STATE_FAILURE):this.setState(Amm.Data.Transaction.STATE_SUCCESS),this.outResultChange(e,t)}},getResult:function(){return this._result},outValidateResult:function(t,e){return this._out("validateResult",t,e)},outResultChange:function(t,e){return this._out("resultChange",t,e)},_setException:function(t,e){var i={exception:t};e&&Amm.override(i,e),this.setResult(new Amm.Data.TransactionResult(i))},validate:function(t){var e=this.requirements?Amm.override({},this.requirements,Amm.Data.Transaction.DEFAULT_REQUIREMENTS):Amm.Data.Transaction.DEFAULT_REQUIREMENTS;if(e[this._type]){for(var i in e[this._type])if(e[this._type].hasOwnProperty(i)){var r=!!e[this._type][i],n=void 0!==this[i]&&null!==this[i];if(r!=n){if(!t)return!1;throw Error("Transaction doesn't meet requirements for type '"+this._type+"': property '"+i+"' is "+(n?"non-empty":"empty")+" while it should be "+(r?"non-empty":"empty"))}}return!0}},run:function(){if(this._state!==Amm.Data.Transaction.STATE_INIT)throw Error("Can run() only from Amm.Data.Transaction.STATE_INIT");try{this.validate(!0);var t={handled:!1};this.outRun(t),t.handled||this._runDefault(),this._state===Amm.Data.Transaction.STATE_INIT&&this.setState(Amm.Data.Transaction.STATE_RUNNING)}catch(t){console.warn(t),this._setException(t)}},outRun:function(t){return this._out("run",t)},_runDefault:function(){throw Error("Call to abstract method")},_parseDefault:function(t){throw Error("Call to abstract method")},cancel:function(){if(this._state!==Amm.Data.Transaction.STATE_RUNNING)throw Error("Can cancel() only Transaction with STATE_RUNNING");var t={handled:!1};this.outCancel(t),this.setState(Amm.Data.Transaction.STATE_CANCELLED)},outCancel:function(t){return this._out("cancel",t)},_cancelDefault:function(){throw Error("Call to abstract method")},setUnparsedResponse:function(t){if(!t||"object"!=typeof t)throw Error("`unparsedResponse` must be an object");this._unparsedResponseClass&&Amm.is(t,this._unparsedResponseClass,"unparsedResponse");var e={transactionResult:null};try{var i=null;this.outParseResponse(t,e),e.transactionResult||(e.transactionResult=this._parseDefault(t)),(i=Amm.constructInstance(e.transactionResult,Amm.Data.TransactionResult)).getImmutable()||i.setUnparsedResponse(t),this.setResult(i)}catch(t){if(this._result)throw t;this._setException(t)}},outParseResponse:function(t,e){return this._out(t,e)},cleanup:function(){this._state===Amm.Data.Transaction.STATE_RUNNING&&this.cancel(),Amm.WithEvents.prototype.cleanup.call(this)}},Amm.extend(Amm.Data.Transaction,Amm.WithEvents),Amm.Data.TransactionResult=function(t){Amm.init(this,t)},Amm.Data.TransactionResult.ERROR_TYPE_NONE=null,Amm.Data.TransactionResult.ERROR_TYPE_CLIENT="client",Amm.Data.TransactionResult.ERROR_TYPE_HTTP="http",Amm.Data.TransactionResult.ERROR_TYPE_SERVER="server",Amm.Data.TransactionResult._revErrorType={client:"CLIENT",http:"HTTP",server:"SERVER"},Amm.Data.TransactionResult.prototype={"Amm.Data.TransactionResult":"__CLASS__",_unparsedResponse:null,_errorType:null,_data:null,_errorData:null,_exception:null,_error:null,_immutable:!1,setUnparsedResponse:function(t){if("object"!=typeof(t=t||null))throw Error("`unparsedResponse` must be an object");if(this._unparsedResponse!==t)return this._checkMutability(),this._unparsedResponse=t,!0},getUnparsedResponse:function(){return this._unparsedResponse},_checkMutability:function(){if(this._immutable)throw Error("Cannot change property of immutable TransactionResult")},setErrorType:function(t){if((t=t||null)&&!(t in Amm.Data.TransactionResult._revErrorType))throw Error("`errorType` must be one of Amm.Data.TransactionResult.ERROR_TYPE_ constants");if(this._errorType!==t)return this._checkMutability(),this._errorType=t,!this._errorType&&this._error?this.setError(null):this._errorType&&!this._error&&this.setError({}),!0},getErrorType:function(){return this._errorType},setData:function(t){if(this._data!==t)return this._checkMutability(),this._data=t,!0},getData:function(){return this._data},setErrorData:function(t){if(this._errorData!==t)return this._checkMutability(),this._errorData=t,!0},getErrorData:function(){return this._errorData},setException:function(t){if(this._exception!==t)return this._checkMutability(),this._exception=t,this._errorType||this.setErrorType("client"),!0},getException:function(){return this._exception},setError:function(t){if(this._error!==t)return this._checkMutability(),this._error=t,!0},getError:function(){return this._error},getIsError:function(){return!!this._errorType},getIsSuccess:function(){return!this._errorType},makeImmutable:function(){this._immutable=!0},getImmutable:function(){return this._immutable}},Amm.Data.Interface=function(){},Amm.Data.Interface.prototype={_uri:null,_key:null,actionCreate:function(t){},actionLoad:function(t){},actionUpdate:function(t,e){},actionDelete:function(t){}},Amm.Data.ModelMeta=function(t,e){this._computed=[],(this._m=t)._mm=this,Object.defineProperty(this,"m",{value:t,writable:!1}),Amm.WithEvents.call(this,e)},Amm.Data.ModelMeta.prototype={"Amm.Data.ModelMeta":"__CLASS__",_m:null,_updateLevel:0,_modified:null,_transaction:null,_lastTransaction:null,_oldState:null,_checked:!1,_cu:!1,_propertiesChanged:!1,_fieldMeta:null,_validators:null,_lockCompute:0,_computed:null,_autoCheck:Amm.Data.AUTO_CHECK_SMART,_validWhenHydrated:!0,getObject:function(){return this._m},getO:function(){return this._m},hydrate:function(t,e,i){for(var r in this.beginUpdate(),e||(this._m._old={},this._m._data={}),t)t.hasOwnProperty(r)&&(this._m._old[r]=t[r],this._m._data[r]=t[r],this._m._propNames[r]||this._createProperty(r));this.getKey()?(this.setState(Amm.Data.STATE_EXISTS),i||this._m._doOnActual(!1)):this.setState(Amm.Data.STATE_NEW),this.outHydrate(),this.endUpdate()},getKey:function(){return null},outHydrate:function(){return this._out("hydrate")},listDataFields:function(){return Amm.keys(this._m._data)},getData:function(){return Amm.override({},this._m._data)},beginUpdate:function(){this._updateLevel++,1<this._updateLevel||(this._m._preUpdateValues=this.getData())},endUpdate:function(){if(!this._updateLevel)throw Error("Call to endUpdate() without corresponding beginUpdate(); check with getUpdateLevel() first");if(this._updateLevel--,!this._updateLevel){this._lockCompute||this._compute();var t,e,i=this._m._preUpdateValues,r=this._m._data;this._lockCompute++;var n=!1;for(var s in i)if(i.hasOwnProperty(s)&&(t=i[s],e=r[s],delete i[s],e!==t&&(n=!0,this._reportFieldChange(s,e,t,!0)),this._m._updateLevel))break;this._lockCompute--,null!==this._oldState&&this._oldState!==this._m.state&&(this._oldState,this._oldState=null,this.outStateChange(this._m._state,this._oldState)),n&&this._reportDataChanged(),this._checkModified(),this._propertiesChanged&&(this._propertiesChanged=!1,this.outPropertiesChanged()),null!==this._m._oldErrors&&this._endUpdateErrors()}},_reportDataChanged:function(){this.outDataChanged()},outDataChanged:function(){return this._out("dataChanged")},getUpdateLevel:function(){return this._updateLevel},_checkFieldModified:function(t){var e=!1;t in this._m._data&&(t in this._m._old&&this._m._old[t]===this._m._data[t]||(e=!0)),e!==this._modified&&this._checkModified()},_checkModified:function(){var t=!1;for(var e in this._m._data)if(this._m._data.hasOwnProperty(e)&&(!(e in this._m._old)||this._m._old[e]!==this._m._data[e])){t=!0;break}this.setModified(t)},_reportFieldChange:function(t,e,i,r){var n,s;this._updateLevel||(s="out"+(n=this._m._propNames[t]).charAt(0).toUpperCase()+n.slice(1)+"Change",this._correctCheckStatus(t,e||i),this._m[s](e,i),this["_change_"+t]&&this["_change_"+t](e,i),this._lockCompute||this["_compute_"+t]||this._compute(),r||(this._reportDataChanged(),this._checkFieldModified(t)))},setModified:function(t){var e=this._modified;if(e!==t)return this._modified=t,this.outModifiedChange(t,e),this._modified||this._checkHydratedAndValid(!0),!0},getModified:function(t){return t?this._m._old[t]!==this._m._data[t]:this._modified},getOldValue:function(t){return this._m._old[t]},outModifiedChange:function(t,e){this._out("modifiedChange",t,e)},revert:function(){this.beginUpdate(),this._m._data=Amm.override({},this._m._old),this.endUpdate()},isSpecial:function(t){return t in this.constructor.prototype},getFieldValue:function(t){return t in this._m._data||!this["_compute_"+t]||(this._m._data[t]=this["_compute_"+t].call(this._m,t)),this._m._data[t]},setFieldValue:function(t,e){var i,r=this._m._data[t];if(!this._computed.length||!this["_compute_"+t]){var n="_set_"+t;if(this[n]&&"function"==typeof this[n]){if(delete this[n].error,!(i={value:e,old:r,error:null})===this[n].call(this._m,i,t))return;e=i.value,r=i.old,i.error&&(this[n].error=i.error)}r!==e&&(this._m._data[t]=e,this._updateLevel||this._reportFieldChange(t,e,r))}},_createProperty:function(e){if(e in this._m._propNames)throw Error("Amm.Data.Record already has property for field '"+e+"'");for(var t=e,i="";this.isSpecial(t);)t=e+"Field"+i,i=(i||1)+1;var r=(this._m._propNames[e]=t).slice(1),n=t.charAt(0).toUpperCase()+r,s=t.charAt(0).toLowerCase()+r+"Change",o="out"+n+"Change",a="set"+n,h="get"+n,l=this.getMeta(e),u=void 0;return l&&("function"==typeof(u=l.def)&&(u=u.call(this._m,e)),void 0!==u&&(e in this._m._old||(this._m._old[e]=u),e in this._m._data||(this._m._data[e]=u))),h in this._m||(this._m[h]=function(){return this._data[e]}),a in this._m||(this._m[a]=function(t){return this.mm.setFieldValue(e,t)}),o in this._m||(this._m[o]=function(t,e){if(!this._updateLevel)return this._out(s,t,e)}),Object.defineProperty(this._m,t,{enumerable:!0,get:this._m[h],set:this._m[a]}),!this._m._preUpdateValues||e in this._m._preUpdateValues||(this._m._preUpdateValues[e]=u),this._updateLevel?this._propertiesChanged=!0:this.outPropertiesChanged(),t},outPropertiesChanged:function(){return this._out("propertiesChanged")},getState:function(){return this._m._state},setState:function(t){var e=this._m._state;if(e!==t){if(!Amm.Data.StateEnum[t])throw Error("`state` must be one of Amm.Data.STATE_ values; given: '"+t+"'");this._m._state=t,this._updateLevel?null===this._oldState&&(this._oldState=e):this.outStateChange(t,e)}},outStateChange:function(t,e){return this._out("stateChange",t,e)},_hasLocalErrors:function(){if(this._m._errors.local)for(var t in this._m._errors.local)if(this._m._errors.local.hasOwnProperty(t))return!0;return!1},check:function(t){return this._checked&&!t?!this._hasLocalErrors():!!this._checkHydratedAndValid(!0)||(this._beginUpdateErrors(),this._m._errors.local={},this._coreCheckFields(),this._coreCheckWhole(),this._m._doOnCheck(),this._checked=!0,this._endUpdateErrors(),!this._hasLocalErrors())},_coreCheckFields:function(t){var e,i,r,n,s,o,a,h=this._m._checkField!==Amm.Data.Record.prototype._checkField;if(t){if(!this._m._propNames[t])return;(e={})[t]=this._m._propNames[t]}else e=this._m._propNames;for(r in e)if(e.hasOwnProperty(r)){if(i=null,"function"==typeof this[a="_set_"+r]&&this[a].error&&(i=this[a].error),n=this._m._data[r],!i&&h&&!1===(i=this._m._checkField(r,n))&&(i=Amm.translate("lang.Amm.ModelMeta.invalidFieldValue")),s=this.getMeta(r,"label")||r,!i){(o=this.getFieldValidators(r))?o instanceof Array||(o=[o]):o=[];for(var l=0,u=o.length;l<u&&("function"==typeof o[l]?i=o[l](n,s):"function"==typeof o[l].getError&&(i=o[l].getError(n,s)),!i);l++);}i?(i=i.replace(/%field/g,s),this.addError(i,r)):delete this._m._errors.local[r]}},_coreCheckWhole:function(){var t=this.getModelValidators(!0);if(t)for(var e in t)if(t.hasOwnProperty(e))for(var i,r=t[e],n=0,s=r.length;n<s;n++){var o=r[n];if(o["Amm.Expression"])o.__func||(o.__func=o.toFunction()),o.__func.env.expressionThis=this._m,i=o.__func();else if(o["Amm.Validator"])i=o.getError(this);else{if("function"!=typeof o)throw Error("modelValidators['"+e+"'] must be either a function, an Amm.Expression or an Amm.Validator; provided: "+Amm.describeType(t[e]));i=o.call(this._m)}!1===i&&(i=Amm.translate(e)),i&&this.addError(i,e)}},setChecked:function(t){var e=this._checked;if(e!==t)return this._checked=t,this.outCheckedChange(t,e),!0},getChecked:function(){return this._checked},outCheckedChange:function(t,e){this._out("checkedChange",t,e)},setAutoCheck:function(t){if("boolean"==typeof t?t+=0:"string"==typeof t&&(t=parseInt(t)),t!==Amm.Data.AUTO_CHECK_NEVER&&t!==Amm.Data.AUTO_CHECK_ALWAYS&&t!==Amm.Data.AUTO_CHECK_SMART)throw Error("Invalid autoCheck value; must be one of Amm.Data.AUTO_CHECK_ constants");if(this._autoCheck!==t)return(this._autoCheck=t)&&this._instaCheck(),!0},getAutoCheck:function(){return this._autoCheck},setValidWhenHydrated:function(t){if(this._validWhenHydrated!==t)return(this._validWhenHydrated=t)?this._checkHydratedAndValid(!0):this.getState()!==Amm.Data.STATE_EXISTS||this._modifierd||(this._autoCheck===Amm.Data.AUTO_CHECK_ALWAYS?this._instaCheck(!0):this.setChecked(!1)),!0},getValidWhenHydrated:function(){return this._validWhenHydrated},_checkHydratedAndValid:function(t){if(this._validWhenHydrated&&!this._modified&&this.getState()===Amm.Data.STATE_EXISTS)return t&&this.setLocalErrors({}),!0},_correctCheckStatus:function(t,e){this._autoCheck===Amm.Data.AUTO_CHECK_SMART&&e?(this._beginUpdateErrors(),this.setChecked(!1),this._coreCheckFields(t),this._endUpdateErrors()):this._autoCheck===Amm.Data.AUTO_CHECK_ALWAYS?this._instaCheck(!0):this.setChecked(!1)},_instaCheck:function(t){this._checked&&!t||this._autoCheck&&(t&&(this._checked=!1),(this._subscribers.localErrorsChange||this._subscribers.errorsChange)&&(this._autoCheck!==Amm.Data.AUTO_CHECK_ALWAYS||this.check()))},_beginUpdateErrors:function(){this._errUpdateLevel++,1<this._errUpdateLevel||(this._subscribers.localErrorsChange||this._subscribers.remoteErrorsChange||this._subscribers.errorsChange||(this._m._oldErrors=!1),this._m._errors||(this._m._errors={local:{},remote:{}}),this._combineErrors(),this._m._oldErrors||(this._m._oldErrors={local:JSON.stringify(this._m._errors.local),remote:JSON.stringify(this._m._errors.remote),all:JSON.stringify(this._m._errors.all)}))},_subscribeFirst_localErrorsChange:function(){!1===this._m._oldErrors&&this._beginUpdateErrors()},_subscribeFirst_remoteErrorsChange:function(){return this._subscribeFirst_localErrorsChange()},_subscribeFirst_errorsChange:function(){return this._subscribeFirst_localErrorsChange()},_errUpdateLevel:0,_endUpdateErrors:function(){var t,e,i,r,n,s;0<this._errUpdateLevel&&this._errUpdateLevel--,this._errUpdateLevel||this._updateLevel||(this._m._errors.all=null,this._m._oldErrors&&(this._m._errors||(this._m._errors?(this._m._errors.local||(this._m._errors.local={}),this._m._errors.remote||(this._m._errors.remote={})):this._m._errors={local:{},remote:{}}),t=this._m._oldErrors,this._m._oldErrors=null,(this._subscribers.localErrorsChange||this._subscribers.remoteErrorsChange||this._subscribers.errorsChange||this._computed.length)&&(e=t.local!==JSON.stringify(this._m._errors.local),i=t.remote!==JSON.stringify(this._m._errors.remote),(e||i)&&(this._compute(),r=e&&this._subscribers.localErrorsChange,n=i&&this._subscribers.remoteErrorsChange,s=this._subscribers.errorsChange,r&&this.outLocalErrorsChange(this._m._errors.local,JSON.parse(t.local)),n&&this.outRemoteErrorsChange(this._m._errors.remote,JSON.parse(t.remote)),s&&this.outErrorsChange(this.getErrors(),JSON.parse(t.all))))))},getLocalErrors:function(t){return this._autoCheck&&this._modified&&!this._checked&&this.check(),this._getErrors("local",t)},_getErrors:function(t,e){if(!this._m._errors[t]||e&&e!==Amm.Data.ERROR_OTHER&&!this._m._errors[t][e])return null;if(e)return e===Amm.Data.ERROR_OTHER?this._getOtherErrors(this._m._errors[t]):this._m._errors[t][e];if(this._m._errors[t]){for(var i in this._m._errors[t])if(this._m._errors[t].hasOwnProperty(i))return this._m._errors[t];return null}return this._m._errors[t]},_setErrors:function(t,e,i){if(this._beginUpdateErrors(),i)return this._m._errors[t][i]=this._flattenErrors(e),this._m._errors[t][i].length||delete this._m._errors[t][i],void this._endUpdateErrors();e?("object"!=typeof e||e instanceof Array)&&(e[Amm.Data.ERROR_GENERIC]=this._flattenErrors(e),e[Amm.Data.ERROR_GENERIC]&&e[Amm.Data.ERROR_GENERIC].length||delete e[Amm.Data.ERROR_GENERIC]):e={};var r,n={};for(var s in e)if(e.hasOwnProperty(s)){if(!(r=this._flattenErrors(e[s])).length)continue;n[s]=r}this._m._errors[t]=n,this._endUpdateErrors()},setLocalErrors:function(t,e){this._setErrors("local",t,e)},addError:function(t,e){var i;!t||t instanceof Array&&!t.length||(this._beginUpdateErrors(),e&&e!==Amm.Data.ERROR_OTHER||(e=Amm.Data.ERROR_GENERIC),(i={})[e]=this._flattenErrors(t),Amm.override(this._m._errors.local,i,!1,!0),this._endUpdateErrors())},outLocalErrorsChange:function(t,e){return this._out("localErrorsChange",t,e)},getRemoteErrors:function(t){return this._getErrors("remote",t)},setRemoteErrors:function(t,e){this._setErrors("remote",t,e)},outRemoteErrorsChange:function(t,e){return this._out("remoteErrorsChange",t,e)},_flattenErrors:function(t){return Amm.Data.flattenErrors(t)},_getOtherErrors:function(t){for(var e in t)!t.hasOwnProperty(e)||e in this._m._propNames||((void 0)[e]=t[e]);return this._flattenErrors(void 0)},_combineErrors:function(){this._m._errors.all={},this._m._errors.local&&Amm.overrideRecursive(this._m._errors.all,this._m._errors.local),this._m._errors.remote&&Amm.overrideRecursive(this._m._errors.all,this._m._errors.remote,!1,!0)},getErrors:function(t){return this._autoCheck===Amm.Data.AUTO_CHECK_ALWAYS&&this._modified&&!this._checked&&this.check(),this._m._errors?(this._m._errors.all||this._combineErrors(),this._getErrors("all",t)):null},outErrorsChange:function(t,e){return this._out("errorsChange",t,e)},setErrors:function(){console.warn("setErrors has no effect; use either setLocalErrors() or setRemoteErrors()")},_syncProperties:function(){var t,e=this.getMeta(),i=[];for(var r in e){e.hasOwnProperty(r)&&(t=e[r],r in this._m._propNames||this._createProperty(r),this["_change_"+r]=t.change,t.compute&&"function"==typeof t.compute?(i.push(r),this["_compute_"+r]=t.compute):delete this["_compute_"+r],void 0!==t.set&&(this["_set_"+r]=t.set))}Amm.Array.equal(i,this._computed)||(this._computed=i,this._computedListUpdated())},_onMetaChange:function(t,e,i,r){var n,s,o,a;Amm.Data.MetaProvider.prototype._onMetaChange.call(this,t,e,i,r),t?(t in this._m._propNames||this._createProperty(t),n=this.getMeta(t),e&&"set"!==e||n&&void 0!==n.set&&(this["_set_"+t]=n.set),e&&"change"!==e||(this["_change_"+t]=n.change),e&&"compute"!==e||(s=!1,o=Amm.Array.indexOf(t,this._computed),"function"==typeof n.compute?o<0&&(s=!0,this._computed.push(t),this["_compute_"+t]=n.compute):0<=o&&(s=!0,this._computed.splice(o,1),delete this["_compute_"+t]),s&&this._computedListUpdated())):this._syncProperties(),e&&"required"!==e&&"label"!==e&&"validators"!==e||(a=t&&this._m._data[t]||this._m._old[t]||"required"===e&&!i,this._correctCheckStatus(t,a))},_computedListUpdated:function(){this._compute()},compute:function(){this._compute()},_compute:function(){if((this._computed.length||this._m._doOnCompute!==Amm.Data.Model.prototype._doOnCompute)&&!this._updateLevel){var t,e,i;for(this.beginUpdate(),t=0,e=this._computed.length;t<e;t++)i=this._computed[t],delete this._m._data[i];for(t=0,e=this._computed.length;t<e;t++)(i=this._computed[t])in this._m._data||this.getFieldValue(i);this._lockCompute++,this._m._doOnCompute(),this.endUpdate(),this._lockCompute--}}},Amm.extend(Amm.Data.ModelMeta,Amm.WithEvents),Amm.extend(Amm.Data.ModelMeta,Amm.Data.MetaProvider),Amm.defineLangStrings({"lang.Amm.ModelMeta.invalidFieldValue":"The field contains invalid value"}),Amm.Data.RecordMeta=function(t,e){Amm.Data.ModelMeta.call(this,t,e),this._mapper=t._mapper,this.setMetaProvider(this._mapper)},Amm.Data.RecordMeta.prototype={"Amm.Data.RecordMeta":"__CLASS__",_mapper:null,_updateLevel:0,_modified:null,getKey:function(){var t=this._mapper.extractKey(this._m._old);return void 0===t&&(t=this._mapper.extractKey(this._m._data)),t},_setTransaction:function(t){t?Amm.is(t,"Amm.Data.Transaction"):t=null;var e=this._transaction;if(e!==t)return e&&e.unsubscribe(void 0,void 0,this),t&&t.subscribe("stateChange",this._notifyTransactionStateChange,this),this._transaction=t,this.outTransactionChange(t,e),e&&this._setLastTransaction(e),!0},getTransaction:function(){return this._transaction},outTransactionChange:function(t,e){this._out("transactionChange",t,e)},_notifyTransactionStateChange:function(t,e){this._transaction&&Amm.event.origin===this._transaction&&(t===Amm.Data.Transaction.STATE_RUNNING||t!==Amm.Data.Transaction.STATE_CANCELLED&&!this._handleTransactionFinished(t)||this._setTransaction(null))},_handleTransactionFinished:function(t){if(t===Amm.Data.Transaction.STATE_CANCELLED)return!0;if(t===Amm.Data.Transaction.STATE_FAILURE)return this._handleGenericTransactionFailure(),!0;if(t===Amm.Data.Transaction.STATE_SUCCESS){var e=this._transaction.getType()+"",i="_handle"+e[0].toUpperCase()+e.slice(1)+"Success";return"function"==typeof this[i]&&this[i](),!0}},_hydrateFromTransactionDataAndTrigger:function(t,e,i){var r=this._transaction.getResult(),n=this._m._state===Amm.Data.STATE_NEW;this.beginUpdate(),this.setRemoteErrors({});var s=r.getData();s&&this.hydrate(s,i,!0),e&&this.setState(e),t?this._m._doAfterSave(n):this._m._doAfterLoad(),this._m._doOnActual(t),this.endUpdate()},_handleGenericTransactionFailure:function(){var t,e=this._transaction.getResult(),i=e.getErrorData(),r=e.getError(),n=e.getException();i?"object"!=typeof i&&((t={})[Amm.Data.ERROR_GENERIC]=[i],i=t):i={},r&&(i[Amm.Data.ERROR_GENERIC]?i[Amm.Data.ERROR_GENERIC].push(r):i[Amm.Data.ERROR_GENERIC]=[r]),n&&(i[Amm.Data.ERROR_EXCEPTION]=""+n),this.setRemoteErrors(i),this.outTransactionFailure(this._transaction)},outTransactionFailure:function(t){return this._out("transactionFailure",t)},_handleCreateSuccess:function(){this._hydrateFromTransactionDataAndTrigger(!0,Amm.Data.STATE_EXISTS,this._mapper.partialHydrateOnCreate)},_handleDeleteSuccess:function(){this.setState(Amm.Data.STATE_DELETED),this.setRemoteErrors({}),this._m._doAfterDelete()},_handleUpdateSuccess:function(){this._hydrateFromTransactionDataAndTrigger(!0,void 0,this._mapper.partialHydrateOnUpdate)},_handleLoadSuccess:function(){this.beginUpdate(),this._hydrateFromTransactionDataAndTrigger(!1,Amm.Data.STATE_EXISTS),this.endUpdate()},_setLastTransaction:function(t){t?Amm.is(t,"Amm.Data.Transaction"):t=null;var e=this._lastTransaction;if(e!==t)return this._lastTransaction=t,this.outLastTransactionChange(t,e),!0},getLastTransaction:function(){return this._lastTransaction},outLastTransactionChange:function(t,e){this._out("lastTransactionChange",t,e)},_getTransactionData:function(){return Amm.override({},this._m._data)},_runTransaction:function(t){if(this._setTransaction(t),t.run(),t.getState()===Amm.Data.Transaction.STATE_FAILURE){var e=t.getResult().getException();if(e)throw e}},save:function(t){if((t||this.check())&&!1!==this._m._doBeforeSave()){var e,i=this._getTransactionData(),r=this.getState();if(r===Amm.Data.STATE_NEW)e=this._mapper.createTransaction(Amm.Data.Transaction.TYPE_CREATE,null,i);else{if(r!==Amm.Data.STATE_EXISTS)throw Error("Cannot save an object with state '"+r+"'");e=this._mapper.createTransaction(Amm.Data.Transaction.TYPE_UPDATE,this.getKey(),i)}return this._runTransaction(e),!0}},delete:function(){var t;return this.getState()!==Amm.Data.STATE_EXISTS?(this.setState(Amm.Data.STATE_DELETED),!0):!1!==this._m._doBeforeDelete()&&(this.getKey(),t=this._mapper.createTransaction(Amm.Data.Transaction.TYPE_DELETE,this.getKey()),this._runTransaction(t),!0)},load:function(t){var e,i=this._m._doBeforeLoad(t);if(!1===i)return!1;if(void 0!==i&&(t=i),void 0===t&&(t=this.getKey()),!t)throw new Error("Cannot load(): key not provided");return e=this._mapper.createTransaction(Amm.Data.Transaction.TYPE_LOAD,t),this._runTransaction(e),!0},cleanup:function(){this._cu||(this._cu=!0,this._transaction&&(this._transaction.cleanup(),this._transaction=null),this._lastTransaction&&(this._lastTransaction.cleanup(),this._lastTransaction=null),this._mapper&&this._mapper.unsubscribe(void 0,void 0,this),this._m.cleanup(),Amm.WithEvents.prototype.cleanup.call(this))},getMapper:function(){return this._mapper},setMapper:function(){},outMapperChange:function(){}},Amm.extend(Amm.Data.RecordMeta,Amm.Data.ModelMeta),Amm.Data.HttpTransaction=function(t){Amm.Data.Transaction.call(this,t)},Amm.Data.HttpTransaction.DEFAULT_METHOD_MAP={load:"GET","":"POST"},Amm.Data.HttpTransaction.prototype={"Amm.Data.HttpTransaction":"__CLASS__",_requestProducer:null,uri:null,uriOverrides:null,dataOverrides:null,method:null,methodMap:null,typePath:null,typeToUri:!0,typeDecorator:null,keyPath:"id",keyToUri:!0,dataPath:null,dataToUri:!1,responseErrorPath:"error",responseErrorDataPath:"errorData",responseDataPath:"data",responseSuccessPath:null,softErrorCodes:null,_unparsedResponseClass:"Amm.Data.HttpResponse",_transport:new Amm.Remote.Transport.JqXhr,_responseDecorator:null,_runningRequest:null,setTransport:function(t){this._transport=Amm.constructInstance(t,"Amm.Remote.Transport")},getTransport:function(){return this._transport},createRequestProducer:function(){var t,e={prototype:null};return this.outRequestProducerPrototype(e,this),e.prototype&&(t=e.prototype),t=t||this.createDefaultRequestProducer(),Amm.constructInstance(t,"Amm.Remote.RequestProducer")},createDefaultRequestProducer:function(){var t,e=new Amm.Remote.RequestProducer({uri:this.uri,uriOverrides:this.uriOverrides,dataOverrides:this.dataOverrides});this.data&&(t=Amm.overrideRecursive({},this.data),this.dataPath?e.setData(t,this.dataPath):e.setDataOverrides(this.data));var i=Amm.Decorator.d(this._type,this,"typeDecorator");return i&&(this.typeToUri?""===this.typePath?e.setUri(e.getUri().replace(/\/$/g,"")+"/"+i):this.typePath&&e.setUri(i,this.typePath):this.typePath&&e.setData(i,this.typePath)),null!==this.key&&(this.keyToUri?this.keyPath?e.setUri(this.key,this.keyPath):e.setUri(e.getUri().replace(/\/$/g,"")+"/"+this.key):e.setData(this.key,this.keyPath)),e.setMethod(this.getAppliedMethod()),e},getAppliedMethod:function(){var t=this.methodMap||Amm.Data.HttpTransaction.DEFAULT_METHOD_MAP;return t[this._type]||t[""]},_runDefault:function(){var t=this.createRequestProducer().produceRequest();this._runningRequest=this.getTransport().makeRequest(t,this._handleSuccess,this._handleFailure,this)},_handleSuccess:function(t,e,i){var r,n,s;this._state===Amm.Data.Transaction.STATE_RUNNING&&(r={},n=200,s="","object"==typeof i&&("function"==typeof i.getAllResponseHeaders&&(r=Amm.Remote.Transport.JqXhr.parseResponseHeaders(i.getAllResponseHeaders())),"statusCode"in i&&(n=i.statusCode),"responseText"in i?s=i.responseText:"string"==typeof t&&(s=t)),this.setUnparsedResponse(new Amm.Data.HttpResponse({rawContent:s,parsedContent:t,httpHeaders:r,httpCode:n})))},_handleFailure:function(t,e,i,r){var n,s,o;this._state===Amm.Data.Transaction.STATE_RUNNING&&(n={},s=i,o="","object"==typeof r&&("function"==typeof r.getAllResponseHeaders&&(n=Amm.Remote.Transport.JqXhr.parseResponseHeaders(r.getAllResponseHeaders())),"statusCode"in r&&(s=r.statusCode),"responseText"in r&&(o=r.responseText)),this.setUnparsedResponse(new Amm.Data.HttpResponse({isError:!0,errorText:e,rawContent:o,parsedContent:null,httpHeaders:n,httpCode:s})))},outRequestProducerPrototype:function(t,e){return this._out("requestProducerPrototype",t,e)},_parseDefault:function(t){var e;if(this._responseDecorator&&(e=this._applyDataDecorator(t)))return e;e={};var i=null;if(t.isError&&!t.httpCode)return{errorType:Amm.Data.TransactionResult.ERROR_TYPE_CLIENT,error:t.errorText};if(t.isError){if(this.softErrorCodes instanceof Array?0<=Amm.Array.indexOf(t.httpCode,this.softErrorCodes)&&(i=t.errorText):this.softErrorCodes&&this.softErrorCodes[t.httpCode]&&(i=this.softErrorCodes[t.httpCode]),!i)return e.errorType=Amm.Data.TransactionResult.ERROR_TYPE_HTTP,e.error=t.errorText,e;e.errorType=Amm.Data.TransactionResult.ERROR_TYPE_SERVER,e.error=i}var r=!1;if(t.parsedContent&&"object"==typeof t.parsedContent)return i?this.responseErrorDataPath&&(e.errorData=Amm.Util.getByPath(t.parsedContent,this.responseErrorDataPath)):(this.responseSuccessPath?r=!Amm.Util.getByPath(t.parsedContent,this.responseSuccessPath):this.responseErrorPath&&void 0!==(r=Amm.Util.getByPath(t.parsedContent,this.responseErrorPath))&&(e.error=r),this.responseErrorDataPath&&(r||this.responseErrorDataPath!==this.responseDataPath)&&(e.errorData=Amm.Util.getByPath(t.parsedContent,this.responseErrorDataPath,null)),(e.errorData||r)&&(e.errorType=Amm.Data.TransactionResult.ERROR_TYPE_SERVER),e.errorType&&this.responseErrorDataPath===this.responseDataPath||(null!==this.responseDataPath?e.data=Amm.Util.getByPath(t.parsedContent,this.responseDataPath,null):e.data=t.parsedContent)),e;if(i)return e;if(this.responseDataPath||this.responseSuccessPath)throw Error("Cannot parse the response");return e},_applyDataDecorator:function(t){var e=this._responseDecorator.decorate(t);if(e&&"object"==typeof e)return Amm.constructInstance(e,"Amm.Data.TransactionResult")},_cancelDefault:function(){if(!this._runningRequest)throw Error("Assertion: _runningRequest during _cancelDefault()");this.getTransport().abortRunningRequest(this._runningRequest)},setResponseDecorator:function(t){this._responseDecorator=t?Amm.constructInstance(t,"Amm.Decorator.Data"):null}},Amm.extend(Amm.Data.HttpTransaction,Amm.Data.Transaction),Amm.Data.FieldMeta=function(t){this._validators=[];var e=Amm.override(t||{});"metaProvider"in e&&(this.setMetaProvider(e.metaProvider),delete e.metaProvider),this._i=!0,Amm.init(this,e,null,function(t,e){return this.setProperty(e,t),!0}),this._i=!1,this._notify()},Amm.Data.FieldMeta._afterPropChange=function(t,e,i){this._notify(t,e,i)},Amm.Data.FieldMeta.prototype={"Amm.Data.FieldMeta":"__CLASS__",_i:null,_metaProvider:null,_validators:null,_requiredValidator:null,_name:null,_properties:null,clone:function(t,e){var i=new Amm.Data.FieldMeta;for(var r in this){var n,s,o=this.hasOwnProperty(r);(o||Amm.Data.FieldMeta.prototype.hasOwnProperty(r))&&(this[r]instanceof Array&&(i[r]=[].concat(this[r])),i[r]=this[r]),o&&"function"==typeof this[r]&&"set"===r.slice(0,3)&&"function"==typeof this[n="get"+(s=r.slice(3))]&&(s[0]=s[0].toLowerCase(),Object.defineProperty(i,s,{enumerable:!0,set:this[r],get:this[n]}))}return i._metaProvider=null,e&&(i._name=e),t&&i.setMetaProvider(t),i},_notify:function(t,e,i){this._metaProvider&&this._name&&this._metaProvider.notifyMetaChange(this,this._name,i,t,e)},setName:function(t){var e=this._name;if(e!==t){if(null!==this._name)throw Error("Can setName() only once");return this._name=t,this._notify(t,e,"name"),!0}},getName:function(){return this._name},setMetaProvider:function(t){if(t!==this._metaProvider){if(t){if(this._metaProvider)throw Error("Can setMetaProvider() only once");Amm.is(t,"MetaProvider","metaProvider")}else t=null;this._metaProvider=t}},getMetaProvider:function(){return this.metaProvider},setValidators:function(t){var e,i;this._validators!==t&&(e=this._validators,t instanceof Array||(t=t?[t]:[]),i=Amm.Data.MetaProvider.checkValidatorsArray(t,"validators"),this._validators=i,this._notify(this._validators,e,"validators"))},getValidators:function(){return[].concat(this._validators)},setProperty:function(t,e){if("_"===e[0])throw Error("Cannot set pseudo-private property");e in this||this.defineProperty(e),this[e]=t},getProperty:function(t){if("_"===t[0])throw Error("Cannot return pseudo-private property");if(t in this)return this[t]},defineProperty:function(t,e,i){Amm.createProperty(this,t,e,{before:i,after:Amm.Data.FieldMeta._afterPropChange},!0)}},Amm.createProperty(Amm.Data.FieldMeta.prototype,"name",null,{before:function(t,e){if(null!==e)throw Error("Can setName() only once")},after:Amm.Data.FieldMeta._afterPropChange},!0),Amm.createProperty(Amm.Data.FieldMeta.prototype,"required",null,{before:function(t){return!!t},after:function(t,e,i){Amm.Data.FieldMeta._afterPropChange.call(this,t,e,i)}},!0),Amm.createProperty(Amm.Data.FieldMeta.prototype,"set",null,{before:function(t){if(t){if("function"!=typeof t)throw Error("'set' meta-property value must be a function or null")}else t=null;return t}},!0),Amm.createProperty(Amm.Data.FieldMeta.prototype,"compute",null,{before:function(t){if(t){if("function"!=typeof t)throw Error("'compute' meta-property value must be a function or null")}else t=null;return t}},!0),Amm.createProperty(Amm.Data.FieldMeta.prototype,"change",null,{before:function(t){if(t){if("function"!=typeof t)throw Error("'change' meta-property value must be a function or null")}else t=null;return t}},!0),Amm.createProperty(Amm.Data.FieldMeta.prototype,"def",null,Amm.Data.FieldMeta._afterPropChange,!0),Amm.createProperty(Amm.Data.FieldMeta.prototype,"label",null,Amm.Data.FieldMeta._afterPropChange,!0),Amm.createProperty(Amm.Data.FieldMeta.prototype,"validators",null,null,!0),Amm.createProperty(Amm.Data.FieldMeta.prototype,"description",null,Amm.Data.FieldMeta._afterPropChange,!0);
//# sourceMappingURL=amm.min.js.map