Amm={id:"amm",domHolderAttribute:"data-amm-iid",_counter:1,_functions:{},_namespaces:{},_bootstrapped:false,lang:{},optionsObjectId:"ammOptions",autoBuildSelector:"[data-amm-build]",defaultBuilderOptions:{topLevelComponent:"root"},_autoBuilder:null,_items:{},itemDebugInfo:{},itemDebugTag:[],r:null,_root:null,_eventStack:[],event:{origin:null,name:"",args:[],parent:null},getRoot:function(){if(!this._root){this._root=new this.Root;this.r=this._root}return this._root},registerItem:function(t){if(t._amm_id)return;t._amm_id=this.id+"_"+this._counter++;this._items[t._amm_id]=t;if(this.itemDebugTag.length){this.itemDebugInfo[t._amm_id]=this.itemDebugTag[this.itemDebugTag.length-1]}return true},unregisterItem:function(t){if(!t._amm_id)return;if(typeof t==="string")t=this._items[t];if(t._amm_id&&this._items[t._amm_id]!==t){throw Error("Mismatch of _amm_id detected during the item de-registration")}delete this._items[t._amm_id];delete this.itemDebugInfo[t._amm_id];t._amm_id=null},getItem:function(t,e){if(t instanceof Array){var i=[];for(var r=0,n=t.length;r<n;r++){if(t[r]&&t[r].length){var s=this.getItem(t[r],e);if(s)i.push(s)}}return i}else{var a=this._items[t];if(!a&&e)throw Error("Item '"+t+"' not found");return a}},extend:function(t,e,i){if(typeof t!=="function"){throw Error("Amm.extend: `subClass` is not a function")}if(typeof e!=="function"){throw Error("Amm.extend: `parentClass` is not a function")}var r=false;if(typeof e.beforeExtend==="function"){r=e.beforeExtend(t,e,i)}if(!r){for(var n in e.prototype){if(!(n in t.prototype))t.prototype[n]=e.prototype[n];if(!i&&t.prototype[n]==="__CLASS__")t.prototype[n]="__PARENT__"}}if(typeof e.afterExtend==="function"){e.afterExtend(t,e,i)}},augment:function(t,e,i){var r,n;if(typeof e==="string"){e=Amm.getFunction(e)}if(typeof t!=="object")throw Error("`instance` must be an object");if(typeof e==="function")r=new e;else if(typeof e==="object")r=e;else throw Error("`trait` must be an object or a function (constructor)");var s=this.getInterfaces(t,r);if(s.length)throw Error("Cannot augment: `instance` already implements same interfaces as the `traitInstance`: "+s.join(", ")+")");for(var a in r)if(a.slice(0,2)!=="__"){if(t[a]===undefined||typeof t[a]==="function")t[a]=r[a]}if(typeof r.__augment==="function"){r.__augment.call(t,r,i)}},override:function(t,e,i){for(var r=0,n=arguments.length;r<n;r++){for(var s in arguments[r]){if(arguments[r].hasOwnProperty(s))t[s]=arguments[r][s]}}return t},overrideRecursive:function(t,e,i,r){if(typeof t!=="object"||typeof e!=="object")throw Error("Both modifiedObject and overrider must be objects");for(var n in e)if(e.hasOwnProperty(n)){if(t[n]instanceof Array&&e[n]instanceof Array){if(!r||!t[n].length){t[n]=t[n].concat(e[n]);continue}for(var s=0,a=e[n].length;s<a;s++){if(Amm.Array.indexOf(e[n][s],t[n])>=0)continue;t[n].push(e[n][s])}}else if(typeof t[n]==="object"&&typeof e[n]==="object"){this.overrideRecursive(t[n],e[n],i,r)}else if(!i||!(n in t)){t[n]=e[n]}}return t},meetsRequirements:function(t,e,i){if(!(e instanceof Array))e=[[e]];for(var r=0,n=e.length;r<n;r++){var s=e[r],a=true;if(!(s instanceof Array))s=[s];for(var o=0,l=s.length;o<l;o++){var h=s[o],u=false,f;if(typeof h==="function")u=t instanceof h;else{f=t[h];u=f==="__CLASS__"||f==="__INTERFACE__"||f==="__PARENT__"||typeof f==="function"}if(!u){a=false;break}}if(a)return true}if(i){throw Error("["+Amm.describeType(t)+"] `"+i+"` "+"doesn't meet following requirement(s): "+Amm.describeRequirements(e))}return false},describeRequirements:function(t){var e=[];for(var i=0;i<t.length;i++){var r=t[i],n;if(!(r instanceof Array))r=[r];for(var s=0;s<r.length;s++){if(r[s][0].toLowerCase()===r[s][0]){r[s]+="()"}}if(r.length>1){n="( "+r.join(" & ")+" )"}else{n=r[0]}e.push(n)}return e.join(" || ")},getClass:function(t,e){var i;if(e)i=[];for(var r in t){if(t[r]==="__CLASS__"||e&&t[r]==="__PARENT__"){if(e)i.push(r);else return r}}if(!e)return null;else return i},getInterfaces:function(t,e){var i=[];for(var r in t){if(t[r]==="__INTERFACE__"){if(!e||e[r]){i.push(r)}}}return i},hasInterfaces:function(t,e,i){if(!e)return true;if(!(e instanceof Array))e=[e];for(var r=e.length-1;r>=0;r--){if(!t||t[e[r]]!=="__INTERFACE__"){if(i){var n=typeof i==="string"?i:"`item`";throw Error(n+=" must implement all following interfaces: "+e.join(",")+" but it doesn't implement interface "+e[r])}else{return false}}}return true},is:function(t,e,i){if(e instanceof Array){for(var r=0,n=r.length;r<n;r++)if(Amm.is(t,e[r]))return true;if(i){var s=typeof i==="string"?i:"`item`";throw Error(s+" must be an instance of "+e.join("|")+"; given: "+Amm.describeType(t))}return o}if(typeof e==="function"){if(t instanceof e)return true;var a=Amm.getClass(e.prototype);if(!a)return false;e=a}var o=t&&(t[e]==="__CLASS__"||t[e]==="__PARENT__"||t[e]==="__INTERFACE__");if(!o&&i){var s=typeof i==="string"?i:"`item`";throw Error(s+" must be an instance of "+e+"; given: "+Amm.describeType(t))}return o},init:function(t,e,i){if(!e)return;var r=null;if(i instanceof Array){for(var n=0,s=i.length;n<s;n++){if(i[n]in e){if(!r)r={};r[i[n]]=e[i[n]];delete e[i[n]]}}}else{r=e}if(!r)return;for(var a in r)if(r.hasOwnProperty(a)){if(a[0]==="_")throw Error("Use of pseudo-private identifiers is prohibited in `optToSet`, encountered: '"+a+"'");if(a in t&&typeof t[a]==="function"){if(typeof r[a]==="function")t[a]=r[a];else throw Error("Only function is allowed to override the function (`"+a+"` provided is "+typeof r[a]+")")}var o=r[a],l="set"+(""+a).slice(0,1).toUpperCase()+(""+a).slice(1);if(typeof t[l]==="function")t[l](o);else if(a in t)t[a]=o;else if(typeof o==="function")t[a]=o;else{throw Error("No such property: '"+a+"' in "+(this.getClass(t)||"`object`"))}}},getFunction:function(t,e){if(typeof t==="function")return t;if(typeof t!=="string"){throw Error("`strName` must be a string, given: "+this.describeType(t))}if(this._functions[t])return this._functions[t];var i=t.split("."),r=this._namespaces,n=[];while(i.length&&r){var s=i.splice(0,1)[0];n.push(s);r=r[s]}if(!r){if(e)return null;if(i.length){throw Error("Unknown namespace '"+n.join(".")+"' (when trying to locate function '"+t+"')")}else{throw Error("Unknown function '"+n.join(".")+"'")}}return r},registerNamespace:function(t,e){if(typeof t!=="string")throw Error("`ns` must be a string");if(!e||typeof e!=="object"&&typeof e!=="function"){throw Error("Amm.registerNamespace: `hash` must be an object or a function")}this._namespaces[t]=e},registerFunction:function(t,e){if(typeof t!=="string")throw Error("`name` must be a string");if(!e||typeof e!=="function")throw Error("`fn` must be a function");this._functions[t]=e},pushEvent:function(t){var e=this.event;t.parent=e;this._eventStack.push(this.event);this.event=t},popEvent:function(){this.event=this._eventStack.pop()},detectProperty:function(t,e,i){var r=e[0].toUpperCase()+e.slice(1),n="get"+r,s="set"+r,a=e+"Change";if(typeof t[n]!=="function")n=null;if(typeof t[s]!=="function")s=null;if(typeof t.hasEvent!=="function"||!t.hasEvent(a))a=null;var o=a&&n&&s;if(i&&typeof i==="object"){i.getterName=n;i.setterName=s;i.eventName=a}return o},getProperty:function(t,e,i,r){var n;if(typeof t!=="object"||!t)return i;if(t instanceof Array){var s=[];for(var a=0;a<t.length;a++){s.push(this.getProperty(t[a],e,i))}return s}if(e instanceof Array){var s={};for(var a=0;a<e.length;a++){s[e[a]]=this.getProperty(t,e[a],i)}return s}var o=(""+e)[0].toUpperCase()+e.slice(1),l="get"+o;if(r!==undefined&&r!==null){if(!(r instanceof Array))r=[r]}if(typeof t[l]==="function"){n=r?t[l].apply(t,r):t[l]()}else if(e in t)n=t[e];else if(e==="class")n=Amm.getClass(t);else n=i;return n},setProperty:function(t,e,i,r,n){if(t instanceof Array){for(var s=0,a=t.length;s<a;s++){Amm.setProperty(t[s],e,i,r,n)}return}if(i===undefined&&e&&typeof e==="object"){var o={};for(var s in e){if(e.hasOwnProperty(s))o[s]=Amm.setProperty(t,s,e[s],r)}return o}var l=(""+e[0]).toUpperCase()+e.slice(1),h="set"+l;if(n!==undefined&&n!==null){if(!(n instanceof Array))n=[n];else n=[].concat(n);n.unshift(i)}if(typeof t[h]==="function"){o=n?t[h].apply(t,n):t[h](i)}else if(e in t)t[e]=i;else if(r)throw Error("No setter for property: `"+e+"`");return o},createProperty:function(t,r,e,i,n){if(!t||typeof t!=="object")throw Error("`target` must be an object");var s=r.slice(1),a=r[0].toUpperCase()+s,o=r[0].toLowerCase()+s,l="get"+a,h="set"+a,u="out"+a+"Change",f=o+"Change",c="_"+o;if(!(c in t))t[c]=e;if(!(l in t)){t[l]=function(){return this[c]}}var _=i?i.before:null;var m=i?i.after||i:null;if(typeof m!=="function")m=null;if(!(h in t)){t[h]=function(t){var e=this[c],i;if(_){i=_.call(this,t,e,r);if(i!==undefined)t=i}if(e===t)return;this[c]=t;if(m){m.call(this,t,e,r);if(this[c]!==e){this[u](this[c],e)}}else{this[u](t,e)}return true}}if(u&&!(u in t)){t[u]=function(t,e){if(typeof this._out==="function"){this._out(f,t,e)}}}if(n){Object.defineProperty(t,o,{enumerable:true,get:t[l],set:t[h]})}},decorate:function(t,e,i){if(!e)return t;else if(typeof e==="function")return i?e.call(i,t):e(t);else if(typeof e==="object"||typeof e==="string"){if(!e.class&&typeof e.decorate==="function")return e.decorate(t,i);else{var r=Amm.Decorator.construct(e);return r.decorate(t)}}else{throw Error("`decorator` must be either function or an object with .decorate() method")}},cleanup:function(t,e){var i=false,r=0;if(typeof t==="boolean"){i=t[0];r=1}for(var n=r,s=arguments.length;n<s;n++){t=arguments[n];if(!t)continue;var a=false;if(typeof t.cleanup==="function"){t.cleanup();a=true}if(t instanceof Array){for(var o=r,l=t.length;o<l;o++)this.cleanup(t[o]);return}if("_amm_id"in t)this.unregisterItem(t);else{if(!a&&!i)throw Error("`itemOrItems` must be either an object with .cleanup() method or an Array")}}},keys:function(t){var e=[];for(var i in t)if(t.hasOwnProperty(i))e.push(i);return e},values:function(t){var e=[];for(var i in t)if(t.hasOwnProperty(i))e.push(t[i]);return e},bootstrap:function(){if(!jQuery)throw Error("Amm.bootstrap: jQuery not found");var t=this;jQuery(function(){t._doBootstrap()})},getBootstrapped:function(){return this._bootstrapped},_doBootstrap:function(){if(this._bootstrapped)return;this._bootstrapped=true;if(this.optionsObjectId&&window[this.optionsObjectId]){var t=window[this.optionsObjectId];if(typeof t==="object")this.init(this,t)}this.registerNamespace("v",this.View.Html);this.registerNamespace("t",this.Trait);if(this.autoBuildSelector){var e=this.autoBuildSelector;this._autoBuilder=new this.Builder(e,this.defaultBuilderOptions);this._autoBuilder.build()}this.getRoot().raiseEvent("bootstrap")},constructInstance:function(t,e,i,r,n){var s;if(typeof t==="string"||typeof t==="function"){t={class:t}}else if(!t)t={};else if(typeof t!=="object")throw Error("`options` must be a string, an object, a function or FALSEable value");if(Amm.getClass(t)){s=t;if(r&&i&&typeof i==="object"){Amm.setProperty(s,i)}}else{t=Amm.override({},t);if(i){if(typeof i==="string")i={class:i};else if(typeof i!=="object")throw Error("`defaults` must be a string, an object or FALSEable value");for(var a in i)if(!(a in t)&&i.hasOwnProperty(a)){t[a]=i[a]}}var o=t["class"]||e;if(typeof t==="function")o=t;o=Amm.getFunction(o);if(!o)throw Error("Either options.class or baseClass are required");delete t["class"];s=new o(t)}if(e)Amm.is(s,e,"created instance");if(n&&!Amm.meetsRequirements(s,n)){throw Error("created instance doesn't meet specified requirements")}return s},constructMany:function(t,e,i,r,n,s){var a=[];var o;if(t instanceof Array){o=t}else if(t&&typeof t==="object"){o=[];for(var l in t)if(t.hasOwnProperty(l)){a.push(l);o.push(t[l])}}else{throw Error("`options` must be either Array or a hash")}var h=[];var u;if(i)u=r?Amm.override({},i):i;else u={};for(var l=0,f=o.length;l<f;l++){try{if(r&&u){if(a[l])u[r]=a[l];else if(r in i)u[r]=i[r];else delete u[r]}var c=new Amm.constructInstance(o[l],e,u,n,s);if(c===o[l]&&r&&a[l]&&!n){Amm.setProperty(c,r,a[l])}h.push(c)}catch(t){if(typeof t==="string")t=Error("item #'"+(a[l]||l)+"': "+t);else if(t instanceof Error){t.message="item #'"+(a[l]||l)+"': "+t.message}throw t}}return h},translate:function(t,e){var i=t;if(Amm.lang[i])i=Amm.lang[i];for(var r=1,n=arguments.length;r<n;r+=2){i=i.replace(new RegExp(Amm.Util.regexEscape(arguments[r]),"g"),arguments[r+1])}return i},defineLangStrings:function(t,e){for(var i in t)if(t.hasOwnProperty(i)){if(e||!(i in this.lang))this.lang[i]=t[i]}},describeType:function(t){var e=typeof t;if(e!=="object")return e;if(!t)return"null";var i=Amm.getClass(t);if(i)return i;if(t.constructor&&t.constructor.name)return t.constructor.name;return"object"},findElement:function(t){var e=Amm.DomHolder.find(t);if(e[0]&&e[0]["Amm.View.Abstract"])return e[0].getElement();return null},callMethods:function(t,e){var i=e instanceof RegExp,r,n={};for(var s in t){if(typeof t[s]==="function"&&(i?s.match(i):s.indexOf(e)===0)){r=r||Array.prototype.slice.call(arguments,2);n[s]=t[s].apply(t,r)}}return n},html:function(t,e,i,r){if(e===undefined)e=0;if(i===undefined)i=4;var n,s,a,o="",l="";for(s=0;s<e;s++)o+=" ";for(s=0;s<i;s++)l+=" ";if(!t||typeof t!=="object")return o+t;if(t instanceof Array){n="";for(s=0,a=t.length;s<a;s++){if(s>0)n+="\n";n+=Amm.html(t[s],e,i,r)}return n}if(!t.$)throw Error("`$` (tag name) must be present in attribute definition");n=o+"<"+t.$;for(s in t)if(t.hasOwnProperty(s)){if(s[0]==="$")continue;var h=t[s];if(h===false)continue;if(h===true)h=s;if(typeof h==="object"&&h){if(s==="style"){var u;u=function(t,e){var i="";if(!e||typeof e!=="object")return t+": "+e+"; ";if(e instanceof Array)return e.join(" ");if(t.length)t+="-";for(var r in e)if(e.hasOwnProperty(r)){i+=u(t+r,e[r])}return i};h=u("",h)}else{h=JSON.stringify(h).replace(/'/g,"&#39;")}}if(!r)s=s.replace(/_/g,"-");n+=" "+s+"='"+h+"'"}if(t.$$===null){n+=" />";return n}if(!t.$$){n+="></"+t.$+">";return n}var f=t["$noIndent"]?0:e+i;n+=">";if(f)n+="\n";n+=Amm.html(t.$$,f,i,r);if(f)n+="\n"+o;n+="</"+t.$+">";return n},getHtmlElements:function(t){if(t instanceof window.HTMLElement){elementOrDOMNode=Amm.findElement(t)}if(!t)return[];var e=t.getUniqueSubscribers("Amm.View.Html");var i=[];for(var r=0;r<e.length;r++){var n=e[r].getHtmlElement();if(n)i.push(n)}i=Amm.Array.unique(i);return i}};Amm.event=null;Amm.registerNamespace("Amm",Amm);if(window.jQuery){Amm.bootstrap()}Amm.WithEvents=function(t,e){this._subscribers={};if(t){var i=this._extractOnHandlers(t);if(i)this._initOnHandlers(i);if(!e){Amm.init(this,t)}}};Amm.WithEvents.invokeHandler=function(t,e,i,r,n,s){return Amm.WithEvents.invokeHandlers.call(this,t,e,[[i,r,n]],s)};Amm.WithEvents.invokeHandlers=function(t,e,i,r){if(!r){Amm.pushEvent({origin:this,name:t,args:e})}try{var n=i.length,s=n<2?i:i.slice();for(var a=0;a<n;a++){var o=s[a],l=o[0]||null,h=o[1]||this,u=o[2]||undefined;if(typeof h==="string"){if(typeof this.getByPath==="function")h=this.getByPath(h);else h=Amm.getByPath(h);if(!h){continue}}if(!h)h=this;if(typeof l==="string"){l=h[l]}var f=[].concat(e);if(u!==undefined)f.push(u);if(!l||typeof l!=="function"&&typeof l.apply!=="function"){throw Error("Cannot call non-function handler or handler without .apply")}l.apply(h,f)}}catch(t){if(!r)Amm.popEvent();throw t}if(!r)Amm.popEvent();return true};Amm.WithEvents.prototype={"Amm.WithEvents":"__CLASS__",_subscribers:null,strictEvents:true,listEvents:function(){var t=[];for(var e in this){if((""+e).slice(0,3)==="out"&&typeof this[e]==="function"){e=""+e;e=e.slice(3,4).toLowerCase()+e.slice(4,e.length);if(e.length)t.push(e)}}return t},hasEvent:function(t){var e=t.charAt(0),i=e.toUpperCase();if(e===i){return null}var r="",n="out"+i+t.slice(1);if(typeof this[n]==="function")r=n;return r},_out:function(t){if(!this._subscribers)return;var e=this._subscribers[t];if(!e||!e.length)return;var i=Array.prototype.slice.call(arguments,1);Amm.WithEvents.invokeHandlers.call(this,t,i,e)},subscribe:function(t,e,i,r){if(typeof t!=="string"||!t.length)throw Error("`eventName` must be a non-empty string");i=i||null;r=r||null;if(this.strictEvents&&!this.hasEvent(t)){var n=this._handleMissingEvent(t,e,i,r);if(n===undefined)throw Error("No such out event: '"+t+"'");if(n===false)return true}var s=false;if(!this._subscribers[t]){this._subscribers[t]=[];s=true}var a;if(!this.getSubscribers(t,e,i,r).length){this._subscribers[t].push([e,i,r]);a=true}if(s){var o="_subscribeFirst_"+t;if(this[o]&&typeof this[o]==="function")this[o]()}return a},_handleMissingEvent:function(t,e,i,r){},getSubscribers:function(t,e,i,r){var n=[],s=null;if(t===undefined)s=this._subscribers;else{s={};s[t]=true}for(var a in s)if(this._subscribers.hasOwnProperty(a)){var o=this._subscribers[a],l=o.length;for(var h=0;h<l;h++){if(e!==undefined&&e!==o[h][0])continue;if(i!==undefined&&i!==o[h][1])continue;if(r!==undefined&&r!==o[h][2])continue;n.push([].concat(o[h],[a,h]))}}return n},getUniqueSubscribers:function(t,e){var i=[],r=null;if(e===undefined)r=this._subscribers;else{r={};r[e]=true}for(var n in r)if(this._subscribers.hasOwnProperty(n)){var s=this._subscribers[n],a=s.length;for(var o=0;o<a;o++){var l=s[o][1];if(!l)continue;if(t===undefined||Amm.is(l,t))i.push(l)}}return Amm.Array.unique(i)},unsubscribeByIndex:function(t,e){if(!this._subscribers[t]||!(e in this._subscribers[t]))return[];var i;i=[[].concat(this._subscribers[t][e],[t,e])];this._subscribers[t].splice(e,1);if(!this._subscribers[t].length){delete this._subscribers[t];var r="_unsubscribeLast_"+t;if(this[r]&&typeof this[r]==="function")this[r]()}return i},unsubscribe:function(t,e,i,r){var n;if(t instanceof Array&&arguments.length===1){n=t}else{n=this.getSubscribers(t,e,i,r)}for(var s=n.length-1;s>=0;s--){var a=n[s];this._subscribers[a[3]].splice(a[4],1);if(!this._subscribers[a[3]].length){delete this._subscribers[a[3]];var o="_unsubscribeLast_"+t;if(this[o]&&typeof this[o]==="function")this[o]()}}return n},cleanup:function(){this._subscribers={};Amm.unregisterItem(this)},_extractOnHandlers:function(t){var e=[];for(var i in t){if(i[0]==="o"&&i[1]==="n"&&i[2]==="_"&&i[3]==="_"&&t.hasOwnProperty(i)){var r=t[i];if(!(r instanceof Array))r=[r];var n=i.split("__")[1];e.push([n,r[0],r[1],r[2]]);delete t[i]}}return e.length?e:null},_initOnHandlers:function(t){for(var e=0,i=t.length;e<i;e++){this.subscribe(t[e][0],t[e][1],t[e][2],t[e][3])}}};Amm.Array=function(t){var e=arguments,i;if(e[0]instanceof Array){i=e[0];t=e[1]}else if(e[0]instanceof Amm.Array){i=e[0].getItems();t=e[1]}Amm.WithEvents.call(this,t);if(i!==undefined)this.setItems(i)};Amm.Array.indexOf=function(t,e,i){i=i||0;if(e instanceof Array&&e.indexOf)return e.indexOf(t,i);for(var r=i,n=e.length;r<n;r++)if(t===e[r])return r;return-1};Amm.Array.nonStrictIndexOf=function(t,e,i){i=i||0;for(var r=i,n=e.length;r<n;r++)if(t==e[r])return r;return-1};Amm.Array.arrayChangeEvents={appendItems:"outAppendItems",insertItem:"outInsertItem",deleteItem:"outDeleteItem",replaceItem:"outReplaceItem",spliceItems:"outSpliceItems",reorderItems:"outReorderItems",moveItem:"outMoveItem",clearItems:"outClearItems",itemsChange:"outItemsChange"};Amm.Array.costlyEvents={reorderItems:"outReorderItems",moveItem:"outMoveItem"};Amm.Array.prototype={"Amm.Array":"__CLASS__",_unique:false,_comparison:null,_diff:true,_sparse:false,_updateLevel:0,_noTrigger:0,_preUpdateItems:null,_evCache:null,_costlyEvents:false,length:0,push:function(t,e){var i=Array.prototype.slice.apply(arguments);if(this._unique)this._checkDuplicates("push()",i);var r=i.length;if(!r)return this.length;for(var n=0;n<r;n++){this[this.length++]=i[n]}if(!this._updateLevel)this.outAppendItems(i);return this.length},pop:function(){if(!this.length)return undefined;--this.length;var t=this[this.length];delete this[this.length];if(!this._updateLevel)this.outDeleteItem(this.length,t);return t},slice:function(t,e){t=t||0;if(t<0)t=this.length+t;if(t<0)t=0;if(e===undefined)e=this.length;if(!e)e=0;if(e<0)e=this.length+e;if(e<0)e=0;if(e>this.length)e=this.length;var i=[];for(var r=t;r<e;r++)i.push(this[r]);return i},sort:function(t,e){e=e||{};e.changed=false;if(this.length<=1)return this;var i=this.getItems(),r=[].concat(i),n,s=this.length;i.sort(t);var a=false;if(this._comparison){for(n=0;n<s;n++){a=a||this._comparison(this[n],i[n]);if(!this._sparse||n in i){this[n]=i[n]}else{delete this[n]}}}else{for(n=0;n<s;n++){a=a||this[n]!==i[n];this[n]=i[n];if(!this._sparse||n in i){this[n]=i[n]}else{delete this[n]}}}if(a){if(!this._updateLevel)this.outReorderItems(0,this.length,r);e.changed=true}return this},reverse:function(){if(this.length<=1)return this;var t=this.getItems(),e,i=this.length-1,r=(i-i%2)/2,n,s,a;for(e=0;e<=r;e++){if(!this._sparse||e in this&&i-e in this){n=this[e];this[e]=this[i-e];this[i-e]=n}else{s=e in this;a=i-e in this;if(!s&&!a)continue;if(a){this[e]=this[i-e];delete this[i-e]}else{this[i-e]=this[e];delete this[e]}}}if(!this._updateLevel)this.outReorderItems(0,this.length,t);return this},_rotate:function(t,e,i){if(!e)return;var r=e<0?t-e:this.length-1,n=e<0?this.length:t-1,s=e<0?1:-1;while(s*r<s*n){if(r in this)this[r+e]=this[r];else delete this[r+e];r+=s}if(e<0)for(var a=this.length+e;a<this.length;a++)delete this[a];this.length+=e},_innerShift:function(t,e){var i=t>e?-1:1;for(var r=t;r*i<e*i;r+=i){this[r]=this[r+i]}},_checkDuplicates:function(t,e,i,r,n,s){if(s===undefined)s=this._comparison;var a=this.getItems();if(r)a.splice(i,r);var o=e.concat(a),l=Amm.Array.findDuplicates(o,true,s,n?null:e.length);if(l.length){var h=this._describeIdx(l[0][0],e.length,i||0,r||0),u=this._describeIdx(l[0][1],e.length,i||0,r||0);throw Error("Cannot "+t+": duplicates found ("+h+" and "+u+")")}},_describeIdx:function(t,e,i,r){var n=this.length,s,a;if(t<e){s="items";a=t}else if(t<i+e){s="this";a-=e}else{s="this";a=t-e+(r||0)}return s+"["+a+"]"},splice:function(t,e,i,r){var n=Array.prototype.slice.call(arguments,2),s=n.length;var a=[],o=this.length;t=+t||0;if(t<0){t=this.length+t;if(t<0)t=0}else if(t>this.length)t=this.length;e=+e||0;if(e<0)e=0;if(e>this.length-t)e=this.length-t;if(this._unique&&s)this._checkDuplicates("splice()",n,t,e);if(t===this.length){this.push.apply(this,n);return a}var l=s-e;var h;for(h=0;h<e;h++)a.push(this[t+h]);this._rotate(t,l);for(h=0;h<s;h++)this[t+h]=n[h];if(!this._updateLevel)this._outSmartSplice(t,a,n);return a},shift:function(){if(!this.length)return undefined;var t=this[0];this._rotate(0,-1);if(!this._updateLevel)this.outDeleteItem(0,t);return t},unshift:function(t,e){var i=Array.prototype.slice.apply(arguments),r=i.length;if(!r)return this.length;var n=this.length;if(this._unique)this._checkDuplicates("unshift()",i);if(this.length)this._rotate(0,r);else this.length=r;for(var s=0;s<r;s++){this[s]=i[s]}if(!this._updateLevel)this._outSmartSplice(0,[],i);return this.length},indexOf:function(t,e){e=e||0;if(e<0){e=this.length+e;if(e<0)e=0}var i=-1;if(this._comparison){for(var r=e,n=this.length;r<n;r++){if(!this._comparison(t,this[r])){i=r;break}}}else{for(var r=e,n=this.length;r<n;r++){if(t===this[r]){i=r;break}}}return i},getItems:function(){return Array.prototype.slice.apply(this)},getItem:function(t){return this[t]},getIndexExists:function(t){return t in this},setItem:function(t,e){if(this[t]&&this._comparison?!this._comparison(this[t],e):this[t]===e)return;if(this._unique)this._checkDuplicates("setItem()",[e],t,1);if(t<0)throw Error("`index` must be >= 0");if(t>=this.length){if(!this._sparse)t=this.length;this.length=t+1}if(t in this){var i=this[t];this[t]=e;if(!this._updateLevel)this.outReplaceItem(t,e,i)}else{this[t]=e;if(!this._updateLevel)this.outInsertItem(e,t)}return t},removeAtIndex:function(t,e){if(!this._sparse)e=false;if(!(t in this))return false;if(t<0)throw Error("`index` must be >= 0");var i=this[t];if(!e)this._rotate(t,-1);else delete this[t];if(!this._updateLevel)this.outDeleteItem(t,i);return true},moveItem:function(t,e){if(t<0)throw Error("`index` must be >= 0");if(t>=this.length)throw Error("No item with index "+t);if(e<0)throw Error("`newIndex` must be >= 0");if(e>=this.length&&!this._sparse){e=this.length-1}if(e===t)return;var i=this[t],r,n,s;this._innerShift(t,e);this[e]=i;if(!this._updateLevel)this.outMoveItem(t,e,i)},insertItem:function(t,e){if(e===undefined||e>=this.length&&!this._sparse){return this.push(t)-1}if(e<0)throw Error("`index` must be >= 0");if(this._unique)this._checkDuplicates("insertItem()",[t]);if(e<this.length)this._rotate(e,1);if(e>=this.length)this.length=e;this[e]=t;if(!this._updateLevel)this.outInsertItem(t,e);return e},insertItemBefore:function(t,e){if(e===undefined)return this.insertItem(t);var i=this.indexOf(e);if(i<0)throw Error("cannot insertItemBefore: `otherItem` not found");return this.insertItem(t,i)},removeItem:function(t,e){if(this._unique)e=false;var i=0,r=0;while((r=this.indexOf(t,r))>=0){this.removeAtIndex(r);i++;if(!e)break}return i},setItems:function(t){if(!t instanceof Array)throw Error("`items` must be an array");if(this._unique)this._checkDuplicates("setItems()",t,0,this.length);var e=this.getItems(),i=t.length,r=this.length;var n,s;for(n=0,s=0;n<i;n++){if(n in t){this[s]=t[n];s++}else{if(this._sparse){delete this[s];s++}}}this.length=s;while(s<r)delete this[s++];if(!this._updateLevel){if(this._diff){this._doDiff(e,t)}else{this._outSmartSplice(0,e,t)}}return this.length},clearItems:function(){this.setItems([])},setSparse:function(t){var e=this._sparse;if(e===t)return;this._sparse=t;return true},getSparse:function(){return this._sparse},setUnique:function(t){t=!!t;var e=this._unique;if(e===t)return;if(t){this._checkDuplicates("setUnique()",[],0,0,true)}this._unique=t;return true},getUnique:function(){return this._unique},setComparison:function(t){var e=this._comparison;if(e===t)return;if(this._unique){this._checkDuplicates("setComparison()",[],0,0,true,t)}this._comparison=t;return true},getComparison:function(){return this._comparison},setDiff:function(t){var e=this._diff;if(e===t)return;this._diff=t;return true},getDiff:function(){return this._diff},_doBeginUpdate:function(){this._preUpdateItems=this.getItems()},_doEndUpdate:function(){if(this._diff){this._doDiff()}else{if(!this._updateLevel)this.outItemsChange(this._getItems,this._preUpdateItems)}this._preUpdateItems=null},beginUpdate:function(){this._updateLevel++;if(this._updateLevel===1){this._doBeginUpdate()}},endUpdate:function(){if(!this._updateLevel)throw Error("endUpdate() before beginUpdate()!");this._updateLevel--;if(this._updateLevel===0){this._doEndUpdate()}},getUpdateLevel:function(){return this._updateLevel},_buildEvCache:function(){var t=[{}],e=[null];if(!e.indexOf){e.indexOf=this.indexOf}for(var i in this._subscribers){if(this._subscribers.hasOwnProperty(i)&&Amm.Array.arrayChangeEvents[i]){var r=this._subscribers[i].length,n,s,a;for(s=0;s<r;s++){n=this._subscribers[i][s];if(n[1]){a=e.indexOf(n[1]);if(a<0){a=e.length;e.push(n[1]);t.push({})}}else a=0;if(!t[a][i])t[a][i]=[];t[a][i].push(n)}}}this._evCache=t;return this._evCache},_outChain:function(t){if(this._noTrigger||this._updateLevel)return;if(!this._evCache)this._buildEvCache();if(!this._evCache.length)return;var e=[],i,r,n;for(i in t)if(t.hasOwnProperty(i))e.push(i);var s=e.length;for(var a=0,o=this._evCache.length;a<o;a++){for(var l=0;l<s;l++){i=e[l];if(this._evCache[a][i]){var n=t[i];if(!n){n=[];if(i==="itemsChange"){n=[this.getItems()];if(this._preUpdateItems){n.push(this._preUpdateItems)}else if(r=t["spliceItems"]){var h=[].concat(n[0]);h.splice.apply(h,[r[0],r[2].length].concat(r[1]));n.push(h)}}}Amm.WithEvents.invokeHandlers.call(this,i,n,this._evCache[a][i]);if(a!==0)break}}}this._checkLengthChange()},_checkLengthChange:function(){if(this._oldLength!==this.length){var t=this._oldLength;this._oldLength=this.length;this.outLengthChange(this.length,t)}},getLength:function(){return this.length},outLengthChange:function(t,e){return this._out("lengthChange",t,e)},outClearItems:function(t){return this._outChain({clearItems:null,spliceItems:[0,t,[]],itemsChange:[[],t]})},outDeleteItem:function(t,e){return this._outChain({deleteItem:[t,e],spliceItems:[t,[e],[]],itemsChange:null})},outInsertItem:function(t,e){return this._outChain({insertItem:[t,e],spliceItems:[e,[],[t]],itemsChange:null})},outReplaceItem:function(t,e,i){return this._outChain({replaceItem:[t,e,i],spliceItems:[t,[i],[e]],itemsChange:null})},outAppendItems:function(t){return this._outChain({appendItems:[t],spliceItems:[this.length-t.length,[],t],itemsChange:null})},outSpliceItems:function(t,e,i){return this._outChain({spliceItems:[t,e,i],itemsChange:null})},outMoveItem:function(t,e,i){if(this._noTrigger)return;var r,n,s;if(t<e){n=t,s=e-t+1;r=this.slice(t,e);r.unshift(i)}else{n=e;s=t-e+1;r=this.slice(e+1,t+1);r.push(i)}return this._outChain({moveItem:[t,e,this[e]],reorderItems:[n,s,r],spliceItems:[n,r,this.slice(n,n+s)],itemsChange:null})},outReorderItems:function(t,e,i){return this._outChain({reorderItems:[t,e,i],spliceItems:[t,i,this.slice(t,t+e)],itemsChange:null})},outItemsChange:function(t,e){return this._outChain({itemsChange:[t,e]})},_outSmartSplice:function(t,e,i){if(this._noTrigger||this._updateLevel)return;if(!e.length&&!i.length)return;if(t===0&&!i.length&&!this.length){return this.outClearItems(e)}if(!e.length&&t>=this.length-i.length){return this.outAppendItems(i)}if(!e.length&&i.length===1){return this.outInsertItem(i[0],t)}if(e.length===1&&i.length===1){return this.outReplaceItem(t,i[0],e[0])}if(e.length===1&&!i.length){return this.outDeleteItem(t,e[0])}if(e.length===i.length){var r=e.length-1;if(Amm.Array.equal(e,i,undefined,undefined,undefined,this._comparison)){return}else if(this._comparison?!this._comparison(e[0],i[r]):e[0]===i[r]){if(Amm.Array.equal(e,i,1,0,r,this._comparison))return this.outMoveItem(t,t+r,e[0])}else if(this._comparison?!this._comparison(e[r],i[0]):e[r]===i[0]){if(Amm.Array.equal(e,i,0,1,r,this._comparison))return this.outMoveItem(t+r,t,e[r])}if(!Amm.Array.symmetricDiff(e,i,this._comparison).length){return this.outReorderItems(t,e.length,e)}}return this.outSpliceItems(t,e,i)},_doDiff:function(t,e){t=t||this._preUpdateItems;e=e||this.getItems();var i=Amm.Array.smartDiff(t,e,null,!this._costlyEvents);if(!i)return;if(i[0]==="splice"){return this._outSmartSplice(i[1],t.slice(i[1],i[1]+i[2]),i[3])}if(i[0]==="move"){return this.outMoveItem(i[1],i[2],this[i[2]])}if(i[0]==="reorder"){return this.outReorderItems(i[1],i[2],i[3])}},subscribe:function(t,e,i,r,n){this._evCache=null;if(!this._costlyEvents&&Amm.Array.costlyEvents[t])this._costlyEvents=true;return Amm.WithEvents.prototype.subscribe.call(this,t,e,i,r,n)},unsubscribe:function(t,e,i){this._evCache=null;var r=Amm.WithEvents.prototype.unsubscribe.call(this,t,e,i);if(this._costlyEvents&&!this._subscribers[t]&&Amm.Array.costlyEvents[t]){var n=false;for(var s in this._subscribers){if(this._subscribers.hasOwnProperty(s)&&Amm.Array.costlyEvents[s]){n=true;break}}if(!n)this._costlyEvents=true}return r},cleanup:function(){var t=Amm.WithEvents.prototype.unsubscribe.call(this);this._evCache=null;this._updateLevel=1;this.setItems([]);this._preUpdateItems=null;this._updateLevel=0;return t}};Amm.extend(Amm.Array,Amm.WithEvents);Amm.Array.equal=function(t,e,i,r,n,s){if(t===e)return true;if(!i&&!r&&n===undefined){if(t.length!==e.length)return false;i=0;r=0;n=t.length}else{i=i||0;if(i<0)i=t.length+i;if(i<0)i=0;r=r||0;if(r<0)r=e.length+r;if(r<0)r=0;if(n===undefined)n=t.length-i;if(n<0)n=0;if(n===0)return true;var a=n,o=n;if(i+n>t.length)a=t.length-i;if(r+n>e.length)o=e.length-r;if(a<=0&&o<=0)return true;if(a!==o)return false}if(s){for(var l=0;l<n;l++){if(s(t[i+l],e[r+l]))return false}}else{for(var l=0;l<n;l++){if(t[i+l]!==e[r+l])return false}}return true};Amm.Array.smartDiff=function(t,e,i,r,n){var s=t.length,a=e.length,o=a-s,l=s>a?s:a,h,u,f;if(n&&n instanceof Array)n.length=0;if(!s&&!a)return null;if(!s)return["splice",0,0,[].concat(e)];if(!a)return["splice",0,s,[]];for(u=0;u<l;u++){if(i?i(t[u],e[u]):t[u]!==e[u]){break}}var c=o>0?u+o-1:u;for(f=s-1;f>=c;f--){if(i?i(t[f],e[f+o]):t[f]!==e[f+o]){break}}f++;var _=f-u;var m=_+o;var d;if(m)d=e.slice(u,u+m);else d=[];if(!_&&!m)return null;if(_===m&&!r){var p=t.slice(u,u+_),g=0,A=0,v=true;if(i?!i(p[0],d[m-1]):p[0]===d[m-1]){g=1}else if(i?!i(p[_-1],d[0]):p[_-1]===d[0]){A=1}if(g||A){for(h=0;h<_-1;h++){if(i?i(p[h+g],d[h+A]):p[h+g]!==d[h+A]){v=false;break}}if(v){if(g)return["move",u,u+_-1];else return["move",f-1,f-_]}}if(!Amm.Array.symmetricDiff(p,d,i,n).length)return["reorder",u,_,p]}return["splice",u,_,d]};Amm.Array._optArrayDiff=true;Amm.Array.symmetricDiff=function(t,e,i,r){if(!t.length||!e.length)return[].concat(t);if(!(r instanceof Array))r=[];var n=t.length,s=e.length,a,o,l,h,u={},f=[].concat(e);r.length=n;if(i){a=[];for(o=0;o<n;o++){var c=t[o];h=null;for(l=0;l<s;l++)if(f[l]!==u&&!i(c,f[l])){h=l;f[l]=u;break}if(l>=s){a.push(c)}r[o]=h}}else{if(t.filter&&e.indexOf&&Amm.Array._optArrayDiff){a=t.filter(function(t,e){var i=f.indexOf(t);if(i>=0){r[e]=i;f[i]=u;return false}r[e]=null;return true})}else{a=[];for(o=0;o<n;o++){var c=t[o];h=null;for(l=0;l<s;l++)if(c===f[l]){f[l]=u;h=l;break}if(l>=s)a.push(c);r[o]=l}}}return a};Amm.Array.findNonMatched=function(t,e,i){var r={},n=[],s,a;i=i||0;for(s=0,a=t.length;s<a;s++){r[t[s]]=true}for(s=0;s<e;s++){if(!(s in r))n.push(s+i)}return n};Amm.Array.diff=function(t,e,i){if(!t.length||!e.length)return[].concat(t);var r=t.length,n=e.length,s,a,o;if(i){s=[];for(a=0;a<r;a++){var l=t[a];for(o=0;o<n;o++){if(!i(l,e[o]))break}if(o>=n)s.push(l)}}else{if(t.filter&&e.indexOf&&Amm.Array._optArrayDiff){s=t.filter(function(t){return e.indexOf(t)<0})}else{s=[];for(a=0;a<r;a++){var l=t[a];for(o=0;o<n;o++){if(l===e[o])break}if(o>=n)s.push(l)}}}return s};Amm.Array.findDuplicates=function(t,e,i,r,n,s){var a=t.length,o=[],l,h,u,f;if(!r||r<0||r>a)r=a;if(n&&r>=a&&!s){return[]}for(var c=0;c<r;c++){h=true;for(var _=n?r:c+1;_<a;_++){var m;if(i)f=!i(t[c],t[_]);else f=t[c]===t[_];if(f){h=false;if(!l)l=[c];else{if(l.indexOf)m=l.indexOf(_)>=0;else{for(var d=0;d<l.length;d++)if(l[d]===_){m=true;break}}if(m)continue}if(!u)u=[c];u.push(_);if(e)return[u];l.push(_)}}if(u){o.push(u);u=null}else if(s&&h){var p;if(!l)p=false;else{if(l.indexOf)p=l.indexOf(c)>=0;else{for(var d=0;d<l.length;d++)if(l[d]===c){p=true;break}}}if(!p)o.push([c])}}if(n&&s){for(var g=r;g<a;g++){var p;if(!l)p=false;else{if(l.indexOf)p=l.indexOf(g)>=0;else{for(var d=0;d<l.length;d++)if(l[d]===g){p=true;break}}}if(!p)o.push([g])}}return o};Amm.Array.calcChanges=function(t,e,i,r,n){var s=t.length;var a=n?s:null,o=!!n;if(!r)r=0;var l=Amm.Array.findDuplicates(t.concat(e),false,i,a,o,true);var h={added:[],deleted:[],moved:[],same:[]};var u=l.length,f;if(n){for(f=0;f<u;f++){if(l[f].length===1){if(l[f][0]>=s)h.added.push([e[l[f][0]-s],l[f][0]-s+r]);else h.deleted.push([t[l[f][0]],l[f][0]+r]);continue}var c=l[f][0],_=l[f][1]-s;if(c===_){h.same.push([t[c],c+r])}else{h.moved.push([t[c],c+r,_+r])}}return h}for(f=0;f<u;f++){var m=[],d=[],p,g={},A=[],v;for(p=0,v=l[f].length;p<v;p++){var y=l[f][p],E=y>=s,C=E?y-s:y;if(!g[C])g[C]=1;else{g[C]++;A.push(C)}if(E){d.push(C)}else{m.push(C)}}if(A.length){for(p=m.length;p>=0;p--)if(g[m[p]]>1)m.splice(p,1);for(p=d.length;p>=0;p--)if(g[d[p]]>1)d.splice(p,1);for(p=0;p<A.length;p++)h.same.push([t[A[p]],A[p]+r])}var b=m.length<d.length?m.length:d.length;for(p=0;p<b;p++){if(d[p]===m[p])h.same.push([t[m[p]],m[p]+r]);else h.moved.push([t[m[p]],m[p]+r,d[p]+r])}for(p=b;p<d.length;p++)h.added.push([e[d[p]],d[p]+r]);for(p=b;p<m.length;p++)h.deleted.push([t[m[p]],m[p]+r])}return h};Amm.Array.intersect=function(t,e,i){if(!(t instanceof Array||t["Amm.Array"]))throw Error("`a` must be an Array");if(!(e instanceof Array||e["Amm.Array"]))throw Error("`b` must be an Array");if(!t.length||!e.length)return[];var r=[].concat(t).concat(e);var n=Amm.Array.findDuplicates(r,false,i,t.length,true);var s=[];for(var a=0,o=n.length;a<o;a++){for(var l=0,h=n[a].length;l<h;l++){if(n[a][l]<t.length){s.push(r[n[a][l]]);break}}}return s};Amm.Array.unique=function(t,e){if(!(t instanceof Array||t["Amm.Array"]))throw Error("`arr` must be an Array");var i=t["Amm.Array"]?t.getItems():[].concat(t);for(var r=0;r<i.length;r++){for(var n=i.length-1;n>r;n--){if(e?!e(i[n],i[r]):i[n]===i[r])i.splice(n,1)}}return i};Amm.Instantiator=function(){if(this["Amm.Instantiator"]==="__CLASS__"){throw Error("Attempt to instantiate abstract class")}};Amm.Instantiator.prototype={"Amm.Instantiator":"__CLASS__"};Amm.Instantiator.Proto=function(t,e,i){Amm.Instantiator.call(this);if(typeof t!=="object"||t&&!t.proto){t={proto:t}}if(t&&Amm.Builder.isPossibleBuilderSource(t.proto)){this.isElement=true}if(e)t.assocProperty=e;if(i)t.revAssocProperty=i;Amm.init(this,t)};Amm.Instantiator.Proto.prototype={"Amm.Instantiator.Proto":"__CLASS__",proto:null,isElement:false,assocProperty:null,revAssocProperty:null,construct:function(t){if(!this.proto)throw Error("`proto` must be set");var e=this.proto;var i;if(this.isElement)i=new Amm.Element(e);else i=Amm.constructInstance(e,null);if(this.assocProperty)Amm.setProperty(i,this.assocProperty,t);if(this.revAssocProperty)Amm.setProperty(t,this.revAssocProperty,i);return i},destruct:function(t){if(t.cleanup){t.cleanup()}}};Amm.extend(Amm.Instantiator.Proto,Amm.Instantiator);Amm.Instantiator.Variants=function(t){this._prototypes={};this._matches=[];this._objects=[];this._instances=[];Amm.Instantiator.call(this);Amm.WithEvents.call(this,t)};Amm.Instantiator.Variants.prototype={"Amm.Instantiator.Variants":"__CLASS__",_defaultPrototype:null,_prototypes:null,_overrideDefaultPrototype:false,_matches:null,_objects:null,_instances:null,_filter:null,_filterIsAggregate:false,_subscribeFilter:true,_allowNullInstance:false,_assocProperty:null,_revAssocProperty:null,setPrototypes:function(t,e){if(!t||typeof t!=="object")throw Error("`prototypes` must be a non-null object");if(e!==undefined){this._prototypes[e]=Amm.override({},t);return}this._prototypes=Amm.override({},t)},getPrototypes:function(t){if(t===undefined)return this._prototypes;return this._prototypes[t]},setDefaultPrototype:function(t){if(typeof t!=="object"){throw Error("`defaultPrototype` must be a null or an object")}if(!t){this._defaultPrototype=null}else{this._defaultPrototype=Amm.override({},t)}},getDefaultPrototype:function(){return this._defaultPrototype},setOverrideDefaultPrototype:function(t){t=!!t;var e=this._overrideDefaultPrototype;if(e===t)return;this._overrideDefaultPrototype=t;return true},getOverrideDefaultPrototype:function(){return this._overrideDefaultPrototype},construct:function(t,e){var i=this._findObject(t);if(e===undefined&&this._filter&&this._subscribeFilter&&i>=0){e=this._filter.getMatch(t)}else if(e===undefined&&this._filter){e=this._filter.evaluateMatch(t)}var r=this._build(t,e);if(!t)return r;if(i>=0){this._matches[i]=e}else{i=this._objects.length;this._objects.push(t);this._matches.push(e);this._instances[i]=[];this._subscribeObject(t);if(this._filter&&this._subscribeFilter){this._filter.observeObject(t)}}if(!r&&this._instances[i][0]!==null){this._instances[i].unshift(null)}if(r){if(this._instances[i][0]===null){this._instances[i].splice(0,1)}this._instances[i].push(r);this._subscribeInstance(r)}return r},_build:function(t,e){var i,r=this._defaultPrototype;if(this._prototypes[e]){i=this._prototypes[e];if(Amm.Builder.isPossibleBuilderSource(i)){i=Amm.Builder.calcPrototypeFromSource(i,false)}if(r&&this._overrideDefaultPrototype){r=this._defaultPrototype;if(Amm.Builder.isPossibleBuilderSource(r)){r=Amm.Builder.calcPrototypeFromSource(r,false)}i=Amm.override({},r,i)}else{i=Amm.override({},i)}}else{if(!this._defaultPrototype){if(!this._allowNullInstance){throw Error("No prototype for match '"+e+"' and `defaultPrototype` not set!")}return null}if(Amm.Builder.isPossibleBuilderSource(r)){r=Amm.Builder.calcPrototypeFromSource(r,false)}else{i=Amm.override({},r)}}var n=this._assocProperty,s=this._revAssocProperty;if("__assocProperty"in i){n=i.__assocProperty;delete i.__assocProperty}if("__revAssocProperty"in i){s=i.__revAssocProperty;delete i.__revAssocProperty}var a=Amm.constructInstance(i);if(n)Amm.setProperty(a,n,t);if(s&&typeof t==="object"&&t){Amm.setProperty(t,s,a)}return a},destruct:function(t){this.forgetInstance(t);if(t.cleanup){t.cleanup()}},setMatches:function(t,e){if(!t.length||!this._objects.length)return;if(e.length!==t.length)throw Exception("`objects` and `matches` must have same length (are: "+t.length+" and "+e.length+")");var i=[],r=[];var n=Amm.Array.findDuplicates([].concat(this._objects,t),false,null,this._objects.length);if(!n.length)return;var s,a,o,l;for(s=0,a=n.length;s<a;s++){var o=n[s][0],l=n[s][1]-this._objects.length;if(this._matches[o]===e[l])continue;var h=this._matches[o]in this._prototypes,u=e[l]in this._prototypes;this._matches[o]=e[l];if(!u&&!h)continue;i.push(this._objects[o]);r.push(this._matches[o])}if(!i.length)return;this.outNeedRebuild(i,r,this)},outNeedRebuild:function(t,e,i){this._out("needRebuild",t,e,i)},cleanup:function(){if(this._filter)this.setFilter(null);Amm.WithEvents.prototype.cleanup.call(this);this._objects=[];this._matches=[];for(var t=0,e=this._instances.length;t<e;t++){this._instances[t]=[]}this._instances=[];this._prototypes={};this._defaultPrototype={}},setFilter:function(t){var e=false;if(t){if(typeof t==="object"&&!t["Amm.Filter"]){t=Amm.constructInstance(t,"Amm.Filter");e=true}}else{t=null}var i=this._filter;if(i===t)return;if(this._filter){if(this._filterIsAggregate)this._filter.cleanup();else if(this._subscribeFilter)this._subFilter(true)}this._filterIsAggregate=e;this._filter=t;if(this._filter&&this._subscribeFilter){this._subFilter();this.setMatches(this._filter.getObservedObjects(),this._filter.getMatches())}return true},getFilter:function(){return this._filter},setSubscribeFilter:function(t){t=!!t;var e=this._subscribeFilter;if(e===t)return;this._subscribeFilter=t;if(this._filter)this._subFilter(!this._subscribeFilter);return true},getSubscribeFilter:function(){return this._subscribeFilter},getFilterIsAggregate:function(){return this._filterIsAggregate},hasObject:function(t){return this._findObject(t)>=0},hasInstance:function(t){return!!this._findInstance(t)},forgetObject:function(t){var e=this._findObject(t);if(e<0)return;this._forgetObject(e);return true},forgetInstance:function(t){if(!t)return;var e=this._findInstance(t);if(!e)return;this._unsubscribeInstance(t);this._instances[e[0]].splice(e[1],1);if(!this._instances[e[0]].length){this._forgetObject(e[0])}return true},getInstances:function(t){var e=this._findObject(t);if(e<0)return[];return[].concat(this._instances[e])},_subFilter:function(t){if(t){this._filter.unsubscribe("matchesChange",this.handleFilterMatchesChange,this);this._filter.setObservedObjects([]);return}this._filter.setObservedObjects(this._objects);this._filter.subscribe("matchesChange",this.handleFilterMatchesChange,this)},handleFilterMatchesChange:function(t,e,i){var r=[],n=[],s=[];for(var a=0,o=t.length;a<o;a++){if(i[a]===undefined||e[a]===undefined)continue;r.push(t[a]);n.push(e[a])}if(r.length)this.setMatches(r,n)},_findObject:function(t){if(typeof t!=="object"||!t)return-1;return Amm.Array.indexOf(t,this._objects)},_findInstance:function(t){var e,i,r,n;for(e=0,r=this._instances.length;e<r;e++){for(i=0,n=this._instances[e].length;i<n;i++){if(this._instances[e][i]===t)return[e,i]}}return null},_forgetObject:function(t){var e=this._objects[t],i=this._instances[t];if(this._filter)this._filter.unobserveObject(e);this._objects.splice(t,1);this._instances.splice(t,1);if(i.length)this._unsubscribeInstance(i,true);this._unsubscribeObject(e)},_subscribeObject:function(t){if(!t||typeof t!=="object")return;if(t["Amm.WithEvents"]&&t.hasEvent("cleanup")){t.subscribe("cleanup",this._handleObjectCleanup,this)}},_unsubscribeObject:function(t){if(t["Amm.WithEvents"]&&t.hasEvent("cleanup")){t.unsubscribe("cleanup",this._handleObjectCleanup,this)}},_forgetObjectsWithoutInstances:function(){for(var t=this._objects.length-1;t>=0;t--){if(this._instances[t][0]!==null)continue;this._instances[t].splice(0,1);if(this._instances[t].length)continue;this._forgetObject(t)}},_unsubscribeInstance:function(t,e){if(e){for(var i=0,r=t.length;i<r;i++)this._unsubscribeInstance(t[i]);return}if(t["Amm.WithEvents"]&&t.hasEvent("cleanup")){t.unsubscribe("cleanup",this._handleInstanceCleanup,this)}},_subscribeInstance:function(t){if(t["Amm.WithEvents"]&&t.hasEvent("cleanup")){t.subscribe("cleanup",this._handleInstanceCleanup,this)}},_handleObjectCleanup:function(){this.forgetObject(Amm.event.origin)},_handleInstanceCleanup:function(){this.forgetInstance(Amm.event.origin)},setAllowNullInstance:function(t){t=!!t;var e=this._allowNullInstance;if(e===t)return;this._allowNullInstance=t;if(!t)this._forgetObjectsWithoutInstances();return true},getAllowNullInstance:function(){return this._allowNullInstance},setAssocProperty:function(t){if(!t)t=null;var e=this._assocProperty;if(e===t)return;this._assocProperty=t;return true},getAssocProperty:function(){return this._assocProperty},setRevAssocProperty:function(t){if(!t)t=null;var e=this._revAssocProperty;if(e===t)return;this._revAssocProperty=t;return true},getRevAssocProperty:function(){return this._revAssocProperty}};Amm.extend(Amm.Instantiator.Variants,Amm.Instantiator);Amm.extend(Amm.Instantiator.Variants,Amm.WithEvents);Amm.Operator=function(){this._subs=[]};Amm.Operator.CONTEXT_ID=1;Amm.Operator.getNextContextId=function(){return""+Amm.Operator.CONTEXT_ID++};Amm.Operator.NON_CACHEABLE_VALUE=1;Amm.Operator.NON_CACHEABLE_CONTENT=2;Amm.Operator.CONTENT_NOTIFIED=1;Amm.Operator.CONTENT_PERIODICALLY_CHECKED=2;Amm.Operator.CONTENT_OPERAND_REPORTED=4;Amm.Operator.prototype={"Amm.Operator":"__CLASS__",id:null,_parent:null,_parentOperand:null,_expression:null,_subs:null,_defSub:null,_value:undefined,_hasValue:false,_lockChange:0,_isEvaluating:0,_contentChanged:null,_evaluated:0,_nonCacheable:0,_hasNonCacheable:0,_destChanged:0,_level:null,_checkArrayChange:false,OPERANDS:[],supportsAssign:false,beginPos:null,endPos:null,STATE_SHARED:{_contextState:true,_contextId:true,_numCtx:true,_parent:true,_parentOperand:true,_expression:true,_level:true,_instanceStateShared:true,beginPos:true,endPos:true,STATE_SHARED:true,STATE_VARS:true,STATE_PROTO:true,OPERANDS:true,_parenthesis:true},STATE_PROTO:{},STATE_VARS:[],_instanceStateShared:null,_contextState:null,_contextId:"0",_numCtx:1,_parenthesis:false,setExpression:function(t){Amm.is(t,"Amm.Expression","Expression");if(this._expression===t)return;else if(this._expression)Error("Can setExpression() only once");this._expression=t;for(var e=0,i=this.OPERANDS.length;e<i;e++){var r=this["_"+this.OPERANDS[e]+"Operator"];if(r){r.setExpression(t)}}if(this._defSub)this._subscribeDeferreds();return true},_subscribeDeferreds:function(){for(var t=0;t<this._defSub.length;t++){this._expression.subscribeOperator(this._defSub[t][0]||this._expression,this._defSub[t][1],this,this._defSub[t][2])}this._defSub=null},getExpression:function(){return this._expression},setParent:function(t,e){this._parent=t;if(e!==undefined)this._parentOperand=e;var i=t.getExpression();if(i)this.setExpression(i)},getParent:function(){return this._parent},getParentOperand:function(){return this._parentOperand},getLevel:function(){if(this._level===null&&this._parent)this._level=this._parent?this._parent.getLevel()+1:0;return this._level},_sub:function(t,e,i,r,n){var s=this._expression||(this["Amm.Expression"]?this:null);if(!s&&!this._defSub)this._defSub=[];if(t){var a=Amm.Array.indexOf(t,this._subs);if(a<0)this._subs.push(t)}else{t=s||null;if(!s)n=true}r=r||null;i=i||this._defaultHandler;if(typeof e==="string"){if(!n&&!t.hasEvent(e))return;if(s){s.subscribeOperator(t,e,this,i,r)}else{this._defSub.push([t,e,i,r])}return}if(e instanceof Array){for(var o=0,l=e.length;o<l;o++){if(n||t.hasEvent(e[o])){if(s){s.subscribeOperator(t,e[o],this,i,r)}else{this._defSub.push([t,e[o],i,r])}}}}else{for(var o in e){if(!e.hasOwnProperty(o)||!n&&!t.hasEvent(o))continue;if(s){s.subscribeOperator(t,o,this,e[o],r)}else{this._defSub.push([t,o,e[o],r])}}}},_unsub:function(t,e,i,r){if(r===undefined&&arguments.length<4)r=null;if(!t)t=null;if(this._defSub){for(var n=this._defSub.length-1;n>=0;n--){if(this._defSub[n][0]===t&&e===undefined||e===this._defSub[n][1]&&i===undefined||i===this._defSub[n][2]&&r===undefined||r===this._defSub[n][3])this._defSub.splice(n,1)}}else{var s=this._expression||(this["Amm.Expression"]?this:null);if(!s)return;var a=s.unsubscribeOperator(t,e,this,i,r);if(!a){var o=Amm.Array.indexOf(t,this._subs);if(o>=0)this._subs.splice(o,1)}}},notifyOperandChanged:function(t,e,i,r){this._propagateContext(t,r,false);if(this._lockChange){return}this._setOperandValue(t,e)},notifyOperandContentChanged:function(t,e,i){if(this._contentChanged!==null){this._contentChanged++;return}if(this._isEvaluating)return;var r=this._expression||(this["Amm.Expression"]?this:null);if(r&&r.getUpdateLevel()){r.queueUpdate(this);return}this.evaluate();return true},_observeOperandContent:function(t,e,i){var r="_"+t+"Observe";var n=this[r];var s=false;var a=false;if(n&&i){a=this._implObserveOperandContent(t,e,i);this[r]=false;s=n===Amm.Operator.CONTENT_PERIODICALLY_CHECKED}else if(!n&&!i){a=this[r]=this._implObserveOperandContent(t,e,i);s=a===Amm.Operator.CONTENT_PERIODICALLY_CHECKED}if(!s)return a;if(!i){var o;o=this._nonCacheable|Amm.Operator.NON_CACHEABLE_CONTENT;this._setNonCacheable(o)}else{var l=false;for(var h=0,u=this.OPERANDS.length;h<u;h++){l=this["_"+this.OPERANDS[h]+"Observe"]===Amm.Operator.CONTENT_PERIODICALLY_CHECKED;if(l)break}if(!l)this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_CONTENT)}return a},_isValueObservable:function(t,e){if(!e||typeof e!=="object")return;return e["Amm.Array"]||e instanceof Array},_implObserveOperandContent:function(t,e,i){if(!e||typeof e!=="object")return;if(e["Amm.Array"]){if(i){this._unsub(e,"spliceItems",this._handleAmmArraySplice,t)}else{this._sub(e,"spliceItems",this._handleAmmArraySplice,t,true)}return Amm.Operator.CONTENT_NOTIFIED}if(e instanceof Array){this["_"+t+"Old"]=i?undefined:[].concat(e);return Amm.Operator.CONTENT_PERIODICALLY_CHECKED}},_handleAmmArraySplice:function(t,e,i,r){var n=this._makeChangeInfoForSplice(t,e,i);r=arguments[arguments.length-1];this.notifyOperandContentChanged(r,n,true)},_checkContentChanged:function(t){var e="_"+t+"Old",i=this[e],r="_"+t+"Value",n=this[r];if(!(n instanceof Array)){this[e]=null;return}this[e]=[].concat(n);if(!(i instanceof Array))return;var s=Amm.Array.smartDiff(i,n,null,true);if(!s)return;if(s[0]!=="splice")Error("Assertion - should receive only 'splice' event (spliceOnly === true)");var a=s[2]?i.slice(s[1],s[1]+s[2]):[];var o=this._makeChangeInfoForSplice(s[1],a,s[3]);this.notifyOperandContentChanged(t,o,true)},_makeChangeInfoForSplice:function(t,e,i){return{"Amm.SpliceInfo":"__STRUCT__",type:"splice",index:t,cut:e,insert:i}},getReportsContentChanged:function(){return false},getValue:function(t){if(t||!this._hasValue)this.evaluate(t);return this._value},setValue:function(t,e){if(!this.supportsAssign)throw Error(Amm.getClass(this)+" cannot be used as lvalue");var i=this._doSetValue(t);if(!i)return true;if(e)throw i;return false},_doSetValue:function(t,e){if(e)return"assignment not supported";Error("Call to abstract method _doSetValue")},getReadonly:function(){var t=this.supportsAssign?this._doSetValue(undefined,true):"assignment not supported";if(!t)t=false;return t},_doEvaluate:function(t){Error("Call to abstract method _doEvaluate")},toFunction:function(){Error("Call to abstract method toFunction")},assignmentFunction:function(){Error("Call to abstract method assignmentFunction")},_operandFunction:function(t){var e="_"+t+"Operator";if(this[e])return this[e].toFunction();var i=this._getOperandValue(t);return function(){return i}},_reportChange:function(t){if(this._parent){this._parent.notifyOperandChanged(this._parentOperand,this._value,t,this)}},_checkNonCacheableOperators:function(){if(this._hasNonCacheable<=!!this._nonCacheable)return;for(var t=0,e=this.OPERANDS.length;t<e;t++){var i="_"+this.OPERANDS[t]+"Operator";if(!this[i])continue;if(this[i]._contextId!==this._contextId){this._propagateContext(i,this[i],true)}if(this[i]._hasNonCacheable){this[i].checkForChanges()}}},checkForChanges:function(){if(!this._hasNonCacheable)return;var t=this._evaluated;this._checkNonCacheableOperators();if(this._nonCacheable&Amm.Operator.NON_CACHEABLE_CONTENT){this._contentChanged=0;for(var e=0,i=this.OPERANDS.length;e<i;e++){if(this["_"+this.OPERANDS[e]+"Observe"]===Amm.Operator.CONTENT_PERIODICALLY_CHECKED){this._checkContentChanged(this.OPERANDS[e])}}if(this._contentChanged)this.evaluate();this._contentChanged=null}if(this._nonCacheable&Amm.Operator.NON_CACHEABLE_VALUE&&this._evaluated===t){this.evaluate()}},evaluate:function(t){this._isEvaluating++;this._evaluated++;this._hasValue=true;var e=this._doEvaluate(t),i=this._value,r=this._hasValue&&this._value!==e;if(r&&this._checkArrayChange&&e instanceof Array&&this._value instanceof Array){if(Amm.Array.equal(this._value,e)){r=false;e=this._value}}this._value=e;if(r)this._reportChange(i);if(this._destChanged){this._destChanged=false;this._parent.notifyWriteDestinationChanged(this)}this._isEvaluating--;return this._value},_defaultHandler:function(){var t=this._expression||(this["Amm.Expression"]?this:null);if(t&&t.getUpdateLevel()){t.queueUpdate(this);return}this.evaluate()},hasOperand:function(t){return!!(this["_"+t+"Exists"]||this["_"+t+"Operator"])},_setOperand:function(t,e){var i="_"+t+"Operator";var r="_"+t+"Value";var n="_"+t+"Exists";var s="_"+t+"Observe";var a=e&&typeof e==="object"&&e["Amm.Operator"];if(this[i]){if(this[i]===e)return;if(this[i]._hasNonCacheable)this._setHasNonCacheable(this._hasNonCacheable-1);this[i].cleanup()}var o;if(a){if(this[s])this._observeOperandContent(t,this[r],true);if(e.getReportsContentChanged())this[s]=Amm.Operator.CONTENT_OPERAND_REPORTED;this[i]=e;if(e._hasNonCacheable){this._setHasNonCacheable(this._hasNonCacheable+1)}if(!this[n]){this[i].setParent(this,t);this[r]=undefined;return}else{this._lockChange++;this[i].setParent(this,t);o=this[i].getValue();this._lockChange--}var l=t+"OperatorChange";if(typeof this[l]==="function"){this[l](this[i])}}else{o=e}this._setOperandValue(t,o)},_setOperandValue:function(t,e){var i="_"+t+"Value";var r="_"+t+"Exists";var n="_"+t+"Change";var s="_"+t+"Events";var a=this[i];var o=this[r];var l=!o||this[i]!==e;var h,u;if(this[s]){h=e&&e["Amm.WithEvents"]?e:null;u=this[r]&&this[i]&&this[i]["Amm.WithEvents"]?this[i]:null}this[r]=true;this[i]=e;if(h||u)this[s](h,u);if(l){var f="_"+t+"Observe";if(this[f]!==Amm.Operator.CONTENT_OPERAND_REPORTED){if(this[f])this._observeOperandContent(t,a,true);if(this._isValueObservable(t,e))this._observeOperandContent(t,e)}if(this.supportsAssign&&this._parent&&this._parent["Amm.Expression"]){this._destChanged=true}if(this[n])this[n](e,a,o);if(!this._isEvaluating){var c=this._expression||(this["Amm.Expression"]?this:null);if(c&&c.getUpdateLevel()){c.queueUpdate(this)}else{this.evaluate()}}}},finishUpdate:function(){this.evaluate()},_propagateContext:function(t,e,i){if(i)e.setContextId(this._contextId);else this.setContextId(e._contextId)},_getOperandValue:function(t,e){var i="_"+t+"Operator",r=this[i];var n="_"+t+"Value";var s="_"+t+"Exists";if(r&&r._contextId!==this._contextId)this._propagateContext(t,r,true);if(r&&(e||!this[s]||r._hasNonCacheable)){this._setOperandValue(t,r.getValue(e))}if(this[s])return this[n];return undefined},_setNonCacheable:function(t){var e=this._nonCacheable;if(e===t)return;this._nonCacheable=t;if(t)this._setHasNonCacheable(this._hasNonCacheable+1);else this._setHasNonCacheable(this._hasNonCacheable-1);return true},getNonCacheable:function(){return this._nonCacheable},_setHasNonCacheable:function(t){t=parseInt(t);if(t<0)t=0;var e=this._hasNonCacheable;if(e===t)return;this._hasNonCacheable=t;if(!!e!==!!t)this._reportNonCacheabilityChanged(!!t);return true},_reportNonCacheabilityChanged:function(t){if(this._parent){this._parent.notifyOperandNonCacheabilityChanged(this._parentOperand,t,this)}},notifyOperandNonCacheabilityChanged:function(t,e,i){if(this._contextId!==i._contextId){this._propagateContext(t,i)}if(e)this._setHasNonCacheable(this._hasNonCacheable+1);else this._setHasNonCacheable(this._hasNonCacheable-1)},getHasNonCacheable:function(){return this._hasNonCacheable},getOperator:function(t){if(!t)t=this.OPERANDS[0];else if(typeof t==="number")t=this.OPERANDS[t];var e="_"+t+"Operator";if(!(e in this))throw Error("No such operand: '"+t+"' in '"+Amm.getClass(this));var i;i=this[e];if(i&&arguments.length>1){return i.getOperator.apply(i,Array.prototype.slice.call(arguments,1))}return i},deleteContext:function(t){if(t===undefined)t=this._contextId;else if(t!==this._contextId){if(!this._contextState[t]){return}this.setContextId(t)}this._partialCleanup();if(this._contextState!==null)this._contextState[t]=null;for(var e=0,i=this.OPERANDS.length;e<i;e++){var r=this.OPERANDS[e],n="_"+r+"Operator",s=this[n];if(s){s.deleteContext(t)}}this._numCtx--},_partialCleanup:function(){var t=this._subs;this._subs=[];var e=this._expression||(this["Amm.Expression"]?this:null);if(e){for(var i=t.length-1;i>=0;i--){e.unsubscribeOperator(t[i],undefined,this,undefined,undefined)}}},cleanup:function(){this._partialCleanup();this._parent=null;var t=this._expression||(this["Amm.Expression"]?this:null);this._expression=null;this._defSub=null;this._contextState={};for(var e=0,i=this.OPERANDS.length;e<i;e++){var r=this.OPERANDS[e];var n="_"+r+"Operator";var s="_"+r+"Value";this[s]=null;if(this[n]){this[n].cleanup();this[n]=null}}},getSrc:function(){var t=this._expression;if(!t){t=this._parent;while(t&&!t["Amm.Expression"])t=t._parent}if(!t)return;if(this.beginPos===null)return;return t.getSrc(this.beginPos,this.endPos)},createContext:function(t){var e=Amm.Operator.getNextContextId();this.setContextId(e);if(t&&typeof t==="object"){Amm.init(this,t)}return e},setContextIdToDispatchEvent:function(t,e,i){this.setContextId(t)},setContextId:function(t){if(this._contextId===t)return;if(!this._contextState){this._contextState={};this._populateInstanceStateShared()}if(this._contextState[this._contextId]!==null)this._contextState[this._contextId]=this._getContextState();var e,i=false;if(t in this._contextState){e=this._contextState[t];if(e===null){Error("Attempt to setContextId() of already destroyed context")}}else{e=this._constructContextState();i=true;this._numCtx++}this._contextId=t;this._setContextState(e,i)},getContextId:function(){return this._contextId},hasContext:function(t){return this._contextId===t||this._contextState&&this._contextState[t]},listContexts:function(){var t=[];for(var e in this._contextState)if(this._contextState.hasOwnProperty(e)&&this._contextState[e]!==null){t.push(e)}if(!(this._contextId in this._contextState))t.push(this._contextId);return t},_getContextState:function(){var t={};for(var e=0,i=this.STATE_VARS.length;e<i;e++){var r=this.STATE_VARS[e];if(!this._instanceStateShared||!this._instanceStateShared[r]){t[r]=this[r]}}return t},_constructContextState:function(){var t={};for(var e=0,i=this.STATE_VARS.length;e<i;e++){var r=this.STATE_VARS[e];if(this._instanceStateShared&&this._instanceStateShared[r])continue;t[r]=this.STATE_PROTO[r]}t._subs=[];return t},_setContextState:function(t,e){if(e&&!this._allSubs)this._allSubs=[].concat(this._subs);this.getExpression();for(var i in t)if(t.hasOwnProperty(i)){this[i]=t[i]}if(e){this._initContextState(this._contextId,true)}if(this._defSub&&this._expression){this._subscribeDeferreds()}},_initContextState:function(t,e){if(!e){this.setContextId(t);return}this._isEvaluating++;for(var i=0,r=this.OPERANDS.length;i<r;i++){var n="_"+this.OPERANDS[i],s=n+"Operator",a=n+"Value",o=n+"Exists",l=n+"Observe";if(this[o]&&!this[s]){var h=this[a];this[a]=this.STATE_PROTO[a];this[o]=false;this._setOperandValue(this.OPERANDS[i],h)}else if(this[s]){this[s]._initContextState(t)}}this._isEvaluating--},destroyContext:function(){this._partialCleanup();var t=0;if(!(t in this._contextState)){t=null;for(t in this._contextState)if(this._contextState.hasOwnProperty(t))break}if(t!==null)this._setContextState(this._contextState[t])},_populateInstanceStateShared:function(){if(!this._instanceStateShared){this._instanceStateShared={}}for(var t=0,e=this.OPERANDS.length;t<e;t++){var i=this.OPERANDS[t];var r="_"+i+"Operator";var n="_"+i+"Value";var s="_"+i+"Exists";var a="_"+i+"Observe";this._instanceStateShared[r]=true;if(!this[r]){this._instanceStateShared[n]=true;this._instanceStateShared[s]=true;this._instanceStateShared[a]=true}}},getNonCacheableChildren:function(t){if(!this._hasNonCacheable)return[];var e=[];for(var i=0,r=this.OPERANDS.length;i<r;i++){var n=this.getOperator(this.OPERANDS[i]);if(!n)continue;if(n._nonCacheable)e.push(n);if(t&&n._hasNonCacheable){e=e.concat(n.getNonCacheableChildren(true))}}return e}};Amm.Operator.beforeExtend=function(t,e,i){if(!t.prototype.STATE_SHARED)t.prototype.STATE_SHARED={};Amm.override(t.prototype.STATE_SHARED||{},this.prototype.STATE_SHARED);if(!t.beforeExtend)t.beforeExtend=this.beforeExtend;if(!(t.prototype.STATE_VARS instanceof Array)){t.prototype.STATE_VARS=[]}if(!t.prototype.STATE_PROTO)t.prototype.STATE_PROTO={}};Amm.Operator.afterExtend=function(t,e,i){Amm.Operator.populateStateVars(t);if(!t.afterExtend)t.afterExtend=this.afterExtend};Amm.Operator.populateStateVars=function(t){var e=t.prototype;for(var i in e){if(e.hasOwnProperty(i)&&!e.STATE_SHARED[i]&&typeof e[i]!=="function"&&e[i]!=="__CLASS__"&&e[i]!=="__PARENT__"&&e[i]!=="__INTERFACE__"){e.STATE_VARS.push(i);e.STATE_PROTO[i]=e[i]}}if(e.OPERANDS instanceof Array){for(var i=0,r=e.OPERANDS.length;i<r;i++){var n=e.OPERANDS[i];var s="_"+n+"Value";var a="_"+n+"Exists";var o="_"+n+"Observe";e.STATE_VARS.push(s,a,o);e.STATE_PROTO[s]=null;e.STATE_PROTO[a]=null;e.STATE_PROTO[o]=null}}};Amm.Operator.populateStateVars(Amm.Operator);Amm.WithEvents.Proxy=function(){};Amm.WithEvents.Proxy.prototype={subscribeObject:function(t,e,i,r,n,s){return t.subscribe(e,i,r,n,s)},unsubscribeObject:function(t,e,i,r,n,s){return t.unsubscribe(e,i,r,n,s)},getObjectSubscribers:function(t,e,i,r,n,s){return t.getSubscribers(e,i,r,n,s)},getUniqueObjectSubscribers:function(t,e,i){return t.getUniqueSubscribers(e,i)},unsubscribeObjectByIndex:function(t,e,i){return t.unsubscribeByIndex(e,i)}};Amm.WithEvents.Proxy.instance=new Amm.WithEvents.Proxy;Amm.WithEvents.DispatcherProxy=function(t){this._subscriptions=[];Amm.init(this,t)};Amm.WithEvents.DispatcherProxy.ANY={};Amm.WithEvents.DispatcherProxy.SKIP_CALL_HANDLER={};Amm.WithEvents.DispatcherProxy.SimpleCompareExtra=function(t,e){if(t===Amm.WithEvents.DispatcherProxy.ANY)return 0;if(e===Amm.WithEvents.DispatcherProxy.ANY)return 0;return t===e?0:-1};Amm.WithEvents.DispatcherProxy.ArrCompareExtra=function(t,e){if(t===Amm.WithEvents.DispatcherProxy.ANY)return 0;if(e===Amm.WithEvents.DispatcherProxy.ANY)return 0;if(!(t instanceof Array)||!(e instanceof Array))return-1;if(t.length!==e.length)return-1;for(var i=0,r=t.length;i<r;i++){if(t[i]===Amm.WithEvents.DispatcherProxy.ANY){continue}if(e[i]===Amm.WithEvents.DispatcherProxy.ANY){continue}if(t[i]!==e[i])return-1}return 0};Amm.WithEvents.DispatcherProxy.prototype={"Amm.WithEvents.DispatcherProxy":"__CLASS__",_eventsProxy:Amm.WithEvents.Proxy.instance,_subscriptions:null,scope:null,beforeDispatch:null,afterDispatch:null,beforeCallHandler:null,afterCallHandler:null,beforeCallHandlerReturnsNewExtra:false,compareExtra:Amm.WithEvents.DispatcherProxy.ArrCompareExtra,setEventsProxy:function(t){Amm.is(t,Amm.WithEvents.Proxy,"eventsProxy");this._eventsProxy=t},getEventsProxy:function(){return this._eventsProxy},doCallHandler:function(t,e,i,r){var n=t[1],s=t[0];var a=[].concat(i);if(!s.apply)s=n[s];if(r!==undefined)a.push(r);s.apply(n,a)},dispatchEvent:function(){var t=arguments[arguments.length-1],e=Array.prototype.slice.call(arguments,0,-1);if(!t.eventName)Error("Queue array (extra) not provided to Amm.WithEvents.DispatcherProxy.dispatchEvent method");var i=t.eventName;if(this.beforeDispatch){if(this.scope)this.beforeDispatch.call(this.scope,t.eventName,t,arguments);else this.beforeDispatch(t.eventName,t,arguments)}for(var r=0;r<t.length;r++){var n=t[r][2];if(this.beforeCallHandler){var s;if(this.scope)s=this.beforeCallHandler.call(this.scope,t.eventName,t,arguments,r,n);else s=this.beforeCallHandler(t.eventName,t,arguments,r,n);if(s===Amm.WithEvents.DispatcherProxy.SKIP_CALL_HANDLER)continue;if(this.beforeCallHandlerReturnsNewExtra)n=s}if(!n)n=undefined;this.doCallHandler(t[r],t.eventName,e,n);if(this.afterCallHandler){if(this.scope)this.afterCallHandler.call(this.scope,t.eventName,t,arguments,r,n);else this.afterCallHandler(t.eventName,t,arguments,r,n)}}if(this.afterDispatch){if(this.scope)this.afterDispatch.call(this.scope,t.eventName,t,arguments);else this.afterDispatch(t.eventName,t,arguments)}},subscribeObject:function(t,e,i,r,n){var s=this._eventsProxy.getObjectSubscribers(t,e,this.dispatchEvent,this);var a;if(s.length>1)Error("Assertion: Amm.WithEvents.DispatcherProxy.dispatchEvent handler must be subscribed only once");if(n===undefined)n=null;if(r===undefined)r=null;if(!s.length){this._subscriptions.push(t);a=[[i,r,n]];a.eventName=e;this._eventsProxy.subscribeObject(t,e,this.dispatchEvent,this,a);return}a=s[0][2];if(!a||a.eventName!==e){Error("Assertion: we found wrong queue array")}for(var o=0,l=a.length;o<l;o++){if(a[o][0]===i&&a[o][1]===r&&!this.compareExtra(a[o][2],n))return}a.push([i,r,n])},unsubscribeObject:function(t,e,i,r,n){if(!t)Error("`object` parameter is required");var s=this._eventsProxy.getObjectSubscribers(t,e,this.dispatchEvent,this);var a=0;if(!s.length)return 0;if(e&&s.length>1)throw Error("Assertion: Amm.WithEvents.DispatcherProxy.dispatchEvent handler must be subscribed only once");for(var o=0,l=s.length;o<l;o++){var h=s[o][2];if(!h||!h.eventName||e&&h.eventName!==e)Error("Assertion: we found wrong queue array");for(var u=h.length-1;u>=0;u--){if((i===undefined||h[u][0]===i)&&(r===undefined||h[u][1]===r)&&(n===undefined||!this.compareExtra(h[u][2],n))){h.splice(u,1)}else{a++}}if(!h.length){this._removeQueue(t,s[o][3],s[o][4])}}return a},getObjectSubscribers:function(t,e,i,r,n){if(!t)Error("`object` parameter is required");var s=this._eventsProxy.getObjectSubscribers(t,e,this.dispatchEvent,this);if(!s.length)return 0;if(e!==undefined&&s.length>1)Error("Assertion: Amm.WithEvents.DispatcherProxy.dispatchEvent handler must be subscribed only once");var a=[];for(var o=0,l=s.length;o<l;o++){var h=s[o][3],u=s[o][2];if(!u||!u.eventName||u.eventName!==h)Error("Assertion: we found wrong queue array");for(var f=u.length-1;f>=0;f--){if((i===undefined||u[f][0]===i)&&(r===undefined||u[f][1]===r)&&(n===undefined||!this.compareExtra(u[f][2],n))){a.push([].concat(u[f],[h,f]))}}}return a},getUniqueObjectSubscribers:function(t,e,i){var r=this.getObjectSubscribers(t,undefined);var n=[];for(var s=0,a=r.length;s<a;s++){var o=r[j][1];if(!o)continue;if(e===undefined||Amm.is(o,e))n.push(o)}return Amm.Array.unique(n)},_removeQueue:function(t,e,i){this._eventsProxy.unsubscribeObjectByIndex(t,e,i);var r=this._eventsProxy.getObjectSubscribers(t,undefined,this.dispatchEvent,this);if(!r.length){var n=Amm.Array.indexOf(this._subscriptions,t);if(n>=0)this._subscriptions.splice(n,1)}},unsubscribeObjectByIndex:function(t,e,i){var r=this._eventsProxy.getObjectSubscribers(t,e,this.dispatchEvent,this);if(!r.length)return[];if(r.length>1)Error("Assertion: Amm.WithEvents.DispatcherProxy.dispatchEvent handler must be subscribed only once");var n=r[0][2];if(!n.eventName||n.eventName!==e){throw Error("Assertion: we found wrong queue array")}if(!n[i])return[];var s=[[].concat(n[i],[e,i])];n.splice(i);if(!n.length){this._removeQueue(t,e,r[0][4])}return s}};Amm.extend(Amm.WithEvents.DispatcherProxy,Amm.WithEvents.Proxy);Amm.Operator.VarsProvider=function(t,e){this._isEvaluating++;if(e&&typeof e!=="object"){Error("`vars` must be an object")}this._vars=e||{};Amm.Operator.call(this);if(t)this.setOperator(t);this._isEvaluating--};Amm.Operator.VarsProvider.prototype={"Amm.Operator.VarsProvider":"__CLASS__",_vars:null,_varsProvider:null,_varsProviderContextId:null,_allVars:null,_operatorOperator:null,_operatorValue:null,_operatorExists:null,_consumers:null,OPERANDS:["operator"],STATE_SHARED:{_varsProvider:true},setOperator:function(t){this._setOperand("operator",t);if(this._operatorOperator){this.supportsAssign=this._operatorOperator.supportsAssign}if(!this._hasValue&&!this._operatorOperator._hasValue){this._value=this._operatorOperator._value}},_doSetValue:function(t,e){if(!e)this._operatorOperator._doSetValue(t);var i=this._operatorOperator.getReadonly();return i},_doEvaluate:function(t){return this._getOperandValue("operator",t)},toFunction:function(){var n=this._operandFunction("operator");var s=this._vars?this._vars:{};var t;if(this._operatorOperator&&this._operatorOperator.supportsAssign){var a=this._operatorOperator.assignmentFunction();t=function(t,e){var i=t.vars;t.vars=Amm.override({},t.vars,s);var r;if(arguments.length>1){r=a(t,e)}else r=n(t);t.vars=i;return r}}else{t=function(t){var e=t.vars;t.vars=Amm.override({},t.vars,s);var i=n(t);t.vars=e;return i}}t.vars=s;return t},assignmentFunction:function(){if(this._operatorOperator){return this._operatorOperator.assignmentFunction()}return function(){return"`operator` not provided"}},setContextIdToDispatchEvent:function(t,e,i){if(e==="varsChange"&&(i[3]!==this._varsProvider||i[4]!==t)){return}Amm.Operator.prototype.setContextIdToDispatchEvent.call(this,t,e,i)},notifyProviderVarsChange:function(t,e,i,r){if(i){if(this._vars&&i in this._vars)return;var n=Amm.override({},this._allVars||this.getVars());this._allVars[i]=t;if(this._providerVars)this._providerVars[i]=t;if(this._consumers)this._notifyConsumers(t,e,i)}else{n=Amm.override({},this._allVars||this.getVars());this._allVars=Amm.override({},t,this._vars);this._providerVars=t;if(this._consumers)this._notifyConsumers(this._allVars,n,"")}},setVarsProvider:function(t){var e=this._varsProvider;var i=this._varsProviderContextId;if(e===t&&i===this._varsProviderContextId)return;if(e)Error("Can setVarsProvider() only once");if(!t||!t["Amm.Operator.VarsProvider"])Error("varsProvider must be an instance of Amm.Operator.VarsProvider");this._varsProvider=t;this._varsProviderContextId=t._contextId;this._varsProvider.addConsumer(this,"");return true},_initContextState:function(t,e){Amm.Operator.prototype._initContextState.call(this,t,e);if(e&&this._varsProvider){this._varsProviderContextId=this._varsProvider._contextId;this._varsProvider.addConsumer(this,"")}},getVarsProvider:function(){return this._varsProvider},setVars:function(t,e){var i=this["Amm.Expression"]?this:this._expression;if(e){if(typeof e!=="string")Error("setVars(`value`, `name`): `name` must be a string");var r=this._vars[e];if(t===r)return;this._vars[e]=t;if(this._varsProvider){if(!this._allVars)this.getVars();this._allVars[e]=t}if(this._consumers)this._notifyConsumers(t,r,e)}else{if(typeof t!=="object")Error("setVars(`value`): object required");var r=Amm.override({},this._allVars||this.getVars());if(!t)t={};this._vars=Amm.override({},t);this._allVars=null;if(this._consumers)this._notifyConsumers(this.getVars(),r,"")}return true},getVars:function(t,e){if(e||!this._varsProvider)return t?this._vars[t]:this._vars;if(!this._providerVars)this._providerVars=this._varsProvider.getVars();if(!this._allVars){this._allVars=Amm.override({},this._providerVars,this._vars)}return t?this._allVars[t]:this._allVars},setExpression:function(t){var e=Amm.Operator.prototype.setExpression.call(this,t);for(var i=this._parent;i;i=i._parent){if(i["Amm.Operator.VarsProvider"]){this.setVarsProvider(i);return}}return e},_partialCleanup:function(){this._vars={};this._providerVars=null;this._allVars=null;this._consumers=null;if(this._varsProvider&&this._varsProvider.hasContext(this._varsProviderContextId)){var t;if(this._varsProviderContextId!==this._varsProvider._contextId){t=this._varsProvider._contextId;this._varsProvider.setContextId(this._varsProviderContextId)}this._varsProvider.deleteConsumer(this,"");if(t)this._varsProvider.setContextId(t)}Amm.Operator.prototype._partialCleanup.call(this)},cleanup:function(){if(this._varsProvider&&this._varsProvider.hasContext(this._varsProviderContextId)){var t;if(this._varsProviderContextId!==this._varsProvider._contextId){t=this._varsProvider._contextId;this._varsProvider.setContextId(this._varsProviderContextId)}this._varsProvider.deleteConsumer(this,"");if(t)this._varsProvider.setContextId(t)}this._varsProvider=null;this._consumers=null;Amm.Operator.prototype.cleanup.call(this)},_constructContextState:function(){var t=Amm.Operator.prototype._constructContextState.call(this);t._vars={};t._consumers=null;return t},addConsumer:function(t,e){e=e||"";if(!this._consumers){this._consumers={};this._consumers[e]=[]}else if(!this._consumers[e]){this._consumers[e]=[]}var i=t._contextId!==this._contextId?[t,t._contextId]:t;this._consumers[e].push(i)},deleteConsumer:function(t,e){if(!this._consumers)return;e=e||"";var i=t._contextId;if(i===this._contextId)i=null;if(!this._consumers[e])return;for(var r=0,n=this._consumers[e].length;r<n;r++){var s=this._consumers[e][r];if(i===null&&s===t||s[0]===t&&s[1]===i){this._consumers[e].splice(r,1);return}}},_notifyConsumers:function(t,e,i){if(!this._consumers)return;var r=this._consumers,n=this._contextId;var s=false;i=i||"";var a,o,l,h,u,f,c,_;var m;if(i==="")m=Amm.keys(r);else{m=["",i];c=t;f=e;_=i}for(var d=0,p=m.length;d<p;d++)if(r[m[d]]){a=m[d];if(i===""){if(!(a===""||!e||!t||e[a]!==t[a]))continue;if(a!==""){c=t?t[a]:undefined;f=e?e[a]:undefined;_=a}else{c=t;f=e;_=""}}for(o=0,l=r[a].length;o<l;o++){if(r[a][o][0]){h=r[a][o][0];u=r[a][o][1]}else{h=r[a][o];u=n}if(!s){s=true;if(this._expression){this._expression._beginUpdate()}else if(this["Amm.Expression"]){this._beginUpdate()}}if(h._contextId!==u){h.setContextId(u)}h.notifyProviderVarsChange(c,f,_,this)}}if(s){if(this._expression){this._expression._endUpdate()}else if(this["Amm.Expression"]){this._endUpdate()}}}};Amm.extend(Amm.Operator.VarsProvider,Amm.Operator);Amm.Expression=function(t,e,i,r,n){Amm.WithEvents.DispatcherProxy.call(this);if(t&&typeof t==="string"){t={src:t}}var s;if(t&&t["Amm.Operator"]){s=t;t={}}Amm.Operator.VarsProvider.call(this,s);Amm.WithEvents.call(this,t,true);if(e)t.expressionThis=e;if(t.writeProperty){i=t.writeProperty;delete t.writeProperty}if(t.writeObject){r=t.writeObject;delete t.writeObject}if(t.writeArgs){n=t.writeArgs;delete t.writeArgs}Amm.init(this,t);if(i)this.setWriteProperty(i,r,n)};Amm.Expression.compareByContextIdAndLevel=function(t,e){if(e[1]!==t[1])return t[1]-e[1];return e[0].getLevel()-t[0].getLevel()};Amm.Expression.THIS_WRITE_NEVER=0;Amm.Expression.THIS_WRITE_ALWAYS=1;Amm.Expression.THIS_WRITE_ONCE=2;Amm.Expression.THIS_WRITE_AUTO=3;Amm.Expression.prototype={"Amm.Expression":"__CLASS__",_expressionThis:null,_writeProperty:null,_writeObject:null,_writeArgs:null,_lockWrite:0,_writeDestinationChanged:false,_src:null,_updateLevel:0,_updateQueue:null,_updateQueueSorted:false,_currChangeInfo:null,_writeToExpressionThis:Amm.Expression.THIS_WRITE_AUTO,setWriteToExpressionThis:function(t){var e=this._writeToExpressionThis;if(e===t)return;this._writeToExpressionThis=t;this._propagateExpressionThis();return true},getWriteToExpressionThis:function(){return this._writeToExpressionThis},_propagateExpressionThis:function(){if(!(this._writeToExpressionThis&&this._expressionThis&&this._writeObject&&this._writeObject["Amm.Expression"])){return}if(this._writeToExpressionThis===Amm.Expression.THIS_WRITE_AUTO){if(this._writeObject.getExpressionThis()){this._writeToExpressionThis=Amm.Expression.THIS_WRITE_NEVER;return}else{this._writeToExpressionThis=Amm.Expression.THIS_WRITE_ALWAYS}}this._writeObject.setExpressionThis(this._expressionThis);if(this._writeToExpressionThis===Amm.Expression.THIS_WRITE_ONCE){this._writeToExpressionThis=Amm.Expression.THIS_WRITE_NEVER}},STATE_SHARED:{_updateLevel:true,_updateQueue:true,_deferredValueChange:true,_src:true,_subscriptions:true,_eventsProxy:true,scope:true},setExpressionThis:function(t){var e=this._expressionThis;if(e===t)return;if(e&&e["Amm.WithEvents"]&&e.hasEvent("cleanup")){this._unsub(e,"cleanup",this._deleteCurrentContext)}this._expressionThis=t;if(t&&t["Amm.WithEvents"]&&t.hasEvent("cleanup")){this._sub(t,"cleanup",this._deleteCurrentContext,undefined,true)}this._propagateExpressionThis();this.outExpressionThisChange(t,e);return true},getExpressionThis:function(){return this._expressionThis},outExpressionThisChange:function(t,e){this._out("expressionThisChange",t,e)},setWriteProperty:function(t,e,i){if(arguments.length===1&&t instanceof Array){t=arguments[0][0];e=arguments[0][1];i=arguments[0][2]}if(this._writeProperty)Error("Can setWriteProperty() only once");if(!t)Error("writeProperty must be non-falseable");if(typeof t==="string"){if(!t.match(/^\w+$/))t=new Amm.Expression(t,this._expressionThis)}if(t["Amm.Expression"]){if(e||i)Error("When Amm.Expression is used as writeProperty, don't specify writeObject/writeArgs");e=t;t="value";this._sub(e,"writeDestinationChanged",this._write,undefined,true)}if(i===null||i===undefined){i=null}else if(!(i instanceof Array)){i=[i]}if(!e&&!this._expressionThis){Error("setExpressionThis() or provide writeObject when setting writeProperty")}this._writeProperty=t;this._writeObject=e;if(e&&e["Amm.WithEvents"]&&e.hasEvent("cleanup")){this._sub(e,"cleanup",this._deleteCurrentContext,undefined,true)}this._writeArgs=i;this._propagateExpressionThis();this._write()},_write:function(){var t=this._writeObject||this._expressionThis;if(!t)return;if(this._lockWrite)return;this._lockWrite++;Amm.setProperty(t,this._writeProperty,this.getValue(),false,this._writeArgs);this._lockWrite--},getWriteProperty:function(t){return t?[this._writeProperty,this._writeObject,this._writeArgs]:this._writeProperty},getWriteObject:function(){return this._writeObject},getWriteArgs:function(){return this._writeArgs},outVarsChange:function(t,e,i,r,n){this._out("varsChange",t,e,i,r,n)},setOperator:function(t){Amm.Operator.VarsProvider.prototype.setOperator.call(this,t);if(this._operatorOperator){this._operatorOperator.setExpression(this)}},_deferredValueChange:null,_reportChange:function(t){var e="ctx_"+this._contextId;this._currChangeInfo=null;if(this._updateLevel&&this._deferredValueChange){if(!this._deferredValueChange[e]){this._deferredValueChange[e]={contextId:this._contextId,old:t};if(!this._deferredValueChange.ids){this._deferredValueChange.ids=[e]}else{this._deferredValueChange["ids"].push(e)}}return}this.outValueChange(this._value,t);if(this._writeProperty)this._write()},notifyOperandContentChanged:function(t,e,i){var r=this["_"+t+"Operator"];if(r&&r._contextId!==this._contextId){this._propagateContext(t,r)}this._currChangeInfo=e;var n=Amm.Operator.VarsProvider.prototype.notifyOperandContentChanged.call(this,t,e,i);if(this._currChangeInfo){this.outValueChange(this._value,this._value,e);this._currChangeInfo=null}return n},_reportNonCacheabilityChanged:function(t){Amm.Operator.VarsProvider.prototype._reportNonCacheabilityChanged.call(this,t);if(t){this._sub(Amm.getRoot(),"interval",this.checkForChanges,undefined,true)}else{this._unsub(Amm.getRoot(),"interval",this.checkForChanges)}},notifyWriteDestinationChanged:function(){if(this._updateLevel){this._writeDestinationChanged=true;return true}else{this._writeDestinationChanged=false}if(this._operatorOperator._contextId!==this._contextId){this._propagateContext("operator",this._operatorOperator)}return this.outWriteDestinationChanged()},outWriteDestinationChanged:function(){this._out("writeDestinationChanged")},outValueChange:function(t,e,i){this._out("valueChange",t,e,i)},deleteContext:function(t){Amm.Operator.VarsProvider.prototype.deleteContext.call(this,t);if(!this._numCtx)this.cleanup()},_deleteCurrentContext:function(){this.deleteContext()},cleanup:function(){for(var t=this._subscriptions.length-1;t>=0;t--){this._eventsProxy.unsubscribeObject(this._subscriptions[t],undefined,this.dispatchEvent,this)}Amm.WithEvents.prototype.cleanup.call(this);this._subscriptions=[];this._numCtx=0;if(this._writeObject&&this._writeObject["Amm.Expression"]){this._writeObject.cleanup()}Amm.Operator.VarsProvider.prototype.cleanup.call(this)},getIsCacheable:function(){return!this._hasNonCacheable},setSrc:function(t){this.parse(t)},setDest:function(t){return this.setWriteProperty(t,null)},getDest:function(){if(this._writeObject&&this._writeObject["Amm.Expression"])return this._writeObject;if(this._writeProperty)return this._writeProperty},getSrc:function(t,e){if(arguments.length&&this._src)return this._src.slice(t,e);return this._src},parse:function(t){if(this._src)Error("Already parsed");this._src=t;if(!Amm.Expression._builder){Amm.Expression._parser=new Amm.Expression.Parser;Amm.Expression._builder=new Amm.Expression.Builder;Amm.Expression._builder.configureParser(Amm.Expression._parser)}this.setOperator(Amm.Expression._builder.unConst(Amm.Expression._parser.parse(t)))},subscribeOperator:function(t,e,i,r,n){var s=i._contextId;if(n===undefined)n=null;this.subscribeObject(t,e,r,i,[s,n])},unsubscribeOperator:function(t,e,i,r,n,s){var a=s?Amm.WithEvents.DispatcherProxy.ANY:i._contextId;if(n===undefined){if(arguments.length<5)n=null;else n=Amm.WithEvents.DispatcherProxy.ANY}return this.unsubscribeObject(t,e,r,i,[a,n])},beforeDispatch:function(t,e,arguments){if(e.length>1){this._beginUpdate()}},afterDispatch:function(t,e,arguments){if(e.length>1){this._endUpdate()}},beforeCallHandler:function(t,e,arguments,i,r){var n=r[0],s=r[1];var a=e[i][1];if(a._contextId!==n){a.setContextIdToDispatchEvent(n,t,arguments)}return s},beforeCallHandlerReturnsNewExtra:true,getUpdateLevel:function(){return this._updateLevel},_beginUpdate:function(){if(!this._updateLevel)this._updateQueue=[];this._updateLevel++;this._lockWrite++},_sortUpdateQueue:function(t){this._updateQueueSorted=true;if(!t){this._updateQueue.sort(Amm.Expression.compareByContextIdAndLevel);return}if(t>=this._updateQueue.length-1)return;var e=this._updateQueue.splice(t,this._updateQueue.length-t);e.sort(Amm.Expression.compareByContextIdAndLevel);this._updateQueue.push.apply(this._updateQueue,e)},_endUpdate:function(){if(!this._updateLevel){Error("Amm.Expression: _endUpdate() without _beginUpdate!")}if(this._updateLevel>1){this._updateLevel--;this._lockWrite--;return}this._deferredValueChange={};for(var t=0;t<this._updateQueue.length;t++){if(!this._updateQueueSorted){this._sortUpdateQueue(t)}var e=this._updateQueue[t][1];var i=this._updateQueue[t][0];if(i._contextId!==e)i.setContextId(e);i.finishUpdate()}this._updateLevel=0;this._lockWrite--;var r=this._deferredValueChange;this._deferredValueChange=null;if(r.ids){for(var t=0,n=r.ids.length;t<n;t++){var s=r[r.ids[t]];if(this._contextId!==s.contextId){this.setContextId(s.contextId)}this._reportChange(s.old)}}if(this._writeDestinationChanged){this.notifyWriteDestinationChanged()}},queueUpdate:function(t){this._updateQueue.push([t,t._contextId]);this._updateQueueSorted=false},_constructContextState:function(){var t=Amm.Operator.VarsProvider.prototype._constructContextState.call(this);t._subscribers={};return t},toFunction:function(){var r=this._operandFunction("operator"),n={vars:this._vars,expressionThis:this._expressionThis};var t;if(this._operatorOperator&&this._operatorOperator.supportsAssign){var s=this._operatorOperator.assignmentFunction();t=function(t,e){if(arguments.length){var i=s(n,t);if(i&&e)throw i;return!i}else return r(n)}}else{t=function(){return r(n)}}t.env=n;return t},findContext:function(t){if(this._expressionThis===t)return this._contextId;for(var e in this._contextState)if(this._contextState.hasOwnProperty(e)){if(this._contextState[e]&&this._contextState[e]._expressionThis===t){return e}}return undefined}};Amm.Expression.getAllWatchers=function(){var t=[];var e=Amm.getRoot().getUniqueSubscribers(Amm.Expression,"interval");for(var i=0,r=e.length;i<r;i++){t.push({expr:e[i],nc:e[i].getNonCacheableChildren(true)})}return t};Amm.Expression._builder=null;Amm.Expression._parser=null;Amm.extend(Amm.Expression,Amm.WithEvents.DispatcherProxy);Amm.extend(Amm.Expression,Amm.WithEvents);Amm.extend(Amm.Expression,Amm.Operator.VarsProvider);Amm.ArrayMapper=function(t){this._srcEntries=[];this._destEntries=[];this.beginUpdate();Amm.WithEvents.call(this,t);this.endUpdate()};Amm.ArrayMapper.SORT_NONE=0;Amm.ArrayMapper.SORT_DIRECT=1;Amm.ArrayMapper.SORT_REVERSE=-1;Amm.ArrayMapper._SRC_ITEM=0;Amm.ArrayMapper._SRC_INDEX=1;Amm.ArrayMapper._SRC_REF_TO_DEST=2;Amm.ArrayMapper._DEST_REF_TO_SRC=0;Amm.ArrayMapper._DEST_PASS=1;Amm.ArrayMapper._DEST_SORT_VALUE=2;Amm.ArrayMapper._DEST_IN_SLICE=3;Amm.ArrayMapper._DEST_ITEM=4;Amm.ArrayMapper.prototype={"Amm.ArrayMapper":"__CLASS__",_src:null,_srcIsOwn:null,_dest:null,_destIsOwn:false,_srcPrototype:null,_destPrototype:null,srcClass:"Amm.Array",destClass:"Amm.Array",_filter:null,_filterIsFn:null,_sort:Amm.ArrayMapper.SORT_DIRECT,_sortIsFn:null,_offset:0,_length:undefined,_hasSlice:false,_instantiator:null,_instantiatorIsFn:null,_srcEntries:null,_destEntries:null,_destExtra:null,_updateLevel:0,_applyFilter:false,_applySort:false,_applySlice:false,setSrc:function(t){if(t instanceof Array){if(this._src&this._srcIsOwn){return this._src.setItems(t)}else{t=this._createSrc(t)}}else if(!t){t=this._createSrc()}var e=this._src;if(e===t)return;Amm.is(t,this.srcClass,"src");Amm.is(t,"Amm.Array","src");this._srcIsOwn=t._ammArrayMapper===this;this._src=t;if(t)this._subscribeSrc(t);if(this._dest){this._rebuild()}if(t)this._subscribeSrc(t);this.outSrcChange(t,e);if(e)this._cleanupCollectionIfOwn(e);return true},getSrc:function(){if(!this._src)this.setSrc(null);return this._src},outSrcChange:function(t,e){this._out("srcChange",t,e)},setSrcPrototype:function(t){var e=this._srcPrototype;if(e===t)return;this._srcPrototype=t;return true},getSrcPrototype:function(){return this._srcPrototype},getSrcIsOwn:function(){return this._srcIsOwn},_createSrc:function(t){var e=this._srcPrototype?Amm.override({},this._srcPrototype):{};if(t)e.items=t;var i=Amm.constructInstance(e,this.srcClass);i._ammArrayMapper=this;return i},setDest:function(t){if(!t){t=this._createDest()}var e=this._dest;if(e===t)return;Amm.is(t,this.destClass,"dest");Amm.is(t,"Amm.Array","dest");this._destIsOwn=t._ammArrayMapper===this;this._dest=t;this._rebuild();this.outDestChange(t,e);if(e)this._cleanupCollectionIfOwn(e);return true},setDestExtra:function(t){if(t===this._destExtra)return;if(t instanceof Array&&!t.length)t=null;else if(!t)t=null;if(this._destExtra instanceof Array&&t instanceof Array&&Amm.Array.equal(t,this._destExtra))return;this._destExtra=t;this._remap()},getDestExtra:function(){return this._destExtra},getDest:function(){if(!this._dest)this.setDest(null);return this._dest},outDestChange:function(t,e){this._out("destChange",t,e)},setDestPrototype:function(t){var e=this._destPrototype;if(e===t)return;this._destPrototype=t;return true},getDestPrototype:function(){return this._destPrototype},getDestIsOwn:function(){return this._destIsOwn},_createDest:function(){var t=this._destPrototype?this._destPrototype:{};var e=Amm.constructInstance(t,this.destClass);e._ammArrayMapper=this;return e},setFilter:function(t){if(!t)t=null;var e=this._filter;if(e===t)return;if(!t){}else if(typeof t==="object"){t=Amm.constructInstance(t,"Amm.Filter",t);this._filterIsFn=false}else if(typeof t==="function"){this._filterIsFn=true}else throw Error("`filter` must be an object, a function or a null");if(this._filter&&!this._filterIsFn)this._unsubscribeFilter();this._filter=t;if(this._filter&&!this._filterIsFn)this._subscribeFilter();this.applyFilter();return true},_subscribeFilter:function(){if(this._src)this._filter.setObservedObjects(this._src.getItems());this._filter.subscribe("matchesChange",this._handleFilterMatchesChange,this)},_unsubscribeFilter:function(){this._filter.unsubscribe("matchesChange",this._handleFilterMatchesChange,this);this._filter.setObservedObjects([])},_subscribeSort:function(){if(this._src)this._sort.setObservedObjects(this._src.getItems());this._sort.subscribe("matchesChange",this._handleSortMatchesChange,this);this._sort.subscribe("needSort",this._handleSortNeedSort,this)},_unsubscribeSort:function(){this._sort.unsubscribe("matchesChange",this._handleFilterMatchesChange,this);this._sort.unsubscribe("needSort",this._handleSortNeedSort,this);this._sort.setObservedObjects([])},_handleFilterMatchesChange:function(t,e){if(t.length>1)this.beginUpdate();var i,r;for(i=0,r=t.length;i<r;i++){var n=t[i],s=e[i];if(s!==undefined)this.applyFilter(n,s)}if(t.length>1)this.endUpdate()},_handleSortMatchesChange:function(t,e){if(t.length>1)this.beginUpdate();var i,r;for(i=0,r=t.length;i<r;i++){var n=t[i],s=e[i];if(s!==undefined)this.applySort(n,s)}if(t.length>1)this.endUpdate()},_handleSortNeedSort:function(){this._remap()},getFilter:function(){return this._filter},applyFilter:function(t,e){if(!this._src)return;if(t===undefined){if(this._updateLevel)this._applyFilter=true;else{this._recalcAllFilter();this._remap()}return}if(!this._filter)return;var i=0;while((i=Amm.Array.indexOf(t,this._src,i))>=0){var r=this._srcEntries[i][Amm.ArrayMapper._SRC_REF_TO_DEST];var n=r[Amm.ArrayMapper._DEST_PASS];var s=e===undefined?this._getFilterValue(r[Amm.ArrayMapper._DEST_ITEM]):e;if(n!=s&&this._instantiator&&this._instantiator["Amm.Instantiator.Variants"]&&!this._instantiator.getFilter()){this._instantiator.setMatches([t],[s])}if(!!n!==!!s){r[Amm.ArrayMapper._DEST_PASS]=s;if(!this._updateLevel)this._remap()}if(this._src.getUnique())break}},setSort:function(t){if(!t)t=null;var e=this._sort;if(e===t)return;if(!t){}else if(typeof t==="object"){t=Amm.constructInstance(t,"Amm.Sorter");this._sortIsFn=false;if(this._sort&&this._sort["Amm.Sorter"])this._unsubscribeSort()}else if(typeof t==="function"){this._sortIsFn=true}else if(!(t===Amm.ArrayMapper.SORT_DIRECT||t===Amm.ArrayMapper.SORT_REVERSE)){throw Error("`sort` must be an object, a function, Amm.ArrayMapper.SORT_ constant or a null")}this._sort=t;if(t&&t["Amm.Sorter"])this._subscribeSort();this.applySort();return true},getSort:function(){return this._sort},applySort:function(t,e){if(!this._src)return;if(t===undefined){if(this._updateLevel)this._applySort=true;else{this._recalcAllSort();this._remap()}return}if(!this._sort)return;var i=-1;while((i=Amm.Array.indexOf(t,this._src,i+1))>=0){var r=this._srcEntries[i][Amm.ArrayMapper._SRC_REF_TO_DEST];var n=r[Amm.ArrayMapper._DEST_SORT_VALUE];var s=e===undefined?this._getSortValue(i):e;if(n!==s){r[Amm.ArrayMapper._DEST_SORT_VALUE]=e;if(!this._updateLevel)this._remap()}if(this._src.getUnique())break}},_recalcAllSort:function(){var t,e,i;for(var r=0,n=this._destEntries.length;r<n;r++){t=this._destEntries[r][Amm.ArrayMapper._DEST_REF_TO_SRC];if(!this._sort)i=null;else{i=this._getSortValue(t[Amm.ArrayMapper._SRC_ITEM],t[Amm.ArrayMapper._SRC_INDEX])}e=this._destEntries[r][Amm.ArrayMapper._DEST_SORT_VALUE]!==i;this._destEntries[r][Amm.ArrayMapper._DEST_SORT_VALUE]=i}this._applySort=false;if(this._sort&&e&&!this._updateLevel)this._remap()},_recalcAllFilter:function(){var t,e,i,r=[],n=[];var s;s=this._instantiator&&this._instantiator["Amm.Instantiator.Variants"]&&!this._instantiator.getFilter();for(var a=0,o=this._destEntries.length;a<o;a++){t=this._destEntries[a][Amm.ArrayMapper._DEST_REF_TO_SRC];if(!this._filter)i=true;else{i=this._getFilterValue(t[Amm.ArrayMapper._SRC_ITEM])}e=this._destEntries[a][Amm.ArrayMapper._DEST_PASS]!==i;if(e&&s){r.push(t[Amm.ArrayMapper._SRC_ITEM]);n.push(i)}this._destEntries[a][Amm.ArrayMapper._DEST_PASS]=i}this._applyFilter=false;if(r.length)this._instantiator.setMatches(r,n);if(e&&!this._updateLevel)this._remap()},_getSortValue:function(t,e){if(!this._sort)return null;if(this._sort===Amm.ArrayMapper.SORT_DIRECT)return e;if(this._sort===Amm.ArrayMapper.SORT_REVERSE)return-e;if(this._sortIsFn)return this._sort(t,e);return this._sort.calcSortValue(t,e)},setOffset:function(t){if(!t)t=0;if(typeof t!=="number"){t=parseInt(t)}if(isNaN(t))throw Error("`offset` must be a number");var e=this._offset;if(e===t)return;this._offset=t;var i=this._hasSlice;this._hasSlice=!(!this._offset&&this._length===null);if(this._hasSlice||i){if(this._updateLevel){this._applySlice=true}else{this._remap()}}this.outOffsetChange(t,e);return true},getOffset:function(){return this._offset},outOffsetChange:function(t,e){this._out("offsetChange",t,e)},setLength:function(t){if(t===null||t===undefined||t===false||t===""){t=null}else{if(typeof t!=="number")t=parseInt(t)}if(isNaN(t))throw Error("`length` must be null/undefined/false/empty string or a number");var e=this._length;if(e===t)return;this._length=t;var i=this._hasSlice;this._hasSlice=!(!this._offset&&this._length===null);if(this._hasSlice||i){if(this._updateLevel){this._applySlice=true}else{this._remap()}}this.outLengthChange(t,e);return true},getLength:function(){return this._length},outLengthChange:function(t,e){this._out("lengthChange",t,e)},setInstantiator:function(t){var e=this._instantiator;var i;if(!t)t=null;else if(typeof t==="function"){i=true}else if(typeof t==="object"){if(t["class"])t=Amm.constructInstance(t);Amm.meetsRequirements(t,[["construct","destruct"]],"instantiator");i=false}else{throw Error("`instantiator` must be an object, a function or a null")}if(e===t)return;this.beginUpdate();this._destructAll();this._unsubscribeInstantiator();this._instantiatorIsFn=i;this._instantiator=t;this._subscribeInstantiator();this._constructAll();this.endUpdate();return true},_subscribeInstantiator:function(){if(!(this._instantiator&&this._instantiator["Amm.Instantiator.Variants"]))return;this._instantiator.subscribe("needRebuild",this._handleInstantiatorNeedRebuild,this);if(this._filter&&this._filter["Amm.Filter"]){this._filter.subscribe("matchesChange",this._setInstantiatorMatches,this)}},_unsubscribeInstantiator:function(){if(!(this._instantiator&&this._instantiator["Amm.Instantiator.Variants"]))return;this._instantiator.unsubscribe("needRebuild",this._handleInstantiatorNeedRebuild,this);if(this._filter&&this._filter["Amm.Filter"]){this._filter.unsubscribe("matchesChange",this._setInstantiatorMatches,this)}},_setInstantiatorMatches:function(t,e,i){if(this._instantiator.getFilter())return;this._instantiator.handleFilterMatchesChange(t,e,i)},_handleInstantiatorNeedRebuild:function(t,e){var i,r,n,s,a,o=-1,l,h,u,f;h=this._src.getUnique();if(t.length>1||!h){this._dest.beginUpdate()}for(i=0,r=t.length;i<r;i++){u=e[i];if(!u)continue;l=t[i];while((n=Amm.Array.indexOf(l,this._src,n))>=0){s=this._srcEntries[n][Amm.ArrayMapper._SRC_REF_TO_DEST];a=s[Amm.ArrayMapper._DEST_ITEM];if(!a)continue;o=Amm.Array.indexOf(a,this._dest,o);if(o<0)continue;f=this._construct(l,u);this._dest.setItem(o,f);this._destruct(a);s[Amm.ArrayMapper._DEST_ITEM]=f;if(h)break}}if(t.length>1||!this._src.getUnique())this._dest.endUpdate()},_construct:function(t,e){if(!this._instantiator)return t;if(this._instantiatorIsFn)return this._instantiator(t,this);if(this._instantiator.getFilter){var i=this._instantiator.getFilter();if(i&&i!==this._filter)e=undefined}return this._instantiator.construct(t,e,this)},_destruct:function(t){if(!this._instantiator||this._instantiatorIsFn)return;return this._instantiator.destruct(t,this)},_destructAll:function(t){t=t||this._destEntries;if(!t)return;for(var e=0,i=this._destEntries.length;e<i;e++){var r=this._destEntries[e][Amm.ArrayMapper._DEST_ITEM];if(!r)continue;if(this._instantiator)this._destruct(r);t[e][Amm.ArrayMapper._DEST_ITEM]=null}},_constructAll:function(t){t=t||this._destEntries;if(!t)return;for(var e=0,i=t.length;e<i;e++){if(t[e][Amm.ArrayMapper._DEST_ITEM])continue;if(!t[e][Amm.ArrayMapper._DEST_IN_SLICE])continue;var r=t[e][Amm.ArrayMapper._DEST_REF_TO_SRC][Amm.ArrayMapper._SRC_ITEM];var n=t[e][Amm.ArrayMapper._DEST_PASS];var s=this._instantiator?this._construct(r,n):r;t[e][Amm.ArrayMapper._DEST_ITEM]=s}},getInstantiator:function(){return this._instantiator},_cleanupCollectionIfOwn:function(t){if(t&&t._ammArrayMapper===this){delete t._ammArrayMapper;t.cleanup();return true}},_subscribeSrc:function(t,e){var i=e?"unsubscribe":"subscribe";t[i]("spliceItems",this._handleSrcSpliceItems,this)},_getFilterValue:function(t){if(!this._filter)return true;if(this._filterIsFn)return this._filter(t,this);else return this._filter.getMatch(t)},getUpdateLevel:function(){return this._updateLevel},beginUpdate:function(){this._updateLevel++;if(this._dest)this._dest.beginUpdate()},endUpdate:function(){if(!this._updateLevel)throw Error("Call to endUpdate() w/o corresponding beginUpdate()");this._updateLevel--;if(!this._updateLevel){if(this._applyFilter)this._recalcAllFilter();if(this._applySort)this._recalcAllSort();this._remap()}if(this._dest&&this._dest.getUpdateLevel()>this._updateLevel)this._dest.endUpdate()},_handleSrcSpliceItems:function(t,e,i){this.beginUpdate();if(this._filter&&!this._filterIsFn)this._filter.beginUpdate();if(this._sort&&typeof this._sort==="object")this._sort.beginUpdate();var r=Amm.Array.calcChanges(e,i,this._src.getComparison(),t,this._src.getUnique());var n,s;var a=[],o,l,h,u,f,c,_,m,d,p;a.length=i.length;for(n=0,s=r.added.length;n<s;n++){o=r.added[n][0];l=r.added[n][1];u=[o,l,null];if(o&&typeof o==="object"){if(this._filter&&!this._filterIsFn)this._filter.observeObject(o);if(this._sort&&this._sort["Amm.Sorter"]){this._sort.observeObject(o)}}f=[u,m=this._filter?this._getFilterValue(o):true,this._getSortValue(o,l),d=this._hasSlice?undefined:true,null];f[Amm.ArrayMapper._DEST_ITEM]=null;this._destEntries.push(f);u[Amm.ArrayMapper._SRC_REF_TO_DEST]=f;a[l-t]=u}for(n=0,s=r.deleted.length;n<s;n++){o=r.deleted[n][0];l=r.deleted[n][1];u=this._srcEntries[l];f=u[Amm.ArrayMapper._SRC_REF_TO_DEST];_=f[Amm.ArrayMapper._DEST_REF_TO_SRC];if(_!==undefined){if(_!==o&&this._instantiator)this._destruct(_)}f.splice(0,f.length);c=Amm.Array.indexOf(f,this._destEntries);u.splice(0,u.length);if(c>=0)this._destEntries.splice(c,1);if(o&&typeof o==="object"){if(this._filter&&!this._filterIsFn)this._filter.unobserveObject(o);if(this._sort&&this._sort["Amm.Sorter"])this._sort.unobserveObject(o)}}for(n=0,s=r.moved.length;n<s;n++){o=r.moved[n][0];l=r.moved[n][1];h=r.moved[n][1];u=this._srcEntries[l];u[Amm.ArrayMapper._SRC_INDEX]=h;f=u[Amm.ArrayMapper._SRC_REF_TO_DEST];f[Amm.ArrayMapper._DEST_SORT_VALUE]=this._getSortValue(o,h);a[h-t]=u}for(n=0,s=r.same.length;n<s;n++){l=r.same[n][1];u=this._srcEntries[l];a[l-t]=u}if(e.length!==i.length){p=i.length-e.length;for(n=t+e.length;n<this._srcEntries.length;n++){u=this._srcEntries[n];u[Amm.ArrayMapper._SRC_INDEX]=n+p;if(this._sort){o=u[Amm.ArrayMapper._SRC_ITEM];f=u[Amm.ArrayMapper._SRC_REF_TO_DEST];f[Amm.ArrayMapper._DEST_SORT_VALUE]=this._getSortValue(o,n+p)}}}this._srcEntries.splice.apply(this._srcEntries,[t,e.length].concat(a));this._remap();if(this._sort&&typeof this._sort==="object")this._sort.endUpdate();if(this._filter&&!this._filterIsFn)this._filter.endUpdate();this.endUpdate()},_cleanAll:function(){if(!this._srcEntries)return;var t,e,i,r,n;for(t=this._srcEntries.length-1;t>=0;t--){i=this._srcEntries[t];r=i[Amm.ArrayMapper._SRC_REF_TO_DEST];n=r[Amm.ArrayMapper._DEST_ITEM];if(this._instantiator&&!this._instantiatorIsFn&&n&&n!==i[Amm.ArrayMapper._SRC_ITEM]){this._destruct(n)}i.splice(0,i.length);r.splice(0,r.length);if(this._dest)this._dest.setItems([]||this._destExtra)}this._srcEntries=[];this._destEntries=[]},_rebuild:function(){this.beginUpdate();this._cleanAll();if(this._src)this._handleSrcSpliceItems(0,[],this._src.getItems());this.endUpdate()},_remap:function(){if(!this._destEntries)return;this._applySort=false;this._applyFilter=false;this._applySlice=false;var t=[],e,i,r,n,s=Amm.ArrayMapper._DEST_PASS,a=Amm.ArrayMapper._DEST_IN_SLICE,o=Amm.ArrayMapper._DEST_ITEM,l=Amm.ArrayMapper._DEST_REF_TO_SRC,h=Amm.ArrayMapper._SRC_ITEM,u;if(this._sort){u=Amm.ArrayMapper._DEST_SORT_VALUE;if(this._sort["Amm.Sorter"]){var f=this._sort;this._destEntries.sort(function(t,e){return f.compareMatches(t[u],e[u])})}else{this._destEntries.sort(function(t,e){return t[u]-e[u]})}}var c,t=[];if(this._hasSlice)c=[];for(e=0,r=this._destEntries.length;e<r;e++){n=this._destEntries[e];i=!this._filter||n[s];if(!i){n[a]=false;if(n[o]){if(this._instantiator)this._destruct(n[o]);n[o]=null}}else if(!this._hasSlice){n[a]=true;if(!n[o]){n[o]=this._instantiator?this._construct(n[l][h],i):n[l][h]}t.push(n[o])}else{n[a]=undefined;c.push(n)}}if(!this._hasSlice){if(this._destExtra){t=this._destExtra.concat(t)}this.getDest().setItems(t);return}var _=this._getSlice(c.length);var m=c.splice(_[0],_[1]-_[0]);for(e=0,r=m.length;e<r;e++){n=m[e];n[a]=true;if(!n[o]){n[o]=this._instantiator?this._construct(n[l][h],n[s]):n[l][h]}t.push(n[o])}for(e=0,r=c.length;e<r;e++){n=c[e];n[a]=false;if(n[o]){if(this._instantiator)this._destruct(n[o]);n[o]=null}}if(this._destExtra){t=this._destExtra.concat(t)}this.getDest().setItems(t)},_getSlice:function(t){var e=this._offset,i=this._length;if(i===0)return[0,0];var r=e||0;if(r<0)r=t+r;if(r<0)r=0;var n;if(!i)n=t;else if(i<0){n=t+i;if(n<0)n=0}else n=r+i;if(n<r)return[0,0];return[r,n]},cleanup:function(){if(this._filter&&!this._filterIsFn){this._unsubscribeFilter();this._filter=null}if(this._sort&&this._sort["Amm.Sorter"]){this._unsubscribeSort();this._sort=null}this._cleanAll();if(this._src)this._cleanupCollectionIfOwn(this._src);if(this._dest)this._cleanupCollectionIfOwn(this._dest);Amm.WithEvents.prototype.cleanup.call(this)},_getArrayItems:function(t,e){return t.map(function(t){return t?t[e]:undefined})}};Amm.extend(Amm.ArrayMapper,Amm.WithEvents);Amm.Collection=function(t){var i=this;this._compareWithProps=function(t,e){return i._implCompareWithProps(t,e)};this._sortWithProps=function(t,e){return i._implSortWithProps(t,e)};this._itemUpdateQueue=[];this.k={};Amm.Array.call(this,t)};Amm.Collection.ERR_NOT_AN_OBJECT="Not an object.";Amm.Collection.ERR_NOT_MEETING_REQUIREMENTS="Doesn't meet requirements.";Amm.Collection.ERR_DUPLICATE_UPDATE_NOT_ALLOWED="Duplicate; update not allowed.";Amm.Collection.ERR_ADD_DISALLOWED="Adding new items disallowed";Amm.Collection.ERR_DELETE_DISALLOWED="Deleting items disallowed";Amm.Collection.ERR_REORDER_DISALLOWED="Reordering (and inserting/deleting items not at the end) disallowed";Amm.Collection.ERR_KEY_PROPERTY_MISSING="Key property missing";Amm.Collection.ERR_KEY_PROPERTY_INVALID="Invalid key property value (must be scalar)";Amm.Collection.binSearch=function(t,e,i,r,n){var s=typeof r==="number"?r:0;var a=typeof n==="number"?n:t.length-1;var o;if(s<0)s=0;if(a>t.length-1)a=t.length-1;if(s>t.length-1){return[r,false]}var l,h,u;l=i?i(e,t[s]):-(e<t[s])||e!==t[s]|0;if(l===0)return[s,true];else if(l<0)return[s-1,false];h=i?i(e,t[a]):-(e<t[a])||e!==t[a]|0;if(h===0)return[a,true];else if(h>0)return[a+1,false];while(a-s>1){o=Math.floor((s+a)/2);u=i?i(e,t[o]):-(e<t[o])||e!==t[o]|0;if(u===0){return[o,true]}if(u<0)a=o;else s=o}return[a,false]};Amm.Collection.prototype={"Amm.Collection":"__CLASS__",k:null,_unique:true,_sparse:false,_requirements:null,_assocProperty:null,_assocInstance:null,_indexProperty:null,_observeIndexProperty:true,_indexPropertyIsWatched:false,_defaults:null,_undefaults:null,_changeEvents:null,_comparisonProperties:null,_onlyStrict:false,_ignoreExactMatches:null,_recheckUniqueness:false,_custComparison:null,_compareWithProps:null,_sortWithProps:null,_sortProperties:null,_sortReverse:false,_sortFn:null,_sorted:false,_sorter:null,_needSort:false,_lockSort:0,_sorterIsAggregate:false,_updateProperties:null,_itemUpdateLevel:0,_endItemsUpdateLock:false,_itemUpdateQueue:null,_updateFn:null,_allowUpdate:false,_suppressDeleteEvent:0,_suppressIndexEvents:0,_allowAdd:true,_allowDelete:true,_allowChangeOrder:true,_cleanupOnDissociate:false,_assocEvents:null,_instantiator:null,_instantiateOnAccept:false,_keyProperty:null,_byKeyChange:false,setUnique:function(t){if(!t)throw Error("setUnique(false) is never supported by Amm.Collection");return Amm.Array.prototype.setUnique.call(this,t)},setSparse:function(t){if(t)throw Error("setSparse(true) is never supported by Amm.Collection");return Amm.Array.prototype.setSparse.call(this,t)},setRequirements:function(t){var e=t instanceof Array||typeof t==="string"||typeof t==="function";if(!e){throw Error("requirements must be an Array, a string or a function")}var i=this._requirements;if(i===t)return;if(t){for(var r=0,n=this.length;r<n;r++){if(!Amm.meetsRequirements(this[r],t)){throw Error("Cannot setRequirements(): at least one item ("+r+")"+" doesn't meet new `requirements`")}}}this._requirements=t;return true},setInstantiator:function(t){if(!t)t=null;var e=this._instantiator;if(e===t)return;this._instantiator=t;return true},getInstantiator:function(){return this._instantiator},setInstantiateOnAccept:function(t){t=!!t;var e=this._instantiateOnAccept;if(e===t)return;this._instantiateOnAccept=t;return true},getInstantiateOnAccept:function(){return this._instantiateOnAccept},createItem:function(t){if(!this._instantiator)throw Error("Cannot createItem() when `instantiator` not provided");var e=this._instantiator.construct(t);this.accept(e);return e},getRequirements:function(){return this._requirements},canAccept:function(t,e,i){i=i||{};if(!this._allowAdd){i.error=Amm.Collection.ERR_ADD_DISALLOWED;return false}if(!(typeof t==="object"&&t)){i.error=Amm.Collection.ERR_NOT_AN_OBJECT;return false}if(this._requirements&&!Amm.meetsRequirements(t,this._requirements)){i.error=Amm.Collection.ERR_NOT_MEETING_REQUIREMENTS;return false}if(this._keyProperty){if(!Amm.detectProperty(t,this._keyProperty)){i.error=Amm.Collection.ERR_KEY_PROPERTY_MISSING;return false}var r=Amm.getProperty(t,this._keyProperty);if(r&&typeof r==="object"){i.error=Amm.Collection.ERR_KEY_PROPERTY_INVALID;return false}}if(!e&&!this._allowUpdate){var n=this.indexOf(t);if(n>=0){i.error=Amm.Collection.ERR_DUPLICATE_UPDATE_NOT_ALLOWED;i.index=n;return false}}i.index=null;i.error=null;this.outOnCanAccept(t,i);return!i.error},_instantiateIfNeeded:function(t){var e=false;if(this._requirements)e=!Amm.meetsRequirements(t,this._requirements);else if(typeof t!=="object")e=true;else if(!Amm.getClass(t))e=true;if(!e)return t;var i=this._instantiator.construct(t);return i},_preAccept:function(t,e,i){if(!e)e=0;if(e<0)e=this.length+e;if(e>this.length)e=this.length;if(!i)i=0;var r=e+i;if(i<0){r=this.length+i;i=0}var n=t.concat(this.getItems()),s,a,o=i?this.slice(e,r):[],l=[],h=0;for(var s=e;s<r;s++)l.push(s);if(this._instantiator&&this._instantiateOnAccept){for(s=0,a=t.length;s<a;s++){t[s]=this._instantiateIfNeeded(t[s])}}for(s=0,a=t.length;s<a;s++){var u={};if(!this.canAccept(t[s],true,u)){throw Error("Cannot accept items["+s+"]: "+u.error)}}var f=Amm.Array.findDuplicates(n,false,this._comparison);if(!f.length){return[[].concat(t),[],[],[],o,[].concat(t),l]}var c=f.length,_=[],m=[],d=[].concat(t),p=0,g=[],A=[].concat(t);for(s=0;s<c;s++){var v=f[s];if(v.length>2){var y=[];for(j=0;j<v.length;j++)y.push(this._describeIdx(v[j],t.length));throw Error("Multiple instances of same item: "+y.join(", "))}var E=n[v[0]]===n[v[1]];if(v[0]>=t.length)throw Error("WTF: we found two duplicates in `this`: "+this._describeIdx(v[0],t.length)+(E?" === ":" ~= ")+this._describeIdx(v[1],t.length));if(v[1]<t.length)throw Error("There are at least two duplicates in `items`: "+this._describeIdx(v[0],t.length)+(E?" === ":" ~= ")+this._describeIdx(v[1],t.length));var C=v[1]-t.length;var b=C>=e&&C<r;if(!E&&!this._allowUpdate){b=false}if(E&&!b&&!this._ignoreExactMatches){throw Error("Item already in collection: "+this._describeIdx(v[0],t.length)+" === "+this._describeIdx(v[1],t.length)+". setIgnoreExactMatches(true) next time.")}if(!E&&!b&&!this._allowUpdate){throw Error("Added item matches existing one, but no update routine provided: "+this._describeIdx(v[0],t.length)+" ~= "+this._describeIdx(v[1],t.length)+". setUpdateProperties() and/or setUpdateFn() may help.")}if(b){o[C-e]=undefined;l[C-e]=undefined;h++}if(!b){A.splice(v[0]-_.length,1)}d.splice(v[0]-p,1);p++;g.push(v[0]);_.push(n[v[0]]);m.push(n[v[1]])}if(h){for(s=o.length-1;s>=0;s--){if(o[s]!==undefined)continue;o.splice(s,1);l.splice(s,1)}}return[d,_,m,g,o,A,l]},_addNew:function(t,e){if(e===undefined||e>=this._length){e=this.length;this.length+=t.length}else{this._rotate(e,t.length)}for(var i=0,r=t.length;i<r;i++){this[e+i]=t[i]}},_addNewToSorted:function(t){var e=[].concat(t);var i=this._locateManyItemIndexesInSortedArray(e);for(var r=0;r<i.length;r++){if(i[r]<this.length){this._rotate(i[r],1);this[i[r]]=e[r]}else{this[this.length++]=e[r]}}return[e,i]},accept:function(t,e){var i=this._preAccept([t]);var r;if(this._sorted&&e!==undefined){throw Error("`index` must not be used with sorted Collection - check for getIsSorted() next time")}if(e===undefined)e=this.length;if(e<0)e=this.length+e;if(e>this.length)e=this.length;if(i[0].length){var n=this._sorted;var s=n?this._locateItemIndexInSortedArray(t):e;if(s===undefined||s<=0)s=0;r=i[0][0];if(s<this.length){this._rotate(s,1);this[s]=t}else{this[this.length++]=t}this._associate(t,s);this._outSmartSplice(s,[],[t]);this._subscribe(t);if(this._indexProperty&&s<this.length-1)this._reportIndexes(null,s+1)}else{r=i[2][0];this._updateItem(i[2][0],i[1][0])}return r},acceptMany:function(t,e){var i=this._sorted;if(i&&e!==undefined)throw Error("`index` must not be used with sorted Collection - check for getIsSorted() next time");if(!t.length)return[];if(t.length===1)return[this.accept(t[0])];this._byKeyChange=1;var r=this._preAccept([].concat(t));var n;if(r[0].length){var s=this.getItems(),a;if(i){var o=this._addNewToSorted(r[0]);for(n=0;n<o[0].length;n++){this._associate(o[0][n],o[1][n])}this._outFragmentedInsert(this._getInsertFragments(o[0],o[1]));a=o[1][0]}else{if(e<0)e=this.length+e;if(e===undefined||e>this.length)e=this.length;a=e;this._addNew(r[0],e);for(n=0;n<r[0].length;n++){this._associate(r[0][n],e+n)}this._outSmartSplice(e,[],r[0])}for(n=0;n<r[0].length;n++){this._subscribe(r[0][n])}if(this._indexProperty&&a<this.length-r[0].length-1){this._reportIndexes(s,a)}}var l=[].concat(r[0]);for(var n=0;n<r[1].length;n++){this._updateItem(r[2][n],r[1][n]);l.splice(r[3][n],0,r[2][n])}if(this._byKeyChange===true){this._byKeyChange=false;this.outByKeyChange()}else{this._byKeyChange=false}return l},hasItem:function(t,e){if(e)return this.indexOf(t)>=0;return Amm.Array.indexOf(t,this)>=0},strictIndexOf:function(t){return Amm.Array.indexOf(t,this)},intersect:function(t,e,i){if(i&&!(i instanceof Array))throw Error("`groups` must be an Array (or falseable value)");if(!t.length)return[];var r=this.getItems().concat(t);var n=Amm.Array.findDuplicates(r,false,e?null:this._comparison,this.length,true);var s=[];for(var a=0,o=n.length;a<o;a++){for(var l=0,h=n[a].length;l<h;l++){if(n[a][l]<this.length){s.push(r[n[a][l]]);if(i)i.push([n[a][l]].concat(n.slice(0,l)));break}}}return s},reject:function(t,e){if(!this._suppressDeleteEvent&&!this._allowDelete){throw Error(Amm.Collection.ERR_DELETE_DISALLOWED)}var i,r;if(typeof t!=="object"){i=parseInt(t);if(isNaN(i))throw Error("itemOrIndex must be an object or a number");if(i<0)i=this.length+i;if(i>=this.length)throw Error("index ["+i+"] doesn't exist");r=this[i]}else{r=t;i=e?this.indexOf(r):this.strictIndexOf(r);if(i<0)throw Error("itemOrIndex specifies non-existing item");r=this[i]}if(!this._suppressDeleteEvent&&!this._allowChangeOrder&&i<this.length-1){throw Error(Amm.Collection.ERR_REORDER_DISALLOWED)}this._rotate(i,-1);this._dissociate(r);if(this._indexProperty&&i<this.length)this._reportIndexes(null,i);if(!this._suppressDeleteEvent&&!this._updateLevel){this.outDeleteItem(i,r)}return r},push:function(t,e){if(!this._allowAdd){throw Error(Amm.Collection.ERR_ADD_DISALLOWED)}var i=Array.prototype.slice.apply(arguments);if(i.length===1)this.accept(i[0]);else this.acceptMany(i);return this.length},pop:function(){if(!this._allowDelete)throw Error(Amm.Collection.ERR_DELETE_DISALLOWED);if(this.length)return this.reject(this.length-1)},unshift:function(t,e){if(!this._allowAdd){throw Error(Amm.Collection.ERR_ADD_DISALLOWED)}if(!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);var i=Array.prototype.slice.apply(arguments);var r=this._sorted?undefined:0;if(i.length===1)this.accept(i[0],r);else this.acceptMany(i,r);return this.length},shift:function(){if(!this._allowDelete)throw Error(Amm.Collection.ERR_DELETE_DISALLOWED);if(!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);if(this.length)return this.reject(0)},splice:function(t,e,i,r){var n=Array.prototype.slice.call(arguments,2);if(n.length&&!this._allowAdd){throw Error(Amm.Collection.ERR_ADD_DISALLOWED)}if(e&&!this._allowDelete){throw Error(Amm.Collection.ERR_DELETE_DISALLOWED)}if(t<0){t=this.length+t;if(t<0)t=0}else if(t>this.length)t=this.length;if(t<this.length-e&&!this._allowChangeOrder){throw Error(Amm.Collection.ERR_REORDER_DISALLOWED)}if(e<0)e=0;var s=this.slice(t,t+e);var a=this._preAccept(n,t,e);var o=a[0],l=a[4],h=a[6],u=a[5];var f,c,_,m;var d,p,g,A;if(this._sorted){p=this._addNewToSorted(a[0]);for(var f=h.length-1;f>=0;f--){for(var c=p[1].length-1;c>=0;c--){if(p[1][c]>h[f])p[1][c]--;else break}}d=this._getInsertFragments(p[0],p[1]);g=l.length?this._getCutFragments(t,l):[];A=this._getGoodSplice(g,d)}else{A=[t,s,u]}if(this._byKeyChange!==true)this._byKeyChange=1;if(A)this._suppressDeleteEvent++;for(f=0,_=l.length;f<_;f++){this.reject(l[f])}if(A)this._suppressDeleteEvent--;var v=this.getItems();if(this._sorted){for(f=0;f<p[0].length;f++){var y=p[1][f];this._associate(p[0][f],y)}if(!A){this._outFragmentedInsert(d)}else{this._outSmartSplice(A[0],A[1],A[2])}}else{var E=u.length-(s.length-l.length);this._rotate(t,E);c=0;_=u.length;m=o.length;for(f=0;f<_;f++){c=0;while(c<=f&&u[f]!==o[c])c++;this[t+f]=u[f];if(u[f]===o[c]){this._associate(this[t+f],t+f)}}this._outSmartSplice(t,s,u)}for(f=0;f<a[0].length;f++){this._subscribe(a[0][f])}if(this._byKeyChange===true){this._byKeyChange=false;this.outByKeyChange()}else{this._byKeyChange=false}if(this._indexProperty)this._reportIndexes(v);for(var f=0;f<a[1].length;f++){if(a[2][f]!==a[1][f])this._updateItem(a[2][f],a[1][f])}return s},setItems:function(t){var e=[0,this.length].concat(t);this.splice.apply(this,e);return this.length},reverse:function(){if(!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);if(this._sorted){this.setSortReverse(!this.getSortReverse());return this.getItems()}else{var t=this.getItems(),e;e=Amm.Array.prototype.reverse.apply(this);if(this._indexProperty)this._reportIndexes(t);return e}},setItem:function(t,e){this.splice(t,1,e);return this[t]===e?t:this.indexOf(e)},removeAtIndex:function(t,e){this.reject(t);return true},moveItem:function(t,e){if(!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);if(this._sorted){throw Error("Cannot moveItem() on sorted Collection. Check with getIsSorted() next time")}var i,r;if(t<=e){i=t;r=e}else{i=e;r=t}var n=Amm.Array.prototype.moveItem.call(this,t,e);if(this._indexProperty)this._reportIndexes(null,i,r+1);return n},_getCutFragments:function(t,e){var i=[],r=0,n=t,s=0,a=e.length,o=this.length;while(r<a&&n<o){if(e[r]===this[n]){s++;r++}else{if(s)i.push([n-s,s,e.slice(r-s,r)]);s=0}n++}if(s)i.push([n-s,s,e.slice(r-s,r)]);return i},_getInsertFragments:function(t,e){if(!t.length)return[];var i=[];var r=[e[0],[t[0]]];for(var n=1,s=t.length;n<s;n++){if(e[n]===r[0]+r[1].length){r[1].push(t[n])}else{i.push(r);r=[e[n],[t[n]]]}}i.push(r);return i},_getGoodSplice:function(t,e){var i=t.length,r=e.length;if(i>1||r>1)return null;if(!i&&!r)return null;if(!i&&r)return[e[0][0],[],e[0][1]];if(i&&!r)return[t[0][0],t[0][2],[]];if(i&&r&&t[0][0]===e[0][0])return[e[0][0],t[0][2],e[0][1]];return null},_outFragmentedInsert:function(t){for(var e=0;e<t.length;e++){this._outSmartSplice(t[e][0],[],t[e][1])}},insertItem:function(t,e){if(e<0)throw Error("`index` must be >= 0");var i;if(e===undefined||e>=this.length||this._sorted)i=this.accept(t);else i=this.accept(t,e);return this.strictIndexOf(t)},getIsSorted:function(){return this._sorted},_associate:function(t,e,i){if(this[e]!==t){throw Error("WTF - this[`index`] !== `item`")}if(this._assocProperty){Amm.setProperty(t,this._assocProperty,this._assocInstance||this)}if(this._assocEvents)this._associateEvents([t]);if(this._indexProperty){Amm.setProperty(t,this._indexProperty,e)}if(this._defaults)Amm.setProperty(t,this._defaults);if(i)this._subscribe(t);this.outOnAssociate(t,e);if(this._keyProperty){var r=Amm.getProperty(t,this._keyProperty);if(r!==undefined&&r!==null){this.k[r]=t;this.outByKeyChange()}}},outOnAssociate:function(t,e){return this._out("onAssociate",t,e)},_subscribe:function(t){if(this._changeEvents){for(var e=0,i=this._changeEvents.length;e<i;e++){t.subscribe(this._changeEvents[e],this._reportItemChangeEvent,this)}}if(this._indexPropertyIsWatched){var r=this._indexProperty+"Change";t.subscribe(r,this._reportItemIndexPropertyChange,this)}if(this._keyProperty){t.subscribe(this._keyProperty+"Change",this._handleKeyChange,this)}},_dissociate:function(t){if(this._changeEvents){t.unsubscribe(undefined,this._reportItemChangeEvent,this)}if(this._assocProperty&&Amm.getProperty(t,this._assocProperty)===(this._assocInstance||this)){Amm.setProperty(t,this._assocProperty,null)}if(this._assocEvents)this._associateEvents([t],true);if(this._indexPropertyIsWatched){if(this._indexPropertyIsWatched){var e=this._indexProperty+"Change";t.unsubscribe(e,this._reportItemIndexPropertyChange,this)}}if(this._keyProperty){var i=Amm.getProperty(t,this._keyProperty);if(i!==false&&i!==undefined&&this.k[i]===t){delete this.k[i];this.outByKeyChange()}t.unsubscribe(this._keyProperty+"Change",this._handleKeyChange,this)}if(this._undefaults){Amm.setProperty(t,this._undefaults)}if(this._sorter){this._lockSort++;this._sorter.unobserveObject(t);this._lockSort--}this.outOnDissociate(t);if(this._cleanupOnDissociate&&typeof(t.cleanup==="function")){t.cleanup()}},outOnDissociate:function(t){return this._out("onDissociate",t)},outOnCanAccept:function(t,e){e=e||{};return this._out("onCanAccept",t,e)},setAssocProperty:function(t){if(!t)t=null;var e=this._assocProperty;if(e===t)return;this._assocProperty=t;this._beginItemsUpdate();var i,r=this.length;if(e){for(i=0;i<r;i++)Amm.setProperty(this[i],e,null)}if(t){for(i=0;i<r;i++)Amm.setProperty(this[i],t,this._assocInstance||this)}this._endItemsUpdate();return true},getAssocProperty:function(){return this._assocProperty},setAssocInstance:function(t){var e=this._assocInstance;if(e===t)return;if(this._assocEvents)this._associateEvents(this,true);this._assocInstance=t;if(this._assocEvents)this._associateEvents(this);if(this._assocProperty){for(var i=0,r=this.length;i<r;i++)Amm.setProperty(this[i],this._assocProperty,this._assocInstance||this)}return true},getAssocInstance:function(){return this._assocInstance},setIndexProperty:function(t){if(!t)t=null;var e=this._indexProperty;if(e===t)return;this._indexProperty=t;var i=this.getObserveIndexProperty();if(i)this.setObserveIndexProperty(false);if(this._indexProperty){for(var r=0,n=this.length;r<n;r++){Amm.setProperty(this[r],this._indexProperty,r)}}if(i)this.setObserveIndexProperty(i);this._checkIndexPropertyWatched();return true},getIndexProperty:function(){return this._indexProperty},setObserveIndexProperty:function(t){t=!!t;var e=this._observeIndexProperty;if(e===t)return;this._observeIndexProperty=t;this._checkIndexPropertyWatched();return true},getObserveIndexProperty:function(){return this._observeIndexProperty},_checkIndexPropertyWatched:function(){var t=false;if(this._observeIndexProperty){t=!this._sorted&&this._indexProperty!==null}if(this._indexPropertyIsWatched!==t){var e=this._indexProperty+"Change";this._indexPropertyIsWatched=t;if(this._indexPropertyIsWatched){for(var i=0,r=this.length;i<r;i++){this[i].subscribe(e,this._reportItemIndexPropertyChange,this)}}else{for(var i=0,r=this.length;i<r;i++){this[i].unsubscribe(e,this._reportItemIndexPropertyChange,this)}}}},_reportItemIndexPropertyChange:function(t,e){if(this._suppressIndexEvents){return}var i=Amm.event.origin;var r=e;var n=t;if(n<0)n=0;else if(n>=this.length)n=this.length-1;if(this[r]!==i){if(this[n]===i)return;r=this.strictIndexOf(i);if(r<0)throw Error("WTF - received item indexProperty change event from item not belonging to this Collection")}if(r===n)return;this.moveItem(r,n)},setDefaults:function(t){if(t&&typeof t!=="object")throw Error("`defaults` must be an object");if(!t)t=null;var e=this._defaults;if(e===t)return;this._defaults=t;return true},getDefaults:function(){return this._defaults},setUndefaults:function(t){if(t&&typeof t!=="object")throw Error("`undefaults` must be an object");if(!t)t=null;var e=this._undefaults;if(e===t)return;this._undefaults=t;return true},getUndefaults:function(){return this._undefaults},getObservesItems:function(){return!!this._changeEvents},setChangeEvents:function(t){if(t){if(!(t instanceof Array))t=[t];else if(!t.length)t=null}else{t=null}var e=this._changeEvents;if(e===t)return;if(this._changeEvents&&t&&!Amm.Array.diff(t,this._changeEvents).length&&!Amm.Array.diff(this._changeEvents,t).length)return;if(e){for(var i=0,r=this.length;i<r;i++){this[i].unsubscribe(undefined,this._reportItemChangeEvent,this)}}if(t){var n=t.length;for(var i=0,r=this.length;i<r;i++){for(var s=0;s<n;s++){this[i].subscribe(t[s],this._reportItemChangeEvent,this)}}}this._changeEvents=t;return true},_reportItemChangeEvent:function(){var t=Amm.event.origin;if(this._itemUpdateLevel){if(Amm.Array.indexOf(t,this._itemUpdateQueue)<0){this._itemUpdateQueue.push(t)}}else{if(this._recheckUniqueness)this._performRecheckUniqueness(t);if(this._sorted){this._checkItemPosition(t)}this.outItemChange(t)}},outItemChange:function(t){return this._out("itemChange",t)},getChangeEvents:function(){return this._changeEvents},setComparison:function(t){if(this._comparison===t)return;var e=this._custComparison;var i=this._comparison;this._custComparison=t;this._onlyStrict=!(this._keyProperty||this._comparisonProperties||t);if(!this._onlyStrict){this._comparison=this._compareWithProps}else{this._comparison=null}try{this._custComparison=t;this._checkDuplicates("setComparison()",[],0,0,true,this._comparison)}catch(t){this._custComparison=e;this._comparison=i;throw t}return true},setComparisonProperties:function(t){if(t){if(!(t instanceof Array))t=[t];else if(!t.length)t=null}else{t=null}var e=this._comparisonProperties;if(e===t)return;if(e&&t&&e.length===t&&!Amm.Array.equal(e,t).length)return;var i=this._comparisonProperties;var r=this._comparison;this._onlyStrict=!(this._keyProperty||t||this._custComparison);if(this._onlyStrict){this._comparison=null}else{this._comparison=this._compareWithProps}try{this._comparisonProperties=t;this._checkDuplicates("setComparisonProperties()",[],0,0,true,this._comparison)}catch(t){this._comparisonProperties=i;this._comparison=r;throw t}return true},getComparisonProperties:function(){if(!this._comparisonProperties)return[];return this._comparisonProperties},setIgnoreExactMatches:function(t){var e=this._ignoreExactMatches;if(e===t)return;this._ignoreExactMatches=t;return true},getIgnoreExactMatches:function(){return this._ignoreExactMatches},setRecheckUniqueness:function(t){var e=this._recheckUniqueness;if(e===t)return;this._recheckUniqueness=t;return true},getRecheckUniqueness:function(){return this._recheckUniqueness},_implCompareWithProps:function(t,e){var i,r,n;if(t===e)return 0;if(this._comparisonProperties){for(var s=0,a=this._comparisonProperties.length;s<a;s++){i=this._comparisonProperties[s];r=Amm.getProperty(t,i);n=Amm.getProperty(e,i);if(r!==n)return-1}}if(this._keyProperty){r=Amm.getProperty(t,this._keyProperty);if(typeof r==="object")throw this._keyPropertyError(t,r);if(r!==undefined&&r!==null){n=Amm.getProperty(e,this._keyProperty);if(n!==undefined&&n!==null){if(typeof n==="object")throw this._keyPropertyError(e,n);if(""+r!==""+n)return-1}}}if(this._custComparison)return this._custComparison(t,e);return 0},_keyPropertyError:function(t,e,i){if(i===undefined)i=this._keyProperty;return new Error("Invalid value of keyProperty '"+this._keyProperty+"': object value isn't allowed")},setSortProperties:function(t){if(t){if(!(t instanceof Array))t=[t];else if(!t.length)t=null}else{t=null}var e=this._sortProperties;if(e===t)return;if(e&&t&&Amm.Array.equal(e,t))return;this._sortProperties=t;this._sorted=!!(this._sortFn||this._sortProperties||this._sorter);this._checkIndexPropertyWatched();if(this._sorted){this._sort()}return true},getSortProperties:function(){if(!this._sortProperties)return[];return this._sortProperties},setSortReverse:function(t){t=!!t;var e=this._sortReverse;if(e===t)return;this._sortReverse=t;if(this._sorted)this._sort();return true},getSortReverse:function(){return this._sortReverse},_implSortWithProps:function(t,e){if(t===e)return 0;var i=this._sortReverse?-1:1;if(this._sortProperties){for(var r=0,n=this._sortProperties.length;r<n;r++){var s=this._sortProperties[r];var a=Amm.getProperty(t,s);var o=Amm.getProperty(e,s);if(a<o)return-1*i;else if(a>o)return 1*i}}if(this._sortFn)return this.sortFn(t,e)*i},setSortFn:function(t){if(t){if(typeof t!=="function")throw Error("sortFn must be a function or a null")}else{t=null}var e=this._sortFn;if(e===t)return;this._sortFn=t;this._sorted=!!(this._sortFn||this._sortProperties||this._sorter);this._checkIndexPropertyWatched();if(this._sorted)this._sort();return true},getSortFn:function(){return this._sortFn},setSorter:function(t){var e=false;if(t){if(typeof t==="object"&&!t["Amm.Sorter"]){t=Amm.constructInstance(t,"Amm.Sorter");e=true}}else{t=null}var i=this._sorter;if(i===t)return;if(this._sorter){if(this._sorterIsAggregate)this._sorter.cleanup();else this._subSorter(true)}this._sorterIsAggregate=e;this._sorter=t;if(this._sorter){this._subSorter()}this._sorted=!!(this._sortFn||this._sortProperties||this._sorter);this._checkIndexPropertyWatched();if(this._sorted){this._sort()}return true},_subSorter:function(t){var e=t?"unsubscribe":"subscribe";this._sorter[e]("matchesChange",this._handleSorterNeedSort,this);this._sorter[e]("needSort",this._handleSorterNeedSort,this);this._sorter.setObservedObjects(t?[]:this.getItems())},_handleSorterNeedSort:function(){if(this._lockSort)return;if(this._updateLevel){this._needSort=true;return}this._sort()},getSorter:function(){return this._sorter},sort:function(t){this._needSort=false;if(t instanceof Array){var i={_sortReverse:this._sortReverse,_sortWithProps:this._implSortWithProps,_sortProperties:t,_sortFn:null};var e=function(t,e){return i._sortWithProps(t,e)};var r=this.sort(e);return r}if(this._sorter||this._sortFn){if(t)throw Error("Cannot sort(fn) when `sortFn` or `sorter` is set; use sort() with no parameters");return this._sort()}if(this._sortProperties){throw Error("Cannot sort() when `sortProperties` is set")}var n={},s;if(this._indexProperty)s=this.getItems();var r;if(this._sorter)r=Amm.Array.prototype.sort.call(this,this._sorter.getCompareClosureFn(),n);else r=Amm.Array.prototype.sort.call(this,t,n);if(this._indexProperty&&n.changed&&s)this._reportIndexes(s);return r},_doEndUpdate:function(){if(this._needSort)this._sort();if(this._indexProperty)this._reportIndexes(this._preUpdateItems);Amm.Array.prototype._doEndUpdate.call(this);if(this._byKeyChange){this._byKeyChange=false;this.outByKeyChange()}},_reportIndexes:function(t,e,i){this._suppressIndexEvents++;var r=i||this.length,e=e||0,n;try{for(var s=e;s<r;s++){if(!t||this[s]!==t[s]){Amm.setProperty(this[s],this._indexProperty,s)}}}catch(n){this._suppressIndexEvents--;throw n}this._suppressIndexEvents--},_sort:function(){this._needSort=false;if(!(this._sortFn||this._sortProperties||this._sorter)){throw Error("WTF - call to _sort() w/o _sorter, _sortFn or _sortProperties")}var t={},e;if(this._indexProperty)e=this.getItems();Amm.Array.prototype.sort.call(this,this._sorter?this._sorter.getCompareClosureFn():this._sortWithProps,t);if(this._indexProperty&&t.changed&&e)this._reportIndexes(e);return t.changed},_locateItemIndexInSortedArray:function(t){if(!this.length)return 0;if(this._sorter){this._lockSort++;this._sorter.observeObject(t);this._lockSort--}var e=Amm.Collection.binSearch(this,t,this._sorter?this._sorter.getCompareClosureFn():this._sortWithProps);return e[0]},_locateManyItemIndexesInSortedArray:function(t){var e,i=t.length,r=this._sorter?this._sorter.getCompareClosureFn():this._sortWithProps;if(this._sorter){this._lockSort++;for(e=0;e<i;e++){this._sorter.observeObject(t[e])}this._lockSort--}t.sort(r);var n=0,s=[];for(e=0;e<i;e++){n=Amm.Collection.binSearch(this,t[e],r,n)[0];if(n<0)n=0;s.push(n+e)}return s},getAllowUpdate:function(){return this._allowUpdate},setUpdateProperties:function(t){if(t){if(!(t instanceof Array))t=[t];else if(!t.length)t=null}else{t=null}var e=this._updateProperties;if(e===t)return;this._updateProperties=t;this._allowUpdate=this._updateProperties||this._updateFn;return true},getUpdateProperties:function(){if(!this._updateProperties)return[];return this._updateProperties},_updateItem:function(t,e){this._beginItemsUpdate();try{if(this._updateProperties&&t!==e){for(var i=0,r=this._updateProperties.length;i<r;i++){var n=this._updateProperties[i];Amm.setProperty(t,n,Amm.getProperty(e,n))}}if(this._updateFn)this._updateFn(t,e);else{if(t===e){console.warn("updateFn not set; exactly matching items won't be update()'d)")}}}catch(t){this._endItemsUpdate();throw t}this._endItemsUpdate()},_beginItemsUpdate:function(){this._itemUpdateLevel++},_endItemsUpdate:function(){this._itemUpdateLevel--;if(this._endItemsUpdateLock)return;this._endItemsUpdateLock=true;if(this._recheckUniqueness&&this._itemUpdateQueue.length)this._performRecheckUniqueness(this._itemUpdateQueue,true);if(!this._itemUpdateLevel&&this._itemUpdateQueue.length){for(var t=0;t<this._itemUpdateQueue.length;t++){this.outItemChange(this._itemUpdateQueue[t])}this._itemUpdateQueue=[]}this._endItemsUpdateLock=false;if(this._byKeyChange){this._byKeyChange=false;this.outByKeyChange()}if(this._sorted)this._sort()},_checkItemPosition:function(t,e){if(e===undefined){if(this._indexProperty){e=Amm.getProperty(t,this._indexProperty);if(typeof e==="number"&&this[e]!==t)e=this.strictIndexOf(t)}else{e=this.strictIndexOf(t)}if(e<0)throw Error("WTF: `item` not found in this")}if(this[e]!==t)throw Error("WTF: this[`index`] !== `item`");var i=undefined,r=false,n,s;if(e>0&&this._sortWithProps(this[e-1],t)>0){var a=Amm.Collection.binSearch(this,t,this._sortWithProps,0,e-1);if(a[0]+1>=e){r=true}else{i=n=a[0]+1;s=e}}if(e<this.length-1&&this._sortWithProps(t,this[e+1])>0){var a=Amm.Collection.binSearch(this,t,this._sortWithProps,e+1,this.length-1);if(a[0]+1<=e){r=true}else{i=s=a[0]+1;n=e}}if(r)this._sort();else if(i!==undefined){Amm.Array.prototype.moveItem.call(this,e,i);if(s>=this.length)s=this.length-1;if(this._indexProperty)this._reportIndexes(null,n,s)}},_performRecheckUniqueness:function(t,e){if(!this._custComparison&&!this._comparisonProperties){console.warn("having setRecheckUniqueness(true) w/o prior setComparsion()"+" or setComparisonProperies() makes no sense - refusing to re-check");return}var i;if(!e)i=[t];else i=t;for(var r=0,n=i.length;r<n;r++){var s=-1,a=[],o=null;do{s=this.indexOf(i[r],s+1);if(s>=0){if(i[r]!==this[s]){a.push(s)}else{o=s}}}while(s>=0);if(o===null)console.warn("Item that was changed is no more in the collection");if(!a.length)continue;if(!o&&a.length===1){console.warn("Item that was changed has a duplicate,"+" but is no more in the collection."+" Not throwing the exception since the collection"+" is still unique.")}else{throw Error("After the change of this["+o+"],"+" duplicate(s) appeared: this["+a.join("], this[")+"]")}}},setUpdateFn:function(t){if(t&&typeof t!=="function")throw Error("updateFn must be a function");var e=this._updateFn;if(e===t)return;this._updateFn=t;this._allowUpdate=this._updateProperties||this._updateFn;return true},getUpdateFn:function(){return this._updateFn},setCleanupOnDissociate:function(t){t=!!t;var e=this._cleanupOnDissociate;if(e===t)return;this._cleanupOnDissociate=t;return true},getCleanupOnDissociate:function(){return this._cleanupOnDissociate},setAllowAdd:function(t){t=!!t;var e=this._allowAdd;if(e===t)return;this._allowAdd=t;return true},getAllowAdd:function(){return this._allowAdd},setAllowDelete:function(t){t=!!t;var e=this._allowDelete;if(e===t)return;this._allowDelete=t;return true},getAllowDelete:function(){return this._allowDelete},setAllowChangeOrder:function(t){t=!!t;var e=this._allowChangeOrder;if(e===t)return;this._allowChangeOrder=t;return true},getAllowChangeOrder:function(){return this._allowChangeOrder},cleanup:function(){var t=this._allowDelete;if(!t)this.setAllowDelete(true);if(this._sorterIsAggregate){this._sorter.cleanup();this._sorter=null}Amm.Array.prototype.cleanup.call(this);if(!t)this.setAllowDelete(t)},setAssocEvents:function(t){var e=null;if(t){if(typeof t==="object"){e=[];for(var i in t)if(t.hasOwnProperty(i)){e.push([i,t[i]])}}else{throw Error("`assocEvents` must be an object")}}if(this._assocEvents&&this.length)this._associateEvents(this,true);this._assocEvents=e;if(t)this._associateEvents(this);return true},_associateEvents:function(t,e){if(!this._assocEvents)return;if(!t.length)return;var i=this._assocInstance||this;var r=this._assocEvents.length;var n=e?"unsubscribe":"subscribe";for(var s=0,a=t.length;s<a;s++){for(var o=0;o<r;o++){if(e||t[s].hasEvent(this._assocEvents[o][0])){t[s][n](this._assocEvents[o][0],this._assocEvents[o][1],i)}}}},getAssocEvents:function(){if(!this._assocEvents)return{};var t={};for(var e=0,i=this._assocEvents.length;e<i;e++){t[this._assocEvents[e][0]]=this._assocEvents[e][1]}return t},setKeyProperty:function(t){if(!t)t=null;var e=this._keyProperty;if(e===t)return;var i=this._keyProperty;var r=this._comparison;this._onlyStrict=!(t||this._comparisonProperties||this._custComparison);if(this._onlyStrict){this._comparison=null}else{this._comparison=this._compareWithProps}try{this._keyProperty=t;this._checkDuplicates("setKeyProperty()",[],0,0,true,this._comparison)}catch(t){this._keyProperty=i;this._comparison=r;throw t}if(e)this._unobserveKeyProperty();this._keyProperty=t;this._observeKeyProperty();this._rebuildKeys();this.outKeyPropertyChange(t,e);return true},_unobserveKeyProperty:function(){var t=this._keyProperty+"Change";for(var e=0,i=this.length;e<i;e++){this[e].unsubscribe(t,this._handleKeyChange,this)}},_observeKeyProperty:function(){var t=this._keyProperty+"Change";for(var e=0,i=this.length;e<i;e++){this[e].subscribe(t,this._handleKeyChange,this)}},_lockKeyValueChange:false,_revertKeyValue:function(t,e){var i;i=this._lockKeyValueChange;this._lockKeyValueChange=t;try{Amm.setProperty(t,this._keyProperty,e)}catch(t){this._lockKeyValueChange=i;throw t}this._lockKeyValueChange=i},_handleKeyChange:function(t,e){var i=Amm.event.origin,r;if(this._lockKeyValueChange&&this._lockKeyValueChange===i)return;if(typeof t==="object"){this._revertKeyValue(i,e);throw this._keyPropertyError(i,t)}if(t!==null&&t!==undefined){if(this.k[t]&&this.k[t]!==i){this._revertKeyValue(i,e);throw Error("Duplicate value of keyProperty '"+this._keyProperty+"': object with key '"+t+"' already exists in the collection")}this.k[t]=i}if(e!==undefined&&e!==null){if(this.k[e]!==i){this._rebuildKeys();return}else{delete this.k[e]}}this.outByKeyChange()},_rebuildKeys:function(){this.k={};for(var t=0,e=this.length;t<e;t++){var i=Amm.getProperty(this[t],this._keyProperty);if(i===null||i===undefined)continue;if(typeof i==="object")throw this._keyPropertyError(this[t],i);this.k[i]=this[t]}this.outByKeyChange()},getKeyProperty:function(){return this._keyProperty},outKeyPropertyChange:function(t,e){this._out("keyPropertyChange",t,e)},getByKey:function(t){return this.k[t]},setByKey:function(t){console.warn("byKey is read-only property")},outByKeyChange:function(){if(this._updateLevel||this._itemUpdateLevel||this._byKeyChange){this._byKeyChange=true;return}this._out("byKeyChange")}};Amm.extend(Amm.Collection,Amm.Array);Amm.Selection=function(t){Amm.Collection.call(this,t)};Amm.Selection.ERR_NOT_IN_OBSERVED_COLLECTION="Not in observed collection.";Amm.Selection.prototype={"Amm.Selection":"__CLASS__",_multiple:true,_valueProperty:null,_selectedProperty:null,_sameOrder:false,_collection:null,_unselectOnItemValueChange:false,_cacheValue:true,_value:undefined,_suppressValueChangeEvent:0,_selfSubscribed:false,setCollection:function(t){var e=this._collection;var i;if(e===t)return;if(e){this._unobserveCollection()}this._collection=t;if(this._selectedProperty){i=this._findSelectedItems()}else{i=[]}if(!this._multiple)i.splice(1,i.length);this.setItems(i);this.outCollectionChange(t,e);if(t){this._observeCollection()}return true},getCollection:function(){return this._collection},outCollectionChange:function(t,e){this._out("collectionChange",t,e)},setMultiple:function(t){t=!!t;var e=this._multiple;if(e===t)return;var i=this._value===undefined?this.getValue(true):this._value;this._multiple=t;if(!t&&this.length>1){this._suppressValueChangeEvent++;this.splice(1,this.length-1);this._suppressValueChangeEvent--}var r=this.getValue(true);if(this._valueProperty)this._value=r;if(this._subscribers.valueChange){this.outValueChange(r,i)}this.outMultipleChange(t,e);return true},getMultiple:function(){return this._multiple},outMultipleChange:function(t,e){this._out("multipleChange",t,e)},setValue:function(t){this.beginUpdate();var e;if(t===undefined||t===null){e=true;if(this._multiple)t=[]}else{if(t instanceof Array||t["Amm.Array"]){if(this._findItemsWithValue([t]).length){t=[t]}else{e=!t.length}}else{t=[t]}}var i;if(e)i=[];else i=this._findItemsWithValue(t);this.setItems(i);this.endUpdate()},getValue:function(t){if(!this.length)return this._multiple?[]:null;var e;if(!this._valueProperty){e=this.getItems();if(!this._multiple){e=e[0]}}else{if(!this._cacheValue||t||this._value===undefined){e=this._value=this._collectValueProperty(this,true)}else{e=this._value}}return e},outValueChange:function(t,e){if(this._suppressValueChangeEvent||this._updateLevel)return;this._out("valueChange",t,e)},setValueProperty:function(t){var e=this._valueProperty;if(e===t)return;if(this._collection&&e)this._unsubscribeCollectionItems(this._collection,false,true);this._valueProperty=t;this.clearItems();if(!this._valueProperty)this._value=undefined;if(this._collection&&t)this._subscribeCollectionItems(this._collection,false,true);return true},getValueProperty:function(){return this._valueProperty},setCacheValue:function(t){t=!!t;var e=this._cacheValue;if(e===t)return;this._cacheValue=t;return true},getCacheValue:function(){return this._cacheValue},setUnselectOnItemValueChange:function(t){var e=this._unselectOnItemValueChange;if(e===t)return;this._unselectOnItemValueChange=t;return true},getUnselectOnItemValueChange:function(){return this._unselectOnItemValueChange},setSelectedProperty:function(t){var e=this._selectedProperty;if(e===t)return;if(e&&this._collection)this._unsubscribeCollectionItems(this._collection,true);this._selectedProperty=t;if(t&&this._collection){if(!this.length)this.setItems(this._findSelectedItems());else this._setItemsSelectedProperty();this._subscribeCollectionItems(this._collection,true)}return true},getSelectedProperty:function(){return this._selectedProperty},setSameOrder:function(t){t=!!t;var e=this._sameOrder;if(e===t)return;this._sameOrder=t;if(this._sameOrder){this.setSortProperties(null);this.setSortFn(null);if(this._collection){this._collection.subscribe("reorderItems",this._handleCollectionReorderItems,this);this._maintainOrder()}}else{if(this._collection){this._collection.unsubscribe("reorderItems",this._handleCollectionReorderItems,this)}}return true},getSameOrder:function(){return this._sameOrder},sort:function(t){if(this._sameOrder)Error("Refusing to sort() when `sameOrder` === true");return Amm.Collection.prototype.sort.call(this,t)},_collectValueProperty:function(t,e,i){t=t||this;var r=[],n=t.length;for(var s=0;s<n;s++){var a=t[s];if(a!==i){var o=Amm.getProperty(a,this._valueProperty);if(o!==undefined&&o!==null)r.push(o)}}if(e&&!this._multiple)r=r.length?r[0]:null;return r},_findItemsWithValue:function(t){if(!this._multiple&&!(t instanceof Array)){if(t===undefined||t===null)t=[];else t=[t]}if(!this._collection||!t.length)return[];if(!this._valueProperty)return this._collection.intersect(t,true);var e=[];for(var i=0,r=this._collection.length;i<r;i++){var n=this._collection[i],s=Amm.getProperty(n,this._valueProperty);if(Amm.Array.indexOf(s,t)>=0)e.push(n)}return e},_findSelectedItems:function(){if(!this._collection)return[];var t=[];for(var e=0,i=this._collection.length;e<i;e++){var r=this._collection[e],n=Amm.getProperty(r,this._selectedProperty);if(n)t.push(r)}return t},_setItemsSelectedProperty:function(){for(var t=0,e=this._collection.length;t<e;t++){Amm.setProperty(this._collection[t],this._selectedProperty,this.hasItem(this._collection[t]))}},_handleCollectionSpliceItems:function(t,e,i){var r=Amm.Array.symmetricDiff(e,i);var n=Amm.Array.symmetricDiff(i,e);this._unsubscribeCollectionItems(r);this._subscribeCollectionItems(n);var s=this.intersect(r,true);var a=Amm.Array.diff(n,this);if(!a.length&&!s.length)return;var o=a.length&&(this._selectedProperty||this._valueProperty&&this.length&&this._multiple);this.beginUpdate();for(var l=0,h=s.length;l<h;l++)this.reject(s[l],false);if(o){var u=[];var f=this._valueProperty?this.getValue():null;for(var l=0,h=a.length;l<h;l++){var c=a[l];if(this._selectedProperty&&Amm.getProperty(c,this._selectedProperty))u.push(c);else if(this._valueProperty&&f&&Amm.Array.indexOf(Amm.getProperty(c,this._valueProperty),f)>=0)u.push(c)}if(u.length){this.acceptMany(u);if(this._sameOrder)this._maintainOrder(true)}}this.endUpdate()},_handleCollectionReorderItems:function(t,e,i){if(!this.length)return;var r=this.getItems();var n=Amm.Array.findDuplicates(r.concat(this._collection.slice(t,t+e)),true,undefined,this.length);if(n.length){this._maintainOrder()}},_maintainOrder:function(t){if(!this._sameOrder||!this.length)return;var e=this.getItems(),i=this._collection.intersect(e,true);var r=null,n=null;if(e.length!==i.length){console.warn("We have problem: it turned some elements disappeared from `collection` when only order might change");this.setItems(i);return}for(var s=0,a=e.length;s<a;s++){if(e[s]!==i[s]){if(r===null)r=s;n=s;this[s]=i[s]}}if(r!==null&&!t){if(this._indexProperty)this._reportIndexes(e,r,n+1);if(!this._updateLevel)this.outReorderItems(r,n-r+1,e.slice(r,n+1))}},_observeCollection:function(){this._collection.subscribe("spliceItems",this._handleCollectionSpliceItems,this);if(this._sameOrder)this._collection.subscribe("reorderItems",this._handleCollectionReorderItems,this);this._subscribeCollectionItems(this._collection)},_unobserveCollection:function(){this._collection.unsubscribe("spliceItems",this._handleCollectionSpliceItems,this);if(this._sameOrder)this._collection.unsubscribe("reorderItems",this._handleCollectionReorderItems,this);this._unsubscribeCollectionItems(this._collection)},_subscribeCollectionItems:function(t,e,i,r){if(!this._valueProperty)e=true;var n,s,a;a=r?"unsubscribe":"subscribe";if(!this._selectedProperty)i=true;if(e&&i)return;if(!e)n=this._valueProperty+"Change";if(!i)s=this._selectedProperty+"Change";for(var o=0,l=t.length;o<l;o++){var h=t[o];if(!h[a])continue;if(r||h.hasEvent){if(n&&(r||h.hasEvent(n))){h[a](n,this._handleItemValuePropertyChange,this)}if(s&&(r||h.hasEvent(s)))h[a](s,this._handleItemSelectedPropertyChange,this)}}},canAccept:function(t,e,i){i=i||{};if(!this._collection||!this._collection.hasItem(t)){i.error=Amm.Selection.ERR_NOT_IN_OBSERVED_COLLECTION;return false}return Amm.Collection.prototype.canAccept.call(this,t,e,i)},_unsubscribeCollectionItems:function(t,e,i){return this._subscribeCollectionItems(t,e,i,true)},_handleItemValuePropertyChange:function(t,e){var i=Amm.event.origin;var r=this.hasItem(i);var n=this._value;var s=Amm.Array.indexOf(t,this._collectValueProperty(this,false,i))>=0;if(s&&!r){this.accept(i)}else if(!s&&r){if(this._unselectOnItemValueChange){this.reject(i)}else{this._value=this._collectValueProperty(this,true);if(this._valueProperty&&this._subscribers.valueChange){this.outValueChange(this._value,n)}}}},_handleItemSelectedPropertyChange:function(t,e){this.beginUpdate();var i=Amm.event.origin;var r=this.hasItem(i);if(r&&!t){this.reject(i);this.endUpdate();return}else if(!r&&t){if(this._multiple)this.accept(i);else this.setItems([i])}this.endUpdate()},_subscribeFirst_valueChange:function(){if(this._valueProperty)this._value=this._collectValueProperty(this.getItems(),true);this._selfSubscribed=true;this.subscribe("itemsChange",this._handleSelfItemsChange,this)},_unsubscribeLast_valueChange:function(){this._selfSubscribed=false;this.unsubscribe("itemsChange",this._handleSelfItemsChange,this)},_handleSelfItemsChange:function(t,e){var i,r;if(!this._valueProperty){if(this._multiple){r=t;i=e}else{i=e[0]||null;r=t[0]||null}}else{if(this._value!==undefined){i=this._value}else{i=this._collectValueProperty(e,true)}this._value=r=this._collectValueProperty(t,true)}this.outValueChange(r,i)},_associate:function(t,e,i){var r;r=Amm.Collection.prototype._associate.call(this,t,e,i);if(!this._selfSubscribed)this._value=undefined;if(this._selectedProperty){Amm.setProperty(t,this._selectedProperty,true)}return r},_dissociate:function(t){var e;e=Amm.Collection.prototype._dissociate.call(this,t);if(!this._selfSubscribed)this._value=undefined;if(this._selectedProperty){Amm.setProperty(t,this._selectedProperty,false)}return e},_oldValue:null,_doBeginUpdate:function(){Amm.Collection.prototype._doBeginUpdate.call(this);this._oldValue=this.getValue();if(this._oldValue instanceof Array)this._oldValue=[].concat(this._oldValue)},_doEndUpdate:function(){this._suppressValueChangeEvent++;Amm.Collection.prototype._doEndUpdate.call(this);this._suppressValueChangeEvent--;if(this._updateLevel)return;var t=this.getValue(),e=this._oldValue;if(t instanceof Array&&e instanceof Array&&Amm.Array.equal(t,e))return;if(t===e)return;this.outValueChange(t,e)}};Amm.extend(Amm.Selection,Amm.Collection);Amm.Remote={};Amm.Decorator=function(t){if(t&&this["Amm.Decorator"]==="__CLASS__"&&t.decorate&&typeof t.decorate==="function"){this.decorate=t.decorate;delete t.decorate}Amm.init(this,t)};Amm.Decorator.construct=function(t,e,i,r){if(typeof t==="function"){t={decorate:t}}return Amm.constructInstance(t,"Amm.Decorator",e,i,r)};Amm.Decorator.prototype={"Amm.Decorator":"__CLASS__",decorate:function(t){return t}};Amm.Decorator.cr=function(t){if(t&&t["Amm.Decorator"])return t;return Amm.Decorator.construct(t)};Amm.Decorator.d=function(t,e,i){if(!i)i="decorator";if(!e)e=this;var r=e[i];if(!r)return t;if(!r["Amm.Decorator"])r=e[i]=Amm.Decorator.construct(r);return r.decorate(t)};Amm.Translator=function(t){Amm.init(this,t)};Amm.Translator.prototype={"Amm.Translator":"__CLASS__",lastError:null,errInValue:null,errOutValue:null,reverseMode:null,field:undefined,trimInStrings:false,decorateBeforeValidate:false,_inDecorator:null,_outDecorator:null,_inValidator:null,_outValidator:null,_implTranslate:function(t,e,i,r,n,s,a){this.lastError=null;if(!(r&&typeof r==="object"))r={};r.error=null;var o;if(n){if(this.trimInStrings&&typeof t==="string"){t=Amm.Util.trim(t)}}if(a&&this.decorateBeforeValidate){try{t=a.decorate(t)}catch(t){r.error=this.lastError=t;return e}}if(s){this.lastError=s.getError(t,this.field);if(this.lastError){r.error=this.lastError;return e}}if(a&&!this.decorateBeforeValidate){try{t=a.decorate(t)}catch(t){r.error=this.lastError=t;return e}}try{o=this[i](t)}catch(t){this.lastError=t}if(this.lastError){o=e}r.error=this.lastError;return o},decorate:function(t){return this.translateIn(t)},translateIn:function(t,e){if(this.reverseMode){return this._implTranslate(t,this.errOutValue,"_doTranslateOut",e,false,this._outValidator,this._outDecorator)}return this._implTranslate(t,this.errInValue,"_doTranslateIn",e,true,this._inValidator,this._inDecorator)},translateOut:function(t,e){if(this.reverseMode){return this._implTranslate(t,this.errInValue,"_doTranslateIn",e,false,this._inValidator,this._inDecorator)}return this._implTranslate(t,this.errOutValue,"_doTranslateOut",e,false,this._outValidator,this._outDecorator)},_doTranslateIn:function(t){return t},_doTranslateOut:function(t){return t},setInDecorator:function(t){var e=this._inDecorator;if(e===t)return;if(t)t=Amm.Decorator.construct(t,"Amm.Decorator");this._inDecorator=t;return true},getInDecorator:function(){return this._inDecorator},setOutDecorator:function(t){var e=this._outDecorator;if(e===t)return;if(t)t=Amm.Decorator.construct(t,"Amm.Decorator");this._outDecorator=t;return true},getOutDecorator:function(){return this._outDecorator},setInValidator:function(t){var e=this._inValidator;if(e===t)return;if(t)t=Amm.Validator.construct(t);this._inValidator=t;return true},getInValidator:function(){return this._inValidator},setOutValidator:function(t){var e=this._outValidator;if(e===t)return;if(t)t=Amm.Validator.construct(t);this._outValidator=t;return true},getOutValidator:function(){return this._outValidator}};Amm.extend(Amm.Translator,Amm.Decorator);Amm.Translator.Bool=function(t){Amm.Translator.call(this,t)};Amm.Translator.Bool.prototype={"Amm.Translator.Bool":"__CLASS__",trueValue:"lang.Amm.True",falseValue:"lang.Amm.False",errorMsg:"lang.Amm.Translator.Bool.msg",caseSensitive:false,trimInStrings:true,guess:true,defaultValue:false,setStrictMode:function(t){if(t){this.caseSensitive=true;this.trimInStrings=false;this.defaultValue=undefined;this.guess=false}else{this.caseSensitive=false;this.trimInStrings=true;this.defaultValue=false;this.guess=true}},getStrictMode:function(){if(this.caseSensitive&&!this.trimInStrings&&this.defaultValue===undefined&&!this.guess){return true}else if(!this.caseSensitive&&this.trimInStrings&&this.defaultValue!==undefined&&this.guess){return false}return undefined},_doTranslateOut:function(t){return Amm.translate(t?this.trueValue:this.falseValue)},_doTranslateIn:function(t){var e;if(this._cmp(t,Amm.translate(this.trueValue)))e=true;else if(this._cmp(t,Amm.translate(this.falseValue)))e=false;else if(this.guess){if(t==="0")e=false;else e=!!t}else if(this.defaultValue!==undefined)e=this.defaultValue;else this.lastError=Amm.translate(this.errorMsg,"%value",t);return e},_cmp:function(t,e){if(!this.caseSensitive){t=(""+t).toLowerCase();e=(""+e).toLowerCase()}return t===e}};Amm.extend(Amm.Translator.Bool,Amm.Translator);Amm.defineLangStrings({"lang.Amm.True":"True","lang.Amm.False":"False","lang.Amm.Translator.Bool.msg":"'%value' isn't allowed Boolean value"});Amm.Translator.RequiredMark=function(t){Amm.Translator.Bool.call(this,t)};Amm.Translator.RequiredMark.prototype={"Amm.Translator.RequiredMark":"__CLASS__",trueValue:'<span class="required">*</span>',falseValue:""};Amm.extend(Amm.Translator.RequiredMark,Amm.Translator.Bool);Amm.Translator.List=function(t){Amm.Translator.call(this,t)};Amm.Translator.List.prototype={"Amm.Translator.List":"__CLASS__",_enclosureElement:"<ul></ul>",_itemElement:"<li></li>",emptyOutValue:null,itemSelector:null,_cachedItemSelector:null,allowHTML:true,strict:false,msgInvalidInValueStrict:"Amm.Translator.List.msgInvalidInValueStrict",msgInvalidInValueNonStrict:"Amm.Translator.List.msgInvalidInValueNonStrict",msgInvalidOutValue:"Amm.Translator.List.msgInvalidOutValue",_cacheValues:null,_lastInValue:null,_lastOutValue:null,setCacheValues:function(t){var e=this._cacheValues;if(e===t)return;this._cacheValues=t;return true},getCacheValues:function(){return this._cacheValues},setItemElement:function(t){var e=this._itemElement;if(e===t)return;if(!t)Error("itemElement is required");if(typeof t!=="string")Error("itemElement must be a string");if(!t.match(/^<.*>$/))Error("itemElement must be a jQuery-compatible HTML element definition");this._itemElement=t;this._cachedItemSelector=null;return true},getItemElement:function(){return this._itemElement},setEnclosureElement:function(t){var e=this._enclosureElement;if(e===t)return;if(t){if(typeof t!=="string")Error("enclosureElement must be a string");if(!t.match(/^<.*>$/))Error("enclosureElement must be a jQuery-compatible HTML element definition")}else{t=""}this._enclosureElement=t;return true},getEnclosureElement:function(){return this._enclosureElement},_doTranslateOut:function(t){if(!this.strict){if(!t)t=[];else if(typeof t==="string")t=[t]}if(!(t instanceof Array||t["Amm.Array"])){var e=this.strict?this.msgInvalidInValueStrict:this.msgInvalidInValueNonStrict;this.lastError=Amm._msg(e,"%type",Amm.describeType(t));return}if(!t.length&&this.emptyOutValue!==null)return this.emptyOutValue;var i=[];if(!this._itemElement)throw Error("itemElement not set");var r="",n;for(var s=0,a=t.length;s<a;s++){var n=jQuery(this._itemElement);if(this.allowHTML)n.html(t[s]);else n.text(t[s]);if(!this._enclosureElement)r+=n[0].outerHTML;else i.push(n)}if(n&&n[0]&&!this._cachedItemSelector&&!this.itemSelector){this._extractItemSelector(n[0])}if(this._enclosureElement)return jQuery(this._enclosureElement).append(i)[0].outerHTML;else return r},_doTranslateIn:function(t){if(t===this.emptyOutValue)return[];if(!t)return[];if(!(t&&(t.jquery||t.nodeName||typeof t==="string"))){this.lastError=Amm._msg(this.msgInvalidOutValue,"%type",Amm.describeType(t))}var e=this.itemSelector||this._cachedItemSelector;if(!e){var i=jQuery(this._itemElement);e=this._extractItemSelector(i[0])}var r=[],n=this.allowHTML;var s=jQuery(t).find(e).addBack(e).each(function(t,e){r.push(n?jQuery(e).html():jQuery(e).text())});return r},_extractItemSelector:function(t){var e;this._cachedItemSelector=t.tagName.toLowerCase();if(e=t.getAttribute("class"))this._cachedItemSelector+="."+e;if(e=t.getAttribute("id"))this._cachedItemSelector+="#"+e;return this._cachedItemSelector}};Amm.extend(Amm.Translator.List,Amm.Translator);Amm.defineLangStrings({"Amm.Translator.List.msgInvalidInValueStrict":"unsupported external value: %type provided, Array or Amm.Array expected","Amm.Translator.List.msgInvalidInValueNonStrict":"unsupported external value: %type provided, Array, Amm.Array, string or FALSEable value expected","Amm.Translator.List.msgInvalidOutValue":"internal value must be either string or FALSEable value or jQuery result or DOM Element, but %type was provided"});Amm.Translator.Errors=function(t){Amm.Translator.List.call(this,t)};Amm.Translator.Errors.prototype={"Amm.Translator.Errors":"__CLASS__",_enclosureElement:'<ul class="errors"></ul>',_itemElement:'<li class="error"></li>',emptyOutValue:"",itemSelector:".error",strict:false,allowHTML:false};Amm.extend(Amm.Translator.Errors,Amm.Translator.List);Amm.Decorator.Loop=function(t){Amm.Decorator.call(this,t)};Amm.Decorator.Loop.prototype={"Amm.Decorator.Loop":"__CLASS__",decorator:null,decorate:function(t){if(!this.decorator||!(t&&typeof t==="object"))return t;var e,i;if(t instanceof Array){e=[];for(i=0;i<t.length;i++){e.push(Amm.Decorator.d(t[i],this,"decorator"))}return e}e={};for(i in t)if(t.hasOwnProperty(i)){e[i]=Amm.Decorator.d(t[i],this,"decorator")}return e}};Amm.extend(Amm.Decorator.Loop,Amm.Decorator);Amm.Decorator.WrapObject=function(t){Amm.Decorator.call(this,t)};Amm.Decorator.WrapObject.prototype={"Amm.Decorator.WrapObject":"__CLASS__",decorate:function(t){var e;if(!(t&&typeof t==="object"))return t;if(Amm.getClass(t))return t;if(t instanceof Array){var i=[],r=true;for(var n=0,s=t.length;n<s;n++){if(!(t[n]&&typeof t[n]==="object"))r=false;i.push(this.wrapObject(t[n]))}if(r)e=new Amm.Collection(i);else e=new Amm.Array(i);return e}e=new Amm.WithEvents;for(var n in t)if(t.hasOwnProperty(n)){var a=t[n];if(a&&typeof a==="object"){a=this.wrapObject(a)}Amm.createProperty(e,n,a,function(t,e,i){if(t&&typeof t==="object"){this[i]=this.wrapObject(t)}},true)}return e}};Amm.extend(Amm.Decorator.WrapObject,Amm.Decorator);Amm.Decorator.Data=function(t){Amm.Decorator.call(this,t)};Amm.Decorator.Data.prototype={"Amm.Decorator.Data":"__CLASS__",_filter:null,_conditions:null,setConditions:function(t){if(!t&&typeof t==="object"){throw Error("`conditions` must be a non-null object")}if(!Amm.keys(t).length){t=null}if(t&&this._actions)this._checkActions(t,this._actions);this._conditions=t;if(this._filter){this._filter.cleanup();this._filter=null}return true},getConditions:function(){return this._conditions},_actions:null,setActions:function(t){if(!t&&typeof t==="object")throw Error("`actions` must be a non-null object");if(!Amm.keys(t).length){this._actions=null;return}if(this._conditions&&t)this._checkActions(this._conditions,t);this._actions=t;return true},_checkActions:function(t,e){var i=Amm.keys(t);var r=Amm.keys(e);var n=Amm.Array.diff(i,r);if(n.length)throw Error("Mismatch in `critera` and `action` keys: some conditions ('"+n.join("', '")+"') don't have corresponding actions");var s=Amm.Array.diff(r,i.concat(["default"]));if(s.length)throw Error("Mismatch in `critera` and `action` keys: some actions ('"+n.join("', '")+"') don't have corresponding conditions")},getActions:function(){return this._actions},decorate:function(t){if(!this._conditions||!this._actions)return t;if(!this._filter){var e=[],i;for(var r in this._conditions)if(this._conditions.hasOwnProperty(r)){i=this._conditions[r];if(typeof i==="string")i={_expr:i};e.push(Amm.override({_id:r},i))}this._filter=new Amm.Filter({conditions:e})}var n=this._filter.evaluateMatch(t);if(!this._actions[n])n="default";if(!this._actions[n])return t;var s={};this._applyActions(t,this._actions,n,s);return s},_applyActions:function(t,e,i,r){var i=e[i];if(i instanceof Array){for(var n=0,s=i.length;n<s;n++){this._applyActions(t,i,n,r)}return}if(!i["Amm.Decorator.Data.Action"]){i=e[i]=Amm.constructInstance(i,"Amm.Decorator.Data.Action");i.apply(t,r)}}};Amm.extend(Amm.Decorator.Data,Amm.Decorator);Amm.Decorator.Data.Action=function(t){Amm.init(this,t)};Amm.Decorator.Data.Action.prototype={"Amm.Decorator.Data.Action":"__CLASS__",_src:null,_dest:null,def:undefined,decorator:null,merge:false,setSrc:function(t){if(!t)t=null;else t=Amm.Util.pathToArray(t);var e=this._src;if(e===t)return;this._src=t;return true},getSrc:function(){return this._src},setDest:function(t){if(t!==null&&t!==false&&t!==undefined){t=Amm.Util.pathToArray(t)}else{t=null}var e=this._dest;if(e===t)return;this._dest=t;return true},getDest:function(){return this._dest},apply:function(t,e){if(!(t&&typeof t==="object"))throw Error("srcObject must be a non-null object");if(!(e&&typeof e==="object"))throw Error("destObject must be a non-null object");var i=undefined;if(this._src)i=Amm.Util.getByPath(t,this._src,this.def);else i=this.def!==undefined?this.def:t;if(i===undefined)return;i=Amm.Decorator.d(i,this,"decorator");if(i===undefined)return;var r=this._dest;if(r===null&&this.merge){if(i&&typeof i==="object")Amm.override(e,i);return}Amm.Util.setByPath(e,r,i,{},this.merge)}};Amm.Element=function(t){this._beginInit();this._cleanupList=[];this._expressions={};if(!t){Amm.WithEvents.call(this);this._endInit();return}var e;var i=this._getDefaultTraits(),r=t.traits;var n=[];t=Amm.Element._checkAndApplyOptionsBuilderSource(t);if(t&&typeof t==="object"){t=Amm.override({},t)}if("expressions"in t){e=t.expressions;delete t.expressions}Amm.Element._checkAndApplyOptionsViews(t,n,r?null:i);if(t.extraTraits){if(r)throw Error("extraTraits and traits options cannot be used simultaneously");i=i.concat(t.extraTraits);delete t.extraTraits}if(r){if(t.traits instanceof Array)i=i.concat(t.traits);else i.push(t.traits);delete t.traits}if(i.length){var s=[];for(var a=0;a<i.length;a++){var o=Amm.getFunction(i[a]);if(Amm.Array.indexOf(o,s)>=0)continue;s.push(o);Amm.augment(this,o,t)}}var l=[],h;for(var a in t)if(t.hasOwnProperty(a)){if(a[0]==="i"&&a[2]==="_"&&a.slice(0,4)==="in__"){l.push([a.slice(4),t[a],Amm.Element.EXPROP_IN]);delete t[a]}if(a[0]==="s"&&a[4]==="_"&&a.slice(0,6)==="sync__"){l.push([a.slice(6),t[a],Amm.Element.EXPROP_SYNC]);delete t[a]}if(a[0]==="e"&&a[4]==="_"&&a.slice(0,6)==="expr__"){l.push([a.slice(6),t[a],Amm.Element.EXPROP_EXPR]);delete t[a]}else if(a[0]==="p"&&a[4]==="_"&&a.slice(0,6)==="prop__"){h=h||{};h[a.slice(6)]=t[a];delete t[a]}}Amm.WithEvents.call(this);var u=this._extractOnHandlers(t);Amm.init(this,t,["id","properties"]);Amm.init(this,t);if(h)this.setProperties(h);if(l.length)this._initInProperties(l);if(u)this._initOnHandlers(u);if(e)this.setExpressions(e);this._endInit();if(n.length){for(var a=0,f=n.length;a<f;a++){n[a].setElement(this)}}};Amm.Element.EXPROP_IN=0;Amm.Element.EXPROP_SYNC=1;Amm.Element.EXPROP_EXPR=2;Amm.Element._checkAndApplyOptionsBuilderSource=function(t){if(Amm.Builder.isPossibleBuilderSource(t)){t={builderSource:t}}if(!t.builderSource)return t;var e=Amm.Builder.calcPrototypeFromSource(t.builderSource);var i=t.builderPriority?Amm.override({},t,e):Amm.override(e,t);delete i.builderSource;delete i.builderPriority;delete i.class;return i};Amm.Element._checkAndApplyOptionsViews=function(t,e,i){if(!t.views)return;for(var r=0,n=t.views.length;r<n;r++){var s=t.views[r];if(!Amm.getClass(s)){if(typeof s==="string")s={class:s};var a=s["class"];if(!a){throw Error("views["+r+"].class not provided")}var o=Amm.getFunction(a);if(!o.prototype["Amm.View.Abstract"])throw Error("View class must be a descendant of Amm.View.Abstract");var l=s.class,h=s;delete s.class;s=new o(s);h.class=l}if(!s["Amm.View.Abstract"])throw Error("Created instance isn't a descendant of Amm.View.Abstract");e.push(s);if(i){i.push.apply(i,s.getSuggestedTraits())}}delete t.views};Amm.Element.regInit=function(t,e,i){if(t._initLevel===false)i.call(t);t._init=t._init||{};t._init[e]=i};Amm.Element.prototype={"Amm.Element":"__CLASS__",_id:null,_cleanupList:null,_cleanupWithComponent:true,defaultProperty:null,_init:null,_initLevel:0,_component:null,_closestComponent:null,_beginInit:function(){if(this._initLevel===false)return false;this._initLevel++;this._init=this._init||{}},_endInit:function(){if(this._initLevel===false)return false;if(this._initLevel>0){this._initLevel--}if(this._initLevel)return;if(this._init){this._initLevel=false;var t=[];for(var e in this._init){if(this._init.hasOwnProperty(e)&&typeof this._init[e]==="function"){t.push(e)}}t.sort();for(var e=0,i=t.length;e<i;e++)this._init[t[e]].call(this)}this._init=null},setId:function(t){if(this._id===t)return;var e=this._id;this._id=t;this._callOwnMethods("_setId_",t,e);this.outIdChange(t,e);return true},getId:function(){return this._id},outIdChange:function(t,e){this._out("idChange",t,e)},outCleanup:function(){this._out("cleanup",this)},setCleanupWithComponent:function(t){t=!!t;var e=this._cleanupWithComponent;if(e===t)return;this._cleanupWithComponent=t;return true},getCleanupWithComponent:function(){return this._cleanupWithComponent},createProperty:function(t,e,i,r){return Amm.createProperty(this,t,e,i,r)},cleanup:function(){this.setComponent(null);this._callOwnMethods("_cleanup_");for(var t=this._cleanupList.length-1;t>=0;t--){if(typeof this._cleanupList[t].cleanup==="function")this._cleanupList[t].cleanup()}this.outCleanup();Amm.WithEvents.prototype.cleanup.call(this)},_callOwnMethods:function(t){var e=t instanceof RegExp,i,r={};for(var n in this){if(typeof this[n]==="function"&&(e?n.match(e):n.indexOf(t)===0)){i=i||Array.prototype.slice.call(arguments,1);r[n]=this[n].apply(this,i)}}return r},setComponent:function(t){if(!t)t=null;if(t==="root")t=Amm.getRoot();if(t){Amm.is(t,"Component","component");if(!t.getIsComponent()){t=t.getClosestComponent()||null}}var e=this._component;if(e===t)return;this._component=t;if(t){t.acceptElements([this])}this._callOwnMethods("_setComponent_",t,e);this._setClosestComponent();this.outComponentChange(t,e);return true},getComponent:function(){return this._component},outComponentChange:function(t,e){this._out("componentChange",t,e)},getClosestComponent:function(){return this._component},_setClosestComponent:function(){var t=this._closestComponent;this._closestComponent=this.getClosestComponent();if(t!==this._closestComponent){this._callOwnMethods("_setClosestComponent_",this._closestComponent,t);this.outClosestComponentChange(this._closestComponent,t)}},outClosestComponentChange:function(t,e){return this._out("closestComponentChange",t,e)},_findChildElementsRecursive:function(t){var e=[];for(var i=0,r=t.length;i<r;i++){var n=t[i];if(n.Component&&n.getIsComponent())continue;e=e.concat(n.findChildElements(true))}return e},findChildElements:function(t){var e=[];this._callOwnMethods("_findChildElements_",e);if(t)e=e.concat(this._findChildElementsRecursive(e));return e},setProperties:function(t){if(!t||typeof t!=="object"){throw Error("`properties` must be an object")}var e=[];for(var i in t)if(t.hasOwnProperty(i)){var r=t[i],n=undefined;if(i.slice(0,4)==="in__"){i=i.slice(4);e.push([i,r,Amm.Element.EXPROP_IN]);r=undefined}else if(r&&typeof r==="object"&&("onChange"in r||"defaultValue"in r||"in__"in r)){if("in__"in r){e.push([i,r.in__])}n=r.onChange;r=r.defaultValue}Amm.createProperty(this,i,r,n)}if(e.length)this._initInProperties(e)},_initInProperties:function(t){for(var e=0,i=t.length;e<i;e++){var r=t[e][0];var n=t[e][1];var s=t[e][2];var a=r.split("__");if(a.length>1){r=a[0];a=a.slice(1)}else{a=undefined}this._createExpression(n,r,a,s)}},_createExpression:function(t,e,i,r){var n;var s,a;if(typeof t==="function"){s=t}else if(typeof t==="string"&&t.slice(0,11)==="javascript:"){var o=this._prepareFunctionHandlerBody(t.slice(11));s=Function("g","s",o)}else if(typeof t==="string"){a={src:t}}else if(t&&typeof t==="object"){a=t}else{throw Error("Expression-property (in__`prop`, sync__`prop`, expr__`prop`) "+"must be a string, function or Amm.Expression prototype")}if(s){if(r!==Amm.Element.EXPROP_IN){throw Error("javascript function handler can be used only for in__`prop` expressions")}n=new Amm.Expression.FunctionHandler(s,this,e,undefined,i);return n}if(!a)throw Error("Logic error");if(a["Amm.Expression"])return a;var l=r===Amm.Element.EXPROP_SYNC?Amm.Expression.Sync:Amm.Expression;if(a["class"]){l=Amm.getFunction(a["class"]);delete a["class"]}var h=e;if(r===Amm.Element.EXPROP_EXPR)h=undefined;n=new l(a,this,h,undefined,i);if(r===Amm.Element.EXPROP_EXPR){this._configureExprExpression(n,e)}Amm.is(n,r===Amm.Element.EXPROP_SYNC?"Amm.Expression.Sync":"Amm.Expression","expression");return n},_configureExprExpression:function(e,r){var t=r.charAt(0).toUpperCase()+r.slice(1);var i="get"+t;var n="set"+t;var s="out"+t+"Change";var a="_"+r;var o=[];if(i in this)o.push(i);if(n in this)o.push(n);if(s in this)o.push(s);if(a in this)o.push(a);if(o.length){throw Error("Cannot define expr__"+r+" expression-property: "+"memeber(s) '"+o.join("', '")+" already defined")}this[i]=function(){return e.getValue()};this[n]=function(t){return e.setValue(t)};this[s]=function(t,e,i){return this._out(r+"Change",t,e,i)};e.subscribe("valueChange",this[s],this);this[a]=e},_prepareFunctionHandlerBody:function(t){var i=false,r="";var e=function(t){if(t==="{:"){if(i)throw Error("Cannot nest {: in function template");i=true;return""}else if(t===":}"){if(!i)throw Error(":} without opening {: in function template");i=false;var e="g('"+r.replace(/(['"\\])/g,"\\$1")+"')";r="";return e}else if(i){r+=t;return""}return t};var n=t.replace(/([{]:|:[}]|:|[{}]|[^:{}]+)/g,e);return n},outViewAdded:function(t){this._out("viewAdded",t)},outViewDeleted:function(t){this._out("viewDeleted",t)},outViewReady:function(t){this._out("viewReady",t)},findView:function(t,e){var i=this.getUniqueSubscribers("Amm.View.Abstract");for(var r=0,n=i.length;r<n;r++){if(t!==undefined&&i[r].id!==t)continue;if(e!==undefined&&!Amm.is(i[r],e))continue;return i[r]}},_getDefaultTraits:function(){return[]},constructDefaultViews:function(){}};Amm.extend(Amm.Element,Amm.WithEvents);Amm.FilterSorter=function(t){this._observers=[];this._objects=[];this._matches=[];this._deferredChanges=[];Amm.WithEvents.DispatcherProxy.call(this);Amm.WithEvents.call(this,t)};Amm.FilterSorter.prototype={"Amm.FilterSorter":"__CLASS__",_observers:null,_objects:null,_matches:null,_deferredChanges:null,_updateLevel:0,_compareMatch:null,_requireAll:false,_cacheMatches:false,_cacheProp:null,getObservedObjects:function(){return[].concat(this._objects)},setObservedObjects:function(t){var e,i,r;if(!t)t=[];else t=Amm.Array.unique(t);var n=Amm.Array.calcChanges(this._objects,t,null,0,true);if(!n.added.length&&!n.deleted.length)return;this.beginUpdate();if(n.deleted.length){var s=[],a=[],o={};for(e=n.deleted.length-1;e>=0;e--){s.unshift(n.deleted[e][0]);r=this._matches[n.deleted[e][1]];a.unshift(r);this._objects.splice(e,1);this._matches.splice(e,1);o[n.deleted[e][1]]=true;this._deferredChanges.push([undefined,r,n.deleted[e]])}for(e=this._deferredChanges.length-n.deleted.length;e>=0;e--){if(o[this._deferredChanges[e][0]])this._deferredChanges.splice(e,1)}if(this._cacheMatches)this._deleteCachedMatches(s);this._unsubObservers(s,undefined,true);this.outObjectsUnobserved(s,a)}if(n.added.length){var l=[],h=[],u=[];for(e=0,i=n.added.length;e<i;e++){l.push(n.added[e][0]);r=this.evaluateMatch(n.added[e][0]);this._matches.push(r);h.push(r);u.push(this._objects.length+e);this._deferredChanges.push([this._objects.length+e,undefined,n.added[e][0]])}this._objects.push.apply(this._objects,l);if(this._cacheMatches){this._saveCachedMatches(u)}this._subObservers(l,undefined,false,true);this.outObjectsObserved(l,h)}this.endUpdate()},getMatches:function(){return[].concat(this._matches)},_subObservers:function(t,e,i,r){t=t||this._objects;e=e||this._observers;var n,s,a=i?"unobserve":"observe";for(n=0,s=e.length;n<s;n++){e[n][a](t)}if(!r)return;a=i?"unsubscribeObject":"subscribeObject";for(n=0,s=t.length;n<s;n++){var o=t[n];if(!(o["Amm.WithEvents"]&&o.hasEvent("cleanup")))continue;this[a](o,"cleanup",this._handleObjectCleanup,this)}},_handleObjectCleanup:function(){var t=Amm.event.origin;this.unobserveObject(t)},beforeDispatch:function(t,e,arguments){if(e.length>1||e[0][1]&&e[0][1]["Amm.Expression"]){this.beginUpdate()}},afterDispatch:function(t,e,arguments){if(e.length>1||e[0][1]&&e[0][1]["Amm.Expression"]){this.endUpdate()}},_unsubObservers:function(t,e,i){return this._subObservers(t,e,true,i)},beginUpdate:function(){this._updateLevel++},_hasChangeSubscribers:function(){return this._subscribers.matchesChange},endUpdate:function(){if(!this._updateLevel)throw Error("call to endUpdate() without prior beginUpdate()");if(this._updateLevel>1){this._updateLevel--;return}if(!this._hasChangeSubscribers()){this._deferredChanges=[];this._updateLevel--;return}var t={},e=[],i=[],r=[],n;for(var s=this._deferredChanges.length-1;s>=0;s--){n=this._deferredChanges[s][0];if(n!==undefined){if(t[n])continue;t[n]=true}var a=this._deferredChanges[s][1],o=this._deferredChanges[s][2],l=this._matches[n];if(a===l||this._compareMatch&&!this._compareMatch(a,l))continue;e.unshift(o);r.unshift(a);i.unshift(l)}this._deferredChanges=[];this._updateLevel--;if(!e.length)return;this.outMatchesChange(e,i,r);this._doOnEndUpdateChange()},_doOnEndUpdateChange:function(){},getUpdateLevel:function(){return this._updateLevel},getMatch:function(t,e){if(this._cacheMatches){var i=this._getCachedMatch(t);if(i!==undefined)return i}var r=Amm.Array.indexOf(t,this._objects);if(r>=0)return this._matches[r];if(e)return this.evaluateMatch(t);return undefined},refresh:function(t){if(t){var e=Amm.Array.indexOf(t,this._objects);if(e<0)throw Error("`object` not observed, cannot refresh()");var i=this.evaluateMatch(t);this._updateMatch(e,i)}else{this.beginUpdate();this._deferredChanges=[];for(var r=0,n=this._objects.length;r<n;r++){var s=this.evaluateMatch(this._objects[r]);this._updateMatch(r,s)}this.endUpdate()}},_doOnUpdateMatch:function(t,e,i){},_updateMatch:function(t,e){var i=this._matches[t];if(i===e||this._compareMatch&&!this._compareMatch(i,e))return;if(this._updateLevel){this._deferredChanges.push([t,i,this._objects[t]])}this._matches[t]=e;if(this._cacheMatches)this._saveCachedMatches([t]);if(this._updateLevel)return;this.outMatchesChange([this._objects[t]],[e],[i]);this._doOnUpdateMatch(t,i,e)},evaluateMatch:function(t){return null},observeObject:function(t){var e=Amm.Array.indexOf(t,this._objects),i;if(e>=0)return this._matches[e];this._objects.push(t);this._subObservers([t],undefined,false,true);i=this.evaluateMatch(t);for(var r=this._deferredChanges.length-1;r>=0;r--){if(this._deferredChanges[r][0]===undefined&&this._deferredChanges[r][2]===t){this._matches[this._objects.length-1]=this._deferredChanges[r][1];this._deferredChanges.splice(r,1)}}this._updateMatch(this._objects.length-1,i);this.outObjectsObserved([t],[i]);return i},unobserveObject:function(t){var e=Amm.Array.indexOf(t,this._objects);var i;if(e<0)return;if(this._cacheMatches)this._deleteCachedMatches([t]);var r=this._matches[e];this._objects.splice(e,1);this._matches.splice(e,1);if(r){i=this._matchingObjects;this._matchingObjects=null}for(var n=this._deferredChanges.length-1;n>=0;n--){if(this._deferredChanges[n][0]>e)this._deferredChanges[n][0]--;else if(this._deferredChanges[n][0]===e)this._deferredChanges.splice(n,1)}if(!this._updateLevel){this.outMatchesChange([t],[undefined],[r])}else{this._deferredChanges.push([undefined,r,t])}this._unsubObservers([t]);if(this._updateLevel)return;if(r&&this._subscribers.matchingObjectsChange)this.outMatchingObjectsChange(this.getMatchingObjects(),i);this.outObjectsUnobserved([t],[r]);return r},hasObservedObject:function(t){return Amm.Array.indexOf(t,this._objects)>=0},outObjectsObserved:function(t,e){this._out("objectsObserved",t,e)},outObjectsUnobserved:function(t,e){this._out("objectsUnobserved",t,e)},outMatchesChange:function(t,e,i){this._out("matchesChange",t,e,i)},_saveCachedMatches:function(t){if(!this._cacheMatches)return;if(t!==undefined&&!(t instanceof Array))t=[t];if(!this._cacheProp){Amm.registerItem(this);this._cacheProp="_Amm.FilterSorter."+this._amm_id;Amm.unregisterItem(this)}for(var e=0,i=t?t.length:this._objects.length;e<i;e++){var r=t?t[e]:e,n=this._objects[r],s=this._matches[r];n[this._cacheProp]=s}},_getCachedMatch:function(t){if(!t||!this._cacheProp)return undefined;return t[this._cacheProp]},_deleteCachedMatches:function(t){if(!this._cacheProp)return;for(var e=0,i=t.length;e<i;e++){delete t[e][this._cacheProp]}},setCacheMatches:function(t){t=!!t;var e=this._cacheMatches;if(e===t)return;this._cacheMatches=t;if(!t)this._deleteCachedMatches(this._objects);else this._saveCachedMatches();return true},getCacheMatches:function(){return this._cacheMatches},cleanup:function(){Amm.WithEvents.prototype.cleanup.apply(this);this._matches=[];this._unsubObservers();for(var t=0,e=this._observers.length;t<e;t++){this._observers[t].cleanup()}this._observers=[];this.setObservedObjects([])}};Amm.extend(Amm.FilterSorter,Amm.WithEvents.DispatcherProxy);Amm.extend(Amm.FilterSorter,Amm.WithEvents);Amm.Sorter=function(t){this._compareClosureFn=function(i){return function(t,e){return i.compareObjects(t,e)}}(this);Amm.FilterSorter.call(this,t)};Amm.Sorter.ascendingDescRx=/\s+(asc|desc)$/i;Amm.Sorter.propNameRx=/^\w+$/;Amm.Sorter.prototype={"Amm.Sorter":"__CLASS__",_needReorderCriteria:false,_parseAscendingDesc:true,_allowExpressions:true,_cacheMatches:true,_lockIndexes:0,_compareClosureFn:null,_directions:null,_oldDirections:null,_deleteCriterion:function(t,e){if(!this._observers[t])return;var i=this._observers[t];this._unsubObservers(this._objects,[i]);i.cleanup();if(!e)return;this._innerShift(t,this._observers.length)},setCriteria:function(t,e){if(e!==undefined){this._directions=null;var i=e;if(i<0)i=0;if(i>this._observers.length)i=this._observers.length;if(t){this._lockIndexes++;try{t=this._getCriterionPrototype(t,i)}catch(t){this._lockIndexes--;throw t}this._lockIndexes--}else{t=null}if(this._observers[i]){if(this._observers[i]===t)return;if(e>=0){this._deleteCriterion(i,!t);this._directions=null;this.refresh();return}}if(!t){this._directions=null;this.refresh();return true}if(e<0){this._innerShift(this._observers.length,0,true)}this._observers[i]=t;this._directions=null;this.refresh();return true}var r,n;try{this.beginUpdate();this._lockIndexes++;var s=[],a;if(!(t instanceof Array))t=[t];this._directions=null;for(r=0,n=t.length;r<n;r++){a=this._getCriterionPrototype(t[r],r);s.push(a)}var o=Amm.constructMany(s,"Amm.Sorter.Criterion");o.sort(function(t,e){return t.getIndex()-e.getIndex()});for(var r=0,n=o.length;r<n;r++){o[r].setIndex(r)}for(r=0,n=this._observers.length;r<n;r++){this._observers[r].cleanup()}this._observers=o;if(this._objects.length){this._subObservers(this._objects)}}catch(t){this._lockIndexes--;this.endUpdate();throw t}this._lockIndexes--;this._directions=null;this.refresh();this.endUpdate()},getCriteria:function(t){if(t===undefined)return[].concat(this._observers);return this._observers[t]},_getCriterionPrototype:function(t,e){var i;if(t&&typeof t==="object"){if(t["Amm.Sorter.Criterion"]){if(t.getFilterSorter()!==this){throw Error("setCriteria(): `criteria["+e+"]` doesn't belong to current Sorter")}if(t.getIndex()===null)t.setIndex(e);i=t}else{i={}.override(t);if(typeof i.index!=="number")i.index=e}i.filterSorter=this;return i}var r,n=true;i={};if(typeof t!=="string")throw Error("`criteria["+e+"]` should be either string or object; given: "+Amm.describeType(t));if(this._parseAscendingDesc){r=Amm.Sorter.ascendingDescRx.exec(t);if(r){n=r[1].toLowerCase()==="asc";t=t.slice(0,-r[0].length)}}if(this._allowExpressions&&!Amm.Sorter.propNameRx.exec(t)){i.expression=t;i.class=Amm.Sorter.Expression}else{i.class=Amm.Sorter.Property;i.property=t}if(!("index"in i))i.index=e;i.ascending=n;i.filterSorter=this;return i},compareObjects:function(t,e){var i=this.getMatch(t,true);var r=this.getMatch(e,true);return this.compareMatches(i,r)},calcSortValue:function(t,e){return this.getMatch(t,true)},getCompareClosureFn:function(){return this._compareClosureFn},_innerShift:function(t,e,i){this._lockIndexes++;var r=t>e?-1:1;for(var n=t;n*r<e*r;n+=r){this._observers[n]=this._observers[n+r];if(i)this._observers[n].setIndex(n)}this._lockIndexes--},notifyCriterionIndexChanged:function(t,e,i){if(this._lockIndexes)return;if(this._observers[i]!==t){i=Amm.Array.indexOf(t,this._observers);if(i<0)throw Error("Provided criterion is not registered observer")}if(e<0)e=0;if(e>=this._observers.length)e=this._observers.length-1;if(e===i)return;this._innerShift(i,e,true);this._observers[e]=t;t.setIndex(e);this._lockIndexes--;this.refresh()},notifyCriterionDirectionChanged:function(t,e,i){if(this._directions){this._directions=null;this.outNeedSort()}},compareMatches:function(t,e){var i,r;if(!(t instanceof Array)&&e instanceof Array)throw Error("both matches must be Arrays");if(t.length!==e.length)throw Error("both matches must have same length");if(!this._directions){this._directions=this._getDirections()}var n;for(i=0,r=t.length;i<r;i++){if(t[i]===e[i])continue;if(t[i]<e[i])n=-1;else if(t[i]>e[i])n=1;else n=0;if(!this._directions[i])n=-1*n;return n}return 0},_compareMatch:function(t,e){if(t===e)return 0;if(!t||!e)return 1;if(!(t instanceof Array||t["Amm.Array"]))return 1;if(!(e instanceof Array||e["Amm.Array"]))return 1;return!Amm.Array.equal(t,e)},outNeedSort:function(){this._oldDirections=null;return this._out("needSort")},sort:function(t){var e;if(t&&t["Amm.Array"])e=t.getItems();else if(t&&t instanceof Array)e=t.slice();else throw Error("`objects` must be Array or Amm.Array");return e.sort(this._compareClosureFn)},evaluateMatch:function(t){if(!this._observers.length)return[];var e=[];for(var i=0,r=this._observers.length;i<r;i++){e.push(this._observers[i].getValue(t))}return e},_doOnEndUpdateChange:function(){this.outNeedSort()},_doOnUpdateMatch:function(t,e,i){this.outNeedSort()},_hasChangeSubscribers:function(){return this._subscribers.matchesChange||this._subscribers.needSort},_getDirections:function(){if(this._directions)return this._directions;var t=[];for(i=0,l=this._observers.length;i<l;i++)t.push(this._observers[i].getAscending());return t},beginUpdate:function(){Amm.FilterSorter.prototype.beginUpdate.call(this);if(this._updateLevel===1){this._oldDirections=this._getDirections()}},endUpdate:function(){Amm.FilterSorter.prototype.endUpdate.call(this);if(this._oldDirections&&!this._directions&&!Amm.Array.equal(this._getDirections(),this._oldDirections)){this._directions=null;this.outNeedSort()}}};Amm.extend(Amm.Sorter,Amm.FilterSorter);Amm.FilterSorter.Observer=function(t,e){this._filterSorter=t;Amm.WithEvents.call(this,e,true)};Amm.FilterSorter.Observer.prototype={"Amm.FilterSorter.Observer":"__CLASS__",_filterSorter:null,match:function(t){return true},cleanup:function(t){this.unsubscribe();this._filterSorter=null;Amm.WithEvents.prototype.cleanup.call(this)},observe:function(t){},unobserve:function(t){}};Amm.extend(Amm.FilterSorter.Observer,Amm.WithEvents);Amm.Sorter.Criterion=function(t,e){if(e===undefined&&t&&typeof t==="object"&&t.filterSorter){e=t;t=e.filterSorter;delete e.filterSorter}Amm.FilterSorter.Observer.call(this,t,e);Amm.init(this,e)};Amm.Sorter.Criterion.prototype={"Amm.Sorter.Criterion":"__CLASS__",_index:null,_ascending:true,_defaultValue:null,setIndex:function(t){var e=this._index;if(e===t)return;this._index=t;this._filterSorter.notifyCriterionIndexChanged(this,t,e);this.outIndexChange(t,e);return true},getIndex:function(){return this._index},outIndexChange:function(t,e){this._out("indexChange",t,e)},setAscending:function(t){t=!!t;var e=this._ascending;if(e===t)return;this._ascending=t;this._filterSorter.notifyCriterionDirectionChanged(this,t,e);this.outAscendingChange(t,e);return true},getAscending:function(){return this._ascending},outAscendingChange:function(t,e){this._out("ascendingChange",t,e)},setDefaultValue:function(t){var e=this._defaultValue;if(e===t)return;this._defaultValue=t;this.outDefaultValueChange(t,e);this._filterSorter.refresh();return true},getDefaultValue:function(){return this._defaultValue},outDefaultValueChange:function(t,e){this._out("defaultValueChange",t,e)},getValue:function(t){var e=this._doGetValue(t);if(e===undefined)e=this._defaultValue;return e},_doGetValue:function(t){}};Amm.extend(Amm.Sorter.Criterion,Amm.FilterSorter.Observer);Amm.Sorter.Expression=function(t,e){Amm.Sorter.Criterion.call(this,t,e);if(!this._expression)throw Error("Need to provide options.expression")};Amm.Sorter.Expression.prototype={"Amm.Sorter.Expression":"__CLASS__",_expression:null,_evaluator:null,setExpression:function(t){var e=this._expression;if(e===t)return;if(this._expression)throw Error("Can setExpression() only once");if(typeof t!=="string")throw Error("`expression` must be a string");this._expression=new Amm.Expression(t);this._expression.setEventsProxy(this._filterSorter);return true},getExpression:function(){return this._expression},observe:function(t){for(var e=0,i=t.length;e<i;e++){var r=t[e];if(this._expression.findContext(r)!==undefined)continue;this._expression.createContext({expressionThis:r});this._expression.subscribe("valueChange",this._handleExpressionChanged,this)}},unobserve:function(t){for(var e=0,i=t.length;e<i;e++){var r=this._expression.findContext(t[e]);if(r===undefined)continue;this._expression.deleteContext(r)}},_handleExpressionChanged:function(t,e){var i=this._expression.getExpressionThis();this._filterSorter.refresh(i)},_doGetValue:function(t){if(t===this._expression.getExpressionThis()){return this._expression.getValue()}var e=this._expression.findContext(t);if(e!==undefined){this._expression.setContextId(e);return this._expression.getValue()}if(!this._evaluator)this._evaluator=this._expression.toFunction();this._evaluator.env.expressionThis=t;return this._evaluator()},cleanup:function(){Amm.Sorter.Criterion.prototype.cleanup.call(this);this._expression.cleanup();this._evaluator=null;this._expression=null}};Amm.extend(Amm.Sorter.Expression,Amm.Sorter.Criterion);Amm.Sorter.Property=function(t,e){Amm.Sorter.Criterion.call(this,t,e);if(!this._property)throw Error("Need to specify options.property")};Amm.Sorter.Property.prototype={"Amm.Sorter.Property":"__CLASS__",_property:null,setProperty:function(t){var e=this._property;if(e===t)return;if(this._property)throw Error("Can setProperty() only once");this._property=t;return true},getProperty:function(){return this._property},observe:function(t){var e=t||this._filterSorter._objects,i=e.length,r,n;var s=this._property+"Change";for(r=0;r<i;r++){n=e[r];if(!n["Amm.WithEvents"])continue;if(!n.hasEvent(s))continue;this._filterSorter.subscribeObject(n,s,this._handleChange,this)}},unobserve:function(t){var e=t||this._filterSorter._objects,i=e.length,r,n;var s=this._property+"Change";for(r=0;r<i;r++){n=e[r];if(!n["Amm.WithEvents"])continue;if(!n.hasEvent(s))continue;this._filterSorter.unsubscribeObject(n,s,this._handleChange,this)}},_handleChange:function(){if(!this._filterSorter)return;var t=Amm.event.origin;this._filterSorter.refresh(t)},_doGetValue:function(t){return Amm.getProperty(t,this._property)}};Amm.extend(Amm.Sorter.Property,Amm.Sorter.Criterion);Amm.DomHolder=function(){};Amm.DomHolder.find=function(t,e,i){var s=Amm.domHolderAttribute,r=[],a={};jQuery(t)[e?"find":"closest"]("["+s+"]").each(function(t,e){var i=e.getAttribute(s).split(" ");for(var r=0,n=i.length;r<n;r++)if(i[r].length)a[i[r]]=1});for(var n in a)if(a.hasOwnProperty(n)){var o=Amm.getItem(n,i);if(o)r.push(o)}return r};Amm.DomHolder.prototype={"Amm.DomHolder":"__CLASS__",_domExclusive:true,_notifyDomNodeConflict:function(t,e){if(this._domExclusive&&!this._domCompat(e)){var i="Element already acquired by a different DomHolder";console.error(i,this,t,e);throw Error(i)}},_domCompat:function(t){var e=this["Amm.ElementBound"]&&t["Amm.ElementBound"]&&this._element&&t._element===this._element;return e},_acquireDomNode:function(t){Amm.registerItem(this);var o=this,l=Amm.domHolderAttribute;jQuery(t).each(function(t,e){var i=e.getAttribute(l)||"",r=i.indexOf(" "+o._amm_id);if(r<0){var n=i.split(" "),s=Amm.getItem(n);for(var t=0,a=s.length;t<a;t++){o._notifyDomNodeConflict(e,s[t]);s[t]._notifyDomNodeConflict(e,o)}n.push(o._amm_id);e.setAttribute(l,n.join(" "))}})},_releaseDomNode:function(t){var e=this,r=" "+e._amm_id,n=Amm.domHolderAttribute;jQuery(t).each(function(t,e){if(e.hasAttribute(n)){var i=e.getAttribute(n).replace(r,"");if(i.length)e.setAttribute(n,i);else e.removeAttribute(n)}})}};Amm.Validator=function(t){Amm.override(this,t)};Amm.Validator.construct=function(t,e,i,r){if(typeof t==="function"){return Amm.constructInstance({func:t},"Amm.Validator.Function",e,i,r)}return Amm.constructInstance(t,"Amm.Validator",e,i,r)};Amm.Validator.instantiate=function(t,e){if(!t[e]["Amm.Validator"])t[e]=Amm.Validator.construct(t[e]);return t[e]};Amm.Validator.iErr=function(t,e,i,r){return Amm.Validator.instantiate(t,e).getError(i,r)};Amm.Validator.prototype={"Amm.Validator":"__CLASS__",_msg:function(t){for(var e=1,i=arguments.length;e<i;e+=2){if(arguments[e]==="%field"&&arguments[e+1]===undefined){arguments[e+1]=Amm.translate("lang.Amm.Validator.value");break}}var r=Array.prototype.slice.apply(arguments);return Amm.translate.apply(Amm,r)},isEmpty:function(t){return t===""||t===null||t===undefined},getError:function(t,e){return null}};Amm.defineLangStrings({"lang.Amm.Validator.value":"Value"});Amm.Validator.Number=function(t){Amm.Validator.call(this,t)};Amm.Validator.Number.prototype={"Amm.Validator.Number":"__CLASS__",allowEmpty:true,strict:true,allowFloat:true,gt:null,ge:null,lt:null,le:null,msgMustBeNumber:"lang.Amm.Validator.Number.msgMustBeNumber",msgMustBeInteger:"lang.Amm.Validator.Number.msgMustBeInteger",msgMustBeGt:"lang.Amm.Validator.Number.msgMustBeGt",msgMustBeGe:"lang.Amm.Validator.Number.msgMustBeGe",msgMustBeLt:"lang.Amm.Validator.Number.msgMustBeLt",msgMustBeLe:"lang.Amm.Validator.Number.msgMustBeLe",getError:function(t,e){var i=this.isEmpty(t);if(i){if(this.allowEmpty)return;return this._msg(this.msgMustBeNumber,"%field",e)}var r=parseInt(t);var n=parseFloat(t);var s=n!=t&&r!=t;if(isNaN(r)||this.strict&&s){return this._msg(this.msgMustBeNumber,"%field",e)}if(r!=n&&!this.allowFloat){return this._msg(this.msgMustBeInteger,"%field",e)}var a=this.allowFloat?n:r;var o;o=this.gt;if(o!==null&&!(a>o)){return this._msg(this.msgMustBeGt,"%field",e,"%val",o)}o=this.ge;if(o!==null&&!(a>=o)){return this._msg(this.msgMustBeGe,"%field",e,"%val",o)}o=this.lt;if(o!==null&&!(a<o)){return this._msg(this.msgMustBeLt,"%field",e,"%val",o)}o=this.le;if(o!==null&&!(a<=o)){return this._msg(this.msgMustBeLe,"%field",e,"%val",o)}}};Amm.extend(Amm.Validator.Number,Amm.Validator);Amm.defineLangStrings({"lang.Amm.Validator.Number.msgMustBeNumber":"%field must be a number","lang.Amm.Validator.Number.msgMustBeInteger":"%field must be an integer number","lang.Amm.Validator.Number.msgMustBeGt":"%field must be higher than %val","lang.Amm.Validator.Number.msgMustBeGe":"%field must not be less than %val","lang.Amm.Validator.Number.msgMustBeLt":"%field must be less than %val","lang.Amm.Validator.Number.msgMustBeLe":"%field must not exceed %val"});Amm.Validator.Function=function(t){Amm.Validator.call(this,t)};Amm.Validator.Function.prototype={"Amm.Validator.Function":"__CLASS__",element:null,func:null,message:"lang.Amm.Validator.Function.msg",getError:function(t,e){var i={message:null},r=null;if(typeof this.func==="function"){r=this.func(t,e,i,this.element);if(typeof r==="string"){r=Amm.translate(r,"%field",e)}else if(!r&&r!==undefined){r=Amm.translate(i.message||this.message,"%field",e)}else{return}}else{Error("Amm.Validator.Function: this.`func` not set (or not a function)")}return r}};Amm.extend(Amm.Validator.Function,Amm.Validator);Amm.defineLangStrings({"lang.Amm.Validator.Function.msg":"%field is invalid"});Amm.Validator.Required=function(t){Amm.Validator.call(this,t)};Amm.Validator.Required.prototype={"Amm.Validator.Required":"__CLASS__",message:"lang.Amm.Validator.Required.msg",getError:function(t,e){var i=this.isEmpty(t);if(!i)return;return this._msg(this.message,"%field",e)}};Amm.extend(Amm.Validator.Required,Amm.Validator);Amm.defineLangStrings({"lang.Amm.Validator.Required.msg":"%field is required"});Amm.View={};Amm.JQueryListener=function(t){Amm.init(this,t)};Amm.JQueryListener.prototype={_handler:null,_onJQuery:null,_onArgs:null,elementPass:null,eventPass:null,_eventName:null,_selector:null,_delegateSelector:null,_htmlRoot:null,setEventName:function(t){var e;if((e=this._eventName)===t)return;this._eventName=t;this._bind()},getEventName:function(){return this._eventName},setSelector:function(t){var e;if((e=this._selector)===t)return;this._selector=t;this._bind()},getSelector:function(){return this._selector},setDelegateSelector:function(t){var e;if((e=this._delegateSelector)===t)return;this._delegateSelector=t;this._bind()},getDelegateSelector:function(){return this._delegateSelector},setHtmlRoot:function(t){var e;if((e=this._htmlRoot)===t)return;this._htmlRoot=t;this._bind()},getHtmlRoot:function(){return this._htmlRoot},_bind:function(){if(this._onJQuery){this._onJQuery.off.apply(this._onJQuery,this._onArgs);this._onJQuery=null;this._onArgs=null}if(this._selector&&this._eventName&&this._handler){this._onArgs=[this._handler];if(this._delegateSelector)this._onArgs.unshift(this._delegateSelector);this._onArgs.unshift(this._eventName);this._onJQuery=this._htmlRoot?jQuery(this._htmlRoot).find(this._selector):jQuery(this._selector);this._onJQuery.on.apply(this._onJQuery,this._onArgs)}},cleanup:function(){this._handler=null;this._bind()},setHandler:function(t){var e=this._handler;if(e===t)return;this._handler=t;this._bind();return true},getHandler:function(){return this._handler}};Amm.Expression.Sync=function(t,e,i,r,n,s,a,o){Amm.Expression.call(this,t,e,i,r,n)};Amm.Expression.Sync.prototype={"Amm.Expression.Sync":"__CLASS__",_translator:null,_errProperty:null,_errObject:null,_writeGetter:null,_writeSetter:null,_writeEvent:null,_lastError:false,setTranslator:function(t){if(!t)t=null;else if(!Amm.getClass(t)){t=Amm.constructInstance(t,"Amm.Translator")}else{Amm.is(t,"Amm.Translator","translator")}var e=this._translator;if(e===t)return;this._translator=t;this._write();return true},getTranslator:function(){return this._translator},setErrProperty:function(t){var e=this._errProperty;if(e===t)return;this._errProperty=t;return true},getErrProperty:function(){return this._errProperty},setErrObject:function(t){var e=this._errObject;if(e===t)return;this._errObject=t;this._handleTranslationError(this._lastError,false,true);return true},getErrObject:function(){return this._errObject},setWriteProperty:function(t,e,i){var r=Amm.Expression.prototype.setWriteProperty.call(this,t,e,i);if(this._writeObject&&this._writeObject["Amm.Expression"]){this._writeObject.subscribe("valueChange",this._handleWriteValueChange,this);return r}if(!this._writeEvent)this._detectWriteProperty();if(this._writeEvent){(this._writeObject||this._expressionThis).subscribe(this._writeEvent,this._handleWriteValueChange,this)}else{throw Error("writeObject doesn't have event for change of writeProperty '"+this._writeProperty+"' so Amm.Expression.Sync cannot function")}},_detectWriteProperty:function(){var t=this._writeObject||this._expressionThis,e={};Amm.detectProperty(t,this._writeProperty,e);this._writeGetter=e.getterName;this._writeSetter=e.setterName;this._writeEvent=e.eventName},_write:function(){var t=this._writeObject||this._expressionThis;if(!t)return;if(this._lockWrite)return;this._lockWrite++;var e=this.getValue(),i=true;if(this._translator&&e!==undefined){var r={};e=this._translator.translateIn(e,r);if(r.error)i=false;this._handleTranslationError(r.error,true)}if(!i){this._lockWrite--;return}if(!this._writeGetter)this._detectWriteProperty();var n=t[this._writeGetter]();if(e===undefined&&n!==undefined){this._setTranslatedValue(n);this._lockWrite--;return}Amm.setProperty(t,this._writeProperty,e,false,this._writeArgs);this._lockWrite--},_setTranslatedValue:function(t){if(!this._translator){this.setValue(t);return}var e={};var i=this._translator.translateOut(t,e);if(!e.error){this.setValue(i)}this._handleTranslationError(e.error||null,false)},_handleTranslationError:function(t,e,i){if(t===this._lastError&&!i)return;this._lastError=t;if(this._errProperty)Amm.setProperty(this._errObject||this._expressionThis,this._errProperty,t)},_handleWriteValueChange:function(t,e){if(this._lockWrite)return;this._lockWrite++;this._setTranslatedValue(t);this._lockWrite--},parse:function(t){Amm.Expression.prototype.parse.call(this,t);if(!this.supportsAssign)throw Error("Amm.Expression.Sync must be assignable, but '"+t+"' is not")},notifyWriteDestinationChanged:function(){if(Amm.Expression.prototype.notifyWriteDestinationChanged.call(this))return true;if(this._writeGetter&&this._hasValue&&this._value===undefined){var t=this._writeObject||this._expressionThis,e;if(t){e=t[this._writeGetter]();if(e!==undefined)this._setTranslatedValue(e)}}}};Amm.extend(Amm.Expression.Sync,Amm.Expression);Amm.Expression.FunctionHandler=function(t){Amm.WithEvents.call(this,t,true);this._expressions={};this._get={};this._set={};var e;var i=null;var r=this;this._getter=function(t,e){return r.get(t,e)};this._setter=function(t,e){return r.set(t,e)};if(typeof t==="function"){if(arguments.length>=2||typeof arguments[2]==="object"&&!(arguments[2]instanceof Array)){e=arguments[6]||{};e.fn=arguments[0];e.thisObject=arguments[1];i=true}else{e=arguments[2]||{};e.fn=arguments[0];e.thisObject=arguments[1]}}else e=t;Amm.init(this,e);if(i)this.setWriteProperty(arguments[2],arguments[3],arguments[4])};Amm.Expression.FunctionHandler.prototype={_fn:null,_thisObject:null,_isRun:0,_get:null,_set:null,_again:false,_writeObject:null,_writeProperty:null,_writeArgs:null,_lockWrite:0,_value:null,_gotValue:false,setFn:function(t){var e=this._fn;if(e===t)return;if(this._fn)throw Error("Can setFn() only once");if(typeof t!=="function")throw Error("fn must be a function");this._fn=t;return true},getFn:function(){return this._fn},setThisObject:function(t){var e=this._thisObject;if(e===t)return;if(typeof t!=="object"||!t)throw Error("thisObject must be a non-null object");this._thisObject=t;if(t["Amm.WithEvents"]&&t.hasEvent("cleanup")){t.subscribe("cleanup",this.cleanup,this)}return true},getThisObject:function(){return this._thisObject},_setValue:function(t){var e=this._value;if(e===t)return;this._gotValue=true;this._value=t;if(this._writeProperty)this._write();this.outValueChange(t,e);return true},getValue:function(t){if(t||!this._gotValue){this._run(t)}return this._value},outValueChange:function(t,e){this._out("valueChange",t,e)},_run:function(t){if(!this._fn)return;if(this._isRun)return;this._isRun++;this._again=!!t;var e=this._fn.call(this,this._getter,this._setter);this._setValue(e);this._cleanExpressions();this._isRun--},setWriteProperty:function(t,e,i){if(arguments.length===1&&t instanceof Array){t=arguments[0][0];e=arguments[0][1];i=arguments[0][2]}if(this._writeProperty)Error("Can setWriteProperty() only once");if(!t)Error("writeProperty must be non-falseable");if(t["Amm.Expression"]){if(e||i)Error("When Amm.Expression is used as writeProperty, don't specify writeObject/writeArgs");e=t;t="value";e.subscribe("writeDestinationChanged",this._write,this)}if(i===null||i===undefined){i=null}else if(!(i instanceof Array)){i=[i]}if(!e&&!this._thisObject){Error("setThisObject() or provide writeObject when setting writeProperty")}this._writeProperty=t;this._writeObject=e;if(e&&e["Amm.WithEvents"]&&e.hasEvent("cleanup")){e.subscribe("cleanup",this.cleanup,this)}this._writeArgs=i;this._write()},_write:function(){if(this._lockWrite||!this._writeProperty)return;this._lockWrite++;var t=this._writeObject||this._thisObject;Amm.setProperty(t,this._writeProperty,this.getValue(),false,this._writeArgs);this._lockWrite--},getWriteProperty:function(t){return t?[this._writeProperty,this._writeObject,this._writeArgs]:this._writeProperty},getWriteObject:function(){return this._writeObject},getWriteArgs:function(){return this._writeArgs},_handleExpressionValueChange:function(t,e){if(this._lockWrite)return;this._run()},_handleExpressionDestinationChange:function(){if(this._lockWrite)return;this._run()},_access:function(t,e){if(this._isRun)this[e?"_set":"_get"][t]=true;if(!this._expressions[t]){this._expressions[t]=new Amm.Expression(t,this._thisObject);if(e){this._expressions[t].subscribe("writeDestinationChanged",this._handleExpressionDestinationChange,this)}else{this._expressions[t].subscribe("valueChange",this._handleExpressionValueChange,this)}}return this._expressions[t]},get:function(t,e){if(e===undefined)e=this._again;return this._access(t).getValue(e)},set:function(t,e){return this._access(t,true).setValue(e)},_cleanExpressions:function(t){for(var e in this._expressions){if(this._expressions.hasOwnProperty(e)){if(t||!this._get[e]&&!this._set[e]){this._expressions[e].unsubscribe(undefined,undefined,this);this._expressions[e].cleanup();delete this._expressions[e]}}}this._get={};this._set={}},cleanup:function(){this._cleanExpressions(true);if(this._writeObject&&this._writeObject["Amm.Expression"]){this._writeObject.cleanup()}Amm.WithEvents.prototype.cleanup.call(this)}};Amm.extend(Amm.Expression.FunctionHandler,Amm.WithEvents);Amm.Util={regexEscape:function(t){return t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},trim:function(t){return t.replace(/^\s+|\s+$/g,"")},getByPath:function(t,e,i){if(!(e instanceof Array))e=Amm.Util.pathToArray(e);var r=t,n=[].concat(e),s;while(n.length){s=n.shift();if(!r||typeof r!=="object"||!(s in r))return i;r=r[s]}if(!n.length)return r;return i},setByPath:function(t,e,i,r,n){if(!t&&i===undefined)return;if(!(e instanceof Array))e=Amm.Util.pathToArray(e);var s=e.length;r=r||{};r.changed=false;if(!s)return i;if(typeof t!=="object"||t===null){t={};r.changed=true}var a={dummy:t},o=a,l="dummy",h,u;for(var f=0;f<s;f++){var c=f>=s-1,_=o[l];h=""+e[f],u=parseInt(h);if(!h.length){if(_ instanceof Array)u=_.length;else{u=0;for(var m in _)if(_.hasOwnProperty(m)){var d=parseInt(m);if(d>=u)u=d+1}}h=u}if(u>=0&&""+u==h){if(c){if(_[u]!==i){if(n&&(i&&typeof i==="object"&&(_[u]&&typeof _[u]==="object"))){Amm.override(_[u],i)}else{_[u]=i}r.changed=true}}else{if(_[u]===undefined){_[u]=[];r.changed=true}}o=_;l=u}else{if(_ instanceof Array){r.changed=true;o[l]=Amm.Util.arrayToHash(o[l]);_=o[l]}if(c){if(_[h]!==i){r.changed=true;if(n&&(i&&typeof i==="object"&&(_[h]&&typeof _[h]==="object"))){Amm.override(_[h],i)}else{_[h]=i}}}else{if(_[h]===undefined){_[h]=[];r.changed=true}o=_;l=h}}}return a.dummy},arrayToHash:function(t){var e={},i=t.length;for(var r=0;r<i;r++){if(t[r]!==undefined)e[r]=t[r]}return e},pathToArray:function(t){if(!t.length)return[];if(t instanceof Array)return t;return t.replace(/\]/g,"").split("[")},arrayToPath:function(t){if(!t.length)return"";var e=t;if(t instanceof Array)e=t.length>1?t.join("][")+"]":t[0];return""+e},swapKeysValues:function(t){if(!t||typeof t!=="object")throw Error("`hash` must be a non-null object");var e={};for(var i in t)if(t.hasOwnProperty(i))e[t[i]]=i;return e}};Amm.Expression.Token=function(t,e,i,r){this.string=t;this.type=e;this.value=i;this.offset=r};Amm.Expression.Token.Type={WHITESPACE:1,SYMBOL:2,WORD:3,INTEGER:4,FLOAT:5,ILLEGAL:6,SINGLE_QUOTED_STRING:15,DOUBLE_QUOTED_STRING:16,REGEXP:17};Amm.Expression.Token.Keyword={NEW:"new",INSTANCEOF:"instanceof",TYPEOF:"typeof"};Amm.Expression.Token._swappedKeywords=Amm.Util.swapKeysValues(Amm.Expression.Token.Keyword);Amm.Expression.Token.prototype={string:undefined,type:undefined,value:undefined,offset:undefined,toArray:function(){return[this.string,this.type,this.value]},isSymbol:function(t){if(this.type!==Amm.Expression.Token.Type.SYMBOL)return false;if(!t)return true;if(t instanceof Array)return Amm.Array.indexOf(this.string,t)>=0;if(arguments.length===1)return this.string===t;var e=Array.prototype.slice.apply(arguments);return Amm.Array.indexOf(this.string,e)>=0},isIdentifier:function(){return this.type===Amm.Expression.Token.Type.WORD},isConstant:function(){return this.type===Amm.Expression.Token.Type.INTEGER||this.type===Amm.Expression.Token.Type.FLOAT||this.type===Amm.Expression.Token.Type.SINGLE_QUOTED_STRING||this.type===Amm.Expression.Token.Type.DOUBLE_QUOTED_STRING||this.type===Amm.Expression.Token.Type.REGEXP}};Amm.Expression.Parser=function(){};Amm.Expression.Parser.prototype={"Amm.Expression.Parser":"__CLASS__",tokensRx:/^(?:(\s+)|(typeof|instanceof|new|!!|\?\?|\.\.|::|->|&&|\|\||!==|!=|===|==|>=|<=|=>|[-&|+><\{\}$?!.,:\[\]()'"%*/])|([_a-zA-Z][_a-zA-Z0-9]*)|(0[xX]?[0-9]+)|([0-9]+(?:\.[0-9+])?(?:e[+-]?[0-9]+)?)|(.))/,regexTokens:/^(?:(\.)|([[\]()\/])|([^\\\[n\]()\/]+))/,regexFlags:/^[a-zA-Z]+/,stringSingleQuoteRx:/^((?:\\.)|')|[^\\']+/,stringDoubleQuoteRx:/^((?:\\.)|")|[^\\"]+/,unescapes:{'\\"':'"',"\\'":"'","\\n":"\n","\\r":"\r","\\t":"\t","\\v":"\v","\\0":"\0","\\f":"\f","\\\\":"\\"},genFn:null,genObj:null,decorateFn:null,decorateObj:null,src:null,_lastNonWhitespace:null,_tokens:undefined,_oldPos:0,_pos:0,_ignoreWhitespace:true,_fetches:0,getString:function(t,e){var i="",r=""+t,n=e?'"':"'",s=e?this.stringDoubleQuoteRx:this.stringSingleQuoteRx;while(r){var a=s.exec(r);if(!a)Error("Assertion: cannot match string part (shouldn't happen)");if(a[1]===n){break}if(a[1]){i+=this.unescapes[a[1]]||a[1][1]}else i+=a[0];r=r.slice(a[0].length)}return[i,t.length-r.length]},getRegex:function(t){var e=false;var i=""+t,r="";var n="",s="";var a=false;var o;var l;if(!i||!i[0]==="/")return;r+=i[0];i=i.slice(1);while(i&&!a){o=this.regexTokens.exec(i);if(!o)Error("Assertion - shouldn't happen");if(o[2]){if(o[2]==="["&&!e)e=true;else if(o[2]==="]"&&e)e=false;else if(o[2]==="/"&&!e)a=true}if(!a)n+=o[0];r+=o[0];i=i.slice(o[0].length)}if(!a)return;if(a){o=this.regexFlags.exec(i);if(o){r+=o[0];s=o[0];i=i.slice(o[0])}}try{l=new RegExp(n,s)}catch(t){throw{msg:"Cannot parse regex: "+t,origException:t,pos:0}}return new Amm.Expression.Token(r,Amm.Expression.Token.Type.REGEXP,l)},getToken:function(t,e){e=e||this._lastNonWhitespace;var i=this.tokensRx.exec(t),r,n;if(!i){Error("Assertion: match next token (shouldn't happen)")}if(i[1])r=Amm.Expression.Token.Type.WHITESPACE;else if(i[2]){if(i[2]==='"'||i[2]==="'"){var s=this.getStringConstantToken(t);if(s){return s}}else if(i[2]==="/"){if(!e||this.regexPossible(e)){var a=this.getRegex(t);if(a)return a}}r=Amm.Expression.Token.Type.SYMBOL}else if(i[3])r=Amm.Expression.Token.Type.WORD;else if(i[4]){r=Amm.Expression.Token.Type.INTEGER;if(i[4][0]==="0"&&(i[4][1]!=="x"&&i[4][1]!=="X"))n=parseInt(i[4],8);else n=parseInt(i[4])}else if(i[5]){r=Amm.Expression.Token.Type.FLOAT;n=parseFloat(i[5])}else if(i[6])r=Amm.Expression.Token.Type.ILLEGAL;var o=new Amm.Expression.Token(i[0],r,n);return o},regexPossible:function(t){var e=false;if(t.type===Amm.Expression.Token.Type.SYMBOL)e=true;return e},getStringConstantToken:function(t,e){var e=t[0];var i=t.slice(1);if(e!=="'"&&e!=='"'||!i.length)return;var r=e==='"';var n=this.getString(i,r);var s=false;i=i.slice(n[1]);if(i[0]===e){s=true;i=i.slice(1)}if(!s){throw{message:"Unmatched "+(r?"double":"single")+" quote",pos:t.length-i.length,string:t}}var a=r?Amm.Expression.Token.Type.DOUBLE_QUOTED_STRING:Amm.Expression.Token.Type.SINGLE_QUOTED_STRING;var o=new Amm.Expression.Token(t.slice(0,t.length-i.length),a,n[0]);return o},getAllTokens:function(t){var e=0;var i=""+t,r=[];var n;this._lastNonWhitespace=null;while(i.length){try{var s=this.getToken(i);s.offset=e;if(!s.string.length)Error("WTF");i=i.slice(s.string.length);e+=s.string.length;r.push(s);if(s.type!==Amm.Expression.Token.Type.WHITESPACE){this._lastNonWhitespace=s}}catch(n){if(n.pos){n.pos+=t.length-i.length;n.string=t}else{n={message:n,pos:t.length-i.length,string:t}}throw n}}return r},begin:function(t){this._tokens=this.getAllTokens(t);this._pos=-1;this._fetches=0},_binaryPriority:[["||"],["&&"],["!==","===","!=","=="],[">","<",">=","<="],["+","-"],["*","/","%"],["instanceof"]],genOp:function(t,e){var i=Array.prototype.slice.apply(arguments);var r;if(this.genFn){r=this.genFn.apply(this.genObj||this,i)}else{r=i}if(this.decorateFn){var n=this._oldPos+1;var s=this._tokens.slice(n,this._pos+1);if(s.length){var a=s[s.length-1];var o=0;if(this._ignoreWhitespace){while(s[o].type===Amm.Expression.Token.Type.WHITESPACE){o++}}var l=s[o];var h=l.offset;var u=a.offset+a.string.length;this.decorateFn.call(this.decorateObj||this,r,h,u,this.src,s.slice(o))}}return r},parseExpression:function(){return this.parsePart("Conditional")},parseConditional:function(){var t,e,i;t=this.parsePart("Binary");if(!t)return;var r=this.fetch();if(r&&r.isSymbol("?")){e=this.parsePart("Expression");if(!e)Error("Expected: expression");r=this.fetch();if(r&&r.isSymbol(":")){i=this.parsePart("Expression");if(!i)Error("Expected: expression");return this.genOp("Conditional",t,e,i)}else{Error("Expected: ':'")}}else{if(r)this.unfetch()}return t},parseBinary:function(t){if(!t)t=0;if(t>=this._binaryPriority.length){return this.parsePart("Unary")}var e,i,r;e=this.parsePart("Binary",t+1);var n=this.fetch();if(!n)return e;if(n.isSymbol(this._binaryPriority[t])){i=n;r=this.parsePart("Binary",t);if(!r)Error("Expected: binary "+this._binaryPriority[t].join(", ")+" operand");return this.genOp("Binary",e,i.string,r)}this.unfetch();return e},parseUnary:function(){var t=this.fetch();if(!t)return;if(t.isSymbol("!","-","!!","typeof")){var e=this.parsePart("Unary");if(!e)Error("Expected: unary");return this.genOp("Unary",t.string,e)}else{this.unfetch();return this.parsePart("New")}},parseList:function(){var t=[],e;e=this.parsePart("Expression");if(!e)return;t.push(e);do{var i=this.fetch();if(i.isSymbol(",")){e=this.parsePart("Expression");if(!e)Error("Expected: expression");t.push(e)}else{this.unfetch();break}}while(1);return this.genOp("List",t)},parseNew:function(){var t=this.fetch();if(!t.isSymbol(Amm.Expression.Token.Keyword.NEW)){this.unfetch();return this.parsePart("Item")}var e=this.parseNew();if(!e)e=this.parsePart("Item");if(!e)throw Error("Expected: new or value");return this.genOp("New",e)},parseItem:function(){var t=this.parsePart(true,"Value");var e=this.parsePart(true,"AccessOperator",t);if(e)return e;return t},parseAccessOperator:function(t){var e;e=this.parsePart(true,"FunctionCall",t)||this.parsePart(true,"PropertyAccess",t)||this.parsePart(true,"ComponentElement",t)||this.parsePart(true,"Range",t);if(e){var i=this.parsePart(true,"AccessOperator",e);if(i)return i;return e}},parseFunctionCall:function(t){var e=this.fetch();if(!e)return;if(!e.isSymbol("(")){this.unfetch();return}var i=this.parsePart("List")||[];e=this.fetch();if(!e||!e.isSymbol(")"))Error("Expected: ')'");var r=this.parsePart("CacheabilityModifier");return this.genOp("FunctionCall",t,i,r===undefined?null:r)},parsePropertyAccess:function(t){var e=this.fetch();var i;var r=false;var n=null;var s=null;if(!e)return;if(e.isSymbol(".")){var a=this._oldPos;this._oldPos=this._pos;var e=this.fetch();if(e&&e.isIdentifier()){i=this.genOp("Constant",e.string)}else{this._oldPos=a;Error("Expected: identifier")}this._oldPos=a}else{this.unfetch();i=this.parsePart("Subexpression");if(i)r=true;else return}n=this.parsePart("PropertyArgs");s=this.parsePart("CacheabilityModifier");return this.genOp("PropertyAccess",t,i||null,n||null,r,s||null)},parseCacheabilityModifier:function(){var t=this.fetch();if(!t)return;if(t.isSymbol("!!","??"))return this.genOp("CacheabilityModifier",t.string);this.unfetch()},parseSubexpression:function(){var t=this.fetch();if(!t)return;if(!t.isSymbol("[")){this.unfetch();return}var e=this.parsePart("Expression");if(!e)Error("Expected: expression");var t=this.fetch();if(!t||!t.isSymbol("]"))Error("Expected: ']'");return this.genOp("Subexpression",e)},parsePropertyArgs:function(){var t=this.fetch();if(!t)return;if(!t.isSymbol("::")){this.unfetch();return}var e=false;var i=[],r;do{t=this.fetch();if(!t)break;if(t.isSymbol("{")){i=this.parsePart("List");if(!i)Error("Expected: list");t=this.fetch();if(!t||!t.isSymbol("}"))Error("Expected: '}'");e=true;break}else if(t.isSymbol("::")){r=this.genOp("Constant",undefined)}else if(t.isIdentifier()){r=this.genOp("Constant",t.string)}else if(t.isConstant()){r=this.genOp("Constant",t.value)}else{this.unfetch();break}i.push(r)}while(true);if(!e&&!i.length)i=[undefined];return this.genOp("PropertyArgs",i,e)},parseComponentElement:function(t){var e=this.fetch();if(!e)return;if(!e.isSymbol("->")){this.unfetch();return}var i=undefined;var r=false;e=this.fetch();if(!(e&&(e.isSymbol("{","[")||e.isIdentifier())))Error("Expected: identifier, subexpression or range");if(e.string==="{"){r=true}if(!e.isIdentifier())this.unfetch();if(!r&&e.isIdentifier()){i=this.genOp("Constant",e.string)}else{if(!r){i=this.parsePart("Subexpression");if(!i){Error("Expected: subexpression")}}}var n=this.genOp("ComponentElement",t,i,null);var s=this.parsePart("Range",n);return s||n},parseLoopIdentifiers:function(){var t=this.parsePart("Variable",true);var e;if(!t)return;var i=this.fetch();if(!i)return;if(i.isSymbol("=>")){e=t;i=this.fetch();if(i.isSymbol(":")){t=null}else{this.unfetch();t=this.parsePart("Variable",true);if(!t)Error("Expected: variable");i=this.fetch();if(!i||!i.isSymbol(":"))Error("Expected: ':'")}return this.genOp("LoopIdentifiers",t,e)}else if(i.isSymbol(":")){return this.genOp("LoopIdentifiers",t,null)}else{this.unfetch();if(t){this.unfetch();this.unfetch()}}},parseRange:function(t){var e=this.fetch();if(!e)return;if(!e.isSymbol("{")){this.unfetch();return}var e=this.fetch();var i,r=null,n=null;if(e.isSymbol("*")){i="All"}else if(e.isConstant()&&e.type===Amm.Expression.Token.Type.INTEGER){i="Index";r=this.genOp("Constant",e.value)}else if(e.isConstant()&&e.type===Amm.Expression.Token.Type.REGEXP){i="RegExp";r=this.genOp("Constant",e.value)}else{if(e.isSymbol("..")){i="Slice";r=null;e=this.fetch();if(e.isSymbol("}")){n=null;this.unfetch()}else{this.unfetch();n=this.parsePart("Expression")}}else{this.unfetch();var s=this.parsePart("LoopIdentifiers");var r=this.parsePart("Expression");if(!r){Error("Expected: expression")}if(s){i="Condition";n=s}else{e=this.fetch();if(e.isSymbol("..")){i="Slice";n=this.parsePart("Expression")}else{this.unfetch();i="Index"}}}}e=this.fetch();if(!e||!e.isSymbol("}"))Error("Expected: '}'");return this.genOp("Range",i,t,r,n)},parseVariable:function(t){var e=this.fetch();if(!e)return;if(e.isSymbol("$")){e=this.fetch();if(e&&e.isIdentifier()){if(t)return this.genOp("Constant",e.string);return this.genOp("Variable",e.string)}else{Error("Expected: identifier")}}else{this.unfetch()}},parseValue:function(){var t=this.parsePart("Variable");if(t)return t;var e=this.fetch();if(e.isSymbol("(")){var i=this.parsePart("Expression");if(!i)Error("Expected: expression");e=this.fetch();if(!e||!e.isSymbol(")"))Error("Expected: ')'");return this.genOp("Parenthesis",i)}if(e.isConstant()){return this.genOp("Constant",e.value)}if(e.isIdentifier()){var r=e.string.toLowerCase();if(r==="true")return this.genOp("Constant",true);if(r==="false")return this.genOp("Constant",false);if(r==="null")return this.genOp("Constant",null);if(r==="undefined")return this.genOp("Constant",undefined);return this.genOp("Identifier",e.string)}this.unfetch()},unfetch:function(){return this.fetch(false,true)},fetch:function(t,e){if(this._fetches++>1e4)Error("Guard: too much fetches (TODO: remove)");if(!this._tokens)return null;var i=null,r=e?-1:1,n=this._pos;do{i=this._tokens[n+r]||null;if(i||e)n=n+r}while(i&&(this._ignoreWhitespace&&i.type===Amm.Expression.Token.Type.WHITESPACE));if((i||e)&&!t)this._pos=n;return i},parsePart:function(t,e){var i=Array.prototype.slice.call(arguments,1);var r;var n=false;if(t===true){n=true;t=i.shift()}if(!t)Error("`part` is required to be non-empty string");var s="parse"+t;if(typeof this[s]!=="function")Error("Amm.Expression.Parser: no such method: '"+s+"'");if(t==="Part")Error("WTF");var a=this._oldPos;if(!n)this._oldPos=this._pos;if(!i.length){r=this[s]()}else if(i.length===1){r=this[s](i[0])}else{r=this[s].apply(this,i)}if(!n)this._oldPos=a;return r},parse:function(t){var e;this.src=t;this._oldPos=0;this.begin(t);e=this.parsePart("Expression");var i=this.fetch();if(i)Error("Expected: eof");return e}};Amm.Expression.Builder=function(){};Amm.Expression.Builder.prototype={build:function(t,e){var i=Array.prototype.slice.call(arguments,1);var r=t;if(!this[r])throw Error("Uknown/unsupported lexeme: "+r);return this[r].apply(this,i)},decorate:function(t,e,i,r,n){if(t&&t["Amm.Operator"]){t.beginPos=e;t.endPos=i}},configureParser:function(t){t.genFn=this.build;t.genObj=this;t.decorateFn=this.decorate;t.decorateObj=this},const:function(t){if(t&&t.Const)return t;return{Const:true,const:t}},unConst:function(t,e){if(t&&t.Const)return t.const;if(e&&t instanceof Array){var i=[];for(var r=0,n=t.length;r<n;r++){i.push(this.unConst(t[r]))}return i}return t},Identifier:function(t){if(t==="this"){return new Amm.Operator.ExpressionThis}if(t==="root"){return new Amm.getRoot}return new Amm.Operator.ScopeElement(new Amm.Operator.ExpressionThis,this.unConst(t))},Conditional:function(t,e,i){return new Amm.Operator.Conditional(this.unConst(t),this.unConst(e),this.unConst(i))},binaryFn:function(t,e,i){switch(e){case"!==":return t!==i;case"===":return t===i;case"==":return t===i;case"!=":return t!=i;case"+":return t+i;case"-":return t-i;case"*":return t*i;case"/":return t/i;case"%":return t%i;case">":return t>i;case"<":return t<i;case"<=":return t<=i;case">=":return t>=i}throw Error("Unknown operator: "+e)},Binary:function(t,e,i){if(t&&t.Const&&i&&i.Const){return this.const(this.binaryFn(this.unConst(t),e,this.unConst(i)))}return new Amm.Operator.Binary(this.unConst(t),this.unConst(e),this.unConst(i))},Unary:function(t,e){if(e.Const){if(t==="!")return this.const(!this.unConst(e));else if(t==="-")return this.const(-this.unConst(e));else if(t==="!!")return this.const(!!this.unConst(e));else if(t==="typeof")return typeof this.unConst(e);else throw Error("Unknown unary operator: '"+t+"'")}else{return new Amm.Operator.Unary(t,this.unConst(e))}},List:function(t){return new Amm.Operator.List(this.unConst(t,true))},Constant:function(t){return this.const(t)},FunctionCall:function(t,e,i){if(t&&t["Amm.Operator.Property"]&&!t.hasArguments()){t.promoteToCall(e,i);return t}return new Amm.Operator.FunctionCall(this.unConst(t),e,i)},New:function(t){if(t&&t["Amm.Operator.Property"]&&!t._parenthesis&&t.getIsCall()){t.promoteToNew();return t}if(t&&t["Amm.Operator.FunctionCall"]&&!t._parenthesis){t._isNew=true;return t}return new Amm.Operator.FunctionCall(this.unConst(t),null,true,true)},PropertyAccess:function(t,e,i,r,n){return new Amm.Operator.Property(this.unConst(t),this.unConst(e),this.unConst(i),n)},CacheabilityModifier:function(t){return t==="!!"?true:false},Subexpression:function(t){return t},Parenthesis:function(t){if(t["Amm.Operator"]){t._parenthesis=true}return t},Variable:function(t){return new Amm.Operator.Var(t)},PropertyArgs:function(t,e){return this.unConst(t,true)},ComponentElement:function(t,e,i){return new Amm.Operator.ComponentElement(this.unConst(t),this.unConst(e),this.unConst(i),false,e===undefined)},LoopIdentifiers:function(t,e){return{keyVar:e,valueVar:t}},Range:function(t,e,i,r){var n=e&&(e["Amm.Operator.ComponentElement"]||e["Amm.Operator.ScopeElement"]);var s;if(t==="All"){if(n){e._setOperand("range","*");s=e}else{s=new Amm.Operator.Range.All(this.unConst(e))}}else if(t==="Index"){if(n){e._setOperand("range",this.unConst(i));s=e}else{s=new Amm.Operator.Range.Index(this.unConst(e),this.unConst(i))}}else if(t==="RegExp"){s=new Amm.Operator.Range.RegExp(this.unConst(e),this.unConst(i))}else if(t==="Slice"){s=new Amm.Operator.Range.Slice(this.unConst(e),this.unConst(i),this.unConst(r))}else if(t==="Condition"){s=new Amm.Operator.Range.Condition(this.unConst(e),this.unConst(i),this.unConst(r.keyVar),this.unConst(r.valueVar))}else{Error("Uknown range type: '"+t+"'")}if(n){if(!e._rangeOperator&&e._rangeValue===null){e._setOperand("range","*")}}return s}};Amm.Remote.Mapper=function(t){this.patterns=[]};Amm.Remote.Mapper.prototype={setPatterns:function(t){}};Amm.Remote.Uri=function(t){if(t===null||t===undefined){t=""}if(typeof t==="string"){t={uri:t}}else if(t&&t["Amm.Remote.Uri"]){this._clone(t);t=undefined}else if(t&&typeof[t.toString]==="function"){t={uri:t.toString()}}else{if(t.uri){t=Amm.override({},t);this.setUri(t.uri);delete t.uri}}Amm.WithEvents.call(this,t)};Amm.Remote.Uri.PART_SCHEME="SCHEME";Amm.Remote.Uri.PART_USER="USER";Amm.Remote.Uri.PART_PASSWORD="PASSWORD";Amm.Remote.Uri.PART_HOST="HOST";Amm.Remote.Uri.PART_PORT="PORT";Amm.Remote.Uri.PART_PATH="PATH";Amm.Remote.Uri.PART_QUERY="QUERY";Amm.Remote.Uri.PART_FRAGMENT="FRAGMENT";Amm.Remote.Uri._current=null;Amm.Remote.Uri.getCurrent=function(){if(Amm.Remote.Uri._current){return new Amm.Remote.Uri(Amm.Remote.Uri._current)}if(window.location&&window.location.href){return new Amm.Remote.Uri(window.location.href)}};Amm.Remote.Uri.setCurrent=function(t){if(t)Amm.Remote.Uri._current=new Amm.Remote.Uri(""+t);else Amm.Remote.Uri._current=null};Amm.Remote.Uri._const={SCHEME:"_scheme",USER:"_user",PASSWORD:"_pass",HOST:"_host",PORT:"_port",PATH:"_path",QUERY:"_query",FRAGMENT:"_fragment"};Amm.Remote.Uri.prototype={"Amm.Remote.Uri":"__CLASS__",RequestProvider:"__INTERFACE__",_scheme:null,_user:null,_pass:null,_host:null,_port:null,_path:null,_query:null,_fragment:null,_uri:null,_updateLevel:0,_oldUri:null,_strQuery:null,setUri:function(t,e){if(e===undefined||e===null||e===""){if(t&&t["Amm.Remote.Uri"]){this._clone(t)}else{this._parse(t)}return}if(Amm.Remote.Uri._const[e]){this.beginUpdate();if(e==="QUERY"&&typeof t!=="object"){this._strQuery=t||"";this._query=this._parseQuery(t)}else this[Amm.Remote.Uri._const[e]]=""+t;this.endUpdate();return}this.beginUpdate();var i={};this._query=Amm.Util.setByPath(this._query,Amm.Util.pathToArray(e),t,i);if(i.changed)this._strQuery=null;this.endUpdate()},getUri:function(t,e){if(!t){if(this._uri!==null)return this._uri;return this._build()}if(e&&t===Amm.Remote.Uri.PART_QUERY){if(this._strQuery===null){this._strQuery=this._buildQuery(this._query,"",true)}return this._strQuery}if(Amm.Remote.Uri._const[t])return this[Amm.Remote.Uri._const[t]];return Amm.Util.getByPath(this._query,Amm.Util.pathToArray(t))},setUriOverrides:function(t){if(!t)return;if(typeof t!=="object")throw Error("uriOverrides must be an object");var e=t?Amm.override({},t):{};this.beginUpdate();for(var i in e)if(e.hasOwnProperty(i)){if(Amm.Remote.Uri._const[i]){this.setUri(e[i],i);delete e[i]}}if(!this._query)this._query={};Amm.overrideRecursive(this._query,e);this.endUpdate()},_clone:function(t){if(this._subscribers)this.beginUpdate();for(var e in Amm.Remote.Uri._const){if(Amm.Remote.Uri._const.hasOwnProperty(e)){this[Amm.Remote.Uri._const[e]]=t[Amm.Remote.Uri._const[e]]}this._strQuery=t._strQuery;this._uri=null}if(this._subscribers)this.endUpdate()},outRequestChangeNotify:function(){return this._out("requestChangeNotify",this)},outUriChange:function(t,e){return this._out("uriChange",t,e)},produceRequest:function(){return new Amm.Remote.ConstRequest({uri:this.getUri(),method:Amm.Remote.ConstRequest.METHOD_GET})},beginUpdate:function(){if(!this._updateLevel){this._oldUri=this.getUri()}this._updateLevel++},endUpdate:function(){if(!this._updateLevel){throw Error("call to endUpdate() without prior beginUpdate()")}this._updateLevel--;if(this._updateLevel)return;var t=this._build(),e=this._oldUri;this._oldUri=null;if(t!==e){this.outUriChange(t,e);this.outRequestChangeNotify()}},_isSimpleNumArray:function(t,e){if(!(t instanceof Array))return false;var i="";for(var r=0,n=t.length;r<n;r++){if(!(r in t)||t[r]===undefined||typeof t[r]==="object")return false;i+="&"+e+"[]="+encodeURIComponent(t[r])}return i},_buildQuery:function(t,e,i){var r="",n,s;if(t===undefined)return"";if((s=this._isSimpleNumArray(t,e))!==false){r=s}else if(t instanceof Array){if(t.length){for(n=0;n<t.length;n++){r=r+this._buildQuery(t[n],e?e+"["+n+"]":n)}}else{r="&"+e+"="}}else{if(typeof t==="object"){for(n in t)if(t.hasOwnProperty(n)){r=r+this._buildQuery(t[n],e?e+"["+n+"]":n)}}else{r="&"+e+"="+encodeURIComponent(t)}}if(i&&r.length)r=r.slice(1);return r},_parseQuery:function(t,e,i){if(t===null||t===undefined)return null;if(!t.length)return{};if(e===undefined)e="&";if(i===undefined)i="=";var r=t.split(e),n=r.length,s=[];for(var a=0;a<n;a++){var o=r[a].split(i,2),l=o[0].replace("]","");l=l.replace(/\]/g,"").split("[");if(o.length<2)o.push("");s=Amm.Util.setByPath(s,l,o[1])}return s},toString:function(){return this.getUri()},_parse:function(t){t=""+t;if(t[0]==="m"&&t[6]===":")t=t.replace(/^mailto:/,"mailto://");this.beginUpdate();var e=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?(((\/?(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;var i=[".source","_scheme",".authority",".userInfo","_user","_pass","_host","_port",".relative","_path",".directory",".file","_strQuery","_fragment"];var r={};var n=e.exec(t);for(var s=i.length-1;s>=0;s--){var a=i[s];if(a[0]!=="."){if(n[s]===undefined)this[a]=null;else this[a]=n[s]}r[a]=n[s]}this._query=this._parseQuery(this._strQuery);this.endUpdate()},_build:function(t){if(t===undefined)t=true;var e="",i;if(this._scheme)e+=this._scheme+":";if(this._host){if(this._scheme!=="mailto")e+="//";if(this._user||this._pass){e+=this._user;if(this._pass)e+=":"+this._pass;e+="@"}e+=this._host;e+=this._port?":"+this._port:""}if(this._path){if(e&&this._path[0]!=="/")e+="/";e+=this._path}if(t&&this._query){if(this._strQuery!==null)i=this._strQuery;else{i=this._buildQuery(this._query,"",true);this._strQuery=i}e+="?"+i}if(this._fragment!==null)e+="#"+this._fragment;if(t)this._uri=e;return e},isFullyQualified:function(){return this._scheme&&this._host},isRelative:function(){return this._path&&this._path[0]!=="/"},resolve:function(t){var e,i,r;if(this.isFullyQualified())return new Amm.Remote.Uri(this);if(!t)t=Amm.Remote.Uri.getCurrent();if(t["Amm.Remote.Uri"])e=t;else e=new Amm.Remote.Uri(t);if(this.getUri()===""){i=new Amm.Remote.Uri(e);i._fragment="";return i}else if(this.getUri().charAt(0)==="#"){i=new Amm.Remote.Uri(e);i.setUri(this._fragment,Amm.Remote.Uri.PART_FRAGMENT);return i}i=new Amm.Remote.Uri(this);if(!i._scheme)i._scheme=e._scheme;if(!i._host)i._host=e._host;if(i._path&&i._path.charAt(0)==="/"){return i}r=e._path;if(!i._path){i._path=r;return i}r=r.replace(/\/[^/]*$/,"").replace(/\/{2,}/,"/")+"/"+i._path.replace(/^\//,"");if(!r.match(/(^|\/)\.\.?(\/|)/)){i._path=r;return i}var n,s;r=r.split("/");s=0;while(s<r.length){n=r[s];if(n==="."||n===""){r.splice(s,1);continue}if(n!==".."){s++;continue}if(s>1){r.splice(s-1,2);s--;continue}r.splice(s,1)}r="/"+r.join("/");i._path=r;return i}};Amm.extend(Amm.Remote.Uri,Amm.WithEvents);Amm.Remote.RequestProducer=function(t){this._data={};Amm.Remote.Uri.call(this,t)};Amm.Remote.RequestProducer._allowedMethods={GET:"Amm.Remote.ConstRequest.METHOD_GET",POST:"Amm.Remote.ConstRequest.METHOD_POST",PUT:"Amm.Remote.ConstRequest.METHOD_PUT",DELETE:"Amm.Remote.ConstRequest.METHOD_DELETE",PATCH:"Amm.Remote.ConstRequest.METHOD_PATCH",HEAD:"Amm.Remote.ConstRequest.METHOD_HEAD",CONNECT:"Amm.Remote.ConstRequest.METHOD_CONNECT",OPTIONS:"Amm.Remote.ConstRequest.METHOD_OPTIONS"},Amm.Remote.RequestProducer.prototype={"Amm.Remote.RequestProducer":"__CLASS__",_method:"GET",_data:null,setMethod:function(t){t=(""+t).toUpperCase();if(!(t in Amm.Remote.RequestProducer._allowedMethods)){throw Error("Invalid 'method' value '"+t+"'; allowed values are "+Amm.keys(Amm.Remote.RequestProducer._allowedMethods).join("|"))}var e=this._method;if(e===t)return;this._method=t;this.outMethodChange(t,e);this.outRequestChangeNotify();return true},getMethod:function(){return this._method},outMethodChange:function(t,e){this._out("methodChange",t,e)},produceRequest:function(){var t={uri:this.getUri(),method:this._method};if(this._data)t.data=this._data;return new Amm.Remote.ConstRequest(t)},setData:function(t,e){var i;if(e===undefined){if(t===undefined||t===false)t=null;if(t===this._data)return;i=this._data?Amm.override({},this._data):this._data;if(JSON.stringify(i)===JSON.stringify(t))return;this._data=t}else{if((t===undefined||t===null)&&this._data===null)return;var r=Amm.Util.pathToArray(e);var n={};i=this._data?Amm.override({},this._data):this._data;if(!this._data)this._data={};Amm.Util.setByPath(this._data,r,t,n);var s=false;for(var a in this._data)if(this._data.hasOwnProperty(a)){s=true}if(!s)this._data=null;if(this._data===i)return;if(!n.changed)return}this.outDataChange(t,i);this.outRequestChangeNotify();return true},getData:function(t){if(t===undefined)return this._data;if(!this._data)return undefined;var e=Amm.Util.pathToArray(t);return this._getByPath(this._data,e)},setDataOverrides:function(t){if(!t)return;if(typeof t!=="object")throw Error("dataOverrides must be an object");var e=Amm.overrideRecursive({},this._data);Amm.overrideRecursive(e,t);this.setData(e)},outDataChange:function(t,e){return this._out("dataChange",t,e)}};Amm.extend(Amm.Remote.RequestProducer,Amm.Remote.Uri);Amm.Remote.Transport=function(t){Amm.init(this,t)};Amm.Remote.Transport._default=null;Amm.Remote.Transport.getDefault=function(){if(!this._default)this._default=new Amm.Remote.Transport.JqXhr;return this._default};Amm.Remote.Transport.setDefault=function(t){if(!t)t=null;else Amm.is(t,"Amm.Remote.Transport","defaultTransport");this._default=t};Amm.Remote.Transport.prototype={"Amm.Remote.Transport":"__CLASS__",_history:null,_historySize:null,setHistorySize:function(t){var e=this._historySize;if(e===t)return;this._historySize=t;if(!this._historySize){this._history=null;return true}if(!this._history)this._history=[];else if(this._history.length>this._historySize){this._history.splice(this._historySize,this._history.length-this._historySize)}return true},getHistorySize:function(){return this._historySize},getHistory:function(){this._history?[].concat(this._history):[]},_push:function(t){this._history.unshift(t);if(this._history.length>this._historySize)this._history.pop()},makeRequest:function(t,e,i,r){var n=new Amm.Remote.RunningRequest(t,e,i,r,this);this._doPrepareRunningRequest(n,t,e,i,r);if(this._historySize)this._push(n);return n},abortRunningRequest:function(t){this._doAbortRunningRequest(t)},_doPrepareRunningRequest:function(t,e,i,r,n){}};Amm.Remote.Transport.JqXhr=function(t){Amm.Remote.Transport.call(this,t)};Amm.Remote.Transport.JqXhr.prototype={"Amm.Remote.Transport.JqXhr":"__CLASS__",_doPrepareRunningRequest:function(t,e,i,r,n){var s=e.getJqXhrOptions();s.context=t;var a=jQuery.ajax(e.getUri(),s).done(t.success).fail(this._failure);t.setExtra(a)},_failure:function(t,e,i){this.failure(e,i,this.getExtra().status,t)},_doAbortRunningRequest:function(t){t.getExtra().abort()}};Amm.extend(Amm.Remote.Transport.JqXhr,Amm.Remote.Transport);Amm.Remote.Transport.JqXhr.parseResponseHeaders=function(t){var e=t.split(/[\n\r]+/);var i={},r,n;for(var s=0;s<e.length;s++){e[s]=e[s].replace(/(^\s+)|(\s+$)/g,"");if(!e[s].length)continue;var a=e[s].match(/^([^:]+)\s*:\s*(.*)$/);if(!a){r="";n=e[s]}else{r=a[1].toLowerCase().replace(/(^\s+)|(\s+$)/g,"");n=a[2]}if(!i[r]){i[r]=n;continue}else if(typeof i[r]!=="Array")i[r]=[i[r]];i[r].push(n)}return i};Amm.Remote.Transport.Debug=function(t){Amm.Remote.Transport.call(this,{});Amm.WithEvents.call(this,t);var r=this;this._successClosure=function(t,e){return r.success.apply(r,Array.prototype.slice.call(arguments))};this._failureClosure=function(t,e,i){return r.failure.apply(r,Array.prototype.slice.call(arguments))}};Amm.Remote.Transport.Debug.prototype={"Amm.Remote.Transport.Debug":"__CLASS__",eventTime:0,replyTime:10,_pendingSuccess:null,_pendingFailure:null,_request:null,_successClosure:null,_failureClosure:null,reply:function(e,i,t,r){this._pendingSuccess=null;this._pendingFailure=null;if(e.getAborted())return;if(t===undefined||t===null)t=this.replyTime;var n=Array.prototype.slice.call(arguments,3);var s=function(){var t=i?e.success:e.failure;t.apply(e,n)};if(t>0){e._timeout=window.setTimeout(s,this.replyTime)}else{s()}this._request=null},success:function(t,e,i){if(!this._request){this._pendingSuccess=Array.prototype.slice.call(arguments);this._pendingFailure=null;return}if(typeof t==="function")t=t(this._request);var r=Array.prototype.slice.call(arguments);r.splice(2,1);r.unshift(this._request,true,i);this.reply.apply(this,r)},failure:function(t,e,i,r){if(!this._request){this._pendingFailure=Array.prototype.slice.call(arguments);this._pendingSuccess=null;return}var n=Array.prototype.slice.call(arguments);n.splice(3,1);n.unshift(this._request,false,r);this.reply.apply(this,n)},outRequest:function(t,e,i){this._request=t;res=this._out("request",t,e,i);if(this._pendingSuccess){this.success.apply(this,this._pendingSuccess)}else if(this._pendingFailure){this.failure.apply(this,this._pendingFailure)}return res},getRequest:function(){return this._request},outAbortRequest:function(t){return this._out("abortRequest",t)},_doPrepareRunningRequest:function(t,e,i,r,n){var s=this,a=function(){s.outRequest(t,s._successClosure,s._failureClosure)};if(this.eventTime<=0){a()}else{t._timeout=window.setTimeout(a,this.eventTime)}},_doAbortRunningRequest:function(t){if(t._timeout){window.clearTimeout(t._timeout,null);t._timeout=null}this.outAbortRequest(t)}};Amm.extend(Amm.Remote.Transport.Debug,Amm.Remote.Transport);Amm.extend(Amm.Remote.Transport.Debug,Amm.WithEvents);Amm.Remote.MapperPattern=function(t){if(typeof t!=="string"||!t.length)throw Error("`definition` must be non-empty string");this._parseDefinition(t)};Amm.Remote.MapperPattern._parseRx=/([^{}]+)|(\{\w+(\.\.\.)?)|[{}]/g;Amm.Remote.MapperPattern.prototype={definition:null,regex:null,args:null,segments:null,_parseDefinition:function(t){this._definition=t;var e=t.match(Amm.Remote.MapperPattern._parseRx);if(e.join("")!==t){console.log(e,t);throw Error("MapperPattern definition wasn't fully matched")}var i,r,n=0,s;this.regex="";this.args=[];this.segments=[];while((curr=e.shift())!==undefined){s=curr.length;if(curr[0]==="{"){if(i){throw Error("Error at position "+n+" of definition '"+t+"': arguments must be always separated by non-argument string")}if(e[0]==="}"){e.shift();s++}else{throw Error("Unmatched '{' at position "+n+"of definition '"+t+"'")}i=curr.slice(1);if(i.slice(-3)==="..."){r=true;i=i.slice(1,-3)}this.args.push(i);if(r)this.regex+="(.+)";else this.regex+="([-\\w]+)";this.segments.push([i])}else{i=null;this.regex+=Amm.Util.regexEscape(curr);this.segments.push(curr)}n+=s}this.regex="^"+this.regex+"$"},parse:function(t,e){if(!e)e={};if(typeof this.regex==="string")this.regex=new RegExp(this.regex);var i=this.regex.exec(t);if(!i)return false;for(var r=0,n=this.args.length;r<n;r++){e[this.args[r]]=i[r+1]}return true},build:function(t,e){var i,r;for(i=0,r=this.args.length;i<r;i++){var n=t[this.args[i]];if(n===null||n===undefined||n===""||""+n==="")return}var s="";for(i=0,r=this.segments.length;i<r;i++){if(this.segments[i]instanceof Array){s+=""+t[this.segments[i][0]];if(e)delete t[this.segments[i][0]]}else s+=this.segments[i]}return s}};Amm.Remote.Fetcher=function(t){Amm.WithEvents.call(this,t)};Amm.Remote.Fetcher.STATE_CONFIGURING="configuring";Amm.Remote.Fetcher.STATE_IDLE="idle";Amm.Remote.Fetcher.STATE_PREINIT="preinit";Amm.Remote.Fetcher.STATE_STARTED="started";Amm.Remote.Fetcher.STATE_SENT="sent";Amm.Remote.Fetcher.STATE_RECEIVED="received";Amm.Remote.Fetcher.STATE_ERROR="error";Amm.Remote.Fetcher.AUTO_NONE=0;Amm.Remote.Fetcher.AUTO_BOOTSTRAP=1;Amm.Remote.Fetcher.AUTO_ALWAYS=2;Amm.Remote.Fetcher.prototype={"Amm.Remote.Fetcher":"__CLASS__",_requestProducer:null,_requestProducerIsOwn:false,_response:undefined,_state:Amm.Remote.Fetcher.STATE_CONFIGURING,_error:null,_auto:Amm.Remote.Fetcher.AUTO_NONE,_firstDelay:10,_throttleDelay:500,_timeout:null,_waitingForBootstrap:false,_constRequest:null,_runningRequest:null,_starting:0,_gotResultOnStart:false,_prevRequest:null,_timeoutCallback:null,_transport:null,_poll:false,_detectChanges:true,_lastResponseJson:undefined,_lastErrorJson:undefined,run:function(){this._doRequest()},setRequestProducer:function(t){var e=this._requestProducer;if(e===t)return;if(e){e.unsubscribe("requestChangeNotify",this._requestChangeNotify,this);if(this._requestProducerIsOwn)e.cleanup()}if(typeof t==="string")t=new Amm.Remote.RequestProducer(t);if(!t)t=null;else if(typeof t==="object"&&!Amm.getClass(t)){t=Amm.constructInstance(t,"Amm.Remote.RequestProducer",undefined,false,"RequestProvider");this._requestProducerIsOwn=true}else{Amm.meetsRequirements(t,"RequestProvider","request")}this._requestProducer=t;if(t){t.subscribe("requestChangeNotify",this._requestChangeNotify,this)}this.setConstRequest(t.produceRequest());this.outRequestProducerChange(t,e);this._updateState();return true},getRequestProducer:function(){return this._requestProducer},outRequestProducerChange:function(t,e){this._out("requestProducerChange",t,e)},_requestChangeNotify:function(){var t=this._requestProducer.produceRequest();this.setConstRequest(t)},setConstRequest:function(t){if(!t)t=null;var e=this._constRequest;if(e===t)return;this._constRequest=t;this.outConstRequestChange(t,e);this._scheduleAutoRequest();this._updateState();return true},getConstRequest:function(){return this._constRequest},outConstRequestChange:function(t,e){return this._out("constRequestChange",t,e)},setTransport:function(t){if(!t)t=null;else if(typeof t!=="object"||!Amm.getClass(t)){t=Amm.constructInstance(t,"Amm.Remote.Transport")}else Amm.is(t,"Amm.Remote.Transport","transport");var e=this._transport;if(e===t)return;this._transport=t;this.outTransportChange(t,e);return true},outTransportChange:function(t,e){return this._out("transportChange",t,e)},getTransport:function(){return this._transport},_doGetTransport:function(){return this._transport||Amm.Remote.Transport.getDefault()},_runOnBootstrap:function(){if(!this._waitingForBootstrap)return;this._scheduleAutoRequest();this._updateState()},_scheduleAutoRequest:function(t){if(!this._auto){return}if(this._auto===Amm.Remote.Fetcher.AUTO_BOOTSTRAP&&!Amm.getBootstrapped()){Amm.getRoot().subscribe("bootstrap",this._runOnBootstrap,this);this._waitingForBootstrap=true;return}if(!this._constRequest){return}var e=this._runningRequest||t?this._throttleDelay:this._firstDelay;var i=this;if(this._timeout)window.clearTimeout(this._timeout);if(this._runningRequest){this._abort()}if(e>0){if(!this._timeoutCallback){this._timeoutCallback=function(){i._doRequest()}}this._timeout=window.setTimeout(this._timeoutCallback,e)}else{this._timeout=null;this._doRequest()}},_abort:function(){if(!this._runningRequest)return;this._prevRequest=this._runningRequest;this._runningRequest=null;this._prevRequest.abort()},_doRequest:function(){if(!this._constRequest){throw Error("Cannot _doRequest() without _constRequest")}this._waitingForBootstrap=false;if(this._runningRequest)this._abort();if(this._timeout){window.clearTimeout(this._timeout);this._timeout=null}this._starting++;this._runningRequest=this._doGetTransport().makeRequest(this._constRequest,this._requestDone,this._requestFail,this);this._starting--;this.setError(null);if(this._gotResultOnStart){this._prevRequest=this._runningRequest;this._runningRequest=null}this._updateState();return},_requestDone:function(t,e){if(!this._runningRequest&&!this._starting)return;if(this._runningRequest){this._prevRequest=this._runningRequest;this._runningRequest=null}this.setResponse(t)},_requestFail:function(t,e,i){if(!this._runningRequest&&!this._starting)return;if(this._runningRequest){this._prevRequest=this._runningRequest;this._runningRequest=null}this.setError({textStatus:t,errorThrown:e,httpCode:i})},_setState:function(t){var e=this._state;if(e===t)return;this._state=t;this.outStateChange(t,e);return true},getState:function(){return this._state},outStateChange:function(t,e){this._out("stateChange",t,e)},isDataChanged:function(t,e){var i="_last"+e.charAt(0).toUpperCase()+e.slice(1)+"Json";var r=JSON.stringify(t);if(this[i]===r)return false;this[i]=r;return true},setResponse:function(t){var e=this._response;if(e===t)return;if(this._runningRequest)this._abort();if(this._starting)this._gotResultOnStart=true;var i=!this._detectChanges||this.isDataChanged(t,"response");if(i)this._response=t;this._updateState();if(i){this.outResponseChange(t,e);return true}},getResponse:function(){return this._response},outResponseChange:function(t,e){this._out("responseChange",t,e)},setError:function(t){var e=this._error;if(e===t)return;if(this._detectChanges&&!this.isDataChanged(t,"error"))return;if(t){if(this._runningRequest){this._abort()}this.setResponse(undefined)}this._error=t;if(this._starting)this._gotResultOnStart=true;this._updateState();this.outErrorChange(t,e);return true},getError:function(){return this._error},outErrorChange:function(t,e){this._out("errorChange",t,e)},setThrottleDelay:function(t){var e=this._throttleDelay;if(e===t)return;this._throttleDelay=t;this.outThrottleDelayChange(t,e);return true},getThrottleDelay:function(){return this._throttleDelay},outThrottleDelayChange:function(t,e){this._out("throttleDelayChange",t,e)},setFirstDelay:function(t){var e=this._firstDelay;if(e===t)return;this._firstDelay=t;this.outFirstDelayChange(t,e);return true},getFirstDelay:function(){return this._firstDelay},outFirstDelayChange:function(t,e){this._out("firstDelayChange",t,e)},setAuto:function(t){var e=this._auto;if(e===t)return;this._auto=t;this.outAutoChange(t,e);if(t&&this._constRequest)this._scheduleAutoRequest();return true},getAuto:function(){return this._auto},outAutoChange:function(t,e){this._out("autoChange",t,e)},cleanup:function(){this.reset();if(this._requestProducer&&this._requestProducerIsOwn&&this._requestProducer.cleanup){this._requestProducer.cleanup();this._requestProducer=null}Amm.WithEvents.prototype.cleanup.call(this)},reset:function(){if(this._poll)this.setPoll(false);if(this._runningRequest)this._abort();if(this._timeout){window.clearTimeout(this._timeout);this._timeout=null}this.setResponse(undefined);this._updateState()},_updateState:function(){var t;if(this._runningRequest){t=Amm.Remote.Fetcher.STATE_SENT}else if(this._timeout){t=Amm.Remote.Fetcher.STATE_STARTED}else if(this._error){t=Amm.Remote.Fetcher.STATE_ERROR}else if(this._response!==undefined){t=Amm.Remote.Fetcher.STATE_RECEIVED}else if(!this._constRequest){t=Amm.Remote.Fetcher.STATE_CONFIGURING}else if(this._waitingForBootstrap){t=Amm.Remote.Fetcher.STATE_PREINIT}else{t=Amm.Remote.Fetcher.STATE_IDLE}if(this._poll&&(t===Amm.Remote.Fetcher.STATE_IDLE||t===Amm.Remote.Fetcher.STATE_RECEIVED||t===Amm.Remote.Fetcher.STATE_ERROR)){this._scheduleAutoRequest(true)}this._setState(t)},setPoll:function(t){t=!!t;var e=this._poll;if(e===t)return;this._poll=t;this.outPollChange(t,e);if(t)this._scheduleAutoRequest();return true},getPoll:function(){return this._poll},outPollChange:function(t,e){this._out("pollChange",t,e)},setDetectChanges:function(t){t=!!t;var e=this._detectChanges;if(e===t)return;this._detectChanges=t;return true},getDetectChanges:function(){return this._detectChanges}};Amm.extend(Amm.Remote.Fetcher,Amm.WithEvents);Amm.Remote.ConstRequest=function(t){if(!t)return;if(t.uri)this._uri=t.uri;if(t.method)this._method=t.method;if(t.data)this._data=t.data;if(t.headers)this._headers=t.headers;if(t.misc)this._misc=t.misc};Amm.Remote.ConstRequest.METHOD_GET="GET";Amm.Remote.ConstRequest.METHOD_POST="POST";Amm.Remote.ConstRequest.METHOD_PUT="PUT";Amm.Remote.ConstRequest.METHOD_DELETE="DELETE";Amm.Remote.ConstRequest.METHOD_PATCH="PATCH";Amm.Remote.ConstRequest.METHOD_HEAD="HEAD";Amm.Remote.ConstRequest.METHOD_CONNECT="CONNECT";Amm.Remote.ConstRequest.METHOD_OPTIONS="OPTIONS";Amm.Remote.ConstRequest.prototype={ConstRequest:"__INTERFACE__",_uri:undefined,_method:undefined,_data:null,_headers:undefined,_misc:undefined,getUri:function(){return this._uri},getMethod:function(){return this._method},getData:function(){return this._data},getHeaders:function(){return this._headers},getMisc:function(){return this._misc},getJqXhrOptions:function(){var t={};if(this._misc&&typeof this._misc==="object")Amm.override(t,this._misc);if(this._data)t.data=this._data;if(this._headers)t.headers=this._headers;if(this._method)t.method=this._method;return t},getAll:function(){var t=this.getJqXhrOptions();if(this._uri)t.uri=this._uri;return t}};Amm.Remote.RunningRequest=function(t,e,i,r,n,s){this._constRequest=t;this._success=e;this._failure=i;this._scope=r;this._transport=n;this._extra=s};Amm.Remote.RunningRequest.ERROR_TIMEOUT="timeout";Amm.Remote.RunningRequest.ERROR_SERVER_ERROR="error";Amm.Remote.RunningRequest.ERROR_ABORT="abort";Amm.Remote.RunningRequest.ERROR_PARSER_ERROR="parsererror";Amm.Remote.RunningRequest.prototype={"Amm.Remote.RunningRequest":"__CLASS__",_constRequest:null,_success:null,_failure:null,_scope:null,_transport:null,_extra:undefined,_finished:false,_result:null,_error:null,getConstRequest:function(){return this._constRequest},getSuccess:function(){return this._success},getFailure:function(){return this._failure},getScope:function(){return this._scope},getTransport:function(){return this._transport},getExtra:function(){return this._extra},setExtra:function(t){if(this._extra===t)return;if(this._extra!==undefined)throw Error("Cant setExtra() only once");this._extra=t},getFinished:function(){return this._finished},success:function(t,e){this._result=Array.prototype.slice.call(arguments);if(!this._finished){this._finished=1}if(!this._success)return;return this._success.apply(this._scope||window,this._result)},failure:function(t,e,i){this._error=Array.prototype.slice.call(arguments);if(!this._finished){this._finished=-1}if(!this._failure)return;return this._failure.apply(this._scope||window,this._error)},abort:function(){this._transport.abortRunningRequest(this);this._finished=-3},getRunning:function(){return!this._finished},getAborted:function(){return this._finished===-3}};Amm.Operator.ScopeElement=function(t,e,i,r,n){this._isEvaluating++;Amm.Operator.call(this);this._componentOnly=r;if(t!==undefined)this._setOperand("origin",t);if(e!==undefined)this._setOperand("id",e);if(i!==undefined)this._setOperand("range",i);if(n!==undefined)this._allElements=!!n;this._isEvaluating--};Amm.Operator.ScopeElement.prototype={"Amm.Operator.ScopeElement":"__CLASS__",_componentOnly:false,_allElements:false,_originOperator:null,_originValue:null,_originExists:null,_idOperator:null,_idValue:null,_idExists:null,_rangeOperator:null,_rangeValue:null,_rangeExists:null,_component:null,OPERANDS:["origin","id","range"],STATE_SHARED:{_componentOnly:true},supportsAssign:false,getReportsContentChanged:function(){return true},_originEvents:function(t,e){if(e&&e["Amm.Element"]){this._unsub(e,"closestComponentChange")}if(t&&t["Amm.Element"]){this._sub(t,"closestComponentChange",this._originComponentChange)}},_originChange:function(t){if(t&&t["Amm.Element"])this._setComponent(t.getClosestComponent())},_originComponentChange:function(t){this._setComponent(t)},_rangeChange:function(t){this._checkArrayChange=t==="*"},_setComponent:function(t){if(!t)t=null;var e=this._component;if(e===t)return;if(e){this._unsub(e,"acceptedInScope");this._unsub(e,"rejectedInScope");this._unsub(e,"renamedInScope");this._unsub(e,"componentStackChange");if(this._componentOnly){this._unsub(e,"childComponentStatusChangeInScope")}}this._component=t;if(this._component){var i={acceptedInScope:this._acceptedInScope,rejectedInScope:this._rejectedInScope,renamedInScope:this._renamedInScope,componentStackChange:this._componentStackChange};if(this._componentOnly){i["childComponentStatusChangeInScope"]=this._childComponentStatusChangeInScope}this._sub(t,i)}if(this._isEvaluating)return;this.evaluate()},_acceptedInScope:function(t,e){if(this._isEvaluating)return;if(this._allElements){this.evaluate();return}if(!this._idExists||!this._idValue)return;var i=false;for(var r=0,n=e.length;r<n;r++){if(e[r].getId()===this._idValue){i=true;break}}if(i)this.evaluate()},_rejectedInScope:function(t,e){return this._acceptedInScope(t,e)},_renamedInScope:function(t,e,i,r){if(this._isEvaluating)return;if(this._allElements){this.evaluate();return}if(!this._idExists||!this._idValue)return;if(i===this._idValue||r===this._idValue)this.evaluate()},_componentStackChange:function(){if(this._isEvaluating)return;this.evaluate()},_childComponentStatusChangeInScope:function(t,e,i){if(this._isEvaluating)return;if(this._allElements){this.evaluate();return}if(!this._idExists||!this._idValue)return;if(e.getId()===this._idValue||e.getInternalId()===this._idValue)this.evaluate()},setOrigin:function(t){this._setOperand("origin",t)},setId:function(t){this._setOperand("id",t)},_doEvaluate:function(t){var e=this._getOperandValue("range",t);var i=this._getOperandValue("id",t);var r=this._getOperandValue("origin",t);return Amm.Operator.ScopeElement._eval(r,i,e,this._componentOnly,this._allElements)},toFunction:function(){var n=this._operandFunction("origin");var s=this._operandFunction("id");var a=this._operandFunction("range");var o=this._allElements;var l=this._componentOnly;return function(t){var e=a(t);var i=s(t);var r=n(t);return Amm.Operator.ScopeElement._eval(r,i,e,l,o)}}};Amm.Operator.ScopeElement._eval=function(t,e,i,r,n){var s=i==="*"||!e&&n;var a=s?[]:undefined;if(!t||!t["Amm.Element"])return a;if(!e&&!n)return a;var o=t.getClosestComponent();if(!o)return a;if(r){var l;if(!e&&n){var h=o.getAllNamedElements();l=[];for(var u in h)if(h.hasOwnProperty(u)){l=l.concat(h[u])}}else{l=o.getAllNamedElements(e,true)}var f=[];for(var u=0;u<l.length;u++)if(l[u]["Component"]&&l[u].getIsComponent())f.push(l[u]);return s?f:f[i]}if(s)return o.getAllNamedElements(e,true);return o.getNamedElement(e,i,true)};Amm.extend(Amm.Operator.ScopeElement,Amm.Operator);Amm.Operator.ExpressionThis=function(){Amm.Operator.call(this)};Amm.Operator.ExpressionThis.prototype={"Amm.Operator.ExpressionThis":"__CLASS__",setExpression:function(t){Amm.Operator.prototype.setExpression.call(this,t);this._sub(t,"expressionThisChange");this._defaultHandler()},_initContextState:function(t,e){Amm.Operator.prototype._initContextState.call(this,t,e);if(e&&this._expression){this._sub(this._expression,"expressionThisChange");this._defaultHandler()}},_doEvaluate:function(t){if(!this._expression){this._hasValue=false;return}return this._expression.getExpressionThis()},toFunction:function(){return function(t){return t.expressionThis}}};Amm.extend(Amm.Operator.ExpressionThis,Amm.Operator);Amm.Operator.Conditional=function(t,e,i){this._isEvaluating++;Amm.Operator.call(this);if(t!==undefined)this._setOperand("condition",t);if(e!==undefined)this._setOperand("trueValue",e);if(i!==undefined)this._setOperand("falseValue",i);this._isEvaluating--};Amm.Operator.Conditional.prototype={"Amm.Operator.Condition":"__CLASS__",_conditionOperator:null,_conditionValue:null,_conditionExists:null,_trueValueOperator:null,_trueValueValue:null,_trueValueExists:null,_falseValueOperator:null,_falseValueValue:null,_falseValueExists:null,OPERANDS:["condition","trueValue","falseValue"],supportsAssign:false,_doEvaluate:function(t){var e=this._getOperandValue("condition",t);var i=e?this._getOperandValue("trueValue",t):this._getOperandValue("falseValue",t);return i},setCondition:function(t){this._setOperand("condition",t)},setTrueValue:function(t){this._setOperand("trueValue",t)},setFalseValue:function(t){this._setOperand("falseValue",t)},toFunction:function(){var e=this._operandFunction("condition");var i=this._operandFunction("trueValue");var r=this._operandFunction("falseValue");return function(t){return e(t)?i(t):r(t)}}};Amm.extend(Amm.Operator.Conditional,Amm.Operator);Amm.Operator.Unary=function(t,e){this._isEvaluating++;Amm.Operator.call(this);this._setOperator(t);if(e!==undefined)this._setOperand("operand",e);this._isEvaluating--};Amm.Operator.Unary.Unary_OPERATORS={"!!":function(t){return!!t},"!":function(t){return!t},"-":function(t){return-t},typeof:function(t){return typeof t}};Amm.Operator.Unary.prototype={"Amm.Operator.Unary":"__CLASS__",_operandOperator:null,_operandValue:null,_operandExists:null,_operator:null,_operatorFn:null,OPERANDS:["operand"],STATE_SHARED:{_operator:true,_operatorFn:true},supportsAssign:false,_setOperator:function(t){var e=Amm.Operator.Unary.Unary_OPERATORS[t];if(!e)Error("Unsupported Unary operator type: '"+t+"'");this._operator=t;this._operatorFn=e},_doEvaluate:function(t){var e=this._getOperandValue("operand",t);return this._operatorFn(e)},setOperand:function(t){this._setOperand("operand",t)},toFunction:function(){var e=this._operandFunction("operand");var i=this._operatorFn;return function(t){return i(e(t))}}};Amm.extend(Amm.Operator.Unary,Amm.Operator);Amm.Operator.Property=function(t,e,i,r,n,s){this._isEvaluating++;Amm.Operator.call(this);if(n||s){this._isCall=true;this.supportsAssign=false}if(r!==undefined&&r!==null){this._cacheability=!!r}this._isNew=!!s;if(t!==undefined)this._setOperand("object",t);if(e!==undefined)this._setOperand("property",e);if(i!==undefined)this._setOperand("arguments",i);this._isEvaluating--};Amm.Operator.Property.prototype={"Amm.Operator.Property":"__CLASS__",_objectOperator:null,_objectValue:null,_objectExists:null,_propertyOperator:null,_propertyValue:null,_propertyExists:null,_argumentsOperator:null,_argumentsValue:null,_argumentsExists:null,_isCall:false,_isNew:false,_cacheability:null,_eventName:false,supportsAssign:true,OPERANDS:["object","property","arguments"],STATE_SHARED:{_isCall:true,_cacheability:true,supportsAssign:true,_isNew:true},setObject:function(t){this._setOperand("object",t)},promoteToCall:function(t,e){if(this._hasValue)Error("Cannot promoteToCall(): already evaluated");this._isEvaluating++;this._isCall=true;this.supportsAssign=false;if(this._argumentsOperator||!(this._arguments===null||this._arguments===undefined))Error("Getter arguments already defined - cannot promote to call");if(e!==undefined&&e!==null){this._cacheability=!!e}if(t!==undefined)this._setOperand("arguments",t);this._isEvaluating--},getIsCall:function(){return this._isCall},getIsNew:function(){return this._isNew},promoteToNew:function(){if(this._hasValue)Error("Cannot promoteToNew(): already evaluated");if(!this._isCall)Error("Cannot promoteToNew(): not is call");this._isNew=true},hasArguments:function(){return this._argumentsOperator||!(this._arguments===null||this._arguments===undefined)},setProperty:function(t){this._setOperand("property",t)},setArguments:function(t){this._setOperand("arguments",t)},_handleObjectCleanup:function(){this._setOperandValue("object",null)},_objectChange:function(t,e){if(t&&!t["Amm.WithEvents"]&&!this._isCall&&this._cacheability===null){this._setNonCacheable(this._nonCacheable|Amm.Operator.NON_CACHEABLE_VALUE)}},_objectEvents:function(t,e){if(e)this._unsub(e);if(!t){this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_VALUE)}else if(this._isCall&&!this._isNew||t&&!t["Amm.WithEvents"]){var i=this._cacheability;if(i===null)i=this._isCall;if(i){this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_CONTENT)}else{this._setNonCacheable(this._nonCacheable|Amm.Operator.NON_CACHEABLE_CONTENT)}}else{this._subToProp(this._propertyValue);if(t.outCleanup)this._sub(t,"cleanup",this._handleObjectCleanup,undefined,true)}},getReportsContentChanged:function(){return this._cacheability},_subToProp:function(t){if(!t&&t!==0||this._objectValue["Amm.Array"]&&parseInt(t)==t){if(this._nonCacheable)this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_VALUE);return}var e=t+"Change";if(!this._objectValue.hasEvent(e))e=null;if(e){this._sub(this._objectValue,e,undefined,undefined,true);this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_VALUE)}else{this._setNonCacheable(this._nonCacheable|Amm.Operator.NON_CACHEABLE_VALUE)}this._eventName=e},_propertyChange:function(t,e){if(!this._objectValue||!this._objectValue["Amm.WithEvents"])return;if(this._eventName==="spliceItems"&&parseInt(t)==t)return;if(this._eventName)this._unsub(this._objectValue,this._eventName);if(!this._isCall){this._subToProp(t)}else{var i=this._cacheability;if(i===null)i=true;if(i){this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_VALUE)}else{this._setNonCacheable(this._nonCacheable|Amm.Operator.NON_CACHEABLE_VALUE)}}},_doEvaluate:function(t){var e=this._getOperandValue("property",t);if(!e&&e!==0)return;e=""+e;var i=this._getOperandValue("object",t);if(!i)return;if(this._isCall&&!this._isNew){if(typeof i[e]!=="function")throw Error("cannot call a non-function property");args=this._getOperandValue("arguments",t);if(args===null||args===undefined)return i[e]();else if(args instanceof Array)return i[e].apply(i,args);else return i[e](args)}var r="get"+e[0].toUpperCase()+e.slice(1);if(this._isNew){var n;if(typeof i[r]!=="function")n=i[e];else n=i[r]();if(!n)return;n=Amm.Operator.FunctionCall.getFunction(n);args=this._getOperandValue("arguments",t);return Amm.Operator.FunctionCall.newVarArgs(n,args)}if(typeof i[r]!=="function")return i[e];args=this._getOperandValue("arguments",t);if(args===null||args===undefined){}else if(args instanceof Array){if(!args.length)args=null}else{args=[args]}if(args)return i[r].apply(i,args);else return i[r]()},toFunction:function(){var s=this._operandFunction("property");var a=this._operandFunction("object");var o=this._operandFunction("arguments");var n=this._isNew;if(this._isCall)return function(t){var e=s(t);if(!e&&e!==0)return;e=""+e;var i=a(t);if(!i)return;if(typeof i[e]!=="function")Error("cannot call a non-function property");var r=o(t);if(n)return Amm.Operator.FunctionCall.newVarArgs(i[e],r);if(r===null||r===undefined)return i[e]();else if(r instanceof Array)return i[e].apply(i,r);return i[e](r)};return function(t){var e=s(t);if(!e&&e!==0)return;e=""+e;var i=a(t);if(!i)return;var r="get"+e[0].toUpperCase()+e.slice(1);if(typeof i[r]!=="function")return i[e];var n=o(t);if(n===null||n===undefined){}else if(n instanceof Array){if(!n.length)n=null}else{n=[n]}if(n)return i[r].apply(i,n);else return i[r]()}},_doSetValue:function(t,e){var i=this._getOperandValue("property");if(!i&&i!==0)return;i=""+i;if(i[0]==="_")return"cannot assign to pseudo-private properties(beginning with '_')";var r=this._getOperandValue("object");if(!r)return"`object` is empty";var n="get"+i[0].toUpperCase()+i.slice(1);var s=i[0].toUpperCase()+i.slice(1);var n="get"+s;var a="set"+s;var o=typeof r[n]==="function";var l=typeof r[a]==="function";if(o&&!l)return"property is read-only (has getter but no setter)";if(e)return false;if(!l){r[i]=t;return}var h=this._getOperandValue("arguments");if(h===null||h===undefined){}else if(h instanceof Array){if(!h.length)h=null}else{h=[h]}if(h){h=[].concat([t],h);r[a].apply(r,h);return}r[a](t)},assignmentFunction:function(){var u=this._operandFunction("property");var f=this._operandFunction("object");var c=this._operandFunction("arguments");return function(t,e){var i=u(t);if(!i)return"`property` is empty";i=""+i;if(i[0]==="_")return"cannot assign to pseudo-private properties(beginning with '_')";var r=f(t);if(!r)return"`object` is empty";var n=i[0].toUpperCase()+i.slice(1);var s="get"+n;var a="set"+n;var o=typeof r[s]==="function";var l=typeof r[a]==="function";if(o&&!l)return"property is read-only (has getter but no setter)";if(!l){r[i]=e;return}var h=c(t);if(h===null||h===undefined){}else if(h instanceof Array){if(!h.length)h=null}else{h=[h]}if(h){h.unshift(e);r[a].apply(r,h);return}r[a](e)}},_isValueObservable:function(t,e){if(t==="arguments")return false;return Amm.Operator.prototype._isValueObservable.call(this,t,e)},_reportChange:function(t){Amm.Operator.prototype._reportChange.call(this,t);if(this._isNew&&t&&typeof t.cleanup==="function"){t.cleanup()}}};Amm.extend(Amm.Operator.Property,Amm.Operator);Amm.Operator.Binary=function(t,e,i){this._isEvaluating++;Amm.Operator.call(this);this._setOperator(e);if(t!==undefined)this._setOperand("left",t);if(i!==undefined)this._setOperand("right",i);this._isEvaluating--};Amm.Operator.Binary.BINARY_OPERATORS={"!==":function(t,e){return t!==e},"===":function(t,e){return t===e},"==":function(t,e){return t==e},"!=":function(t,e){return t!=e},"+":function(t,e){return t+e},"-":function(t,e){return t-e},"*":function(t,e){return t*e},"%":function(t,e){return t%e},"/":function(t,e){return t/e},">":function(t,e){return t>e},"<":function(t,e){return t<e},"<=":function(t,e){return t<=e},">=":function(t,e){return t>=e},"&":function(t,e){return t&e},"|":function(t,e){return t|e},"&&":function(t,e){return t&&e},"||":function(t,e){return t||e},instanceof:function(t,e){return Amm.Operator.Binary.instanceof(t,e)}};Amm.Operator.Binary.prototype={"Amm.Operator.Binary":"__CLASS__",_leftOperator:null,_leftValue:null,_leftExists:null,_operator:null,_operatorFn:null,_rightOperator:null,_rightValue:null,_rightExists:null,OPERANDS:["left","right"],STATE_SHARED:{_operator:true,_operatorFn:true},supportsAssign:false,_setOperator:function(t){var e=Amm.Operator.Binary.BINARY_OPERATORS[t];if(!e)Error("Unsupported binary operator type: '"+t+"'");this._operator=t;this._operatorFn=e},_doEvaluate:function(t){var e=this._getOperandValue("left",t);var i=this._getOperandValue("right",t);return this._operatorFn(e,i)},setLeft:function(t){this._setOperand("left",t)},setRight:function(t){this._setOperand("right",t)},toFunction:function(){var e=this._operandFunction("left");var i=this._operandFunction("right");var r=this._operatorFn;return function(t){return r(e(t),i(t))}}};Amm.extend(Amm.Operator.Binary,Amm.Operator);Amm.Operator.Binary.instanceof=function(t,e){if(!e)return false;if(!t&&typeof t!=="object")return false;if(typeof e==="string"){e=Amm.Operator.FunctionCall.getFunction(e,true);if(!e)return false}if(typeof e!=="function"){throw Error("right-side of instanceof must be either string or function")}if(t instanceof e)return true;return Amm.is(t,e)};Amm.Operator.ComponentElement=function(t,e,i,r,n){this._isEvaluating++;Amm.Operator.call(this);this._componentOnly=r;if(t!==undefined)this._setOperand("component",t);if(e!==undefined)this._setOperand("id",e);if(i!==undefined)this._setOperand("range",i);if(n!==undefined)this._allElements=!!n;this._isEvaluating--};Amm.Operator.ComponentElement.prototype={"Amm.Operator.ComponentElement":"__CLASS__",_componentOnly:false,_allElements:false,_componentOperator:null,_componentValue:null,_componentExists:null,_idOperator:null,_idValue:null,_idExists:null,_rangeOperator:null,_rangeValue:null,_rangeExists:null,OPERANDS:["component","id","range"],STATE_SHARED:{_componentOnly:true},supportsAssign:false,getReportsContentChanged:function(){return true},_componentEvents:function(t,e){if(e&&e["Component"])this._unsub(e);if(t&&t["Component"]){var i={acceptedElements:this._acceptedElements,rejectedElements:this._rejectedElements,renamedElement:this._renamedElement};if(this._componentOnly){i["childComponentStatusChange"]=this._childComponentStatusChange}this._sub(t,i)}},_rangeChange:function(t){this._checkArrayChange=t==="*"},_acceptedElements:function(t){if(this._isEvaluating)return;if(this._allElements){this.evaluate();return}if(!this._allElements&&(!this._idExists||!this._idValue))return;var e=false;for(var i=0,r=t.length;i<r;i++){if(t[i].getId()===this._idValue){e=true;break}}if(e)this.evaluate()},_rejectedElements:function(t){return this._acceptedElements(t)},_renamedElement:function(t,e,i){if(this._isEvaluating)return;if(this._allElements){this.evaluate();return}if(!this._idExists||!this._idValue)return;if(e===this._idValue||i===this._idValue)this.evaluate()},_childComponentStatusChange:function(t,e){if(this._isEvaluating)return;if(this._allElements){this.evaluate();return}if(!this._idExists||!this._idValue)return;if(t.getId()===this._idValue||t.getInternalId()===this._idValue)this.evaluate()},setComponent:function(t){this._setOperand("component",t)},setId:function(t){this._setOperand("id",t)},_doEvaluate:function(t){var e=this._getOperandValue("range",t);var i=this._getOperandValue("id",t);var r=this._getOperandValue("component",t);return Amm.Operator.ComponentElement._eval(r,i,e,this._componentOnly,this._allElements)},toFunction:function(){var n=this._operandFunction("component");var s=this._operandFunction("id");var a=this._operandFunction("range");var o=this._componentOnly;var l=this._allElements;return function(t){var e=a(t);var i=s(t);var r=n(t);return Amm.Operator.ComponentElement._eval(r,i,e,o,l)}}};Amm.Operator.ComponentElement._eval=function(t,e,i,r,n){var s=i==="*"||!e&&n;var a=s?[]:undefined;if(!t||!t["Component"]||!t.getIsComponent())return a;if(r){var o;if(!e&&n)o=t.getElements();else o=t.getAllNamedElements(e);var l=[];for(var h=0;h<o.length;h++)if(o[h]["Component"]&&o[h].getIsComponent())l.push(o[h]);return s?l:l[i]}if(s){if(!e&&n)return t.getElements();return t.getAllNamedElements(e)}return t.getNamedElement(e,i)};Amm.extend(Amm.Operator.ComponentElement,Amm.Operator);Amm.Operator.Var=function(t){this._isEvaluating++;Amm.Operator.call(this);if(t!==undefined)this._setOperand("varName",t);this._isEvaluating--};Amm.Operator.Var.prototype={"Amm.Operator.Var":"__CLASS__",_varNameOperator:null,_varNameValue:null,_varNameExists:null,_varsProvider:null,_varsProviderContextId:null,OPERANDS:["varName"],STATE_SHARED:{_varsProvider:true},supportsAssign:true,notifyProviderVarsChange:function(t,e,i,r){if(this._varNameValue&&i&&this._varNameValue!==i){Error("WTF - we shouldn't received wrong varsChange notification")}if(this._expression&&this._expression.getUpdateLevel()){this._expression.queueUpdate(this)}else{this.evaluate()}},setExpression:function(t){Amm.Operator.prototype.setExpression.call(this,t);this._varsProvider=t;this._varsProviderContextId=t._contextId;for(var e=this._parent;e;e=e._parent){if(e["Amm.Operator.VarsProvider"]){this._varsProvider=e;this._varsProviderContextId=e._contextId;break}}if(this._varsProvider&&this._varNameExists&&this._varNameValue){this._varsProvider.addConsumer(this,this._varNameValue+"")}},_initContextState:function(t,e){Amm.Operator.prototype._initContextState.call(this,t,e);if(e&&this._varsProvider){this._varsProviderContextId=this._varsProvider._contextId}},_doEvaluate:function(t){var e=this._getOperandValue("varName",t);if(!e)return;if(!this._varsProvider){this._hasValue=false;return}var i;if(this._varsProviderContextId&&this._varsProviderContextId!==this._varsProvider._contextId){i=this._varsProvider._contextId;this._varsProvider.setContextId(this._varsProviderContextId)}var r=this._varsProvider.getVars(e);if(i)this._varsProvider.setContextId(i);return r},_varNameChange:function(t,e,i){if(!this._varsProvider)return;var r;if(this._varsProviderContextId&&this._varsProviderContextId!==this._varsProvider._contextId){r=this._varsProvider._contextId;this._varsProvider.setContextId(this._varsProviderContextId)}if(e)this._varsProvider.deleteConsumer(this,e);if(t)this._varsProvider.addConsumer(this,t);if(r)this._varsProvider.setContextId(r)},_doSetValue:function(t,e){var i=this._getOperandValue("varName");if(!i&&i!==0)return"`varName` is empty";if(!this._varsProvider)return"expression not provided";if(e)return"";var r;if(this._varsProviderContextId&&this._varsProviderContextId!==this._varsProvider._contextId){r=this._varsProvider._contextId;this._varsProvider.setContextId(this._varsProviderContextId)}this._varsProvider.setVars(t,i);if(r)this._varsProvider.setContextId(r)},setVarName:function(t){this._setOperand("varName",t)},toFunction:function(){var i=this._operandFunction("varName");return function(t){var e=i(t);if(!e)return;return t.vars[e]}},assignmentFunction:function(){var r=this._operandFunction("varName");return function(t,e){var i=r(t);if(!i&&i!==0)return"`varName` is empty";t.vars[i]=e}},_partialCleanup:function(){if(this._expression&&this._varsProvider){this._expression.unsubscribeOperator(this._expression,"varsChange",this)}if(this._varsProvider&&this._varsProvider.hasContext(this._varsProviderContextId)){var t;if(this._varsProviderContextId&&this._varsProviderContextId!==this._varsProvider._contextId){t=this._varsProvider._contextId;this._varsProvider.setContextId(this._varsProviderContextId)}this._varsProvider.deleteConsumer(this,this._varNameValue+"");if(t)this._varsProvider.setContextId(t)}Amm.Operator.prototype._partialCleanup.call(this)}};Amm.extend(Amm.Operator.Var,Amm.Operator);Amm.Operator.Range=function(t){this._isEvaluating++;Amm.Operator.call(this);if(t!==undefined)this._setOperand("source",t);this._isEvaluating--};Amm.Operator.Range.prototype={"Amm.Operator.Range":"__CLASS__",_sourceOperator:null,_sourceValue:null,_sourceExists:null,OPERANDS:["source"],supportsAssign:false,getReportsContentChanged:function(){return true},_setSource:function(t){this._setOperand("source",t)},_doEvaluate:function(t){Error("Call to abstract function")},toFunction:function(){Error("Call to abstract function")}};Amm.extend(Amm.Operator.Range,Amm.Operator);Amm.Operator.Range.Condition=function(t,e,i,r){this._isEvaluating++;this._map=[];Amm.Operator.Range.call(this,t);this._value=[];this._nonCacheableIteratorContexts={};if(i!==undefined)this.keyVar=i;if(r!==undefined)this.valueVar=r;var n=new Amm.Operator.Range.Iterator(e,i,r);this._setOperand("iterator",n);this._isEvaluating--};Amm.Operator.Range.Condition.prototype={"Amm.Operator.Range.Condition":"__CLASS__",_iteratorOperator:null,_iteratorValue:null,_iteratorExists:null,_checkArrayChange:true,keyVar:null,valueVar:null,_nonCacheableIteratorContexts:null,_numNonCacheableIteratorContexts:0,_map:null,OPERANDS:["source","iterator"],STATE_SHARED:{keyVar:true,valueVar:true},supportsAssign:false,_setSource:function(t){this._setOperand("source",t)},_sourceEvents:function(t,e){},_sortMap:function(t){var e=t?this._map.slice(0,t):[];e.length=this._map.length;for(var i=t||0,r=this._map.length;i<r;i++){if(!this._map[i]){e.length--;continue}e[this._map[i].i]=this._map[i]}this._map=e},_doEvaluate:function(t){var e=[],i=true;for(var r=0,n=this._map.length;r<n;r++){if(i&&(!this._map[r]||this._map[r].i!==r)){i=false;this._sortMap(r);n=this._map.length;r--}var s=this._map[r].c;if(t){this._iteratorOperator.setContextId(s);this._map[r].v=this._iteratorOperator.getValue(t)}else{var a=this._iteratorOperator._contextId===s?this._iteratorOperator:this._iteratorOperator._contextState[s];if(a._hasValue)this._map[r].v=a._value;else{this._iteratorOperator.setContextId(s);this._map[r].v=this._iteratorOperator.getValue()}}if(this._map[r].v)e.push(this._map[r].o)}return e},toFunction:function(){var l=this._operandFunction("source");var h=this._operandFunction("iterator");var u=this.keyVar||"";var f=this.valueVar||"";var t=function(t){var e=l(t),i=e.length;if(!i)return[];var r=h.vars,n=r[u],s=r[f],a=[];for(var o=0;o<i;o++){r[u]=o;r[f]=e[o];if(h(t))a.push(e[o])}r[u]=n;r[f]=s;return a};return t},_clearIteratorContexts:function(){this._isEvaluating++;this._map=[];for(var t in this._iteratorOperator._contextState){if(t!=="0"&&this._iteratorOperator._contextState.hasOwnProperty(t)&&this._iteratorOperator._contextState[t]){this._iteratorOperator.deleteContext(t)}}this._isEvaluating--},notifyOperandChanged:function(t,e,i,r){if(r===this._iteratorOperator){if(r.parentContextId!==null&&r.parentContextId!==this._contextId)this.setContextId(r.parentContextId);if(this._lockChange)return;var n=r.index;if(this._map[n]&&this._map[n].c===r._contextId&&this._map[n].v!==e){this._map[n].v=e;if(!this._isEvaluating)this.evaluate()}return}Amm.Operator.Range.prototype.notifyOperandChanged.call(this,t,e,i,r)},_buildIteratorContexts:function(){this._isEvaluating++;var t=this._sourceValue,e=t.length,i=this._iteratorOperator;this._map.length=t.length;for(var r=0;r<e;r++){var n={};if(this.keyVar!==null)n[this.keyVar]=r;if(this.valueVar!==null)n[this.valueVar]=t[r];this._iteratorOperator.createContext({index:r,parentContextId:this._contextId,vars:n});this._map[r]={c:this._iteratorOperator._contextId,i:r,o:t[r],v:undefined}}this._isEvaluating--},_adjustIteratorContexts:function(t,e){var i=this._sourceValue||[];if(e===undefined)e=t.cut.length===t.insert.length||i.length<t.insert.length;if(!t.cut.length||!t.insert.length)e=false;if(!i.length){this._clearIteratorContexts();return}if((!t.cut.length||!e)&&t.insert.length===i.length){if(this._map.length)this._clearIteratorContexts();this._buildIteratorContexts();return}this._isEvaluating++;var r=t.index;var n,s=[],a;if(e){var o=[],l;l=Amm.Array.symmetricDiff(t.cut,t.insert,null,o);n=Amm.Array.findNonMatched(o,t.insert.length);a=[];for(var h=0,u=o.length;h<u;h++){if(o[h]===null)s.push(h);else if(o[h]!==h)a.push([h,o[h]])}}else{n=[];for(var h=0;h<t.cut.length;h++){s.push(h)}for(var h=0;h<t.insert.length;h++){n.push(h)}a=[]}var f=this._map,c;var _=t.insert.length-t.cut.length;if(_){for(var h=r+t.cut.length;h<f.length;h++){a.push([h-r,h+_-r])}}var m=this._iteratorOperator;for(var h=0,u=a.length;h<u;h++){c=f[a[h][0]+r];c.i=a[h][1]+r;if(c.c===m._contextId){m.index=c.i}else{m._contextState[c.c].index=c.i}if(this.keyVar){m.setContextId(c.c);m.setVars(c.i,this.keyVar)}}var d=s.length<n.length?s.length:n.length;for(var h=0;h<d;h++){c=f[s[h]+r];c.i=n[h]+r;c.o=t.insert[n[h]];m.setContextId(c.c);m.index=c.i;var p={};if(this.keyVar)p[this.keyVar]=c.i;if(this.valueVar)p[this.valueVar]=c.o;m.setVars(p)}for(var h=n.length;h<s.length;h++){m.deleteContext(f[s[h]+r].c);f[s[h]+r]=null}for(var h=s.length;h<n.length;h++){var p={};if(this.keyVar!==null)p[this.keyVar]=n[h]+r;if(this.valueVar!==null)p[this.valueVar]=t.insert[n[h]];m.createContext({index:n[h]+r,parentContextId:this._contextId,vars:p});f.push({c:m._contextId,i:n[h]+r,o:t.insert[n[h]],v:undefined})}this._map=f;this._sortMap();this._isEvaluating--},_sourceChange:function(t,e){var i=t&&t.length?t:null;var r=e&&e.length?e:null;var n,s,a;if(!r){if(!i)return;s=[];a=i;n=0}else if(!i){s=r?r.slice(0,r.length):[];a=[];n=0}else{var o=Amm.Array.smartDiff(r,i,null,true);if(!o)return;if(o[0]!=="splice")Error("Assertion - should receive only 'splice' event (spliceOnly === true)");s=o[2]?e.slice(o[1],o[1]+o[2]):[];a=o[3];n=o[1]}var l=this._makeChangeInfoForSplice(n,s,a);this._adjustIteratorContexts(l)},notifyOperandContentChanged:function(t,e,i){if(t==="source"){this._adjustIteratorContexts(e,true)}return Amm.Operator.prototype.notifyOperandContentChanged.call(this,t,e,i)},_constructContextState:function(){var t=Amm.Operator.Range.prototype._constructContextState.call(this);t._map=[];t._value=[];t._nonCacheableIteratorContexts={};return t},_propagateContext:function(t,e,i){if(e===this._iteratorOperator){if(this._contextId!==e.parentContextId){if(!i)this.setContextId(e.parentContextId);return}return}return Amm.Operator.Range.prototype._propagateContext.call(this,t,e,i)},notifyOperandNonCacheabilityChanged:function(t,e,i){if(i===this._iteratorOperator){if(i.parentContextId!==this._contextId)return;var r=i._contextId;if(e){this._nonCacheableIteratorContexts[r]=true;this._numNonCacheableIteratorContexts++}else{delete this._nonCacheableIteratorContexts[r];this._numNonCacheableIteratorContexts--}}return Amm.Operator.prototype.notifyOperandNonCacheabilityChanged.call(this,t,e,i)},_checkNonCacheableIterator:function(){for(var t in this._nonCacheableIteratorContexts){if(this._nonCacheableIteratorContexts.hasOwnProperty(t)){this._iteratorOperator.setContextId(t);this._iteratorOperator.checkForChanges()}}},_checkNonCacheableOperators:function(){if(this._hasNonCacheable<=!!this._nonCacheable)return;for(var t=0,e=this.OPERANDS.length;t<e;t++){var i="_"+this.OPERANDS[t]+"Operator";if(this[i]===this._iteratorOperator){if(this._numNonCacheableIteratorContexts)this._checkNonCacheableIterator();continue}if(!this[i])continue;if(this[i]._contextId!==this._contextId){this._propagateContext(i,this[i],true)}if(this[i]._hasNonCacheable){this[i].checkForChanges()}}}};Amm.extend(Amm.Operator.Range.Condition,Amm.Operator.Range);Amm.Operator.Range.Slice=function(t,e,i){this._isEvaluating++;Amm.Operator.Range.call(this);if(t!==undefined)this._setOperand("source",t);if(e!==undefined)this._setOperand("start",e);if(i!==undefined)this._setOperand("end",i);this._isEvaluating--};Amm.Operator.Range.Slice.prototype={"Amm.Operator.Range.Slice":"__CLASS__",_startOperator:null,_startValue:null,_startExists:null,OPERANDS:["source","start","end"],supportsAssign:false,_doEvaluate:function(t){var e=this._getOperandValue("source",t);var i=this._getOperandValue("start",t);var r=this._getOperandValue("end",t);if(!i&&typeof i!=="number")i=null;if(!r&&typeof r!=="number")r=null;if(e&&(e instanceof Array||e["Amm.Array"])){return e.slice(i,r)}return undefined},toFunction:function(){var n=this._operandFunction("source");var s=this._operandFunction("start");var a=this._operandFunction("end");return function(t){var e=n(t);var i=s(t);var r=a(t);if(!i&&typeof i!=="number")i=null;if(!r&&typeof r!=="number")r=null;if(e&&(e instanceof Array||e["Amm.Array"])){return e.slice(i,r)}return undefined}}};Amm.extend(Amm.Operator.Range.Slice,Amm.Operator.Range);Amm.Operator.Range.RegExp=function(t,e){this._isEvaluating++;Amm.Operator.Range.call(this);if(t!==undefined)this._setOperand("source",t);if(e!==undefined)this._setOperand("regexp",e);this._isEvaluating--};Amm.Operator.Range.RegExp.prototype={"Amm.Operator.Range.RegExp":"__CLASS__",_regexpOperator:null,_regexpValue:null,_regexpExists:null,OPERANDS:["source","regexp"],supportsAssign:false,_doEvaluate:function(t){var e=this._getOperandValue("source",t);var i=this._getOperandValue("regexp",t);if(!(e&&(e instanceof Array||e["Amm.Array"])&&i instanceof RegExp))return undefined;var r=[];for(var n=0,s=e.length;n<s;n++)if(i.exec(""+e[n])){r.push(e[n])}return r},toFunction:function(){var a=this._operandFunction("source");var o=this._operandFunction("regexp");return function(t){var e=a(t);var i=o(t);if(!(e&&(e instanceof Array||e["Amm.Array"])&&i instanceof RegExp))return undefined;var r=[];for(var n=0,s=e.length;n<s;n++)if(i.exec(""+e[n])){r.push(e[n])}return r}}};Amm.extend(Amm.Operator.Range.RegExp,Amm.Operator.Range);Amm.Operator.Range.All=function(t){Amm.Operator.Range.call(this,t)};Amm.Operator.Range.All.prototype={"Amm.Operator.Range.All":"__CLASS__",_sourceOperator:null,_sourceValue:null,_sourceExists:null,OPERANDS:["source"],supportsAssign:false,_doEvaluate:function(t){var e=this._getOperandValue("source",t);if(e===null)return[];if(e===undefined)return undefined;if(e instanceof Array||e["Amm.Array"])return e;return[e]},toFunction:function(){var i=this._operandFunction("source");return function(t){var e=i(t);if(e===null)return[];if(e===undefined)return undefined;if(e instanceof Array||e["Amm.Array"])return e;return[e]}}};Amm.extend(Amm.Operator.Range.All,Amm.Operator.Range);Amm.Operator.Range.Iterator=function(t,e,i){this._isEvaluating++;Amm.Operator.VarsProvider.call(this,t);this.keyVar=e||null;this.valueVar=i||null;this._isEvaluating--};Amm.Operator.Range.Iterator.prototype={"Amm.Operator.Range.Iterator":"__CLASS__",keyVar:null,valueVar:null,index:null,parentContextId:null,supportsAssign:false,STATE_SHARED:{keyVar:true,valueVar:true},_doEvaluate:function(t){var e=this._getOperandValue("operator",t);if(e===undefined)return e;return!!e}};Amm.extend(Amm.Operator.Range.Iterator,Amm.Operator.VarsProvider);Amm.Operator.Range.Index=function(t,e){this._isEvaluating++;Amm.Operator.Range.call(this);if(t!==undefined)this._setOperand("source",t);if(e!==undefined)this._setOperand("index",e);this._isEvaluating--};Amm.Operator.Range.Index.prototype={"Amm.Operator.Range.Index":"__CLASS__",_indexOperator:null,_indexValue:null,_indexExists:null,OPERANDS:["source","index"],supportsAssign:false,_doEvaluate:function(t){var e=this._getOperandValue("source",t);var i=this._getOperandValue("index",t);if(e&&(e instanceof Array||e["Amm.Array"])){return e[i]}if(!i)return e;return undefined},toFunction:function(){var r=this._operandFunction("source");var n=this._operandFunction("index");return function(t){var e=r(t);var i=n(t);if(e&&(e instanceof Array||e["Amm.Array"])){return e[i]}if(!i)return e;return undefined}}};Amm.extend(Amm.Operator.Range.Index,Amm.Operator.Range);Amm.Operator.List=function(t){this._isEvaluating++;this.OPERANDS=[];Amm.Operator.call(this);if(t!==undefined)this.setItems(t);this._isEvaluating--};Amm.Operator.List.prototype={"Amm.Operator.List":"__CLASS__",_length:0,OPERANDS:null,STATE_SHARED:{_length:true},_getContextState:function(){var t=Amm.Operator.prototype._getContextState.call(this);for(var e=0;e<this._length;e++){var i="_"+e+"Value",r="_"+e+"Operator",n="_"+e+"Exists",s="_"+e+"Observe";t[i]=this[i];t[0]=this[r];t[n]=this[n];t[s]=this[s]}return t},getReportsContentChanged:function(){return true},setItems:function(t){if(!(t instanceof Array))Error("items must be an Array");var e=this._length,i=t.length;for(var r=i;r<e;r++){var n="_"+r+"Value",s="_"+r+"Operator",a="_"+r+"Exists",o="_"+r+"Observe";if(this[s])this[s].cleanup();delete this[s];delete this[n];delete this[a];delete this[o]}this._isEvaluating++;this.OPERANDS=[];for(var r=0;r<i;r++){this._setOperand(r,t[r]);this.OPERANDS.push(r)}this._length=i;this._isEvaluating--},_doEvaluate:function(t){var e=[],i=!!this._value&&this._length===this._value.length,r;for(var n=0;n<this._length;n++){e.push(r=this._getOperandValue(n,t));i=i&&this._value[n]===r}if(i){return this._value}return e},toFunction:function(){var r=[];for(var t=0;t<this._length;t++)r.push(this._operandFunction(t));var n=r.length;return function(t){var e=[];for(var i=0;i<n;i++)e.push(r[i]());return e}}};Amm.extend(Amm.Operator.List,Amm.Operator);Amm.Operator.FunctionCall=function(t,e,i,r){this._isEvaluating++;Amm.Operator.call(this);this._cacheability=!!i||!!r;this._isNew=!!r;if(e!==undefined)this._setOperand("args",e);if(t!==undefined)this._setOperand("func",t);if(i!==undefined&&i!==null&&!i){this._setNonCacheable(Amm.Operator.NON_CACHEABLE_VALUE)}this._isEvaluating--};Amm.Operator.FunctionCall.WINDOW_PASSTHROUGH=["RegExp","Intl","JSON","Math","Date","isNaN","isFinite","parseInt","parseFloat"];Amm.Operator.FunctionCall.prototype={"Amm.Operator.FunctionCall":"__CLASS__",_isNew:false,_funcOperator:null,_funcValue:null,_funcExists:null,_argsOperator:null,_argsValue:null,_argsExists:null,_cacheability:null,OPERANDS:["func","args"],STATE_SHARED:{_cacheability:true,_isNew:true},getReportsContentChanged:function(){return this._cacheability},_doEvaluate:function(t){var e=this._getOperandValue("func",t);if(!e)return;e=Amm.Operator.FunctionCall.getFunction(e);var i=this._getOperandValue("args",t);if(this._isNew)return Amm.Operator.FunctionCall.newVarArgs(e,i);if(i===null||i===undefined||i instanceof Array&&!i.length){return e()}else{if(i instanceof Array)return e.apply(window,i);else return e(i)}},toFunction:function(){var r=this._operandFunction("func");var n=this._operandFunction("args");var s=this._isNew;return function(t){var e=r(t);if(!e)return;e=Amm.Operator.FunctionCall.getFunction(e);var i=n(t);if(s)return Amm.Operator.FunctionCall.newVarArgs(e,i);if(i===null||i===undefined||i instanceof Array&&!i.length){return e()}else{if(i instanceof Array)return e.apply(window,i);else return e(i)}}},_isValueObservable:function(t,e){if(t==="args")return false;return Amm.Operator.prototype._isValueObservable.call(this,t,e)},_reportChange:function(t){Amm.Operator.prototype._reportChange.call(this,t);if(this._isNew&&t&&typeof t.cleanup==="function"){t.cleanup()}}};Amm.extend(Amm.Operator.FunctionCall,Amm.Operator);Amm.Operator.FunctionCall.getFunction=function(t,e){var i;if(typeof t==="function")return t;else if(typeof t==="string"){i=Amm.getFunction(t,true);if(!i){if(Amm.Array.indexOf(t,Amm.Operator.FunctionCall.WINDOW_PASSTHROUGH)>=0){i=window[t]}}if(!i&&!e)Amm.getFunction(t)}else{if(e)return;throw Error("Callee must be either function or string, given: "+Amm.describeType(t))}return i};Amm.Operator.FunctionCall.newVarArgs=function(t,e){if(e===null||e===undefined||e instanceof Array&&!e.length)return new t;else if(!(e instanceof Array))return new t(e);var i=e.length;if(!i)return new t;if(i===1)return new t(e[0]);if(i===2)return new t(e[0],e[1]);if(i===3)return new t(e[0],e[1],e[2]);if(i===4)return new t(e[0],e[1],e[2],e[3]);if(i===5)return new t(e[0],e[1],e[2],e[3],e[4]);if(i===6)return new t(e[0],e[1],e[2],e[3],e[4],e[5]);if(i===7)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6]);if(i===8)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7]);if(i===9)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]);if(i===10)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9]);if(i===11)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10]);if(i===12)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11]);if(i===13)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12]);if(i===14)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13]);if(i===15)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14]);if(i===16)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]);if(i===17)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15],e[16]);if(i===18)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15],e[16],e[17]);if(i===19)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15],e[16],e[17],e[18]);if(i===20)return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15],e[16],e[17],e[18],e[19]);throw Error("Only argument arrays of size up to 20 are supported")};Amm.ElementBound=function(t){Amm.init(this,t)};Amm.ElementBound.prototype={"Amm.ElementBound":"__CLASS__",requiredElementClass:"Amm.Element",requiredElementInterfaces:null,_element:null,_isElementCleanup:0,cleanupWithElement:true,_doElementChange:function(t,e){if(e&&!this._isElementCleanup){e.unsubscribe("cleanup",this._handleElementCleanup,this)}this._element=t;if(this._element)this._element.subscribe("cleanup",this._handleElementCleanup,this)},setElement:function(t){if(t!==null){if(this.requiredElementClass)Amm.is(t,this.requiredElementClass,"element");if(this.requiredElementInterfaces)Amm.hasInterfaces(t,this.requiredElementInterfaces,"element")}var e=this._element;if(t===e)return;this._doElementChange(t,e);return true},getElement:function(){return this._element},_handleElementCleanup:function(){this._isElementCleanup++;if(this.cleanupWithElement){this.cleanup()}this.setElement(null);this._isElementCleanup--;return true},cleanup:function(){if(this._element){if(!this._isElementCleanup){this._element.unsubscribe(undefined,undefined,this)}this.setElement(null)}Amm.callMethods(this,"_cleanup_");Amm.unregisterItem(this)},_requireInterfaces:function(t,e){var i=Array.prototype.slice.call(arguments);if(!(this.requiredElementInterfaces instanceof Array)){this.requiredElementInterfaces=this.requiredElementInterfaces?[this.requiredElementInterfaces]:[]}this.requiredElementInterfaces=this.requiredElementInterfaces.concat(i)}};Amm.View.Abstract=function(t){Amm.callMethods(this,"_preInit_",t);Amm.ElementBound.call(this,t);Amm.init(this,t,["element","elementPath"]);if(!this.id)this.id=Amm.getClass(this)};Amm.View.Abstract.waitForView=function(i,r,n,s,a){var o=i.findView(r,n);if(o&&o.getObserving()){s.call(a,o,i);return null}var t=function(){var e;e=function(t){if(r!==undefined&&t.id!==r)return;if(n!==undefined&&!Amm.is(t,n))return;s.call(a,o,i);i.unsubscribe("viewReady",e)};return e}();i.subscribe("viewReady",t);return t};Amm.View.Abstract.stopWaitingForView=function(t,e){t.unsubscribe("viewReady",e)};Amm.View.Abstract.prototype={"Amm.View.Abstract":"__CLASS__",twoWayInit:true,_presentationProperty:null,_observing:null,id:null,getIsReady:function(){return this.getObserving()},getObserving:function(){return this._observing},_doElementChange:function(t,e){if(this._observing)this._endObserve();if(e)e.outViewDeleted(this);Amm.ElementBound.prototype._doElementChange.call(this,t,e);if(t)t.outViewAdded(this);Amm.callMethods(this,"_elementChange_",t,e);this._observeElementIfPossible()},_canObserve:function(){if(!this._presentationProperty)return false;return!!(this._element&&this[this._presentationProperty])},_endObserve:function(){this._observing=false;if(this._element)this._element.unsubscribe(undefined,undefined,this);this._releaseResources()},_observeElementIfPossible:function(){var t=this._canObserve();if(!t){if(this._observing)this._endObserve();return}if(this._observing)return;this._observing=true;this._acquireResources();var e=[],i={};for(var r in this){if(typeof this[r]==="function"){var n=(""+r).slice(0,4);if(n==="setV"||n==="getV"){var s=r[4].toLowerCase()+r.slice(5);if(!i[s]){i[s]=true;this._observeProp(s,"setV"+r.slice(4),e)}}else{if((""+r).slice(0,14)==="_handleElement"){var a=r[14].toLowerCase()+r.slice(15);if(this._element.hasEvent(a))this._element.subscribe(a,this[r],this)}}}}this._initProperties(e);this._element.outViewReady(this);return true},_acquireResources:function(){},_releaseResources:function(){},_observeProp:function(t,e,i){var r={};Amm.detectProperty(this._element,t,r);if(this[e]){if(r.eventName)this._element.subscribe(r.eventName,e,this)}if(r.getterName){r.propName=t;i.push(r)}},_initProperties:function(t){for(var e=0;e<t.length;e++){var i=t[e],r=i.propName;r=r[0].toUpperCase()+r.slice(1);var n="setV"+r,s="getV"+r;var a=this._element[i.getterName]();if(this.twoWayInit&&a===undefined&&i.setterName&&typeof this[s]==="function"){var o=this[s]();if(o!==undefined){this._element[i.setterName](o)}}else{if(typeof this[n]==="function")this[n](a)}}},getSuggestedTraits:function(){return[]}};Amm.extend(Amm.View.Abstract,Amm.ElementBound);Amm.View.Html=function(t){Amm.DomHolder.call(this,{})};Amm.View.Html.prototype={"Amm.View.Html":"__CLASS__",_presentationProperty:"_htmlElement",_htmlElement:null,_deferHtmlElementRef:null,_resolveHtmlElement:true,_relativeToView:null,_waitHandler:null,_preInit_htmlView:function(t){if(t&&t.relativeToView){this.setRelativeToView(t.relativeToView)}},setHtmlSource:function(t){var e=jQuery(t);if(!e.length)throw Error("Cannot setHtmlSource: selector '"+t+"' doesn't return any elements");var i=jQuery.parseHTML(e[0].innerHTML.replace(/^\s+|\s+$/g,""))[0];this.setHtmlElement(i)},setHtmlElement:function(t){if(this._resolveHtmlElement||this._relativeToView)t=this._implResolveHtmlElement(t);var e=this._htmlElement;if(e===t)return;if(e){this._releaseDomNode(e)}this._htmlElement=t;this._doSetHtmlElement(t,e);this._observeElementIfPossible();return true},_implResolveHtmlElementRelativeToView:function(t){var e,i;if(this._deferHtmlElementRef["Amm.Builder.Ref"]){this._deferHtmlElementRef.setNode(t.getHtmlElement());e=this._deferHtmlElementRef.resolve(true)}else{i=jQuery(t.getHtmlElement());e=i.find(this._deferHtmlElementRef)[0];if(!e)e=i.closest(this._deferHtmlElementRef)[0]}if(e&&(e instanceof HTMLElement||e.nodeType))this.setHtmlElement(e);else{console.warn(Amm.getClass(this)+" of "+Amm.getClass(this._element)+": cannot resolve HTMLElement relative to view '"+t.id+"' using selector '"+this._deferHtmlElementRef)}this._deferHtmlElementRef=null},_elementChange_htmlView:function(t,e){if(e&&this._waitHandler){Amm.View.Abstract.stopWaitingForView(e,this._waitHandler);this._waitHandler=null}if(t&&this._deferHtmlElementRef){this._resolveOrDeferHtmlElementRelativeToView(this._deferHtmlElementRef)}},_resolveOrDeferHtmlElementRelativeToView:function(t){this._deferHtmlElementRef=t;if(!this._element)return null;var e=this._relativeToView===true?undefined:this._relativeToView;if(this._element){var i=Amm.View.Abstract.waitForView(this._element,e,"Amm.View.Html",this._implResolveHtmlElementRelativeToView,this);this._waitHandler=i}},_implResolveHtmlElement:function(t){if(!t)return null;if(t instanceof HTMLElement||t.nodeType){return t}if(typeof t==="string"||t["Amm.Builder.Ref"]||"$ref"in t){if(t.$ref)t=new Amm.Builder.Ref(t);if(this._relativeToView){return this._resolveOrDeferHtmlElementRelativeToView(t)}if(t["Amm.Builder.Ref"])return t.resolve(true);return jQuery(t)[0]||null}if(t.jquery)return t[0]||null;throw Error("`htmlElement` of Amm.View.Html is expected to be HTMLElement instance"+", string or jQuery result or FALSEable value; provided: "+Amm.describeType(t))},_doSetHtmlElement:function(t,e){},setRelativeToView:function(t){var e=this._relativeToView;if(e===t)return;this._relativeToView=t;return true},getRelativeToView:function(){return this._relativeToView},getHtmlElement:function(){return this._htmlElement},_acquireResources:function(){this._acquireDomNode(this._htmlElement)},_releaseResources:function(){if(this._htmlElement)this._releaseDomNode(this._htmlElement)},_cleanup_AmmViewHtml:function(){this.setHtmlElement(null)}};Amm.extend(Amm.View.Html,Amm.DomHolder);Amm.View.Abstract.Visual=function(t){Amm.View.Abstract.call(this,t);this._requireInterfaces("Visual","ClassName")};Amm.View.Abstract.Visual.prototype={"Amm.View.Abstract.Visual":"__CLASS__",setVVisible:function(t){},getVVisible:function(){},setVDisplayParent:function(t){},getVDisplayParent:function(){},setVDisplayOrder:function(t){},getVDisplayOrder:function(){},setVClassName:function(t){},getVClassName:function(){}};Amm.extend(Amm.View.Abstract.Visual,Amm.View.Abstract);Amm.View.Abstract.Annotated=function(t){this._childViews=[];Amm.View.Abstract.call(this,t);this._requireInterfaces("Annotated")};Amm.View.Abstract.Annotated.prototype={"Amm.View.Abstract.Annotated":"__CLASS__",_childViews:null,enumerateExisting:true,_observeElementIfPossible:function(){var t=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);if(t){if(this.enumerateExisting)this._createExisting()}return t},_createExisting:function(){},_doElementChange:function(t,e){Amm.View.Abstract.prototype._doElementChange.call(this,t,e);if(e)e.getAnnotationsContainer().unsubscribe(undefined,undefined,this);this._clearChildViews();if(t){var i=t.getAnnotationsContainer();i.subscribe("acceptedElements",this._onAnnotationAdded,this);var r=i.getElements();for(var n=0;n<r.length;n++){this._createChildViewsOrDefer(r[n])}}},_clearChildViews:function(){for(var t=this._childViews.length-1;t>=0;t--){this._childViews[t].cleanup();delete this._childViews[t]}},_createViewOnChildContentChange:function(t,e){var i=Amm.event.origin;if(t&&i._annotated_needCreateViews){if(this._createChildViews(i)){i.unsubscribe("contentChange",this._createViewOnChildContentChange,this);i._annotated_needCreateViews=false}}},_createChildViewsOrDefer:function(t){if(!this._createChildViews(t)){t._annotated_needCreateViews=true;t.subscribe("contentChange",this._createViewOnChildContentChange,this)}},_onAnnotationAdded:function(t){for(var e=0,i=t.length;e<i;e++){this._createChildViewsOrDefer(t[e])}},_createChildViews:function(t,e){},cleanup:function(){this._clearChildViews();Amm.View.Abstract.prototype.cleanup.call(this)}};Amm.extend(Amm.View.Abstract.Annotated,Amm.View.Abstract);Amm.View.Abstract.Input=function(t){Amm.View.Abstract.call(this,t);this._requireInterfaces("Focusable","Editor","Lockable")};Amm.View.Abstract.Input.prototype={"Amm.View.Abstract.Input":"__CLASS__",setVFocused:function(t){},getVFocused:function(){},setVReadOnly:function(t){},getVReadOnly:function(){},setVEnabled:function(t){},getVEnabled:function(){},setVValue:function(t){},getVValue:function(){},setVLocked:function(t){}};Amm.extend(Amm.View.Abstract.Input,Amm.View.Abstract);Amm.View.Abstract.Collection=function(t){Amm.View.Abstract.call(this,t)};Amm.View.Abstract.Collection.prototype={"Amm.View.Abstract.Collection":"__CLASS__",_observesCollection:false,_collection:null,_requiresElement:false,_collectionProperty:null,_colEv:null,_canObserveCollection:function(){var t=this._collection&&(!this._requiresElement||this._element);if(this._presentationProperty)t=t&&this[this._presentationProperty];return!!t},_observeCollectionIfPossible:function(){var t=this._canObserveCollection();if(t){if(!this._observesCollection){this._beginObserveCollection()}}else{if(this._observesCollection){this._endObserveCollection()}}},_beginObserveCollection:function(){if(this._observesCollection)return;this._observesCollection=true;this._colEv=[];var t="_handleCollection",e=t.length;for(var i in this){if(i[0]==="_"&&i.slice(0,e)===t&&typeof this[i]==="function"){var r=i.charAt(e).toLowerCase()+i.slice(e+1);this._collection.subscribe(r,this[i],this);this._colEv.push(r)}}},_endObserveCollection:function(){if(!this._observesCollection)return;this._observesCollection=false;if(this._colEv){for(var t=0,e=this._colEv.length;t<e;t++)this._collection.unsubscribe(this._colEv[t],undefined,this)}},setCollection:function(t){var e=this._collection;if(e===t)return;if(e)this._endObserveCollection();this._collection=t;this._observeCollectionIfPossible();return true},getCollection:function(){return this._collection},setRequiresElement:function(t){var e=this._requiresElement;if(e===t)return;this._requiresElement=t;this._observeCollectionIfPossible();return true},getRequiresElement:function(){return this._requiresElement},getObservesCollection:function(){return this._observesCollection},setCollectionProperty:function(t){var e=this._collectionProperty;if(e===t)return;if(this._element&&e)this._element.unsubscribe(e+"Change",undefined,this);this._collectionProperty=t;var i=t+"Change";if(this._element&&this._element.hasEvent(i))this._element.subscribe(i,this._onElementCollectionPropertyChange,this);this._checkCollectionProperty();return true},_checkCollectionProperty:function(t){if(!this._element&&!t)return;var e=null;if(this._element){if(this._collectionProperty){e=Amm.getProperty(this._element,this._collectionProperty)}else if(Amm.is(this._element,"Amm.Collection")){e=this._element}}this.setCollection(e)},getCollectionProperty:function(){return this._collectionProperty},_onElementCollectionPropertyChange:function(t,e){this.setCollection(t)},_doElementChange:function(t,e){Amm.View.Abstract.prototype._doElementChange.call(this,t,e);this._checkCollectionProperty(!!e)},_observeElementIfPossible:function(){var t=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);this._observeCollectionIfPossible();if(!t)return t;if(this._collectionProperty){var e=this._collectionProperty+"Change";if(this._element&&this._element.hasEvent(e)){this._element.subscribe(e,this._onElementCollectionPropertyChange,this)}}return t}};Amm.extend(Amm.View.Abstract.Collection,Amm.View.Abstract);Amm.View.Abstract.Content=function(t){Amm.View.Abstract.call(this,t);this._requireInterfaces("Content")};Amm.View.Abstract.Content.prototype={"Amm.View.Abstract.Content":"__CLASS__",_elementContentTranslator:null,_contentTranslator:null,_lastContent:undefined,setContentTranslator:function(t){if(t)t=Amm.constructInstance(t,"Amm.Translator");else t=null;var e=this._contentTranslator;if(e===t)return;this._contentTranslator=t;if(this._observing&&this._lastContent!==undefined)this.setVContent(this._lastContent);return true},getContentTranslator:function(){return this._contentTranslator},setVContentTranslator:function(t){this._elementContentTranslator=t;if(!this._contentTranslator&&this._lastContent!==undefined&&this._observing){this.setVContent(this._lastContent)}},_doHandleInTranslationError:function(t,e){},_doHandleOutTranslationError:function(t,e){},setVContent:function(t){this._lastContent=t;var e=this._contentTranslator||this._elementContentTranslator;var i,r={};if(e){i=e.translateOut(t,r);if(r.error)i=this._doHandleInTranslationError(t,r.error)}else{i=t}this._doSetContent(i)},getVContent:function(){var t=this._doGetContent();var e=this._contentTranslator||this._elementContentTranslator;var i,r={};if(e){i=e.translateIn(t,r);if(r.error)i=this._doHandleInTranslationError(t,r.error)}else{i=t}return i},_doSetContent:function(t){},_doGetContent:function(){}};Amm.extend(Amm.View.Abstract.Content,Amm.View.Abstract);Amm.View.Abstract.Select=function(t){Amm.View.Abstract.call(this,t);this._requireInterfaces("Select")};Amm.View.Abstract.Select.prototype={"Amm.View.Abstract.Select":"__CLASS__",_fieldView:null,_collectionView:null,_observeElementIfPossible:function(){var t=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);if(t)this._doObserveSelect();return t},_createFieldView:function(){},_createCollectionView:function(){},_doObserveSelect:function(){if(!this._collectionView)this._createCollectionView();this._collectionView.setElement(this._element);if(!this._fieldView)this._createFieldView();this._fieldView.setElement(this._element)},_endObserve:function(){this._fieldView.setElement(null);this._collectionView.setElement(null)}};Amm.extend(Amm.View.Abstract.Select,Amm.View.Abstract);Amm.View.Html.Visual=function(t){Amm.View.Abstract.Visual.call(this,t);Amm.View.Html.call(this)};Amm.View.Html.Visual.defaultDelay=250;Amm.View.Html.Visual.prototype={"Amm.View.Html.Visual":"__CLASS__",delay:undefined,setVVisible:function(t){var e=this.delay;if(e===undefined)e=Amm.View.Html.Visual.defaultDelay;jQuery(this._htmlElement)[t?"show":"hide"](e)},getVVisible:function(){if(!this._htmlElement)return undefined;var t=this._htmlElement.style.display!=="none";return t},setVDisplayParent:function(t){},getVDisplayParent:function(){},setVDisplayOrder:function(t){},getVDisplayOrder:function(){},setVToggleClass:function(t,e){jQuery(this._htmlElement)[e?"addClass":"removeClass"](t)},getVToggleClass:function(t){return jQuery(this._htmlElement).hasClass(t)},setVClassName:function(t){jQuery(this._htmlElement).attr("class",t)},getVClassName:function(){return jQuery(this._htmlElement).attr("class")},cleanup:function(){Amm.View.Abstract.Visual.prototype.cleanup.call(this);if(this._htmlElement)this._releaseDomNode(this._htmlElement)},_acquireResources:function(){this._acquireDomNode(this._htmlElement)},getSuggestedTraits:function(){return[Amm.Trait.Visual]}};Amm.extend(Amm.View.Html.Visual,Amm.View.Html);Amm.extend(Amm.View.Html.Visual,Amm.View.Abstract.Visual);Amm.View.Html.Annotated=function(t){Amm.DomHolder.call(this);Amm.View.Abstract.Annotated.call(this,t)};Amm.View.Html.Annotated.prototype={"Amm.View.Html.Annotated":"__CLASS__",annotationClass:"annotation",annotationClassPrefix:"a_",createNodesOnDemand:true,classToId:function(t,e){if(e){var i=t.replace(/^\s+|\s+$/g,"").split(/\s+/);for(var r=0;r<i.length;r++){var n=this.classToId(i[r]);if(n)return n}return null}if(t===this.annotationClass)return null;var s=this.annotationClassPrefix.length,a=null;if(!s)a=t;else if(t.slice(0,s)===this.annotationClassPrefix){a=t.slice(s)}return a},idToClass:function(t){return this.annotationClassPrefix+t},locateChildHtmlElement:function(t,e){if(!this._htmlElement)return null;var i=this.idToClass(t),r="."+this.idToClass(t);if(this.annotationClass)r="."+this.annotationClass+r;var n=jQuery(this._htmlElement).find(r);if(!n.length){if(e){n=jQuery('<div class="'+this.annotationClass+" "+i+'"></div>');jQuery(this._htmlElement).append(n)}else{n=null}}return n},_createExisting:function(){if(!this._htmlElement)return null;var n=this,t={};jQuery(this._htmlElement).find("."+this.annotationClass).each(function(t,e){var i=n.classToId(e.getAttribute("class"),true);var r=n._element.getAnnotationsContainer().getAnnotationElement(i);n._createChildViews(r,true,e)});return t},_createChildViews:function(t,e,i){i=i||this.locateChildHtmlElement(t.getId(),this.createNodesOnDemand);if(!i){if(e)throw Error("Cannot locate child htmlElement for child with id "+t.getId());if(this.createNodesOnDemand){t._annotated_needCreateViews=true}return null}var r=[];if(t["Visual"]){r.push(new Amm.View.Html.Visual({element:t,htmlElement:i}))}r.push(new Amm.View.Html.Content({element:t,htmlElement:i}));return r},_acquireResources:function(){this._acquireDomNode(this._htmlElement)},getSuggestedTraits:function(){return[Amm.Trait.Annotated]}};Amm.extend(Amm.View.Html.Annotated,Amm.View.Html);Amm.extend(Amm.View.Html.Annotated,Amm.View.Abstract.Annotated);Amm.View.Html.Collection=function(t){Amm.registerItem(this);Amm.View.Html.call(this);this._mappingProp="_map_vhc_"+this._amm_id;Amm.View.Abstract.Collection.call(this,t)};Amm.View.Html.Collection.prototype={"Amm.View.Html.Collection":"__CLASS__",debug:false,itemHtmlElementsMustBeOrphans:true,_mappingProp:null,createItemHtml:function(t){return"<div>Overwrite createItemHtml!</div>"},updateItemHtml:function(t,e){return jQuery(this.createItemHtml(t))[0]},_doSetHtmlElement:function(t,e){if(!this._canObserve()&&this._canObserveCollection())this._acquireResources()},getItemHtmlElement:function(t){if(t[this._mappingProp])return t[this._mappingProp];var e=this._createAndBindHtmlNode(t);if(!e[this._mappingProp]){e[this._mappingProp]=t;t[this._mappingProp]=e}return e},getHtmlElementItem:function(t){return t[this._mappingProp]},rebuild:function(){return this._rebuild()},_canObserve:function(){if(!this._presentationProperty)return false;return!!(this._element&&this[this._presentationProperty])},_createAndBindHtmlNode:function(t){var e=this.createItemHtml(t);if(typeof e==="string")e=jQuery(e)[0];if(!e||!e.nodeType)Error("Cannot reliabliy create and bind Html Node");if(e.parentNode&&e.parentNode.nodeType!==11){if(this.itemHtmlElementsMustBeOrphans){Error("createItemHtml() is supposed to create new nodes, but this one already has parentNode")}else{e.parentNode.removeChild(e)}}e[this._mappingProp]=t;t[this._mappingProp]=e;return e},_beginObserveCollection:function(){this._rebuild();Amm.View.Abstract.Collection.prototype._beginObserveCollection.call(this)},_clearContainer:function(){var i=jQuery(this._htmlElement);var r=this._mappingProp;i.contents().each(function(t,e){if(e[r]){if(e[r][r]===e)delete e[r][r];delete e[r]}i[0].removeChild(e)})},_rebuild:function(){if(this.debug)console.log(this.debug,"_rebuild");this._clearContainer();this._insertToContainer()},_insertToContainer:function(t,e,i){i=i||false;t=t||this._collection;for(var r=0;r<t.length;r++){var n=this.getItemHtmlElement(t[r],!i);if(n){if(!e)this._htmlElement.appendChild(n);else this._htmlElement.insertBefore(n,e)}}},_handleCollectionAppendItems:function(t){if(this.debug)console.log(this.debug,"_handleCollectionAppendItems",t.length);this._insertToContainer(t)},_handleCollectionDeleteItem:function(t,e){if(this.debug)console.log(this.debug,"_handleCollectionDeleteItem",t,e._amm_id);var i=this._mappingProp,r=e[i];if(r){if(r.parentNode===this._htmlElement)this._htmlElement.removeChild(r);if(r[i])delete r[i];delete e[i]}},refreshAllItems:function(){if(!this._collection||!this._htmlElement)return;for(var t=0,e=this._collection.length;t<e;t++){this.refreshItem(this._collection[t])}},refreshItem:function(t){if(!this._collection||!this._htmlElement)return;var e=this._mappingProp,i=t[e],r=this.updateItemHtml(t,i);if(!r)return;var n=jQuery(r)[0];if(!n||n===i)return;if(!n.nodeType){Error("updateItemHtml() returned something that is not an HTML Node")}if(n.parentNode&&n.parentNode.nodeType!==11){if(this.itemHtmlElementsMustBeOrphans){Error("updateItemHtml() is supposed to create new nodes, but this one already has parentNode")}else{n.parentNode.removeChild(n)}}if(!jQuery(n).has(i).length){jQuery(i).replaceWith(n)}i[e]=null;n[e]=t;t[e]=n},_handleCollectionItemChange:function(t){this.refreshItem(t)},_handleCollectionSpliceItems:function(t,e,i){if(e.length>=this._htmlElement.childNodes.length){this._rebuild();return}var r=this._htmlElement.childNodes;for(var n=t,s=Math.min(t+e.length,r.length);n<s;n++){this._htmlElement.removeChild(r[t])}this._insertToContainer(i,r[t]);var a=this._mappingProp;for(var n=0,s=e.length;n<s;n++){if(e[n][a]&&!e[n][a].parentNode){if(e[n][a][a])delete e[n][a][a];delete e[n][a]}}},_handleCollectionMoveItem:function(t,e,i){if(this.debug)console.log(this.debug,"_handleCollectionMoveItem",t,e,i._amm_id);var r,n=this._htmlElement.childNodes;var s=n[t];this._htmlElement.removeChild(s);var a=n[e];if(a)this._htmlElement.insertBefore(s,a);else this._htmlElement.appendChild(s)},_handleCollectionClearItems:function(){if(this.debug)console.log(this.debug,"_handleCollectionClearItems");this._clearContainer()},_handleCollectionItemsChange:function(t,e){if(this.debug)console.log(this.debug,"_handleCollectionItemsChange",t.length,e.length);this._rebuild()}};Amm.extend(Amm.View.Html.Collection,Amm.View.Html);Amm.extend(Amm.View.Html.Collection,Amm.View.Abstract.Collection);Amm.View.Html.DisplayParent=function(t){this.requiredElementInterfaces=this.requiredElementInterfaces||[];this.requiredElementInterfaces.push("DisplayParent");delete this._handleCollectionItemChange;Amm.View.Html.Collection.call(this,t)};Amm.View.Html.DisplayParent.prototype={"Amm.View.Html.DisplayParent":"__CLASS__",debug:false,_collectionProperty:"displayChildren",itemHtmlElementsMustBeOrphans:false,scanForItems:true,buildItems:false,scanForDisplayOrder:true,getItemHtmlElement:function(t,e){var i=this._getItemView(t,e);var r=null;if(i)r=i.getHtmlElement();if(!r&&!e){Error("Collection item doesn't have view with htmlElement")}if(!r[this._mappingProp]){r[this._mappingProp]=t;t[this._mappingProp]=r}return r},updateItemHtml:function(t,e){},_getItemView:function(t,e){var i=t.getUniqueSubscribers("Amm.View.Html.Visual");if(!i.length){if(!e)Error("Collection item doesn't have respective Amm.View.Html.Visual view");return null}if(!i.length>1)console.warn("Collection item have more than one Amm.View.Html.Visual view");return i[0]},_getHtmlElementsWithItems:function(){var t=Amm.domHolderAttribute;return jQuery(this._htmlElement).children("["+t+"]").toArray()},_getElementOfHtmlElement:function(t){var e=Amm.domHolderAttribute;var i=(t.getAttribute(e)+"").split(" ");var r=Amm.getItem(i);var n=null;for(var s=0,a=r.length;s<a;s++){if(Amm.is(r[s],"Amm.View.Html.Visual")){n=r[s].getElement();if(n)return n}}return null},_getItemsInContainer:function(){var t=this._getHtmlElementsWithItems();var e=[];for(var i=0,r=t.length;i<r;i++){var n=this._getElementOfHtmlElement(t[i]);if(!n)continue;e.push(n)}return e},_updateCollectionWithFoundItems:function(t){var e=this.scanForItems,i=this.scanForDisplayOrder;if(e&&i){var r=Amm.Array.diff(t,this._collection);if(r.length)this._collection.push.apply(this._collection,r);for(var n=0;n<t.length;n++)t[n].setDisplayOrder(n)}else if(e){var r=Amm.Array.diff(t,this._collection);if(r.length)this._collection.push.apply(this._collection,this._collection.length,t)}else{for(var n=0;n<t.length;n++)t[n].setDisplayOrder(n)}},_scanForItems:function(){if(this.buildItems){var t=new Amm.Builder(jQuery(this._htmlElement));t.build()}var e=this.scanForItems,i=this.scanForDisplayOrder;if(!e&&!i)return;var r=this._getItemsInContainer();if(r.length)this._updateCollectionWithFoundItems(r)},_beginObserveCollection:function(){this._scanForItems();Amm.View.Html.Collection.prototype._beginObserveCollection.call(this)},getSuggestedTraits:function(){return[Amm.Trait.DisplayParent]}};Amm.extend(Amm.View.Html.DisplayParent,Amm.View.Html.Collection);Amm.View.Html.StaticDisplayParent=function(t){Amm.View.Html.DisplayParent.call(this,t)};Amm.View.Html.StaticDisplayParent.prototype={"Amm.View.Html.StaticDisplayParent":"__CLASS__",_oldAllowAdd:null,_oldAllowDelete:null,_oldAllowChangeOrder:null,_scanForItems:function(){if(!this.scanForItems){console.warn("Setting Amm.View.Html.StaticDisplayParent::scanForItems to FALSE has no effect; property was reset back to TRUE");this.scanForItems=true}if(!this.scanForDisplayOrder){console.warn("Setting Amm.View.Html.StaticDisplayParent::scanForDisplayOrder to FALSE has no effect; property was reset back to TRUE");this.scanForDisplayOrder=true}return Amm.View.Html.DisplayParent.prototype._scanForItems.apply(this)},_beginObserveCollection:function(){this._oldAllowAdd=this._collection.getAllowAdd();this._oldAllowDelete=this._collection.getAllowDelete();this._oldAllowChangeOrder=this._collection.getAllowChangeOrder();if(!this._oldAllowAdd)this._collection.setAllowAdd(true);if(!this._oldAllowDelete)this._collection.setAllowDelete(true);if(!this._oldAllowChangeOrder)this._collection.setAllowChangeOrder(true);return Amm.View.Html.DisplayParent.prototype._beginObserveCollection.apply(this)},_freezeCollection:function(){this._collection.setAllowAdd(false);this._collection.setAllowDelete(false);this._collection.setAllowChangeOrder(false)},_endObserveCollection:function(){this._collection.setAllowAdd(this._oldAllowAdd);this._collection.setAllowDelete(this._oldAllowDelete);this._collection.setAllowChangeOrder(this._oldAllowChangeOrder);return Amm.View.Html.DisplayParent.prototype._endObserveCollection.apply(this)},_getHtmlElementsWithItems:function(){var t=Amm.domHolderAttribute;var e=jQuery(this._htmlElement).find("["+t+"]");var i=e.not(e.find("["+t+"]"));return i},_updateCollectionWithFoundItems:function(t){if(this._collection.length&&!Amm.Array.equal(this._collection,t)){console.warn("Pre-populated display children are replaced by Amm.View.Html.StaticDisplayParent detection routine")}this._collection.setItems(t);this._freezeCollection()},_rebuild:function(){}};Amm.extend(Amm.View.Html.StaticDisplayParent,Amm.View.Html.DisplayParent);Amm.View.Html.StaticDisplayParent.WithContainers=function(t){Amm.View.Html.StaticDisplayParent.call(this,t)};Amm.View.Html.StaticDisplayParent.WithContainers.prototype={"Amm.View.Html.StaticDisplayParent.WithContainers":"__CLASS__"};Amm.extend(Amm.View.Html.StaticDisplayParent.WithContainers,Amm.View.Html.StaticDisplayParent);Amm.View.Html.Input=function(t){var e=this;this._handler=function(t){return e._receiveEvent(t,this)};Amm.View.Abstract.Input.call(this,t);Amm.View.Html.call(this);Amm.JQueryListener.call(this,{})};Amm.View.Html.Input.prototype={"Amm.View.Html.Input":"__CLASS__",_eventName:"change focus blur",_blurTimeoutHandler:null,_resolveHtmlElement:false,_watchKeys:false,_receiveEvent:function(t){if(!this._element)return;if(t.type==="focus"){this._element.setFocusedView(this);return true}if(t.type==="blur"){var e=this;if(!this._blurTimeoutHandler)this._blurTimeoutHandler=function(){if(e._element.getFocusedView()===e)e._element.setFocusedView(null)};window.setTimeout(this._blurTimeoutHandler,1);return true}if(!this._element.getReadOnly()){this._element.setValue(this.getVValue())}return true},setVFocusedView:function(t){var e=t===this;var i=jQuery(this._htmlElement);if(i[0]){if(e&&!i.is(":focus"))i.focus();else if(!e&&i.is(":focus"))i.blur()}},getVFocusedView:function(){if(jQuery(this._htmlElement).is(":focus"))return this},setVReadOnly:function(t){var e=jQuery(this._htmlElement);if(e[0]){if(t&&!e[0].hasAttribute("readonly"))e[0].setAttribute("readonly","readonly");else if(!t&&e[0].hasAttribute("readonly"))e[0].removeAttribute("readonly")}},getVReadOnly:function(){var t=jQuery(this._htmlElement)[0];if(t)return t.getAttribute("readonly")},_doSetEnabled:function(t,e){if(t===undefined)t=this._element.getEnabled();if(e===undefined)e=this._element.getLocked();r=!t||e;var i=jQuery(this._htmlElement),r=!t||e;if(i[0]){if(r&&!i[0].hasAttribute("disabled"))i[0].setAttribute("disabled","disabled");else if(!r&&i[0].hasAttribute("disabled"))i[0].removeAttribute("disabled")}},setVEnabled:function(t){this._doSetEnabled(t,undefined)},getVEnabled:function(){var t=jQuery(this._htmlElement)[0];if(t)return!t.hasAttribute("disabled")},setVValue:function(t){if(this._htmlElement){jQuery(this._htmlElement).val(t)}},setVLocked:function(t){this._doSetEnabled(undefined,t)},getVValue:function(){if(this._htmlElement)return jQuery(this._htmlElement).val()},_doSetHtmlElement:function(t){this.setSelector(t)},cleanup:function(){Amm.View.Abstract.Input.prototype.cleanup.call(this);Amm.JQueryListener.prototype.cleanup.call(this);if(this._htmlElement)this._releaseDomNode(this._htmlElement)},_acquireResources:function(){this._acquireDomNode(this._htmlElement)},getSuggestedTraits:function(){return[Amm.Trait.Input]},setUpdateOnKeyUp:function(t){t=!!t;var e=this._eventName;var i=this.getUpdateOnKeyUp();if(t===i)return;if(t&&!i)e+=" keyup";else e=e.replace(/\bkeyup\b/g,"").replace(/ +/," ").replace(/^ +| +$/g,"");this.setEventName(e)},getUpdateOnKeyUp:function(){return!!this._eventName.match(/\bkeyup\b/)}};Amm.extend(Amm.View.Html.Input,Amm.View.Html);Amm.extend(Amm.View.Html.Input,Amm.JQueryListener);Amm.extend(Amm.View.Html.Input,Amm.View.Abstract.Input);Amm.View.Html.Variants=function(t){Amm.View.Abstract.call(this,t);Amm.View.Html.call(this,t);Amm.DomHolder.call(this);this._requireInterfaces("InstantiatorOrRepeater")};Amm.View.Html.Variants.ERROR_BOTH_ATTRIBS="HTML definition of variant prototype cannot have both data-amm-default and data-amm-condition";Amm.View.Html.Variants.ERROR_DEFAULT_DEFINED="Default variant prototype was already defined";Amm.View.Html.Variants.ERROR_INVALID_ATTRIBUTE="Attribute data-amm-condition should contain hash value";Amm.View.Html.Variants.prototype={"Amm.View.Html.Variants":"__CLASS__",_observeElementIfPossible:function(){var t=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);if(!t)return t;this._scanHtmlElementAndConfigureInstantiator();return t},_scanHtmlElementAndConfigureInstantiator:function(){var t=Amm.View.Html.Variants.scanNodeForVairants(this._htmlElement);if(!t)return;this._element.reportInstantiatorOptions(t.default,t.conditions,t.prototypes)}};Amm.extend(Amm.View.Html.Variants,Amm.View.Html);Amm.extend(Amm.View.Html.Variants,Amm.View.Abstract);Amm.View.Html.Variants.builderExtension_build=function(t,e,i){var r=Amm.View.Html.Variants.scanNodeForVairants(t);if(!r)return;e.initialInstantiatorOptions=[r.default,r.conditions,r.prototypes]};Amm.View.Html.Variants.scanNodeForVairants=function(t){var e,i;var r=[],n={};var s=null;for(e=0;e<t.childNodes.length;e++){var a=t.childNodes[e];if(!a.hasAttribute)continue;var o=a.hasAttribute("data-amm-default");var l=a.hasAttribute("data-amm-condition");if(o&&l){console.error(Amm.View.Html.Variants.ERROR_BOTH_ATTRIBS,a);throw Error(Amm.View.Html.Variants.ERROR_BOTH_ATTRIBS)}if(o){if(s){console.error(Amm.View.Html.Variants.ERROR_DEFAULT_DEFINED,a,s);throw Error(Amm.View.Html.Variants.ERROR_DEFAULT_DEFINED)}s=a;continue}var h=(window.RJSON||window.JSON).parse(a.getAttribute("data-amm-condition"));if(!(h&&typeof h==="object")){console.error(Amm.View.Html.Variants.ERROR_INVALID_ATTRIBUTE,a);throw Error(a)}i=h._id||"condition_"+r.length;h._id=i;r.push(h);n[i]=a}if(!r.length&&!s)return;return{default:s,conditions:r,prototypes:n}};Amm.View.Html.Toggle=function(t){Amm.View.Html.Input.call(this,t)};Amm.View.Html.Toggle.prototype={"Amm.View.Html.Toggle":"__CLASS__",getVIsRadio:function(){return jQuery(this._htmlElement).attr("type")==="radio"?true:undefined},setVIsRadio:function(t){jQuery(this._htmlElement).attr("type",t?"radio":"checkbox")},getVChecked:function(){var t=jQuery(this._htmlElement)[0];if(t)return t.checked},setVChecked:function(t){var e=jQuery(this._htmlElement)[0];if(e)e.checked=!!t},setVValue:function(){},getVValue:function(){},getVCheckedValue:function(){var t=jQuery(this._htmlElement)[0];if(t)return t.value},setVCheckedValue:function(t){var e=jQuery(this._htmlElement)[0];if(e)e.value=t},_receiveEvent:function(t){if(!this._element)return;if(t.type==="change"){if(this._element.getReadOnly()){this.setVChecked(this._element.getChecked());if(this._element.getIsRadio()){var e=this._element.findGroupItems(true,true);for(var i=0,r=e.length;i<r;i++){if(e[i].getChecked()){var n=e[i].getUniqueSubscribers("Amm.View.Html.Toggle");for(var s=0,a=n.length;s<a;s++)n[s].setVChecked(true)}}}}else{this._element.setChecked(this._htmlElement.checked)}return true}return Amm.View.Html.Input.prototype._receiveEvent.call(this,t)},getVGroupName:function(){return jQuery(this._htmlElement).attr("name")},getVGroupParent:function(){return jQuery(this._htmlElement).closest("form")[0]},getSuggestedTraits:function(){return[Amm.Trait.Toggle]}};Amm.extend(Amm.View.Html.Toggle,Amm.View.Html.Input);Amm.View.Html.Content=function(t){Amm.View.Abstract.Content.call(this,t);Amm.DomHolder.call(this)};Amm.View.Html.Content.prototype={"Amm.View.Html.Content":"__CLASS__",_doSetContent:function(t){jQuery(this._htmlElement).html(t)},_doGetContent:function(){return jQuery(this._htmlElement).html()},getSuggestedTraits:function(){return[Amm.Trait.Content]}};Amm.extend(Amm.View.Html.Content,Amm.View.Html);Amm.extend(Amm.View.Html.Content,Amm.View.Abstract.Content);Amm.Builder=function(t,e){this.selIgnore+=", ["+Amm.domHolderAttribute+"]";this.elements=[];this.topLevel=[];this.problems=[];if(t&&t.jquery||typeof t==="string"){this.selector=t}else if(!e&&t&&typeof t==="object"){e=t;t=null}if(e)Amm.init(this,e)};Amm.Builder._EXT_NOT_FOUND={};Amm.Builder.PROBLEM_SILENT=0;Amm.Builder.PROBLEM_CONSOLE=1;Amm.Builder.PROBLEM_HTML=2;Amm.Builder.TOP_LEVEL_ROOT="root";Amm.Builder.problemReportMode=Amm.Builder.PROBLEM_SILENT;Amm.Builder._scanId=1;Amm.Builder.prototype={_globalIds:null,selector:null,problemReportMode:undefined,sel:"[data-amm-id], [data-amm-e], [data-amm-v], [data-amm-x]",selIgnore:"[data-amm-dont-build], [data-amm-dont-build] *, [data-amm-built]",topLevelComponent:null,rememberElements:false,rememberProblems:false,elements:null,topLevel:null,reportMode:Amm.Builder.PROBLEM_CONSOLE|Amm.Builder.PROBLEM_HTML,problems:null,_parent:null,calcPrototypes:function(){return this.build(true)},calcViewPrototypes:function(t){var e,i;var r=this._parent;if(t){this._parent=new Amm.Builder.Node({e:t});if(Amm.getClass(t)){Amm.is(t,"Amm.Element","forElement");this._parent.id=t.getId()}else{this._parent.id=t.id||null}}else{this._parent=new Amm.Builder.Node({e:{}})}try{i=this.build(true);if(i.length!==1||!i[0].views||!i[0].views.length){console.log({fe:t,ep:i});var n;if(i.length!==1)n="found "+i.length+" top-level elements";else if(!i[0].views||!i[0].views.length)n="no views defined for top-level element";throw new Error("Amm.Builder: cannot calcViewPrototypes(): "+n)}e=i[0].views;if(t){for(var s=0;s<e.length;s++)e[s].element=t}}catch(t){this._parent=r;throw t}this._parent=r;return e},build:function(t){var e=this.selector;var i=this._globalIds;this._globalIds={};var r=this._scanNodes(e),n=[];var s=[];this._detectConnectedRecursive(r);for(var a=0,o=r.length;a<o;a++){n=n.concat(this._buildElements(r[a],s,t))}if(this.rememberElements){if(n.length)this.elements.push.apply(this.elements,n);if(s.length)this.topLevel.push.apply(this.topLevel,s)}this._globalIds=i;if(t)return s;return n},clear:function(){this.elements=[];this.topLevel=[];this.problems=[]},_scanNodes:function(t){if(!t)t=window.document.documentElement;var r="_amm_builder_scn_"+Amm.Builder._scanId++;var e=[],n=[],s=this;var i=jQuery(t).filter(this.sel).add(jQuery(t).find(this.sel)).not(this.selIgnore);i.each(function(t,e){var i=s._createNode(e);e[r]=n.length;n.push(i)});if(this._parent){e.push(this._parent)}for(var a=0,o=n.length;a<o;a++){var l=n[a];var h=l.htmlElement;var u=jQuery(h).parent().closest(this.sel)[0];if(u&&u[r]!==undefined){l.parent=n[u[r]];n[u[r]].children.push(l)}else{if(this._parent){l.parent=this._parent;this._parent.children.push(l)}e.push(l)}}return e},getExtData:function(t,e,i){if(i===undefined)i=Amm.Builder._EXT_NOT_FOUND;if(!(e instanceof Array))e=(""+e).split(".");var r=t,n,s=[].concat(e);while((n=s.shift())!==undefined){if(typeof r!=="object"||!(n in r))return i;r=r[n]}return r},_replaceRefsAndInstaniateObjects:function(t,e){if(!t||typeof t!=="object")return t;var i,r;if("$ref"in t)return new Amm.Builder.Ref(t,e);if("$ext"in t){var n=this.getExtData(window,t.$ext);if(n===Amm.Builder._EXT_NOT_FOUND)throw Error("Cannot resolve '$ext' "+t.$ext);if(t["$resolve"])t=n;else return n}if(t instanceof Array){for(i=0,r=t.length;i<r;i++){if(t[i]&&typeof t[i]==="object")t[i]=this._replaceRefsAndInstaniateObjects(t[i],e)}}else{for(i in t)if(t.hasOwnProperty(i)&&t[i]&&typeof t[i]==="object"){t[i]=this._replaceRefsAndInstaniateObjects(t[i],e)}if("__construct"in t){var s=t.__construct;delete t.__construct;t=Amm.constructInstance(t,s)}}return t},_createNode:function(t){var e=window.RJSON||window.JSON;var i=new Amm.Builder.Node,r;i.htmlElement=t;r=t.getAttribute("data-amm-v");if(r&&r.length){i.v=this._replaceRefsAndInstaniateObjects(e.parse(r),i.htmlElement);if(!(i.v instanceof Array))i.v=i.v?[i.v]:[];for(var n=0,s=i.v.length;n<s;n++){if(typeof i.v[n]==="string"){i.v[n]={class:i.v[n]}}i.v[n].htmlElement=t}}r=t.getAttribute("data-amm-e");if(r&&r.length)i.e=this._replaceRefsAndInstaniateObjects(e.parse(r),i.htmlElement);r=t.getAttribute("data-amm-id");if(r&&r.length){r=r.replace(/^\s+|\s+$/g,"");if(r[0]==="@"&&r[1]){i.global=true;r=r.slice(1);if(!this._globalIds[r])this._globalIds[r]=[i];else this._globalIds[r].push(i)}}if(r&&r.length){i.id=r;i.connected.id=r}r=t.getAttribute("data-amm-x");if(r&&r.length)i.x=this._replaceRefsAndInstaniateObjects(e.parse(r),i.htmlElement);return i},_connect:function(t,e){if(t.e||e.e)t.connected.groupHasElement=true;var i=t.connected.length;var r;r=Amm.Array.diff(e.connected,t.connected);t.connected.push.apply(t.connected,r);if(e.connected.groupHasElement)t.connected.groupHasElement=true;if(e.connected.id&&!t.connected.id)t.connected.id=e.connected.id;if(e.connected.alreadyBuilt)t.connected.alreadyBuilt=e.connected.alreadyBuilt;e.connected=t.connected;for(var n=i,s=t.connected.length;n<s;n++){e.connected[n].conIdx=n;e.connected[n].connected=e.connected}},_detectChildrenConnectedByIds:function(t,e){if(!t.id)return;for(var i=0,r=e.children.length;i<r;i++){var n=e.children[i];if(n===t)continue;if(n.id&&n.id!==t.id){continue}if(n.id===t.id){this._connect(t,n)}this._detectChildrenConnectedByIds(t,n)}},_detectConnectedNodes:function(t){var e,i;if(t.id){if(t.global&&(i=this._globalIds[t.id])){for(var r=0,n=i.length;r<n;r++){if(i[r]!==t)this._connect(t,i[r])}}for(e=t.parent;e;e=e.parent){if(t.id==="__parent"){t.id=null;this._connect(t,e)}if(e.id===t.id)this._connect(t,e);this._detectChildrenConnectedByIds(t,e)}}this._detectConnectedRecursive(t.children);e=t.parent;if(e&&((t.v||t.x)&&!t.e||(e.v||e.x)&&!e.e)){if(e&&e.children.length===1){var s=!!(t.e||t.connected.groupHasElement);var a=!!(e.e||e.connected.groupHasElement);var o=!(s&&a);if(o&&(!e.id||!t.id)&&(e.e||e.v||e.x)){this._connect(e,t);t.conParent=true;e.conChild=true}}}},_getAllViews:function(t){var e=t.v;if(!e)e=[];for(var i=0,r=t.connected.length;i<r;i++){if(t.connected[i]!==t)if(t.connected[i].v){e=e.concat(t.connected[i].v)}}return e},_detectConnectedRecursive:function(t){for(var e=0,i=t.length;e<i;e++){this._detectConnectedNodes(t[e])}},_buildElements:function(t,e,i){var r=[];for(var n=0,s=t.children.length;n<s;n++){r=r.concat(this._buildElements(t.children[n],e,i))}if(!t.e&&t.connected.length>1){if(t.connected.id!==undefined)t.id=t.connected.id;if(t.connected.groupHasElement){return r}else{if(t.conIdx<t.connected.length-1){return r}}if(t.connected.alreadyBuilt)return r}var a=t.e||{};var o;if(a["Amm.Element"]){if(!t.connected.views)t.connected.views=[];o=t.connected.views}else{if(!a.views)a.views=[];o=a.views}o.push.apply(o,this._getAllViews(t));if(!o.length)o.push({class:"Amm.View.Html.Default",reportMode:this.reportMode});for(var n=0,s=o.length;n<s;n++){if(!o[n].htmlElement){o[n].htmlElement=t.htmlElement}}if(t.id&&!a.id)a.id=t.id;if(!t.parent&&this.topLevelComponent&&!("component"in a)){a.component=this.topLevelComponent}this._applyExtensions(a,t);var l;if(a["Amm.Element"]){l={class:"Amm.Element",views:o}}else{l=Amm.override({class:"Amm.Element"},a)}if(!i){l=Amm.constructInstance(a,"Amm.Element")}if(e&&(!t.parent||t.parent===this._parent||t.conParent&&!t.parent.parent)){e.push(l)}r.push(l);t.connected.alreadyBuilt=true;return r},_applyExtensions:function(t,e){for(var i=0,r=e.connected.length;i<r;i++){if(e.connected[i].x){var n=this._parseExtensions(e.connected[i].x);for(var s=0,a=n.length;s<a;s++){var o=n[s].fn(e.connected[i].htmlElement,t,n[s].arg);if(o&&typeof o==="object")Amm.overrideRecursive(t,o)}}}},_getExtension:function(t){t=t.replace(/(\.|^)(\w+)$/,"$1builderExtension_$2");return Amm.getFunction(t)},_parseExtensions:function(t){if(typeof t==="string")return[{fn:this._getExtension(t),arg:undefined}];if(typeof t!=="object"){throw Error("data-amm-x must contain either string or an object")}var e=[];for(var i in t)if(t.hasOwnProperty(i)){e.push({fn:this._getExtension(i),arg:t[i]})}return e},_regProblem:function(t,e){if(t instanceof Array){for(var i=0,r=t.length;i<r;i++)this._regProblem(t[i],e);return}if(!t.htmlElement.hasAttribute(Amm.domHolderAttribute)){t.htmlElement.setAttribute(Amm.domHolderAttribute,"")}if(this.rememberProblems)this.problems.push({element:t.htmlElement,problem:e});if(this.reportMode&Amm.Builder.PROBLEM_CONSOLE){console.warn("Amm.Builder problem with HTML element",t.htmlElement,e)}if(this.reportMode&Amm.Builder.PROBLEM_HTML){this._annotate(t,e)}},_annotate:function(t,e){t.htmlElement.setAttribute("data-amm-warning",e)}};Amm.Builder.isPossibleBuilderSource=function(t){if(!t)return false;if(t["Amm.Builder.Ref"])return true;if(typeof t==="object"&&"parentNode"in t&&"tagName"in t)return true;if(t.jquery)return true;if(typeof t==="string"&&t.match(/^\<(?:.|[\n])*\>$/))return true;return false};Amm.Builder.calcPrototypeFromSource=function(t,e,i){if(!t)throw Error("`builderSource` is required");var r;if(typeof t==="string"){if(t.match(/\s*<(?:.|[\n])*>\s*$/))e=true;r=t}else if(t["Amm.Builder.Ref"]){r=t.resolve()}else if(t.tagName||t.jquery){r=t}else throw Error("Unsupported builderSource type: "+Amm.describeType(t));var n=jQuery(r);if(!n.length)throw Error("Cannot resolve builderSource reference");if(e===undefined)e=n.attr("data-amm-dont-build")===undefined;if(!e)n=n.clone();n.removeAttr("data-amm-dont-build");var s=new Amm.Builder(n);var a=i?s.calcViewPrototypes():s.calcPrototypes(true);if(!a.length)throw Error("Builder returned no prototypes");if(!i){if(a.length>1)throw Error("Builder returned more than one prototype");if(!a[0].class)a[0].class="Amm.Element";return a[0]}return a};Amm.View.Html.Default=function(t){Amm.View.Abstract.call(this,t);Amm.View.Html.call(this)};Amm.View.Html.Default.prototype={"Amm.View.Html.Default":"__CLASS__",_defaultViews:null,_replacedMyElement:false,_ownHtmlElement:null,_viewHtmlElements:null,_replaceOwnHtmlElement:true,reportMode:Amm.Builder.PROBLEM_CONSOLE|Amm.Builder.PROBLEM_HTML,setReplaceOwnHtmlElement:function(t){var e=this._replaceOwnHtmlElement;if(e===t)return;if(this._observing){throw new Error("Cannot Amm.View.Html.Default::setReplaceOwnHtmlElement() while getObserving()")}this._replaceOwnHtmlElement=t;return true},getReplaceOwnHtmlElement:function(){return this._replaceOwnHtmlElement},getOwnHtmlElement:function(){return this._ownHtmlElement},setDefaultViews:function(){if(this._defaultViews!==null)throw Error("can setDefaultViews() only once, before element observation")},getDefaultViews:function(){return this._defaultViews?[].concat(this._defaultViews):[]},_observeElementIfPossible:function(){var t=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);if(!t)return t;var e;if(this._defaultViews)e=this._defaultViews;else e=this._element.constructDefaultViews();if(!e||typeof e==="Array"&&!e.length){if(this.reportMode&Amm.Builder.PROBLEM_HTML){this._htmlElement.setAttribute("data-amm-warning","Element has no default view(s)")}if(this.reportMode&Amm.Builder.PROBLEM_CONSOLE){console.warn("Element has no default view(s): ",this._element)}return}this._defaultViews=[];if(typeof e!=="Array")e=[e];var i=[];for(var r=0,n=e.length;r<n;r++){var s=e[r],a;if(!s)continue;if(typeof s==="object"&&("class"in s||Amm.is(s,"Amm.View.Abstract"))){a=[s]}else if(Amm.Builder.isPossibleBuilderSource(s)){a=Amm.Builder.calcPrototypeFromSource(s,false,true)}else{throw new Error("incorrect result returned by Amm.Element.consturctDefaultViews() - cannot construct view")}for(var o=0,l=a.length;o<l;o++){a[o]=Amm.constructInstance(a[o],null,{element:this._element},true,["Amm.View.Html"]);this._defaultViews.push(a[o]);var h=a[o].getHtmlElement();if(h){i.push(h)}}}this._deleteNonTopNodes(i);this._setViewHtmlElements(i);return t},_deleteNonTopNodes:function(t){for(var e=t.length-1;e>=0;e--){if(t[e].parentNode&&t[e].parentNode.tagName){t.splice(e,1)}}},_replaceHtmlNodes:function(t,e){if(this._htmlElement===t[0]){if(!this._ownHtmlElement)this._ownHtmlElement=this._htmlElement;this._htmlElement=e[0]}if(!t[0].parentNode)return;var i;for(i=e.length-1;i>=0;i--){t[0].parentNode.insertBefore(e[i],t[0])}for(i=0;i<t.length;i++){t[i].parentNode.removeChild(t[i])}},_setViewHtmlElements:function(t){var e,i;e=t;if(!this._replaceOwnHtmlElement)return this._replaceContents(t);if(!e||!e.length){if(this._ownHtmlElement)e=[this._ownHtmlElement];else e=[]}i=this._viewHtmlElements;if(!i||!i.length){i=[this._htmlElement]}if(Amm.Array.equal(i,e))return;if(!e.length)return;if(this._observing){if(i.length)this._releaseDomNode(e);this._acquireDomNode(e)}if(i[0]===this._htmlElement&&!this._ownHtmlElement)this._ownHtmlElement=i[0];this._replaceHtmlNodes(i,e);this._viewHtmlElements=t&&t.length?t:null;this._htmlElement=e[0]},_doSetHtmlElement:function(t,e){if(!t||!e||!this._observing)return;var i=this._ownHtmlElement;if(i&&!this._viewHtmlElements){this._releaseDomNode(this._ownHtmlElement);return}var r=[].concat(this._viewHtmlElements);this._setViewHtmlElements([]);this._releaseResources(i);this._htmlElement=t;this._ownHtmlElement=null;this._setViewHtmlElements(r)},_replaceContents:function(t){var e=this._htmlElement.firstChild,i;while(e){i=e.nextSibling;this._htmlElement.removeChild(e);e=i}this._viewHtmlElements=t||null;if(!t)return;for(var r=0;r<t.length;r++){this._htmlElement.appendChild(t[r])}return},_releaseResources:function(){this._setViewHtmlElements([]);if(!this._defaultViews)return;for(var t=0,e=this._defaultViews.length;t<e;t++){this._defaultViews[t].setElement(null);this._defaultViews[t].setHtmlElement(null);this._defaultViews[t].cleanup()}this._defaultViews=null;Amm.View.Html.prototype._releaseResources.call(this)}};Amm.extend(Amm.View.Html.Default,Amm.View.Html);Amm.extend(Amm.View.Html.Default,Amm.View.Abstract);Amm.View.Html.Select=function(t){Amm.View.Html.call(this);Amm.View.Abstract.Select.call(this,t)};Amm.View.Html.Select.prototype={"Amm.View.Html.Select":"__CLASS__",_fieldView:null,_collectionView:null,_createFieldView:function(){var t={getVReadOnly:this._fieldView_getVReadOnly,setVReadOnly:this._fieldView_setVReadOnly,htmlElement:this._htmlElement,getVValue:this._fieldView_getVValue,setVValue:this._fieldView_setVValue};this._fieldView=new Amm.View.Html.Input(t);this._fieldView._selectView=this;this._fieldView._receiveEvent=this._fieldView_receiveEvent},_fieldView_getVReadOnly:function(){return false},_fieldView_setVReadOnly:function(t){},_fieldView_receiveEvent:function(t){if(!this._element)return;if(t.type==="change"&&this._element.getReadOnly()){this.setVValue(this._element.getValue());return true}return Amm.View.Html.Input.prototype._receiveEvent.call(this,t)},_fieldView_setVValue:function(t){if(!this._selectView._element)return;var e=this._selectView._collectionView;var i,r;if(!e)return Amm.View.Html.Input.prototype.getVValue.call(this);if(this._element.getMultiple()){for(i=0,r=this._htmlElement.options.length;i<r;i++){var n=e.getHtmlElementItem(this._htmlElement.options[i]);if(!n)continue;this._htmlElement.options[i].selected=Amm.Array.indexOf(n.getValue(),t)>=0}return}for(i=0,r=this._htmlElement.options.length;i<r;i++){var n=e.getHtmlElementItem(this._htmlElement.options[i]);this._htmlElement.options[i].selected=n.getValue()===t}},_fieldView_getVValue:function(){if(this._element.getOptions()===undefined&&this._htmlElement){this._element.setOptions(this._detectOptions(this._htmlElement));return}var t=[];var e=this._element.getMultiple();var i=this._selectView._collectionView;if(!i)return Amm.View.Html.Input.prototype.getVValue.call(this);for(var r=0,n=this._htmlElement.options.length;r<n;r++){if(!this._htmlElement.options[r].selected)continue;var s=i.getHtmlElementItem(this._htmlElement.options[r]);if(!s)continue;var a=s.getValue();if(!e){return a}else t.push(a)}if(!e)return null;return t},_detectOptions:function(t){var e=jQuery(t);var i=[];for(var r=0;r<t.options.length;r++){var n=t.options[r];var s={label:jQuery(n).html(),value:n.value};if(n.disabled)s.disabled=true;s.selected=!!n.selected;i.push(s)}return i},_createCollectionView:function(){var t=this._element.getOptions();if(t===undefined){this._element.setOptions(this._detectOptions(this._htmlElement))}var s=this;var e={collectionProperty:"optionsCollection",htmlElement:this._htmlElement,createItemHtml:function(t){var e=jQuery("<option>"+t.getLabel()+"</option>");var i=t.getValue();if(typeof i!=="object"){e.attr("value",i)}else{e.removeAttr("value")}if(t.getDisabled())e.attr("disabled","disabled");if(t.getSelected())e.attr("selected","selected");if(!t.getVisible())return e.wrap("<span>").parent()[0];else return e[0]},updateItemHtml:function(t,e){var i=false;if(e.tagName==="SPAN"){i=true;e=e.firstChild}var r=!!t.getSelected();e.selected=r;e.disabled=s._element.getReadOnly()&&!r||!!t.getDisabled();var n=t.getValue();if(typeof n!=="object"){e.value=n}else{e.removeAttribute("value")}jQuery(e).html(t.getLabel());if(!t.getVisible()){if(!i)e=jQuery(e).wrap("<span></span>").parent()[0];else e=e.parentNode}else if(i){e.parentNode.removeChild(e)}return e}};this._collectionView=new Amm.View.Html.Collection(e)},_doObserveSelect:function(){Amm.View.Abstract.Select.prototype._doObserveSelect.call(this);this._fieldView.setElement(this._element);this._collectionView.setElement(this._element)},_endObserve:function(){this._fieldView.setElement(null);this._collectionView.setElement(null)},setHtmlElement:function(t){if(t&&t.tagName!=="SELECT"){Error("<select> element must be provided")}return Amm.View.Html.prototype.setHtmlElement.call(this,t)},_doSetHtmlElement:function(t,e){if(this._fieldView)this._fieldView.setHtmlElement(this._htmlElement);if(this._collectionView)this._collectionView.setHtmlElement(this._htmlElement)},getVMultiple:function(){var t=jQuery(this._htmlElement);if(t[0])return!!t.attr("multiple")},setVMultiple:function(t){var e=jQuery(this._htmlElement);if(e[0])e.attr("multiple",t?"multiple":null)},setVReadOnly:function(t){if(this._collectionView)this._collectionView.refreshAllItems()},getVSelectSize:function(){var t=jQuery(this._htmlElement);if(t[0]){return t[0].size||1}},setVSelectSize:function(t){var e=jQuery(this._htmlElement);if(e[0])e.attr("size",t)},getSuggestedTraits:function(){return[Amm.Trait.Select]}};Amm.extend(Amm.View.Html.Select,Amm.View.Html);Amm.extend(Amm.View.Html.Select,Amm.View.Abstract.Select);Amm.Root=function(t){Amm.augment(this,Amm.Trait.Component);Amm.Element.call(this,t)};Amm.Root.prototype={"Amm.Root":"__CLASS__",_id:"^",_internalId:"root",_intervalDelay:250,_interval:null,_counter:0,strictEvents:false,setId:function(t){if(t!=="^")Error("Cannot setId() of root to anything other than '^'")},raiseEvent:function(t){var e=Array.prototype.slice.call(arguments,0);var i=this._out.apply(this,e);if(t==="bootstrap"&&Amm.getBootstrapped()){delete this._subscribers["bootstrap"]}return i},outInterval:function(){this._out("interval",this._counter++)},_subscribeFirst_bootstrap:function(){if(Amm.getBootstrapped()){this.raiseEvent("bootstrap")}},_subscribeFirst_interval:function(){var t=this;this._interval=window.setInterval(function(){t.outInterval()},this._intervalDelay)},_unsubscribeLast_interval:function(){if(this._interval){window.clearInterval(this._interval);this._interval=null}},subscribe:function(t,e,i,r,n){if(Amm.itemDebugTag&&Amm.itemDebugTag.length&&Amm.getClass(i)){if(!i._root_sub)i._root_sub={};i._root_sub[t]=Amm.itemDebugTag[Amm.itemDebugTag.length-1]}return Amm.WithEvents.prototype.subscribe.call(this,t,e,i,r,n)}};Amm.extend(Amm.Root,Amm.Element);Amm.Trait={};Amm.Trait.Field=function(){this._validators=[]};Amm.Trait.Field.VALIDATE_NEVER=0;Amm.Trait.Field.VALIDATE_BLUR=1;Amm.Trait.Field.VALIDATE_CHANGE=2;Amm.Trait.Field.VALIDATE_BLUR_CHANGE=3;Amm.Trait.Field.VALIDATE_EXPRESSIONS=4;Amm.Trait.Field.VALIDATE_INSTANT=8;Amm.Trait.Field.TRANSLATION_ERROR_IN=1;Amm.Trait.Field.TRANSLATION_ERROR_OUT=-1;Amm.Trait.Field.prototype={Field:"__INTERFACE__",_form:null,_fieldName:undefined,_fieldLabel:undefined,_validators:null,_validateMode:Amm.Trait.Field.VALIDATE_CHANGE|Amm.Trait.Field.VALIDATE_EXPRESSIONS,_fieldLocalErrors:undefined,_fieldRemoteErrors:undefined,_fieldErrors:undefined,_needValidate:false,_fieldApplied:true,_fieldRequired:undefined,fieldRequiredMessage:"lang.Amm.Validator.Required.msg",_fieldRequiredValidator:null,_fieldEmpty:undefined,_fieldValue:undefined,_fieldSyncsValue:false,_lockFieldValueChange:0,_lockAnnotationSync:0,_fieldTranslator:null,_translationErrorState:null,_fieldSyncWithAnnotations:true,_fieldInSyncWithAnnotations:false,_initValidationExpressions:null,_validationExpressions:null,_fieldIndex:undefined,__augment:function(t,e){Amm.Element.regInit(this,"99.Amm.Trait.Field",function(){this._fieldSyncsValue=!!Amm.detectProperty(this,"value");if(this._fieldSyncsValue)this.subscribe("valueChange",this._handleFormExtValueChange,this);if(Amm.detectProperty(this,"focused")){this.subscribe("focusedChange",this._handleFieldFocusedChange,this)}if(this["Annotated"]==="__INTERFACE__"&&this._fieldSyncWithAnnotations){this._syncWithAnnotations()}if(this._fieldSyncsValue){if(this._fieldValue===undefined){var t=this.getValue();if(t!==undefined){this._handleFormExtValueChange(t,undefined)}}else{this._syncFieldValueToElement(this._fieldValue)}}})},_syncWithAnnotations:function(){if(!this._fieldInSyncWithAnnotations){this.subscribe("requiredChange",this._handleSelfAnnotationRequiredChange,this);this.subscribe("labelChange",this._handleSelfAnnotationLabelChange,this);this.subscribe("errorChange",this._handleSelfAnnotationErrorChange,this);this._fieldInSyncWithAnnotations=true}if(this._fieldRequired!==undefined)this.setRequired(this._fieldRequired);else if(this._required!==undefined)this.setFieldRequired(this._required);if(this._fieldLabel!==undefined)this.setLabel(this._fieldLabel);else if(this._label!==undefined)this.setFieldLabel(this._label);if(this._fieldErrors!==undefined)this.setError(this._fieldErrors);else if(this._error!==undefined)this.setFieldRemoteErrors(this._error)},getFieldSyncsValue:function(){return this._fieldSyncsValue},_handleSelfAnnotationRequiredChange:function(t,e){if(this._lockAnnotationSync)return;if(this._fieldInSyncWithAnnotations&&this._fieldRequired===undefined)this.setFieldRequired(t)},_handleSelfAnnotationLabelChange:function(t,e){if(this._lockAnnotationSync)return;if(this._fieldInSyncWithAnnotations&&this._fieldLabel===undefined){this.setFieldLabel(t)}},_handleSelfAnnotationErrorChange:function(t,e){if(this._lockAnnotationSync)return;if(this._fieldInSyncWithAnnotations&&this._fieldLocalErrors===undefined){this.setFieldLocalErrors(t)}},setForm:function(t){if(t)Amm.is(t,"Form","form");else t=null;var e=this._form;if(e===t)return;if(e){var i=e.fields.strictIndexOf(this);if(i>=0)e.fields.removeAtIndex(i)}if(t){var r=t.fields.strictIndexOf(this);if(r<0)t.fields.accept(this)}this._form=t;this._callOwnMethods("_setForm_",this._form,e);this.outFormChange(t,e);return true},outFormChange:function(t,e){return this._out("formChange",t,e)},getForm:function(){return this._form},setFieldName:function(t){var e=this._fieldName;if(e===t)return;this._fieldName=t;this.outFieldNameChange(t,e);return true},getFieldName:function(){if(this._fieldName===undefined)return this._id;return this._fieldName},_setId_Field:function(t,e){if(this._fieldName===undefined)this.outFieldNameChange(t,e)},outFieldNameChange:function(t,e){this._callOwnMethods("_fieldNameChange_",t,e);this._out("fieldNameChange",t,e)},setFieldIndex:function(t){var e=this._fieldIndex;if(e===t)return;this._fieldIndex=t;this.outFieldIndexChange(t,e);return true},getFieldIndex:function(){return this._fieldIndex},outFieldIndexChange:function(t,e){this._out("fieldIndexChange",t,e)},setFieldLabel:function(t){var e=this._fieldLabel;if(e===t)return;this._fieldLabel=t;if(this._fieldTranslator&&this._fieldTranslator.field===e){this._fieldTranslator.field=t}if(this._fieldLocalErrors)this._revalidate();if(this._fieldInSyncWithAnnotations&&!this._lockAnnotationSync&&this.hasAnnotation("label")){this._lockAnnotationSync++;this.setLabel(this._fieldLabel);this._lockAnnotationSync--}this.outFieldLabelChange(t,e);return true},getFieldLabel:function(){return this._fieldLabel},outFieldLabelChange:function(t,e){return this._out("fieldLabelChange",t,e)},setValidators:function(t){Amm.cleanup(true,this.validators);this._validators=[];if(!t)return;if(!(t instanceof Array)){Error("`validators` must be an Array")}for(var e=0;e<t.length;e++){var i=Amm.Validator.construct(t[e]);if(typeof i.setElement==="function"){i.setElement(this)}else if("element"in i){i.element=this}this._validators.push(i)}this.setNeedValidate(true)},validate:function(t){if(!this._fieldApplied){if(t)return[];return true}if(this._translationErrorState){if(t)return this._fieldLocalErrors?[].concat(this._fieldLocalErrors):[];return false}var e=[];var i=this.getFieldEmpty();var r=this.getFieldValue();var n=this.getFieldLabel();this._doValidate(e,r,i,n);if(t){return e}this.setFieldLocalErrors(e);this.setNeedValidate(false);this.outAfterFieldValidate(!e.length,e);return!e.length},outAfterFieldValidate:function(t,e){return this._out("afterFieldValidate",t,e)},_doValidate:function(t,e,i,r){var n;if(this._fieldRequiredValidator){n=this._fieldRequiredValidator.getError(e,this.getFieldLabel());if(n){if(this._fieldRequired)t.push(n);i=true}else{i=false}}else{if(i&&this._fieldRequired){t.push(Amm.translate(this.fieldRequiredMessage,"%field",r))}}if(!i){this.outOnValidate(e,t);if(this._validationExpressions){this._applyValidationExpressions(t)}for(var s=0;s<this._validators.length;s++){n=this._validators[s].getError(e,r);if(n)t.push(n)}}},_revalidate:function(){if(this._fieldSyncsValue&&this._translationErrorState===Amm.Trait.Field.TRANSLATION_ERROR_IN){var t=this.getValue();this._handleFormExtValueChange(t,t)}else if(this._fieldSyncsValue&&this._translationErrorState===Amm.Trait.Field.TRANSLATION_ERROR_OUT){this._syncFieldValueToElement(this._fieldValue)}else{this.validate()}},outOnValidate:function(t,e){return this._out("onValidate",t,e)},getValidators:function(){return this._validators},setValidateMode:function(t){var e=this._validateMode;if(e===t)return;this._validateMode=t;if(this._needValidate&&t&Amm.Trait.Field.VALIDATE_INSTANT){this.validate()}return true},getValidateMode:function(){return this._validateMode},_setFieldErrorsArray:function(t,e,i){var r=this[t];var n=false;if(e){if(!(e instanceof Array))e=[e];else if(!e.length)e=null}else{if(e!==undefined)e=null}if(i&&this[t]){if(!e)return false;var s=Amm.Array.diff(e,this[t]);if(!s.length)return false;e=[].concat(this[t],s)}else{if(r instanceof Array&&e instanceof Array){if(r.length===e.length&&!Amm.Array.symmetricDiff(r,e).length)n=true}}if(r===e||n)return false;this[t]=e;return r},_updateFieldErrors:function(){var t=this._fieldErrors;this._fieldErrors=[].concat(this.getFieldLocalErrors()||[],this._fieldRemoteErrors||[]);this._fieldErrors=Amm.Array.unique(this._fieldErrors);if(!this._fieldErrors.length)this._fieldErrors=null;if(t===this._fieldErrors||t&&this._fieldErrors&&Amm.Array.equal(this._fieldErrors,t)){this._fieldErrors=t;return}this.outFieldErrorsChange(this._fieldErrors,t);if(!this._fieldInSyncWithAnnotations||this._lockAnnotationSync||!this.hasAnnotation("error")){return}this._lockAnnotationSync++;this.setError(this._fieldErrors&&this._fieldErrors.length?[].concat(this._fieldErrors):null);this._lockAnnotationSync--},getFieldErrors:function(){if(!this._fieldApplied)return[];if(!this._fieldErrors){this._fieldErrors=[].concat(this.getFieldLocalErrors()||[],this._fieldRemoteErrors||[]);this._fieldErrors=Amm.Array.unique(this._fieldErrors)}return this._fieldErrors&&this._fieldErrors.length?[].concat(this._fieldErrors):null},setFieldErrors:function(t,e){if(!e)this.setFieldRemoteErrors(null);this.setFieldLocalErrors(t,e)},outFieldErrorsChange:function(t,e){return this._out("fieldErrorsChange",t,e)},setFieldLocalErrors:function(t,e){var i=this._setFieldErrorsArray("_fieldLocalErrors",t,e);if(i===false)return;this._updateFieldErrors();this.outFieldLocalErrorsChange(t,i);return true},getFieldLocalErrors:function(){if(!this._fieldApplied)return[];if(this._fieldLocalErrors===undefined)this.validate();return this._fieldLocalErrors?[].concat(this._fieldLocalErrors):null},outFieldLocalErrorsChange:function(t,e){this._out("fieldLocalErrorsChange",t,e)},setFieldRemoteErrors:function(t,e){var i=this._setFieldErrorsArray("_fieldRemoteErrors",t,e);if(i===false)return;this._updateFieldErrors();this.outFieldRemoteErrorsChange(t,i);return true},getFieldRemoteErrors:function(){if(!this._fieldApplied)return[];if(this._fieldRemoteErrors===undefined)this.validate();return this._fieldRemoteErrors?[].concat(this._fieldRemoteErrors):null},outFieldRemoteErrorsChange:function(t,e){this._out("fieldRemoteErrorsChange",t,e)},setFieldApplied:function(t){t=!!t;var e=this._fieldApplied;if(e===t)return;this._fieldApplied=t;this.outFieldAppliedChange(t,e);this.setNeedValidate(true);return true},outFieldAppliedChange:function(t,e){this._out("fieldAppliedChange",t,e)},getFieldApplied:function(){return this._fieldApplied},setFieldSyncWithAnnotations:function(t){t=!!t;var e=this._fieldSyncWithAnnotations;if(e===t)return;this._fieldSyncWithAnnotations=t;if(this._fieldSyncWithAnnotations)this._syncWithAnnotations();return true},getFieldSyncWithAnnotations:function(){return this._fieldSyncWithAnnotations},getFieldInSyncWithAnnotations:function(){return this._fieldInSyncWithAnnotations},setFieldRequired:function(t){t=!!t;var e=this._fieldRequired;if(e===t)return;this._fieldRequired=t;if(this._fieldInSyncWithAnnotations&&!this._lockAnnotationSync&&this.hasAnnotation("required")){this._lockAnnotationSync++;this.setRequired(this._fieldRequired);this._lockAnnotationSync--}this.outFieldRequiredChange(t,e);this.setNeedValidate(true);return true},outFieldRequiredChange:function(t,e){return this._out("fieldRequiredChange",t,e)},getFieldRequired:function(){return this._fieldRequired},setFieldRequiredValidator:function(t){var e=this._fieldRequiredValidator;if(e===t)return;if(t){if(typeof t==="function"){t=new Amm.Validator.Function({func:t})}else{t=Amm.constructInstance(t,"Amm.Validator")}Amm.setField(t,"element",this)}this._fieldRequiredValidator=t;this.setNeedValidate(true);return true},getFieldRequiredValidator:function(){return this._fieldRequiredValidator},setFieldEmpty:function(t){var e=this._fieldEmpty;if(e===t)return;this._fieldEmpty=t;this.outFieldEmptyChange(t,e);return true},_handleFormExtValueChange:function(t,e){if(this._lockFieldValueChange)return;this._lockFieldValueChange=1;this._translationErrorState=0;var i={},r=t;if(this._fieldTranslator){r=this._fieldTranslator.translateIn(t,i)}if(i.error){this._setInTranslationErrorState(r,i.error)}else{this.setFieldValue(r)}this._lockFieldValueChange=0},setFieldValue:function(t){var e=this._fieldValue;if(e===t)return;this._fieldValue=t;this.setFieldEmpty(this._isFieldEmpty(t));this.setNeedValidate(true);this.outFieldValueChange(t,e);if(this._validateMode&Amm.Trait.Field.VALIDATE_CHANGE&&this._needValidate){this.validate()}if(!this._lockFieldValueChange&&this._fieldSyncsValue){this._syncFieldValueToElement(t)}return true},_syncFieldValueToElement:function(t){if(this._lockFieldValueChange||!this._fieldSyncsValue)return;this._translationErrorState=0;this._lockFieldValueChange=1;var e=t,i={};if(this._fieldTranslator){e=this._fieldTranslator.translateOut(t,i)}if(i.error){this._setOutTranslationErrorState(e,i.error)}else{this.setValue(e)}this._lockFieldValueChange=0},_setInTranslationErrorState:function(t,e){this._translationErrorState=Amm.Trait.Field.TRANSLATION_ERROR_IN;this.setFieldValue(t);this.setFieldLocalErrors(e,false)},_setOutTranslationErrorState:function(t,e){this._translationErrorState=Amm.Trait.Field.TRANSLATION_ERROR_OUT;this.setValue(t);this.setFieldLocalErrors(e,false)},getFieldValue:function(){return this._fieldValue},outFieldValueChange:function(t,e){this._out("fieldValueChange",t,e)},_handleFieldFocusedChange:function(t,e){if(e&&this._needValidate&&!t&&this._validateMode&Amm.Trait.Field.VALIDATE_BLUR){this.validate()}},_isFieldEmpty:function(t){var e=t===undefined||t===null||t==="";return e},getFieldEmpty:function(){if(this._fieldEmpty===undefined){var t=this._isFieldEmpty(this.getFieldValue());this.setFieldEmpty(t)}return this._fieldEmpty},outFieldEmptyChange:function(t,e){this._out("fieldEmptyChange",t,e)},setNeedValidate:function(t){t=!!t;if(this._needValidate===t)return;var e=this._needValidate;this._needValidate=t;this._out("needValidateChange",t,e);if(t&&this._validateMode&Amm.Trait.Field.VALIDATE_INSTANT){this.validate()}return true},outNeedValidateChange:function(t,e){this._out("needValidateChange",t,e)},getNeedValidate:function(){return this._needValidate},setFieldTranslator:function(t){if(t)t=Amm.constructInstance(t,"Amm.Translator");else t=null;var e=this._fieldTranslator;if(e===t)return;if(t&&t.field===undefined)t.field=this.getFieldLabel();this._fieldTranslator=t;if(this._translationErrorState)this._revalidate();return true},getFieldTranslator:function(){return this._fieldTranslator},getTranslationErrorState:function(){return this._translationErrorState},setValidationExpressions:function(t){if(this._validationExpressions){Amm.cleanup(this._validationExpressions)}this._validationExpressions=null;if(!t){return}else if(!(t instanceof Array)){throw Error("`validationExpressions` must be an Array or FALSEable, provided: "+Amm.describeType(t))}if(!t.length){return}this._validationExpressions=[];for(var e=0,i=t.length;e<i;e++){var r=this._createExpression(t[e]);this._validationExpressions.push(r);r.subscribe("valueChange",this._handleValidationExpressionChange,this,e)}},_handleValidationExpressionChange:function(t,e){this.setNeedValidate(true);if(this._needValidate&&this._validateMode&Amm.Trait.Field.VALIDATE_EXPRESSIONS){this.validate()}},_applyValidationExpressions:function(t){if(!this._validationExpressions)return;var e=this.getFieldLabel();for(var i=0,r=this._validationExpressions.length;i<r;i++){var n=this._validationExpressions[i].getValue();if(n){var s=Amm.translate(n+"","%field",e);t.push(s)}}}};Amm.Trait.Form=function(t){Amm.Trait.Field.call(this,t)};Amm.Trait.Form.prototype={Form:"__INTERFACE__",invalidFieldsMessage:"lang.Amm.Trait.Form.invalidFieldsMsg",fields:null,_setFormFields:null,_elementsAreFields:true,_displayChildrenAreFields:true,_fieldsUpdateLevel:0,_fieldMap:null,_setFieldMap:null,_fieldsChanged:false,_lastNum:null,_beginUpdateFields:function(){this._fieldsUpdateLevel++;this.fields.beginUpdate()},_endUpdateFields:function(){if(!this._fieldsUpdateLevel)Error("Call to _endUpdateFields() w/o corresponding _beginUpdateFields()");this.fields.endUpdate();this._fieldsUpdateLevel--;if(!this._fieldsUpdateLevel&&this._fieldsChanged){this._fieldsChanged=false;this._recalcFields()}},__augment:function(t,e){Amm.Trait.Field.prototype.__augment.call(this,t,e);var i={indexProperty:"fieldIndex",assocProperty:"form",assocInstance:this,assocEvents:{fieldNameChange:this._softRecalc,fieldValueChange:this._softRecalc,fieldAppliedChange:this._softRecalc,needValidateChange:this._fieldNeedValidate},on__spliceItems:[this._softRecalc,this]};if(this._setFormFields){i.items=this._setFormFields.slice();this._setFormFields=null}if("fieldsPrototype"in e){if(typeof e.fieldsPrototype==="object"&&e.fieldsPrototype){Amm.override(i,e.fieldsPrototype)}delete e.fieldsPrototype}this.fields=new Amm.Collection(i);Amm.Element.regInit(this,"99.Amm.Trait.Form",function(){this._beginUpdateFields();if(this._elementsAreFields)this.setElementsAreFields(true,true);if(this._displayChildrenAreFields)this.setDisplayChildrenAreFields(true,true);this._endUpdateFields()})},_softRecalc:function(){this._recalcFields()},_fieldNeedValidate:function(t){this.setNeedValidate(true)},_recalcFields:function(t){if(this._fieldsUpdateLevel&&!t){this._fieldsChanged=true;return true}this._fieldsChanged=false;var e={},i=[],r=0,n=0,s=false,a=!this._fieldValue,o=0;this._fieldMap={};this._setFieldMap={};for(var l=0,h=this.fields.length;l<h;l++){var u=this.fields[l];var f=u.getFieldValue(),c=u.getFieldName();if(c===undefined||c===null){this._setFieldMap[n]=u;n++;if(!u.getFieldApplied())continue;o++;i.push(f);e[r]=f;this._fieldMap[r]=u;if(!a&&this._fieldValue[r]!==f)a=true;r++}else{this._setFieldMap[c]=u;if(!u.getFieldApplied())continue;o++;s=true;e[c]=f;this._fieldMap[c]=u;if(!a&&this._fieldValue[c]!==e[c])a=true}}if(!a&&o===this._lastNum){return}this._lastNum=o;var _=this._fieldValue;this._fieldValue=s?e:i;if(window.Object&&window.Object.freeze)window.Object.freeze(this._fieldValue);this.outFieldValueChange(this._fieldValue,_);return true},_addFields:function(t){var e=t.slice();for(var i=e.length-1;i>=0;i--){if(e[i]["Field"]!=="__INTERFACE__")e.splice(i,1)}e=Amm.Array.diff(e,this.fields);if(e.length){if(e.length>1)this._beginUpdateFields();this.fields.acceptMany(e);if(e.length>1)this._endUpdateFields()}return e},_delFields:function(t,e,i){var r=[];for(var n=0,s=t.length;n<s;n++){if(t[n]["Field"]==="__INTERFACE__")r.push(t[n])}if(e&&r.length&&this._elementsAreFields&&this["Component"]&&this._elements.length){r=Amm.Array.diff(r,this._elements)}if(i&&r.length&&this._displayChildrenAreFields&&this["DisplayParent"]&&this.displayChildren.length){r=Amm.Array.diff(r,this.displayChildren)}if(!r.length)return;this._beginUpdateFields();var a=[];for(var n=0,s=r.length;n<s;n++){var o=this.fields.indexOf(r[n]);if(o>=0){this.fields.removeAtIndex(o);a.push(r[n])}}this._endUpdateFields();return a},setElementsAreFields:function(t,e){t=!!t;var i=this._elementsAreFields;if(i===t&&!e)return;this._elementsAreFields=t;if(!this.fields||this["Component"]!=="__INTERFACE__")return true;var r=t?"subscribe":"unsubscribe";this[r]("acceptedElements",this._handleFieldComponentAcceptedElements,this);this[r]("rejectedElements",this._handleFieldComponentRejectedElements,this);if(this._elements.length){if(t)this._addFields(this._elements);else this._delFields(this._elements,false,true)}return true},_handleFieldComponentAcceptedElements:function(t){this._addFields(t)},_handleFieldComponentRejectedElements:function(t){if(t.length&&this._displayChildrenAreFields&&this["DisplayParent"]&&this.displayChildren.length){t=Amm.Array.diff(t,this.displayChildren)}if(t.length)this._delFields(t,false,true)},getElementsAreFields:function(){return this._elementsAreFields},setDisplayChildrenAreFields:function(t,e){t=!!t;var i=this._displayChildrenAreFields;if(i===t&&!e)return;this._displayChildrenAreFields=t;if(!this.fields||this["DisplayParent"]!=="__INTERFACE__")return true;var r=t?"subscribe":"unsubscribe";this.displayChildren[r]("spliceItems",this._handleFieldDisplayChildrenSpliceItems,this);if(this.displayChildren.length){if(t)this._addFields(this.displayChildren);else this._delFields(this.displayChildren,true,false)}return true},_handleFieldDisplayChildrenSpliceItems:function(t,e,i){var r=Amm.Array.symmetricDiff(e,i);var n=Amm.Array.symmetricDiff(i,e);if(r.length&&n.length)this._beginUpdateFields();if(r.length)this._delFields(r,true,false);if(n.length)this._addFields(n);if(r.length&&n.length)this._endUpdateFields()},getDisplayChildrenAreFields:function(){return this._displayChildrenAreFields},_cleanup_Model:function(){this.fields.cleanup()},_acquirePossibleFields:function(t){pp=[];for(var e=0,i=t.length;e<i;e++){var r=t[e];if(!(r&&r["Field"]==="__INTERFACE__"))continue;if(!(r._parentModel||r===this))continue;pp.push(r)}if(pp.length)this.fields.push.apply(this.fields,pp)},setFields:function(t){if(!this.fields){if(!this._setFormFields)this._setFormFields=t;else{if(!t)this._setFormFields=null;else if(!(t instanceof Array||t["Amm.Array"]))throw Error("`fields` must be an Array or Amm.Array");this._setFormFields=t}return}var e=Amm.Array.diff(this.fields,t);var i=Amm.Array.diff(t,this.fields);if(!e.length&&!i.length)return;this._beginUpdateFields();if(e.length)this._delFields(e,true,true);if(t.length)this.fields.acceptMany(t);this._endUpdateFields()},getFields:function(){if(!this.fields){if(!this._setFormFields)this._setFormFields=[];return this._setFormFields}return this.fields},_parseKeyArgs:function(t,e,i){var r=e[t];if(r!==undefined){var n=r,s;if(e.length>t+1){if(!(n instanceof Array))n=[n];n=n.concat(Array.prototype.slice.call(e,t+1))}if(n instanceof Array){s=n.shift();if(!n.length)n=undefined}else{s=n;n=undefined}var a=i?this._setFieldMap[s]:this._fieldMap[s];return[a,s,n]}},setFieldValue:function(t,e){if(!this._fieldMap)this._recalcFields(true);if(e!==undefined){var i=this._parseKeyArgs(1,arguments,true),r=i[0];if(r)return r.setFieldValue(t,i[2]);else return undefined}this._beginUpdateFields();if(typeof t!=="object"||!t)throw Error("`value` must be a hash or an Array; provided: "+Amm.describeType(t));for(var n in t)if(t.hasOwnProperty(n)&&this._setFieldMap[n]){this._setFieldMap[n].setFieldValue(t[n])}this._endUpdateFields()},getFieldValue:function(t){if(this._fieldValue===undefined){this._recalcFields(true)}if(t===undefined)return this._fieldValue;var e=this._parseKeyArgs(0,arguments,false),i=e[0],r=e[1],n=e[2];var s=this._fieldValue[r];if(n){do{var a=n.shift();if(typeof s==="object"&&(s instanceof Array||s)&&a in s){s=s[a]}else{s=undefined}}while(n.length);if(n.length)s=undefined}return s},_doValidate:function(t,e,i,r){Amm.Trait.Field.prototype._doValidate.call(this,t,e,i,r);var n=false;for(var s=0,a=this.fields.length;s<a;s++){if(!this.fields[s].validate())n=true}if(n){t.push(Amm.translate(this.invalidFieldsMessage,"%field",r||Amm.translate("lang.Amm.Trait.Form.form")))}}};Amm.extend(Amm.Trait.Form,Amm.Trait.Field);Amm.defineLangStrings({"lang.Amm.Trait.Form.invalidFieldsMsg":"One or more fields of %field are filled with errors","lang.Amm.Trait.Form.form":"the form"});Amm.Trait.Instantiator=function(){};Amm.Trait.Instantiator.prototype={Instantiator:"__INTERFACE__",InstantiatorOrRepeater:"__INTERFACE__",__augment:function(t,e){Amm.Element.regInit(this,"99.Amm.Trait.Instantiator",function(){if(this["DisplayParent"]!=="__INTERFACE__")throw Error("Instantiator must be also a DisplayParent")});if(e&&e.initialInstantiatorOptions){this._reportedInstantiatorOptions=e.initialInstantiatorOptions;delete e.initialInstantiatorOptions}},_instantiator:null,_src:null,_dest:null,_instantiatorOptions:null,_reportedInstantiatorOptions:null,_construct:function(){if(!this._instantiator||!this._src)return;var t=this._instantiator.construct(this._src);this.setDest(t)},_destruct:function(){if(!this._dest)return;this._dest.setDisplayParent(null);if(this._instantiator){this._instantiator.destruct(this._dest)}this._dest=null},setInstantiator:function(t){if(!t)t=null;else t=Amm.constructInstance(t,"Amm.Instantiator");var e=this._instantiator;if(e===t)return;if(e&&e["Amm.WithEvents"])e.unsubscribe("needRebuild",this._handleInstantiatorNeedRebuild,this);this._instantiator=t;if(t&&t["Amm.WithEvents"]&&t.hasEvent("needRebuild")){t.subscribe("needRebuild",this._handleInstantiatorNeedRebuild,this)}this._reportedInstantiatorOptions=null;this._destruct();this.outInstantiatorChange(t,e);this._construct();return true},getInstantiator:function(){return this._instantiator},outInstantiatorChange:function(t,e){this._out("instantiatorChange",t,e)},setSrc:function(t){var e=this._src;if(e===t)return;this._src=t;this._construct();this.outSrcChange(t,e);return true},getSrc:function(){return this._src},outSrcChange:function(t,e){this._out("srcChange",t,e)},setDest:function(t){var e=this._dest;if(e===t)return;if(t)Amm.is(t,"Visual","dest");this._destruct();this._dest=t;if(this._dest)this._dest.setDisplayParent(this);this.outDestChange(t,e);return true},getDest:function(){return this._dest},outDestChange:function(t,e){this._out("destChange",t,e)},_handleInstantiatorNeedRebuild:function(t,e,i){if(!this._src||i!==this._instantiator)return;if(Amm.Array.indexOf(this._src,t)<0)return;this._construct()},_cleanup_Instantiator:function(){this.setInstantiator(null);this.setSrc(null)},setInstantiatorOptions:function(t){if(!t)t=null;var e=this._instantiatorOptions;if(e===t)return;this._instantiatorOptions=t;if(this._reportedInstantiatorOptions){this.reportInstantiatorOptions.apply(this,this._reportedInstantiatorOptions)}return true},getInstantiatorOptions:function(){return this._instantiatorOptions},reportInstantiatorOptions:function(t,e,i){this._reportedInstantiatorOptions=[t,e,i];var r;if(e&&e.length){r={class:Amm.Instantiator.Variants,defaultPrototype:t,filter:{conditions:e},prototypes:i,allowNullInstance:true}}else{r={class:Amm.Instantiator.Proto,proto:t}}if(this._instantiatorOptions){r=Amm.overrideRecursive(r,this._instantiatorOptions)}this.setInstantiator(Amm.constructInstance(r,Amm.Instantiator.Abstract))}};Amm.Trait.Annotated=function(){this._defaultAnnotations=["label","description","required","error"]};Amm.Trait.Annotated.annotationElementDefaults={BASE:{traits:["Amm.Trait.Content","Amm.Trait.Visual"]},required:{contentTranslator:{class:"Amm.Translator.RequiredMark"}},error:{contentTranslator:{class:"Amm.Translator.Errors"}}};Amm.Trait.Annotated.mergePrototypes=function(t,e,i,r){var n,s;if(t&&e&&e in t)n=t[e];if(e){if(t&&e in t)n=t[e]}else{n=t}if(r){if(i&&r in i)s=i[r]}else{s=i}if(s===null)return null;if(!s)return n;if(!n)return s;if(typeof s!=="object"||typeof n!=="object")return s;return Amm.override({},n,s)};Amm.Trait.Annotated.prototype={Annotated:"__INTERFACE__",_defaultAnnotations:null,_label:undefined,_description:undefined,_required:undefined,_error:undefined,annotationElementDefaults:null,_annotationsContainer:undefined,getAnnotationsContainer:function(){if(this._annotationsContainer===undefined){var t="annotations";t="annotations";this._annotationsContainer=new Amm.Trait.Annotated.Container({id:t,component:this.getClosestComponent(),element:this});this._assignDefaultAnnotations()}this.subscribe("closestComponentChange",this._annotated_onSelfClosestComponentChange,this);return this._annotationsContainer},_annotated_onSelfClosestComponentChange:function(t){if(this._annotationsContainer)this._annotationsContainer.setComponent(t)},getAnnotationElementPrototype:function(t){var e=Amm.Trait.Annotated.annotationElementDefaults,i=this.annotationElementDefaults;var r=Amm.Trait.Annotated.mergePrototypes(e,"BASE",i,"BASE");var n=Amm.Trait.Annotated.mergePrototypes(e,t,i,t);var s=Amm.Trait.Annotated.mergePrototypes(r,null,n,null);return Amm.override({},s)},_assignDefaultAnnotations:function(){if(this._defaultAnnotations instanceof Array){for(var t=0,e=this._defaultAnnotations.length;t<e;t++){var i=this._defaultAnnotations[t];var r=Amm.getProperty(this,i,undefined);if(r!==undefined){this.getAnnotationsContainer().getAnnotationElement(i).setContent(r)}else{var n=this.getAnnotationsContainer().getAnnotationElement(i).getContent();if(n!==undefined)Amm.setProperty(this,i,n)}}}},setLabel:function(t){var e=this._label;if(e===t)return;this._label=t;this.outLabelChange(t,e);return true},getLabel:function(){return this._label},outLabelChange:function(t,e){this._out("labelChange",t,e)},setDescription:function(t){var e=this._description;if(e===t)return;this._description=t;this.outDescriptionChange(t,e);return true},getDescription:function(){return this._description},outDescriptionChange:function(t,e){this._out("descriptionChange",t,e)},setRequired:function(t){var e=this._required;if(e===t)return;this._required=t;this.outRequiredChange(t,e);return true},getRequired:function(){return this._required},outRequiredChange:function(t,e){this._out("requiredChange",t,e)},setError:function(t){var e=this._error;if(e===t)return;this._error=t;this.outErrorChange(t,e);return true},getError:function(){return this._error},outErrorChange:function(t,e){this._out("errorChange",t,e)},listAnnotations:function(){return Amm.keys(this.getAnnotationsContainer().getAllNamedElements())},hasAnnotation:function(t){return!!this.getAnnotationsContainer().getAnnotationElement(t,true)},getAnnotationValue:function(t){if(t){var e=this.getAnnotationsContainer().getAnnotationElement(t,true);if(e)return e.getContent();return undefined}var i=this.listAnnotations(),r=this.getAnnotationsContainer();var n={};for(var s=0,a=i.length;s<a;s++){var t=i[s];var o=r.getAnnotationElement(t,true);if(o)n[t]=o.getContent()}return n},setAnnotationValue:function(t,e){return this.getAnnotationsContainer().getAnnotationElement(e).setContent(t)}};Amm.Trait.Annotated.Container=function(t){this._requireInterfaces("Annotated");Amm.ElementBound.call(this);Amm.Element.call(this,t)};Amm.Trait.Annotated.Container.prototype={"Amm.Trait.Annotated.Container":"__CLASS__",setElement:function(t){if(this._element!==null&&this._element!==t)Error("can setElement() only once in Amm.Trait.Annotated.Container");return Amm.ElementBound.prototype.setElement.call(this,t)},_passAnnotatedContentChange:function(t,e){if(this._element)Amm.setProperty(this._element,Amm.event.origin.getId(),t)},createAnnotationElement:function(t){var e=this._element.getAnnotationElementPrototype(t);e.id=t;e.component=this;var i=new Amm.Element(e);var r={};if(Amm.detectProperty(this._element,t,r)){i.subscribe("contentChange",this._passAnnotatedContentChange,this);var n=this._element[r.getterName](),s=i.getContent();if(n!==undefined)i.setContent(n);else if(n===undefined&&s!==undefined){this._element[r.setterName](s)}this._element.subscribe(r.eventName,i.setContent,i)}return i},getAnnotationElement:function(t,e){if(this._namedElements[t]||e){return this.getNamedElement(t,0,true)}return this.createAnnotationElement(t)},_getDefaultTraits:function(){return["Amm.Trait.Component"]}};Amm.extend(Amm.Trait.Annotated.Container,Amm.Element);Amm.extend(Amm.Trait.Annotated.Container,Amm.ElementBound);Amm.Trait.Component=function(){this._namedElements={};this._elements=[];this._components=[];this.e={}};Amm.Trait.Component.changeComponent=function(t,e,i){var r=[];if(i!==undefined){for(var n=0,s=t.length;n<s;n++){if(t[n].getComponent()===i){r.push(t[n])}}}else{r=t}if(e){e.acceptElements(r)}else{for(var n=0,s=r.length;n<s;n++){r[n].setComponent(e)}}};Amm.Trait.Component.prototype={Component:"__INTERFACE__",_internalId:"component",_isComponent:true,_namedElements:null,_elements:null,e:null,_components:null,setInternalId:function(t){var e=this._internalId;if(e===t)return;this._internalId=t;this.outInternalIdChange(t,e);this.outRenamedElement(this,t,e);this.outRenamedInScope(this,this,t,e);return true},getInternalId:function(){return this._internalId},outInternalIdChange:function(t,e){this._out("internalIdChange",t,e)},getClosestComponent:function(){return this._isComponent?this:this._component},__augment:function(){Amm.Element.regInit(this,"95_Component_setClosestComponent",this._setClosestComponent)},setIsComponent:function(t){t=!!t;var e=this._isComponent;if(e===t)return;this._isComponent=t;this._setClosestComponent();this._callOwnMethods("_setIsComponent_");if(t){var i=this.findChildElements();if(i.length)this.acceptElements(i)}else{if(this._component)this._component.acceptElements(this.getElements());else this.rejectElements(this.getElements())}this.outIsComponentChange(t,e);return true},getIsComponent:function(){return this._isComponent},outIsComponentChange:function(t,e){this._out("isComponentChange",t,e)},_extractNameEventFromMethodName:function(t){var e="handle__";if(t.indexOf(e)!==0)return;var i=t.slice(e.length).split("__");var r,n;if(i.length===1){r="";n=i[0]}else{r=i[0];n=i.slice(1).join("__")}return[r,n]},_listHandlersForElements:function(){var t={};var e;for(var i in this)if(typeof this[i]==="function"){var e=this._extractNameEventFromMethodName(i);if(!e)continue;if(!t[e[0]])t[e[0]]=[];t[e[0]].push([e[1],i])}return t},_subscribeElement:function(t,e,i,r){var n=t.getId();if((!n||!n.length)&&e)return;var i=i||this._listHandlersForElements();var s=[];if(!e&&i[""])s=i[""];if(i[n])s=s.concat(i[n]);for(var a=0,o=s.length;a<o;a++){if(t.hasEvent(s[a][0])){if(r&&t.getSubscribers(s[a][0],s[a][1],this).length)continue;t.subscribe(s[a][0],s[a][1],this)}}},_unsubscribeElement:function(t,e){var i=t.getSubscribers(undefined,undefined,this);for(var r=0,n=i.length;r<n;r++){var s=i[r],a;if(typeof s[0]!=="string")continue;a=this._extractNameEventFromMethodName(s[0]);if(!a)continue;if(!e||a[0])t.unsubscribe(s[3],s[0],this)}},resubscribeAllElements:function(){var t=this._listHandlersForElements();for(var e=0,i=this._elements.length;e<i;e++){this._subscribeElement(this._elements[e],false,t,true)}},handle__componentChange:function(t,e){var i=Amm.event.origin;if(t===this)this.acceptElements([i]);else if(e===this)this.rejectElements([i])},handle__idChange:function(t,e){var i=Amm.event.origin;if(e){this._deleteNamedElementEntry(i,e);this._unsubscribeElement(i,true)}if(t){if(!this._namedElements[t]){this._namedElements[t]=[]}this._namedElements[t].push(i);if(this._namedElements[t].length===1){this.e[t]=i}else{this.e[t]=this._namedElements[t]}this._subscribeElement(i,true,undefined)}this.outRenamedElement(i,t,e);this.outRenamedInScope(this,i,t,e)},handle__isComponentChange:function(t,e){var i=Amm.event.origin;if(t)this._registerComponent(i);else this._unregisterComponent(i);this.outChildComponentStatusChange(i,t);this.outChildComponentStatusChangeInScope(this,i,t)},outRenamedElement:function(t,e,i){this._out("renamedElement",t,e,i)},handle__cleanup:function(){var t=Amm.event.origin;this.rejectElements([t])},g:function(t,e,i){return this.getNamedElement(t,e,i)},getNamedElement:function(t,e,i){if(!e||e<0)e=0;if(this._internalId&&t===this._internalId&&!e)return this;var r;if(this._namedElements[t]){r=this._namedElements[t][e]}if(!r&&i){var n=this.getAllNamedElements(t,i);if(n&&n[e])r=n[e]}return r},getAllNamedElements:function(t,e){var i;if(t){i=[];if(this._internalId&&t===this._internalId){i.push(this)}if(this._namedElements[t]){i=i.concat(this._namedElements[t])}if(e&&this._component){var r=this._component.getAllNamedElements(t,e);if(this._internalId===t){for(var n=0,s=r.length;n<s;n++){if(r[n]===this){r.splice(n,1);break}}}i=i.concat(r)}return i}i={};if(this._internalId)i[this._internalId]=[this];for(var n in this._namedElements){if(this._namedElements.hasOwnProperty(n)){i[n]=(i[n]||[]).concat(this._namedElements[n])}}if(e&&this._component){var r=this._component.getAllNamedElements(undefined,e);var a=this._id;if(a&&r[a]){for(var o=0,s=r[a].length;o<s;o++)if(r[a][o]===this){r[n].splice(o,1);if(!r[n].length)delete r[n];break}}for(var n in r)if(r.hasOwnProperty(n)){i[n]=(this._namedElements[n]||[]).concat(r[n])}}return i},_includeAllChildren:function(t){var e=[].concat(t);for(var i=0,r=t.length;i<r;i++){if(!t[i]["Component"]||!t[i].getIsComponent()){var n=this._includeAllChildren(t[i].findChildElements());e=e.concat(n)}}return e},acceptElements:function(t){var e=this._includeAllChildren(t),i=[];e=Amm.Array.diff(e,this._elements);if(!e.length)return;this._elements.push.apply(this._elements,e);var r=this._listHandlersForElements();for(var n=0,s=e.length;n<s;n++){this._subscribeElement(e[n],false,r);var a=e[n].getId();if(a){if(!this._namedElements[a]){this._namedElements[a]=[]}this._namedElements[a].push(e[n]);if(this._namedElements[a].length===1){this.e[a]=this._namedElements[a][0]}else{this.e[a]=this._namedElements[a]}}if(e[n].Component==="__INTERFACE__"&&e[n].getIsComponent()){this._registerComponent(e[n])}e[n].setComponent(this);i.push(e[n])}if(i.length){this.outAcceptedElements(i);this.outAcceptedInScope(this,i)}return i},_registerComponent:function(t){this._components.push(t)},outAcceptedElements:function(t){return this._out("acceptedElements",t)},_deleteNamedElementEntry:function(t,e){if(!e)e=t.getId();if(!e)e=t.getId();if(!this._namedElements[e])return;var i=Amm.Array.indexOf(t,this._namedElements[e]);if(i>=0){this._namedElements[e].splice(i,1);if(this._namedElements[e].length===1){this.e[e]=this._namedElements[e][0]}else if(!this._namedElements[e].length){delete this._namedElements[e];delete this.e[e]}return true}},rejectElements:function(t){var e=[];var i=this._includeAllChildren(t),r=this._elements.length;var n=Amm.Array.findDuplicates(this._elements.concat(i),false,null,r,true);for(var s=n.length-1;s>=0;s--){if(n[s][0]>=r)continue;var a=this._elements[n[s][0]],o=a.getId();if(o)this._deleteNamedElementEntry(a,o);this._elements.splice(n[s][0],1);this._unsubscribeElement(a);if(a.getComponent()===this){a.setComponent(null)}if(i[s].Component==="__INTERFACE__"&&i[s].getIsComponent()){this._unregisterComponent(i[s])}e.unshift(a)}if(e.length){this.outRejectedElements(e);this.outRejectedInScope(this,e)}return e},_unregisterComponent:function(t){for(var e=0,i=this._components.length;e<i;e++){if(this._components[e]===t){this._components.splice(e,1);break}}},outRejectedElements:function(t){return this._out("rejectedElements",t)},getElements:function(){return[].concat(this._elements)},_listCall:function(t,e,i){var r=[];for(var n=0,s=t.length;n<s;n++){var a=t[n];if(typeof e==="function")r.push([a,e.apply(a,i)]);else if(typeof a[e]==="function")r.push([a,a[e].apply(a,i)])}return r},callElements:function(t,e){return this._listCall(this._elements,t,Array.prototype.slice.call(arguments,1))},callComponents:function(t,e){return this._listCall(this._components,t,Array.prototype.slice.call(arguments,1))},_cleanup_Component:function(){this._namedElements={};this.e={};var t=this._elements;this._elements=[];for(var e=0,i=t.length;e<i;e++){this._unsubscribeElement(t[e]);t[e].setComponent(null);if(t[e].getCleanupWithComponent()){t[e].cleanup()}}},outAcceptedInScope:function(t,e){var i=this._out("acceptedInScope",t,e);this.callComponents("outAcceptedInScope",t,e);return i},outRejectedInScope:function(t,e){var i=this._out("rejectedInScope",t,e);this.callComponents("outRejectedInScope",t,e);return i},outRenamedInScope:function(t,e,i,r){var n=this._out("renamedInScope",t,e,i,r);this.callComponents("outRenamedInScope",t,e,i,r);return n},outChildComponentStatusChange:function(t,e){return this._out("childComponentStatusChange",t,e)},outChildComponentStatusChangeInScope:function(t,e,i){var r=this._out("childComponentStatusChangeInScope",t,e,i);this.callComponents("outChildComponentStatusChangeInScope",t,e,i);return r},_setComponent_Component:function(t){this.outComponentStackChange()},outComponentStackChange:function(){this.callComponents("outComponentStackChange");this._out("componentStackChange")}};Amm.Trait.Visual=function(){};Amm.Trait.Visual.prototype={Visual:"__INTERFACE__",ClassName:"__INTERFACE__",DisplayChild:"__INTERFACE__",_visible:undefined,_displayParent:undefined,_displayOrder:undefined,_className:undefined,setVisible:function(t){var e=this._visible;if(e===t)return;this._visible=t;this.outVisibleChange(t,e);return true},getVisible:function(){return this._visible},outVisibleChange:function(t,e){this._out("visibleChange",t,e)},setDisplayParent:function(t){if(t)Amm.is(t,"DisplayParent","displayParent");else t=null;var e=this._displayParent;if(e===t)return;this._displayParent=t;if(e){var i=e.displayChildren.strictIndexOf(this);if(i>=0)e.displayChildren.removeAtIndex(i)}if(t){var r=t.displayChildren.strictIndexOf(this);if(r<0)t.displayChildren.accept(this)}this.outDisplayParentChange(t,e);return true},getDisplayParent:function(){return this._displayParent},outDisplayParentChange:function(t,e){this._out("displayParentChange",t,e)},setDisplayOrder:function(t){if(typeof t!=="number"){t=parseInt(t);if(isNaN(t))throw Error("`displayOrder` must be a number")}var e=this._displayOrder;if(e===t)return;if(this._displayParent&&t>=this._displayParent.displayChildren.length){t=this._displayParent.displayChildren.length-1}if(t<0)t=0;this._displayOrder=t;this.outDisplayOrderChange(t,e);return true},getDisplayOrder:function(){return this._displayOrder},outDisplayOrderChange:function(t,e){this._out("displayOrderChange",t,e)},setClassName:function(t,e){var i=this._className;var r;if(e){var n=new RegExp("\\s*\\b"+Amm.Util.regexEscape(e)+"\\b\\s*","g");if(this._className===undefined)this._className="";if(!t){if(this._className===undefined)this._className="";r=this._className.replace(n," ").replace(/ {2,}/g," ");if(r[0]===" ")r=r.slice(1);if(r[r.length-1]===" ")r=r.slice(0,-1)}else{if(!n.exec(this._className))r=this._className+" "+e;else r=this._className}}else{r=t}if(r===i)return;this._className=r;this.outClassNameChange(r,i);return true},getClassName:function(t){if(!t)return this._className;return(" "+this._className+" ").indexOf(" "+t+" ")>=0},outClassNameChange:function(t,e){this._out("classNameChange",t,e)}};Amm.Trait.Input=function(){};Amm.Trait.Input.prototype={Focusable:"__INTERFACE__",Editor:"__INTERFACE__",Lockable:"__INTERFACE__",_readOnly:undefined,_focused:undefined,_enabled:true,_value:undefined,_locked:false,_focusedView:null,setValue:function(t){var e=this._value;if(e===t)return;this._value=t;this.outValueChange(t,e);return true},getValue:function(){return this._value},outValueChange:function(t,e){this._out("valueChange",t,e)},setReadOnly:function(t){var e=this._readOnly;if(e===t)return;this._readOnly=t;this.outReadOnlyChange(t,e);return true},getReadOnly:function(){return this._readOnly},outReadOnlyChange:function(t,e){this._out("readOnlyChange",t,e)},setFocused:function(t){t=!!t;var e=this._focused;if(e===t)return;this._focused=t;this.outFocusedChange(t,e);return true},getFocused:function(){return this._focused},outFocusedChange:function(t,e){this._out("focusedChange",t,e)},setFocusedView:function(t){if(!t)t=null;var e=this._focusedView;if(e===t)return;this._focusedView=t;if(t===null)this.setFocused(false);else if(!this._focused)this.setFocused(true);this.outFocusedViewChange(t,e);return true},getFocusedView:function(){return this._focusedView},outFocusedViewChange:function(t,e){this._out("focusedViewChange",t,e)},setEnabled:function(t){var e=this._enabled;if(e===t)return;this._enabled=t;this.outEnabledChange(t,e);return true},getEnabled:function(){return this._enabled},outEnabledChange:function(t,e){this._out("enabledChange",t,e)},setLocked:function(t){var e=this._locked;if(e===t)return;this._locked=t;this.outLockedChange(t,e);return true},getLocked:function(){return this._locked},outLockedChange:function(t,e){this._out("lockedChange",t,e)}};Amm.Trait.Toggle=function(){};Amm.Trait.Toggle.prototype={Toggle:"__INTERFACE__",_isRadio:undefined,_groupName:undefined,_groupParent:undefined,_checked:undefined,_checkedValue:undefined,_uncheckedValue:undefined,_valueIsStandalone:false,_lockGroup:0,_lockGroupSearch:0,_value:undefined,__augment:function(t){Amm.Element.regInit(this,"99.Amm.Trait.Toggle",this._subscribeToggleToRoot)},setIsRadio:function(t){if(t!==undefined)t=!!t;var e=this._isRadio;if(e===t)return;var i=this._getOwnValue()!==undefined;this._isRadio=t;i=i||this._getOwnValue()!==undefined;this.outIsRadioChange(t,e);if(this._uncheckOtherRadios()||i)this._notifyGroup();return true},getIsRadio:function(){return this._isRadio},outIsRadioChange:function(t,e){this._out("isRadioChange",t,e)},setGroupName:function(t){if(!t)t=undefined;var e=this._groupName;if(e===t)return;var i=this.findGroupItems(false,true);this._groupName=t;if(i.length)this._notifyGroup(i);this.outGroupNameChange(t,e);this._notifyGroup();return true},getGroupName:function(){return this._groupName},outGroupNameChange:function(t,e){this._out("groupNameChange",t,e)},setGroupParent:function(t){if(!t)t=undefined;var e=this._groupParent;if(e===t)return;var i=this.findGroupItems(false,true);this._groupParent=t;if(i.length)this._notifyGroup(i);this.outGroupParentChange(t,e);this._notifyGroup();return true},getGroupParent:function(){return this._groupParent},outGroupParentChange:function(t,e){this._out("groupParentChange",t,e)},_uncheckOtherRadios:function(){if(!this._checked||!this._isRadio)return;var t=this.findGroupItems(true),e=false;if(t.length<=1)return;for(var i=0,r=t.length;i<r;i++){if(t[i]!==this&&t[i].getChecked()){t[i]._uncheckByGroup();e=true}}return e},_uncheckByGroup:function(){this._lockGroup++;this.setChecked(false);this._lockGroup--},setEnabled:function(t){var e=this._getOwnValue()!==undefined;var i=Amm.Trait.Input.prototype.setEnabled.call(this,t);if(i&&(e||this._getOwnValue()!==undefined))this._reportChange();return i},setChecked:function(t){if(t!==undefined)t=!!t;var e=this._checked;if(e===t)return;this._checked=t;this._uncheckOtherRadios();this._reportChange();this.outCheckedChange(t,e);return true},getChecked:function(){return this._checked},outCheckedChange:function(t,e){this._out("checkedChange",t,e)},setCheckedValue:function(t){var e=this._checkedValue;if(e===t)return;this._checkedValue=t;this.outCheckedValueChange(t,e);if(this._checked)this._reportChange();return true},getCheckedValue:function(){return this._checkedValue},outCheckedValueChange:function(t,e){this._out("checkedValueChange",t,e)},setUncheckedValue:function(t){var e=this._uncheckedValue;if(e===t)return;this._uncheckedValue=t;this.outUncheckedValueChange(t,e);if(!this._checked)this._reportChange();return true},getUncheckedValue:function(){return this._uncheckedValue},outUncheckedValueChange:function(t,e){this._out("uncheckedValueChange",t,e)},setValueIsStandalone:function(t){t=!!t;var e=this._valueIsStandalone;if(e===t)return;this._valueIsStandalone=t;var i=this._value;this.outValueIsStandaloneChange(t,e);this._value=t?this._getOwnValue():this._getGroupValue();if(!Amm.Trait.Select.valuesAreSame(i,this._value))this.outValueChange(this._value,i);return true},getValueIsStandalone:function(){return this._valueIsStandalone},outValueIsStandaloneChange:function(t,e){this._out("valueIsStandaloneChange",t,e)},_notifyGroup:function(t,e){if(!t)t=this.findGroupItems();if(arguments.length<2)e=this._getGroupValue(t);for(var i=0,r=t.length;i<r;i++){t[i]._receiveGroupNotification(e,this)}},_reportChange:function(){if(this._valueIsStandalone){var t=this._getOwnValue();if(t!==this._value){var e=this._value;this._value=t;this.outValueChange(this._value,e)}}var i=this._getGroupValue();var r=this.findGroupItems();for(var n=0,s=r.length;n<s;n++){r[n]._receiveGroupNotification(i,this)}},setValue:function(t){var e=this._value;if(this._valueIsStandalone){this._setOwnValue(t)}else{this._setGroupValue(t)}if(!Amm.Trait.Select.valuesAreSame(this._value,e))return true},_receiveGroupNotification:function(t,e){if(this._valueIsStandalone)return;if(!Amm.Trait.Select.valuesAreSame(t,this._value)){var i=this._value;this._value=t;this.outValueChange(t,i)}},_setGroupValue:function(t){var e;if(t instanceof Array)e=t;else{if(t===null||t===undefined)e=[];else e=[t]}var i=this.findGroupItems();var r=false;var n=false;var s,a;for(s=0,a=i.length;s<a;s++){i[s]._lockGroup++}for(s=0,a=i.length;s<a;s++){var o=i[s];if(o["Toggle"]!=="__INTERFACE__")return;var l=o.getIsRadio(),h=Amm.Array.nonStrictIndexOf(o.getCheckedValue(),e)>=0,u=o.getChecked();r=r||h&&u&&l;if(!(l&&r)&&(h&&!u||!h&&u)){if(l&&h)r=true;n=true;o.setChecked(!!h)}}for(s=0,a=i.length;s<a;s++){i[s]._lockGroup--}if(n)this._reportChange();return n},_getGroupValue:function(t){if(!t)t=this.findGroupItems();var e=[],i=0,r=0;for(var n=0,s=t.length;n<s;n++){var a=t[n],o=a._getOwnValue();if(a["Toggle"]!=="__INTERFACE__")continue;if(a.getIsRadio()){r++}else{i++}if(o!==undefined){e.push(o)}}var l=r===0&&i===1||r&&!i;var e;if(l)e=e[0];return e},_setOwnValue:function(t){if(t==this._checkedValue){this.setChecked(true)}else{this.setChecked(false)}},_getOwnValue:function(){if(!this._enabled)return;if(this._checked)return this._checkedValue;if(!this._isRadio)return this._uncheckedValue},findGroupItems:function(t,e){var i=[];if(e)this._lockGroupSearch++;Amm.getRoot().raiseEvent("findToggleGroupItems",this._groupParent,this._groupName,t,i);if(e)this._lockGroupSearch--;return i},_handleFindToggleGroupItems:function(t,e,i,r){if(this._lockGroupSearch)return;if(t===this._groupParent&&e===this._groupName){if(!i||this._isRadio){r.push(this)}}},_subscribeToggleToRoot:function(){Amm.getRoot().subscribe("findToggleGroupItems",this._handleFindToggleGroupItems,this)},_setComponent_Toggle:function(t,e){if(this._groupParent===e||!this._groupParent||this._groupParent.tagName){this.setGroupParent(t)}},_cleanup_Toggle:function(){Amm.getRoot().unsubscribe("findToggleGroupItems",this._handleFindToggleGroupItems,this)}};Amm.extend(Amm.Trait.Toggle,Amm.Trait.Input);Amm.Trait.Content=function(){};Amm.Trait.Content.prototype={Content:"__INTERFACE__",_content:undefined,_contentTranslator:null,setContent:function(t){var e=this._content;if(e===t)return;this._content=t;this.outContentChange(t,e);return true},getContent:function(){return this._content},outContentChange:function(t,e){this._out("contentChange",t,e)},setContentTranslator:function(t){if(t)t=Amm.constructInstance(t,"Amm.Translator");else t=null;var e=this._contentTranslator;if(e===t)return;this._contentTranslator=t;this.outContentTranslatorChange(t,e);return true},getContentTranslator:function(){return this._contentTranslator},outContentTranslatorChange:function(t,e){this._out("contentTranslatorChange",t,e)}};Amm.Trait.Select=function(){};Amm.Trait.Select.valuesAreSame=function(t,e){if(t===undefined&&e!==undefined)return false;if(e===undefined&&t!==undefined)return false;if(t===e)return true;if(t&&t["Amm.Array"])t=t.getItems();if(e&&e["Amm.Array"])e=e.getItems();var i=function(t,e){return t==e?0:1};if(t instanceof Array){if(!(e instanceof Array))return false;if(!Amm.Array.diff(t,e,i).length&&!Amm.Array.diff(e,t,i).length){return true}return false}else{if(e instanceof Array)return false}return!i(t,e)};Amm.Trait.Select.prototype={Select:"__INTERFACE__",options:null,_objectsMapper:null,_selectionCollection:null,_multiple:undefined,_selectSize:undefined,_numChanges:0,_labelProperty:null,_valueProperty:null,_disabledProperty:null,_dummyLabel:null,_dummyValue:null,_dummyOption:null,_optionPrototype:null,_sorter:null,setOptions:function(t){if(!t)t=[];var e=[];if(t instanceof Array||t["Amm.Array"]){e=t}else if(typeof t==="object"){for(var i in t)if(t.hasOwnProperty(i)){e.push({label:t[i],value:i})}}var r=[];for(var i=0;i<e.length;i++){var n;var s=this._optionPrototype?Amm.overrideRecursive({},this._optionPrototype):{};if(typeof e[i]!=="object"){s.label=e[i];s.value=e[i]}else{var a=Amm.getClass(e[i]);if(!a)s=Amm.overrideRecursive(s,e[i]);else n=e[i]}s.component=this.getClosestComponent();r.push(Amm.constructInstance(s,Amm.Trait.Select.Option))}if(this._dummyOption)r.unshift(this._dummyOption);var o=this.getSelectionCollection(),l=this.getValue();if(l instanceof Array)l=[].concat(l);o.beginUpdate();this.getOptionsCollection().setItems(r);if(l!==undefined)o.setValue(l);o.endUpdate();if(!this._multiple&&(this._value===null||this._value===undefined)&&this._selectSize===1){if(this._correctValueForSingleSelect())return}},_updateDummyOption:function(t){var e=null;t=t||this._objectsMapper;if(!this._multiple&&this._dummyLabel!==null&&this._dummyLabel!==undefined){if(this._dummyOption)e=this._dummyOption;else e=new Amm.Trait.Select.Option;e.setLabel(this._dummyLabel);e.setValue(this._dummyValue)}if(t){t.setDestExtra(e?[e]:null);return}if(!this.options)return;if(e&&!this._dummyOption){this.options.splice(0,0,e)}else if(!e&&this._dummyOption){this.options.reject(this._dummyOption)}this._dummyOption=e},getOptions:function(){if(!this.options)return undefined;var t=this.getOptionsCollection().getItems();if(this._dummyOption)return t.slice(1);return t},getOptionsCollection:function(){if(this.options)return this.options;var t={changeEvents:["labelChange","valueChange","disabledChange","visibleChange","selectedChange"],requirements:["Amm.Trait.Select.Option"],indexProperty:"index",observeIndexProperty:true,cleanupOnDissociate:true,sorter:this._sorter};this.options=new Amm.Collection(t);if(this._cleanupList)this._cleanupList.push(this.options);this.getSelectionCollection();this.options.subscribe("itemsChange",this._handleOptionsChange,this);return this.options},outOptionsCollectionChange:function(){},getSelectionCollection:function(){if(this._selectionCollection)return this._selectionCollection;var t={multiple:this._multiple,valueProperty:"value",selectedProperty:"selected"};this._selectionCollection=new Amm.Selection(t);this._selectionCollection.setCollection(this.getOptionsCollection());this._selectionCollection.subscribe("valueChange",this._handleSelfSelectionValueChange,this);this._selectionCollection.setValue(this._value);if(this._cleanupList)this._cleanupList.push(this._selectionCollection);return this._selectionCollection},setSelectSize:function(t){if(t!==undefined){t=parseInt(t)||1;if(t<0)t=1}var e=this._selectSize;if(e===t)return;this._selectSize=t;if(t===1&&!this._multiple&&(this._value===null||this._value===undefined)){if(this.options&&this.options.length){this._correctValueForSingleSelect()}}this.outSelectSizeChange(t,e);return true},getSelectSize:function(){return this._selectSize},outSelectSizeChange:function(t,e){this._out("selectSizeChange",t,e)},_handleSelfSelectionValueChange:function(t,e){if(t===undefined)t=null;if(!Amm.Trait.Select.valuesAreSame(t,this._value)){var i=this._value;this._value=t;if(!this._multiple&&this._value===null&&this._selectSize===1){if(this._correctValueForSingleSelect())return}this._numChanges++;this.outValueChange(t,i)}},_handleOptionsChange:function(t,e){if(!e.length&&t.length&&this._selectSize===1&&this._value===undefined){this._correctValueForSingleSelect()}},_correctValueForSingleSelect:function(){if(this._selectionCollection&&this._selectionCollection.getUpdateLevel()){return}var t=this.getOptionsCollection();for(var e=0,i=t.length;e<i;e++){var r=t[e];if(!r.getDisabled()&&r.getVisible()){this.setValue(r.getValue());return true}}},setMultiple:function(t){t=!!t;var e=this._multiple;if(e===t)return;this._multiple=t;this._updateDummyOption();if(this._selectionCollection)this._selectionCollection.setMultiple(t);this.outMultipleChange(t,e);return true},getMultiple:function(){return this._multiple},outMultipleChange:function(t,e){this._out("multipleChange",t,e)},setObjects:function(t){if(!t){this._detachObjects();return}if(!(t instanceof Array||Amm.is(t,"Amm.Array")))throw new Error("objects must be FALSEable, Array or Amm.Array; provided: "+Amm.describeType(t));if(!this._objectsMapper){this._objectsMapper=this._createObjectsMapper(t)}},getObjects:function(){if(!this._objectsMapper)return null;return this._objectsMapper.getSrc()},getObjectsItems:function(){if(!this._objectsMapper)return[];return this._objectsMapper.getSrc().getItems()},_detachObjects:function(t){if(!this._objectsMapper)return;this._objectsMapper.setSrc([]);this._objectsMapper.cleanup();for(var e=0,i=this._cleanupList.length;e<i;e++){if(this._cleanupList[e]===this._objectsMapper){this._cleanupList[e].splice(e,1);break}}this._objectsMapper=null},outObjectsChange:function(t,e){},setValue:function(t){var e=this._numChanges;this.getSelectionCollection().setValue(t);if(this._numChanges!==e)return true},setLabelProperty:function(t){var e=this._labelProperty;if(e===t)return;this._labelProperty=t;this.outLabelPropertyChange(t,e);this._updateInstantiator();return true},getLabelProperty:function(){return this._labelProperty},outLabelPropertyChange:function(t,e){this._out("labelPropertyChange",t,e)},setValueProperty:function(t){var e=this._valueProperty;if(e===t)return;this._valueProperty=t;this.outValuePropertyChange(t,e);this._updateInstantiator();return true},getValueProperty:function(){return this._valueProperty},setDisabledProperty:function(t){var e=this._disabledProperty;if(e===t)return;this._disabledProperty=t;this.outDisabledPropertyChange(t,e);this._updateInstantiator();return true},getDisabledProperty:function(){return this._disabledProperty},outDisabledPropertyChange:function(t,e){this._out("disabledPropertyChange",t,e)},_objectPropToExp:function(t){if(t.match(/^\w+$/))return"this.origin."+t;return t},_updateInstantiator:function(){if(!this._objectsMapper)return;var t=Amm.getProperty(this._selectionCollection.getItems(),"origin");this._selectionCollection.beginUpdate();this._objectsMapper.setInstantiator(this._createInstantiator());if(t.length){var e=[];for(var i=0,r=this.options.length;i<r;i++){if(Amm.Array.indexOf(this.options[i].getOrigin(),t)<0)continue;e.push(this.options[i])}this._selectionCollection.setItems(e)}this._selectionCollection.endUpdate()},_createInstantiator:function(){var t={class:"Amm.Trait.Select.Option"};if(this._labelProperty){t["in__label"]=this._objectPropToExp(this._labelProperty)}if(this._disabledProperty){t["in__disabled"]=this._objectPropToExp(this._disabledProperty)}if(this._valueProperty){t["in__value"]=this._objectPropToExp(this._valueProperty)}else{t["in__value"]="this.origin"}t["component"]=this.getClosestComponent();if(this._optionPrototype){t=Amm.overrideRecursive(t,this._optionPrototype)}return new Amm.Instantiator.Proto(t,"origin")},_createObjectsMapper:function(t){var e={instantiator:this._createInstantiator(),dest:this.getOptionsCollection()};var i=new Amm.ArrayMapper(e);i.beginUpdate();i.setSrc(t);this._updateDummyOption(i);i.endUpdate();return i},outValuePropertyChange:function(t,e){this._out("valuePropertyChange",t,e)},_cleanup_AmmTraitSelect:function(){this._detachObjects()},setDummyLabel:function(t){var e=this._dummyLabel;if(e===t)return;this._dummyLabel=t;this._updateDummyOption();this.outDummyLabelChange(t,e);return true},getDummyLabel:function(){return this._dummyLabel},outDummyLabelChange:function(t,e){this._out("dummyLabelChange",t,e)},setDummyValue:function(t){var e=this._dummyValue;if(e===t)return;this._dummyValue=t;this._updateDummyOption();this.outDummyValueChange(t,e);return true},getDummyValue:function(){return this._dummyValue},outDummyValueChange:function(t,e){this._out("dummyValueChange",t,e)},setOptionPrototype:function(t){if(!t)t=null;if(typeof t==="string"){t={class:t}}else if(typeof t!=="object"){throw Error("optionProtoype must be null, a string or an object")}var e=this._optionPrototype;if(e===t)return;this._optionPrototype=t;this.outOptionPrototypeChange(t,e);this._updateInstantiator();return true},getOptionPrototype:function(){return this._optionPrototype},outOptionPrototypeChange:function(t,e){this._out("optionPrototypeChange",t,e)},_setClosestComponent_ammTraitSelect:function(t){var e=this.getOptionsCollection();Amm.setProperty(e.getItems(),"component",t)},setSorter:function(t){if(this.options)return this.options.setSorter(t);this._sorter=t},getSorter:function(){if(this.options)return this.options.getSorter();else return this._sorter}};Amm.extend(Amm.Trait.Select,Amm.Trait.Input);Amm.Trait.Select.Option=function(t){Amm.Element.call(this,t)};Amm.Trait.Select.Option.prototype={"Amm.Trait.Select.Option":"__CLASS__",_value:null,_label:null,_disabled:false,_selected:false,_index:null,_origin:null,_visible:true,setValue:function(t){var e=this._value;if(e===t)return;this._value=t;this.outValueChange(t,e);return true},getValue:function(){return this._value},outValueChange:function(t,e){this._out("valueChange",t,e)},setLabel:function(t){var e=this._label;if(e===t)return;this._label=t;this.outLabelChange(t,e);return true},getLabel:function(){return this._label},outLabelChange:function(t,e){this._out("labelChange",t,e)},setDisabled:function(t){t=!!t;var e=this._disabled;if(e===t)return;this._disabled=t;this.outDisabledChange(t,e);if(this._disabled&&this._selected)this.setSelected(false);return true},getDisabled:function(){return this._disabled},outDisabledChange:function(t,e){this._out("disabledChange",t,e)},setSelected:function(t){t=!!t;if(this._disabled||!this._visible)t=false;var e=this._selected;if(e===t)return;this._selected=t;this.outSelectedChange(t,e);return true},getSelected:function(){return this._selected},outSelectedChange:function(t,e){this._out("selectedChange",t,e)},setIndex:function(t){var e=this._index;if(e===t)return;this._index=t;this.outIndexChange(t,e);return true},getIndex:function(){return this._index},outIndexChange:function(t,e){this._out("indexChange",t,e)},setOrigin:function(t){var e=this._origin;if(e===t)return;this._origin=t;this.outOriginChange(t,e);return true},getOrigin:function(){return this._origin},outOriginChange:function(t,e){this._out("originChange",t,e)},setVisible:function(t){t=!!t;var e=this._visible;if(e===t)return;this._visible=t;if(!this._visible&&this._selected)this.setSelected(false);this.outVisibleChange(t,e);return true},getVisible:function(){return this._visible},outVisibleChange:function(t,e){this._out("visibleChange",t,e)}};Amm.extend(Amm.Trait.Select.Option,Amm.Element);Amm.Trait.DisplayParent=function(){};Amm.Trait.DisplayParent.prototype={DisplayParent:"__INTERFACE__",displayChildren:null,_displayChildrenPrototype:null,_passDisplayChildrenToComponent:true,_displayChildrenObservedForComponent:false,__augment:function(t,e){var i={requirements:["Visual"],assocInstance:this,assocProperty:"displayParent",indexProperty:"displayOrder",observeIndexProperty:true,assocEvents:{cleanup:"_handleDisplayChildCleanup"}};if(this._displayChildrenPrototype){Amm.overrideRecursive(i,this._displayChildrenPrototype)}this.displayChildren=new Amm.Collection(i);Amm.Element.regInit(this,"99_DisplayParent_observe",this._observeDisplayChildrenForComponent)},setDisplayChildrenPrototype:function(t){if(!t)t=null;else if(typeof t!=="object"){Error("`displayChildrenPrototype` must be a nullable or an object")}var e=this._displayChildrenPrototype;if(e===t)return;this._displayChildrenPrototype=t;if(this.displayChildren&&this._displayChildrenPrototype){Amm.init(this.displayChildren,this._displayChildrenPrototype)}return true},getDisplayChildrenPrototype:function(){return this._displayChildrenPrototype},getDisplayChildren:function(){return this.displayChildren},setDisplayChildren:function(t){return this.displayChildren.setItems(t)},_observeDisplayChildrenForComponent:function(t){var e=t===undefined?!!(this._closestComponent&&this._passDisplayChildrenToComponent):!!t,i=!!this._displayChildrenObservedForComponent;if(e===i)return;if(e){this.displayChildren.subscribe("spliceItems",this._passDisplayChildrenOnSplice,this)}else{this.displayChildren.unsubscribe("spliceItems",this._passDisplayChildrenOnSplice,this)}this._displayChildrenObservedForComponent=!!e},_passDisplayChildrenOnSplice:function(t,e,i){if(!this._passDisplayChildrenToComponent||!this._closestComponent)return;var r=Amm.Array.symmetricDiff(e,i);var n=Amm.Array.symmetricDiff(i,e);if(r)this._closestComponent.rejectElements(r);if(n){this._closestComponent.acceptElements(n)}},setPassDisplayChildrenToComponent:function(t){t=!!t;var e=this._passDisplayChildrenToComponent;if(e===t)return;this._passDisplayChildrenToComponent=t;if(this._closestComponent){var i=[];i=i.concat(this.displayChildren.getItems());if(this._passDisplayChildrenToComponent){this._closestComponent.acceptElements(i)}else{this._closestComponent.rejectElements(i)}}this._observeDisplayChildrenForComponent();this.outPassDisplayChildrenToComponentChange(t,e);return true},getPassDisplayChildrenToComponent:function(){return this._passDisplayChildrenToComponent},outPassDisplayChildrenToComponentChange:function(t,e){this._out("passDisplayChildrenToComponentChange",t,e)},_findChildElements_DisplayParent:function(t){if(this._passDisplayChildrenToComponent){t.push.apply(t,this.displayChildren.getItems())}},_setClosestComponent_DisplayParent:function(t,e){if(this._passDisplayChildrenToComponent){Amm.Trait.Component.changeComponent(this.displayChildren,t,e)}this._observeDisplayChildrenForComponent()},_cleanup_DisplayParent:function(){this.displayChildren.cleanup()},_handleDisplayChildCleanup:function(t){if(t.getDisplayParent()===this){var e=this.displayChildren.getAllowDelete();var i=this.displayChildren.getAllowChangeOrder();this.displayChildren.setAllowDelete(true);this.displayChildren.setAllowChangeOrder(true);this.displayChildren.reject(t);this.displayChildren.setAllowDelete(e);this.displayChildren.setAllowChangeOrder(i)}}};Amm.Trait.Repeater=function(){};Amm.Trait.Repeater.prototype={Repeater:"__INTERFACE__",InstantiatorOrRepeater:"__INTERFACE__",_useFilter:true,_arrayMapperOptions:null,_reportedInstantiatorOptions:null,_withVariantsView:false,_assocProperty:null,_revAssocProperty:null,_repeaterItems:null,__augment:function(t,e){if(typeof e==="object"&&e&&"withVariantsView"in e){this._withVariantsView=!!e.withVariantsView;delete e.withVariantsView}Amm.Element.regInit(this,"99.Amm.Trait.Repeater",function(){if(this["DisplayParent"]!=="__INTERFACE__")throw Error("Repeater must be also a DisplayParent")});if("items"in e){var i=e.items;Amm.Element.regInit(this,"99.Amm.Trait.Repeater.setItems",function(){this.setItems(i)});delete e.items}if(e&&e.initialInstantiatorOptions){this._reportedInstantiatorOptions=e.initialInstantiatorOptions;delete e.initialInstantiatorOptions}},setItems:function(t){if(!t)t=[];else if(!(t instanceof Array)&&!t["Amm.Array"])t=[t];if(this._withVariantsView&&!this._arrayMapper)this._repeaterItems=t;else this.getArrayMapper().setSrc(t)},getItems:function(){return this.getArrayMapper().getSrc()},outItemsChange:function(t,e){return this._out("itemsChange",t,e)},_handleArrayMapperSrcChange:function(t,e){this.outItemsChange(t,e)},getArrayMapper:function(){if(!this._arrayMapper){this._createArrayMapper()}return this._arrayMapper},setArrayMapper:function(t){console.warn("Amm.Trait.Repeater: setArrayMapper() isn't supported; use setArrayMapperOptions() instead")},outArrayMapperChange:function(t,e){return this._out("arrayMapperChange",t,e)},_createArrayMapper:function(){var t=this._arrayMapper,e;this.displayChildren.setCleanupOnDissociate(true);if(t){e=t.getSrcIsOwn()?t.getSrc().getItems():t.getSrc();t.cleanup()}var i=this._calcArrayMapperOptions.apply(this,this._reportedInstantiatorOptions||[]);if(e)i.src=e;else if(this._repeaterItems){i.src=this._repeaterItems;this._repeaterItems=null}if(this._arrayMapperOptions)i=Amm.overrideRecursive(i,this._arrayMapperOptions);var r=Amm.constructInstance(i,Amm.ArrayMapper);this._arrayMapper=r;this.outArrayMapperChange(this._arrayMapper,t)},_calcArrayMapperOptions:function(t,e,i){var r;if((!e||!e.length)&&t){r={class:Amm.Instantiator.Proto,isElement:true,proto:t}}else{r={class:Amm.Instantiator.Variants,prototypes:i||[],defaultPrototype:t||null}}var n={dest:this.displayChildren,filter:{class:Amm.Filter,conditions:e},instantiator:r};if(!e||!e.length)delete n.filter;if(this._assocProperty)n.instantiator.assocProperty=this._assocProperty;if(this._revAssocProperty)n.instantiator.revAssocProperty=this._revAssocProperty;return n},_cleanup_Repeater:function(){this._arrayMapper.cleanup()},setArrayMapperOptions:function(t){if(!t)t=null;var e=this._arrayMapperOptions;if(e===t)return;this._arrayMapperOptions=t;if(this._arrayMapper)this._createArrayMapper();return true},getArrayMapperOptions:function(){return this._arrayMapperOptions},reportInstantiatorOptions:function(t,e,i){this._reportedInstantiatorOptions=[t,e,i];this._createArrayMapper()},setAssocProperty:function(t){var e=this._assocProperty;if(e===t)return;this._assocProperty=t;if(this._arrayMapper)this._createArrayMapper();return true},getAssocProperty:function(){return this._assocProperty},setRevAssocProperty:function(t){var e=this._revAssocProperty;if(e===t)return;this._revAssocProperty=t;if(this._arrayMapper)this._createArrayMapper();return true},getRevAssocProperty:function(){return this._revAssocProperty}};Amm.Trait.Data=function(){};Amm.Trait.Data.UPDATE_VALIDATE="validate";Amm.Trait.Data.UPDATE_CHANGE="change";Amm.Trait.Data.UPDATE_BLUR="blur";Amm.Trait.Data.UPDATE_NEVER="never";Amm.Trait.Data.LOCK_NEVER=0;Amm.Trait.Data.LOCK_DURING_TRANSACTION=1;Amm.Trait.Data.LOCK_WITHOUT_PROPERTY=2;Amm.Trait.Data._revDataUpdate={validate:"UPDATE_VALIDATE",change:"UPDATE_CHANGE",blur:"UPDATE_BLUR",never:"UPDATE_NEVER"};Amm.Trait.Data.prototype={Data:"__INTERFACE__",_dataObject:undefined,_dataProperty:undefined,_dataHasProperty:undefined,_dataValue:undefined,_dataSyncAnnotations:true,_dataUpdateMode:undefined,_dataParent:undefined,_dataSyncWithField:undefined,_dataSyncProperties:null,_subDataObject:null,_subDataProperty:null,_dataObjectUpdating:0,_dataControlUpdating:0,_dataLockMode:Amm.Trait.Data.LOCK_DURING_TRANSACTION|Amm.Trait.Data.LOCK_WITHOUT_PROPERTY,_dataModified:undefined,__augment:function(t,e){this._dataSyncProperties={dataObject:true,dataProperty:true,dataParent:true};Amm.Element.regInit(this,"aa.Amm.Trait.Data",this._initDataSync)},_initDataSync:function(){if(this._dataSyncWithField===undefined){this.setDataSyncWithField(this["Field"]==="__INTERFACE__");if(this._dataUpdateMode===undefined){if(this["Field"]==="__INTERFACE__"){this._dataUpdateMode=Amm.Trait.Data.UPDATE_VALIDATE}else{this._dataUpdateMode=Amm.Trait.Data.UPDATE_CHANGE}}}if(this._dataProperty===undefined)this._dataSyncProperty();if(this._dataParent===undefined)this._dataSyncParent();if(this["Focusable"]==="__INTERFACE__"){this.subscribe("focusedChange",this._handleSelfDataFocusedChange,this)}this._dataUpdateModified();this._dataUpdateLock()},_setClosestComponent_Data:function(t){this._dataSyncParent()},_setForm_Data:function(t){this._dataSyncParent()},_setId_Data:function(){this._dataSyncProperty()},_fieldNameChange_Data:function(){this._dataSyncProperty()},_dataSyncParent:function(){if(!this._dataSyncProperties.dataParent)return;var t=null;if(this._dataSyncWithField&&this._form&&this._form["Data"]==="__INTERFACE__"){t=this._form}else if(this._closestComponent&&this._closestComponent["Data"]==="__INTERFACE__"){t=this._closestComponent}this.setDataParent(t,true)},_dataSyncProperty:function(){var t=null;if(!this._dataSyncProperties.dataProperty)return;if(this._dataSyncWithField&&this.getFieldName()){t=this.getFieldName()}else if(this._id){t=this._id}this.setDataProperty(t,true)},_dataSyncObject:function(){var t=null;if(!this._dataSyncProperties.dataObject)return;if(this._dataParent){if(this._dataParent.getDataProperty()){t=this._dataParent.getDataValue()}else{t=this._dataParent.getDataObject()}}if(!t)t=null;this.setDataObject(t,true)},setDataParent:function(t,e){var i=this._dataParent;if(i===t)return;if(!e)this._dataSyncProperties.dataParent=t===undefined;if(i){i.unsubscribe("dataObjectChange",this._dataSyncObject,this);i.unsubscribe("dataValueChange",this._dataSyncObject,this)}this._dataParent=t;if(t){t.subscribe("dataObjectChange",this._dataSyncObject,this);t.subscribe("dataValueChange",this._dataSyncObject,this)}this._dataSyncObject();this.outDataParentChange(t,i);return true},getDataParent:function(){return this._dataParent},outDataParentChange:function(t,e){this._out("dataParentChange",t,e)},setDataObject:function(t,e){if(t)Amm.is(t,"Amm.Data.Object",t);else if(t!==undefined)t=null;var i=this._dataObject;if(i===t)return;this._dataObject=t;if(i){i.lm.unsubscribe("propertiesChanged",this._dataCheckProperty,this);i.lm.unsubscribe("errorsChange",this._handleDataErrorsChange,this);i.lm.unsubscribe("transactionChange",this._handleDataTransactionChange,this);i.lm.unsubscribe("modifiedChange",this._dataUpdateModified,this);i.lm.getMapper().unsubscribe("metaChange",this._handleDataMetaChange,this)}if(!e)this._dataSyncProperties.dataObject=t===undefined;if(t){t.lm.subscribe("propertiesChanged",this._dataCheckProperty,this);t.lm.subscribe("errorsChange",this._handleDataErrorsChange,this);t.lm.subscribe("transactionChange",this._handleDataTransactionChange,this);t.lm.subscribe("modifiedChange",this._dataUpdateModified,this);t.lm.getMapper().subscribe("metaChange",this._handleDataMetaChange,this)}this.outDataObjectChange(t,i);this._dataUpdateModified();this._dataUpdateLock();this._dataCheckProperty();this._dataSyncMeta();this._dataSyncErrors();return true},getDataObject:function(){return this._dataObject},outDataObjectChange:function(t,e){this._out("dataObjectChange",t,e)},_handleDataTransactionChange:function(){this._dataUpdateLock()},_handleDataErrorsChange:function(t){this._dataSyncErrors()},_dataSyncErrors:function(){var t=null;var e=this._dataSyncWithField||this["Annotated"]==="__INTERFACE__";if(!e)return;if(this._dataHasProperty)t=this._dataObject.lm.getErrors(this._dataProperty);if(this._dataSyncWithField){this.setFieldRemoteErrors(t)}else{this.setError(t)}},_handleDataMetaChange:function(t,e,i,r,n,s){if(!this._dataHasProperty)return;if(!i||i===this._dataProperty){this._dataSyncMeta(t[this._dataProperty])}},_dataSyncMeta:function(t){if(!this._dataHasProperty||!this._dataSyncAnnotations)return;if(!t)t=this._dataObject.lm.getMapper().getMeta(this._dataProperty);var e=this._dataSyncWithField;if(e){this.setFieldLabel(t.label);this.setFieldRequired(t.required)}else if(this["Annotated"]==="__INTERFACE__"){if(!e){this.setLabel(t.label);this.setRequired(t.required)}this.setDescription(t.description,"description")}},setDataProperty:function(t){var e=this._dataProperty;if(e===t)return;this._dataProperty=t;this.outDataPropertyChange(t,e);this._dataCheckProperty();return true},getDataProperty:function(){return this._dataProperty},outDataPropertyChange:function(t,e){this._out("dataPropertyChange",t,e)},_dataCheckProperty:function(){var t=false;if(this._dataObject&&this._dataProperty){t=Amm.detectProperty(this._dataObject,this._dataProperty)}var e=this._subDataObject===this._dataObject&&this._subDataProperty===this._dataProperty;if(this._subDataObject&&!e){this._subDataObject.unsubscribe(this._subDataProperty+"Change",this._handleDataValueChange,this);this._subDataObject=null;this._subDataProperty=null}if(t&&!e){this._subDataObject=this._dataObject;this._subDataProperty=this._dataProperty;this._subDataObject.subscribe(this._subDataProperty+"Change",this._handleDataValueChange,this);this._dataObjectUpdating++;this.setDataValue(this._subDataObject[this._subDataProperty]);this._dataObjectUpdating--}this.setDataHasProperty(t)},_handleDataValueChange:function(t){this._dataObjectUpdating++;this.setDataValue(t);this._dataUpdateModified();this._dataObjectUpdating--},setDataHasProperty:function(t){t=!!t;var e=this._dataHasProperty;if(e===t)return;this._dataHasProperty=t;this._dataUpdateLock();this._dataUpdateModified();this.outDataHasPropertyChange(t,e);if(t){this._dataUpdateValueSync();this._dataSyncMeta(this._dataObject.lm.getMapper().getMeta(this._dataProperty))}return true},getDataHasProperty:function(){return this._dataHasProperty},outDataHasPropertyChange:function(t,e){this._out("dataHasPropertyChange",t,e)},setDataValue:function(t,e){var i=this._dataValue;if(i===t&&!e)return;this._dataValue=t;if(!this._dataObjectUpdating&&this._dataHasProperty){this._dataObject[this._dataProperty]=t}if(!this._dataControlUpdating){if(this._dataSyncWithField)this.setFieldValue(t);else this.setValue(t)}if(!e||i!==t){this.outDataValueChange(t,i)}return true},getDataValue:function(){return this._dataValue},outDataValueChange:function(t,e){this._out("dataValueChange",t,e)},setDataSyncAnnotations:function(t){t=!!t;var e=this._dataSyncAnnotations;if(e===t)return;this._dataSyncAnnotations=t;if(t&&this._dataHasProperty){this._dataSyncMeta(this._dataObject.lm.getMapper().getMeta(this._dataProperty))}return true},getDataSyncAnnotations:function(){return this._dataSyncAnnotations},setDataUpdateMode:function(t){if(!Amm.Trait.Data._revDataUpdate[t])throw Error("dataUpdateMode must be one of Amm.Trait.Data.UPDATE_*");var e=this._dataUpdateMode;if(e===t)return;this._dataUpdateMode=t;this._dataSyncUpdateMode();return true},getDataUpdateMode:function(){return this._dataUpdateMode},setDataSyncWithField:function(t){t=!!t;if(t&&this["Field"]!=="__INTERFACE__"){throw Error("Need Field trait to enable data sync with field")}var e=this._dataSyncWithField;if(e===t)return;this._dataSyncWithField=t;this._dataUpdateValueSync();return true},_dataUpdateValueSync:function(){var t=typeof this.outValueChange==="function";var e=this["Field"]==="__INTERFACE__";if(this._dataSyncWithField){if(t){this.unsubscribe("valueChange",this._handleSelfControlValueChange,this)}this.subscribe("fieldValueChange",this._handleSelfControlValueChange,this);this.subscribe("afterFieldValidate",this._handleSelfDataAfterFieldValidate,this)}else{if(t){this.subscribe("valueChange",this._handleSelfControlValueChange,this)}if(e){this.unsubscribe("fieldValueChange",this._handleSelfControlValueChange,this);this.unsubscribe("afterFieldValidate",this._handleSelfDataAfterFieldValidate,this)}}},getDataSyncWithField:function(){return this._dataSyncWithField},_updateDataValueFromControl:function(t){this._dataControlUpdating++;if(!arguments.length){t=this._dataSyncWithField?this.getFieldValue():this.getValue()}this.setDataValue(t);this._dataControlUpdating--},_handleSelfDataAfterFieldValidate:function(t){if(this._dataUpdateMode===Amm.Trait.Data.UPDATE_VALIDATE&&t){this._updateDataValueFromControl()}},_handleSelfControlValueChange:function(t){if(this._dataObjectUpdating)return;if(this._dataUpdateMode===Amm.Trait.Data.UPDATE_CHANGE){this._updateDataValueFromControl(t)}},_handleSelfDataFocusedChange:function(t){if(t)return;if(this._dataUpdateMode!==Amm.Trait.Data.UPDATE_BLUR)return;this._updateDataValueFromControl()},setDataLockMode:function(t){if(!t)t=0;if(typeof t!=="Number"){throw Error("dataLockMode must be a number")}var e=this._dataLockMode;if(e===t)return;this._dataLockMode=t;this._dataUpdateLock();return true},getDataLockMode:function(){return this._dataLockMode},_dataUpdateLock:function(){if(this["Lockable"]!=="__INTERFACE__"||!this._dataLockMode)return;var t=false;if(this._dataLockMode&Amm.Trait.Data.LOCK_WITHOUT_PROPERTY){if(!this._dataHasProperty)t=true}if(this._dataLockMode&Amm.Trait.Data.LOCK_DURING_TRANSACTION){if(this._dataObject&&this._dataObject.lm.getTransaction()){t=true}}this.setLocked(t)},setDataModified:function(t,e){t=!!t;var i=this._dataModified;if(i===t)return;if(!e&&t)return;if(!e&&!t&&this._dataHasProperty){this.setDataValue(this._dataObject.lm.getOldValue(this._dataProperty));return}this._dataModified=t;this.outDataModifiedChange(t,i);return true},outDataModifiedChange:function(t,e){return this._out("dataModifiedChange",t,e)},getDataModified:function(){return this._dataModified},_dataUpdateModified:function(){var t=false;if(this._dataHasProperty){t=this._dataObject.lm.getModified(this._dataProperty)}else if(this._dataObject&&!this._dataProperty){t=this._dataObject.lm.getModified()}this.setDataModified(t,true)}};Amm.Builder.Node=function(t){this.children=[];this.connected=[this];this.conIdx=0;if(t)Amm.override(this,t)};Amm.Builder.Node.prototype={htmlElement:null,v:null,e:null,x:null,id:null,global:false,parent:null,children:null,connected:null,conIdx:null,conParent:false,conChild:false};Amm.Builder.Ref=function(t,e){if(t&&"$ref"in t){if(t["$ref"]&&!("find"in t))t["find"]=t["$ref"];delete t["$ref"]}if(e)this.setNode(e);Amm.init(this,t)};Amm.Builder.Ref.prototype={"Amm.Builder.Ref":"__CLASS__",_node:null,_parent:0,_closest:null,_find:null,_index:0,_global:false,setNode:function(t){if(!t)t=null;else if(!(t instanceof HTMLElement||t.tagName)){throw Error("`node` must be an instance of HTMLElement")}this._node=t},getNode:function(){return this._node},setGlobal:function(t){t=!!t;this._global=t},getGlobal:function(){return this._global},setParent:function(t){if(typeof t!=="number"){t=parseInt(t)}if(isNaN(t)||t<0){throw Error("`parent` must be a number >= 0")}this._parent=t},getParent:function(){return this._parent},setClosest:function(t){if(!t)t=null;else if(typeof t!=="string")throw Error("`closest` must be a null or a string");this._closest=t},getClosest:function(){return this._closest},setFind:function(t){this._find=t},getFind:function(){return this._find},setIndex:function(t){if(t!==null){if(typeof t!=="number"){t=parseInt(t);if(isNaN(t)||t<0){throw Error("`index` must be a number >= 0")}}}this._index=t},getIndex:function(){return this._index},resolve:function(t){if(!this._global&&!this._node)throw Error("Cannot resolve without `node`");var e=this._global?jQuery:jQuery(this._node);if(this._parent&&!this._global){for(var i=0;i<this._parent&&e.length;i++){e=e.parent()}if(!e.length)return null}if(this._closest&&!this._global){e=e.closest(this._closest);if(!e)return null}if(this._find){e=e.find(this._find);if(!e)return null}if(this._index!==null){return e[this._index]||null}if(t)return e[0]||null;return e}};Amm.Filter=function(t){Amm.FilterSorter.call(this,t)};Amm.Filter.prototype={"Amm.Filter":"__CLASS__",_oldMatchingObjects:null,_matchingObjects:null,filter:function(t,e){if(!(e instanceof Array))e=[];else e.splice(0,e.length);var i,r,n,s=[];for(i=0,r=t.length;i<r;i++){n=this.evaluateMatch(t[i]);if(!n)continue;s.push(t[i]);e.push(n)}return s},setConditions:function(t,e){var i=null,r,n,s;if(this._subscribers.outConditionsChange){r=[].concat(this._observers)}if(e){if(t){if(typeof t!=="object")throw Error("setConditions(`conditions`, `id`): `conditions` must be a null or an object");t._id=e;i=this._createCondition(t)}this.beginUpdate();for(n=0,s=this._observers.length;n<s;n++){if(this._observers[n].id===e){this._observers[n].cleanup();this._observers.splice(n,1);break}}this._observers.push(i);if(this._subscribers.outConditionsChange){this.outConditionsChange([].concat(this._observers),r)}i.observe(this._objects);this.refresh();this.endUpdate();return}var a=[];if(t){if(!(t instanceof Array))throw Error("`conditions` must be an Array");var o={};for(n=0,s=t.length;n<s;n++){i=this._createCondition(t[n]);a.push(i);if(!i.id)continue;if(i.id in o)throw Error("conditions['"+n+"'].id is same as "+"conditions['"+o[i.id]+"'] ('"+i.id+"')");o[i.id]=n}}this.beginUpdate();for(n=this._observers.length-1;n>=0;n--){this._observers[n].cleanup()}this._observers=a;this._subObservers(this._objects);if(this._subscribers.outConditionsChange){this.outConditionsChange([].concat(this._observers),r)}this.refresh();this.endUpdate()},getConditions:function(t){var e,i;if(!t)return[].concat(this._observers);for(e=0,i=this._observers.length;e<i;e++){if(t===e+1||this._observers[e].id===t)return this._observers[e]}return null},outConditionsChange:function(t,e){return this._out("conditionsChange",t,e)},outMatchingObjectsChange:function(t,e){return this._out("matchingObjectsChange",t,e)},beginUpdate:function(){if(!this._updateLevel)this._oldMatchingObjects=this.getMatchingObjects();Amm.FilterSorter.prototype.beginUpdate.call(this);this._matchingObjects=null},_doOnEndUpdateChange:function(){if(!this._subscribers.matchingObjectsChange)return;var t=this.getMatchingObjects();if(Amm.Array.equal(t,this._oldMatchingObjects))return;var e=this._oldMatchingObjects;this._oldMatchingObjects=null;this.outMatchingObjectsChange(t,e)},_createCondition:function(t){if(t&&typeof t==="string"){console.log(t);t={_expr:t}}if(!t||typeof t!=="object")throw Error("filter condition must be an object, given: "+Amm.describeType(t));if(t._expr)return new Amm.Filter.ExpressionCondition(this,t);return new Amm.Filter.PropsCondition(this,t)},setRequireAll:function(t){t=!!t;var e=this._requireAll;if(e===t)return;this._requireAll=t;this.outRequireAllChange(t,e);if(this._observers.length)this.refresh();return true},getRequireAll:function(){return this._requireAll},outRequireAllChange:function(t,e){this._out("requireAllChange",t,e)},getMatchingObjects:function(){if(this._matchingObjects)return this._matchingObjects;var t=[],e,i;for(e=0,i=this._objects.length;e<i;e++){if(this._matches[e]){t.push(this._objects[e])}}if(this._oldMatchingObjects&&Amm.Array.equal(t,this._oldMatchingObjects))t=this._oldMatchingObjects;this._matchingObjects=t;return t},_doOnUpdateMatch:function(t,e,i){if(!!i===!!e)return;this._matchingObjects=null;if(!this._subscribers.matchingObjectsChange)return;var r=[],n=[],s,a;for(s=0,a=this._objects.length;s<a;s++){if(s===t&&e)n.push(this._objects[s]);if(this._matches[s]){r.push(this._objects[s]);n.push(this._objects[s])}}this._matchingObjects=r;this.outMatchingObjectsChange(r,n)},evaluateMatch:function(t){if(!this._observers.length)return true;var e;for(var i=0,r=this._observers.length;i<r;i++){e=false;if(this._observers[i].match(t))e=this._observers[i].id||i+1;if(this._requireAll){if(!e)return false}else{if(e)return e}}if(this._requireAll)return e;return false},_hasChangeSubscribers:function(){return this._subscribers.matchesChange||this._subscribers.matchingObjectsChange}};Amm.extend(Amm.Filter,Amm.FilterSorter);Amm.Filter.Condition=function(t,e){if(e&&e._id){this.id=e._id;delete e._id}if(e&&e._class){this.requiredClass=e._class;delete e._class}if(e&&e._not){this.not=true;delete e._not}Amm.FilterSorter.Observer.call(this,t,e,true)};Amm.Filter.Condition.testValue=function(t,e){var i,r;if(t instanceof Array||t&&t["Amm.Array"]){if(typeof e==="object"&&e&&e.only){for(i=0,r=t.length;i<r;i++){if(!Amm.Filter.Condition.testValue(t[i],e.only))return false}return true}for(i=0,r=t.length;i<r;i++){if(Amm.Filter.Condition.testValue(t[i],e))return true}return false}if(e instanceof Array){for(i=0,r=e.length;i<r;i++){if(this.testValue(t,e[i]))return true}return}if(e instanceof RegExp){return typeof t==="string"&&e.exec(t)}if(typeof e==="function"){return!!e(t)}if(typeof e==="object"&&e){if("and"in e){if(!e.and||!(e.and instanceof Array))return Amm.Filter.Condition.testValue(t,e.and);for(i=0,r=e.and.length;i<r;i++){if(!this.testValue(t,e.and[i]))return false}return true}if("only"in e)return Amm.Filter.Condition.testValue(t,e.only);if("typeof"in e){return Amm.Filter.Condition.testValue(typeof t,e.typeof)}if(typeof e.fn==="function")return e.scope?e.fn.call(e.scope,t):e.fn(t);if("regExp"in e)return Amm.Filter.Condition.testValue(t,new RegExp(e.regExp,e.flags||""));if("validator"in e){return!Amm.Validator.iErr(e,"validator",t)}if(e["Amm.Validator"]){return!e.getError(t)}if("strict"in e)return t===e.strict;if("rq"in e)return Amm.meetsRequirements(t,e.rq);if("not"in e)return!Amm.Filter.Condition.testValue(t,e.not);throw Error("object `test` must contain at least one of following keys: `and`, `only`, `fn`, `regExp`, `validator`, `strict`, `rq`, `not`")}return e==t};Amm.Filter.Condition.prototype={"Amm.Filter.Condition":"__CLASS__",id:null,requiredClass:null,not:false,match:function(t){var e=true;if(this.requiredClass&&!Amm.is(t,this.requiredClass))e=false;else e=this._doMatch(t);if(this.not)e=!e;return e},_doMatch:function(t){return true},setProps:function(t,e){},getProps:function(t){},outPropsChange:function(t,e){return this._out("propsChange",t,e)}};Amm.extend(Amm.Filter.Condition,Amm.FilterSorter.Observer);Amm.Filter.PropsCondition=function(t,e){e=Amm.override({},e);if("_allowExpressions"in e){this.allowExpressions=!!e._allowExpressions;delete e._allowExpressions}this._props={};this._expressions={};this._evaluators={};this._propList=[];Amm.Filter.Condition.call(this,t,e);this.setProps(e)};Amm.Filter.propNameRx=/^\w+$/;Amm.Filter.PropsCondition.prototype={"Amm.Filter.PropsCondition":"__CLASS__",allowExpressions:true,_props:null,_expressions:null,_evaluators:null,_propList:null,_noRefresh:0,_checkProps:function(t,e){if(!e)e={};for(var i=0,r=t.length;i<r;i++){if(Amm.Filter.propNameRx.exec(t[i]))continue;if(!this.allowExpressions){throw Error("'"+t[i]+"' doesn't look like simple property name; "+" set `allowExpressions` to true to access expression values")}if(this._expressions[t[i]]){e[t[i]]=this._expressions[t[i]];continue}e[t[i]]=new Amm.Expression(t[i]);e[t[i]].setEventsProxy(this._filterSorter)}},setProps:function(t,e){this._noRefresh++;var i={};var r;if(this._subscribers.propsChange){r=Amm.override({},this._props)}if(e){var n=!(e in this._props);this._checkProps([e],i);this._props[e]=t;if(n){if(this.allowExpressions){Amm.override(this._expressions,i)}this._propList.push(e);this._sub(e)}}else if(t){var s=Amm.keys(t);this._checkProps(s,i);this.deleteProps(null,i);if(this.allowExpressions){Amm.override(this._expressions,i)}this._props=Amm.override({},t);this._propList=s;this._sub()}else{this.deleteProps()}if(this._subscribers.propsChange)this.outPropsChange(this._props,r);this._noRefresh--;if(!this._noRefresh)this._filterSorter.refresh()},_handleChange:function(){var t=Amm.event.origin;this._filterSorter.refresh(t)},_handleExpressionChange:function(t,e){var i=Amm.event.origin.getExpressionThis();this._filterSorter.refresh(i)},_sub:function(t,e){var i=e||this._filterSorter._objects,r=i.length,n,s,a;if(!t)t=this._propList;var o,l=t.length;for(n=0;n<r;n++){s=i[n];if(!s["Amm.WithEvents"])continue;for(o=0;o<l;o++){if(this._expressions[t[o]]){var h=this._expressions[t[o]].findContext(s);if(h!==undefined)continue;this._expressions[t[o]].createContext({expressionThis:s});this._expressions[t[o]].subscribe("valueChange",this._handleExpressionChange,this);continue}a=t[o]+"Change";if(this.requiredClass&&!Amm.is(s,this.requiredClass))continue;if(!s.hasEvent(a))continue;this._filterSorter.subscribeObject(s,a,this._handleChange,this)}}},_unsub:function(t,e){var i=e||this._filterSorter._objects,r=i.length,n,s,a;if(!t)t=this._propList;var o,l=t?t.length:0;for(n=0;n<r;n++){s=i[n];if(!s["Amm.WithEvents"])continue;if(this.requiredClass&&!Amm.is(s,this.requiredClass))continue;for(o=0;o<l;o++){if(this._expressions[t[o]]){var h=this._expressions[t[o]].findContext(s);if(h!==undefined)this._expressions[t[o]].deleteContext(h);continue}a=t[o]+"Change";if(this._expressions[t[o]])continue;if(!s.hasEvent(a))continue;this._filterSorter.unsubscribeObject(s,a,this._handleChange,this)}}},_doMatch:function(t){var e,i,r;for(var n=0,s=this._propList.length;n<s;n++){if(e=this._expressions[this._propList[n]]){if(e.getExpressionThis()===t){r=e.getValue()}else{i=e.findContext(t);if(i===undefined){if(!this._evaluators[this._propList[n]])this._evaluators[this._propList[n]]=e.toFunction();this._evaluators[this._propList[n]].env.expressionThis=t;r=this._evaluators[this._propList[n]]()}else{e.setContextId(i);r=e.getValue()}}}else{r=Amm.getProperty(t,this._propList[n])}if(!Amm.Filter.Condition.testValue(r,this._props[this._propList[n]])){return false}}return true},observe:function(t){this._sub(this._propList,t)},unobserve:function(t){this._unsub(null,t)},getProps:function(t){if(t)return this._props[t];return this._props},deleteProps:function(t,e){if(t&&!(t instanceof Array)){t=[t]}this._unsub(t);if(!t){this._props={};this._propList=[]}else{for(var i=0,r=t.length;i<r;i++){delete this._props(t[i]);if(!this._expressions[t[i]])continue;if(e&&e[t[i]])continue;this._expressions[t[i]].cleanup();if(this._evaluators[[t[i]]]){this._evaluators[[t[i]]].env.expressionThis={};delete this._evaluators[[t[i]]]}delete this._expressions[t[i]]}this._propList=Amm.Array.diff(this._propList,t)}if(!this._noRefresh)this._filterSorter.refresh()},cleanup:function(){Amm.Filter.Condition.prototype.cleanup.call(this);for(var t in this._expressions)if(this._expressions.hasOwnProperty(t)){this._expressions[t].cleanup()}this._expressions={};this._evaluators={};this._propList=[];this._props={}}};Amm.extend(Amm.Filter.PropsCondition,Amm.Filter.Condition);Amm.Filter.ExpressionCondition=function(t,e){var i=Amm.override({},e);var r=null;if(e._expr){r=e._expr;delete e._expr}if(!r)throw Error("options._expr must be provided for Amm.Filter.ExpressionCondition");Amm.Filter.Condition.call(this,t,e);this._props=Amm.override({},e);this._setExpression(r)};Amm.Filter.ExpressionCondition.prototype={"Amm.Filter.ExpressionCondition":"__CLASS__",_expression:null,_evaluator:null,_props:null,_setExpression:function(t){this._expression=new Amm.Expression(t);this._expression.setEventsProxy(this._filterSorter)},_handleExpressionChanged:function(t,e){var i=this._expression.getExpressionThis();this._filterSorter.refresh(i)},match:function(t){if(t===this._expression.getExpressionThis()){return this._expression.getValue()}var e=this._expression.findContext(t);if(e!==undefined){this._expression.setContextId(e);return this._expression.getValue()}if(!this._evaluator)this._evaluator=this._expression.toFunction();this._evaluator.env.expressionThis=t;this._evaluator.env.vars=this._props;return this._evaluator()},observe:function(t){for(var e=0,i=t.length;e<i;e++){var r=t[e];if(this._expression.findContext(r)!==undefined)continue;this._expression.createContext({expressionThis:r,vars:this._props});this._expression.subscribe("valueChange",this._handleExpressionChanged,this)}},unobserve:function(t){for(var e=0,i=t.length;e<i;e++){var r=this._expression.findContext(t[e]);if(r===undefined)continue;this._expression.deleteContext(r)}},cleanup:function(){Amm.Filter.Condition.prototype.cleanup.call(this);this._expression.cleanup();this._evaluator=null;this._expression=null;this._props={}},setProps:function(t,e){var i;if(this._subscribers.propsChange)i=Amm.override({},this._props);if(e)this._props[e]=t;else{if(!t||typeof t!=="object")throw Error("`props` must be a non-null object when `propName` not provided");this._props=e}if(this._expression){if(this._filterSorter)this._filterSorter.beginUpdate();var r=this._expression.listContexts(),n,s;for(n=0,s=r.length;n<s;n++){this._expression.setContextId(r[n]);this._expression.setVars(t,e)}if(this._filterSorter)this._filterSorter.endUpdate()}if(this._subscribers.propsChange)this.outPropsChange(this._props,i)},getProps:function(t){if(t!==undefined)return this._props[t];return this._props}};Amm.extend(Amm.Filter.ExpressionCondition,Amm.Filter.Condition);Amm.Data={isEmpty:function(t){if(!t)return true;if(t instanceof Array)return!t.length;if(typeof t==="object"){for(var e in t)if(t.hashOwnProperty(e))return!isEmpty(t[e]);return true}return false},flattenErrors:function(t,e){if(!t)return[];if(typeof t!=="object")return[t];var i;var r=e||[],e=e||r;if(t instanceof Array){for(i=0,l=t.length;i<l;i++){if(Amm.Data.isEmpty(t[i]))continue;if(typeof t[i]==="object"&&t[i])Amm.Data.flattenErrors(t[i],r);if(Amm.Array.indexOf(e,t[i])<0)e.push(t[i])}}else{for(i in t)if(t.hasOwnProperty(i)){if(Amm.Data.isEmpty(t[i]))continue;if(typeof t[i]==="object"&&t[i])Amm.Data.flattenErrors(t[i],r);if(t[i]instanceof Array&&!t[i].length){delete t[i];continue}if(Amm.Array.indexOf(e,t[i])<0)e.push(t[i])}}return r}};Amm.Data.STATE_NEW="new";Amm.Data.STATE_EXISTS="exists";Amm.Data.STATE_DELETED="deleted";Amm.Data.StateEnum={};Amm.Data.StateEnum[Amm.Data.STATE_NEW]=Amm.Data.STATE_NEW;Amm.Data.StateEnum[Amm.Data.STATE_EXISTS]=Amm.Data.STATE_EXISTS;Amm.Data.StateEnum[Amm.Data.STATE_DELETED]=Amm.Data.STATE_DELETED;Amm.Data.ERROR_OTHER="ERROR_OTHER";Amm.Data.ERROR_GENERIC="ERROR_GENERIC";Amm.Data.ERROR_EXCEPTION="ERROR_EXCEPTION";Amm.Data.AUTO_CHECK_NEVER=0;Amm.Data.AUTO_CHECK_SMART=1;Amm.Data.AUTO_CHECK_ALWAYS=2;Amm.Data.Mapper=function(t){this._meta={};if(t&&"metaClass"in t)this.metaClass=t.metaClass;Amm.WithEvents.call(this,t)};Amm.Data.Mapper.instances={};Amm.Data.Mapper.get=function(t,e){if(this.instances[t]||e)return this.instances[t]||null;throw Error("No such mapper: '"+t+"'")};Amm.Data.Mapper.transactionDefault=null;Amm.Data.Mapper.prototype={"Amm.Data.Mapper":"__CLASS__",_id:null,_key:"id",_objectPrototype:null,_objectClass:null,_interface:null,_transactionPrototypes:null,_allFieldValidators:null,_fieldValidators:null,_commonValidators:null,_uri:null,_meta:null,requireLoadDataNotEmpty:true,requireLoadDataHasKey:true,requireCreateDataHasKey:true,partialHydrateOnCreate:true,partialHydrateOnUpdate:true,metaClass:"Amm.Data.Meta",requiredValidatorPrototype:null,_requiredValidator:null,setId:function(t){if(typeof t!=="string"||!t)throw Error("`id` must be a non-empty string");var e=this._id;if(e===t)return;if(e!==null)throw Error("Can setId() only once");if(Amm.Data.Mapper.instances[t])throw Error("Mapper with id '"+t+"' already registered");this._id=t;return true},getId:function(){return this._id},setObjectPrototype:function(t){if(!t)t={};var e=this._objectPrototype;if(e===t)return;if(e!==null)throw Error("can setObjectPrototype() only once");this._objectPrototype=t;return true},getObjectPrototype:function(){return this._objectPrototype?Amm.override({},this._objectPrototype):{}},setKey:function(t){var e=this._key;if(e===t)return;this._key=t;return true},getKey:function(){return this._key},setObjectClass:function(t){var e=this._objectClass;if(e===t)return;if(e!==t)throw Error("can setObjectClass() only once");this._objectClass=t;return true},getObjectClass:function(){return this._objectClass},construct:function(t){if(!t||typeof t!=="object")throw Error("`objectOrArray` must be an object");if(t instanceof Array||t["Amm.Array"]){var e=[];for(var i=0,r=t.length;i<r;i++){e.push(this.construct(t[i]))}return e}if(Amm.getClass(t))throw Error("`objectOrArray` must have no class");var n=this.getObjectClass()||Amm.Data.Object,s=Amm.getFunction(n);var a=Amm.override({},t);a._mapper=this;return new s(a)},setInterface:function(t){var e=this._interface;if(e===t)return;this._interface=t;return true},getInterface:function(){return this._interface},setFieldValidators:function(t){if(typeof t!=="object"){throw Error("fieldValidators must be an object or null")}this._allFieldValidators=null;this._fieldValidators=Amm.Data.Mapper.checkValidatorsHash(t,"fieldValidators");return true},_combineFieldValidators:function(){this._allFieldValidators={};var t,e;for(t in this._fieldValidators)if(this._fieldValidators.hasOwnProperty(t)){e=[].concat(this._fieldValidators[t]);if(this._meta&&t in this._meta){if(this._meta[t].required)e.unshift(this.getRequiredValidator());e=e.concat(this._meta[t].getValidators())}this._allFieldValidators[t]=e}for(t in this._meta)if(this._meta.hasOwnProperty(t)&&!(this._fieldValidators&&t in this._fieldValidators)){e=this._meta[t].getValidators();if(this._meta[t].required)e.unshift(this.getRequiredValidator());if(e.length)this._allFieldValidators[t]=e}},getFieldValidators:function(t){if(!t)return this._fieldValidators||{};if(!this._allFieldValidators)this._combineFieldValidators();return this._allFieldValidators},setCommonValidators:function(t){if(typeof t!=="object"){throw Error("commonValidators must be an object or null")}this._commonValidators=Amm.Data.Mapper.checkValidatorsHash(t,"commonValidators");return true},getCommonValidators:function(){return this._commonValidators},setUri:function(t){var e=this._uri;if(e===t)return;this._uri=t;return true},getUri:function(){return this._uri},setTransactionPrototypes:function(t){if(typeof t!=="object"){throw Error("transactionPrototypes must be an object or null")}var e=this._transactionPrototypes;if(e===t)return;this._transactionPrototypes=t;return true},getTransactionPrototypes:function(){return this._transactionPrototypes},createTransaction:function(t,e,i){var r=this._transactionPrototypes||{};var n=Amm.Data.Mapper.transactionDefault?Amm.override({},Amm.Data.Mapper.transactionDefault):{};var s=r.default?Amm.overrideRecursive(n,r.default):{};if(r[t]){if(r[t].noDefault)s=Amm.override({},r[t]);else s=Amm.overrideRecursive(r[t],s)}if(!s.class)s.class="Amm.Data.HttpTransaction";if(!s.uri&&this._uri)s.uri=this._uri;var a=Amm.constructInstance(s,"Amm.Data.Transaction",{type:t,key:e||null,data:i||null});a.subscribe("validateResult",this._validateTransactionResult,this);return a},extractKey:function(t){var e=this._key;if(!(e instanceof Array)){if(e in t)return t[e];return undefined}var i=[],r,n=e.length;for(var r=0;r<n;r++){if(e[r]in t)i.push(this.o._old[e[r]]);else break}if(i.length===n)return i;return undefined},_validateTransactionResult:function(t,e){var i=t.getData()||{};if(e.getType()===Amm.Data.Transaction.TYPE_LOAD){if(this.requireLoadDataNotEmpty){var r=true;for(var n in i)if(i.hasOwnProperty(n)){r=false;break}if(r)throw Error("TYPE_LOAD transaction result contains no data")}if(this.requireLoadDataHasKey){if(this.extractKey(i)===undefined){throw Error("Data of TYPE_LOAD transaction result contains no key")}}}else if(e.getType()===Amm.Data.Transaction.TYPE_CREATE){if(this.requireCreateDataHasKey){if(this.extractKey(i)===undefined){throw Error("Data of TYPE_CREATE transaction result contains no key")}}}e.unsubscribe("validateResult",this._validateTransactionResult,this)},_metaUpdating:0,_metaChanged:false,beginUpdateMeta:function(){this._metaUpdating++},endUpdateMeta:function(){if(!this._metaUpdating)throw Error("Cannot call endUpdateMeta() without prior call to beginUpdateMeta()");this._metaUpdating--;if(!this._metaUpdating&&this._metaChanged){this._metaChanged=false;this.outMetaChange(this._meta)}},_createMetas:function(t,e){var i={},r;for(r in t)if(t.hasOwnProperty(r)){i[r]=this._createMeta(t[r],r,true)}if(e)return i;this.beginUpdateMeta();this._meta={};for(r in i)if(i.hasOwnProperty(r)){this._assignMeta(i[r],r)}this.endUpdateMeta();return i},_createMeta:function(t,e,i){var r={};if(e!==undefined)r.name=e;r.mapper=this;var n=Amm.constructInstance(t,this.metaClass,r,true);e=n.getName();if(!i&&e)this._assignMeta(n,e);return n},_assignMeta:function(t,e){var i=this._meta[e];if(i===t)return;delete this._meta[e];if(i)i.setMapper(null);this._meta[e]=t;this.outMetaChange(this._meta,{},e,undefined,t,i)},setMeta:function(t,e,i){if(!e){this._createMetas(t);return true}if(!i){this._createMeta(t,e);return true}if(!(e in this._meta)){throw Error("Cannot set property of non-existent meta '"+e+"'")}this._meta[e].setProperty(t,i)},getMeta:function(t,e){if(!t)return Amm.override({},this._meta);if(!(t in this._meta))return undefined;if(!e)return this._meta[t];return this._meta[t][e]},notifyMetaChange:function(t,e,i,r,n){if(!e||i==="required"||i==="validators"){this._allFieldValidators=null}this.outMetaChange(t,null,e,i,r,n)},outMetaChange:function(t,e,i,r,n,s){if(this._metaUpdating){this._metaChanged=true;return}return this._out("metaChange",this._meta,null,i,r,n,s)},getRequiredValidator:function(){if(this._requiredValidator)return this._requiredValidator;var t=this.requiredValidatorPrototype||Amm.Data.Mapper.requiredValidatorPrototype;this._requiredValidator=Amm.constructInstance(Amm.override({},t),"Amm.Validator");return this._requiredValidator}};Amm.Data.Mapper.checkValidatorsHash=function(t,e){if(!t)return{};var i={},r;for(var n in t)if(t.hasOwnProperty(n)){r=t[n];if(!r)continue;if(!(r instanceof Array))r=[r];if(!r.length)continue;i[n]=Amm.Data.Mapper.checkValidatorsArray(r,e+"['"+n+"']")}return i};Amm.Data.Mapper.checkValidatorsArray=function(t,e){var i=[],r,n=t.length;for(r=0;r<n;r++){var s=t[r];if(typeof s==="function"){}else if(typeof s==="string"){if(Amm.getFunction(s,true))s=Amm.constructInstance(s,"Amm.Validator");else s=new Amm.Expression(s)}else if(s&&typeof s==="object"){if(s.class)s=Amm.constructInstance(s);Amm.meetsRequirements(s,["Amm.Expression","Amm.Validator"],e+"["+r+"]")}else{throw new Error("name["+r+"] must be a function, a string or a non-null object")}i.push(s)}return i};Amm.Data.Mapper.requiredValidatorPrototype={class:"Amm.Validator.Required"};Amm.extend(Amm.Data.Mapper,Amm.WithEvents);Amm.Data.HttpResponse=function(t){this.httpHeaders=[];Amm.init(this,t)};Amm.Data.HttpResponse.prototype={"Amm.Data.HttpResponse":"__CLASS__",isError:false,errorText:"",rawContent:null,parsedContent:null,httpHeaders:null,httpCode:null};Amm.Data.Object=function(t){if(!t)t={};this._old={};this._data={};this._propNames={};var e,i;if(!t.__mapper)throw Error("__mapper is required");if(t.__mapper["Amm.Data.Mapper"])e=t.__mapper;else e=Amm.Data.Mapper.get(t.__mapperId);this._mapper=e;var r=this._mapper.getObjectClass();if(r&&!Amm.is(this,r)){throw Error("Cannot use instance of "+Amm.getClass(this)+" with mapper "+e.getId()+"; required class is "+r)}t=Amm.override(this._mapper.getObjectPrototype(),t);delete t.__mapper;if(t.lm&&typeof t.lm==="object"){this._lm=new Amm.Data.LifecycleAndMeta(this,t.lm);delete t.lm}Amm.WithEvents.call(this,t,true);for(i in t)if(t.hasOwnProperty(i)){if(typeof t[i]==="function"){this[i]=t[i];delete t[i]}}var n=false;for(i in t)if(t.hasOwnProperty(i)){n=true;break}if(n)this.lm.hydrate(t)};Amm.Data.Object.prototype={"Amm.Data.Object":"__CLASS__",_mapper:null,_data:null,_old:null,_lm:null,_cu:false,_state:Amm.Data.STATE_NEW,_propNames:null,_preUpdateValues:null,_errors:null,_oldErrors:null,getLm:function(){if(!this._lm)this._lm=new Amm.Data.LifecycleAndMeta(this);return this._lm},setLm:function(){},outLmChange:function(){},_doOnActual:function(t){},_doBeforeLoad:function(t){},_doAfterLoad:function(){},_doOnCheck:function(){},_checkField:function(t,e){},_doBeforeDelete:function(){},_doAfterDelete:function(){},_doBeforeSave:function(){},_doAfterSave:function(){},_handleMissingEvent:function(t,e,i,r){if(t.match(/Change$/))return true},cleanup:function(){if(this._cu)return;this._cu=true;this.lm.cleanup();this._data={};this._old={};Amm.WithEvents.prototype.cleanup.call(this)}};Object.defineProperty(Amm.Data.Object.prototype,"lm",{get:function(){return this.getLm()}});Amm.extend(Amm.Data.Object,Amm.WithEvents);Amm.Data.Transaction=function(t){var e=false;var i;if(t&&"run"in t){i=Amm.override({},t);t=i;e=t.run;delete t.run}if(this["Amm.Data.Transaction"]==="__CLASS__"){throw Error("Attempt to instantiate abstract class: Amm.Data.Transaction")}Amm.WithEvents.call(this,t);if(e)this.run()};Amm.Data.Transaction.TYPE_CREATE="create";Amm.Data.Transaction.TYPE_LOAD="load";Amm.Data.Transaction.TYPE_UPDATE="update";Amm.Data.Transaction.TYPE_DELETE="delete";Amm.Data.Transaction.STATE_INIT="init";Amm.Data.Transaction.STATE_RUNNING="running";Amm.Data.Transaction.STATE_SUCCESS="success";Amm.Data.Transaction.STATE_FAILURE="failure";Amm.Data.Transaction.STATE_CANCELLED="cancelled";Amm.Data.Transaction.DEFAULT_REQUIREMENTS={};Amm.Data.Transaction.DEFAULT_REQUIREMENTS[Amm.Data.Transaction.TYPE_CREATE]={key:false,data:true};Amm.Data.Transaction.DEFAULT_REQUIREMENTS[Amm.Data.Transaction.TYPE_LOAD]={key:true,data:false};Amm.Data.Transaction.DEFAULT_REQUIREMENTS[Amm.Data.Transaction.TYPE_UPDATE]={key:true,data:true};Amm.Data.Transaction.DEFAULT_REQUIREMENTS[Amm.Data.Transaction.TYPE_DELETE]={key:true,data:false};Amm.Data.Transaction.prototype={"Amm.Data.Transaction":"__CLASS__",_type:null,_state:Amm.Data.Transaction.STATE_INIT,key:null,data:null,requirements:null,_unparsedResponseClass:null,setType:function(t){this._type=t},getType:function(){return this._type},setState:function(t){var e=this._state;if(e===t)return;this._state=t;this.outStateChange(t,e);return true},getState:function(){return this._state},outStateChange:function(t,e){return this._out("stateChange",t,e)},setResult:function(e){if(!e||!e["Amm.Data.TransactionResult"])throw Error("`result` must be Amm.Data.TransactionResult");var t=this._result;if(t===e)return;if(this._result)throw new Error("can setResult only once");if(!e.getIsError()){try{this.outValidateResult(e,this)}catch(t){e.setException(t)}}e.makeImmutable();this._result=e;if(e.getIsError())this.setState(Amm.Data.Transaction.STATE_FAILURE);else this.setState(Amm.Data.Transaction.STATE_SUCCESS);this.outResultChange(e,t)},getResult:function(){return this._result},outValidateResult:function(t,e){return this._out("validateResult",t,e)},outResultChange:function(t,e){return this._out("resultChange",t,e)},_setException:function(t,e){var i={exception:t};if(e)Amm.override(i,e);this.setResult(new Amm.Data.TransactionResult(i))},validate:function(t){var e;if(this.requirements){e=Amm.override({},this.requirements,Amm.Data.Transaction.DEFAULT_REQUIREMENTS)}else{e=Amm.Data.Transaction.DEFAULT_REQUIREMENTS}if(!e[this._type])return;for(var i in e[this._type])if(e[this._type].hasOwnProperty(i)){var r=!!e[this._type][i];var n=this[i]!==undefined&&this[i]!==null;if(r!==n){if(!t)return false;throw Error("Transaction doesn't meet requirements for type '"+this._type+"': property '"+i+"' is "+(n?"non-empty":"empty")+" while it should be "+(r?"non-empty":"empty"))}}return true},run:function(){if(this._state!==Amm.Data.Transaction.STATE_INIT){throw Error("Can run() only from Amm.Data.Transaction.STATE_INIT")}try{this.validate(true);var t={handled:false};this.outRun(t);if(!t.handled)this._runDefault();if(this._state===Amm.Data.Transaction.STATE_INIT){this.setState(Amm.Data.Transaction.STATE_RUNNING)}}catch(t){console.warn(t);this._setException(t)}},outRun:function(t){return this._out("run",t)},_runDefault:function(){throw Error("Call to abstract method")},_parseDefault:function(t){throw Error("Call to abstract method")},cancel:function(){if(this._state!==Amm.Data.Transaction.STATE_RUNNING){throw Error("Can cancel() only Transaction with STATE_RUNNING")}var t={handled:false};this.outCancel(t);if(!t){this._cancelDefault()}this.setState(Amm.Data.Transaction.STATE_CANCELLED)},outCancel:function(t){return this._out("cancel",t)},_cancelDefault:function(){throw Error("Call to abstract method")},setUnparsedResponse:function(t){if(!t||typeof t!=="object"){throw Error("`unparsedResponse` must be an object")}if(this._unparsedResponseClass){Amm.is(t,this._unparsedResponseClass,"unparsedResponse")}var e={transactionResult:null};try{var i=null;this.outParseResponse(t,e);if(!e.transactionResult)e.transactionResult=this._parseDefault(t);i=Amm.constructInstance(e.transactionResult,Amm.Data.TransactionResult);if(!i.getImmutable()){i.setUnparsedResponse(t)}this.setResult(i)}catch(t){if(!this._result)this._setException(t);else throw t}},outParseResponse:function(t,e){return this._out(t,e)},cleanup:function(){if(this._state===Amm.Data.Transaction.STATE_RUNNING)this.cancel();Amm.WithEvents.prototype.cleanup.call(this)}};Amm.extend(Amm.Data.Transaction,Amm.WithEvents);Amm.Data.TransactionResult=function(t){Amm.init(this,t)};Amm.Data.TransactionResult.ERROR_TYPE_NONE=null;Amm.Data.TransactionResult.ERROR_TYPE_CLIENT="client";Amm.Data.TransactionResult.ERROR_TYPE_HTTP="http";Amm.Data.TransactionResult.ERROR_TYPE_SERVER="server";Amm.Data.TransactionResult._revErrorType={client:"CLIENT",http:"HTTP",server:"SERVER"};Amm.Data.TransactionResult.prototype={"Amm.Data.TransactionResult":"__CLASS__",_unparsedResponse:null,_errorType:null,_data:null,_errorData:null,_exception:null,_error:null,_immutable:false,setUnparsedResponse:function(t){if(!t)t=null;if(typeof t!=="object")throw Error("`unparsedResponse` must be an object");var e=this._unparsedResponse;if(e===t)return;this._checkMutability();this._unparsedResponse=t;return true},getUnparsedResponse:function(){return this._unparsedResponse},_checkMutability:function(){if(this._immutable){throw Error("Cannot change property of immutable TransactionResult")}},setErrorType:function(t){if(!t)t=null;if(t&&!(t in Amm.Data.TransactionResult._revErrorType)){throw Error("`errorType` must be one of Amm.Data.TransactionResult.ERROR_TYPE_ constants")}var e=this._errorType;if(e===t)return;this._checkMutability();this._errorType=t;if(!this._errorType&&this._error){this.setError(null)}else if(this._errorType&&!this._error){this.setError({})}return true},getErrorType:function(){return this._errorType},setData:function(t){var e=this._data;if(e===t)return;this._checkMutability();this._data=t;return true},getData:function(){return this._data},setErrorData:function(t){var e=this._errorData;if(e===t)return;this._checkMutability();this._errorData=t;return true},getErrorData:function(){return this._errorData},setException:function(t){var e=this._exception;if(e===t)return;this._checkMutability();this._exception=t;if(!this._errorType)this.setErrorType("client");return true},getException:function(){return this._exception},setError:function(t){var e=this._error;if(e===t)return;this._checkMutability();this._error=t;return true},getError:function(){return this._error},getIsError:function(){return!!this._errorType},getIsSuccess:function(){return!this._errorType},makeImmutable:function(){this._immutable=true},getImmutable:function(){return this._immutable}};Amm.Data.Interface=function(){};Amm.Data.Interface.prototype={_uri:null,_key:null,actionCreate:function(t){},actionLoad:function(t){},actionUpdate:function(t,e){},actionDelete:function(t){}};Amm.Data.HttpTransaction=function(t){Amm.Data.Transaction.call(this,t)};Amm.Data.HttpTransaction.DEFAULT_METHOD_MAP={load:"GET","":"POST"};Amm.Data.HttpTransaction.prototype={"Amm.Data.HttpTransaction":"__CLASS__",_requestProducer:null,uri:null,uriOverrides:null,dataOverrides:null,method:null,methodMap:null,typePath:null,typeToUri:true,typeDecorator:null,keyPath:"id",keyToUri:true,dataPath:null,dataToUri:false,responseErrorPath:"error",responseErrorDataPath:"errorData",responseDataPath:"data",responseSuccessPath:null,softErrorCodes:null,_unparsedResponseClass:"Amm.Data.HttpResponse",_transport:new Amm.Remote.Transport.JqXhr,_responseDecorator:null,_runningRequest:null,setTransport:function(t){this._transport=Amm.constructInstance(t,"Amm.Remote.Transport")},getTransport:function(){return this._transport},createRequestProducer:function(){var t={prototype:null},e;this.outRequestProducerPrototype(t,this);if(t.prototype){e=t.prototype}if(!e)e=this.createDefaultRequestProducer();return Amm.constructInstance(e,"Amm.Remote.RequestProducer")},createDefaultRequestProducer:function(){var t=new Amm.Remote.RequestProducer({uri:this.uri,uriOverrides:this.uriOverrides,dataOverrides:this.dataOverrides});if(this.data){var e=Amm.overrideRecursive({},this.data);if(!this.dataPath)t.setDataOverrides(this.data);else{t.setData(e,this.dataPath)}}var i=Amm.Decorator.d(this._type,this,"typeDecorator");if(i){if(this.typeToUri){if(this.typePath===""){t.setUri(t.getUri().replace(/\/$/g,"")+"/"+i)}else if(this.typePath){t.setUri(i,this.typePath)}}else if(this.typePath){t.setData(i,this.typePath)}}if(this.key!==null){if(this.keyToUri){if(!this.keyPath)t.setUri(t.getUri().replace(/\/$/g,"")+"/"+this.key);else{t.setUri(this.key,this.keyPath)}}else{t.setData(this.key,this.keyPath)}}t.setMethod(this.getAppliedMethod());return t},getAppliedMethod:function(){var t=this.methodMap||Amm.Data.HttpTransaction.DEFAULT_METHOD_MAP;var e=t[this._type]||t[""];return e},_runDefault:function(){var t=this.createRequestProducer();var e=t.produceRequest();this._runningRequest=this.getTransport().makeRequest(e,this._handleSuccess,this._handleFailure,this)},_handleSuccess:function(t,e,i){if(this._state!==Amm.Data.Transaction.STATE_RUNNING)return;var r={},n=200,s="";if(typeof i==="object"){if(typeof i.getAllResponseHeaders==="function"){r=Amm.Remote.Transport.JqXhr.parseResponseHeaders(i.getAllResponseHeaders())}if("statusCode"in i)n=i.statusCode;if("responseText"in i)s=i.responseText;else if(typeof t==="string")s=t}this.setUnparsedResponse(new Amm.Data.HttpResponse({rawContent:s,parsedContent:t,httpHeaders:r,httpCode:n}))},_handleFailure:function(t,e,i,r){if(this._state!==Amm.Data.Transaction.STATE_RUNNING)return;var n={},s=i,a="";if(typeof r==="object"){if(typeof r.getAllResponseHeaders==="function"){n=Amm.Remote.Transport.JqXhr.parseResponseHeaders(r.getAllResponseHeaders())}if("statusCode"in r)s=r.statusCode;if("responseText"in r)a=r.responseText}this.setUnparsedResponse(new Amm.Data.HttpResponse({isError:true,errorText:e,rawContent:a,parsedContent:null,httpHeaders:n,httpCode:s}))},outRequestProducerPrototype:function(t,e){return this._out("requestProducerPrototype",t,e)},_parseDefault:function(t){var e;if(this._responseDecorator){e=this._applyDataDecorator(t);if(e)return e}e={};var i=null;if(t.isError&&!t.httpCode){return{errorType:Amm.Data.TransactionResult.ERROR_TYPE_CLIENT,error:t.errorText}}else if(t.isError){if(this.softErrorCodes instanceof Array){if(Amm.Array.indexOf(t.httpCode,this.softErrorCodes)>=0)i=t.errorText}else if(this.softErrorCodes&&this.softErrorCodes[t.httpCode]){i=this.softErrorCodes[t.httpCode]}if(i){e.errorType=Amm.Data.TransactionResult.ERROR_TYPE_SERVER;e.error=i}else{e.errorType=Amm.Data.TransactionResult.ERROR_TYPE_HTTP;e.error=t.errorText;return e}}var r=false;var n=t.parsedContent&&typeof t.parsedContent==="object";if(!n){if(i)return e;if(this.responseDataPath||this.responseSuccessPath)throw Error("Cannot parse the response");return e}if(i){if(this.responseErrorDataPath){e.errorData=Amm.Util.getByPath(t.parsedContent,this.responseErrorDataPath)}return e}if(this.responseSuccessPath){r=!Amm.Util.getByPath(t.parsedContent,this.responseSuccessPath)}else if(this.responseErrorPath){r=Amm.Util.getByPath(t.parsedContent,this.responseErrorPath);if(r!==undefined)e.error=r}if(this.responseErrorDataPath&&(r||this.responseErrorDataPath!==this.responseDataPath)){e.errorData=Amm.Util.getByPath(t.parsedContent,this.responseErrorDataPath,null)}if(e.errorData||r){e.errorType=Amm.Data.TransactionResult.ERROR_TYPE_SERVER}if(!e.errorType||this.responseErrorDataPath!==this.responseDataPath){if(this.responseDataPath!==null){e.data=Amm.Util.getByPath(t.parsedContent,this.responseDataPath,null)}else{e.data=t.parsedContent}}return e},_applyDataDecorator:function(t){var e=this._responseDecorator.decorate(t);if(e&&typeof e==="object"){return Amm.constructInstance(e,"Amm.Data.TransactionResult")}},_cancelDefault:function(){if(!this._runningRequest){throw Error("Assertion: _runningRequest during _cancelDefault()")}this.getTransport().abortRunningRequest(this._runningRequest)},setResponseDecorator:function(t){if(!t){this._responseDecorator=null;return}this._responseDecorator=Amm.constructInstance(t,"Amm.Decorator.Data")}};Amm.extend(Amm.Data.HttpTransaction,Amm.Data.Transaction);Amm.Data.LifecycleAndMeta=function(t,e){this._o=t;this._mapper=t._mapper;this._mapper.subscribe("metaChange",this._handleMapperMetaChange,this);Object.defineProperty(this,"o",{value:t,writable:false});Amm.WithEvents.call(this,e)};Amm.Data.LifecycleAndMeta.prototype={"Amm.Data.LifecycleAndMeta":"__CLASS__",_o:null,_mapper:null,_updateLevel:0,_modified:null,_transaction:null,_lastTransaction:null,_oldState:null,_checked:false,_cu:false,_propertiesChanged:false,_autoCheck:Amm.Data.AUTO_CHECK_SMART,_validWhenHydrated:true,getObject:function(){return this._o},getO:function(){return this._o},hydrate:function(t,e,i){this.beginUpdate();if(!e){this.o._old={};this.o._data={}}for(var r in t)if(t.hasOwnProperty(r)){this.o._old[r]=t[r];this.o._data[r]=t[r];if(!this.o._propNames[r])this._createProperty(r)}if(this.getKey()){this.setState(Amm.Data.STATE_EXISTS);if(!i)this.o._doOnActual(false)}else{this.setState(Amm.Data.STATE_NEW)}this.outHydrate();this.endUpdate()},outHydrate:function(){return this._out("hydrate")},listDataFields:function(){return Amm.keys(this.o._data)},getData:function(){return Amm.override({},this.o._data)},beginUpdate:function(){this._updateLevel++;if(this._updateLevel>1)return;this.o._preUpdateValues=this.getData()},endUpdate:function(){if(!this._updateLevel)throw Error("Call to endUpdate() without corresponding beginUpdate(); check with getUpdateLevel() first");this._updateLevel--;if(this._updateLevel)return;var t=this.o._preUpdateValues;var e=this.o._data,i,r;for(var n in t)if(t.hasOwnProperty(n)){i=t[n];r=e[n];delete t[n];if(r!==i)this._reportFieldChange(n,r,i,true);if(this.o._updateLevel)break}if(this._oldState!==null){if(this._oldState!==this._o.state){var s=this._oldState;this._oldState=null;this.outStateChange(this._o._state,this._oldState)}}this._checkModified();if(this._propertiesChanged){this._propertiesChanged=false;this.outPropertiesChanged()}if(this._o._oldErrors!==null){this._endUpdateErrors()}},getUpdateLevel:function(){return this._updateLevel},_checkFieldModified:function(t){var e=false;if(t in this.o._data){if(!(t in this.o._old)||this.o._old[t]!==this.o._data[t])e=true}if(e!==this._modified)this._checkModified()},_checkModified:function(){var t=false;for(var e in this.o._data)if(this.o._data.hasOwnProperty(e)){if(!(e in this.o._old)||this.o._old[e]!==this.o._data[e]){t=true;break}}this.setModified(t)},_reportFieldChange:function(t,e,i,r){if(this._updateLevel)return;var n=this.o._propNames[t];var s="out"+n.charAt(0).toUpperCase()+n.slice(1)+"Change";this._correctCheckStatus(t,e||i);this.o[s](e,i);if(!r){this._checkFieldModified(t)}},setModified:function(t){var e=this._modified;if(e===t)return;this._modified=t;this.outModifiedChange(t,e);if(!this._modified)this._checkHydratedAndValid(true);return true},getModified:function(t){if(t){return this._o._old[t]!==this._o._data[t]}return this._modified},getOldValue:function(t){return this._o._old[t]},outModifiedChange:function(t,e){this._out("modifiedChange",t,e)},revert:function(){this.beginUpdate();this._o._data=Amm.override({},this._o._old);this.endUpdate()},isSpecial:function(t){return t in this.constructor.prototype},getFieldValue:function(t){return this.o._data[t]},setFieldValue:function(t,e){var i=this.o._data[t];if(i===e)return;this.o._data[t]=e;if(this._updateLevel)return;this._reportFieldChange(t,e,i)},_createProperty:function(e){if(e in this.o._propNames)throw Error("Amm.Data.Object already has property for field '"+e+"'");var t=e,i="";while(this.isSpecial(t)){t=e+"Field"+i;i=(i||1)+1}this.o._propNames[e]=t;var r=t.slice(1);var n=t.charAt(0).toUpperCase()+r;var s=t.charAt(0).toLowerCase()+r;var a=s+"Change";var o="out"+n+"Change";var l="set"+n;var h="get"+n;if(!(h in this.o)){this.o[h]=function(){return this._data[e]}}if(!(l in this.o)){this.o[l]=function(t){return this.lm.setFieldValue(e,t)}}if(!(o in this.o)){this.o[o]=function(t,e){if(this._updateLevel)return;return this._out(a,t,e)}}Object.defineProperty(this.o,t,{enumerable:true,get:this.o[h],set:this.o[l]});if(!(e in this._o._preUpdateValues)){this._o._preUpdateValues[e]=undefined}if(!this._updateLevel)this.outPropertiesChanged();else this._propertiesChanged=true;return t},outPropertiesChanged:function(){return this._out("propertiesChanged")},getState:function(){return this.o._state},setState:function(t){var e=this._o._state;if(e===t)return;if(!Amm.Data.StateEnum[t])throw Error("`state` must be one of Amm.Data.STATE_ values; given: '"+t+"'");this._o._state=t;if(!this._updateLevel){this.outStateChange(t,e);return}if(this._oldState===null){this._oldState=e}},outStateChange:function(t,e){return this._out("stateChange",t,e)},getKey:function(){var t=this._mapper.extractKey(this.o._old);if(t===undefined)t=this._mapper.extractKey(this.o._data);return t},_hasLocalErrors:function(){if(this._o._errors.local){for(var t in this._o._errors.local){if(this._o._errors.local.hasOwnProperty(t))return true}}return false},check:function(t){if(this._checked&&!t)return!this._hasLocalErrors();if(this._checkHydratedAndValid(true))return true;this._beginUpdateErrors();this._o._errors.local={};this._coreCheckFields();this._coreCheckWhole();this._o._doOnCheck();this._checked=true;this._endUpdateErrors();return!this._hasLocalErrors()},_coreCheckFields:function(t){var e=this._mapper.getFieldValidators(true);var i=this._o._checkField!==Amm.Data.Object.prototype._checkField;if(!i&&!(e&&(!t||e[t])))return;var r;if(t){if(!this._o._propNames[t])throw Error("No such field: '"+t+"'");r={};r[t]=this._o._propNames[t]}else{r=this._o._propNames}var n,s,a,o,l,h;for(s in r)if(r.hasOwnProperty(s)){l=this._o._data[s];if(i){n=this._o._checkField(s,l);if(n===false)n=Amm.translate("lang.Amm.LifecycleAndMeta.invalidFieldValue");if(n){this.addError(n,s)}}if(!e||!(s in e))continue;h=e[s];if(!(h instanceof Array))h=[h];var u=this._mapper.getMeta(s,"label")||s;for(var a=0,o=h.length;a<o;a++){if(typeof h[a]==="function"){n=h[a](l,u)}else if(typeof h[a].getError==="function"){n=h[a].getError(l,u)}if(n){n=n.replace(/%field/g,u);this.addError(n,s);break}}if(!n)delete this._o._errors.local[s]}},_coreCheckWhole:function(){var t=this._mapper.getCommonValidators();if(!t)return;for(var e in t)if(t.hasOwnProperty(e)){var i=t[e];var r;for(var n=0,s=i.length;n<s;n++){var a=i[n];if(a["Amm.Expression"]){if(!a.__func)a.__func=a.toFunction();a.__func.env.expressionThis=this._o;r=a.__func()}else if(a["Amm.Validator"]){r=a.getError(this)}else if(typeof a==="function"){r=a.call(this._o)}else{throw Error("commonValidators['"+e+"'] must be either a function, an Amm.Expression or an Amm.Validator; provided: "+Amm.describeType(t[e]))}if(r===false)r=Amm.translate(e);if(r){this.addError(r,e);continue}}}},setChecked:function(t){var e=this._checked;if(e===t)return;this._checked=t;this.outCheckedChange(t,e);return true},getChecked:function(){return this._checked},outCheckedChange:function(t,e){this._out("checkedChange",t,e)},setAutoCheck:function(t){if(typeof t==="boolean")t=t+0;else if(typeof t==="string")t=parseInt(t);if(t!==Amm.Data.AUTO_CHECK_NEVER&&t!==Amm.Data.AUTO_CHECK_ALWAYS&&t!==Amm.Data.AUTO_CHECK_SMART){throw Error("Invalid autoCheck value; must be one of Amm.Data.AUTO_CHECK_ constants")}var e=this._autoCheck;if(e===t)return;this._autoCheck=t;if(t)this._instaCheck();return true},getAutoCheck:function(){return this._autoCheck},setValidWhenHydrated:function(t){var e=this._validWhenHydrated;if(e===t)return;this._validWhenHydrated=t;if(t)this._checkHydratedAndValid(true);else if(this.getState()===Amm.Data.STATE_EXISTS&&!this._modifierd){if(this._autoCheck===Amm.Data.AUTO_CHECK_ALWAYS){this._instaCheck(true)}else{this.setChecked(false)}}return true},getValidWhenHydrated:function(){return this._validWhenHydrated},_checkHydratedAndValid:function(t){if(!this._validWhenHydrated)return;if(this._modified||this.getState()!==Amm.Data.STATE_EXISTS)return;if(t)this.setLocalErrors({});return true},_correctCheckStatus:function(t,e){if(this._autoCheck===Amm.Data.AUTO_CHECK_SMART&&e){this._beginUpdateErrors();this.setChecked(false);this._coreCheckFields(t);this._endUpdateErrors()}else if(this._autoCheck===Amm.Data.AUTO_CHECK_ALWAYS){this._instaCheck(true)}else{this.setChecked(false)}},_instaCheck:function(t){if(this._checked&&!t)return;if(!this._autoCheck)return;if(t)this._checked=false;if(!this._subscribers.localErrorsChange&&!this._subscribers.errorsChange)return;if(this._autoCheck===Amm.Data.AUTO_CHECK_ALWAYS){this.check();return}},_beginUpdateErrors:function(){if(!this._subscribers.localErrorsChange&&!this._subscribers.remoteErrorsChange&&!this._subscribers.errorsChange){this._o._oldErrors=false}if(!this._o._errors)this._o._errors={local:{},remote:{}};this._combineErrors();if(!this._o._oldErrors)this._o._oldErrors={local:JSON.stringify(this._o._errors.local),remote:JSON.stringify(this._o._errors.remote),all:JSON.stringify(this._o._errors.all)}},_subscribeFirst_localErrorsChange:function(){if(this._o._oldErrors===false)this._beginUpdateErrors()},_subscribeFirst_remoteErrorsChange:function(){return this._subscribeFirst_localErrorsChange()},_subscribeFirst_errorsChange:function(){return this._subscribeFirst_localErrorsChange()},_endUpdateErrors:function(){this._o._errors.all=null;if(this._updateLevel)return;if(!this._o._oldErrors)return;if(!this._o._errors)if(!this._o._errors)this._o._errors={local:{},remote:{}};else{if(!this._o._errors.local)this._o._errors.local={};if(!this._o._errors.remote)this._o._errors.remote={}}var t=this._o._oldErrors;this._o._oldErrors=null;if(!this._subscribers.localErrorsChange&&!this._subscribers.remoteErrorsChange&&!this._subscribers.errorsChange){return}var e=t.local!==JSON.stringify(this._o._errors.local);var i=t.remote!==JSON.stringify(this._o._errors.remote);if(!e&&!i){return}var r=e&&this._subscribers.localErrorsChange;var n=i&&this._subscribers.remoteErrorsChange;var s=this._subscribers.errorsChange;if(r)this.outLocalErrorsChange(this._o._errors.local,JSON.parse(t.local));if(n)this.outRemoteErrorsChange(this._o._errors.remote,JSON.parse(t.remote));if(s)this.outErrorsChange(this.getErrors(),JSON.parse(t.all))},getLocalErrors:function(t){if(this._autoCheck&&this._modified&&!this._checked)this.check();return this._getErrors("local",t)},_getErrors:function(t,e){if(!this._o._errors[t]||e&&e!==Amm.Data.ERROR_OTHER&&!this._o._errors[t][e])return null;if(!e)return this._o._errors[t];if(e===Amm.Data.ERROR_OTHER)return this._getOtherErrors(this._o._errors[t]);return this._o._errors[t][e]},_setErrors:function(t,e,i){this._beginUpdateErrors();if(i){this._o._errors[t][i]=this._flattenErrors(e);if(!this._o._errors[t][i].length)delete this._o._errors[t][i];this._endUpdateErrors();return}if(!e)e={};else if(typeof e!=="object"||e instanceof Array){e[Amm.Data.ERROR_GENERIC]=this._flattenErrors(e);if(!e[Amm.Data.ERROR_GENERIC]||!e[Amm.Data.ERROR_GENERIC].length){delete e[Amm.Data.ERROR_GENERIC]}}var r,n,s={};for(var r in e)if(e.hasOwnProperty(r)){n=this._flattenErrors(e[r]);if(!n.length)continue;s[r]=n}this._o._errors[t]=s;this._endUpdateErrors()},setLocalErrors:function(t,e){this._setErrors("local",t,e)},addError:function(t,e){if(!t||t instanceof Array&&!t.length)return;this._beginUpdateErrors();if(!e||e===Amm.Data.ERROR_OTHER)e=Amm.Data.ERROR_GENERIC;var i={};i[e]=this._flattenErrors(t);Amm.override(this._o._errors.local,i,false,true);this._endUpdateErrors()},outLocalErrorsChange:function(t,e){return this._out("localErrorsChange",t,e)},getRemoteErrors:function(t){return this._getErrors("remote",t)},setRemoteErrors:function(t,e){this._setErrors("remote",t,e)},outRemoteErrorsChange:function(t,e){return this._out("remoteErrorsChange",t,e)},_flattenErrors:function(t){return Amm.Data.flattenErrors(t)},_getOtherErrors:function(t){var e,i;for(var r in t)if(t.hasOwnProperty(r)&&!(r in this._o._propNames)){e[r]=t[r]}return this._flattenErrors(e)},_combineErrors:function(){this._o._errors.all={};if(this._o._errors.local)Amm.overrideRecursive(this._o._errors.all,this._o._errors.local);if(this._o._errors.remote)Amm.overrideRecursive(this._o._errors.all,this._o._errors.remote,false,true)},getErrors:function(t){if(this._autoCheck&&this._modified&&!this._checked)this.check();if(!this._o._errors)return null;if(!this._o._errors.all){this._combineErrors()}return this._getErrors("all",t)},outErrorsChange:function(t,e){return this._out("errorsChange",t,e)},setErrors:function(){console.warn("setErrors has no effect; use either setLocalErrors() or setRemoteErrors()")},_setTransaction:function(t){if(t)Amm.is(t,"Amm.Data.Transaction");else t=null;var e=this._transaction;if(e===t)return;if(e)e.unsubscribe(undefined,undefined,this);if(t)t.subscribe("stateChange",this._notifyTransactionStateChange,this);this._transaction=t;this.outTransactionChange(t,e);if(e)this._setLastTransaction(e);return true},getTransaction:function(){return this._transaction},outTransactionChange:function(t,e){this._out("transactionChange",t,e)},_notifyTransactionStateChange:function(t,e){if(!this._transaction||Amm.event.origin!==this._transaction)return;if(t===Amm.Data.Transaction.STATE_RUNNING){return}if(t===Amm.Data.Transaction.STATE_CANCELLED){this._setTransaction(null);return}if(this._handleTransactionFinished(t)){this._setTransaction(null)}},_handleTransactionFinished:function(t){if(t===Amm.Data.Transaction.STATE_CANCELLED)return true;var e=t===Amm.Data.Transaction.STATE_FAILURE;if(e){this._handleGenericTransactionFailure();return true}var i=t===Amm.Data.Transaction.STATE_SUCCESS;if(!i)return;var r=this._transaction.getType()+"";var n="_handle"+r[0].toUpperCase()+r.slice(1)+"Success";if(typeof this[n]==="function"){this[n]()}return true},_hydrateFromTransactionDataAndTrigger:function(t,e,i){var r=this._transaction.getResult();var n=this.o._state===Amm.Data.STATE_NEW;this.beginUpdate();this.setRemoteErrors({});var s=r.getData();if(s)this.hydrate(s,i,true);if(e)this.setState(e);if(t){this._o._doAfterSave(n)}else{this._o._doAfterLoad()}this._o._doOnActual(t);this.endUpdate()},_handleGenericTransactionFailure:function(){var t=this._transaction.getResult();var e=t.getErrorData(),i,r=t.getError(),n=t.getException();if(!e)e={};else if(typeof e!=="object"){i={};i[Amm.Data.ERROR_GENERIC]=[e];e=i}var s;if(r){if(e[Amm.Data.ERROR_GENERIC]){e[Amm.Data.ERROR_GENERIC].push(r)}else{e[Amm.Data.ERROR_GENERIC]=[r]}}if(n){e[Amm.Data.ERROR_EXCEPTION]=""+n}this.setRemoteErrors(e);this.outTransactionFailure(this._transaction)},outTransactionFailure:function(t){return this._out("transactionFailure",t)},_handleCreateSuccess:function(){this._hydrateFromTransactionDataAndTrigger(true,Amm.Data.STATE_EXISTS,this._mapper.partialHydrateOnCreate)},_handleDeleteSuccess:function(){this.setState(Amm.Data.STATE_DELETED);this.setRemoteErrors({});this._o._doAfterDelete()},_handleUpdateSuccess:function(){this._hydrateFromTransactionDataAndTrigger(true,undefined,this._mapper.partialHydrateOnUpdate)},_handleLoadSuccess:function(){this.beginUpdate();this._hydrateFromTransactionDataAndTrigger(false,Amm.Data.STATE_EXISTS);this.endUpdate()},_setLastTransaction:function(t){if(t)Amm.is(t,"Amm.Data.Transaction");else t=null;var e=this._lastTransaction;if(e===t)return;this._lastTransaction=t;this.outLastTransactionChange(t,e);return true},getLastTransaction:function(){return this._lastTransaction},outLastTransactionChange:function(t,e){this._out("lastTransactionChange",t,e)},_getTransactionData:function(){return Amm.override({},this._o._data)},_runTransaction:function(t){this._setTransaction(t);t.run();if(t.getState()===Amm.Data.Transaction.STATE_FAILURE){var e=t.getResult().getException();if(e)throw e}},save:function(t){if(!t&&!this.check())return;if(this._o._doBeforeSave()===false)return;var e=this._getTransactionData(),i,r=this.getState();if(r===Amm.Data.STATE_NEW){i=this._mapper.createTransaction(Amm.Data.Transaction.TYPE_CREATE,null,e)}else if(r===Amm.Data.STATE_EXISTS){i=this._mapper.createTransaction(Amm.Data.Transaction.TYPE_UPDATE,this.getKey(),e)}else{throw Error("Cannot save an object with state '"+r+"'")}this._runTransaction(i);return true},delete:function(){var t,e=this.getState(),i;if(e!==Amm.Data.STATE_EXISTS){this.setState(Amm.Data.STATE_DELETED);return true}if(this._o._doBeforeDelete()===false)return false;i=this.getKey();t=this._mapper.createTransaction(Amm.Data.Transaction.TYPE_DELETE,this.getKey());this._runTransaction(t);return true},load:function(t){var e=this._o._doBeforeLoad(t);if(e===false)return false;if(e!==undefined)t=e;if(t===undefined)t=this.getKey();if(!t)throw new Error("Cannot load(): key not provided");var i;i=this._mapper.createTransaction(Amm.Data.Transaction.TYPE_LOAD,t);this._runTransaction(i);return true},_handleMapperMetaChange:function(t,e,i,r,n,s){if(r&&r!=="required"&&r!=="label"&&r!=="validators")return;var a=i&&this._o._data[i]||this._o._old[i];var o=a||r==="required"&&!n;this._correctCheckStatus(i,o)},cleanup:function(){if(this._cu)return;this._cu=true;if(this._transaction){this._transaction.cleanup();this._transaction=null}if(this._lastTransaction){this._lastTransaction.cleanup();this._lastTransaction=null}if(this._mapper)this._mapper.unsubscribe(undefined,undefined,this);this._o.cleanup();Amm.WithEvents.prototype.cleanup.call(this)},getMapper:function(){return this._mapper},setMapper:function(){},outMapperChange:function(){}};Amm.extend(Amm.Data.LifecycleAndMeta,Amm.WithEvents);Amm.defineLangStrings({"lang.Amm.LifecycleAndMeta.invalidFieldValue":"The field contains invalid value"});Amm.Data.Meta=function(t){this._validators=[];var e=Amm.override(t||{});if("mapper"in e){this.setMapper(e.mapper);delete e.mapper}this._i=true;Amm.init(this,e);this._i=false;this._notify()};Amm.Data.Meta._afterPropChange=function(t,e,i){this._notify(t,e,i)};Amm.Data.Meta.prototype={"Amm.Data.Meta":"__CLASS__",_i:null,_mapper:null,_required:null,_validators:null,_requiredValidator:null,_label:null,_description:null,_name:null,_notify:function(t,e,i){if(this._mapper&&this._name){this._mapper.notifyMetaChange(this,this._name,i,t,e)}},setName:function(t){var e=this._name;if(e===t)return;if(this._name!==null)throw Error("Can setName() only once");this._name=t;this._notify(t,e,"name");return true},getName:function(){return this._name},setMapper:function(t){if(t===this._mapper)return;if(t){if(this._mapper)throw Error("Can setMapper() only once");Amm.is(t,Amm.Data.Mapper,"mapper")}else{t=null}this._mapper=t},getMapper:function(){return this.mapper},setValidators:function(t){if(this._validators===t)return;var e=this._validators;if(!(t instanceof Array))t=t?[t]:[];var i=Amm.Data.Mapper.checkValidatorsArray(t,"validators");this._validators=i;this._notify(this._validators,e,"validators")},getValidators:function(){return[].concat(this._validators)},setProperty:function(t,e){if(e[0]==="_"){throw Error("Cannot set pseudo-private property")}if(!(e in this)){this.defineProperty(e)}this[e]=t},getProperty:function(t){if(t[0]==="_"){throw Error("Cannot return pseudo-private property")}if(t in this)return this[t]},defineProperty:function(t,e,i){Amm.createProperty(this,t,e,{before:i,after:Amm.Data.Meta._afterPropChange},true)}};Amm.createProperty(Amm.Data.Meta.prototype,"name",null,{before:function(t,e){if(e!==null){throw Error("Can setName() only once")}},after:Amm.Data.Meta._afterPropChange},true);Amm.createProperty(Amm.Data.Meta.prototype,"required",null,{before:function(t){return!!t},after:function(t,e,i){Amm.Data.Meta._afterPropChange.call(this,t,e,i)}},true);Amm.createProperty(Amm.Data.Meta.prototype,"label",null,Amm.Data.Meta._afterPropChange,true);Amm.createProperty(Amm.Data.Meta.prototype,"description",null,Amm.Data.Meta._afterPropChange,true);