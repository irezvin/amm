Amm={ID_SEPARATOR:"/",id:"amm",domHolderAttribute:"data-amm-iid",_counter:1,_functions:{},_namespaces:{},_bootstrapped:false,lang:{},optionsObjectId:"ammOptions",autoBuildSelector:"[data-amm-build]",defaultBuilderOptions:{topLevelComponent:"root"},_autoBuilder:null,_items:{},itemDebugInfo:{},itemDebugTag:[],_byPaths:{},_waitList:{},r:null,_root:null,_eventStack:[],event:{origin:null,name:"",args:[],parent:null},getRoot:function(){if(!this._root){this._root=new this.Root;this.r=this._root}return this._root},registerItem:function(e){if(e._amm_id)return;e._amm_id=this.id+"_"+this._counter++;this._items[e._amm_id]=e;if(this.itemDebugTag.length){this.itemDebugInfo[e._amm_id]=this.itemDebugTag[this.itemDebugTag.length-1]}return true},unregisterItem:function(e){if(!e._amm_id)return;if(typeof e==="string")e=this._items[e];if(e._amm_id&&this._items[e._amm_id]!==e){throw Error("Mismatch of _amm_id detected during the item de-registration")}if(typeof e.getPath==="function"){var t=e.getPath();if(t&&t[0]==="^"){delete this._byPaths[t]}}this.stopWaiting(undefined,undefined,e);delete this._items[e._amm_id];delete this.itemDebugInfo[e._amm_id];e._amm_id=null},getItem:function(e,t){if(e instanceof Array){var i=[];for(var r=0,n=e.length;r<n;r++){if(e[r]&&e[r].length){var s=this.getItem(e[r],t);if(s)i.push(s)}}return i}else{var o=this._items[e];if(!o&&t)throw Error("Item '"+e+"' not found");return o}},destroyItem:function(e){if(typeof e==="string")e=this._items[e];if(typeof e.cleanup==="function")e.cleanup();for(var t in this._items)if(this._items.hasOwnProperty(t)){if(typeof this._items[t].unsubscribe==="function")this._items[t].unsubscribe(undefined,undefined,e)}this.unregisterItem(e)},extend:function(e,t,i){if(typeof e!=="function"){throw Error("Amm.extend: `subClass` is not a function")}if(typeof t!=="function"){throw Error("Amm.extend: `parentClass` is not a function")}var r=false;if(typeof t.beforeExtend==="function"){r=t.beforeExtend(e,t,i)}if(!r){for(var n in t.prototype){if(!(n in e.prototype))e.prototype[n]=t.prototype[n];if(!i&&e.prototype[n]==="__CLASS__")e.prototype[n]="__PARENT__"}}if(typeof t.afterExtend==="function"){t.afterExtend(e,t,i)}},augment:function(e,t,i){var r=arguments.length;var n,s;if(typeof t==="string"){t=Amm.getFunction(t)}if(typeof e!=="object")throw Error("`instance` must be an object");if(typeof t==="function")n=new t;else if(typeof t==="object")n=t;else throw Error("`trait` must be an object or a function (constructor)");var o=this.getInterfaces(e,n);if(o.length)throw Error("Cannot augment: `instance` already implements same interfaces as the `traitInstance`: "+o.join(", ")+")");for(var a in n)if(a.slice(0,2)!=="__"){if(e[a]===undefined||typeof e[a]==="function")e[a]=n[a]}if(typeof n.__augment==="function"){n.__augment.call(e,n,i)}},override:function(e,t,i){for(var r=0,n=arguments.length;r<n;r++){for(var s in arguments[r]){if(arguments[r].hasOwnProperty(s))e[s]=arguments[r][s]}}return e},overrideRecursive:function(e,t,i){if(typeof e!=="object"||typeof t!=="object")throw Error("Both modifiedObject and overrider must be objects");for(var r in t)if(t.hasOwnProperty(r)){if(e[r]instanceof Array&&t[r]instanceof Array){e[r]=e[r].concat(t[r])}else if(typeof e[r]==="object"&&typeof t[r]==="object"){this.overrideRecursive(e[r],t[r],i)}else if(!i||!(r in e)){e[r]=t[r]}}return e},meetsRequirements:function(e,t,i){if(!(t instanceof Array))t=[[t]];for(var r=0,n=t.length;r<n;r++){var s=t[r],o=true;if(!(s instanceof Array))s=[s];for(var a=0,l=s.length;a<l;a++){var h=s[a],u=false,f;if(typeof h==="function")u=e instanceof h;else{f=e[h];u=f==="__CLASS__"||f==="__INTERFACE__"||f==="__PARENT__"||typeof f==="function"}if(!u){o=false;break}}if(o)return true}if(i){throw Error("["+Amm.describeType(e)+"] `"+i+"` "+"doesn't meet following requirement(s): "+Amm.describeRequirements(t))}return false},describeRequirements:function(e){var t=[];for(var i=0;i<e.length;i++){var r=e[i],n;if(!(r instanceof Array))r=[r];for(var s=0;s<r.length;s++){if(r[s][0].toLowerCase()===r[s][0]){r[s]+="()"}}if(r.length>1){n="( "+r.join(" & ")+" )"}else{n=r[0]}t.push(n)}return t.join(" || ")},getClass:function(e,t){var i;if(t)i=[];for(var r in e){if(e[r]==="__CLASS__"||t&&e[r]==="__PARENT__"){if(t)i.push(r);else return r}}if(!t)return null;else return i},getInterfaces:function(e,t){var i=[];for(var r in e){if(e[r]==="__INTERFACE__"){if(!t||t[r]){i.push(r)}}}return i},hasInterfaces:function(e,t,i){if(!t)return true;if(!(t instanceof Array))t=[t];for(var r=t.length-1;r>=0;r--){if(!e||e[t[r]]!=="__INTERFACE__"){if(i){var n=typeof i==="string"?i:"`item`";throw Error(n+=" must implement all following interfaces: "+t.join(",")+" but it doesn't implement interface "+t[r])}else{return false}}}return true},is:function(e,t,i){if(t instanceof Array){for(var r=0,n=r.length;r<n;r++)if(Amm.is(e,t[r]))return true;if(i){var s=typeof i==="string"?i:"`item`";throw Error(s+" must be an instance of "+t.join("|")+"; given: "+Amm.describeType(e))}return a}if(typeof t==="function"){if(e instanceof t)return true;var o=Amm.getClass(t.prototype);if(!o)return false;t=o}var a=e&&(e[t]==="__CLASS__"||e[t]==="__PARENT__"||e[t]==="__INTERFACE__");if(!a&&i){var s=typeof i==="string"?i:"`item`";throw Error(s+" must be an instance of "+t+"; given: "+Amm.describeType(e))}return a},getByPath:function(e){return this.p(e)},p:function(e){if(e[0]==="^"&&this._byPaths[e])return this._byPaths[e];return this.getRoot().getByPath(e)},waitFor:function(e,t,i,r){i=i||null;r=r||null;if(!this._waitList[e])this._waitList[e]=[];else{for(var n=this._waitList[e].length-1;n>=0;n--){if(this._waitList[e][n][0]===t&&this._waitList[e][n][1]===i&&this._waitList[e][n][2]===r)return false}}this._waitList[e].push([t,i,r])},notifyElementPathChanged:function(e,t,i){if(i&&i[0]==="^"&&this._byPaths[i]===e)delete this._byPaths[i];if(t&&t[0]==="^")this._byPaths[t]=e;if(!this._waitList[t])return;var r=this._waitList[t],n=r.length;delete this._waitList[t];for(var s=0;s<n;s++)r[s][0].call(r[s][1]||e,e,t,r[s][2])},stopWaiting:function(e,t,i,r){e=e||null;t=t||null;var n;if(e===null)n=this._waitList;else n={elementPath:true};for(var s in n)if(this._waitList.hasOwnProperty(s)){if(t===undefined&&i===undefined&&r===undefined){delete this._waitList[s]}else{var o=this._waitList[e];for(var a=o.length-1;a>=0;a--){if((t===undefined||o[a][0]===t)&&(i===undefined||o[a][1]===i)&&(r===undefined||o[a][2]===r)){o[s].splice(a,1)}}}}},init:function(e,t,i){if(!t)return;var r=null;if(i instanceof Array){for(var n=0,s=i.length;n<s;n++){if(i[n]in t){if(!r)r={};r[i[n]]=t[i[n]];delete t[i[n]]}}}else{r=t}if(!r)return;for(var o in r)if(r.hasOwnProperty(o)){if(o[0]==="_")throw Error("Use of pseudo-private identifiers is prohibited in `optToSet`, encountered: '"+o+"'");if(o in e&&typeof e[o]==="function"){if(typeof r[o]==="function")e[o]=r[o];else throw Error("Only function is allowed to override the function (`"+o+"` provided is "+typeof r[o]+")")}var a=r[o],l="set"+(""+o).slice(0,1).toUpperCase()+(""+o).slice(1);if(typeof e[l]==="function")e[l](a);else if(o in e)e[o]=a;else if(typeof a==="function")e[o]=a;else{throw Error("No such property: '"+o+"' in "+(this.getClass(e)||"`object`"))}}},getFunction:function(e){if(typeof e==="function")return e;if(typeof e!=="string"){throw Error("`strName` must be a string, given: "+this.describeType(e))}if(this._functions[e])return this._functions[e];var t=e.split("."),i=this._namespaces,r=[];while(t.length&&i){var n=t.splice(0,1)[0];r.push(n);i=i[n]}if(!i){if(t.length){throw Error("Unknown namespace '"+r.join(".")+"' (when trying to locate function '"+e+"')")}else throw Error("Unknown function '"+r.join(".")+"'")}return i},registerNamespace:function(e,t){if(typeof e!=="string")throw Error("`ns` must be a string");if(!t||typeof t!=="object"&&typeof t!=="function"){throw Error("Amm.registerNamespace: `hash` must be an object or a function")}this._namespaces[e]=t},registerFunction:function(e,t){if(typeof e!=="string")throw Error("`name` must be a string");if(!t||typeof t!=="function")throw Error("`fn` must be a function");this._functions[e]=t},pushEvent:function(e){var t=this.event;e.parent=t;this._eventStack.push(this.event);this.event=e},popEvent:function(){this.event=this._eventStack.pop()},detectProperty:function(e,t,i){var r=t[0].toUpperCase()+t.slice(1),n="get"+r,s="set"+r,o=t+"Change";if(typeof e[n]!=="function")n=null;if(typeof e[s]!=="function")s=null;if(typeof e.hasEvent!=="function"||!e.hasEvent(o))o=null;var a=o&&n&&s;if(i&&typeof i==="object"){i.getterName=n;i.setterName=s;i.eventName=o}return a},getProperty:function(e,t,i,r){var n;if(typeof e!=="object"||!e)return i;if(e instanceof Array){var s=[];for(var o=0;o<e.length;o++){s.push(this.getProperty(e[o],t,i))}return s}if(t instanceof Array){var s={};for(var o=0;o<t.length;o++){s[t[o]]=this.getProperty(e,t[o],i)}return s}var a=(""+t)[0].toUpperCase()+t.slice(1),l="get"+a;if(r!==undefined&&r!==null){if(!(r instanceof Array))r=[r]}if(typeof e[l]==="function"){n=r?e[l].apply(e,r):e[l]()}else if(t in e)n=e[t];else if(t==="class")n=Amm.getClass(e);else n=i;return n},setProperty:function(e,t,i,r,n){if(e instanceof Array){for(var s=0,o=e.length;s<o;s++){Amm.setProperty(e[s],t,i,r,n)}return}if(i===undefined&&t&&typeof t==="object"){var a={};for(var s in t){if(t.hasOwnProperty(s))a[s]=Amm.setProperty(e,s,t[s],r)}return a}var l=(""+t[0]).toUpperCase()+t.slice(1),h="set"+l;if(n!==undefined&&n!==null){if(!(n instanceof Array))n=[n];else n=[].concat(n);n.unshift(i)}if(typeof e[h]==="function"){a=n?e[h].apply(e,n):e[h](i)}else if(t in e)e[t]=i;else if(r)throw Error("No setter for property: `"+t+"`");return a},createProperty:function(e,t,i,r,n){if(!e||typeof e!=="object")throw Error("`target` must be an object");var s=t.slice(1),o=t[0].toUpperCase()+s,a=t[0].toLowerCase()+s,l="get"+o,h="set"+o,u="out"+o+"Change",f=a+"Change",c="_"+a;if(!(c in e))e[c]=i;if(!(l in e)){e[l]=function(){return this[c]}}if(!(h in e)){e[h]=function(e){var t=this[c];if(t===e)return;this[c]=e;if(r){r.call(this,e,t,c);if(this[c]!==t){this[u](this[c],t)}}else{this[u](e,t)}return true}}if(!(u in e)){e[u]=function(e,t){this._out(f,e,t)}}if(n){Object.defineProperty(e,a,{enumerable:true,get:e[l],set:e[h]})}},decorate:function(e,t,i){if(!t)return e;else if(typeof t==="function")return i?t.call(i,e):t(e);else if(typeof t==="object"||typeof t==="string"){if(!t.class&&typeof t.decorate==="function")return t.decorate(e,i);else{var r=Amm.Decorator.construct(t);return r.decorate(e)}}else{throw Error("`decorator` must be either function or an object with .decorate() method")}},cleanup:function(e,t){var i=false,r=0;if(typeof e==="boolean"){i=e[0];r=1}for(var n=r,s=arguments.length;n<s;n++){e=arguments[n];if(!e)continue;if(typeof e.cleanup==="function")e.cleanup();else if(e instanceof Array){for(var o=r,a=e.length;o<a;o++)this.cleanup(e[o])}else{if(!i)throw Error("`itemOrItems` must be either an object with .cleanup() method or an Array")}}},keys:function(e){var t=[];for(var i in e)if(e.hasOwnProperty(i))t.push(i);return t},values:function(e){var t=[];for(var i in e)if(e.hasOwnProperty(i))t.push(e[i]);return t},bootstrap:function(){if(!jQuery)throw Error("Amm.bootstrap: jQuery not found");var e=this;jQuery(function(){e._doBootstrap()})},getBootstrapped:function(){return this._bootstrapped},_doBootstrap:function(){if(this._bootstrapped)return;this._bootstrapped=true;if(this.optionsObjectId&&window[this.optionsObjectId]){var e=window[this.optionsObjectId];if(typeof e==="object")this.init(this,e)}this.registerNamespace("v",this.View.Html);this.registerNamespace("t",this.Trait);if(this.autoBuildSelector){var t=this.autoBuildSelector;this._autoBuilder=new this.Builder(t,this.defaultBuilderOptions);this._autoBuilder.build()}this.getRoot().raiseEvent("bootstrap")},constructInstance:function(e,t,i,r,n){var s;if(typeof e==="string"||typeof e==="function"){e={class:e}}else if(!e)e={};else if(typeof e!=="object")throw Error("`options` must be a string, an object, a function or FALSEable value");if(Amm.getClass(e)){s=e;if(r&&i&&typeof i==="object"){Amm.setProperty(s,i)}}else{e=Amm.override({},e);if(i){if(typeof i==="string")i={class:i};else if(typeof i!=="object")throw Error("`defaults` must be a string, an object or FALSEable value");for(var o in i)if(!(o in e)&&i.hasOwnProperty(o)){e[o]=i[o]}}var a=e["class"]||t;if(typeof e==="function")a=e;a=Amm.getFunction(a);if(!a)throw Error("Either options.class or baseClass are required");delete e["class"];s=new a(e)}if(t)Amm.is(s,t,"created instance");if(n&&!Amm.meetsRequirements(s,n)){throw Error("created instance doesn't meet specified requirements")}return s},constructMany:function(e,t,i,r,n,s){var o=[];var a;if(e instanceof Array){a=e}else if(e&&typeof e==="object"){a=[];for(var l in e)if(e.hasOwnProperty(l)){o.push(l);a.push(e[l])}}else{throw Error("`options` must be either Array or a hash")}var h=[];var u;if(i)u=r?Amm.override({},i):i;else u={};for(var l=0,f=a.length;l<f;l++){try{if(r&&u){if(o[l])u[r]=o[l];else if(r in i)u[r]=i[r];else delete u[r]}var c=new Amm.constructInstance(a[l],t,u,n,s);if(c===a[l]&&r&&o[l]&&!n){Amm.setProperty(c,r,o[l])}h.push(c)}catch(e){if(typeof e==="string")e=Error("item #'"+(o[l]||l)+"': "+e);else if(e instanceof Error){e.message="item #'"+(o[l]||l)+"': "+e.message}throw e}}return h},translate:function(e,t){var i=e;if(Amm.lang[i])i=Amm.lang[i];for(var r=1,n=arguments.length;r<n;r+=2){i=i.replace(new RegExp(Amm.Util.regexEscape(arguments[r]),"g"),arguments[r+1])}return i},defineLangStrings:function(e,t){for(var i in e)if(e.hasOwnProperty(i)){if(t||!(i in this.lang))this.lang[i]=e[i]}},describeType:function(e){var t=typeof e;if(t!=="object")return t;if(!e)return"null";var i=Amm.getClass(e);if(i)return i;if(e.constructor&&e.constructor.name)return e.constructor.name;return"object"},findElement:function(e){var t=Amm.DomHolder.find(e);if(t[0]&&t[0]["Amm.View.Abstract"])return t[0].getElement();return null},callMethods:function(e,t){var i=t instanceof RegExp,r,n={};for(var s in e){if(typeof e[s]==="function"&&(i?s.match(i):s.indexOf(t)===0)){r=r||Array.prototype.slice.call(arguments,2);n[s]=e[s].apply(e,r)}}return n},html:function(e,t,i,r){if(t===undefined)t=0;if(i===undefined)i=4;var n,s,o,a="",l="";for(s=0;s<t;s++)a+=" ";for(s=0;s<i;s++)l+=" ";if(!e||typeof e!=="object")return a+e;if(e instanceof Array){n="";for(s=0,o=e.length;s<o;s++){if(s>0)n+="\n";n+=Amm.html(e[s],t,i,r)}return n}if(!e.$)throw Error("`$` (tag name) must be present in attribute definition");n=a+"<"+e.$;for(s in e)if(e.hasOwnProperty(s)){if(s[0]==="$")continue;var h=e[s];if(h===false)continue;if(h===true)h=s;if(typeof h==="object"&&h){if(s==="style"){var u;u=function(e,t){var i="";if(!t||typeof t!=="object")return e+": "+t+"; ";if(t instanceof Array)return t.join(" ");if(e.length)e+="-";for(var r in t)if(t.hasOwnProperty(r)){i+=u(e+r,t[r])}return i};h=u("",h)}else{h=JSON.stringify(h).replace(/'/g,"&#39;")}}if(!r)s=s.replace(/_/g,"-");n+=" "+s+"='"+h+"'"}if(e.$$===null){n+=" />";return n}if(!e.$$){n+="></"+e.$+">";return n}var f=e["$noIndent"]?0:t+i;n+=">";if(f)n+="\n";n+=Amm.html(e.$$,f,i,r);if(f)n+="\n"+a;n+="</"+e.$+">";return n},getHtmlElements:function(e){if(e instanceof window.HTMLElement){elementOrDOMNode=Amm.findElement(e)}if(!e)return[];var t=e.getUniqueSubscribers("Amm.View.Html");var i=[];for(var r=0;r<t.length;r++){var n=t[r].getHtmlElement();if(n)i.push(n)}i=Amm.Array.unique(i);return i}};Amm.event=null;Amm.registerNamespace("Amm",Amm);if(window.jQuery){Amm.bootstrap()}Amm.Remote={};Amm.Remote.RunningRequest=function(e,t,i,r,n,s){this._constRequest=e;this._success=t;this._failure=i;this._scope=r;this._transport=n;this._extra=s};Amm.Remote.RunningRequest.ERROR_TIMEOUT="timeout";Amm.Remote.RunningRequest.ERROR_SERVER_ERROR="error";Amm.Remote.RunningRequest.ERROR_ABORT="abort";Amm.Remote.RunningRequest.ERROR_PARSER_ERROR="parsererror";Amm.Remote.RunningRequest.prototype={"Amm.Remote.RunningRequest":"__CLASS__",_constRequest:null,_success:null,_failure:null,_scope:null,_transport:null,_extra:undefined,_finished:false,_result:null,_error:null,getConstRequest:function(){return this._constRequest},getSuccess:function(){return this._success},getFailure:function(){return this._failure},getScope:function(){return this._scope},getTransport:function(){return this._transport},getExtra:function(){return this._extra},setExtra:function(e){if(this._extra===e)return;if(this._extra!==undefined)throw Error("Cant setExtra() only once");this._extra=e},getFinished:function(){return this._finished},success:function(e,t){this._result=Array.prototype.slice.call(arguments);if(!this._finished){this._finished=1}if(!this._success)return;return this._success.apply(this._scope||window,this._result)},failure:function(e,t,i){this._error=Array.prototype.slice.call(arguments);if(!this._finished){this._finished=-1}if(!this._failure)return;return this._failure.apply(this._scope||window,this._error)},abort:function(){this._transport.abortRunningRequest(this);this._finished=-3},getRunning:function(){return!this._finished},getAborted:function(){return this._finished===-3}};Amm.Remote.Transport=function(e){Amm.init(this,e)};Amm.Remote.Transport._default=null;Amm.Remote.Transport.getDefault=function(){if(!this._default)this._default=new Amm.Remote.Transport.JqXhr;return this._default};Amm.Remote.Transport.setDefault=function(e){if(!e)e=null;else Amm.is(e,"Amm.Remote.Transport","defaultTransport");this._default=e};Amm.Remote.Transport.prototype={"Amm.Remote.Transport":"__CLASS__",_history:null,_historySize:null,setHistorySize:function(e){var t=this._historySize;if(t===e)return;this._historySize=e;if(!this._historySize){this._history=null;return true}if(!this._history)this._history=[];else if(this._history.length>this._historySize){this._history.splice(this._historySize,this._history.length-this._historySize)}return true},getHistorySize:function(){return this._historySize},getHistory:function(){this._history?[].concat(this._history):[]},_push:function(e){this._history.unshift(e);if(this._history.length>this._historySize)this._history.pop()},makeRequest:function(e,t,i,r){var n=new Amm.Remote.RunningRequest(e,t,i,r,this);this._doPrepareRunningRequest(n,e,t,i,r);if(this._historySize)this._push(n);return n},abortRunningRequest:function(e){this._doAbortRunningRequest(e)},_doPrepareRunningRequest:function(e,t,i,r,n){}};Amm.WithEvents=function(e,t){this._subscribers={};if(e){var i=this._extractOnHandlers(e);if(i)this._initOnHandlers(i);if(!t){Amm.init(this,e)}}};Amm.WithEvents.invokeHandler=function(e,t,i,r,n,s,o){return Amm.WithEvents.invokeHandlers.call(this,e,t,[[i,r,n,s]],o)};Amm.WithEvents.invokeHandlers=function(e,t,i,r,n){if(!r){Amm.pushEvent({origin:this,name:e,args:t})}try{var s=i.length,o=s<2?i:i.slice();for(var a=0;a<s;a++){var l=o[a],h=l[0]||null,u=l[1]||this,f=l[2]||undefined,c=l[3]||n||null;if(typeof u==="string"){if(typeof this.getByPath==="function")u=this.getByPath(u);else u=Amm.getByPath(u);if(!u){continue}}if(!u)u=this;if(typeof h==="string"){h=u[h]}var _=[].concat(t);if(f!==undefined)_.push(f);if(c){_=c.call(c,e,_,h,u,f,this);if(!(_ instanceof Array))continue}if(!h||typeof h!=="function"&&typeof h.apply!=="function"){throw Error("Cannot call non-function handler or handler without .apply")}h.apply(u,_)}}catch(e){if(!r)Amm.popEvent();throw e}if(!r)Amm.popEvent();return true};Amm.WithEvents.prototype={"Amm.WithEvents":"__CLASS__",_subscribers:null,strictEvents:true,listEvents:function(){var e=[];for(var t in this){if((""+t).slice(0,3)==="out"&&typeof this[t]==="function"){t=""+t;t=t.slice(3,4).toLowerCase()+t.slice(4,t.length);if(t.length)e.push(t)}}return e},hasEvent:function(e){var t=e.charAt(0),i=t.toUpperCase();if(t===i){return null}var r="",n="out"+i+e.slice(1);if(typeof this[n]==="function")r=n;return r},_out:function(e){if(!this._subscribers)return;var t=this._subscribers[e];if(!t||!t.length)return;var i=Array.prototype.slice.call(arguments,1);Amm.WithEvents.invokeHandlers.call(this,e,i,t)},subscribe:function(e,t,i,r,n){if(typeof e!=="string"||!e.length)throw Error("`eventName` must be a non-empty string");i=i||null;r=r||null;n=n||null;if(this.strictEvents&&!this.hasEvent(e)){var s=this._handleMissingEvent(e,t,i,r,n);if(s===undefined)throw Error("No such out event: '"+e+"'");if(s===false)return true}var o=false;if(!this._subscribers[e]){this._subscribers[e]=[];o=true}var a;if(!this.getSubscribers(e,t,i,r,n).length){this._subscribers[e].push([t,i,r,n]);a=true}if(o){var l="_subscribeFirst_"+e;if(this[l]&&typeof this[l]==="function")this[l]()}return a},_handleMissingEvent:function(e,t,i,r,n){},getSubscribers:function(e,t,i,r,n){var s=[],o=null;if(e===undefined)o=this._subscribers;else{o={};o[e]=true}for(var a in o)if(this._subscribers.hasOwnProperty(a)){var l=this._subscribers[a],h=l.length;for(var u=0;u<h;u++){if(t!==undefined&&t!==l[u][0])continue;if(i!==undefined&&i!==l[u][1])continue;if(r!==undefined&&r!==l[u][2])continue;if(n!==undefined&&n!==l[u][3])continue;s.push([].concat(l[u],[a,u]))}}return s},getUniqueSubscribers:function(e,t){var i=[],r=null;if(t===undefined)r=this._subscribers;else{r={};r[t]=true}for(var n in r)if(this._subscribers.hasOwnProperty(n)){var s=this._subscribers[n],o=s.length;for(var a=0;a<o;a++){var l=s[a][1];if(!l)continue;if(e===undefined||Amm.is(l,e))i.push(l)}}return Amm.Array.unique(i)},unsubscribeByIndex:function(e,t){if(!this._subscribers[e]||!(t in this._subscribers[e]))return[];var i;i=[[].concat(this._subscribers[e][t],[e,t])];this._subscribers[e].splice(t,1);if(!this._subscribers[e].length){delete this._subscribers[e];var r="_unsubscribeLast_"+e;if(this[r]&&typeof this[r]==="function")this[r]()}return i},unsubscribe:function(e,t,i,r,n){var s;if(e instanceof Array&&arguments.length===1){s=e}else{s=this.getSubscribers(e,t,i,r,n)}for(var o=s.length-1;o>=0;o--){var a=s[o];this._subscribers[a[4]].splice(a[5],1);if(!this._subscribers[a[4]].length){delete this._subscribers[a[4]];var l="_unsubscribeLast_"+e;if(this[l]&&typeof this[l]==="function")this[l]()}}return s},cleanup:function(){this._subscribers={};Amm.unregisterItem(this)},_extractOnHandlers:function(e){var t=[];for(var i in e){if(i[0]==="o"&&i[1]==="n"&&i[2]==="_"&&i[3]==="_"&&e.hasOwnProperty(i)){var r=e[i];if(!(r instanceof Array))r=[r];var n=i.split("__")[1];t.push([n,r[0],r[1],r[2],r[3]]);delete e[i]}}return t.length?t:null},_initOnHandlers:function(e){for(var t=0,i=e.length;t<i;t++){this.subscribe(e[t][0],e[t][1],e[t][2],e[t][3],e[t][4])}}};Amm.Remote.Uri=function(e){if(e===null||e===undefined){e=""}if(typeof e==="string"){e={uri:e}}else if(e&&e["Amm.Remote.Uri"]){this._clone(e);e=undefined}else if(e&&typeof[e.toString]==="function"){e={uri:e.toString()}}else{if(e.uri){e=Amm.override({},e);this.setUri(e.uri);delete e.uri}}Amm.WithEvents.call(this,e)};Amm.Remote.Uri.PART_SCHEME="SCHEME";Amm.Remote.Uri.PART_USER="USER";Amm.Remote.Uri.PART_PASSWORD="PASSWORD";Amm.Remote.Uri.PART_HOST="HOST";Amm.Remote.Uri.PART_PORT="PORT";Amm.Remote.Uri.PART_PATH="PATH";Amm.Remote.Uri.PART_QUERY="QUERY";Amm.Remote.Uri.PART_FRAGMENT="FRAGMENT";Amm.Remote.Uri._current=null;Amm.Remote.Uri.getCurrent=function(){if(Amm.Remote.Uri._current){return new Amm.Remote.Uri(Amm.Remote.Uri._current)}if(window.location&&window.location.href){return new Amm.Remote.Uri(window.location.href)}};Amm.Remote.Uri.setCurrent=function(e){if(e)Amm.Remote.Uri._current=new Amm.Remote.Uri(""+e);else Amm.Remote.Uri._current=null};Amm.Remote.Uri._const={SCHEME:"_scheme",USER:"_user",PASSWORD:"_pass",HOST:"_host",PORT:"_port",PATH:"_path",QUERY:"_query",FRAGMENT:"_fragment"};Amm.Remote.Uri.prototype={"Amm.Remote.Uri":"__CLASS__",RequestProvider:"__INTERFACE__",_scheme:null,_user:null,_pass:null,_host:null,_port:null,_path:null,_query:null,_fragment:null,_uri:null,_updateLevel:0,_oldUri:null,_strQuery:null,setUri:function(e,t){if(t===undefined||t===null||t===""){if(e&&e["Amm.Remote.Uri"]){this._clone(e)}else{this._parse(e)}return}if(Amm.Remote.Uri._const[t]){this.beginUpdate();if(t==="QUERY"&&typeof e!=="object"){this._strQuery=e||"";this._query=this._parseQuery(e)}else this[Amm.Remote.Uri._const[t]]=""+e;this.endUpdate();return}this.beginUpdate();var i={};this._query=this._setByPath(this._query,this._pathToArray(t),e,i);if(i.changed)this._strQuery=null;this.endUpdate()},getUri:function(e,t){if(!e){if(this._uri!==null)return this._uri;return this._build()}if(t&&e===Amm.Remote.Uri.PART_QUERY){if(this._strQuery===null){this._strQuery=this._buildQuery(this._query,"",true)}return this._strQuery}if(Amm.Remote.Uri._const[e])return this[Amm.Remote.Uri._const[e]];return this._getByPath(this._query,this._pathToArray(e))},_clone:function(e){if(this._subscribers)this.beginUpdate();for(var t in Amm.Remote.Uri._const){if(Amm.Remote.Uri._const.hasOwnProperty(t)){this[Amm.Remote.Uri._const[t]]=e[Amm.Remote.Uri._const[t]]}this._strQuery=e._strQuery;this._uri=null}if(this._subscribers)this.endUpdate()},outRequestChangeNotify:function(){return this._out("requestChangeNotify",this)},outUriChange:function(e,t){return this._out("uriChange",e,t)},produceRequest:function(){return new Amm.Remote.ConstRequest({uri:this.getUri(),method:Amm.Remote.ConstRequest.METHOD_GET})},beginUpdate:function(){if(!this._updateLevel){this._oldUri=this.getUri()}this._updateLevel++},endUpdate:function(){if(!this._updateLevel){throw Error("call to endUpdate() without prior beginUpdate()")}this._updateLevel--;if(this._updateLevel)return;var e=this._build(),t=this._oldUri;this._oldUri=null;if(e!==t){this.outUriChange(e,t);this.outRequestChangeNotify()}},_isSimpleNumArray:function(e,t){if(!(e instanceof Array))return false;var i="";for(var r=0,n=e.length;r<n;r++){if(!(r in e)||e[r]===undefined||typeof e[r]==="object")return false;i+="&"+t+"[]="+encodeURIComponent(e[r])}return i},_buildQuery:function(e,t,i){var r="",n,s;if(e===undefined)return"";if((s=this._isSimpleNumArray(e,t))!==false){r=s}else if(e instanceof Array){if(e.length){for(n=0;n<e.length;n++){r=r+this._buildQuery(e[n],t?t+"["+n+"]":n)}}else{r="&"+t+"="}}else{if(typeof e==="object"){for(n in e)if(e.hasOwnProperty(n)){r=r+this._buildQuery(e[n],t?t+"["+n+"]":n)}}else{r="&"+t+"="+encodeURIComponent(e)}}if(i&&r.length)r=r.slice(1);return r},_parseQuery:function(e,t,i){if(e===null||e===undefined)return null;if(!e.length)return{};if(t===undefined)t="&";if(i===undefined)i="=";var r=e.split(t),n=r.length,s=[];for(var o=0;o<n;o++){var a=r[o].split(i,2),l=a[0].replace("]","");l=l.replace(/\]/g,"").split("[");if(a.length<2)a.push("");s=this._setByPath(s,l,a[1])}return s},_pathToArray:function(e){if(e instanceof Array)return e;return e.replace(/\]/g,"").split("[")},_arrayToPath:function(e){var t=e;if(e instanceof Array)t=e.length>1?e.join("][")+"]":e[0];return t},_getByPath:function(e,t,i){var r=e,n=[].concat(t),s;while(n.length){s=n.shift();if(!r||typeof r!=="object"||!(s in r))return i;r=r[s]}if(!n.length)return r;return i},_setByPath:function(e,t,i,r){if(!e&&i===undefined)return;var n=t.length;r=r||{};r.changed=false;if(!n)return i;if(typeof e!=="object"||e===null){e={};r.changed=true}var s={dummy:e},o=s,a="dummy",l,h;for(var u=0;u<n;u++){var f=u>=n-1,c=o[a];l=""+t[u],h=parseInt(l);if(!l.length){if(c instanceof Array)h=c.length;else{h=0;for(var _ in c)if(c.hasOwnProperty(_)){var m=parseInt(_);if(m>=h)h=m+1}}l=h}if(h>=0&&""+h==l){if(f){if(c[h]!==i){c[h]=i;r.changed=true}}else{if(c[h]===undefined){c[h]=[];r.changed=true}}o=c;a=h}else{if(c instanceof Array){r.changed=true;o[a]=this._arrayToObject(o[a]);c=o[a]}if(f){if(c[l]!==i){r.changed=true;c[l]=i}}else{if(c[l]===undefined){c[l]=[];r.changed=true}o=c;a=l}}}return s.dummy},_arrayToObject:function(e){var t={},i=e.length;for(var r=0;r<i;r++){if(e[r]!==undefined)t[r]=e[r]}return t},toString:function(){return this.getUri()},_parse:function(e){e=""+e;if(e[0]==="m"&&e[6]===":")e=e.replace(/^mailto:/,"mailto://");this.beginUpdate();var t=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?(((\/?(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;var i=[".source","_scheme",".authority",".userInfo","_user","_pass","_host","_port",".relative","_path",".directory",".file","_strQuery","_fragment"];var r={};var n=t.exec(e);for(var s=i.length-1;s>=0;s--){var o=i[s];if(o[0]!=="."){if(n[s]===undefined)this[o]=null;else this[o]=n[s]}r[o]=n[s]}this._query=this._parseQuery(this._strQuery);this.endUpdate()},_build:function(e){if(e===undefined)e=true;var t="",i;if(this._scheme)t+=this._scheme+":";if(this._host){if(this._scheme!=="mailto")t+="//";if(this._user||this._pass){t+=this._user;if(this._pass)t+=":"+this._pass;t+="@"}t+=this._host;t+=this._port?":"+this._port:""}if(this._path){if(t&&this._path[0]!=="/")t+="/";t+=this._path}if(e&&this._query){if(this._strQuery!==null)i=this._strQuery;else{i=this._buildQuery(this._query,"",true);this._strQuery=i}t+="?"+i}if(this._fragment!==null)t+="#"+this._fragment;if(e)this._uri=t;return t},isFullyQualified:function(){return this._scheme&&this._host},isRelative:function(){return this._path&&this._path[0]!=="/"},resolve:function(e){var t,i,r;if(this.isFullyQualified())return new Amm.Remote.Uri(this);if(!e)e=Amm.Remote.Uri.getCurrent();if(e["Amm.Remote.Uri"])t=e;else t=new Amm.Remote.Uri(e);if(this.getUri()===""){i=new Amm.Remote.Uri(t);i._fragment="";return i}else if(this.getUri().charAt(0)==="#"){i=new Amm.Remote.Uri(t);i.setUri(this._fragment,Amm.Remote.Uri.PART_FRAGMENT);return i}i=new Amm.Remote.Uri(this);if(!i._scheme)i._scheme=t._scheme;if(!i._host)i._host=t._host;if(i._path&&i._path.charAt(0)==="/"){return i}r=t._path;if(!i._path){i._path=r;return i}r=r.replace(/\/[^/]*$/,"").replace(/\/{2,}/,"/")+"/"+i._path.replace(/^\//,"");if(!r.match(/(^|\/)\.\.?(\/|)/)){i._path=r;return i}var n,s;r=r.split("/");s=0;while(s<r.length){n=r[s];if(n==="."||n===""){r.splice(s,1);continue}if(n!==".."){s++;continue}if(s>1){r.splice(s-1,2);s--;continue}r.splice(s,1)}r="/"+r.join("/");i._path=r;return i}};Amm.extend(Amm.Remote.Uri,Amm.WithEvents);Amm.Remote.Transport.JqXhr=function(e){Amm.Remote.Transport.call(this,e)};Amm.Remote.Transport.JqXhr.prototype={"Amm.Remote.Transport.JqXhr":"__CLASS__",_doPrepareRunningRequest:function(e,t,i,r,n){var s=t.getJqXhrOptions();s.context=e;var o=jQuery.ajax(t.getUri(),s).done(e.success).fail(this._failure);e.setExtra(o)},_failure:function(e,t){this.failure(e,t,this.getExtra().status)},_doAbortRunningRequest:function(e){e.getExtra().abort()}};Amm.extend(Amm.Remote.Transport.JqXhr,Amm.Remote.Transport);Amm.Remote.Transport.Debug=function(e){Amm.Remote.Transport.call(this,{});Amm.WithEvents.call(this,e);var r=this;this._successClosure=function(e,t){return r.success(e,t)};this._failureClosure=function(e,t,i){return r.failure(e,t,i)}};Amm.Remote.Transport.Debug.prototype={"Amm.Remote.Transport.Debug":"__CLASS__",eventTime:0,replyTime:10,_pendingSuccess:null,_pendingFailure:null,_lastRequest:null,_successClosure:null,_failureClosure:null,reply:function(t,i,e,r){this._pendingSuccess=null;this._pendingFailure=null;if(t.getAborted())return;if(e===undefined||e===null)e=this.replyTime;var n=Array.prototype.slice.call(arguments,3);var s=function(){var e=i?t.success:t.failure;e.apply(t,n)};if(e>0){t._timeout=window.setTimeout(s,this.replyTime)}else{s()}},success:function(e,t,i){if(!this._lastRequest){this._pendingSuccess=Array.prototype.slice.call(arguments);this._pendingFailure=null;return}if(typeof e==="function")e=e(this._lastRequest);this.reply(this._lastRequest,true,i,e,t)},failure:function(e,t,i,r){if(!this._lastRequest){this._pendingFailure=Array.prototype.slice.call(arguments);this._pendingSuccess=null;return}this.reply(this._lastRequest,false,r,e,t,i)},outRequest:function(e,t,i){var r=this._lastRequest,n;this._lastRequest=e;n=this._out("request",e,t,i);if(this._pendingSuccess){this.success.apply(this,this._pendingSuccess)}else if(this._pendingFailure){this.failure.apply(this,this._pendingFailure)}this._lastRequest=r;return n},outAbortRequest:function(e){return this._out("abortRequest",e)},_doPrepareRunningRequest:function(e,t,i,r,n){var s=this,o=function(){s.outRequest(e,s._successClosure,s._failureClosure)};if(this.eventTime<=0)o();else{e._timeout=window.setTimeout(o,this.eventTime)}},_doAbortRunningRequest:function(e){if(e._timeout){window.clearTimeout(e._timeout,null);e._timeout=null}this.outAbortRequest(e)}};Amm.extend(Amm.Remote.Transport.Debug,Amm.Remote.Transport);Amm.extend(Amm.Remote.Transport.Debug,Amm.WithEvents);Amm.Remote.RequestProducer=function(e){this._data={};Amm.Remote.Uri.call(this,e)};Amm.Remote.RequestProducer._allowedMethods={GET:"Amm.Remote.ConstRequest.METHOD_GET",POST:"Amm.Remote.ConstRequest.METHOD_POST",PUT:"Amm.Remote.ConstRequest.METHOD_PUT",DELETE:"Amm.Remote.ConstRequest.METHOD_DELETE",PATCH:"Amm.Remote.ConstRequest.METHOD_PATCH",HEAD:"Amm.Remote.ConstRequest.METHOD_HEAD",CONNECT:"Amm.Remote.ConstRequest.METHOD_CONNECT",OPTIONS:"Amm.Remote.ConstRequest.METHOD_OPTIONS"},Amm.Remote.RequestProducer.prototype={"Amm.Remote.RequestProducer":"__CLASS__",_method:"GET",_data:null,setMethod:function(e){e=(""+e).toUpperCase();if(!(e in Amm.Remote.RequestProducer._allowedMethods)){throw Error("Invalid 'method' value; allowed values are "+Amm.keys(Amm.Remote.RequestProducer._allowedMethods).join("|"))}var t=this._method;if(t===e)return;this._method=e;this.outMethodChange(e,t);this.outRequestChangeNotify();return true},getMethod:function(){return this._method},outMethodChange:function(e,t){this._out("methodChange",e,t)},produceRequest:function(){var e={uri:this.getUri(),method:this._method};if(this._data)e.data=this._data;return new Amm.Remote.ConstRequest(e)},setData:function(e,t){var i;if(t===undefined){if(e===undefined||e===false)e=null;if(e===this._data)return;i=this._data?Amm.override({},this._data):this._data;if(JSON.stringify(i)===JSON.stringify(e))return;this._data=e}else{if((e===undefined||e===null)&&this._data===null)return;var r=this._pathToArray(t);var n={};i=this._data?Amm.override({},this._data):this._data;if(!this._data)this._data={};this._setByPath(this._data,r,e,n);var s=false;for(var o in this._data)if(this._data.hasOwnProperty(o)){s=true}if(!s)this._data=null;if(this._data===i)return;if(!n.changed)return}this.outDataChange(e,i);this.outRequestChangeNotify();return true},getData:function(e){if(e===undefined)return this._data;if(!this._data)return undefined;var t=this._pathToArray(e);return this._getByPath(this._data,t)},outDataChange:function(e,t){return this._out("dataChange",e,t)}};Amm.extend(Amm.Remote.RequestProducer,Amm.Remote.Uri);Amm.Remote.Mapper=function(e){this.patterns=[]};Amm.Remote.Mapper.prototype={setPatterns:function(e){}};Amm.Remote.ConstRequest=function(e){if(!e)return;if(e.uri)this._uri=e.uri;if(e.method)this._method=e.method;if(e.data)this._data=e.data;if(e.headers)this._headers=e.headers;if(e.misc)this._misc=e.misc};Amm.Remote.ConstRequest.METHOD_GET="GET";Amm.Remote.ConstRequest.METHOD_POST="POST";Amm.Remote.ConstRequest.METHOD_PUT="PUT";Amm.Remote.ConstRequest.METHOD_DELETE="DELETE";Amm.Remote.ConstRequest.METHOD_PATCH="PATCH";Amm.Remote.ConstRequest.METHOD_HEAD="HEAD";Amm.Remote.ConstRequest.METHOD_CONNECT="CONNECT";Amm.Remote.ConstRequest.METHOD_OPTIONS="OPTIONS";Amm.Remote.ConstRequest.prototype={ConstRequest:"__INTERFACE__",_uri:undefined,_method:undefined,_data:null,_headers:undefined,_misc:undefined,getUri:function(){return this._uri},getMethod:function(){return this._method},getData:function(){return this._data},getHeaders:function(){return this._headers},getMisc:function(){return this._misc},getJqXhrOptions:function(){var e={};if(this._misc&&typeof this._misc==="object")Amm.override(e,this._misc);if(this._data)e.data=this._data;if(this._headers)e.headers=this._headers;if(this._method)e.method=this._method;return e},getAll:function(){var e=this.getJqXhrOptions();if(this._uri)e.uri=this._uri;return e}};Amm.Remote.Fetcher=function(e){Amm.WithEvents.call(this,e)};Amm.Remote.Fetcher.STATE_CONFIGURING="configuring";Amm.Remote.Fetcher.STATE_IDLE="idle";Amm.Remote.Fetcher.STATE_PREINIT="preinit";Amm.Remote.Fetcher.STATE_STARTED="started";Amm.Remote.Fetcher.STATE_SENT="sent";Amm.Remote.Fetcher.STATE_RECEIVED="received";Amm.Remote.Fetcher.STATE_ERROR="error";Amm.Remote.Fetcher.AUTO_NONE=0;Amm.Remote.Fetcher.AUTO_BOOTSTRAP=1;Amm.Remote.Fetcher.AUTO_ALWAYS=2;Amm.Remote.Fetcher.prototype={"Amm.Remote.Fetcher":"__CLASS__",_requestProducer:null,_requestProducerIsOwn:false,_response:undefined,_state:Amm.Remote.Fetcher.STATE_CONFIGURING,_error:null,_auto:Amm.Remote.Fetcher.AUTO_NONE,_firstDelay:10,_throttleDelay:500,_timeout:null,_waitingForBootstrap:false,_constRequest:null,_runningRequest:null,_starting:0,_gotResultOnStart:false,_prevRequest:null,_timeoutCallback:null,_transport:null,_poll:false,_detectChanges:true,_lastResponseJson:undefined,_lastErrorJson:undefined,run:function(){this._doRequest()},setRequestProducer:function(e){var t=this._requestProducer;if(t===e)return;if(t){t.unsubscribe("requestChangeNotify",this._requestChangeNotify,this);if(this._requestProducerIsOwn)t.cleanup()}if(typeof e==="string")e=new Amm.Remote.RequestProducer(e);if(!e)e=null;else if(typeof e==="object"&&!Amm.getClass(e)){e=Amm.constructInstance(e,"Amm.Remote.RequestProducer",undefined,false,"RequestProvider");this._requestProducerIsOwn=true}else{Amm.meetsRequirements(e,"RequestProvider","request")}this._requestProducer=e;if(e){e.subscribe("requestChangeNotify",this._requestChangeNotify,this)}this.setConstRequest(e.produceRequest());this.outRequestProducerChange(e,t);this._updateState();return true},getRequestProducer:function(){return this._requestProducer},outRequestProducerChange:function(e,t){this._out("requestProducerChange",e,t)},_requestChangeNotify:function(){var e=this._requestProducer.produceRequest();this.setConstRequest(e)},setConstRequest:function(e){if(!e)e=null;var t=this._constRequest;if(t===e)return;this._constRequest=e;this.outConstRequestChange(e,t);this._scheduleAutoRequest();this._updateState();return true},getConstRequest:function(){return this._constRequest},outConstRequestChange:function(e,t){return this._out("constRequestChange",e,t)},setTransport:function(e){if(!e)e=null;else if(typeof e!=="object"||!Amm.getClass(e)){e=Amm.constructInstance(e,"Amm.Remote.Transport")}else Amm.is(e,"Amm.Remote.Transport","transport");var t=this._transport;if(t===e)return;this._transport=e;this.outTransportChange(e,t);return true},outTransportChange:function(e,t){return this._out("transportChange",e,t)},getTransport:function(){return this._transport},_doGetTransport:function(){return this._transport||Amm.Remote.Transport.getDefault()},_runOnBootstrap:function(){if(!this._waitingForBootstrap)return;this._scheduleAutoRequest();this._updateState()},_scheduleAutoRequest:function(e){if(!this._auto){return}if(this._auto===Amm.Remote.Fetcher.AUTO_BOOTSTRAP&&!Amm.getBootstrapped()){Amm.getRoot().subscribe("bootstrap",this._runOnBootstrap,this);this._waitingForBootstrap=true;return}if(!this._constRequest){return}var t=this._runningRequest||e?this._throttleDelay:this._firstDelay;var i=this;if(this._timeout)window.clearTimeout(this._timeout);if(this._runningRequest){this._abort()}if(t>0){if(!this._timeoutCallback){this._timeoutCallback=function(){i._doRequest()}}this._timeout=window.setTimeout(this._timeoutCallback,t)}else{this._timeout=null;this._doRequest()}},_abort:function(){if(!this._runningRequest)return;this._prevRequest=this._runningRequest;this._runningRequest=null;this._prevRequest.abort()},_doRequest:function(){if(!this._constRequest){throw Error("Cannot _doRequest() without _constRequest")}this._waitingForBootstrap=false;if(this._runningRequest)this._abort();if(this._timeout){window.clearTimeout(this._timeout);this._timeout=null}this._starting++;this._runningRequest=this._doGetTransport().makeRequest(this._constRequest,this._requestDone,this._requestFail,this);this._starting--;this.setError(null);if(this._gotResultOnStart){this._prevRequest=this._runningRequest;this._runningRequest=null}this._updateState();return},_requestDone:function(e,t){if(!this._runningRequest&&!this._starting)return;if(this._runningRequest){this._prevRequest=this._runningRequest;this._runningRequest=null}this.setResponse(e)},_requestFail:function(e,t,i){if(!this._runningRequest&&!this._starting)return;if(this._runningRequest){this._prevRequest=this._runningRequest;this._runningRequest=null}this.setError({textStatus:e,errorThrown:t,httpCode:i})},_setState:function(e){var t=this._state;if(t===e)return;this._state=e;this.outStateChange(e,t);return true},getState:function(){return this._state},outStateChange:function(e,t){this._out("stateChange",e,t)},isDataChanged:function(e,t){var i="_last"+t.charAt(0).toUpperCase()+t.slice(1)+"Json";var r=JSON.stringify(e);if(this[i]===r)return false;this[i]=r;return true},setResponse:function(e){var t=this._response;if(t===e)return;if(this._runningRequest)this._abort();if(this._starting)this._gotResultOnStart=true;var i=!this._detectChanges||this.isDataChanged(e,"response");if(i)this._response=e;this._updateState();if(i){this.outResponseChange(e,t);return true}},getResponse:function(){return this._response},outResponseChange:function(e,t){this._out("responseChange",e,t)},setError:function(e){var t=this._error;if(t===e)return;if(this._detectChanges&&!this.isDataChanged(e,"error"))return;if(e){if(this._runningRequest){this._abort()}this.setResponse(undefined)}this._error=e;if(this._starting)this._gotResultOnStart=true;this._updateState();this.outErrorChange(e,t);return true},getError:function(){return this._error},outErrorChange:function(e,t){this._out("errorChange",e,t)},setThrottleDelay:function(e){var t=this._throttleDelay;if(t===e)return;this._throttleDelay=e;this.outThrottleDelayChange(e,t);return true},getThrottleDelay:function(){return this._throttleDelay},outThrottleDelayChange:function(e,t){this._out("throttleDelayChange",e,t)},setFirstDelay:function(e){var t=this._firstDelay;if(t===e)return;this._firstDelay=e;this.outFirstDelayChange(e,t);return true},getFirstDelay:function(){return this._firstDelay},outFirstDelayChange:function(e,t){this._out("firstDelayChange",e,t)},setAuto:function(e){var t=this._auto;if(t===e)return;this._auto=e;this.outAutoChange(e,t);if(e&&this._constRequest)this._scheduleAutoRequest();return true},getAuto:function(){return this._auto},outAutoChange:function(e,t){this._out("autoChange",e,t)},cleanup:function(){this.reset();if(this._requestProducer&&this._requestProducerIsOwn&&this._requestProducer.cleanup){this._requestProducer.cleanup();this._requestProducer=null}Amm.WithEvents.prototype.cleanup.call(this)},reset:function(){if(this._poll)this.setPoll(false);if(this._runningRequest)this._abort();if(this._timeout){window.clearTimeout(this._timeout);this._timeout=null}this.setResponse(undefined);this._updateState()},_updateState:function(){var e;if(this._runningRequest){e=Amm.Remote.Fetcher.STATE_SENT}else if(this._timeout){e=Amm.Remote.Fetcher.STATE_STARTED}else if(this._error){e=Amm.Remote.Fetcher.STATE_ERROR}else if(this._response!==undefined){e=Amm.Remote.Fetcher.STATE_RECEIVED}else if(!this._constRequest){e=Amm.Remote.Fetcher.STATE_CONFIGURING}else if(this._waitingForBootstrap){e=Amm.Remote.Fetcher.STATE_PREINIT}else{e=Amm.Remote.Fetcher.STATE_IDLE}if(this._poll&&(e===Amm.Remote.Fetcher.STATE_IDLE||e===Amm.Remote.Fetcher.STATE_RECEIVED||e===Amm.Remote.Fetcher.STATE_ERROR)){this._scheduleAutoRequest(true)}this._setState(e)},setPoll:function(e){e=!!e;var t=this._poll;if(t===e)return;this._poll=e;this.outPollChange(e,t);if(e)this._scheduleAutoRequest();return true},getPoll:function(){return this._poll},outPollChange:function(e,t){this._out("pollChange",e,t)},setDetectChanges:function(e){e=!!e;var t=this._detectChanges;if(t===e)return;this._detectChanges=e;return true},getDetectChanges:function(){return this._detectChanges}};Amm.extend(Amm.Remote.Fetcher,Amm.WithEvents);Amm.Remote.MapperPattern=function(e){if(typeof e!=="string"||!e.length)throw Error("`definition` must be non-empty string");this._parseDefinition(e)};Amm.Remote.MapperPattern._parseRx=/([^{}]+)|(\{\w+(\.\.\.)?)|[{}]/g;Amm.Remote.MapperPattern.prototype={definition:null,regex:null,args:null,segments:null,_parseDefinition:function(e){this._definition=e;var t=e.match(Amm.Remote.MapperPattern._parseRx);if(t.join("")!==e){console.log(t,e);throw Error("MapperPattern definition wasn't fully matched")}var i,r,n=0,s;this.regex="";this.args=[];this.segments=[];while((curr=t.shift())!==undefined){s=curr.length;if(curr[0]==="{"){if(i){throw Error("Error at position "+n+" of definition '"+e+"': arguments must be always separated by non-argument string")}if(t[0]==="}"){t.shift();s++}else{throw Error("Unmatched '{' at position "+n+"of definition '"+e+"'")}i=curr.slice(1);if(i.slice(-3)==="..."){r=true;i=i.slice(1,-3)}this.args.push(i);if(r)this.regex+="(.+)";else this.regex+="([-\\w]+)";this.segments.push([i])}else{i=null;this.regex+=Amm.Util.regexEscape(curr);this.segments.push(curr)}n+=s}this.regex="^"+this.regex+"$"},parse:function(e,t){if(!t)t={};if(typeof this.regex==="string")this.regex=new RegExp(this.regex);var i=this.regex.exec(e);if(!i)return false;for(var r=0,n=this.args.length;r<n;r++){t[this.args[r]]=i[r+1]}return true},build:function(e,t){var i,r;for(i=0,r=this.args.length;i<r;i++){var n=e[this.args[i]];if(n===null||n===undefined||n===""||""+n==="")return}var s="";for(i=0,r=this.segments.length;i<r;i++){if(this.segments[i]instanceof Array){s+=""+e[this.segments[i][0]];if(t)delete e[this.segments[i][0]]}else s+=this.segments[i]}return s}};Amm.Decorator=function(e){if(e&&this["Amm.Decorator"]==="__CLASS__"&&e.decorate&&typeof e.decorate==="function"){this.decorate=e.decorate;delete e.decorate}Amm.init(this,e)};Amm.Decorator.construct=function(e,t,i,r){if(typeof e==="function"){e={decorate:e}}return Amm.constructInstance(e,"Amm.Decorator",t,i,r)};Amm.Decorator.prototype={"Amm.Decorator":"__CLASS__",decorate:function(e){return e}};Amm.Decorator.WrapObject=function(e){Amm.Decorator.call(this,e)};Amm.Decorator.WrapObject.prototype={"Amm.Decorator.WrapObject":"__CLASS__",decorate:function(e){var t;if(!(e&&typeof e==="object"))return e;if(Amm.getClass(e))return e;if(e instanceof Array){var i=[],r=true;for(var n=0,s=e.length;n<s;n++){if(!(e[n]&&typeof e[n]==="object"))r=false;i.push(this.wrapObject(e[n]))}if(r)t=new Amm.Collection(i);else t=new Amm.Array(i);return t}t=new Amm.WithEvents;for(var n in e)if(e.hasOwnProperty(n)){var o=e[n];if(o&&typeof o==="object"){o=this.wrapObject(o)}Amm.createProperty(t,n,o,function(e,t,i){if(e&&typeof e==="object"){this[i]=this.wrapObject(e)}},true)}return t}};Amm.extend(Amm.Decorator.WrapObject,Amm.Decorator);Amm.Element=function(e){this._beginInit();this._cleanupList=[];this._expressions={};if(!e){Amm.WithEvents.call(this);this._endInit();return}var t;var i=this._getDefaultTraits(),r=e.traits;var n=[];e=Amm.Element._checkAndApplyOptionsBuilderSource(e);if("expressions"in e){t=e.expressions;delete e.expressions}Amm.Element._checkAndApplyOptionsViews(e,n,r?null:i);if(e.extraTraits){if(r)throw Error("extraTraits and traits options cannot be used simultaneously");i=i.concat(e.extraTraits);delete e.extraTraits}if(r){if(e.traits instanceof Array)i=i.concat(e.traits);else i.push(e.traits);delete e.traits}if(i.length){var s=[];for(var o=0;o<i.length;o++){var a=Amm.getFunction(i[o]);if(Amm.Array.indexOf(a,s)>=0)continue;s.push(a);Amm.augment(this,a,e)}}var l=[],h;for(var o in e)if(e.hasOwnProperty(o)){if(o[0]==="i"&&o[2]==="_"&&o.slice(0,4)==="in__"){l.push([o.slice(4),e[o],Amm.Element.EXPROP_IN]);delete e[o]}if(o[0]==="s"&&o[4]==="_"&&o.slice(0,6)==="sync__"){console.log(o);l.push([o.slice(6),e[o],Amm.Element.EXPROP_SYNC]);delete e[o]}if(o[0]==="e"&&o[4]==="_"&&o.slice(0,6)==="expr__"){l.push([o.slice(6),e[o],Amm.Element.EXPROP_EXPR]);delete e[o]}else if(o[0]==="p"&&o[4]==="_"&&o.slice(0,6)==="prop__"){h=h||{};h[o.slice(6)]=e[o];delete e[o]}}Amm.WithEvents.call(this);var u=this._extractOnHandlers(e);Amm.init(this,e,["id","properties"]);Amm.init(this,e);if(h)this.setProperties(h);if(l.length)this._initInProperties(l);if(u)this._initOnHandlers(u);if(t)this.setExpressions(t);this._endInit();if(n.length){for(var o=0,f=n.length;o<f;o++){n[o].setElement(this)}}};Amm.Element.EXPROP_IN=0;Amm.Element.EXPROP_SYNC=1;Amm.Element.EXPROP_EXPR=2;Amm.Element._checkAndApplyOptionsBuilderSource=function(e){if(Amm.Builder.isPossibleBuilderSource(e)){e={builderSource:e}}if(!e.builderSource)return e;var t=Amm.Builder.calcPrototypeFromSource(e.builderSource);var i=e.builderPriority?Amm.override({},e,t):Amm.override(t,e);delete i.builderSource;delete i.builderPriority;delete i.class;return i};Amm.Element._checkAndApplyOptionsViews=function(e,t,i){if(!e.views)return;for(var r=0,n=e.views.length;r<n;r++){var s=e.views[r];if(!Amm.getClass(s)){if(typeof s==="string")s={class:s};var o=s["class"];if(!o){throw Error("views["+r+"].class not provided")}var a=Amm.getFunction(o);if(!a.prototype["Amm.View.Abstract"])throw Error("View class must be a descendant of Amm.View.Abstract");var l=s.class,h=s;delete s.class;s=new a(s);h.class=l}if(!s["Amm.View.Abstract"])throw Error("Created instance isn't a descendant of Amm.View.Abstract");t.push(s);if(i){i.push.apply(i,s.getSuggestedTraits())}}delete e.views};Amm.Element.regInit=function(e,t,i){if(e._initLevel===false)i.call(e);e._init=e._init||{};e._init[t]=i};Amm.Element.prototype={"Amm.Element":"__CLASS__",_requiredParentClass:"Composite",_id:null,_path:null,_parent:null,_cleanupList:null,_cleanupWithParent:null,_cleanupWithComponent:true,_deferredParentPath:null,defaultProperty:null,_init:null,_initLevel:0,_component:null,_closestComponent:null,_beginInit:function(){if(this._initLevel===false)return false;this._initLevel++;this._init=this._init||{}},_endInit:function(){if(this._initLevel===false)return false;if(this._initLevel>0){this._initLevel--}if(this._initLevel)return;if(this._init){this._initLevel=false;var e=[];for(var t in this._init){if(this._init.hasOwnProperty(t)&&typeof this._init[t]==="function"){e.push(t)}}e.sort();for(var t=0,i=e.length;t<i;t++)this._init[e[t]].call(this)}this._init=null},setId:function(e){if(this._id===e)return;if((""+e).indexOf(Amm.ID_SEPARATOR)>=0){throw Error("`id` must not contain Amm.ID_SEPARATOR ('"+Amm.ID_SEPARATOR+"')")}var t=this._id,i=this.getPath(),r;if(this._parent&&(r=this._parent.getChild(e))&&r!==this){throw Error("Cannot setId() since the Parent already hasChild() with id '"+e+"'")}this._id=e;this.outIdChange(e,t);this._path=null;var n=this.getPath();if(n!==i)this.outPathChanged(n,i);return true},getPath:function(){if(this._path===null&&this._id!==null){this._path=(this._parent?this._parent.getPath():"")+Amm.ID_SEPARATOR+this._id}return this._path},getId:function(){return this._id},setDeferredParentPath:function(e){if(this._deferredParentPath===e)return;if(this._deferredParentPath)Amm.stopWaiting(this._parent,this.setParent,this);var t=this.getByPath(e);if(t)return this.setParent(t);if(this._parent)this.setParent(null);this._deferredParentPath=e;if(e){Amm.waitFor(this._deferredParentPath,this.setParent,this)}},getDeferredParentPath:function(){return this._deferredParentPath},setParent:function(e){if(e===this._parent)return;if(typeof e==="string")return this.setDeferredParentPath(e);if(e){for(var t=e;t;t=t.getParent()){if(t===this)throw Error("Cannot setParent() when `parent` is the child of me")}}var i=this._parent,r=this.getPath();this._parent=null;this._path=null;if(i){i.unsubscribe("pathChanged",this._deferredParentPathChanged,this);i.unsubscribe("cleanup",this._handleParentCleanup,this);i.removeChild(this)}if(e){e.subscribe("pathChanged",this._deferredParentPathChanged,this);e.subscribe("cleanup",this._handleParentCleanup,this);if(this._requiredParentClass)Amm.is(e,this._requiredParentClass,"parent");try{this._parent=e;this._parent.addChild(this)}catch(t){this._parent=null;throw t}}this.outParentChanged(e,i);var n=this.getPath();if(n!==r)this.outPathChanged(n,r);return true},_deferredParentPathChanged:function(e,t){var t=this._path;this._path=e+Amm.ID_SEPARATOR+this._id;if(this._path!==t)this.outPathChanged(this._path,t)},outIdChange:function(e,t){this._out("idChange",e,t)},outPathChanged:function(e,t){this._out("pathChanged",e,t);if(e&&e[0]==="^"||t&&t[0]==="^"){Amm.notifyElementPathChanged(this,e,t)}},outParentChanged:function(e){this._out("parentChanged",e)},p:function(e){if(e===undefined)return this.getPath();return this.getByPath(e)},getByPath:function(e){if(!((typeof e==="string"||e instanceof Array)&&e.length))throw Error("`path` must be a non-empty array or non-empty string");var t=null,i;if(e[0]==="^"&&this._id!=="^")return Amm.p(e);var r,n;if(typeof e==="string"){n=e.split(Amm.ID_SEPARATOR)}else{n=[].concat(e)}r=n.splice(0,1)[0];if(r===""){i=this.getTopElement()}else if(r==="^")i=Amm.getRoot();else if(r===".")i=this;else if(r==="..")i=this.getParent();else i=this.getChild(r);if(i){if(!n.length){t=i}else{t=i.getByPath(n)}}return t},listChildren:function(){return[]},hasChild:function(e){return false},getTopElement:function(){var e=null;for(var t=this;t;t=t.getParent())e=t;return e},getParent:function(){return this._parent},outCleanup:function(){this._out("cleanup",this)},_handleParentCleanup:function(){var e=this._cleanupWithParent;if(e===null)e=this._parent.getCleanupChildren();if(e)this.cleanup();else this.setParent(null)},setCleanupWithParent:function(e){var t=this._cleanupWithParent;if(t===e)return;this._cleanupWithParent=e;return true},getCleanupWithParent:function(){return this._cleanupWithParent},setCleanupWithComponent:function(e){e=!!e;var t=this._cleanupWithComponent;if(t===e)return;this._cleanupWithComponent=e;return true},getCleanupWithComponent:function(){return this._cleanupWithComponent},createProperty:function(e,t,i,r){return Amm.createProperty(this,e,t,i,r)},cleanup:function(){this.setParent(null);this.setComponent(null);this._callOwnMethods("_cleanup_");for(var e=this._cleanupList.length-1;e>=0;e--){if(typeof this._cleanupList[e].cleanup==="function")this._cleanupList[e].cleanup()}this.outCleanup();Amm.WithEvents.prototype.cleanup.call(this)},_callOwnMethods:function(e){var t=e instanceof RegExp,i,r={};for(var n in this){if(typeof this[n]==="function"&&(t?n.match(t):n.indexOf(e)===0)){i=i||Array.prototype.slice.call(arguments,1);r[n]=this[n].apply(this,i)}}return r},setComponent:function(e){if(!e)e=null;if(e==="root")e=Amm.getRoot();if(e)Amm.is(e,"Component","component");var t=this._component;if(t===e)return;this._component=e;if(e){e.acceptElements([this])}this._callOwnMethods("_setComponent_",e,t);this._setClosestComponent();this.outComponentChange(e,t);return true},getComponent:function(){return this._component},outComponentChange:function(e,t){this._out("componentChange",e,t)},getClosestComponent:function(){return this._component},_setClosestComponent:function(){var e=this._closestComponent;this._closestComponent=this.getClosestComponent();if(e!==this._closestComponent){this._callOwnMethods("_setClosestComponent_",this._closestComponent,e);this.outClosestComponentChange(this._closestComponent,e)}},outClosestComponentChange:function(e,t){return this._out("closestComponentChange",e,t)},_findChildElementsRecursive:function(e){var t=[];for(var i=0,r=e.length;i<r;i++){var n=e[i];if(n.Component&&n.getIsComponent())continue;t=t.concat(n.findChildElements(true))}return t},findChildElements:function(e){var t=[];this._callOwnMethods("_findChildElements_",t);if(e)t=t.concat(this._findChildElementsRecursive(t));return t},setProperties:function(e){if(!e||typeof e!=="object"){throw Error("`properties` must be an object")}var t=[];for(var i in e)if(e.hasOwnProperty(i)){var r=e[i],n=undefined;if(i.slice(0,4)==="in__"){i=i.slice(4);t.push([i,r,Amm.Element.EXPROP_IN]);r=undefined}else if(r&&typeof r==="object"&&("onChange"in r||"defaultValue"in r||"in__"in r)){if("in__"in r){t.push([i,r.in__])}n=r.onChange;r=r.defaultValue}Amm.createProperty(this,i,r,n)}if(t.length)this._initInProperties(t)},_initInProperties:function(e){for(var t=0,i=e.length;t<i;t++){var r=e[t][0];var n=e[t][1];var s=e[t][2];var o=r.split("__");if(o.length>1){r=o[0];o=o.slice(1)}else{o=undefined}this._createExpression(n,r,o,s)}},_createExpression:function(e,t,i,r){var n;var s,o;if(typeof e==="function"){s=e}else if(typeof e==="string"&&e.slice(0,11)==="javascript:"){var a=this._prepareFunctionHandlerBody(e.slice(11));s=Function("g","s",a)}else if(typeof e==="string"){o={src:e}}else if(e&&typeof e==="object"){o=e}else{throw Error("Expression-property (in__`prop`, sync__`prop`, expr__`prop`) "+"must be a string, function or Amm.Expression prototype")}if(s){if(r!==Amm.Element.EXPROP_IN){throw Error("javascript function handler can be used only for in__`prop` expressions")}n=new Amm.Expression.FunctionHandler(s,this,t,undefined,i);return n}if(!o)throw Error("Logic error");if(o["Amm.Expression"])return o;var l=r===Amm.Element.EXPROP_SYNC?Amm.Expression.Sync:Amm.Expression;if(o["class"])l=Amm.getFunction(o["class"]);var h=t;if(r===Amm.Element.EXPROP_EXPR)h=undefined;n=new l(o,this,h,undefined,i);if(r===Amm.Element.EXPROP_EXPR){this._configureExprExpression(n,t)}Amm.is(n,r===Amm.Element.EXPROP_SYNC?"Amm.Expression.Sync":"Amm.Expression","expression");return n},_configureExprExpression:function(t,r){var e=r.charAt(0).toUpperCase()+r.slice(1);var i="get"+e;var n="set"+e;var s="out"+e+"Change";var o="_"+r;var a=[];if(i in this)a.push(i);if(n in this)a.push(n);if(s in this)a.push(s);if(o in this)a.push(o);if(a.length){throw Error("Cannot define expr__"+r+" expression-property: "+"memeber(s) '"+a.join("', '")+" already defined")}this[i]=function(){return t.getValue()};this[n]=function(e){return t.setValue(e)};this[s]=function(e,t,i){return this._out(r+"Change",e,t,i)};t.subscribe("valueChange",this[s],this);this[o]=t},_prepareFunctionHandlerBody:function(e){var i=false,r="";var t=function(e){if(e==="{:"){if(i)throw Error("Cannot nest {: in function template");i=true;return""}else if(e===":}"){if(!i)throw Error(":} without opening {: in function template");i=false;var t="g('"+r.replace(/(['"\\])/g,"\\$1")+"')";r="";return t}else if(i){r+=e;return""}return e};var n=e.replace(/([{]:|:[}]|:|[{}]|[^:{}]+)/g,t);return n},outViewAdded:function(e){this._out("viewAdded",e)},outViewDeleted:function(e){this._out("viewDeleted",e)},outViewReady:function(e){this._out("viewReady",e)},findView:function(e,t){var i=this.getUniqueSubscribers("Amm.View.Abstract");for(var r=0,n=i.length;r<n;r++){if(e!==undefined&&i[r].id!==e)continue;if(t!==undefined&&!Amm.is(i[r],t))continue;return i[r]}},_getDefaultTraits:function(){return[]},constructDefaultViews:function(){}};Amm.extend(Amm.Element,Amm.WithEvents);Amm.Builder=function(e,t){this.selIgnore+=", ["+Amm.domHolderAttribute+"]";this.elements=[];this.topLevel=[];this.problems=[];if(e&&e.jquery||typeof e==="string"){this.selector=e}else if(!t&&e&&typeof e==="object"){t=e;e=null}if(t)Amm.init(this,t)};Amm.Builder._EXT_NOT_FOUND={};Amm.Builder.PROBLEM_SILENT=0;Amm.Builder.PROBLEM_CONSOLE=1;Amm.Builder.PROBLEM_HTML=2;Amm.Builder.TOP_LEVEL_ROOT="root";Amm.Builder.problemReportMode=Amm.Builder.PROBLEM_SILENT;Amm.Builder._scanId=1;Amm.Builder.prototype={_globalIds:null,selector:null,problemReportMode:undefined,sel:"[data-amm-id], [data-amm-e], [data-amm-v], [data-amm-x]",selIgnore:"[data-amm-dont-build], [data-amm-dont-build] *, [data-amm-built]",topLevelComponent:null,rememberElements:false,rememberProblems:false,elements:null,topLevel:null,reportMode:Amm.Builder.PROBLEM_CONSOLE|Amm.Builder.PROBLEM_HTML,problems:null,_parent:null,calcPrototypes:function(){return this.build(true)},calcViewPrototypes:function(e){var t,i;var r=this._parent;if(e){this._parent=new Amm.Builder.Node({e:e});if(Amm.getClass(e)){Amm.is(e,"Amm.Element","forElement");this._parent.id=e.getId()}else{this._parent.id=e.id||null}}else{this._parent=new Amm.Builder.Node({e:{}})}try{i=this.build(true);if(i.length!==1||!i[0].views||!i[0].views.length){console.log({fe:e,ep:i});var n;if(i.length!==1)n="found "+i.length+" top-level elements";else if(!i[0].views||!i[0].views.length)n="no views defined for top-level element";throw new Error("Amm.Builder: cannot calcViewPrototypes(): "+n)}t=i[0].views;if(e){for(var s=0;s<t.length;s++)t[s].element=e}}catch(e){this._parent=r;throw e}this._parent=r;return t},build:function(e){var t=this.selector;var i=this._globalIds;this._globalIds={};var r=this._scanNodes(t),n=[];var s=[];this._detectConnectedRecursive(r);for(var o=0,a=r.length;o<a;o++){n=n.concat(this._buildElements(r[o],s,e))}if(this.rememberElements){if(n.length)this.elements.push.apply(this.elements,n);if(s.length)this.topLevel.push.apply(this.topLevel,s)}this._globalIds=i;if(e)return s;return n},clear:function(){this.elements=[];this.topLevel=[];this.problems=[]},_scanNodes:function(e){if(!e)e=window.document.documentElement;var r="_amm_builder_scn_"+Amm.Builder._scanId++;var t=[],n=[],s=this;var i=jQuery(e).filter(this.sel).add(jQuery(e).find(this.sel)).not(this.selIgnore);i.each(function(e,t){var i=s._createNode(t);t[r]=n.length;n.push(i)});if(this._parent){t.push(this._parent)}for(var o=0,a=n.length;o<a;o++){var l=n[o];var h=l.htmlElement;var u=jQuery(h).parent().closest(this.sel)[0];if(u&&u[r]!==undefined){l.parent=n[u[r]];n[u[r]].children.push(l)}else{if(this._parent){l.parent=this._parent;this._parent.children.push(l)}t.push(l)}}return t},getExtData:function(e,t,i){if(i===undefined)i=Amm.Builder._EXT_NOT_FOUND;if(!(t instanceof Array))t=(""+t).split(".");var r=e,n,s=[].concat(t);while((n=s.shift())!==undefined){if(typeof r!=="object"||!(n in r))return i;r=r[n]}return r},_replaceRefsAndInstaniateObjects:function(e,t){if(!e||typeof e!=="object")return e;var i,r;if("$ref"in e)return new Amm.Builder.Ref(e,t);if("$ext"in e){var n=this.getExtData(window,e.$ext);if(n===Amm.Builder._EXT_NOT_FOUND)throw Error("Cannot resolve '$ext' "+e.$ext);if(e["$resolve"])e=n;else return n}if(e instanceof Array){for(i=0,r=e.length;i<r;i++){if(e[i]&&typeof e[i]==="object")e[i]=this._replaceRefsAndInstaniateObjects(e[i],t)}}else{for(i in e)if(e.hasOwnProperty(i)&&e[i]&&typeof e[i]==="object"){e[i]=this._replaceRefsAndInstaniateObjects(e[i],t)}if("__construct"in e){var s=e.__construct;delete e.__construct;e=Amm.constructInstance(e,s)}}return e},_createNode:function(e){var t=window.RJSON||window.JSON;var i=new Amm.Builder.Node,r;i.htmlElement=e;r=e.getAttribute("data-amm-v");if(r&&r.length){i.v=this._replaceRefsAndInstaniateObjects(t.parse(r),i.htmlElement);if(!(i.v instanceof Array))i.v=i.v?[i.v]:[];for(var n=0,s=i.v.length;n<s;n++){if(typeof i.v[n]==="string"){i.v[n]={class:i.v[n]}}i.v[n].htmlElement=e}}r=e.getAttribute("data-amm-e");if(r&&r.length)i.e=this._replaceRefsAndInstaniateObjects(t.parse(r),i.htmlElement);r=e.getAttribute("data-amm-id");if(r&&r.length){r=r.replace(/^\s+|\s+$/g,"");if(r[0]==="@"&&r[1]){i.global=true;r=r.slice(1);if(!this._globalIds[r])this._globalIds[r]=[i];else this._globalIds[r].push(i)}}if(r&&r.length){i.id=r;i.connected.id=r}r=e.getAttribute("data-amm-x");if(r&&r.length)i.x=this._replaceRefsAndInstaniateObjects(t.parse(r),i.htmlElement);return i},_connect:function(e,t){if(e.e||t.e)e.connected.groupHasElement=true;var i=e.connected.length;var r;r=Amm.Array.diff(t.connected,e.connected);e.connected.push.apply(e.connected,r);if(t.connected.groupHasElement)e.connected.groupHasElement=true;if(t.connected.id&&!e.connected.id)e.connected.id=t.connected.id;if(t.connected.alreadyBuilt)e.connected.alreadyBuilt=t.connected.alreadyBuilt;t.connected=e.connected;for(var n=i,s=e.connected.length;n<s;n++){t.connected[n].conIdx=n;t.connected[n].connected=t.connected}},_detectChildrenConnectedByIds:function(e,t){if(!e.id)return;for(var i=0,r=t.children.length;i<r;i++){var n=t.children[i];if(n===e)continue;if(n.id&&n.id!==e.id){continue}if(n.id===e.id){this._connect(e,n)}this._detectChildrenConnectedByIds(e,n)}},_detectConnectedNodes:function(e){var t,i;if(e.id){if(e.global&&(i=this._globalIds[e.id])){for(var r=0,n=i.length;r<n;r++){if(i[r]!==e)this._connect(e,i[r])}}for(t=e.parent;t;t=t.parent){if(e.id==="__parent"){e.id=null;this._connect(e,t)}if(t.id===e.id)this._connect(e,t);this._detectChildrenConnectedByIds(e,t)}}this._detectConnectedRecursive(e.children);t=e.parent;if(t&&((e.v||e.x)&&!e.e||(t.v||t.x)&&!t.e)){if(t&&t.children.length===1){var s=!!(e.e||e.connected.groupHasElement);var o=!!(t.e||t.connected.groupHasElement);var a=!(s&&o);if(a&&(!t.id||!e.id)&&(t.e||t.v||t.x)){this._connect(t,e);e.conParent=true;t.conChild=true}}}},_getAllViews:function(e){var t=e.v;if(!t)t=[];for(var i=0,r=e.connected.length;i<r;i++){if(e.connected[i]!==e)if(e.connected[i].v){t=t.concat(e.connected[i].v)}}return t},_detectConnectedRecursive:function(e){for(var t=0,i=e.length;t<i;t++){this._detectConnectedNodes(e[t])}},_buildElements:function(e,t,i){var r=[];for(var n=0,s=e.children.length;n<s;n++){r=r.concat(this._buildElements(e.children[n],t,i))}if(!e.e&&e.connected.length>1){if(e.connected.id!==undefined)e.id=e.connected.id;if(e.connected.groupHasElement){return r}else{if(e.conIdx<e.connected.length-1){return r}}if(e.connected.alreadyBuilt)return r}var o=e.e||{};var a;if(o["Amm.Element"]){if(!e.connected.views)e.connected.views=[];a=e.connected.views}else{if(!o.views)o.views=[];a=o.views}a.push.apply(a,this._getAllViews(e));if(!a.length)a.push({class:"Amm.View.Html.Default",reportMode:this.reportMode});for(var n=0,s=a.length;n<s;n++){if(!a[n].htmlElement){a[n].htmlElement=e.htmlElement}}if(e.id&&!o.id)o.id=e.id;if(!e.parent&&this.topLevelComponent&&!("component"in o)){o.component=this.topLevelComponent}this._applyExtensions(o,e);var l;if(o["Amm.Element"]){l={class:"Amm.Element",views:a}}else{l=Amm.override({class:"Amm.Element"},o)}if(!i){l=Amm.constructInstance(o,"Amm.Element")}if(t&&(!e.parent||e.parent===this._parent||e.conParent&&!e.parent.parent)){t.push(l)}r.push(l);e.connected.alreadyBuilt=true;return r},_applyExtensions:function(e,t){for(var i=0,r=t.connected.length;i<r;i++){if(t.connected[i].x){var n=this._parseExtensions(t.connected[i].x);for(var s=0,o=n.length;s<o;s++){var a=n[s].fn(t.connected[i].htmlElement,e,n[s].arg);if(a&&typeof a==="object")Amm.overrideRecursive(e,a)}}}},_getExtension:function(e){e=e.replace(/(\.|^)(\w+)$/,"$1builderExtension_$2");return Amm.getFunction(e)},_parseExtensions:function(e){if(typeof e==="string")return[{fn:this._getExtension(e),arg:undefined}];if(typeof e!=="object"){throw Error("data-amm-x must contain either string or an object")}var t=[];for(var i in e)if(e.hasOwnProperty(i)){t.push({fn:this._getExtension(i),arg:e[i]})}return t},_regProblem:function(e,t){if(e instanceof Array){for(var i=0,r=e.length;i<r;i++)this._regProblem(e[i],t);return}if(!e.htmlElement.hasAttribute(Amm.domHolderAttribute)){e.htmlElement.setAttribute(Amm.domHolderAttribute,"")}if(this.rememberProblems)this.problems.push({element:e.htmlElement,problem:t});if(this.reportMode&Amm.Builder.PROBLEM_CONSOLE){console.warn("Amm.Builder problem with HTML element",e.htmlElement,t)}if(this.reportMode&Amm.Builder.PROBLEM_HTML){this._annotate(e,t)}},_annotate:function(e,t){e.htmlElement.setAttribute("data-amm-warning",t)}};Amm.Builder.isPossibleBuilderSource=function(e){if(!e)return false;if(e["Amm.Builder.Ref"])return true;if(typeof e==="object"&&"parentNode"in e&&"tagName"in e)return true;if(e.jquery)return true;if(typeof e==="string"&&e.match(/^\<(?:.|[\n])*\>$/))return true;return false};Amm.Builder.calcPrototypeFromSource=function(e,t,i){if(!e)throw Error("`builderSource` is required");var r;if(typeof e==="string"){if(e.match(/\s*<(?:.|[\n])*>\s*$/))t=true;r=e}else if(e["Amm.Builder.Ref"]){r=e.resolve()}else if(e.tagName||e.jquery){r=e}else throw Error("Unsupported builderSource type: "+Amm.describeType(e));var n=jQuery(r);if(!n.length)throw Error("Cannot resolve builderSource reference");if(t===undefined)t=n.attr("data-amm-dont-build")===undefined;if(!t)n=n.clone();n.removeAttr("data-amm-dont-build");var s=new Amm.Builder(n);var o=i?s.calcViewPrototypes():s.calcPrototypes(true);if(!o.length)throw Error("Builder returned no prototypes");if(!i){if(o.length>1)throw Error("Builder returned more than one prototype");if(!o[0].class)o[0].class="Amm.Element";return o[0]}return o};Amm.Instantiator=function(){if(this["Amm.Instantiator"]==="__CLASS__"){throw Error("Attempt to instantiate abstract class")}};Amm.Instantiator.prototype={"Amm.Instantiator":"__CLASS__"};Amm.WithEvents.Proxy=function(){};Amm.WithEvents.Proxy.prototype={subscribeObject:function(e,t,i,r,n,s){return e.subscribe(t,i,r,n,s)},unsubscribeObject:function(e,t,i,r,n,s){return e.unsubscribe(t,i,r,n,s)},getObjectSubscribers:function(e,t,i,r,n,s){return e.getSubscribers(t,i,r,n,s)},getUniqueObjectSubscribers:function(e,t,i){return e.getUniqueSubscribers(t,i)},unsubscribeObjectByIndex:function(e,t,i){return e.unsubscribeByIndex(t,i)}};Amm.WithEvents.Proxy.instance=new Amm.WithEvents.Proxy;Amm.WithEvents.DispatcherProxy=function(e){this._subscriptions=[];Amm.init(this,e)};Amm.WithEvents.DispatcherProxy.ANY={};Amm.WithEvents.DispatcherProxy.SKIP_CALL_HANDLER={};Amm.WithEvents.DispatcherProxy.SimpleCompareExtra=function(e,t){if(e===Amm.WithEvents.DispatcherProxy.ANY)return 0;if(t===Amm.WithEvents.DispatcherProxy.ANY)return 0;return e===t?0:-1};Amm.WithEvents.DispatcherProxy.ArrCompareExtra=function(e,t){if(e===Amm.WithEvents.DispatcherProxy.ANY)return 0;if(t===Amm.WithEvents.DispatcherProxy.ANY)return 0;if(!(e instanceof Array)||!(t instanceof Array))return-1;if(e.length!==t.length)return-1;for(var i=0,r=e.length;i<r;i++){if(e[i]===Amm.WithEvents.DispatcherProxy.ANY){continue}if(t[i]===Amm.WithEvents.DispatcherProxy.ANY){continue}if(e[i]!==t[i])return-1}return 0};Amm.WithEvents.DispatcherProxy.prototype={"Amm.WithEvents.DispatcherProxy":"__CLASS__",_eventsProxy:Amm.WithEvents.Proxy.instance,_subscriptions:null,scope:null,beforeDispatch:null,afterDispatch:null,beforeCallHandler:null,afterCallHandler:null,beforeCallHandlerReturnsNewExtra:false,compareExtra:Amm.WithEvents.DispatcherProxy.ArrCompareExtra,setEventsProxy:function(e){Amm.is(e,Amm.WithEvents.Proxy,"eventsProxy");this._eventsProxy=e},getEventsProxy:function(){return this._eventsProxy},doCallHandler:function(e,t,i,r){var n=e[1],s=e[0],o=e[3];var a=[].concat(i);if(o){a=o.call(o,t,a,s,n,r,this);if(!(a instanceof Array))return}if(!s.apply)s=n[s];if(r!==undefined)a.push(r);s.apply(n,a)},dispatchEvent:function(){var e=arguments[arguments.length-1],t=Array.prototype.slice.call(arguments,0,-1);if(!e.eventName)Error("Queue array (extra) not provided to Amm.WithEvents.DispatcherProxy.dispatchEvent method");var i=e.eventName;if(this.beforeDispatch){if(this.scope)this.beforeDispatch.call(this.scope,e.eventName,e,arguments);else this.beforeDispatch(e.eventName,e,arguments)}for(var r=0;r<e.length;r++){var n=e[r][2];if(this.beforeCallHandler){var s;if(this.scope)s=this.beforeCallHandler.call(this.scope,e.eventName,e,arguments,r,n);else s=this.beforeCallHandler(e.eventName,e,arguments,r,n);if(s===Amm.WithEvents.DispatcherProxy.SKIP_CALL_HANDLER)continue;if(this.beforeCallHandlerReturnsNewExtra)n=s}if(!n)n=undefined;this.doCallHandler(e[r],e.eventName,t,n);if(this.afterCallHandler){if(this.scope)this.afterCallHandler.call(this.scope,e.eventName,e,arguments,r,n);else this.afterCallHandler(e.eventName,e,arguments,r,n)}}if(this.afterDispatch){if(this.scope)this.afterDispatch.call(this.scope,e.eventName,e,arguments);else this.afterDispatch(e.eventName,e,arguments)}},subscribeObject:function(e,t,i,r,n,s){var o=this._eventsProxy.getObjectSubscribers(e,t,this.dispatchEvent,this);var a;if(o.length>1)Error("Assertion: Amm.WithEvents.DispatcherProxy.dispatchEvent handler must be subscribed only once");if(n===undefined)n=null;if(s===undefined)s=null;if(r===undefined)r=null;if(!o.length){this._subscriptions.push(e);a=[[i,r,n,s]];a.eventName=t;this._eventsProxy.subscribeObject(e,t,this.dispatchEvent,this,a);return}a=o[0][2];if(!a||a.eventName!==t){Error("Assertion: we found wrong queue array")}for(var l=0,h=a.length;l<h;l++){if(a[l][0]===i&&a[l][1]===r&&!this.compareExtra(a[l][2],n)&&a[l][3]===s)return}a.push([i,r,n,s])},unsubscribeObject:function(e,t,i,r,n,s){if(!e)Error("`object` parameter is required");var o=this._eventsProxy.getObjectSubscribers(e,t,this.dispatchEvent,this);var a=0;if(!o.length)return 0;if(t&&o.length>1)throw Error("Assertion: Amm.WithEvents.DispatcherProxy.dispatchEvent handler must be subscribed only once");for(var l=0,h=o.length;l<h;l++){var u=o[l][2];if(!u||!u.eventName||t&&u.eventName!==t)Error("Assertion: we found wrong queue array");for(var f=u.length-1;f>=0;f--){if((i===undefined||u[f][0]===i)&&(r===undefined||u[f][1]===r)&&(n===undefined||!this.compareExtra(u[f][2],n))&&(s===undefined||u[f][3]===s)){u.splice(f,1)}else{a++}}if(!u.length){this._removeQueue(e,o[l][4],o[l][5])}}return a},getObjectSubscribers:function(e,t,i,r,n,s){if(!e)Error("`object` parameter is required");var o=this._eventsProxy.getObjectSubscribers(e,t,this.dispatchEvent,this);if(!o.length)return 0;if(t!==undefined&&o.length>1)Error("Assertion: Amm.WithEvents.DispatcherProxy.dispatchEvent handler must be subscribed only once");var a=[];for(var l=0,h=o.length;l<h;l++){var u=o[l][4],f=o[l][2];if(!f||!f.eventName||f.eventName!==u)Error("Assertion: we found wrong queue array");for(var c=f.length-1;c>=0;c--){if((i===undefined||f[c][0]===i)&&(r===undefined||f[c][1]===r)&&(n===undefined||!this.compareExtra(f[c][2],n))&&(s===undefined||f[c][3]===s)){a.push([].concat(f[c],[u,c]))}}}return a},getUniqueObjectSubscribers:function(e,t,i){var r=this.getObjectSubscribers(e,undefined);var n=[];for(var s=0,o=r.length;s<o;s++){var a=r[j][1];if(!a)continue;if(t===undefined||Amm.is(a,t))n.push(a)}return Amm.Array.unique(n)},_removeQueue:function(e,t,i){this._eventsProxy.unsubscribeObjectByIndex(e,t,i);var r=this._eventsProxy.getObjectSubscribers(e,undefined,this.dispatchEvent,this);if(!r.length){var n=Amm.Array.indexOf(this._subscriptions,e);if(n>=0)this._subscriptions.splice(n,1)}},unsubscribeObjectByIndex:function(e,t,i){var r=this._eventsProxy.getObjectSubscribers(e,t,this.dispatchEvent,this);if(!r.length)return[];if(r.length>1)Error("Assertion: Amm.WithEvents.DispatcherProxy.dispatchEvent handler must be subscribed only once");var n=r[0][2];if(!n.eventName||n.eventName!==t){throw Error("Assertion: we found wrong queue array")}if(!n[i])return[];var s=[[].concat(n[i],[t,i])];n.splice(i);if(!n.length){this._removeQueue(e,t,r[0][5])}return s}};Amm.extend(Amm.WithEvents.DispatcherProxy,Amm.WithEvents.Proxy);Amm.Translator=function(e){Amm.init(this,e)};Amm.Translator.prototype={"Amm.Translator":"__CLASS__",lastError:null,errInValue:null,errOutValue:null,reverseMode:null,field:undefined,trimInStrings:false,decorateBeforeValidate:false,_inDecorator:null,_outDecorator:null,_inValidator:null,_outValidator:null,_implTranslate:function(e,t,i,r,n,s,o){this.lastError=null;if(!(r&&typeof r==="object"))r={};r.error=null;var a;if(n){if(this.trimInStrings&&typeof e==="string"){e=Amm.Util.trim(e)}}if(o&&this.decorateBeforeValidate){try{e=o.decorate(e)}catch(e){r.error=this.lastError=e;return t}}if(s){this.lastError=s.getError(e,this.field);if(this.lastError){r.error=this.lastError;return t}}if(o&&!this.decorateBeforeValidate){try{e=o.decorate(e)}catch(e){r.error=this.lastError=e;return t}}try{a=this[i](e)}catch(e){this.lastError=e}if(this.lastError){a=t}r.error=this.lastError;return a},decorate:function(e){return this.translateIn(e)},translateIn:function(e,t){if(this.reverseMode){return this._implTranslate(e,this.errOutValue,"_doTranslateOut",t,false,this._outValidator,this._outDecorator)}return this._implTranslate(e,this.errInValue,"_doTranslateIn",t,true,this._inValidator,this._inDecorator)},translateOut:function(e,t){if(this.reverseMode){return this._implTranslate(e,this.errInValue,"_doTranslateIn",t,false,this._inValidator,this._inDecorator)}return this._implTranslate(e,this.errOutValue,"_doTranslateOut",t,false,this._outValidator,this._outDecorator)},_doTranslateIn:function(e){return e},_doTranslateOut:function(e){return e},setInDecorator:function(e){var t=this._inDecorator;if(t===e)return;if(e)e=Amm.Decorator.construct(e,"Amm.Decorator");this._inDecorator=e;return true},getInDecorator:function(){return this._inDecorator},setOutDecorator:function(e){var t=this._outDecorator;if(t===e)return;if(e)e=Amm.Decorator.construct(e,"Amm.Decorator");this._outDecorator=e;return true},getOutDecorator:function(){return this._outDecorator},setInValidator:function(e){var t=this._inValidator;if(t===e)return;if(e)e=Amm.Validator.construct(e);this._inValidator=e;return true},getInValidator:function(){return this._inValidator},setOutValidator:function(e){var t=this._outValidator;if(t===e)return;if(e)e=Amm.Validator.construct(e);this._outValidator=e;return true},getOutValidator:function(){return this._outValidator}};Amm.extend(Amm.Translator,Amm.Decorator);Amm.Translator.Bool=function(e){Amm.Translator.call(this,e)};Amm.Translator.Bool.prototype={"Amm.Translator.Bool":"__CLASS__",trueValue:"lang.Amm.True",falseValue:"lang.Amm.False",errorMsg:"lang.Amm.Translator.Bool.msg",caseSensitive:false,trimInStrings:true,guess:true,defaultValue:false,setStrictMode:function(e){if(e){this.caseSensitive=true;this.trimInStrings=false;this.defaultValue=undefined;this.guess=false}else{this.caseSensitive=false;this.trimInStrings=true;this.defaultValue=false;this.guess=true}},getStrictMode:function(){if(this.caseSensitive&&!this.trimInStrings&&this.defaultValue===undefined&&!this.guess){return true}else if(!this.caseSensitive&&this.trimInStrings&&this.defaultValue!==undefined&&this.guess){return false}return undefined},_doTranslateOut:function(e){return Amm.translate(e?this.trueValue:this.falseValue)},_doTranslateIn:function(e){var t;if(this._cmp(e,Amm.translate(this.trueValue)))t=true;else if(this._cmp(e,Amm.translate(this.falseValue)))t=false;else if(this.guess){if(e==="0")t=false;else t=!!e}else if(this.defaultValue!==undefined)t=this.defaultValue;else this.lastError=Amm.translate(this.errorMsg,"%value",e);return t},_cmp:function(e,t){if(!this.caseSensitive){e=(""+e).toLowerCase();t=(""+t).toLowerCase()}return e===t}};Amm.extend(Amm.Translator.Bool,Amm.Translator);Amm.defineLangStrings({"lang.Amm.True":"True","lang.Amm.False":"False","lang.Amm.Translator.Bool.msg":"'%value' isn't allowed Boolean value"});Amm.Translator.List=function(e){Amm.Translator.call(this,e)};Amm.Translator.List.prototype={"Amm.Translator.List":"__CLASS__",_enclosureElement:"<ul></ul>",_itemElement:"<li></li>",emptyOutValue:null,itemSelector:null,_cachedItemSelector:null,allowHTML:true,strict:false,msgInvalidInValueStrict:"Amm.Translator.List.msgInvalidInValueStrict",msgInvalidInValueNonStrict:"Amm.Translator.List.msgInvalidInValueNonStrict",msgInvalidOutValue:"Amm.Translator.List.msgInvalidOutValue",_cacheValues:null,_lastInValue:null,_lastOutValue:null,setCacheValues:function(e){var t=this._cacheValues;if(t===e)return;this._cacheValues=e;return true},getCacheValues:function(){return this._cacheValues},setItemElement:function(e){var t=this._itemElement;if(t===e)return;if(!e)Error("itemElement is required");if(typeof e!=="string")Error("itemElement must be a string");if(!e.match(/^<.*>$/))Error("itemElement must be a jQuery-compatible HTML element definition");this._itemElement=e;this._cachedItemSelector=null;return true},getItemElement:function(){return this._itemElement},setEnclosureElement:function(e){var t=this._enclosureElement;if(t===e)return;if(e){if(typeof e!=="string")Error("enclosureElement must be a string");if(!e.match(/^<.*>$/))Error("enclosureElement must be a jQuery-compatible HTML element definition")}else{e=""}this._enclosureElement=e;return true},getEnclosureElement:function(){return this._enclosureElement},_doTranslateOut:function(e){if(!this.strict){if(!e)e=[];else if(typeof e==="string")e=[e]}if(!(e instanceof Array||e["Amm.Array"])){var t=this.strict?this.msgInvalidInValueStrict:this.msgInvalidInValueNonStrict;this.lastError=Amm._msg(t,"%type",Amm.describeType(e));return}if(!e.length&&this.emptyOutValue!==null)return this.emptyOutValue;var i=[];if(!this._itemElement)throw Error("itemElement not set");var r="",n;for(var s=0,o=e.length;s<o;s++){var n=jQuery(this._itemElement);if(this.allowHTML)n.html(e[s]);else n.text(e[s]);if(!this._enclosureElement)r+=n[0].outerHTML;else i.push(n)}if(n&&n[0]&&!this._cachedItemSelector&&!this.itemSelector){this._extractItemSelector(n[0])}if(this._enclosureElement)return jQuery(this._enclosureElement).append(i)[0].outerHTML;else return r},_doTranslateIn:function(e){if(e===this.emptyOutValue)return[];if(!e)return[];if(!(e&&(e.jquery||e.nodeName||typeof e==="string"))){this.lastError=Amm._msg(this.msgInvalidOutValue,"%type",Amm.describeType(e))}var t=this.itemSelector||this._cachedItemSelector;if(!t){var i=jQuery(this._itemElement);t=this._extractItemSelector(i[0])}var r=[],n=this.allowHTML;var s=jQuery(e).find(t).addBack(t).each(function(e,t){r.push(n?jQuery(t).html():jQuery(t).text())});return r},_extractItemSelector:function(e){var t;this._cachedItemSelector=e.tagName.toLowerCase();if(t=e.getAttribute("class"))this._cachedItemSelector+="."+t;if(t=e.getAttribute("id"))this._cachedItemSelector+="#"+t;return this._cachedItemSelector}};Amm.extend(Amm.Translator.List,Amm.Translator);Amm.defineLangStrings({"Amm.Translator.List.msgInvalidInValueStrict":"unsupported external value: %type provided, Array or Amm.Array expected","Amm.Translator.List.msgInvalidInValueNonStrict":"unsupported external value: %type provided, Array, Amm.Array, string or FALSEable value expected","Amm.Translator.List.msgInvalidOutValue":"internal value must be either string or FALSEable value or jQuery result or DOM Element, but %type was provided"});Amm.Translator.Errors=function(e){Amm.Translator.List.call(this,e)};Amm.Translator.Errors.prototype={"Amm.Translator.Errors":"__CLASS__",_enclosureElement:'<ul class="errors"></ul>',_itemElement:'<li class="error"></li>',emptyOutValue:"",itemSelector:".error",strict:false,allowHTML:false};Amm.extend(Amm.Translator.Errors,Amm.Translator.List);Amm.Translator.RequiredMark=function(e){Amm.Translator.Bool.call(this,e)};Amm.Translator.RequiredMark.prototype={"Amm.Translator.RequiredMark":"__CLASS__",trueValue:'<span class="required">*</span>',falseValue:""};Amm.extend(Amm.Translator.RequiredMark,Amm.Translator.Bool);Amm.FilterSorter=function(e){this._observers=[];this._objects=[];this._matches=[];this._deferredChanges=[];Amm.WithEvents.DispatcherProxy.call(this);Amm.WithEvents.call(this,e)};Amm.FilterSorter.prototype={"Amm.FilterSorter":"__CLASS__",_observers:null,_objects:null,_matches:null,_deferredChanges:null,_updateLevel:0,_compareMatch:null,_requireAll:false,_cacheMatches:false,_cacheProp:null,getObservedObjects:function(){return[].concat(this._objects)},setObservedObjects:function(e){var t,i,r;if(!e)e=[];else e=Amm.Array.unique(e);var n=Amm.Array.calcChanges(this._objects,e,null,0,true);if(!n.added.length&&!n.deleted.length)return;this.beginUpdate();if(n.deleted.length){var s=[],o=[],a={};for(t=n.deleted.length-1;t>=0;t--){s.unshift(n.deleted[t][0]);r=this._matches[n.deleted[t][1]];o.unshift(r);this._objects.splice(t,1);this._matches.splice(t,1);a[n.deleted[t][1]]=true;this._deferredChanges.push([undefined,r,n.deleted[t]])}for(t=this._deferredChanges.length-n.deleted.length;t>=0;t--){if(a[this._deferredChanges[t][0]])this._deferredChanges.splice(t,1)}if(this._cacheMatches)this._deleteCachedMatches(s);this._unsubObservers(s,undefined,true);this.outObjectsUnobserved(s,o)}if(n.added.length){var l=[],h=[],u=[];for(t=0,i=n.added.length;t<i;t++){l.push(n.added[t][0]);r=this.evaluateMatch(n.added[t][0]);this._matches.push(r);h.push(r);u.push(this._objects.length+t);this._deferredChanges.push([this._objects.length+t,undefined,n.added[t][0]])}this._objects.push.apply(this._objects,l);if(this._cacheMatches){this._saveCachedMatches(u)}this._subObservers(l,undefined,false,true);this.outObjectsObserved(l,h)}this.endUpdate()},getMatches:function(){return[].concat(this._matches)},_subObservers:function(e,t,i,r){e=e||this._objects;t=t||this._observers;var n,s,o=i?"unobserve":"observe";for(n=0,s=t.length;n<s;n++){t[n][o](e)}if(!r)return;o=i?"unsubscribeObject":"subscribeObject";for(n=0,s=e.length;n<s;n++){var a=e[n];if(!(a["Amm.WithEvents"]&&a.hasEvent("cleanup")))continue;this[o](a,"cleanup",this._handleObjectCleanup,this)}},_handleObjectCleanup:function(){var e=Amm.event.origin;this.unobserveObject(e)},beforeDispatch:function(e,t,arguments){if(t.length>1||t[0][1]&&t[0][1]["Amm.Expression"]){this.beginUpdate()}},afterDispatch:function(e,t,arguments){if(t.length>1||t[0][1]&&t[0][1]["Amm.Expression"]){this.endUpdate()}},_unsubObservers:function(e,t,i){return this._subObservers(e,t,true,i)},beginUpdate:function(){this._updateLevel++},_hasChangeSubscribers:function(){return this._subscribers.matchesChange},endUpdate:function(){if(!this._updateLevel)throw Error("call to endUpdate() without prior beginUpdate()");if(this._updateLevel>1){this._updateLevel--;return}if(!this._hasChangeSubscribers()){this._deferredChanges=[];this._updateLevel--;return}var e={},t=[],i=[],r=[],n;for(var s=this._deferredChanges.length-1;s>=0;s--){n=this._deferredChanges[s][0];if(n!==undefined){if(e[n])continue;e[n]=true}var o=this._deferredChanges[s][1],a=this._deferredChanges[s][2],l=this._matches[n];if(o===l||this._compareMatch&&!this._compareMatch(o,l))continue;t.unshift(a);r.unshift(o);i.unshift(l)}this._deferredChanges=[];this._updateLevel--;if(!t.length)return;this.outMatchesChange(t,i,r);this._doOnEndUpdateChange()},_doOnEndUpdateChange:function(){},getUpdateLevel:function(){return this._updateLevel},getMatch:function(e,t){if(this._cacheMatches){var i=this._getCachedMatch(e);if(i!==undefined)return i}var r=Amm.Array.indexOf(e,this._objects);if(r>=0)return this._matches[r];if(t)return this.evaluateMatch(e);return undefined},refresh:function(e){if(e){var t=Amm.Array.indexOf(e,this._objects);if(t<0)throw Error("`object` not observed, cannot refresh()");var i=this.evaluateMatch(e);this._updateMatch(t,i)}else{this.beginUpdate();this._deferredChanges=[];for(var r=0,n=this._objects.length;r<n;r++){var s=this.evaluateMatch(this._objects[r]);this._updateMatch(r,s)}this.endUpdate()}},_doOnUpdateMatch:function(e,t,i){},_updateMatch:function(e,t){var i=this._matches[e];if(i===t||this._compareMatch&&!this._compareMatch(i,t))return;if(this._updateLevel){this._deferredChanges.push([e,i,this._objects[e]])}this._matches[e]=t;if(this._cacheMatches)this._saveCachedMatches([e]);if(this._updateLevel)return;this.outMatchesChange([this._objects[e]],[t],[i]);this._doOnUpdateMatch(e,i,t)},evaluateMatch:function(e){return null},observeObject:function(e){var t=Amm.Array.indexOf(e,this._objects),i;if(t>=0)return this._matches[t];this._objects.push(e);this._subObservers([e],undefined,false,true);i=this.evaluateMatch(e);for(var r=this._deferredChanges.length-1;r>=0;r--){if(this._deferredChanges[r][0]===undefined&&this._deferredChanges[r][2]===e){this._matches[this._objects.length-1]=this._deferredChanges[r][1];this._deferredChanges.splice(r,1)}}this._updateMatch(this._objects.length-1,i);this.outObjectsObserved([e],[i]);return i},unobserveObject:function(e){var t=Amm.Array.indexOf(e,this._objects);var i;if(t<0)return;if(this._cacheMatches)this._deleteCachedMatches([e]);var r=this._matches[t];this._objects.splice(t,1);this._matches.splice(t,1);if(r){i=this._matchingObjects;this._matchingObjects=null}for(var n=this._deferredChanges.length-1;n>=0;n--){if(this._deferredChanges[n][0]>t)this._deferredChanges[n][0]--;else if(this._deferredChanges[n][0]===t)this._deferredChanges.splice(n,1)}if(!this._updateLevel){this.outMatchesChange([e],[undefined],[r])}else{this._deferredChanges.push([undefined,r,e])}this._unsubObservers([e]);if(this._updateLevel)return;if(r&&this._subscribers.matchingObjectsChange)this.outMatchingObjectsChange(this.getMatchingObjects(),i);this.outObjectsUnobserved([e],[r]);return r},hasObservedObject:function(e){return Amm.Array.indexOf(e,this._objects)>=0},outObjectsObserved:function(e,t){this._out("objectsObserved",e,t)},outObjectsUnobserved:function(e,t){this._out("objectsUnobserved",e,t)},outMatchesChange:function(e,t,i){this._out("matchesChange",e,t,i)},_saveCachedMatches:function(e){if(!this._cacheMatches)return;if(e!==undefined&&!(e instanceof Array))e=[e];if(!this._cacheProp){Amm.registerItem(this);this._cacheProp="_Amm.FilterSorter."+this._amm_id;Amm.unregisterItem(this)}for(var t=0,i=e?e.length:this._objects.length;t<i;t++){var r=e?e[t]:t,n=this._objects[r],s=this._matches[r];n[this._cacheProp]=s}},_getCachedMatch:function(e){if(!e||!this._cacheProp)return undefined;return e[this._cacheProp]},_deleteCachedMatches:function(e){if(!this._cacheProp)return;for(var t=0,i=e.length;t<i;t++){delete e[t][this._cacheProp]}},setCacheMatches:function(e){e=!!e;var t=this._cacheMatches;if(t===e)return;this._cacheMatches=e;if(!e)this._deleteCachedMatches(this._objects);else this._saveCachedMatches();return true},getCacheMatches:function(){return this._cacheMatches},cleanup:function(){Amm.WithEvents.prototype.cleanup.apply(this);this._matches=[];this._unsubObservers();for(var e=0,t=this._observers.length;e<t;e++){this._observers[e].cleanup()}this._observers=[];this.setObservedObjects([])}};Amm.extend(Amm.FilterSorter,Amm.WithEvents.DispatcherProxy);Amm.extend(Amm.FilterSorter,Amm.WithEvents);Amm.Sorter=function(e){this._compareClosureFn=function(i){return function(e,t){return i.compareObjects(e,t)}}(this);Amm.FilterSorter.call(this,e)};Amm.Sorter.ascendingDescRx=/\s+(asc|desc)$/i;Amm.Sorter.propNameRx=/^\w+$/;Amm.Sorter.prototype={"Amm.Sorter":"__CLASS__",_needReorderCriteria:false,_parseAscendingDesc:true,_allowExpressions:true,_cacheMatches:true,_lockIndexes:0,_compareClosureFn:null,_directions:null,_deleteCriterion:function(e,t){if(!this._observers[e])return;var i=this._observers[e];this._unsubObservers(this._objects,[i]);i.cleanup();if(!t)return;this._innerShift(e,this._observers.length)},setCriteria:function(e,t){if(t!==undefined){var i=t;if(i<0)i=0;if(i>this._observers.length)i=this._observers.length;if(e){this._lockIndexes++;try{e=this._getCriterionPrototype(e,i)}catch(e){this._lockIndexes--;throw e}this._lockIndexes--}else{e=null}if(this._observers[i]){if(this._observers[i]===e)return;if(t>=0){this._deleteCriterion(i,!e);this._directions=null;this.refresh();return}}if(!e){this._directions=null;this.refresh();return true}if(t<0){this._innerShift(this._observers.length,0,true)}this._observers[i]=e;this._directions=null;this.refresh();return true}var r,n;try{this.beginUpdate();this._lockIndexes++;var s=[],o;if(!(e instanceof Array))e=[e];for(r=0,n=e.length;r<n;r++){o=this._getCriterionPrototype(e[r],r);s.push(o)}var a=Amm.constructMany(s,"Amm.Sorter.Criterion");a.sort(function(e,t){return e.getIndex()-t.getIndex()});for(var r=0,n=a.length;r<n;r++){a[r].setIndex(r)}for(r=0,n=this._observers.length;r<n;r++){this._observers[r].cleanup()}this._observers=a;if(this._objects.length){this._subObservers(this._objects)}}catch(e){this._lockIndexes--;this.endUpdate();throw e}this._lockIndexes--;this._directions=null;this.refresh();this.endUpdate()},getCriteria:function(e){if(e===undefined)return[].concat(this._observers);return this._observers[e]},_getCriterionPrototype:function(e,t){var i;if(e&&typeof e==="object"){if(e["Amm.Sorter.Criterion"]){if(e.getFilterSorter()!==this){throw Error("setCriteria(): `criteria["+t+"]` doesn't belong to current Sorter")}if(e.getIndex()===null)e.setIndex(t);i=e}else{i={}.override(e);if(typeof i.index!=="number")i.index=t}i.filterSorter=this;return i}var r,n=true;i={};if(typeof e!=="string")throw Error("`criteria["+t+"]` should be either string or object; given: "+Amm.describeType(e));if(this._parseAscendingDesc){r=Amm.Sorter.ascendingDescRx.exec(e);if(r){n=r[1].toLowerCase()==="asc";e=e.slice(0,-r[0].length)}}if(this._allowExpressions&&!Amm.Sorter.propNameRx.exec(e)){i.expression=e;i.class=Amm.Sorter.Expression}else{i.class=Amm.Sorter.Property;i.property=e}if(!("index"in i))i.index=t;i.ascending=n;i.filterSorter=this;return i},compareObjects:function(e,t){var i=this.getMatch(e,true);var r=this.getMatch(t,true);return this.compareMatches(i,r)},calcSortValue:function(e,t){return this.getMatch(e,true)},getCompareClosureFn:function(){return this._compareClosureFn},_innerShift:function(e,t,i){this._lockIndexes++;var r=e>t?-1:1;for(var n=e;n*r<t*r;n+=r){this._observers[n]=this._observers[n+r];if(i)this._observers[n].setIndex(n)}this._lockIndexes--},notifyCriterionIndexChanged:function(e,t,i){if(this._lockIndexes)return;if(this._observers[i]!==e){i=Amm.Array.indexOf(e,this._observers);if(i<0)throw Error("Provided criterion is not registered observer")}if(t<0)t=0;if(t>=this._observers.length)t=this._observers.length-1;if(t===i)return;this._innerShift(i,t,true);this._observers[t]=e;e.setIndex(t);this._lockIndexes--;this.refresh()},notifyCriterionDirectionChanged:function(e,t,i){if(this._directions){this._directions=null;this.outNeedSort()}},compareMatches:function(e,t){var i,r;if(!(e instanceof Array)&&t instanceof Array)throw Error("both matches must be Arrays");if(e.length!==t.length)throw Error("both matches must have same length");if(!this._directions){this._directions=[];for(i=0,r=this._observers.length;i<r;i++)this._directions.push(this._observers[i].getAscending())}var n;for(i=0,r=e.length;i<r;i++){if(e[i]===t[i])continue;if(e[i]<t[i])n=-1;else if(e[i]>t[i])n=1;else n=0;if(!this._directions[i])n=-1*n;return n}return 0},_compareMatch:function(e,t){if(e===t)return 0;if(!e||!t)return 1;if(!(e instanceof Array||e["Amm.Array"]))return 1;if(!(t instanceof Array||t["Amm.Array"]))return 1;return!Amm.Array.equal(e,t)},outNeedSort:function(){return this._out("needSort")},sort:function(e){var t;if(e&&e["Amm.Array"])t=e.getItems();else if(e&&e instanceof Array)t=e.slice();else throw Error("`objects` must be Array or Amm.Array");return t.sort(this._compareClosureFn)},evaluateMatch:function(e){if(!this._observers.length)return[];var t=[];for(var i=0,r=this._observers.length;i<r;i++){t.push(this._observers[i].getValue(e))}return t},_doOnEndUpdateChange:function(){this.outNeedSort()},_doOnUpdateMatch:function(e,t,i){this.outNeedSort()},_hasChangeSubscribers:function(){return this._subscribers.matchesChange||this._subscribers.needSort}};Amm.extend(Amm.Sorter,Amm.FilterSorter);Amm.FilterSorter.Observer=function(e,t){this._filterSorter=e;Amm.WithEvents.call(this,t,true)};Amm.FilterSorter.Observer.prototype={"Amm.FilterSorter.Observer":"__CLASS__",_filterSorter:null,match:function(e){return true},cleanup:function(e){this.unsubscribe();this._filterSorter=null;Amm.WithEvents.prototype.cleanup.call(this)},observe:function(e){},unobserve:function(e){}};Amm.extend(Amm.FilterSorter.Observer,Amm.WithEvents);Amm.Sorter.Criterion=function(e,t){if(t===undefined&&e&&typeof e==="object"&&e.filterSorter){t=e;e=t.filterSorter;delete t.filterSorter}Amm.FilterSorter.Observer.call(this,e,t);Amm.init(this,t)};Amm.Sorter.Criterion.prototype={"Amm.Sorter.Criterion":"__CLASS__",_index:null,_ascending:true,_defaultValue:null,setIndex:function(e){var t=this._index;if(t===e)return;this._index=e;this._filterSorter.notifyCriterionIndexChanged(this,e,t);this.outIndexChange(e,t);return true},getIndex:function(){return this._index},outIndexChange:function(e,t){this._out("indexChange",e,t)},setAscending:function(e){e=!!e;var t=this._ascending;if(t===e)return;this._ascending=e;this._filterSorter.notifyCriterionDirectionChanged(this,e,t);this.outAscendingChange(e,t);return true},getAscending:function(){return this._ascending},outAscendingChange:function(e,t){this._out("ascendingChange",e,t)},setDefaultValue:function(e){var t=this._defaultValue;if(t===e)return;this._defaultValue=e;this.outDefaultValueChange(e,t);this._filterSorter.refresh();return true},getDefaultValue:function(){return this._defaultValue},outDefaultValueChange:function(e,t){this._out("defaultValueChange",e,t)},getValue:function(e){var t=this._doGetValue(e);if(t===undefined)t=this._defaultValue;return t},_doGetValue:function(e){}};Amm.extend(Amm.Sorter.Criterion,Amm.FilterSorter.Observer);Amm.Sorter.Property=function(e,t){Amm.Sorter.Criterion.call(this,e,t);if(!this._property)throw Error("Need to specify options.property")};Amm.Sorter.Property.prototype={"Amm.Sorter.Property":"__CLASS__",_property:null,setProperty:function(e){var t=this._property;if(t===e)return;if(this._property)throw Error("Can setProperty() only once");this._property=e;return true},getProperty:function(){return this._property},observe:function(e){var t=e||this._filterSorter._objects,i=t.length,r,n;var s=this._property+"Change";for(r=0;r<i;r++){n=t[r];if(!n["Amm.WithEvents"])continue;if(!n.hasEvent(s))continue;this._filterSorter.subscribeObject(n,s,this._handleChange,this)}},unobserve:function(e){var t=e||this._filterSorter._objects,i=t.length,r,n;var s=this._property+"Change";for(r=0;r<i;r++){n=t[r];if(!n["Amm.WithEvents"])continue;if(!n.hasEvent(s))continue;this._filterSorter.unsubscribeObject(n,s,this._handleChange,this)}},_handleChange:function(){var e=Amm.event.origin;this._filterSorter.refresh(e)},_doGetValue:function(e){return Amm.getProperty(e,this._property)}};Amm.extend(Amm.Sorter.Property,Amm.Sorter.Criterion);Amm.Sorter.Expression=function(e,t){Amm.Sorter.Criterion.call(this,e,t);if(!this._expression)throw Error("Need to provide options.expression")};Amm.Sorter.Expression.prototype={"Amm.Sorter.Expression":"__CLASS__",_expression:null,_evaluator:null,setExpression:function(e){var t=this._expression;if(t===e)return;if(this._expression)throw Error("Can setExpression() only once");if(typeof e!=="string")throw Error("`expression` must be a string");this._expression=new Amm.Expression(e);this._expression.setEventsProxy(this._filterSorter);return true},getExpression:function(){return this._expression},observe:function(e){for(var t=0,i=e.length;t<i;t++){var r=e[t];if(this._expression.findContext(r)!==undefined)continue;this._expression.createContext({expressionThis:r});this._expression.subscribe("valueChange",this._handleExpressionChanged,this)}},unobserve:function(e){for(var t=0,i=e.length;t<i;t++){var r=this._expression.findContext(e[t]);if(r===undefined)continue;this._expression.deleteContext(r)}},_handleExpressionChanged:function(e,t){var i=this._expression.getExpressionThis();this._filterSorter.refresh(i)},_doGetValue:function(e){if(e===this._expression.getExpressionThis()){return this._expression.getValue()}var t=this._expression.findContext(e);if(t!==undefined){this._expression.setContextId(t);return this._expression.getValue()}if(!this._evaluator)this._evaluator=this._expression.toFunction();this._evaluator.env.expressionThis=e;return this._evaluator()},cleanup:function(){Amm.Sorter.Criterion.prototype.cleanup.call(this);this._expression.cleanup();this._evaluator=null;this._expression=null}};Amm.extend(Amm.Sorter.Expression,Amm.Sorter.Criterion);Amm.Root=function(e){Amm.augment(this,Amm.Trait.Composite);Amm.augment(this,Amm.Trait.Component);Amm.Element.call(this,e)};Amm.Root.prototype={"Amm.Root":"__CLASS__",_id:"^",_internalId:"root",_intervalDelay:250,_interval:null,_counter:0,strictEvents:false,getPath:function(){return"^"},setParent:function(e){if(e)throw Error("Cannot setParent() of root")},setId:function(e){if(e!=="^")Error("Cannot setId() of root to anything other than '^'")},raiseEvent:function(e){var t=Array.prototype.slice.call(arguments,0);var i=this._out.apply(this,t);if(e==="bootstrap"&&Amm.getBootstrapped()){delete this._subscribers["bootstrap"]}return i},outInterval:function(){this._out("interval",this._counter++)},_subscribeFirst_bootstrap:function(){if(Amm.getBootstrapped()){this.raiseEvent("bootstrap")}},_subscribeFirst_interval:function(){var e=this;this._interval=window.setInterval(function(){e.outInterval()},this._intervalDelay)},_unsubscribeLast_interval:function(){if(this._interval){window.clearInterval(this._interval);this._interval=null}},subscribe:function(e,t,i,r,n){if(Amm.itemDebugTag&&Amm.itemDebugTag.length&&Amm.getClass(i)){if(!i._root_sub)i._root_sub={};i._root_sub[e]=Amm.itemDebugTag[Amm.itemDebugTag.length-1]}return Amm.WithEvents.prototype.subscribe.call(this,e,t,i,r,n)}};Amm.extend(Amm.Root,Amm.Element);Amm.Builder.Ref=function(e,t){if(e&&"$ref"in e){if(e["$ref"]&&!("find"in e))e["find"]=e["$ref"];delete e["$ref"]}if(t)this.setNode(t);Amm.init(this,e)};Amm.Builder.Ref.prototype={"Amm.Builder.Ref":"__CLASS__",_node:null,_parent:0,_closest:null,_find:null,_index:0,_global:false,setNode:function(e){if(!e)e=null;else if(!(e instanceof HTMLElement||e.tagName)){throw Error("`node` must be an instance of HTMLElement")}this._node=e},getNode:function(){return this._node},setGlobal:function(e){e=!!e;this._global=e},getGlobal:function(){return this._global},setParent:function(e){if(typeof e!=="number"){e=parseInt(e)}if(isNaN(e)||e<0){throw Error("`parent` must be a number >= 0")}this._parent=e},getParent:function(){return this._parent},setClosest:function(e){if(!e)e=null;else if(typeof e!=="string")throw Error("`closest` must be a null or a string");this._closest=e},getClosest:function(){return this._closest},setFind:function(e){this._find=e},getFind:function(){return this._find},setIndex:function(e){if(e!==null){if(typeof e!=="number"){e=parseInt(e);if(isNaN(e)||e<0){throw Error("`index` must be a number >= 0")}}}this._index=e},getIndex:function(){return this._index},resolve:function(e){if(!this._global&&!this._node)throw Error("Cannot resolve without `node`");var t=this._global?jQuery:jQuery(this._node);if(this._parent&&!this._global){for(var i=0;i<this._parent&&t.length;i++){t=t.parent()}if(!t.length)return null}if(this._closest&&!this._global){t=t.closest(this._closest);if(!t)return null}if(this._find){t=t.find(this._find);if(!t)return null}if(this._index!==null){return t[this._index]||null}if(e)return t[0]||null;return t}};Amm.Builder.Node=function(e){this.children=[];this.connected=[this];this.conIdx=0;if(e)Amm.override(this,e)};Amm.Builder.Node.prototype={htmlElement:null,v:null,e:null,x:null,id:null,global:false,parent:null,children:null,connected:null,conIdx:null,conParent:false,conChild:false};Amm.Array=function(e){var t=arguments,i;if(t[0]instanceof Array){i=t[0];e=t[1]}else if(t[0]instanceof Amm.Array){i=t[0].getItems();e=t[1]}Amm.WithEvents.call(this,e);if(i!==undefined)this.setItems(i)};Amm.Array.indexOf=function(e,t,i){i=i||0;if(t instanceof Array&&t.indexOf)return t.indexOf(e,i);for(var r=i,n=t.length;r<n;r++)if(e===t[r])return r;return-1};Amm.Array.nonStrictIndexOf=function(e,t,i){i=i||0;for(var r=i,n=t.length;r<n;r++)if(e==t[r])return r;return-1};Amm.Array.arrayChangeEvents={appendItems:"outAppendItems",insertItem:"outInsertItem",deleteItem:"outDeleteItem",replaceItem:"outReplaceItem",spliceItems:"outSpliceItems",reorderItems:"outReorderItems",moveItem:"outMoveItem",clearItems:"outClearItems",itemsChange:"outItemsChange"};Amm.Array.costlyEvents={reorderItems:"outReorderItems",moveItem:"outMoveItem"};Amm.Array.prototype={"Amm.Array":"__CLASS__",_unique:false,_comparison:null,_diff:true,_sparse:false,_updateLevel:0,_noTrigger:0,_preUpdateItems:null,_evCache:null,_costlyEvents:false,length:0,push:function(e,t){var i=Array.prototype.slice.apply(arguments);if(this._unique)this._checkDuplicates("push()",i);var r=i.length;if(!r)return this.length;for(var n=0;n<r;n++){this[this.length++]=i[n]}if(!this._updateLevel)this.outAppendItems(i);return this.length},pop:function(){if(!this.length)return undefined;--this.length;var e=this[this.length];delete this[this.length];if(!this._updateLevel)this.outDeleteItem(this.length,e);return e},slice:function(e,t){e=e||0;if(e<0)e=this.length+e;if(e<0)e=0;if(t===undefined)t=this.length;if(!t)t=0;if(t<0)t=this.length+t;if(t<0)t=0;if(t>this.length)t=this.length;var i=[];for(var r=e;r<t;r++)i.push(this[r]);return i},sort:function(e,t){t=t||{};t.changed=false;if(this.length<=1)return this;var i=this.getItems(),r=[].concat(i),n,s=this.length;i.sort(e);var o=false;if(this._comparison){for(n=0;n<s;n++){o=o||this._comparison(this[n],i[n]);if(!this._sparse||n in i){this[n]=i[n]}else{delete this[n]}}}else{for(n=0;n<s;n++){o=o||this[n]!==i[n];this[n]=i[n];if(!this._sparse||n in i){this[n]=i[n]}else{delete this[n]}}}if(o){if(!this._updateLevel)this.outReorderItems(0,this.length,r);t.changed=true}return this},reverse:function(){if(this.length<=1)return this;var e=this.getItems(),t,i=this.length-1,r=(i-i%2)/2,n,s,o;for(t=0;t<=r;t++){if(!this._sparse||t in this&&i-t in this){n=this[t];this[t]=this[i-t];this[i-t]=n}else{s=t in this;o=i-t in this;if(!s&&!o)continue;if(o){this[t]=this[i-t];delete this[i-t]}else{this[i-t]=this[t];delete this[t]}}}if(!this._updateLevel)this.outReorderItems(0,this.length,e);return this},_rotate:function(e,t,i){if(!t)return;var r=t<0?e-t:this.length-1,n=t<0?this.length:e-1,s=t<0?1:-1;while(s*r<s*n){if(r in this)this[r+t]=this[r];else delete this[r+t];r+=s}if(t<0)for(var o=this.length+t;o<this.length;o++)delete this[o];this.length+=t},_innerShift:function(e,t){var i=e>t?-1:1;for(var r=e;r*i<t*i;r+=i){this[r]=this[r+i]}},_checkDuplicates:function(e,t,i,r,n,s){if(s===undefined)s=this._comparison;var o=this.getItems();if(r)o.splice(i,r);var a=t.concat(o),l=Amm.Array.findDuplicates(a,true,s,n?null:t.length);if(l.length){var h=this._describeIdx(l[0][0],t.length,i||0,r||0),u=this._describeIdx(l[0][1],t.length,i||0,r||0);throw Error("Cannot "+e+": duplicates found ("+h+" and "+u+")")}},_describeIdx:function(e,t,i,r){var n=this.length,s,o;if(e<t){s="items";o=e}else if(e<i+t){s="this";o-=t}else{s="this";o=e-t+(r||0)}return s+"["+o+"]"},splice:function(e,t,i,r){var n=Array.prototype.slice.call(arguments,2),s=n.length;var o=[],a=this.length;e=+e||0;if(e<0){e=this.length+e;if(e<0)e=0}else if(e>this.length)e=this.length;t=+t||0;if(t<0)t=0;if(t>this.length-e)t=this.length-e;if(this._unique&&s)this._checkDuplicates("splice()",n,e,t);if(e===this.length){this.push.apply(this,n);return o}var l=s-t;var h;for(h=0;h<t;h++)o.push(this[e+h]);this._rotate(e,l);for(h=0;h<s;h++)this[e+h]=n[h];if(!this._updateLevel)this._outSmartSplice(e,o,n);return o},shift:function(){if(!this.length)return undefined;var e=this[0];this._rotate(0,-1);if(!this._updateLevel)this.outDeleteItem(0,e);return e},unshift:function(e,t){var i=Array.prototype.slice.apply(arguments),r=i.length;if(!r)return this.length;var n=this.length;if(this._unique)this._checkDuplicates("unshift()",i);if(this.length)this._rotate(0,r);else this.length=r;for(var s=0;s<r;s++){this[s]=i[s]}if(!this._updateLevel)this._outSmartSplice(0,[],i);return this.length},indexOf:function(e,t){t=t||0;if(t<0){t=this.length+t;if(t<0)t=0}var i=-1;if(this._comparison){for(var r=t,n=this.length;r<n;r++){if(!this._comparison(e,this[r])){i=r;break}}}else{for(var r=t,n=this.length;r<n;r++){if(e===this[r]){i=r;break}}}return i},getItems:function(){return Array.prototype.slice.apply(this)},getItem:function(e){return this[e]},getIndexExists:function(e){return e in this},setItem:function(e,t){if(this[e]&&this._comparison?!this._comparison(this[e],t):this[e]===t)return;if(this._unique)this._checkDuplicates("setItem()",[t],e,1);if(e<0)throw Error("`index` must be >= 0");if(e>=this.length){if(!this._sparse)e=this.length;this.length=e+1}if(e in this){var i=this[e];this[e]=t;if(!this._updateLevel)this.outReplaceItem(e,t,i)}else{this[e]=t;if(!this._updateLevel)this.outInsertItem(t,e)}return e},removeAtIndex:function(e,t){if(!this._sparse)t=false;if(!(e in this))return false;if(e<0)throw Error("`index` must be >= 0");var i=this[e];if(!t)this._rotate(e,-1);else delete this[e];if(!this._updateLevel)this.outDeleteItem(e,i);return true},moveItem:function(e,t){if(e<0)throw Error("`index` must be >= 0");if(e>=this.length)throw Error("No item with index "+e);if(t<0)throw Error("`newIndex` must be >= 0");if(t>=this.length&&!this._sparse){t=this.length-1}if(t===e)return;var i=this[e],r,n,s;this._innerShift(e,t);this[t]=i;if(!this._updateLevel)this.outMoveItem(e,t,i)},insertItem:function(e,t){if(t===undefined||t>=this.length&&!this._sparse){return this.push(e)-1}if(t<0)throw Error("`index` must be >= 0");if(this._unique)this._checkDuplicates("insertItem()",[e]);if(t<this.length)this._rotate(t,1);if(t>=this.length)this.length=t;this[t]=e;if(!this._updateLevel)this.outInsertItem(e,t);return t},insertItemBefore:function(e,t){if(t===undefined)return this.insertItem(e);var i=this.indexOf(t);if(i<0)throw Error("cannot insertItemBefore: `otherItem` not found");return this.insertItem(e,i)},removeItem:function(e,t){if(this._unique)t=false;var i=0,r=0;while((r=this.indexOf(e,r))>=0){this.removeAtIndex(r);i++;if(!t)break}return i},setItems:function(e){if(!e instanceof Array)throw Error("`items` must be an array");if(this._unique)this._checkDuplicates("setItems()",e,0,this.length);var t=this.getItems(),i=e.length,r=this.length;var n,s;for(n=0,s=0;n<i;n++){if(n in e){this[s]=e[n];s++}else{if(this._sparse){delete this[s];s++}}}this.length=s;while(s<r)delete this[s++];if(!this._updateLevel){if(this._diff){this._doDiff(t,e)}else{this._outSmartSplice(0,t,e)}}return this.length},clearItems:function(){this.setItems([])},setSparse:function(e){var t=this._sparse;if(t===e)return;this._sparse=e;return true},getSparse:function(){return this._sparse},setUnique:function(e){e=!!e;var t=this._unique;if(t===e)return;if(e){this._checkDuplicates("setUnique()",[],0,0,true)}this._unique=e;return true},getUnique:function(){return this._unique},setComparison:function(e){var t=this._comparison;if(t===e)return;if(this._unique){this._checkDuplicates("setComparison()",[],0,0,true,e)}this._comparison=e;return true},getComparison:function(){return this._comparison},setDiff:function(e){var t=this._diff;if(t===e)return;this._diff=e;return true},getDiff:function(){return this._diff},_doBeginUpdate:function(){this._preUpdateItems=this.getItems()},_doEndUpdate:function(){if(this._diff){this._doDiff()}else{if(!this._updateLevel)this.outItemsChange(this._getItems,this._preUpdateItems)}this._preUpdateItems=null},beginUpdate:function(){this._updateLevel++;if(this._updateLevel===1){this._doBeginUpdate()}},endUpdate:function(){if(!this._updateLevel)throw Error("endUpdate() before beginUpdate()!");this._updateLevel--;if(this._updateLevel===0){this._doEndUpdate()}},getUpdateLevel:function(){return this._updateLevel},_buildEvCache:function(){var e=[{}],t=[null];if(!t.indexOf){t.indexOf=this.indexOf}for(var i in this._subscribers){if(this._subscribers.hasOwnProperty(i)&&Amm.Array.arrayChangeEvents[i]){var r=this._subscribers[i].length,n,s,o;for(s=0;s<r;s++){n=this._subscribers[i][s];if(n[1]){o=t.indexOf(n[1]);if(o<0){o=t.length;t.push(n[1]);e.push({})}}else o=0;if(!e[o][i])e[o][i]=[];e[o][i].push(n)}}}this._evCache=e;return this._evCache},_outChain:function(e){if(this._noTrigger||this._updateLevel)return;if(!this._evCache)this._buildEvCache();if(!this._evCache.length)return;var t=[],i,r,n;for(i in e)if(e.hasOwnProperty(i))t.push(i);var s=t.length;for(var o=0,a=this._evCache.length;o<a;o++){for(var l=0;l<s;l++){i=t[l];if(this._evCache[o][i]){var n=e[i];if(!n){n=[];if(i==="itemsChange"){n=[this.getItems()];if(this._preUpdateItems){n.push(this._preUpdateItems)}else if(r=e["spliceItems"]){var h=[].concat(n[0]);h.splice.apply(h,[r[0],r[2].length].concat(r[1]));n.push(h)}}}Amm.WithEvents.invokeHandlers.call(this,i,n,this._evCache[o][i]);if(o!==0)break}}}this._checkLengthChange()},_checkLengthChange:function(){if(this._oldLength!==this.length){var e=this._oldLength;this._oldLength=this.length;this.outLengthChange(this.length,e)}},getLength:function(){return this.length},outLengthChange:function(e,t){return this._out("lengthChange",e,t)},outClearItems:function(e){return this._outChain({clearItems:null,spliceItems:[0,e,[]],itemsChange:[[],e]})},outDeleteItem:function(e,t){return this._outChain({deleteItem:[e,t],spliceItems:[e,[t],[]],itemsChange:null})},outInsertItem:function(e,t){return this._outChain({insertItem:[e,t],spliceItems:[t,[],[e]],itemsChange:null})},outReplaceItem:function(e,t,i){return this._outChain({replaceItem:[e,t,i],spliceItems:[e,[i],[t]],itemsChange:null})},outAppendItems:function(e){return this._outChain({appendItems:[e],spliceItems:[this.length-e.length,[],e],itemsChange:null})},outSpliceItems:function(e,t,i){return this._outChain({spliceItems:[e,t,i],itemsChange:null})},outMoveItem:function(e,t,i){if(this._noTrigger)return;var r,n,s;if(e<t){n=e,s=t-e+1;r=this.slice(e,t);r.unshift(i)}else{n=t;s=e-t+1;r=this.slice(t+1,e+1);r.push(i)}return this._outChain({moveItem:[e,t,this[t]],reorderItems:[n,s,r],spliceItems:[n,r,this.slice(n,n+s)],itemsChange:null})},outReorderItems:function(e,t,i){return this._outChain({reorderItems:[e,t,i],spliceItems:[e,i,this.slice(e,e+t)],itemsChange:null})},outItemsChange:function(e,t){return this._outChain({itemsChange:[e,t]})},_outSmartSplice:function(e,t,i){if(this._noTrigger||this._updateLevel)return;if(!t.length&&!i.length)return;if(e===0&&!i.length&&!this.length){return this.outClearItems(t)}if(!t.length&&e>=this.length-i.length){return this.outAppendItems(i)}if(!t.length&&i.length===1){return this.outInsertItem(i[0],e)}if(t.length===1&&i.length===1){return this.outReplaceItem(e,i[0],t[0])}if(t.length===1&&!i.length){return this.outDeleteItem(e,t[0])}if(t.length===i.length){var r=t.length-1;if(Amm.Array.equal(t,i,undefined,undefined,undefined,this._comparison)){return}else if(this._comparison?!this._comparison(t[0],i[r]):t[0]===i[r]){if(Amm.Array.equal(t,i,1,0,r,this._comparison))return this.outMoveItem(e,e+r,t[0])}else if(this._comparison?!this._comparison(t[r],i[0]):t[r]===i[0]){if(Amm.Array.equal(t,i,0,1,r,this._comparison))return this.outMoveItem(e+r,e,t[r])}if(!Amm.Array.symmetricDiff(t,i,this._comparison).length){return this.outReorderItems(e,t.length,t)}}return this.outSpliceItems(e,t,i)},_doDiff:function(e,t){e=e||this._preUpdateItems;t=t||this.getItems();var i=Amm.Array.smartDiff(e,t,null,!this._costlyEvents);if(!i)return;if(i[0]==="splice"){return this._outSmartSplice(i[1],e.slice(i[1],i[1]+i[2]),i[3])}if(i[0]==="move"){return this.outMoveItem(i[1],i[2],this[i[2]])}if(i[0]==="reorder"){return this.outReorderItems(i[1],i[2],i[3])}},subscribe:function(e,t,i,r,n){this._evCache=null;if(!this._costlyEvents&&Amm.Array.costlyEvents[e])this._costlyEvents=true;return Amm.WithEvents.prototype.subscribe.call(this,e,t,i,r,n)},unsubscribe:function(e,t,i){this._evCache=null;var r=Amm.WithEvents.prototype.unsubscribe.call(this,e,t,i);if(this._costlyEvents&&!this._subscribers[e]&&Amm.Array.costlyEvents[e]){var n=false;for(var s in this._subscribers){if(this._subscribers.hasOwnProperty(s)&&Amm.Array.costlyEvents[s]){n=true;break}}if(!n)this._costlyEvents=true}return r},cleanup:function(){var e=Amm.WithEvents.prototype.unsubscribe.call(this);this._evCache=null;this._updateLevel=1;this.setItems([]);this._preUpdateItems=null;this._updateLevel=0;return e}};Amm.extend(Amm.Array,Amm.WithEvents);Amm.Array.equal=function(e,t,i,r,n,s){if(e===t)return true;if(!i&&!r&&n===undefined){if(e.length!==t.length)return false;i=0;r=0;n=e.length}else{i=i||0;if(i<0)i=e.length+i;if(i<0)i=0;r=r||0;if(r<0)r=t.length+r;if(r<0)r=0;if(n===undefined)n=e.length-i;if(n<0)n=0;if(n===0)return true;var o=n,a=n;if(i+n>e.length)o=e.length-i;if(r+n>t.length)a=t.length-r;if(o<=0&&a<=0)return true;if(o!==a)return false}if(s){for(var l=0;l<n;l++){if(s(e[i+l],t[r+l]))return false}}else{for(var l=0;l<n;l++){if(e[i+l]!==t[r+l])return false}}return true};Amm.Array.smartDiff=function(e,t,i,r,n){var s=e.length,o=t.length,a=o-s,l=s>o?s:o,h,u,f;if(n&&n instanceof Array)n.length=0;if(!s&&!o)return null;if(!s)return["splice",0,0,[].concat(t)];if(!o)return["splice",0,s,[]];for(u=0;u<l;u++){if(i?i(e[u],t[u]):e[u]!==t[u]){break}}var c=a>0?u+a-1:u;for(f=s-1;f>=c;f--){if(i?i(e[f],t[f+a]):e[f]!==t[f+a]){break}}f++;var _=f-u;var m=_+a;var d;if(m)d=t.slice(u,u+m);else d=[];if(!_&&!m)return null;if(_===m&&!r){var p=e.slice(u,u+_),g=0,v=0,A=true;if(i?!i(p[0],d[m-1]):p[0]===d[m-1]){g=1}else if(i?!i(p[_-1],d[0]):p[_-1]===d[0]){v=1}if(g||v){for(h=0;h<_-1;h++){if(i?i(p[h+g],d[h+v]):p[h+g]!==d[h+v]){A=false;break}}if(A){if(g)return["move",u,u+_-1];else return["move",f-1,f-_]}}if(!Amm.Array.symmetricDiff(p,d,i,n).length)return["reorder",u,_,p]}return["splice",u,_,d]};Amm.Array._optArrayDiff=true;Amm.Array.symmetricDiff=function(e,t,i,r){if(!e.length||!t.length)return[].concat(e);if(!(r instanceof Array))r=[];var n=e.length,s=t.length,o,a,l,h,u={},f=[].concat(t);r.length=n;if(i){o=[];for(a=0;a<n;a++){var c=e[a];h=null;for(l=0;l<s;l++)if(f[l]!==u&&!i(c,f[l])){h=l;f[l]=u;break}if(l>=s){o.push(c)}r[a]=h}}else{if(e.filter&&t.indexOf&&Amm.Array._optArrayDiff){o=e.filter(function(e,t){var i=f.indexOf(e);if(i>=0){r[t]=i;f[i]=u;return false}r[t]=null;return true})}else{o=[];for(a=0;a<n;a++){var c=e[a];h=null;for(l=0;l<s;l++)if(c===f[l]){f[l]=u;h=l;break}if(l>=s)o.push(c);r[a]=l}}}return o};Amm.Array.findNonMatched=function(e,t,i){var r={},n=[],s,o;i=i||0;for(s=0,o=e.length;s<o;s++){r[e[s]]=true}for(s=0;s<t;s++){if(!(s in r))n.push(s+i)}return n};Amm.Array.diff=function(e,t,i){if(!e.length||!t.length)return[].concat(e);var r=e.length,n=t.length,s,o,a;if(i){s=[];for(o=0;o<r;o++){var l=e[o];for(a=0;a<n;a++){if(!i(l,t[a]))break}if(a>=n)s.push(l)}}else{if(e.filter&&t.indexOf&&Amm.Array._optArrayDiff){s=e.filter(function(e){return t.indexOf(e)<0})}else{s=[];for(o=0;o<r;o++){var l=e[o];for(a=0;a<n;a++){if(l===t[a])break}if(a>=n)s.push(l)}}}return s};Amm.Array.findDuplicates=function(e,t,i,r,n,s){var o=e.length,a=[],l,h,u,f;if(!r||r<0||r>o)r=o;if(n&&r>=o&&!s){return[]}for(var c=0;c<r;c++){h=true;for(var _=n?r:c+1;_<o;_++){var m;if(i)f=!i(e[c],e[_]);else f=e[c]===e[_];if(f){h=false;if(!l)l=[c];else{if(l.indexOf)m=l.indexOf(_)>=0;else{for(var d=0;d<l.length;d++)if(l[d]===_){m=true;break}}if(m)continue}if(!u)u=[c];u.push(_);if(t)return[u];l.push(_)}}if(u){a.push(u);u=null}else if(s&&h){var p;if(!l)p=false;else{if(l.indexOf)p=l.indexOf(c)>=0;else{for(var d=0;d<l.length;d++)if(l[d]===c){p=true;break}}}if(!p)a.push([c])}}if(n&&s){for(var g=r;g<o;g++){var p;if(!l)p=false;else{if(l.indexOf)p=l.indexOf(g)>=0;else{for(var d=0;d<l.length;d++)if(l[d]===g){p=true;break}}}if(!p)a.push([g])}}return a};Amm.Array.calcChanges=function(e,t,i,r,n){var s=e.length;var o=n?s:null,a=!!n;if(!r)r=0;var l=Amm.Array.findDuplicates(e.concat(t),false,i,o,a,true);var h={added:[],deleted:[],moved:[],same:[]};var u=l.length,f;if(n){for(f=0;f<u;f++){if(l[f].length===1){if(l[f][0]>=s)h.added.push([t[l[f][0]-s],l[f][0]-s+r]);else h.deleted.push([e[l[f][0]],l[f][0]+r]);continue}var c=l[f][0],_=l[f][1]-s;if(c===_){h.same.push([e[c],c+r])}else{h.moved.push([e[c],c+r,_+r])}}return h}for(f=0;f<u;f++){var m=[],d=[],p,g={},v=[],A;for(p=0,A=l[f].length;p<A;p++){var y=l[f][p],C=y>=s,E=C?y-s:y;if(!g[E])g[E]=1;else{g[E]++;v.push(E)}if(C){d.push(E)}else{m.push(E)}}if(v.length){for(p=m.length;p>=0;p--)if(g[m[p]]>1)m.splice(p,1);for(p=d.length;p>=0;p--)if(g[d[p]]>1)d.splice(p,1);for(p=0;p<v.length;p++)h.same.push([e[v[p]],v[p]+r])}var b=m.length<d.length?m.length:d.length;for(p=0;p<b;p++){if(d[p]===m[p])h.same.push([e[m[p]],m[p]+r]);else h.moved.push([e[m[p]],m[p]+r,d[p]+r])}for(p=b;p<d.length;p++)h.added.push([t[d[p]],d[p]+r]);for(p=b;p<m.length;p++)h.deleted.push([e[m[p]],m[p]+r])}return h};Amm.Array.intersect=function(e,t,i){if(!(e instanceof Array||e["Amm.Array"]))throw Error("`a` must be an Array");if(!(t instanceof Array||t["Amm.Array"]))throw Error("`b` must be an Array");if(!e.length||!t.length)return[];var r=[].concat(e).concat(t);var n=Amm.Array.findDuplicates(r,false,i,e.length,true);var s=[];for(var o=0,a=n.length;o<a;o++){for(var l=0,h=n[o].length;l<h;l++){if(n[o][l]<e.length){s.push(r[n[o][l]]);break}}}return s};Amm.Array.unique=function(e,t){if(!(e instanceof Array||e["Amm.Array"]))throw Error("`arr` must be an Array");var i=e["Amm.Array"]?e.getItems():[].concat(e);for(var r=0;r<i.length;r++){for(var n=i.length-1;n>r;n--){if(t?!t(i[n],i[r]):i[n]===i[r])i.splice(n,1)}}return i};Amm.Filter=function(e){Amm.FilterSorter.call(this,e)};Amm.Filter.prototype={"Amm.Filter":"__CLASS__",_oldMatchingObjects:null,_matchingObjects:null,filter:function(e,t){if(!(t instanceof Array))t=[];else t.splice(0,t.length);var i,r,n,s=[];for(i=0,r=e.length;i<r;i++){n=this.evaluateMatch(e[i]);if(!n)continue;s.push(e[i]);t.push(n)}return s},setConditions:function(e,t){var i=null,r,n,s;if(this._subscribers.outConditionsChange){r=[].concat(this._observers)}if(t){if(e){if(typeof e!=="object")throw Error("setConditions(`conditions`, `id`): non-FALSEable `conditions` must be an object");e._id=t;i=this._createCondition(e)}this.beginUpdate();for(n=0,s=this._observers.length;n<s;n++){if(this._observers[n].id===t){this._observers[n].cleanup();this._observers.splice(n,1);break}}this._observers.push(i);if(this._subscribers.outConditionsChange){this.outConditionsChange([].concat(this._observers),r)}i.observe(this._objects);this.refresh();this.endUpdate();return}var o=[];if(e){if(!(e instanceof Array))throw Error("`conditions` must be an Array");var a={};for(n=0,s=e.length;n<s;n++){i=this._createCondition(e[n]);o.push(i);if(!i.id)continue;if(i.id in a)throw Error("conditions['"+n+"'].id is same as "+"conditions['"+a[i.id]+"'] ('"+i.id+"')");a[i.id]=n}}this.beginUpdate();for(n=this._observers.length-1;n>=0;n--){this._observers[n].cleanup()}this._observers=o;this._subObservers(this._objects);if(this._subscribers.outConditionsChange){this.outConditionsChange([].concat(this._observers),r)}this.refresh();this.endUpdate()},getConditions:function(e){var t,i;if(!e)return[].concat(this._observers);for(t=0,i=this._observers.length;t<i;t++){if(e===t+1||this._observers[t].id===e)return this._observers[t]}return null},outConditionsChange:function(e,t){return this._out("conditionsChange",e,t)},outMatchingObjectsChange:function(e,t){return this._out("matchingObjectsChange",e,t)},beginUpdate:function(){if(!this._updateLevel)this._oldMatchingObjects=this.getMatchingObjects();Amm.FilterSorter.prototype.beginUpdate.call(this);this._matchingObjects=null},_doOnEndUpdateChange:function(){if(!this._subscribers.matchingObjectsChange)return;var e=this.getMatchingObjects();if(Amm.Array.equal(e,this._oldMatchingObjects))return;var t=this._oldMatchingObjects;this._oldMatchingObjects=null;this.outMatchingObjectsChange(e,t)},_createCondition:function(e){if(!e||typeof e!=="object")throw Error("filter condition must be an object, given: "+Amm.describeType(e));if(e._expr)return new Amm.Filter.ExpressionCondition(this,e);return new Amm.Filter.PropsCondition(this,e)},setRequireAll:function(e){e=!!e;var t=this._requireAll;if(t===e)return;this._requireAll=e;this.outRequireAllChange(e,t);if(this._observers.length)this.refresh();return true},getRequireAll:function(){return this._requireAll},outRequireAllChange:function(e,t){this._out("requireAllChange",e,t)},getMatchingObjects:function(){if(this._matchingObjects)return this._matchingObjects;var e=[],t,i;for(t=0,i=this._objects.length;t<i;t++){if(this._matches[t]){e.push(this._objects[t])}}if(this._oldMatchingObjects&&Amm.Array.equal(e,this._oldMatchingObjects))e=this._oldMatchingObjects;this._matchingObjects=e;return e},_doOnUpdateMatch:function(e,t,i){if(!!i===!!t)return;this._matchingObjects=null;if(!this._subscribers.matchingObjectsChange)return;var r=[],n=[],s,o;for(s=0,o=this._objects.length;s<o;s++){if(s===e&&t)n.push(this._objects[s]);if(this._matches[s]){r.push(this._objects[s]);n.push(this._objects[s])}}this._matchingObjects=r;this.outMatchingObjectsChange(r,n)},evaluateMatch:function(e){if(!this._observers.length)return true;var t;for(var i=0,r=this._observers.length;i<r;i++){t=false;if(this._observers[i].match(e))t=this._observers[i].id||i+1;if(this._requireAll){if(!t)return false}else{if(t)return t}}if(this._requireAll)return t;return false},_hasChangeSubscribers:function(){return this._subscribers.matchesChange||this._subscribers.matchingObjectsChange}};Amm.extend(Amm.Filter,Amm.FilterSorter);Amm.ElementBound=function(e){Amm.init(this,e)};Amm.ElementBound.prototype={"Amm.ElementBound":"__CLASS__",requiredElementClass:"Amm.Element",requiredElementInterfaces:null,_element:null,_elementPath:null,_isElementCleanup:0,cleanupWithElement:true,setElementPath:function(e){if(this._elementPath===e)return;if(this._element){if(this._element.getPath()===e)return;if(this._elementPath){Amm.stopWaiting(this._elementPath,this.setElement,this);this._elementPath=null}this.setElement(null)}var t=typeof this.getByPath==="function"?this.getByPath(e):Amm.p(e);if(!t){this._elementPath=e;Amm.waitFor(e,this.setElement,this)}return true},_doElementChange:function(e,t){if(t&&!this._isElementCleanup){t.unsubscribe("cleanup",this._handleElementCleanup,this)}this._element=e;this._elementPath=null;if(this._element)this._element.subscribe("cleanup",this._handleElementCleanup,this)},setElement:function(e){if(typeof e==="string")return this.setElementPath(e);if(e!==null){if(this.requiredElementClass)Amm.is(e,this.requiredElementClass,"element");if(this.requiredElementInterfaces)Amm.hasInterfaces(e,this.requiredElementInterfaces,"element")}var t=this._element;if(e===t)return;this._doElementChange(e,t);return true},getElement:function(){return this._element},_handleElementCleanup:function(){this._isElementCleanup++;if(this.cleanupWithElement){this.cleanup()}this.setElement(null);this._isElementCleanup--;return true},cleanup:function(){if(this._element){if(!this._isElementCleanup){this._element.unsubscribe(undefined,undefined,this)}this.setElement(null)}Amm.callMethods(this,"_cleanup_");Amm.stopWaiting(undefined,undefined,this);Amm.unregisterItem(this)},_requireInterfaces:function(e,t){var i=Array.prototype.slice.call(arguments);if(!(this.requiredElementInterfaces instanceof Array)){this.requiredElementInterfaces=this.requiredElementInterfaces?[this.requiredElementInterfaces]:[]}this.requiredElementInterfaces=this.requiredElementInterfaces.concat(i)}};Amm.Collection=function(e){var i=this;this._compareWithProps=function(e,t){return i._implCompareWithProps(e,t)};this._sortWithProps=function(e,t){return i._implSortWithProps(e,t)};this._itemUpdateQueue=[];this.k={};Amm.Array.call(this,e)};Amm.Collection.ERR_NOT_AN_OBJECT="Not an object.";Amm.Collection.ERR_NOT_MEETING_REQUIREMENTS="Doesn't meet requirements.";Amm.Collection.ERR_DUPLICATE_UPDATE_NOT_ALLOWED="Duplicate; update not allowed.";Amm.Collection.ERR_ADD_DISALLOWED="Adding new items disallowed";Amm.Collection.ERR_DELETE_DISALLOWED="Deleting items disallowed";Amm.Collection.ERR_REORDER_DISALLOWED="Reordering (and inserting/deleting items not at the end) disallowed";Amm.Collection.ERR_KEY_PROPERTY_MISSING="Key property missing";Amm.Collection.ERR_KEY_PROPERTY_INVALID="Invalid key property value (must be scalar)";Amm.Collection.binSearch=function(e,t,i,r,n){var s=typeof r==="number"?r:0;var o=typeof n==="number"?n:e.length-1;var a;if(s<0)s=0;if(o>e.length-1)o=e.length-1;if(s>e.length-1){return[r,false]}var l,h,u;l=i?i(t,e[s]):-(t<e[s])||t!==e[s]|0;if(l===0)return[s,true];else if(l<0)return[s-1,false];h=i?i(t,e[o]):-(t<e[o])||t!==e[o]|0;if(h===0)return[o,true];else if(h>0)return[o+1,false];while(o-s>1){a=Math.floor((s+o)/2);u=i?i(t,e[a]):-(t<e[a])||t!==e[a]|0;if(u===0){return[a,true]}if(u<0)o=a;else s=a}return[o,false]};Amm.Collection.prototype={"Amm.Collection":"__CLASS__",k:null,_unique:true,_sparse:false,_requirements:null,_assocProperty:null,_assocInstance:null,_indexProperty:null,_observeIndexProperty:true,_indexPropertyIsWatched:false,_defaults:null,_undefaults:null,_changeEvents:null,_comparisonProperties:null,_onlyStrict:false,_ignoreExactMatches:null,_recheckUniqueness:false,_custComparison:null,_compareWithProps:null,_sortWithProps:null,_sortProperties:null,_sortReverse:false,_sortFn:null,_sorted:false,_sorter:null,_needSort:false,_lockSort:0,_sorterIsAggregate:false,_updateProperties:null,_itemUpdateLevel:0,_endItemsUpdateLock:false,_itemUpdateQueue:null,_updateFn:null,_allowUpdate:false,_suppressDeleteEvent:0,_suppressIndexEvents:0,_allowAdd:true,_allowDelete:true,_allowChangeOrder:true,_cleanupOnDissociate:false,_assocEvents:null,_instantiator:null,_instantiateOnAccept:false,_keyProperty:null,_byKeyChange:false,setUnique:function(e){if(!e)throw Error("setUnique(false) is never supported by Amm.Collection");return Amm.Array.prototype.setUnique.call(this,e)},setSparse:function(e){if(e)throw Error("setSparse(true) is never supported by Amm.Collection");return Amm.Array.prototype.setSparse.call(this,e)},setRequirements:function(e){var t=e instanceof Array||typeof e==="string"||typeof e==="function";if(!t){throw Error("requirements must be an Array, a string or a function")}var i=this._requirements;if(i===e)return;if(e){for(var r=0,n=this.length;r<n;r++){if(!Amm.meetsRequirements(this[r],e)){throw Error("Cannot setRequirements(): at least one item ("+r+")"+" doesn't meet new `requirements`")}}}this._requirements=e;return true},setInstantiator:function(e){if(!e)e=null;var t=this._instantiator;if(t===e)return;this._instantiator=e;return true},getInstantiator:function(){return this._instantiator},setInstantiateOnAccept:function(e){e=!!e;var t=this._instantiateOnAccept;if(t===e)return;this._instantiateOnAccept=e;return true},getInstantiateOnAccept:function(){return this._instantiateOnAccept},createItem:function(e){if(!this._instantiator)throw Error("Cannot createItem() when `instantiator` not provided");var t=this._instantiator.construct(e);this.accept(t);return t},getRequirements:function(){return this._requirements},canAccept:function(e,t,i){i=i||{};if(!this._allowAdd){i.error=Amm.Collection.ERR_ADD_DISALLOWED;return false}if(!(typeof e==="object"&&e)){i.error=Amm.Collection.ERR_NOT_AN_OBJECT;return false}if(this._requirements&&!Amm.meetsRequirements(e,this._requirements)){i.error=Amm.Collection.ERR_NOT_MEETING_REQUIREMENTS;return false}if(this._keyProperty){if(!Amm.detectProperty(e,this._keyProperty)){i.error=Amm.Collection.ERR_KEY_PROPERTY_MISSING;return false}var r=Amm.getProperty(e,this._keyProperty);if(r&&typeof r==="object"){i.error=Amm.Collection.ERR_KEY_PROPERTY_INVALID;return false}}if(!t&&!this._allowUpdate){var n=this.indexOf(e);if(n>=0){i.error=Amm.Collection.ERR_DUPLICATE_UPDATE_NOT_ALLOWED;i.index=n;return false}}i.index=null;i.error=null;this.outOnCanAccept(e,i);return!i.error},_instantiateIfNeeded:function(e){var t=false;if(this._requirements)t=!Amm.meetsRequirements(e,this._requirements);else if(typeof e!=="object")t=true;else if(!Amm.getClass(e))t=true;if(!t)return e;var i=this._instantiator.construct(e);return i},_preAccept:function(e,t,i){if(!t)t=0;if(t<0)t=this.length+t;if(t>this.length)t=this.length;if(!i)i=0;var r=t+i;if(i<0){r=this.length+i;i=0}var n=e.concat(this.getItems()),s,o,a=i?this.slice(t,r):[],l=[],h=0;for(var s=t;s<r;s++)l.push(s);if(this._instantiator&&this._instantiateOnAccept){for(s=0,o=e.length;s<o;s++){e[s]=this._instantiateIfNeeded(e[s])}}for(s=0,o=e.length;s<o;s++){var u={};if(!this.canAccept(e[s],true,u)){throw Error("Cannot accept items["+s+"]: "+u.error)}}var f=Amm.Array.findDuplicates(n,false,this._comparison);if(!f.length){return[[].concat(e),[],[],[],a,[].concat(e),l]}var c=f.length,_=[],m=[],d=[].concat(e),p=0,g=[],v=[].concat(e);for(s=0;s<c;s++){var A=f[s];if(A.length>2){var y=[];for(j=0;j<A.length;j++)y.push(this._describeIdx(A[j],e.length));throw Error("Multiple instances of same item: "+y.join(", "))}var C=n[A[0]]===n[A[1]];if(A[0]>=e.length)throw Error("WTF: we found two duplicates in `this`: "+this._describeIdx(A[0],e.length)+(C?" === ":" ~= ")+this._describeIdx(A[1],e.length));if(A[1]<e.length)throw Error("There are at least two duplicates in `items`: "+this._describeIdx(A[0],e.length)+(C?" === ":" ~= ")+this._describeIdx(A[1],e.length));var E=A[1]-e.length;var b=E>=t&&E<r;if(!C&&!this._allowUpdate){b=false}if(C&&!b&&!this._ignoreExactMatches){throw Error("Item already in collection: "+this._describeIdx(A[0],e.length)+" === "+this._describeIdx(A[1],e.length)+". setIgnoreExactMatches(true) next time.")}if(!C&&!b&&!this._allowUpdate){throw Error("Added item matches existing one, but no update routine provided: "+this._describeIdx(A[0],e.length)+" ~= "+this._describeIdx(A[1],e.length)+". setUpdateProperties() and/or setUpdateFn() may help.")}if(b){a[E-t]=undefined;l[E-t]=undefined;h++}if(!b){v.splice(A[0]-_.length,1)}d.splice(A[0]-p,1);p++;g.push(A[0]);_.push(n[A[0]]);m.push(n[A[1]])}if(h){for(s=a.length-1;s>=0;s--){if(a[s]!==undefined)continue;a.splice(s,1);l.splice(s,1)}}return[d,_,m,g,a,v,l]},_addNew:function(e,t){if(t===undefined||t>=this._length){t=this.length;this.length+=e.length}else{this._rotate(t,e.length)}for(var i=0,r=e.length;i<r;i++){this[t+i]=e[i]}},_addNewToSorted:function(e){var t=[].concat(e);var i=this._locateManyItemIndexesInSortedArray(t);for(var r=0;r<i.length;r++){if(i[r]<this.length){this._rotate(i[r],1);this[i[r]]=t[r]}else{this[this.length++]=t[r]}}return[t,i]},accept:function(e,t){var i=this._preAccept([e]);var r;if(this._sorted&&t!==undefined){throw Error("`index` must not be used with sorted Collection - check for getIsSorted() next time")}if(t===undefined)t=this.length;if(t<0)t=this.length+t;if(t>this.length)t=this.length;if(i[0].length){var n=this._sorted;var s=n?this._locateItemIndexInSortedArray(e):t;if(s===undefined||s<=0)s=0;r=i[0][0];if(s<this.length){this._rotate(s,1);this[s]=e}else{this[this.length++]=e}this._associate(e,s);this._outSmartSplice(s,[],[e]);this._subscribe(e);if(this._indexProperty&&s<this.length-1)this._reportIndexes(null,s+1)}else{r=i[2][0];this._updateItem(i[2][0],i[1][0])}return r},acceptMany:function(e,t){var i=this._sorted;if(i&&t!==undefined)throw Error("`index` must not be used with sorted Collection - check for getIsSorted() next time");if(!e.length)return[];if(e.length===1)return[this.accept(e[0])];this._byKeyChange=1;var r=this._preAccept([].concat(e));var n;if(r[0].length){var s=this.getItems(),o;if(i){var a=this._addNewToSorted(r[0]);for(n=0;n<a[0].length;n++){this._associate(a[0][n],a[1][n])}this._outFragmentedInsert(this._getInsertFragments(a[0],a[1]));o=a[1][0]}else{if(t<0)t=this.length+t;if(t===undefined||t>this.length)t=this.length;o=t;this._addNew(r[0],t);for(n=0;n<r[0].length;n++){this._associate(r[0][n],t+n)}this._outSmartSplice(t,[],r[0])}for(n=0;n<r[0].length;n++){this._subscribe(r[0][n])}if(this._indexProperty&&o<this.length-r[0].length-1){this._reportIndexes(s,o)}}var l=[].concat(r[0]);for(var n=0;n<r[1].length;n++){this._updateItem(r[2][n],r[1][n]);l.splice(r[3][n],0,r[2][n])}if(this._byKeyChange===true){this._byKeyChange=false;this.outByKeyChange()}else{this._byKeyChange=false}return l},hasItem:function(e,t){if(t)return this.indexOf(e)>=0;return Amm.Array.indexOf(e,this)>=0},strictIndexOf:function(e){return Amm.Array.indexOf(e,this)},intersect:function(e,t,i){if(i&&!(i instanceof Array))throw Error("`groups` must be an Array (or falseable value)");if(!e.length)return[];var r=this.getItems().concat(e);var n=Amm.Array.findDuplicates(r,false,t?null:this._comparison,this.length,true);var s=[];for(var o=0,a=n.length;o<a;o++){for(var l=0,h=n[o].length;l<h;l++){if(n[o][l]<this.length){s.push(r[n[o][l]]);if(i)i.push([n[o][l]].concat(n.slice(0,l)));break}}}return s},reject:function(e,t){if(!this._suppressDeleteEvent&&!this._allowDelete){throw Error(Amm.Collection.ERR_DELETE_DISALLOWED)}var i,r;if(typeof e!=="object"){i=parseInt(e);if(isNaN(i))throw Error("itemOrIndex must be an object or a number");if(i<0)i=this.length+i;if(i>=this.length)throw Error("index ["+i+"] doesn't exist");r=this[i]}else{r=e;i=t?this.indexOf(r):this.strictIndexOf(r);if(i<0)throw Error("itemOrIndex specifies non-existing item");r=this[i]}if(!this._suppressDeleteEvent&&!this._allowChangeOrder&&i<this.length-1){throw Error(Amm.Collection.ERR_REORDER_DISALLOWED)}this._rotate(i,-1);this._dissociate(r);if(this._indexProperty&&i<this.length)this._reportIndexes(null,i);if(!this._suppressDeleteEvent&&!this._updateLevel){this.outDeleteItem(i,r)}return r},push:function(e,t){if(!this._allowAdd){throw Error(Amm.Collection.ERR_ADD_DISALLOWED)}var i=Array.prototype.slice.apply(arguments);if(i.length===1)this.accept(i[0]);else this.acceptMany(i);return this.length},pop:function(){if(!this._allowDelete)throw Error(Amm.Collection.ERR_DELETE_DISALLOWED);if(this.length)return this.reject(this.length-1)},unshift:function(e,t){if(!this._allowAdd){throw Error(Amm.Collection.ERR_ADD_DISALLOWED)}if(!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);var i=Array.prototype.slice.apply(arguments);var r=this._sorted?undefined:0;if(i.length===1)this.accept(i[0],r);else this.acceptMany(i,r);return this.length},shift:function(){if(!this._allowDelete)throw Error(Amm.Collection.ERR_DELETE_DISALLOWED);if(!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);if(this.length)return this.reject(0)},splice:function(e,t,i,r){var n=Array.prototype.slice.call(arguments,2);if(n.length&&!this._allowAdd){throw Error(Amm.Collection.ERR_ADD_DISALLOWED)}if(t&&!this._allowDelete){throw Error(Amm.Collection.ERR_DELETE_DISALLOWED)}if(e<0){e=this.length+e;if(e<0)e=0}else if(e>this.length)e=this.length;if(e<this.length-t&&!this._allowChangeOrder){throw Error(Amm.Collection.ERR_REORDER_DISALLOWED)}if(t<0)t=0;var s=this.slice(e,e+t);var o=this._preAccept(n,e,t);var a=o[0],l=o[4],h=o[6],u=o[5];var f,c,_,m;var d,p,g,v;if(this._sorted){p=this._addNewToSorted(o[0]);for(var f=h.length-1;f>=0;f--){for(var c=p[1].length-1;c>=0;c--){if(p[1][c]>h[f])p[1][c]--;else break}}d=this._getInsertFragments(p[0],p[1]);g=l.length?this._getCutFragments(e,l):[];v=this._getGoodSplice(g,d)}else{v=[e,s,u]}if(this._byKeyChange!==true)this._byKeyChange=1;if(v)this._suppressDeleteEvent++;for(f=0,_=l.length;f<_;f++){this.reject(l[f])}if(v)this._suppressDeleteEvent--;var A=this.getItems();if(this._sorted){for(f=0;f<p[0].length;f++){var y=p[1][f];this._associate(p[0][f],y)}if(!v){this._outFragmentedInsert(d)}else{this._outSmartSplice(v[0],v[1],v[2])}}else{var C=u.length-(s.length-l.length);this._rotate(e,C);c=0;_=u.length;m=a.length;for(f=0;f<_;f++){c=0;while(c<=f&&u[f]!==a[c])c++;this[e+f]=u[f];if(u[f]===a[c]){this._associate(this[e+f],e+f)}}this._outSmartSplice(e,s,u)}for(f=0;f<o[0].length;f++){this._subscribe(o[0][f])}if(this._byKeyChange===true){this._byKeyChange=false;this.outByKeyChange()}else{this._byKeyChange=false}if(this._indexProperty)this._reportIndexes(A);for(var f=0;f<o[1].length;f++){if(o[2][f]!==o[1][f])this._updateItem(o[2][f],o[1][f])}return s},setItems:function(e){var t=[0,this.length].concat(e);this.splice.apply(this,t);return this.length},reverse:function(){if(!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);if(this._sorted){this.setSortReverse(!this.getSortReverse());return this.getItems()}else{var e=this.getItems(),t;t=Amm.Array.prototype.reverse.apply(this);if(this._indexProperty)this._reportIndexes(e);return t}},setItem:function(e,t){this.splice(e,1,t);return this[e]===t?e:this.indexOf(t)},removeAtIndex:function(e,t){this.reject(e);return true},moveItem:function(e,t){if(!this._allowChangeOrder)throw Error(Amm.Collection.ERR_REORDER_DISALLOWED);if(this._sorted){throw Error("Cannot moveItem() on sorted Collection. Check with getIsSorted() next time")}var i,r;if(e<=t){i=e;r=t}else{i=t;r=e}var n=Amm.Array.prototype.moveItem.call(this,e,t);if(this._indexProperty)this._reportIndexes(null,i,r+1);return n},_getCutFragments:function(e,t){var i=[],r=0,n=e,s=0,o=t.length,a=this.length;while(r<o&&n<a){if(t[r]===this[n]){s++;r++}else{if(s)i.push([n-s,s,t.slice(r-s,r)]);s=0}n++}if(s)i.push([n-s,s,t.slice(r-s,r)]);return i},_getInsertFragments:function(e,t){if(!e.length)return[];var i=[];var r=[t[0],[e[0]]];for(var n=1,s=e.length;n<s;n++){if(t[n]===r[0]+r[1].length){r[1].push(e[n])}else{i.push(r);r=[t[n],[e[n]]]}}i.push(r);return i},_getGoodSplice:function(e,t){var i=e.length,r=t.length;if(i>1||r>1)return null;if(!i&&!r)return null;if(!i&&r)return[t[0][0],[],t[0][1]];if(i&&!r)return[e[0][0],e[0][2],[]];if(i&&r&&e[0][0]===t[0][0])return[t[0][0],e[0][2],t[0][1]];return null},_outFragmentedInsert:function(e){for(var t=0;t<e.length;t++){this._outSmartSplice(e[t][0],[],e[t][1])}},insertItem:function(e,t){if(t<0)throw Error("`index` must be >= 0");var i;if(t===undefined||t>=this.length||this._sorted)i=this.accept(e);else i=this.accept(e,t);return this.strictIndexOf(e)},getIsSorted:function(){return this._sorted},_associate:function(e,t,i){if(this[t]!==e){throw Error("WTF - this[`index`] !== `item`")}if(this._assocProperty){Amm.setProperty(e,this._assocProperty,this._assocInstance||this)}if(this._assocEvents)this._associateEvents([e]);if(this._indexProperty){Amm.setProperty(e,this._indexProperty,t)}if(this._defaults)Amm.setProperty(e,this._defaults);if(i)this._subscribe(e);this.outOnAssociate(e,t);if(this._keyProperty){var r=Amm.getProperty(e,this._keyProperty);if(r!==undefined&&r!==null){this.k[r]=e;this.outByKeyChange()}}},outOnAssociate:function(e,t){return this._out("onAssociate",e,t)},_subscribe:function(e){if(this._changeEvents){for(var t=0,i=this._changeEvents.length;t<i;t++){e.subscribe(this._changeEvents[t],this._reportItemChangeEvent,this)}}if(this._indexPropertyIsWatched){var r=this._indexProperty+"Change";e.subscribe(r,this._reportItemIndexPropertyChange,this)}if(this._keyProperty){e.subscribe(this._keyProperty+"Change",this._handleKeyChange,this)}},_dissociate:function(e){if(this._changeEvents){e.unsubscribe(undefined,this._reportItemChangeEvent,this)}if(this._assocProperty&&Amm.getProperty(e,this._assocProperty)===(this._assocInstance||this)){Amm.setProperty(e,this._assocProperty,null)}if(this._assocEvents)this._associateEvents([e],true);if(this._indexPropertyIsWatched){if(this._indexPropertyIsWatched){var t=this._indexProperty+"Change";e.unsubscribe(t,this._reportItemIndexPropertyChange,this)}}if(this._keyProperty){var i=Amm.getProperty(e,this._keyProperty);if(i!==false&&i!==undefined&&this.k[i]===e){delete this.k[i];this.outByKeyChange()}e.unsubscribe(this._keyProperty+"Change",this._handleKeyChange,this)}if(this._undefaults){Amm.setProperty(e,this._undefaults)}if(this._sorter){this._lockSort++;this._sorter.unobserveObject(e);this._lockSort--}this.outOnDissociate(e);if(this._cleanupOnDissociate&&typeof(e.cleanup==="function")){e.cleanup()}},outOnDissociate:function(e){return this._out("onDissociate",e)},outOnCanAccept:function(e,t){t=t||{};return this._out("onCanAccept",e,t)},setAssocProperty:function(e){if(!e)e=null;var t=this._assocProperty;if(t===e)return;this._assocProperty=e;this._beginItemsUpdate();var i,r=this.length;if(t){for(i=0;i<r;i++)Amm.setProperty(this[i],t,null)}if(e){for(i=0;i<r;i++)Amm.setProperty(this[i],e,this._assocInstance||this)}this._endItemsUpdate();return true},getAssocProperty:function(){return this._assocProperty},setAssocInstance:function(e){var t=this._assocInstance;if(t===e)return;if(this._assocEvents)this._associateEvents(this,true);this._assocInstance=e;if(this._assocEvents)this._associateEvents(this);if(this._assocProperty){for(var i=0,r=this.length;i<r;i++)Amm.setProperty(this[i],this._assocProperty,this._assocInstance||this)}return true},getAssocInstance:function(){return this._assocInstance},setIndexProperty:function(e){if(!e)e=null;var t=this._indexProperty;if(t===e)return;this._indexProperty=e;var i=this.getObserveIndexProperty();if(i)this.setObserveIndexProperty(false);if(this._indexProperty){for(var r=0,n=this.length;r<n;r++){Amm.setProperty(this[r],this._indexProperty,r)}}if(i)this.setObserveIndexProperty(i);this._checkIndexPropertyWatched();return true},getIndexProperty:function(){return this._indexProperty},setObserveIndexProperty:function(e){e=!!e;var t=this._observeIndexProperty;if(t===e)return;this._observeIndexProperty=e;this._checkIndexPropertyWatched();return true},getObserveIndexProperty:function(){return this._observeIndexProperty},_checkIndexPropertyWatched:function(){var e=false;if(this._observeIndexProperty){e=!this._sorted&&this._indexProperty!==null}if(this._indexPropertyIsWatched!==e){var t=this._indexProperty+"Change";this._indexPropertyIsWatched=e;if(this._indexPropertyIsWatched){for(var i=0,r=this.length;i<r;i++){this[i].subscribe(t,this._reportItemIndexPropertyChange,this)}}else{for(var i=0,r=this.length;i<r;i++){this[i].unsubscribe(t,this._reportItemIndexPropertyChange,this)}}}},_reportItemIndexPropertyChange:function(e,t){if(this._suppressIndexEvents){return}var i=Amm.event.origin;var r=t;var n=e;if(n<0)n=0;else if(n>=this.length)n=this.length-1;if(this[r]!==i){if(this[n]===i)return;r=this.strictIndexOf(i);if(r<0)throw Error("WTF - received item indexProperty change event from item not belonging to this Collection")}if(r===n)return;this.moveItem(r,n)},setDefaults:function(e){if(e&&typeof e!=="object")throw Error("`defaults` must be an object");if(!e)e=null;var t=this._defaults;if(t===e)return;this._defaults=e;return true},getDefaults:function(){return this._defaults},setUndefaults:function(e){if(e&&typeof e!=="object")throw Error("`undefaults` must be an object");if(!e)e=null;var t=this._undefaults;if(t===e)return;this._undefaults=e;return true},getUndefaults:function(){return this._undefaults},getObservesItems:function(){return!!this._changeEvents},setChangeEvents:function(e){if(e){if(!(e instanceof Array))e=[e];else if(!e.length)e=null}else{e=null}var t=this._changeEvents;if(t===e)return;if(this._changeEvents&&e&&!Amm.Array.diff(e,this._changeEvents).length&&!Amm.Array.diff(this._changeEvents,e).length)return;if(t){for(var i=0,r=this.length;i<r;i++){this[i].unsubscribe(undefined,this._reportItemChangeEvent,this)}}if(e){var n=e.length;for(var i=0,r=this.length;i<r;i++){for(var s=0;s<n;s++){this[i].subscribe(e[s],this._reportItemChangeEvent,this)}}}this._changeEvents=e;return true},_reportItemChangeEvent:function(){var e=Amm.event.origin;if(this._itemUpdateLevel){if(Amm.Array.indexOf(e,this._itemUpdateQueue)<0){this._itemUpdateQueue.push(e)}}else{if(this._recheckUniqueness)this._performRecheckUniqueness(e);if(this._sorted){this._checkItemPosition(e)}this.outItemChange(e)}},outItemChange:function(e){return this._out("itemChange",e)},getChangeEvents:function(){return this._changeEvents},setComparison:function(e){if(this._comparison===e)return;var t=this._custComparison;var i=this._comparison;this._custComparison=e;this._onlyStrict=!(this._keyProperty||this._comparisonProperties||e);if(!this._onlyStrict){this._comparison=this._compareWithProps}else{this._comparison=null}try{this._custComparison=e;this._checkDuplicates("setComparison()",[],0,0,true,this._comparison)}catch(e){this._custComparison=t;this._comparison=i;throw e}return true},setComparisonProperties:function(e){if(e){if(!(e instanceof Array))e=[e];else if(!e.length)e=null}else{e=null}var t=this._comparisonProperties;if(t===e)return;if(t&&e&&t.length===e&&!Amm.Array.equal(t,e).length)return;var i=this._comparisonProperties;var r=this._comparison;this._onlyStrict=!(this._keyProperty||e||this._custComparison);if(this._onlyStrict){this._comparison=null}else{this._comparison=this._compareWithProps}try{this._comparisonProperties=e;this._checkDuplicates("setComparisonProperties()",[],0,0,true,this._comparison)}catch(e){this._comparisonProperties=i;this._comparison=r;throw e}return true},getComparisonProperties:function(){if(!this._comparisonProperties)return[];return this._comparisonProperties},setIgnoreExactMatches:function(e){var t=this._ignoreExactMatches;if(t===e)return;this._ignoreExactMatches=e;return true},getIgnoreExactMatches:function(){return this._ignoreExactMatches},setRecheckUniqueness:function(e){var t=this._recheckUniqueness;if(t===e)return;this._recheckUniqueness=e;return true},getRecheckUniqueness:function(){return this._recheckUniqueness},_implCompareWithProps:function(e,t){var i,r,n;if(e===t)return 0;if(this._comparisonProperties){for(var s=0,o=this._comparisonProperties.length;s<o;s++){i=this._comparisonProperties[s];r=Amm.getProperty(e,i);n=Amm.getProperty(t,i);if(r!==n)return-1}}if(this._keyProperty){r=Amm.getProperty(e,this._keyProperty);if(typeof r==="object")throw this._keyPropertyError(e,r);if(r!==undefined&&r!==null){n=Amm.getProperty(t,this._keyProperty);if(n!==undefined&&n!==null){if(typeof n==="object")throw this._keyPropertyError(t,n);if(""+r!==""+n)return-1}}}if(this._custComparison)return this._custComparison(e,t);return 0},_keyPropertyError:function(e,t,i){if(i===undefined)i=this._keyProperty;return new Error("Invalid value of keyProperty '"+this._keyProperty+"': object value isn't allowed")},setSortProperties:function(e){if(e){if(!(e instanceof Array))e=[e];else if(!e.length)e=null}else{e=null}var t=this._sortProperties;if(t===e)return;if(t&&e&&Amm.Array.equal(t,e))return;this._sortProperties=e;this._sorted=!!(this._sortFn||this._sortProperties||this._sorter);this._checkIndexPropertyWatched();if(this._sorted){this._sort()}return true},getSortProperties:function(){if(!this._sortProperties)return[];return this._sortProperties},setSortReverse:function(e){e=!!e;var t=this._sortReverse;if(t===e)return;this._sortReverse=e;if(this._sorted)this._sort();return true},getSortReverse:function(){return this._sortReverse},_implSortWithProps:function(e,t){if(e===t)return 0;var i=this._sortReverse?-1:1;if(this._sortProperties){for(var r=0,n=this._sortProperties.length;r<n;r++){var s=this._sortProperties[r];var o=Amm.getProperty(e,s);var a=Amm.getProperty(t,s);if(o<a)return-1*i;else if(o>a)return 1*i}}if(this._sortFn)return this.sortFn(e,t)*i},setSortFn:function(e){if(e){if(typeof e!=="function")throw Error("sortFn must be a function or a null")}else{e=null}var t=this._sortFn;if(t===e)return;this._sortFn=e;this._sorted=!!(this._sortFn||this._sortProperties||this._sorter);this._checkIndexPropertyWatched();if(this._sorted)this._sort();return true},getSortFn:function(){return this._sortFn},setSorter:function(e){var t=false;if(e){if(typeof e==="object"&&!e["Amm.Sorter"]){e=Amm.constructInstance(e,"Amm.Sorter");t=true}}else{e=null}var i=this._sorter;if(i===e)return;if(this._sorter){if(this._sorterIsAggregate)this._sorter.cleanup();else this._subSorter(true)}this._sorterIsAggregate=t;this._sorter=e;if(this._sorter){this._subSorter()}this._sorted=!!(this._sortFn||this._sortProperties||this._sorter);this._checkIndexPropertyWatched();if(this._sorted){this._sort()}return true},_subSorter:function(e){var t=e?"unsubscribe":"subscribe";this._sorter[t]("matchesChange",this._handleSorterNeedSort,this);this._sorter[t]("needSort",this._handleSorterNeedSort,this);this._sorter.setObservedObjects(e?[]:this.getItems())},_handleSorterNeedSort:function(){if(this._lockSort)return;if(this._updateLevel){this._needSort=true;return}this._sort()},getSorter:function(){return this._sorter},sort:function(e){this._needSort=false;if(e instanceof Array){var i={_sortReverse:this._sortReverse,_sortWithProps:this._implSortWithProps,_sortProperties:e,_sortFn:null};var t=function(e,t){return i._sortWithProps(e,t)};var r=this.sort(t);return r}if(this._sorter||this._sortFn){if(e)throw Error("Cannot sort(fn) when `sortFn` or `sorter` is set; use sort() with no parameters");return this._sort()}if(this._sortProperties){throw Error("Cannot sort() when `sortProperties` is set")}var n={},s;if(this._indexProperty)s=this.getItems();var r;if(this._sorter)r=Amm.Array.prototype.sort.call(this,this._sorter.getCompareClosureFn(),n);else r=Amm.Array.prototype.sort.call(this,e,n);if(this._indexProperty&&n.changed&&s)this._reportIndexes(s);return r},_doEndUpdate:function(){if(this._needSort)this._sort();if(this._indexProperty)this._reportIndexes(this._preUpdateItems);Amm.Array.prototype._doEndUpdate.call(this);if(this._byKeyChange){this._byKeyChange=false;this.outByKeyChange()}},_reportIndexes:function(e,t,i){this._suppressIndexEvents++;var r=i||this.length,t=t||0,n;try{for(var s=t;s<r;s++){if(!e||this[s]!==e[s]){Amm.setProperty(this[s],this._indexProperty,s)}}}catch(n){this._suppressIndexEvents--;throw n}this._suppressIndexEvents--},_sort:function(){this._needSort=false;if(!(this._sortFn||this._sortProperties||this._sorter)){throw Error("WTF - call to _sort() w/o _sorter, _sortFn or _sortProperties")}var e={},t;if(this._indexProperty)t=this.getItems();Amm.Array.prototype.sort.call(this,this._sorter?this._sorter.getCompareClosureFn():this._sortWithProps,e);if(this._indexProperty&&e.changed&&t)this._reportIndexes(t);return e.changed},_locateItemIndexInSortedArray:function(e){if(!this.length)return 0;if(this._sorter){this._lockSort++;this._sorter.observeObject(e);this._lockSort--}var t=Amm.Collection.binSearch(this,e,this._sorter?this._sorter.getCompareClosureFn():this._sortWithProps);return t[0]},_locateManyItemIndexesInSortedArray:function(e){var t,i=e.length,r=this._sorter?this._sorter.getCompareClosureFn():this._sortWithProps;if(this._sorter){this._lockSort++;for(t=0;t<i;t++){this._sorter.observeObject(e[t])}this._lockSort--}e.sort(r);var n=0,s=[];for(t=0;t<i;t++){n=Amm.Collection.binSearch(this,e[t],r,n)[0];if(n<0)n=0;s.push(n+t)}return s},getAllowUpdate:function(){return this._allowUpdate},setUpdateProperties:function(e){if(e){if(!(e instanceof Array))e=[e];else if(!e.length)e=null}else{e=null}var t=this._updateProperties;if(t===e)return;this._updateProperties=e;this._allowUpdate=this._updateProperties||this._updateFn;return true},getUpdateProperties:function(){if(!this._updateProperties)return[];return this._updateProperties},_updateItem:function(e,t){this._beginItemsUpdate();try{if(this._updateProperties&&e!==t){for(var i=0,r=this._updateProperties.length;i<r;i++){var n=this._updateProperties[i];Amm.setProperty(e,n,Amm.getProperty(t,n))}}if(this._updateFn)this._updateFn(e,t);else{if(e===t){console.warn("updateFn not set; exactly matching items won't be update()'d)")}}}catch(e){this._endItemsUpdate();throw e}this._endItemsUpdate()},_beginItemsUpdate:function(){this._itemUpdateLevel++},_endItemsUpdate:function(){this._itemUpdateLevel--;if(this._endItemsUpdateLock)return;this._endItemsUpdateLock=true;if(this._recheckUniqueness&&this._itemUpdateQueue.length)this._performRecheckUniqueness(this._itemUpdateQueue,true);if(!this._itemUpdateLevel&&this._itemUpdateQueue.length){for(var e=0;e<this._itemUpdateQueue.length;e++){this.outItemChange(this._itemUpdateQueue[e])}this._itemUpdateQueue=[]}this._endItemsUpdateLock=false;if(this._byKeyChange){this._byKeyChange=false;this.outByKeyChange()}if(this._sorted)this._sort()},_checkItemPosition:function(e,t){if(t===undefined){if(this._indexProperty){t=Amm.getProperty(e,this._indexProperty);if(typeof t==="number"&&this[t]!==e)t=this.strictIndexOf(e)}else{t=this.strictIndexOf(e)}if(t<0)throw Error("WTF: `item` not found in this")}if(this[t]!==e)throw Error("WTF: this[`index`] !== `item`");var i=undefined,r=false,n,s;if(t>0&&this._sortWithProps(this[t-1],e)>0){var o=Amm.Collection.binSearch(this,e,this._sortWithProps,0,t-1);if(o[0]+1>=t){r=true}else{i=n=o[0]+1;s=t}}if(t<this.length-1&&this._sortWithProps(e,this[t+1])>0){var o=Amm.Collection.binSearch(this,e,this._sortWithProps,t+1,this.length-1);if(o[0]+1<=t){r=true}else{i=s=o[0]+1;n=t}}if(r)this._sort();else if(i!==undefined){Amm.Array.prototype.moveItem.call(this,t,i);if(s>=this.length)s=this.length-1;if(this._indexProperty)this._reportIndexes(null,n,s)}},_performRecheckUniqueness:function(e,t){if(!this._custComparison&&!this._comparisonProperties){console.warn("having setRecheckUniqueness(true) w/o prior setComparsion()"+" or setComparisonProperies() makes no sense - refusing to re-check");return}var i;if(!t)i=[e];else i=e;for(var r=0,n=i.length;r<n;r++){var s=-1,o=[],a=null;do{s=this.indexOf(i[r],s+1);if(s>=0){if(i[r]!==this[s]){o.push(s)}else{a=s}}}while(s>=0);if(a===null)console.warn("Item that was changed is no more in the collection");if(!o.length)continue;if(!a&&o.length===1){console.warn("Item that was changed has a duplicate,"+" but is no more in the collection."+" Not throwing the exception since the collection"+" is still unique.")}else{throw Error("After the change of this["+a+"],"+" duplicate(s) appeared: this["+o.join("], this[")+"]")}}},setUpdateFn:function(e){if(e&&typeof e!=="function")throw Error("updateFn must be a function");var t=this._updateFn;if(t===e)return;this._updateFn=e;this._allowUpdate=this._updateProperties||this._updateFn;return true},getUpdateFn:function(){return this._updateFn},setCleanupOnDissociate:function(e){e=!!e;var t=this._cleanupOnDissociate;if(t===e)return;this._cleanupOnDissociate=e;return true},getCleanupOnDissociate:function(){return this._cleanupOnDissociate},setAllowAdd:function(e){e=!!e;var t=this._allowAdd;if(t===e)return;this._allowAdd=e;return true},getAllowAdd:function(){return this._allowAdd},setAllowDelete:function(e){e=!!e;var t=this._allowDelete;if(t===e)return;this._allowDelete=e;return true},getAllowDelete:function(){return this._allowDelete},setAllowChangeOrder:function(e){e=!!e;var t=this._allowChangeOrder;if(t===e)return;this._allowChangeOrder=e;return true},getAllowChangeOrder:function(){return this._allowChangeOrder},cleanup:function(){var e=this._allowDelete;if(!e)this.setAllowDelete(true);if(this._sorterIsAggregate){this._sorter.cleanup();this._sorter=null}Amm.Array.prototype.cleanup.call(this);if(!e)this.setAllowDelete(e)},setAssocEvents:function(e){var t=null;if(e){if(typeof e==="object"){t=[];for(var i in e)if(e.hasOwnProperty(i)){t.push([i,e[i]])}}else{throw Error("`assocEvents` must be an object")}}if(this._assocEvents&&this.length)this._associateEvents(this,true);this._assocEvents=t;if(e)this._associateEvents(this);return true},_associateEvents:function(e,t){if(!this._assocEvents)return;if(!e.length)return;var i=this._assocInstance||this;var r=this._assocEvents.length;var n=t?"unsubscribe":"subscribe";for(var s=0,o=e.length;s<o;s++){for(var a=0;a<r;a++){if(t||e[s].hasEvent(this._assocEvents[a][0])){e[s][n](this._assocEvents[a][0],this._assocEvents[a][1],i)}}}},getAssocEvents:function(){if(!this._assocEvents)return{};var e={};for(var t=0,i=this._assocEvents.length;t<i;t++){e[this._assocEvents[t][0]]=this._assocEvents[t][1]}return e},setKeyProperty:function(e){if(!e)e=null;var t=this._keyProperty;if(t===e)return;var i=this._keyProperty;var r=this._comparison;this._onlyStrict=!(e||this._comparisonProperties||this._custComparison);if(this._onlyStrict){this._comparison=null}else{this._comparison=this._compareWithProps}try{this._keyProperty=e;this._checkDuplicates("setKeyProperty()",[],0,0,true,this._comparison)}catch(e){this._keyProperty=i;this._comparison=r;throw e}if(t)this._unobserveKeyProperty();this._keyProperty=e;this._observeKeyProperty();this._rebuildKeys();this.outKeyPropertyChange(e,t);return true},_unobserveKeyProperty:function(){var e=this._keyProperty+"Change";for(var t=0,i=this.length;t<i;t++){this[t].unsubscribe(e,this._handleKeyChange,this)}},_observeKeyProperty:function(){var e=this._keyProperty+"Change";for(var t=0,i=this.length;t<i;t++){this[t].subscribe(e,this._handleKeyChange,this)}},_lockKeyValueChange:false,_revertKeyValue:function(e,t){var i;i=this._lockKeyValueChange;this._lockKeyValueChange=e;try{Amm.setProperty(e,this._keyProperty,t)}catch(e){this._lockKeyValueChange=i;throw e}this._lockKeyValueChange=i},_handleKeyChange:function(e,t){var i=Amm.event.origin,r;if(this._lockKeyValueChange&&this._lockKeyValueChange===i)return;if(typeof e==="object"){this._revertKeyValue(i,t);throw this._keyPropertyError(i,e)}if(e!==null&&e!==undefined){if(this.k[e]&&this.k[e]!==i){this._revertKeyValue(i,t);throw Error("Duplicate value of keyProperty '"+this._keyProperty+"': object with key '"+e+"' already exists in the collection")}this.k[e]=i}if(t!==undefined&&t!==null){if(this.k[t]!==i){this._rebuildKeys();return}else{delete this.k[t]}}this.outByKeyChange()},_rebuildKeys:function(){this.k={};for(var e=0,t=this.length;e<t;e++){var i=Amm.getProperty(this[e],this._keyProperty);if(i===null||i===undefined)continue;if(typeof i==="object")throw this._keyPropertyError(this[e],i);this.k[i]=this[e]}this.outByKeyChange()},getKeyProperty:function(){return this._keyProperty},outKeyPropertyChange:function(e,t){this._out("keyPropertyChange",e,t)},getByKey:function(e){return this.k[e]},setByKey:function(e){console.warn("byKey is read-only property")},outByKeyChange:function(){if(this._updateLevel||this._itemUpdateLevel||this._byKeyChange){this._byKeyChange=true;return}this._out("byKeyChange")}};Amm.extend(Amm.Collection,Amm.Array);Amm.Operator=function(){this._subs=[]};Amm.Operator.CONTEXT_ID=1;Amm.Operator.getNextContextId=function(){return""+Amm.Operator.CONTEXT_ID++};Amm.Operator.NON_CACHEABLE_VALUE=1;Amm.Operator.NON_CACHEABLE_CONTENT=2;Amm.Operator.CONTENT_NOTIFIED=1;Amm.Operator.CONTENT_PERIODICALLY_CHECKED=2;Amm.Operator.CONTENT_OPERAND_REPORTED=4;Amm.Operator.prototype={"Amm.Operator":"__CLASS__",id:null,_parent:null,_parentOperand:null,_expression:null,_subs:null,_defSub:null,_value:undefined,_hasValue:false,_lockChange:0,_isEvaluating:0,_contentChanged:null,_evaluated:0,_nonCacheable:0,_hasNonCacheable:0,_destChanged:0,_level:null,_checkArrayChange:false,OPERANDS:[],supportsAssign:false,beginPos:null,endPos:null,STATE_SHARED:{_contextState:true,_contextId:true,_numCtx:true,_parent:true,_parentOperand:true,_expression:true,_level:true,_instanceStateShared:true,beginPos:true,endPos:true,STATE_SHARED:true,STATE_VARS:true,STATE_PROTO:true,OPERANDS:true},STATE_PROTO:{},STATE_VARS:[],_instanceStateShared:null,_contextState:null,_contextId:"0",_numCtx:1,setExpression:function(e){Amm.is(e,"Amm.Expression","Expression");if(this._expression===e)return;else if(this._expression)Error("Can setExpression() only once");this._expression=e;for(var t=0,i=this.OPERANDS.length;t<i;t++){var r=this["_"+this.OPERANDS[t]+"Operator"];if(r){r.setExpression(e)}}if(this._defSub)this._subscribeDeferreds();return true},_subscribeDeferreds:function(){for(var e=0;e<this._defSub.length;e++){this._expression.subscribeOperator(this._defSub[e][0]||this._expression,this._defSub[e][1],this,this._defSub[e][2])}this._defSub=null},getExpression:function(){return this._expression},setParent:function(e,t){this._parent=e;if(t!==undefined)this._parentOperand=t;var i=e.getExpression();if(i)this.setExpression(i)},getParent:function(){return this._parent},getParentOperand:function(){return this._parentOperand},getLevel:function(){if(this._level===null&&this._parent)this._level=this._parent?this._parent.getLevel()+1:0;return this._level},_sub:function(e,t,i,r,n){var s=this._expression||(this["Amm.Expression"]?this:null);if(!s&&!this._defSub)this._defSub=[];if(e){var o=Amm.Array.indexOf(e,this._subs);if(o<0)this._subs.push(e)}else{e=s||null;if(!s)n=true}r=r||null;i=i||this._defaultHandler;if(typeof t==="string"){if(!n&&!e.hasEvent(t))return;if(s){s.subscribeOperator(e,t,this,i,r)}else{this._defSub.push([e,t,i,r])}return}if(t instanceof Array){for(var a=0,l=t.length;a<l;a++){if(n||e.hasEvent(t[a])){if(s){s.subscribeOperator(e,t[a],this,i,r)}else{this._defSub.push([e,t[a],i,r])}}}}else{for(var a in t){if(!t.hasOwnProperty(a)||!n&&!e.hasEvent(a))continue;if(s){s.subscribeOperator(e,a,this,t[a],r)}else{this._defSub.push([e,a,t[a],r])}}}},_unsub:function(e,t,i,r){if(r===undefined&&arguments.length<4)r=null;if(!e)e=null;if(this._defSub){for(var n=this._defSub.length-1;n>=0;n--){if(this._defSub[n][0]===e&&t===undefined||t===this._defSub[n][1]&&i===undefined||i===this._defSub[n][2]&&r===undefined||r===this._defSub[n][3])this._defSub.splice(n,1)}}else{var s=this._expression||(this["Amm.Expression"]?this:null);if(!s)return;var o=s.unsubscribeOperator(e,t,this,i,r);if(!o){var a=Amm.Array.indexOf(e,this._subs);if(a>=0)this._subs.splice(a,1)}}},notifyOperandChanged:function(e,t,i,r){this._propagateContext(e,r,false);if(this._lockChange){return}this._setOperandValue(e,t)},notifyOperandContentChanged:function(e,t,i){if(this._contentChanged!==null){this._contentChanged++;return}if(this._isEvaluating)return;var r=this._expression||(this["Amm.Expression"]?this:null);if(r&&r.getUpdateLevel()){r.queueUpdate(this);return}this.evaluate();return true},_observeOperandContent:function(e,t,i){var r="_"+e+"Observe";var n=this[r];var s=false;var o=false;if(n&&i){o=this._implObserveOperandContent(e,t,i);this[r]=false;s=n===Amm.Operator.CONTENT_PERIODICALLY_CHECKED}else if(!n&&!i){o=this[r]=this._implObserveOperandContent(e,t,i);s=o===Amm.Operator.CONTENT_PERIODICALLY_CHECKED}if(!s)return o;if(!i){var a;a=this._nonCacheable|Amm.Operator.NON_CACHEABLE_CONTENT;this._setNonCacheable(a)}else{var l=false;for(var h=0,u=this.OPERANDS.length;h<u;h++){l=this["_"+this.OPERANDS[h]+"Observe"]===Amm.Operator.CONTENT_PERIODICALLY_CHECKED;if(l)break}if(!l)this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_CONTENT)}return o},_isValueObservable:function(e,t){if(!t||typeof t!=="object")return;return t["Amm.Array"]||t instanceof Array},_implObserveOperandContent:function(e,t,i){if(!t||typeof t!=="object")return;if(t["Amm.Array"]){if(i){this._unsub(t,"spliceItems",this._handleAmmArraySplice,e)}else{this._sub(t,"spliceItems",this._handleAmmArraySplice,e,true)}return Amm.Operator.CONTENT_NOTIFIED}if(t instanceof Array){this["_"+e+"Old"]=i?undefined:[].concat(t);return Amm.Operator.CONTENT_PERIODICALLY_CHECKED}},_handleAmmArraySplice:function(e,t,i,r){var n=this._makeChangeInfoForSplice(e,t,i);r=arguments[arguments.length-1];this.notifyOperandContentChanged(r,n,true)},_checkContentChanged:function(e){var t="_"+e+"Old",i=this[t],r="_"+e+"Value",n=this[r];if(!(n instanceof Array)){this[t]=null;return}this[t]=[].concat(n);if(!(i instanceof Array))return;var s=Amm.Array.smartDiff(i,n,null,true);if(!s)return;if(s[0]!=="splice")Error("Assertion - should receive only 'splice' event (spliceOnly === true)");var o=s[2]?i.slice(s[1],s[1]+s[2]):[];var a=this._makeChangeInfoForSplice(s[1],o,s[3]);this.notifyOperandContentChanged(e,a,true)},_makeChangeInfoForSplice:function(e,t,i){return{"Amm.SpliceInfo":"__STRUCT__",type:"splice",index:e,cut:t,insert:i}},getReportsContentChanged:function(){return false},getValue:function(e){if(e||!this._hasValue)this.evaluate(e);return this._value},setValue:function(e,t){if(!this.supportsAssign)throw Error(Amm.getClass(this)+" cannot be used as lvalue");var i=this._doSetValue(e);if(!i)return true;if(t)throw i;return false},_doSetValue:function(e,t){if(t)return"assignment not supported";Error("Call to abstract method _doSetValue")},getReadonly:function(){var e=this.supportsAssign?this._doSetValue(undefined,true):"assignment not supported";if(!e)e=false;return e},_doEvaluate:function(e){Error("Call to abstract method _doEvaluate")},toFunction:function(){Error("Call to abstract method toFunction")},assignmentFunction:function(){Error("Call to abstract method assignmentFunction")},_operandFunction:function(e){var t="_"+e+"Operator";if(this[t])return this[t].toFunction();var i=this._getOperandValue(e);return function(){return i}},_reportChange:function(e){if(this._parent){this._parent.notifyOperandChanged(this._parentOperand,this._value,e,this)}},_checkNonCacheableOperators:function(){if(this._hasNonCacheable<=!!this._nonCacheable)return;for(var e=0,t=this.OPERANDS.length;e<t;e++){var i="_"+this.OPERANDS[e]+"Operator";if(!this[i])continue;if(this[i]._contextId!==this._contextId){this._propagateContext(i,this[i],true)}if(this[i]._hasNonCacheable){this[i].checkForChanges()}}},checkForChanges:function(){if(!this._hasNonCacheable)return;var e=this._evaluated;this._checkNonCacheableOperators();if(this._nonCacheable&Amm.Operator.NON_CACHEABLE_CONTENT){this._contentChanged=0;for(var t=0,i=this.OPERANDS.length;t<i;t++){if(this["_"+this.OPERANDS[t]+"Observe"]===Amm.Operator.CONTENT_PERIODICALLY_CHECKED){this._checkContentChanged(this.OPERANDS[t])}}if(this._contentChanged)this.evaluate();this._contentChanged=null}if(this._nonCacheable&Amm.Operator.NON_CACHEABLE_VALUE&&this._evaluated===e){this.evaluate()}},evaluate:function(e){this._isEvaluating++;this._evaluated++;this._hasValue=true;var t=this._doEvaluate(e),i=this._value,r=this._hasValue&&this._value!==t;if(r&&this._checkArrayChange&&t instanceof Array&&this._value instanceof Array){if(Amm.Array.equal(this._value,t)){r=false;t=this._value}}this._value=t;if(r)this._reportChange(i);if(this._destChanged){this._destChanged=false;this._parent.notifyWriteDestinationChanged(this)}this._isEvaluating--;return this._value},_defaultHandler:function(){var e=this._expression||(this["Amm.Expression"]?this:null);if(e&&e.getUpdateLevel()){e.queueUpdate(this);return}this.evaluate()},hasOperand:function(e){return!!(this["_"+e+"Exists"]||this["_"+e+"Operator"])},_setOperand:function(e,t){var i="_"+e+"Operator";var r="_"+e+"Value";var n="_"+e+"Exists";var s="_"+e+"Observe";var o=t&&typeof t==="object"&&t["Amm.Operator"];if(this[i]){if(this[i]===t)return;if(this[i]._hasNonCacheable)this._setHasNonCacheable(this._hasNonCacheable-1);this[i].cleanup()}var a;if(o){if(this[s])this._observeOperandContent(e,this[r],true);if(t.getReportsContentChanged())this[s]=Amm.Operator.CONTENT_OPERAND_REPORTED;this[i]=t;if(t._hasNonCacheable){this._setHasNonCacheable(this._hasNonCacheable+1)}if(!this[n]){this[i].setParent(this,e);this[r]=undefined;return}else{this._lockChange++;this[i].setParent(this,e);a=this[i].getValue();this._lockChange--}var l=e+"OperatorChange";if(typeof this[l]==="function"){this[l](this[i])}}else{a=t}this._setOperandValue(e,a)},_setOperandValue:function(e,t){var i="_"+e+"Value";var r="_"+e+"Exists";var n="_"+e+"Change";var s="_"+e+"Events";var o=this[i];var a=this[r];var l=!a||this[i]!==t;var h,u;if(this[s]){h=t&&t["Amm.WithEvents"]?t:null;u=this[r]&&this[i]&&this[i]["Amm.WithEvents"]?this[i]:null}this[r]=true;this[i]=t;if(h||u)this[s](h,u);if(l){var f="_"+e+"Observe";if(this[f]!==Amm.Operator.CONTENT_OPERAND_REPORTED){if(this[f])this._observeOperandContent(e,o,true);if(this._isValueObservable(e,t))this._observeOperandContent(e,t)}if(this.supportsAssign&&this._parent&&this._parent["Amm.Expression"]){this._destChanged=true}if(this[n])this[n](t,o,a);if(!this._isEvaluating){var c=this._expression||(this["Amm.Expression"]?this:null);if(c&&c.getUpdateLevel()){c.queueUpdate(this)}else{this.evaluate()}}}},finishUpdate:function(){this.evaluate()},_propagateContext:function(e,t,i){if(i)t.setContextId(this._contextId);else this.setContextId(t._contextId)},_getOperandValue:function(e,t){var i="_"+e+"Operator",r=this[i];var n="_"+e+"Value";var s="_"+e+"Exists";if(r&&r._contextId!==this._contextId)this._propagateContext(e,r,true);if(r&&(t||!this[s]||r._hasNonCacheable))this._setOperandValue(e,r.getValue(t));if(this[s])return this[n];return undefined},_setNonCacheable:function(e){var t=this._nonCacheable;if(t===e)return;this._nonCacheable=e;if(e)this._setHasNonCacheable(this._hasNonCacheable+1);else this._setHasNonCacheable(this._hasNonCacheable-1);return true},getNonCacheable:function(){return this._nonCacheable},_setHasNonCacheable:function(e){e=parseInt(e);if(e<0)e=0;var t=this._hasNonCacheable;if(t===e)return;this._hasNonCacheable=e;if(!!t!==!!e)this._reportNonCacheabilityChanged(!!e);return true},_reportNonCacheabilityChanged:function(e){if(this._parent){this._parent.notifyOperandNonCacheabilityChanged(this._parentOperand,e,this)}},notifyOperandNonCacheabilityChanged:function(e,t,i){if(this._contextId!==i._contextId){this._propagateContext(e,i)}if(t)this._setHasNonCacheable(this._hasNonCacheable+1);else this._setHasNonCacheable(this._hasNonCacheable-1)},getHasNonCacheable:function(){return this._hasNonCacheable},getOperator:function(e){if(!e)e=this.OPERANDS[0];else if(typeof e==="number")e=this.OPERANDS[e];var t="_"+e+"Operator";if(!(t in this))throw Error("No such operand: '"+e+"' in '"+Amm.getClass(this));var i;i=this[t];if(i&&arguments.length>1){return i.getOperator.apply(i,Array.prototype.slice.call(arguments,1))}return i},deleteContext:function(e){if(e===undefined)e=this._contextId;else if(e!==this._contextId){if(!this._contextState[e]){return}this.setContextId(e)}this._partialCleanup();if(this._contextState!==null)this._contextState[e]=null;for(var t=0,i=this.OPERANDS.length;t<i;t++){var r=this.OPERANDS[t],n="_"+r+"Operator",s=this[n];if(s){s.deleteContext(e)}}this._numCtx--},_partialCleanup:function(){var e=this._subs;this._subs=[];var t=this._expression||(this["Amm.Expression"]?this:null);if(t){for(var i=e.length-1;i>=0;i--){t.unsubscribeOperator(e[i],undefined,this,undefined,undefined)}}},cleanup:function(){this._partialCleanup();this._parent=null;var e=this._expression||(this["Amm.Expression"]?this:null);this._expression=null;this._defSub=null;this._contextState={};for(var t=0,i=this.OPERANDS.length;t<i;t++){var r=this.OPERANDS[t];var n="_"+r+"Operator";var s="_"+r+"Value";this[s]=null;if(this[n]){this[n].cleanup();this[n]=null}}},getSrc:function(){var e=this._expression;if(!e){e=this._parent;while(e&&!e["Amm.Expression"])e=e._parent}if(!e)return;if(this.beginPos===null)return;return e.getSrc(this.beginPos,this.endPos)},createContext:function(e){var t=Amm.Operator.getNextContextId();this.setContextId(t);if(e&&typeof e==="object"){Amm.init(this,e)}return t},setContextIdToDispatchEvent:function(e,t,i){this.setContextId(e)},setContextId:function(e){if(this._contextId===e)return;if(!this._contextState){this._contextState={};this._populateInstanceStateShared()}if(this._contextState[this._contextId]!==null)this._contextState[this._contextId]=this._getContextState();var t,i=false;if(e in this._contextState){t=this._contextState[e];if(t===null){Error("Attempt to setContextId() of already destroyed context")}}else{t=this._constructContextState();i=true;this._numCtx++}this._contextId=e;this._setContextState(t,i)},getContextId:function(){return this._contextId},hasContext:function(e){return this._contextId===e||this._contextState&&this._contextState[e]},listContexts:function(){var e=[];for(var t in this._contextState)if(this._contextState.hasOwnProperty(t)&&this._contextState[t]!==null){e.push(t)}if(!(this._contextId in this._contextState))e.push(this._contextId);return e},_getContextState:function(){var e={};for(var t=0,i=this.STATE_VARS.length;t<i;t++){var r=this.STATE_VARS[t];if(!this._instanceStateShared||!this._instanceStateShared[r]){e[r]=this[r]}}return e},_constructContextState:function(){var e={};for(var t=0,i=this.STATE_VARS.length;t<i;t++){var r=this.STATE_VARS[t];if(this._instanceStateShared&&this._instanceStateShared[r])continue;e[r]=this.STATE_PROTO[r]}e._subs=[];return e},_setContextState:function(e,t){if(t&&!this._allSubs)this._allSubs=[].concat(this._subs);this.getExpression();for(var i in e)if(e.hasOwnProperty(i)){this[i]=e[i]}if(t){this._initContextState(this._contextId,true)}if(this._defSub&&this._expression){this._subscribeDeferreds()}},_initContextState:function(e,t){if(!t){this.setContextId(e);return}this._isEvaluating++;for(var i=0,r=this.OPERANDS.length;i<r;i++){var n="_"+this.OPERANDS[i],s=n+"Operator",o=n+"Value",a=n+"Exists",l=n+"Observe";if(this[a]&&!this[s]){var h=this[o];this[o]=this.STATE_PROTO[o];this[a]=false;this._setOperandValue(this.OPERANDS[i],h)}else if(this[s]){this[s]._initContextState(e)}}this._isEvaluating--},destroyContext:function(){this._partialCleanup();var e=0;if(!(e in this._contextState)){e=null;for(e in this._contextState)if(this._contextState.hasOwnProperty(e))break}if(e!==null)this._setContextState(this._contextState[e])},_populateInstanceStateShared:function(){if(!this._instanceStateShared){this._instanceStateShared={}}for(var e=0,t=this.OPERANDS.length;e<t;e++){var i=this.OPERANDS[e];var r="_"+i+"Operator";var n="_"+i+"Value";var s="_"+i+"Exists";var o="_"+i+"Observe";this._instanceStateShared[r]=true;if(!this[r]){this._instanceStateShared[n]=true;this._instanceStateShared[s]=true;this._instanceStateShared[o]=true}}},getNonCacheableChildren:function(e){if(!this._hasNonCacheable)return[];var t=[];for(var i=0,r=this.OPERANDS.length;i<r;i++){var n=this.getOperator(this.OPERANDS[i]);if(!n)continue;if(n._nonCacheable)t.push(n);if(e&&n._hasNonCacheable){t=t.concat(n.getNonCacheableChildren(true))}}return t}};Amm.Operator.beforeExtend=function(e,t,i){if(!e.prototype.STATE_SHARED)e.prototype.STATE_SHARED={};Amm.override(e.prototype.STATE_SHARED||{},this.prototype.STATE_SHARED);if(!e.beforeExtend)e.beforeExtend=this.beforeExtend;if(!(e.prototype.STATE_VARS instanceof Array)){e.prototype.STATE_VARS=[]}if(!e.prototype.STATE_PROTO)e.prototype.STATE_PROTO={}};Amm.Operator.afterExtend=function(e,t,i){Amm.Operator.populateStateVars(e);if(!e.afterExtend)e.afterExtend=this.afterExtend};Amm.Operator.populateStateVars=function(e){var t=e.prototype;for(var i in t){if(t.hasOwnProperty(i)&&!t.STATE_SHARED[i]&&typeof t[i]!=="function"&&t[i]!=="__CLASS__"&&t[i]!=="__PARENT__"&&t[i]!=="__INTERFACE__"){t.STATE_VARS.push(i);t.STATE_PROTO[i]=t[i]}}if(t.OPERANDS instanceof Array){for(var i=0,r=t.OPERANDS.length;i<r;i++){var n=t.OPERANDS[i];var s="_"+n+"Value";var o="_"+n+"Exists";var a="_"+n+"Observe";t.STATE_VARS.push(s,o,a);t.STATE_PROTO[s]=null;t.STATE_PROTO[o]=null;t.STATE_PROTO[a]=null}}};Amm.Operator.populateStateVars(Amm.Operator);Amm.Operator.VarsProvider=function(e,t){if(t&&typeof t!=="object"){Error("`vars` must be an object")}this._vars=t||{};Amm.Operator.call(this);if(e)this.setOperator(e)};Amm.Operator.VarsProvider.prototype={"Amm.Operator.VarsProvider":"__CLASS__",_vars:null,_varsProvider:null,_varsProviderContextId:null,_allVars:null,_operatorOperator:null,_operatorValue:null,_operatorExists:null,_consumers:null,OPERANDS:["operator"],STATE_SHARED:{_varsProvider:true},setOperator:function(e){this._setOperand("operator",e);if(this._operatorOperator){this.supportsAssign=this._operatorOperator.supportsAssign}if(!this._hasValue&&!this._operatorOperator._hasValue){this._value=this._operatorOperator._value}},_doSetValue:function(e,t){if(!t)this._operatorOperator._doSetValue(e);var i=this._operatorOperator.getReadonly();return i},_doEvaluate:function(e){return this._getOperandValue("operator",e)},toFunction:function(){var n=this._operandFunction("operator");var s=this._vars?this._vars:{};var e;if(this._operatorOperator&&this._operatorOperator.supportsAssign){var o=this._operatorOperator.assignmentFunction();e=function(e,t){var i=e.vars;e.vars=Amm.override({},e.vars,s);var r;if(arguments.length>1){r=o(e,t)}else r=n(e);e.vars=i;return r}}else{e=function(e){var t=e.vars;e.vars=Amm.override({},e.vars,s);var i=n(e);e.vars=t;return i}}e.vars=s;return e},assignmentFunction:function(){if(this._operatorOperator){return this._operatorOperator.assignmentFunction()}return function(){return"`operator` not provided"}},setContextIdToDispatchEvent:function(e,t,i){if(t==="varsChange"&&(i[3]!==this._varsProvider||i[4]!==e)){return}Amm.Operator.prototype.setContextIdToDispatchEvent.call(this,e,t,i)},notifyProviderVarsChange:function(e,t,i,r){if(i){if(this._vars&&i in this._vars)return;var n=Amm.override({},this._allVars||this.getVars());this._allVars[i]=e;if(this._providerVars)this._providerVars[i]=e;if(this._consumers)this._notifyConsumers(e,t,i)}else{n=Amm.override({},this._allVars||this.getVars());this._allVars=Amm.override({},e,this._vars);this._providerVars=e;if(this._consumers)this._notifyConsumers(this._allVars,n,"")}},setVarsProvider:function(e){var t=this._varsProvider;var i=this._varsProviderContextId;if(t===e&&i===this._varsProviderContextId)return;if(t)Error("Can setVarsProvider() only once");if(!e||!e["Amm.Operator.VarsProvider"])Error("varsProvider must be an instance of Amm.Operator.VarsProvider");this._varsProvider=e;this._varsProviderContextId=e._contextId;this._varsProvider.addConsumer(this,"");return true},_initContextState:function(e,t){Amm.Operator.prototype._initContextState.call(this,e,t);if(t&&this._varsProvider){this._varsProviderContextId=this._varsProvider._contextId;this._varsProvider.addConsumer(this,"")}},getVarsProvider:function(){return this._varsProvider},setVars:function(e,t){var i=this["Amm.Expression"]?this:this._expression;if(t){if(typeof t!=="string")Error("setVars(`value`, `name`): `name` must be a string");var r=this._vars[t];if(e===r)return;this._vars[t]=e;if(this._varsProvider){if(!this._allVars)this.getVars();this._allVars[t]=e}if(this._consumers)this._notifyConsumers(e,r,t)}else{if(typeof e!=="object")Error("setVars(`value`): object required");var r=Amm.override({},this._allVars||this.getVars());if(!e)e={};this._vars=Amm.override({},e);this._allVars=null;if(this._consumers)this._notifyConsumers(this.getVars(),r,"")}return true},getVars:function(e,t){if(t||!this._varsProvider)return e?this._vars[e]:this._vars;if(!this._providerVars)this._providerVars=this._varsProvider.getVars();if(!this._allVars){this._allVars=Amm.override({},this._providerVars,this._vars)}return e?this._allVars[e]:this._allVars},setExpression:function(e){var t=Amm.Operator.prototype.setExpression.call(this,e);for(var i=this._parent;i;i=i._parent){if(i["Amm.Operator.VarsProvider"]){this.setVarsProvider(i);return}}return t},_partialCleanup:function(){this._vars={};this._providerVars=null;this._allVars=null;this._consumers=null;if(this._varsProvider&&this._varsProvider.hasContext(this._varsProviderContextId)){var e;if(this._varsProviderContextId!==this._varsProvider._contextId){e=this._varsProvider._contextId;this._varsProvider.setContextId(this._varsProviderContextId)}this._varsProvider.deleteConsumer(this,"");if(e)this._varsProvider.setContextId(e)}Amm.Operator.prototype._partialCleanup.call(this)},cleanup:function(){if(this._varsProvider&&this._varsProvider.hasContext(this._varsProviderContextId)){var e;if(this._varsProviderContextId!==this._varsProvider._contextId){e=this._varsProvider._contextId;this._varsProvider.setContextId(this._varsProviderContextId)}this._varsProvider.deleteConsumer(this,"");if(e)this._varsProvider.setContextId(e)}this._varsProvider=null;this._consumers=null;Amm.Operator.prototype.cleanup.call(this)},_constructContextState:function(){var e=Amm.Operator.prototype._constructContextState.call(this);e._vars={};e._consumers=null;return e},addConsumer:function(e,t){t=t||"";if(!this._consumers){this._consumers={};this._consumers[t]=[]}else if(!this._consumers[t]){this._consumers[t]=[]}var i=e._contextId!==this._contextId?[e,e._contextId]:e;this._consumers[t].push(i)},deleteConsumer:function(e,t){if(!this._consumers)return;t=t||"";var i=e._contextId;if(i===this._contextId)i=null;if(!this._consumers[t])return;for(var r=0,n=this._consumers[t].length;r<n;r++){var s=this._consumers[t][r];if(i===null&&s===e||s[0]===e&&s[1]===i){this._consumers[t].splice(r,1);return}}},_notifyConsumers:function(e,t,i){if(!this._consumers)return;var r=this._consumers,n=this._contextId;var s=false;i=i||"";var o,a,l,h,u,f,c,_;var m;if(i==="")m=Amm.keys(r);else{m=["",i];c=e;f=t;_=i}for(var d=0,p=m.length;d<p;d++)if(r[m[d]]){o=m[d];if(i===""){if(!(o===""||!t||!e||t[o]!==e[o]))continue;if(o!==""){c=e?e[o]:undefined;f=t?t[o]:undefined;_=o}else{c=e;f=t;_=""}}for(a=0,l=r[o].length;a<l;a++){if(r[o][a][0]){h=r[o][a][0];u=r[o][a][1]}else{h=r[o][a];u=n}if(!s){s=true;if(this._expression){this._expression._beginUpdate()}else if(this["Amm.Expression"]){this._beginUpdate()}}if(h._contextId!==u){h.setContextId(u)}h.notifyProviderVarsChange(c,f,_,this)}}if(s){if(this._expression){this._expression._endUpdate()}else if(this["Amm.Expression"]){this._endUpdate()}}}};Amm.extend(Amm.Operator.VarsProvider,Amm.Operator);Amm.Expression=function(e,t,i,r,n){Amm.WithEvents.DispatcherProxy.call(this);if(e&&typeof e==="string"){e={src:e}}var s;if(e&&e["Amm.Operator"]){s=e;e={}}Amm.Operator.VarsProvider.call(this,s);Amm.WithEvents.call(this,e,true);if(t)e.expressionThis=t;if(e.writeProperty){i=e.writeProperty;delete e.writeProperty}if(e.writeObject){r=e.writeObject;delete e.writeObject}if(e.writeArgs){n=e.writeArgs;delete e.writeArgs}Amm.init(this,e);if(i)this.setWriteProperty(i,r,n)};Amm.Expression.compareByContextIdAndLevel=function(e,t){if(t[1]!==e[1])return e[1]-t[1];return t[0].getLevel()-e[0].getLevel()};Amm.Expression.THIS_WRITE_NEVER=0;Amm.Expression.THIS_WRITE_ALWAYS=1;Amm.Expression.THIS_WRITE_ONCE=2;Amm.Expression.THIS_WRITE_AUTO=3;Amm.Expression.prototype={"Amm.Expression":"__CLASS__",_expressionThis:null,_writeProperty:null,_writeObject:null,_writeArgs:null,_lockWrite:0,_writeDestinationChanged:false,_src:null,_updateLevel:0,_updateQueue:null,_updateQueueSorted:false,_currChangeInfo:null,_writeToExpressionThis:Amm.Expression.THIS_WRITE_AUTO,setWriteToExpressionThis:function(e){var t=this._writeToExpressionThis;if(t===e)return;this._writeToExpressionThis=e;this._propagateExpressionThis();return true},getWriteToExpressionThis:function(){return this._writeToExpressionThis},_propagateExpressionThis:function(){if(!(this._writeToExpressionThis&&this._expressionThis&&this._writeObject&&this._writeObject["Amm.Expression"])){return}if(this._writeToExpressionThis===Amm.Expression.THIS_WRITE_AUTO){if(this._writeObject.getExpressionThis()){this._writeToExpressionThis=Amm.Expression.THIS_WRITE_NEVER;return}else{this._writeToExpressionThis=Amm.Expression.THIS_WRITE_ALWAYS}}this._writeObject.setExpressionThis(this._expressionThis);if(this._writeToExpressionThis===Amm.Expression.THIS_WRITE_ONCE){this._writeToExpressionThis=Amm.Expression.THIS_WRITE_NEVER}},STATE_SHARED:{_updateLevel:true,_updateQueue:true,_deferredValueChange:true,_src:true,_subscriptions:true,_eventsProxy:true,scope:true},setExpressionThis:function(e){var t=this._expressionThis;if(t===e)return;if(t&&t["Amm.WithEvents"]&&t.hasEvent("cleanup")){this._unsub(t,"cleanup",this._deleteCurrentContext)}this._expressionThis=e;if(e&&e["Amm.WithEvents"]&&e.hasEvent("cleanup")){this._sub(e,"cleanup",this._deleteCurrentContext,undefined,true)}this._propagateExpressionThis();this.outExpressionThisChange(e,t);return true},getExpressionThis:function(){return this._expressionThis},outExpressionThisChange:function(e,t){this._out("expressionThisChange",e,t)},setWriteProperty:function(e,t,i){if(arguments.length===1&&e instanceof Array){e=arguments[0][0];t=arguments[0][1];i=arguments[0][2]}if(this._writeProperty)Error("Can setWriteProperty() only once");if(!e)Error("writeProperty must be non-falseable");if(typeof e==="string"){if(!e.match(/^\w+$/))e=new Amm.Expression(e,this._expressionThis)}if(e["Amm.Expression"]){if(t||i)Error("When Amm.Expression is used as writeProperty, don't specify writeObject/writeArgs");t=e;e="value";this._sub(t,"writeDestinationChanged",this._write,undefined,true)}if(i===null||i===undefined){i=null}else if(!(i instanceof Array)){i=[i]}if(!t&&!this._expressionThis){Error("setExpressionThis() or provide writeObject when setting writeProperty")}this._writeProperty=e;this._writeObject=t;if(t&&t["Amm.WithEvents"]&&t.hasEvent("cleanup")){this._sub(t,"cleanup",this._deleteCurrentContext,undefined,true)}this._writeArgs=i;this._propagateExpressionThis();this._write()},_write:function(){var e=this._writeObject||this._expressionThis;if(!e)return;if(this._lockWrite)return;this._lockWrite++;Amm.setProperty(e,this._writeProperty,this.getValue(),false,this._writeArgs);this._lockWrite--},getWriteProperty:function(e){return e?[this._writeProperty,this._writeObject,this._writeArgs]:this._writeProperty},getWriteObject:function(){return this._writeObject},getWriteArgs:function(){return this._writeArgs},outVarsChange:function(e,t,i,r,n){this._out("varsChange",e,t,i,r,n)},setOperator:function(e){Amm.Operator.VarsProvider.prototype.setOperator.call(this,e);if(this._operatorOperator){this._operatorOperator.setExpression(this)}},_deferredValueChange:null,_reportChange:function(e){var t="ctx_"+this._contextId;this._currChangeInfo=null;if(this._updateLevel&&this._deferredValueChange){if(!this._deferredValueChange[t]){this._deferredValueChange[t]={contextId:this._contextId,old:e};if(!this._deferredValueChange.ids){this._deferredValueChange.ids=[t]}else{this._deferredValueChange["ids"].push(t)}}return}this.outValueChange(this._value,e);if(this._writeProperty)this._write()},notifyOperandContentChanged:function(e,t,i){var r=this["_"+e+"Operator"];if(r&&r._contextId!==this._contextId){this._propagateContext(e,r)}this._currChangeInfo=t;var n=Amm.Operator.VarsProvider.prototype.notifyOperandContentChanged.call(this,e,t,i);if(this._currChangeInfo){this.outValueChange(this._value,this._value,t);this._currChangeInfo=null}return n},_reportNonCacheabilityChanged:function(e){Amm.Operator.VarsProvider.prototype._reportNonCacheabilityChanged.call(this,e);if(e){this._sub(Amm.getRoot(),"interval",this.checkForChanges,undefined,true)}else{this._unsub(Amm.getRoot(),"interval",this.checkForChanges)}},notifyWriteDestinationChanged:function(){if(this._updateLevel){this._writeDestinationChanged=true;return true}else{this._writeDestinationChanged=false}if(this._operatorOperator._contextId!==this._contextId){this._propagateContext("operator",this._operatorOperator)}return this.outWriteDestinationChanged()},outWriteDestinationChanged:function(){this._out("writeDestinationChanged")},outValueChange:function(e,t,i){this._out("valueChange",e,t,i)},deleteContext:function(e){Amm.Operator.VarsProvider.prototype.deleteContext.call(this,e);if(!this._numCtx)this.cleanup()},_deleteCurrentContext:function(){this.deleteContext()},cleanup:function(){for(var e=this._subscriptions.length-1;e>=0;e--){this._eventsProxy.unsubscribeObject(this._subscriptions[e],undefined,this.dispatchEvent,this)}Amm.WithEvents.prototype.cleanup.call(this);this._subscriptions=[];this._numCtx=0;if(this._writeObject&&this._writeObject["Amm.Expression"]){this._writeObject.cleanup()}Amm.Operator.VarsProvider.prototype.cleanup.call(this)},getIsCacheable:function(){return!this._hasNonCacheable},setSrc:function(e){this.parse(e)},setDest:function(e){return this.setWriteProperty(e,null)},getDest:function(){if(this._writeObject&&this._writeObject["Amm.Expression"])return this._writeObject;if(this._writeProperty)return this._writeProperty},getSrc:function(e,t){if(arguments.length&&this._src)return this._src.slice(e,t);return this._src},parse:function(e){if(this._src)Error("Already parsed");this._src=e;if(!Amm.Expression._builder){Amm.Expression._parser=new Amm.Expression.Parser;Amm.Expression._builder=new Amm.Expression.Builder;Amm.Expression._builder.configureParser(Amm.Expression._parser)}this.setOperator(Amm.Expression._builder.unConst(Amm.Expression._parser.parse(e)))},subscribeOperator:function(e,t,i,r,n){var s=i._contextId;if(n===undefined)n=null;this.subscribeObject(e,t,r,i,[s,n])},unsubscribeOperator:function(e,t,i,r,n,s){var o=s?Amm.WithEvents.DispatcherProxy.ANY:i._contextId;if(n===undefined){if(arguments.length<5)n=null;else n=Amm.WithEvents.DispatcherProxy.ANY}return this.unsubscribeObject(e,t,r,i,[o,n])},beforeDispatch:function(e,t,arguments){if(t.length>1){this._beginUpdate()}},afterDispatch:function(e,t,arguments){if(t.length>1){this._endUpdate()}},beforeCallHandler:function(e,t,arguments,i,r){var n=r[0],s=r[1];var o=t[i][1];if(o._contextId!==n){o.setContextIdToDispatchEvent(n,e,arguments)}return s},beforeCallHandlerReturnsNewExtra:true,getUpdateLevel:function(){return this._updateLevel},_beginUpdate:function(){if(!this._updateLevel)this._updateQueue=[];this._updateLevel++;this._lockWrite++},_sortUpdateQueue:function(e){this._updateQueueSorted=true;if(!e){this._updateQueue.sort(Amm.Expression.compareByContextIdAndLevel);return}if(e>=this._updateQueue.length-1)return;var t=this._updateQueue.splice(e,this._updateQueue.length-e);t.sort(Amm.Expression.compareByContextIdAndLevel);this._updateQueue.push.apply(this._updateQueue,t)},_endUpdate:function(){if(!this._updateLevel){Error("Amm.Expression: _endUpdate() without _beginUpdate!")}if(this._updateLevel>1){this._updateLevel--;this._lockWrite--;return}this._deferredValueChange={};for(var e=0;e<this._updateQueue.length;e++){if(!this._updateQueueSorted){this._sortUpdateQueue(e)}var t=this._updateQueue[e][1];var i=this._updateQueue[e][0];if(i._contextId!==t)i.setContextId(t);i.finishUpdate()}this._updateLevel=0;this._lockWrite--;var r=this._deferredValueChange;this._deferredValueChange=null;if(r.ids){for(var e=0,n=r.ids.length;e<n;e++){var s=r[r.ids[e]];if(this._contextId!==s.contextId){this.setContextId(s.contextId)}this._reportChange(s.old)}}if(this._writeDestinationChanged){this.notifyWriteDestinationChanged()}},queueUpdate:function(e){this._updateQueue.push([e,e._contextId]);this._updateQueueSorted=false},_constructContextState:function(){var e=Amm.Operator.VarsProvider.prototype._constructContextState.call(this);e._subscribers={};return e},toFunction:function(){var r=this._operandFunction("operator"),n={vars:this._vars,expressionThis:this._expressionThis};var e;if(this._operatorOperator&&this._operatorOperator.supportsAssign){var s=this._operatorOperator.assignmentFunction();e=function(e,t){if(arguments.length){var i=s(n,e);if(i&&t)throw i;return!i}else return r(n)}}else{e=function(){return r(n)}}e.env=n;return e},findContext:function(e){if(this._expressionThis===e)return this._contextId;for(var t in this._contextState)if(this._contextState.hasOwnProperty(t)){if(this._contextState[t]&&this._contextState[t]._expressionThis===e){return t}}return undefined}};Amm.Expression.getAllWatchers=function(){var e=[];var t=Amm.getRoot().getUniqueSubscribers(Amm.Expression,"interval");for(var i=0,r=t.length;i<r;i++){e.push({expr:t[i],nc:t[i].getNonCacheableChildren(true)})}return e};Amm.Expression._builder=null;Amm.Expression._parser=null;Amm.extend(Amm.Expression,Amm.WithEvents.DispatcherProxy);Amm.extend(Amm.Expression,Amm.WithEvents);Amm.extend(Amm.Expression,Amm.Operator.VarsProvider);Amm.Trait={};Amm.Filter.Condition=function(e,t){if(t&&t._id){this.id=t._id;delete t._id}if(t&&t._class){this.requiredClass=t._class;delete t._class}if(t&&t._not){this.not=true;delete t._not}Amm.FilterSorter.Observer.call(this,e,t,true)};Amm.Filter.Condition.testValue=function(e,t){var i,r;if(e instanceof Array||e&&e["Amm.Array"]){if(typeof t==="object"&&t&&t.only){for(i=0,r=e.length;i<r;i++){if(!Amm.Filter.Condition.testValue(e[i],t.only))return false}return true}for(i=0,r=e.length;i<r;i++){if(Amm.Filter.Condition.testValue(e[i],t))return true}return false}if(t instanceof Array){for(i=0,r=t.length;i<r;i++){if(this.testValue(e,t[i]))return true}return}if(t instanceof RegExp){return typeof e==="string"&&t.exec(e)}if(typeof t==="function"){return!!t(e)}if(typeof t==="object"&&t){if("and"in t){if(!t.and||!(t.and instanceof Array))return Amm.Filter.Condition.testValue(e,t.and);for(i=0,r=t.and.length;i<r;i++){if(!this.testValue(e,t.and[i]))return false}return true}if("only"in t)return Amm.Filter.Condition.testValue(e,t.only);if(typeof t.fn==="function")return t.scope?t.fn.call(t.scope,e):t.fn(e);if("regExp"in t)return Amm.Filter.Condition.testValue(e,new RegExp(t.regExp,t.flags||""));if("validator"in t){return!Amm.Validator.iErr(t,"validator",e)}if(t["Amm.Validator"]){return!t.getError(e)}if("strict"in t)return e===t.strict;if("rq"in t)return Amm.meetsRequirements(e,t.rq);if("not"in t)return!Amm.Filter.Condition.testValue(e,t.not);throw Error("object `test` must contain at least one of following keys: `and`, `only`, `fn`, `regExp`, `validator`, `strict`, `rq`, `not`")}return t==e};Amm.Filter.Condition.prototype={"Amm.Filter.Condition":"__CLASS__",id:null,requiredClass:null,not:false,match:function(e){var t=true;if(this.requiredClass&&!Amm.is(e,this.requiredClass))t=false;else t=this._doMatch(e);if(this.not)t=!t;return t},_doMatch:function(e){return true},setProps:function(e,t){},getProps:function(e){},outPropsChange:function(e,t){return this._out("propsChange",e,t)}};Amm.extend(Amm.Filter.Condition,Amm.FilterSorter.Observer);Amm.Filter.ExpressionCondition=function(e,t){var i=Amm.override({},t);var r=null;if(t._expr){r=t._expr;delete t._expr}if(!r)throw Error("options._expr must be provided for Amm.Filter.ExpressionCondition");Amm.Filter.Condition.call(this,e,t);this._props=Amm.override({},t);this._setExpression(r)};Amm.Filter.ExpressionCondition.prototype={"Amm.Filter.ExpressionCondition":"__CLASS__",_expression:null,_evaluator:null,_props:null,_setExpression:function(e){this._expression=new Amm.Expression(e);this._expression.setEventsProxy(this._filterSorter)},_handleExpressionChanged:function(e,t){var i=this._expression.getExpressionThis();this._filterSorter.refresh(i)},match:function(e){if(e===this._expression.getExpressionThis()){return this._expression.getValue()}var t=this._expression.findContext(e);if(t!==undefined){this._expression.setContextId(t);return this._expression.getValue()}if(!this._evaluator)this._evaluator=this._expression.toFunction();this._evaluator.env.expressionThis=e;this._evaluator.env.vars=this._props;return this._evaluator()},observe:function(e){for(var t=0,i=e.length;t<i;t++){var r=e[t];if(this._expression.findContext(r)!==undefined)continue;this._expression.createContext({expressionThis:r,vars:this._props});this._expression.subscribe("valueChange",this._handleExpressionChanged,this)}},unobserve:function(e){for(var t=0,i=e.length;t<i;t++){var r=this._expression.findContext(e[t]);if(r===undefined)continue;this._expression.deleteContext(r)}},cleanup:function(){Amm.Filter.Condition.prototype.cleanup.call(this);this._expression.cleanup();this._evaluator=null;this._expression=null;this._props={}},setProps:function(e,t){var i;if(this._subscribers.propsChange)i=Amm.override({},this._props);if(t)this._props[t]=e;else{if(!e||typeof e!=="object")throw Error("`props` must be a non-null object when `propName` not provided");this._props=t}if(this._expression){if(this._filterSorter)this._filterSorter.beginUpdate();var r=this._expression.listContexts(),n,s;for(n=0,s=r.length;n<s;n++){this._expression.setContextId(r[n]);this._expression.setVars(e,t)}if(this._filterSorter)this._filterSorter.endUpdate()}if(this._subscribers.propsChange)this.outPropsChange(this._props,i)},getProps:function(e){if(e!==undefined)return this._props[e];return this._props}};Amm.extend(Amm.Filter.ExpressionCondition,Amm.Filter.Condition);Amm.Filter.PropsCondition=function(e,t){t=Amm.override({},t);if("_allowExpressions"in t){this.allowExpressions=!!t._allowExpressions;delete t._allowExpressions}this._props={};this._expressions={};this._evaluators={};this._propList=[];Amm.Filter.Condition.call(this,e,t);this.setProps(t)};Amm.Filter.propNameRx=/^\w+$/;Amm.Filter.PropsCondition.prototype={"Amm.Filter.PropsCondition":"__CLASS__",allowExpressions:true,_props:null,_expressions:null,_evaluators:null,_propList:null,_noRefresh:0,_checkProps:function(e,t){if(!t)t={};for(var i=0,r=e.length;i<r;i++){if(Amm.Filter.propNameRx.exec(e[i]))continue;if(!this.allowExpressions){throw Error("'"+e[i]+"' doesn't look like simple property name; "+" set `allowExpressions` to true to access expression values")}if(this._expressions[e[i]]){t[e[i]]=this._expressions[e[i]];continue}t[e[i]]=new Amm.Expression(e[i]);t[e[i]].setEventsProxy(this._filterSorter)}},setProps:function(e,t){this._noRefresh++;var i={};var r;if(this._subscribers.propsChange){r=Amm.override({},this._props)}if(t){var n=!(t in this._props);this._checkProps([t],i);this._props[t]=e;if(n){if(this.allowExpressions){Amm.override(this._expressions,i)}this._propList.push(t);this._sub(t)}}else if(e){var s=Amm.keys(e);this._checkProps(s,i);this.deleteProps(null,i);if(this.allowExpressions){Amm.override(this._expressions,i)}this._props=Amm.override({},e);this._propList=s;this._sub()}else{this.deleteProps()}if(this._subscribers.propsChange)this.outPropsChange(this._props,r);this._noRefresh--;if(!this._noRefresh)this._filterSorter.refresh()},_handleChange:function(){var e=Amm.event.origin;this._filterSorter.refresh(e)},_handleExpressionChange:function(e,t){var i=Amm.event.origin.getExpressionThis();this._filterSorter.refresh(i)},_sub:function(e,t){var i=t||this._filterSorter._objects,r=i.length,n,s,o;if(!e)e=this._propList;var a,l=e.length;for(n=0;n<r;n++){s=i[n];if(!s["Amm.WithEvents"])continue;for(a=0;a<l;a++){if(this._expressions[e[a]]){var h=this._expressions[e[a]].findContext(s);if(h!==undefined)continue;this._expressions[e[a]].createContext({expressionThis:s});this._expressions[e[a]].subscribe("valueChange",this._handleExpressionChange,this);continue}o=e[a]+"Change";if(this.requiredClass&&!Amm.is(s,this.requiredClass))continue;if(!s.hasEvent(o))continue;this._filterSorter.subscribeObject(s,o,this._handleChange,this)}}},_unsub:function(e,t){var i=t||this._filterSorter._objects,r=i.length,n,s,o;if(!e)e=this._propList;var a,l=e?e.length:0;for(n=0;n<r;n++){s=i[n];if(!s["Amm.WithEvents"])continue;if(this.requiredClass&&!Amm.is(s,this.requiredClass))continue;for(a=0;a<l;a++){if(this._expressions[e[a]]){var h=this._expressions[e[a]].findContext(s);if(h!==undefined)this._expressions[e[a]].deleteContext(h);continue}o=e[a]+"Change";if(this._expressions[e[a]])continue;if(!s.hasEvent(o))continue;this._filterSorter.unsubscribeObject(s,o,this._handleChange,this)}}},_doMatch:function(e){var t,i,r;for(var n=0,s=this._propList.length;n<s;n++){if(t=this._expressions[this._propList[n]]){if(t.getExpressionThis()===e){r=t.getValue()}else{i=t.findContext(e);if(i===undefined){if(!this._evaluators[this._propList[n]])this._evaluators[this._propList[n]]=t.toFunction();this._evaluators[this._propList[n]].env.expressionThis=e;r=this._evaluators[this._propList[n]]()}else{t.setContextId(i);r=t.getValue()}}}else{r=Amm.getProperty(e,this._propList[n])}if(!Amm.Filter.Condition.testValue(r,this._props[this._propList[n]])){return false}}return true},observe:function(e){this._sub(this._propList,e)},unobserve:function(e){this._unsub(null,e)},getProps:function(e){if(e)return this._props[e];return this._props},deleteProps:function(e,t){if(e&&!(e instanceof Array)){e=[e]}this._unsub(e);if(!e){this._props={};this._propList=[]}else{for(var i=0,r=e.length;i<r;i++){delete this._props(e[i]);if(!this._expressions[e[i]])continue;if(t&&t[e[i]])continue;this._expressions[e[i]].cleanup();if(this._evaluators[[e[i]]]){this._evaluators[[e[i]]].env.expressionThis={};delete this._evaluators[[e[i]]]}delete this._expressions[e[i]]}this._propList=Amm.Array.diff(this._propList,e)}if(!this._noRefresh)this._filterSorter.refresh()},cleanup:function(){Amm.Filter.Condition.prototype.cleanup.call(this);for(var e in this._expressions)if(this._expressions.hasOwnProperty(e)){this._expressions[e].cleanup()}this._expressions={};this._evaluators={};this._propList=[];this._props={}}};Amm.extend(Amm.Filter.PropsCondition,Amm.Filter.Condition);Amm.JQueryListener=function(e){Amm.init(this,e)};Amm.JQueryListener.prototype={_handler:null,_onJQuery:null,_onArgs:null,elementPass:null,eventPass:null,_eventName:null,_selector:null,_delegateSelector:null,_htmlRoot:null,setEventName:function(e){var t;if((t=this._eventName)===e)return;this._eventName=e;this._bind()},getEventName:function(){return this._eventName},setSelector:function(e){var t;if((t=this._selector)===e)return;this._selector=e;this._bind()},getSelector:function(){return this._selector},setDelegateSelector:function(e){var t;if((t=this._delegateSelector)===e)return;this._delegateSelector=e;this._bind()},getDelegateSelector:function(){return this._delegateSelector},setHtmlRoot:function(e){var t;if((t=this._htmlRoot)===e)return;this._htmlRoot=e;this._bind()},getHtmlRoot:function(){return this._htmlRoot},_bind:function(){if(this._onJQuery){this._onJQuery.off.apply(this._onJQuery,this._onArgs);this._onJQuery=null;this._onArgs=null}if(this._selector&&this._eventName&&this._handler){this._onArgs=[this._handler];if(this._delegateSelector)this._onArgs.unshift(this._delegateSelector);this._onArgs.unshift(this._eventName);this._onJQuery=this._htmlRoot?jQuery(this._htmlRoot).find(this._selector):jQuery(this._selector);this._onJQuery.on.apply(this._onJQuery,this._onArgs)}},cleanup:function(){this._handler=null;this._bind()},setHandler:function(e){var t=this._handler;if(t===e)return;this._handler=e;this._bind();return true},getHandler:function(){return this._handler}};Amm.Expression.Token=function(e,t,i,r){this.string=e;this.type=t;this.value=i;this.offset=r};Amm.Expression.Token.Type={WHITESPACE:1,WORD:2,INTEGER:3,FLOAT:4,SYMBOL:5,ILLEGAL:6,SINGLE_QUOTED_STRING:15,DOUBLE_QUOTED_STRING:16,REGEXP:17};Amm.Expression.Token.prototype={string:undefined,type:undefined,value:undefined,offset:undefined,toArray:function(){return[this.string,this.type,this.value]},isSymbol:function(e){if(this.type!==Amm.Expression.Token.Type.SYMBOL)return false;if(!e)return true;if(e instanceof Array)return Amm.Array.indexOf(this.string,e)>=0;if(arguments.length===1)return this.string===e;var t=Array.prototype.slice.apply(arguments);return Amm.Array.indexOf(this.string,t)>=0},isIdentifier:function(){return this.type===Amm.Expression.Token.Type.WORD},isConstant:function(){return this.type===Amm.Expression.Token.Type.INTEGER||this.type===Amm.Expression.Token.Type.FLOAT||this.type===Amm.Expression.Token.Type.SINGLE_QUOTED_STRING||this.type===Amm.Expression.Token.Type.DOUBLE_QUOTED_STRING||this.type===Amm.Expression.Token.Type.REGEXP}};Amm.Expression.Builder=function(){};Amm.Expression.Builder.prototype={build:function(e,t){var i=Array.prototype.slice.call(arguments,1);var r=e;if(!this[r])throw Error("Uknown/unsupported lexeme: "+r);return this[r].apply(this,i)},decorate:function(e,t,i,r,n){if(e&&e["Amm.Operator"]){e.beginPos=t;e.endPos=i}},configureParser:function(e){e.genFn=this.build;e.genObj=this;e.decorateFn=this.decorate;e.decorateObj=this},const:function(e){if(e&&e.Const)return e;return{Const:true,const:e}},unConst:function(e,t){if(e&&e.Const)return e.const;if(t&&e instanceof Array){var i=[];for(var r=0,n=e.length;r<n;r++){i.push(this.unConst(e[r]))}return i}return e},Identifier:function(e){if(e==="this"){return new Amm.Operator.ExpressionThis}if(e==="root"){return new Amm.getRoot}return new Amm.Operator.ScopeElement(new Amm.Operator.ExpressionThis,this.unConst(e))},Conditional:function(e,t,i){return new Amm.Operator.Conditional(this.unConst(e),this.unConst(t),this.unConst(i))},binaryFn:function(e,t,i){switch(t){case"!==":return e!==i;case"===":return e===i;case"==":return e===i;case"!=":return e!=i;case"+":return e+i;case"-":return e-i;case"*":return e*i;case"/":return e/i;case"%":return e%i;case">":return e>i;case"<":return e<i;case"<=":return e<=i;case">=":return e>=i}throw Error("Unknown operator: "+t)},Binary:function(e,t,i){if(e&&e.Const&&i&&i.Const){return this.const(this.binaryFn(this.unConst(e),t,this.unConst(i)))}return new Amm.Operator.Binary(this.unConst(e),this.unConst(t),this.unConst(i))},Unary:function(e,t){if(t.Const){if(e==="!")return this.const(!this.unConst(t));else if(e==="-")return this.const(-this.unConst(t));else Error("Unknown unary operator: '"+e+"'")}else{return new Amm.Operator.Unary(e,this.unConst(t))}},List:function(e){return new Amm.Operator.List(this.unConst(e,true))},Constant:function(e){return this.const(e)},FunctionCall:function(e,t,i){if(e&&e["Amm.Operator.Property"]&&!e.hasArguments()){e.promoteToCall(t,i);return e}return new Amm.Operator.FunctionCall(this.unConst(e),t,i)},PropertyAccess:function(e,t,i,r,n){return new Amm.Operator.Property(this.unConst(e),this.unConst(t),this.unConst(i),n)},CacheabilityModifier:function(e){return e==="!!"?true:false},Subexpression:function(e){return e},Parenthesis:function(e){return e},Variable:function(e){return new Amm.Operator.Var(e)},PropertyArgs:function(e,t){return this.unConst(e,true)},ComponentElement:function(e,t,i){return new Amm.Operator.ComponentElement(this.unConst(e),this.unConst(t),this.unConst(i),false,t===undefined)},ChildElement:function(e,t,i){return new Amm.Operator.ChildElement(this.unConst(e),this.unConst(t),this.unConst(i),t===undefined)},LoopIdentifiers:function(e,t){return{keyVar:t,valueVar:e}},Range:function(e,t,i,r){var n=t&&(t["Amm.Operator.ComponentElement"]||t["Amm.Operator.ChildElement"]||t["Amm.Operator.ScopeElement"]);var s;if(e==="All"){if(n){t._setOperand("range","*");s=t}else{s=new Amm.Operator.Range.All(this.unConst(t))}}else if(e==="Index"){if(n){t._setOperand("range",this.unConst(i));s=t}else{s=new Amm.Operator.Range.Index(this.unConst(t),this.unConst(i))}}else if(e==="RegExp"){s=new Amm.Operator.Range.RegExp(this.unConst(t),this.unConst(i))}else if(e==="Slice"){s=new Amm.Operator.Range.Slice(this.unConst(t),this.unConst(i),this.unConst(r))}else if(e==="Condition"){s=new Amm.Operator.Range.Condition(this.unConst(t),this.unConst(i),this.unConst(r.keyVar),this.unConst(r.valueVar))}else{Error("Uknown range type: '"+e+"'")}if(n){if(!t._rangeOperator&&t._rangeValue===null){t._setOperand("range","*")}}return s}};Amm.Expression.Parser=function(){};Amm.Expression.Parser.prototype={"Amm.Expression.Parser":"__CLASS__",tokensRx:/^(?:(\s+)|([_a-zA-Z][_a-zA-Z0-9]*)|(0[xX]?[0-9]+)|([0-9]+(?:\.[0-9+])?(?:e[+-]?[0-9]+)?)|(!!|\?\?|\.\.|::|->>|->|&&|\|\||!==|!=|===|==|>=|<=|=>|[-&|+><\{\}$?!.,:\[\]()'"%*/])|(.))/,regexTokens:/^(?:(\.)|([[\]()\/])|([^\\\[n\]()\/]+))/,regexFlags:/^[a-zA-Z]+/,stringSingleQuoteRx:/^((?:\\.)|')|[^\\']+/,stringDoubleQuoteRx:/^((?:\\.)|")|[^\\"]+/,unescapes:{'\\"':'"',"\\'":"'","\\n":"\n","\\r":"\r","\\t":"\t","\\v":"\v","\\0":"\0","\\f":"\f","\\\\":"\\"},genFn:null,genObj:null,decorateFn:null,decorateObj:null,src:null,_lastNonWhitespace:null,_tokens:undefined,_oldPos:0,_pos:0,_ignoreWhitespace:true,_fetches:0,getString:function(e,t){var i="",r=""+e,n=t?'"':"'",s=t?this.stringDoubleQuoteRx:this.stringSingleQuoteRx;while(r){var o=s.exec(r);if(!o)Error("Assertion: cannot match string part (shouldn't happen)");if(o[1]===n){break}if(o[1]){i+=this.unescapes[o[1]]||o[1][1]}else i+=o[0];r=r.slice(o[0].length)}return[i,e.length-r.length]},getRegex:function(e){var t=false;var i=""+e,r="";var n="",s="";var o=false;var a;var l;if(!i||!i[0]==="/")return;r+=i[0];i=i.slice(1);while(i&&!o){a=this.regexTokens.exec(i);if(!a)Error("Assertion - shouldn't happen");if(a[2]){if(a[2]==="["&&!t)t=true;else if(a[2]==="]"&&t)t=false;else if(a[2]==="/"&&!t)o=true}if(!o)n+=a[0];r+=a[0];i=i.slice(a[0].length)}if(!o)return;if(o){a=this.regexFlags.exec(i);if(a){r+=a[0];s=a[0];i=i.slice(a[0])}}try{l=new RegExp(n,s)}catch(e){throw{msg:"Cannot parse regex: "+e,origException:e,pos:0}}return new Amm.Expression.Token(r,Amm.Expression.Token.Type.REGEXP,l)},getToken:function(e,t){t=t||this._lastNonWhitespace;var i=this.tokensRx.exec(e),r,n;if(!i){Error("Assertion: match next token (shouldn't happen)")}if(i[1])r=Amm.Expression.Token.Type.WHITESPACE;else if(i[2])r=Amm.Expression.Token.Type.WORD;else if(i[3]){r=Amm.Expression.Token.Type.INTEGER;if(i[3][0]==="0"&&(i[3][1]!=="x"&&i[3][1]!=="X"))n=parseInt(i[3],8);else n=parseInt(i[3])}else if(i[4]){r=Amm.Expression.Token.Type.FLOAT;n=parseFloat(i[4])}else if(i[5]){if(i[5]==='"'||i[5]==="'"){var s=this.getStringConstantToken(e);if(s){return s}}else if(i[5]==="/"){if(!t||this.regexPossible(t)){var o=this.getRegex(e);if(o)return o}}r=Amm.Expression.Token.Type.SYMBOL}else if(i[6])r=Amm.Expression.Token.Type.ILLEGAL;var a=new Amm.Expression.Token(i[0],r,n);return a},regexPossible:function(e){var t=false;if(e.type===Amm.Expression.Token.Type.SYMBOL)t=true;return t},getStringConstantToken:function(e,t){var t=e[0];var i=e.slice(1);if(t!=="'"&&t!=='"'||!i.length)return;var r=t==='"';var n=this.getString(i,r);var s=false;i=i.slice(n[1]);if(i[0]===t){s=true;i=i.slice(1)}if(!s){throw{message:"Unmatched "+(r?"double":"single")+" quote",pos:e.length-i.length,string:e}}var o=r?Amm.Expression.Token.Type.DOUBLE_QUOTED_STRING:Amm.Expression.Token.Type.SINGLE_QUOTED_STRING;var a=new Amm.Expression.Token(e.slice(0,e.length-i.length),o,n[0]);return a},getAllTokens:function(e){var t=0;var i=""+e,r=[];var n;this._lastNonWhitespace=null;while(i.length){try{var s=this.getToken(i);s.offset=t;if(!s.string.length)Error("WTF");i=i.slice(s.string.length);t+=s.string.length;r.push(s);if(s.type!==Amm.Expression.Token.Type.WHITESPACE){this._lastNonWhitespace=s}}catch(n){if(n.pos){n.pos+=e.length-i.length;n.string=e}else{n={message:n,pos:e.length-i.length,string:e}}throw n}}return r},begin:function(e){this._tokens=this.getAllTokens(e);this._pos=-1;this._fetches=0},_binaryPriority:[["||"],["&&"],["!==","===","!=","=="],[">","<",">=","<="],["+","-"],["*","/","%"]],genOp:function(e,t){var i=Array.prototype.slice.apply(arguments);var r;if(this.genFn){r=this.genFn.apply(this.genObj||this,i)}else{r=i}if(this.decorateFn){var n=this._oldPos+1;var s=this._tokens.slice(n,this._pos+1);if(s.length){var o=s[s.length-1];var a=0;if(this._ignoreWhitespace){while(s[a].type===Amm.Expression.Token.Type.WHITESPACE){a++}}var l=s[a];var h=l.offset;var u=o.offset+o.string.length;this.decorateFn.call(this.decorateObj||this,r,h,u,this.src,s.slice(a))}}return r},parseExpression:function(){return this.parsePart("Conditional")},parseConditional:function(){var e,t,i;e=this.parsePart("Binary");if(!e)return;var r=this.fetch();if(r&&r.isSymbol("?")){t=this.parsePart("Expression");if(!t)Error("Expected: expression");r=this.fetch();if(r&&r.isSymbol(":")){i=this.parsePart("Expression");if(!i)Error("Expected: expression");return this.genOp("Conditional",e,t,i)}else{Error("Expected: ':'")}}else{if(r)this.unfetch()}return e},parseBinary:function(e){if(!e)e=0;if(e>=this._binaryPriority.length){return this.parsePart("Unary")}var t,i,r;t=this.parsePart("Binary",e+1);var n=this.fetch();if(!n)return t;if(n.isSymbol(this._binaryPriority[e])){i=n;r=this.parsePart("Binary",e);if(!r)Error("Expected: binary "+this._binaryPriority[e].join(", ")+" operand");return this.genOp("Binary",t,i.string,r)}this.unfetch();return t},parseUnary:function(){var e=this.fetch();if(!e)return;if(e.isSymbol("!","-")){var t=this.parsePart("Unary");if(!t)Error("Expected: unary");return this.genOp("Unary",e.string,t)}else{this.unfetch();return this.parsePart("Item")}},parseList:function(){var e=[],t;t=this.parsePart("Expression");if(!t)return;e.push(t);do{var i=this.fetch();if(i.isSymbol(",")){t=this.parsePart("Expression");if(!t)Error("Expected: expression");e.push(t)}else{this.unfetch();break}}while(1);return this.genOp("List",e)},parseItem:function(){var e=this.parsePart(true,"Value");var t=this.parsePart(true,"AccessOperator",e);if(t)return t;return e},parseAccessOperator:function(e){var t;t=this.parsePart(true,"FunctionCall",e)||this.parsePart(true,"PropertyAccess",e)||this.parsePart(true,"ElementOrChildElement",e)||this.parsePart(true,"Range",e);if(t){var i=this.parsePart(true,"AccessOperator",t);if(i)return i;return t}},parseFunctionCall:function(e){var t=this.fetch();if(!t)return;if(!t.isSymbol("(")){this.unfetch();return}var i=this.parsePart("List")||[];t=this.fetch();if(!t||!t.isSymbol(")"))Error("Expected: ')'");var r=this.parsePart("CacheabilityModifier");return this.genOp("FunctionCall",e,i,r===undefined?null:r)},parsePropertyAccess:function(e){var t=this.fetch();var i;var r=false;var n=null;var s=null;if(!t)return;if(t.isSymbol(".")){var o=this._oldPos;this._oldPos=this._pos;var t=this.fetch();if(t&&t.isIdentifier()){i=this.genOp("Constant",t.string)}else{this._oldPos=o;Error("Expected: identifier")}this._oldPos=o}else{this.unfetch();i=this.parsePart("Subexpression");if(i)r=true;else return}n=this.parsePart("PropertyArgs");s=this.parsePart("CacheabilityModifier");return this.genOp("PropertyAccess",e,i||null,n||null,r,s||null)},parseCacheabilityModifier:function(){var e=this.fetch();if(!e)return;if(e.isSymbol("!!","??"))return this.genOp("CacheabilityModifier",e.string);this.unfetch()},parseSubexpression:function(){var e=this.fetch();if(!e)return;if(!e.isSymbol("[")){this.unfetch();return}var t=this.parsePart("Expression");if(!t)Error("Expected: expression");var e=this.fetch();if(!e||!e.isSymbol("]"))Error("Expected: ']'");return this.genOp("Subexpression",t)},parsePropertyArgs:function(){var e=this.fetch();if(!e)return;if(!e.isSymbol("::")){this.unfetch();return}var t=false;var i=[],r;do{e=this.fetch();if(!e)break;if(e.isSymbol("{")){i=this.parsePart("List");if(!i)Error("Expected: list");e=this.fetch();if(!e||!e.isSymbol("}"))Error("Expected: '}'");t=true;break}else if(e.isSymbol("::")){r=this.genOp("Constant",undefined)}else if(e.isIdentifier()){r=this.genOp("Constant",e.string)}else if(e.isConstant()){r=this.genOp("Constant",e.value)}else{this.unfetch();break}i.push(r)}while(true);if(!t&&!i.length)i=[undefined];return this.genOp("PropertyArgs",i,t)},parseElementOrChildElement:function(e){var t=this.fetch();if(!t)return;if(!t.isSymbol("->","->>")){this.unfetch();return}var i=t.string==="->>";var r=undefined;var n=false;t=this.fetch();if(!(t&&(t.isSymbol("{","[")||t.isIdentifier())))Error("Expected: identifier, subexpression or range");if(t.string==="{"){n=true}if(!t.isIdentifier())this.unfetch();if(!n&&t.isIdentifier()){r=this.genOp("Constant",t.string)}else{if(!n){r=this.parsePart("Subexpression");if(!r){Error("Expected: subexpression")}}}var s=this.genOp(i?"ChildElement":"ComponentElement",e,r,null);var o=this.parsePart("Range",s);return o||s},parseLoopIdentifiers:function(){var e=this.parsePart("Variable",true);var t;if(!e)return;var i=this.fetch();if(!i)return;if(i.isSymbol("=>")){t=e;i=this.fetch();if(i.isSymbol(":")){e=null}else{this.unfetch();e=this.parsePart("Variable",true);if(!e)Error("Expected: variable");i=this.fetch();if(!i||!i.isSymbol(":"))Error("Expected: ':'")}return this.genOp("LoopIdentifiers",e,t)}else if(i.isSymbol(":")){return this.genOp("LoopIdentifiers",e,null)}else{this.unfetch();if(e){this.unfetch();this.unfetch()}}},parseRange:function(e){var t=this.fetch();if(!t)return;if(!t.isSymbol("{")){this.unfetch();return}var t=this.fetch();var i,r=null,n=null;if(t.isSymbol("*")){i="All"}else if(t.isConstant()&&t.type===Amm.Expression.Token.Type.INTEGER){i="Index";r=this.genOp("Constant",t.value)}else if(t.isConstant()&&t.type===Amm.Expression.Token.Type.REGEXP){i="RegExp";r=this.genOp("Constant",t.value)}else{if(t.isSymbol("..")){i="Slice";r=null;t=this.fetch();if(t.isSymbol("}")){n=null;this.unfetch()}else{this.unfetch();n=this.parsePart("Expression")}}else{this.unfetch();var s=this.parsePart("LoopIdentifiers");var r=this.parsePart("Expression");if(!r){Error("Expected: expression")}if(s){i="Condition";n=s}else{t=this.fetch();if(t.isSymbol("..")){i="Slice";n=this.parsePart("Expression")}else{this.unfetch();i="Index"}}}}t=this.fetch();if(!t||!t.isSymbol("}"))Error("Expected: '}'");return this.genOp("Range",i,e,r,n)},parseVariable:function(e){var t=this.fetch();if(!t)return;if(t.isSymbol("$")){t=this.fetch();if(t&&t.isIdentifier()){if(e)return this.genOp("Constant",t.string);return this.genOp("Variable",t.string)}else{Error("Expected: identifier")}}else{this.unfetch()}},parseValue:function(){var e=this.parsePart("Variable");if(e)return e;var t=this.fetch();if(t.isSymbol("(")){var i=this.parsePart("Expression");if(!i)Error("Expected: expression");t=this.fetch();if(!t||!t.isSymbol(")"))Error("Expected: ')'");return this.genOp("Parenthesis",i)}if(t.isConstant()){return this.genOp("Constant",t.value)}if(t.isIdentifier()){var r=t.string.toLowerCase();if(r==="true")return this.genOp("Constant",true);if(r==="false")return this.genOp("Constant",false);if(r==="null")return this.genOp("Constant",null);if(r==="undefined")return this.genOp("Constant",undefined);return this.genOp("Identifier",t.string)}this.unfetch()},unfetch:function(){return this.fetch(false,true)},fetch:function(e,t){if(this._fetches++>1e4)Error("Guard: too much fetches (TODO: remove)");if(!this._tokens)return null;var i=null,r=t?-1:1,n=this._pos;do{i=this._tokens[n+r]||null;if(i||t)n=n+r}while(i&&(this._ignoreWhitespace&&i.type===Amm.Expression.Token.Type.WHITESPACE));if((i||t)&&!e)this._pos=n;return i},parsePart:function(e,t){var i=Array.prototype.slice.call(arguments,1);var r;var n=false;if(e===true){n=true;e=i.shift()}if(!e)Error("`part` is required to be non-empty string");var s="parse"+e;if(typeof this[s]!=="function")Error("Amm.Expression.Parser: no such method: '"+s+"'");if(e==="Part")Error("WTF");var o=this._oldPos;if(!n)this._oldPos=this._pos;if(!i.length){r=this[s]()}else if(i.length===1){r=this[s](i[0])}else{r=this[s].apply(this,i)}if(!n)this._oldPos=o;return r},parse:function(e){var t;this.src=e;this._oldPos=0;this.begin(e);t=this.parsePart("Expression");var i=this.fetch();if(i)Error("Expected: eof");return t}};Amm.Expression.FunctionHandler=function(e){Amm.WithEvents.call(this,e,true);this._expressions={};this._get={};this._set={};var t;var i=null;var r=this;this._getter=function(e,t){return r.get(e,t)};this._setter=function(e,t){return r.set(e,t)};if(typeof e==="function"){if(arguments.length>=2||typeof arguments[2]==="object"&&!(arguments[2]instanceof Array)){t=arguments[6]||{};t.fn=arguments[0];t.thisObject=arguments[1];i=true}else{t=arguments[2]||{};t.fn=arguments[0];t.thisObject=arguments[1]}}else t=e;Amm.init(this,t);if(i)this.setWriteProperty(arguments[2],arguments[3],arguments[4])};Amm.Expression.FunctionHandler.prototype={_fn:null,_thisObject:null,_isRun:0,_get:null,_set:null,_again:false,_writeObject:null,_writeProperty:null,_writeArgs:null,_lockWrite:0,_value:null,_gotValue:false,setFn:function(e){var t=this._fn;if(t===e)return;if(this._fn)throw Error("Can setFn() only once");if(typeof e!=="function")throw Error("fn must be a function");this._fn=e;return true},getFn:function(){return this._fn},setThisObject:function(e){var t=this._thisObject;if(t===e)return;if(typeof e!=="object"||!e)throw Error("thisObject must be a non-null object");this._thisObject=e;if(e["Amm.WithEvents"]&&e.hasEvent("cleanup")){e.subscribe("cleanup",this.cleanup,this)}return true},getThisObject:function(){return this._thisObject},_setValue:function(e){var t=this._value;if(t===e)return;this._gotValue=true;this._value=e;if(this._writeProperty)this._write();this.outValueChange(e,t);return true},getValue:function(e){if(e||!this._gotValue){this._run(e)}return this._value},outValueChange:function(e,t){this._out("valueChange",e,t)},_run:function(e){if(!this._fn)return;if(this._isRun)return;this._isRun++;this._again=!!e;var t=this._fn.call(this,this._getter,this._setter);this._setValue(t);this._cleanExpressions();this._isRun--},setWriteProperty:function(e,t,i){if(arguments.length===1&&e instanceof Array){e=arguments[0][0];t=arguments[0][1];i=arguments[0][2]}if(this._writeProperty)Error("Can setWriteProperty() only once");if(!e)Error("writeProperty must be non-falseable");if(e["Amm.Expression"]){if(t||i)Error("When Amm.Expression is used as writeProperty, don't specify writeObject/writeArgs");t=e;e="value";t.subscribe("writeDestinationChanged",this._write,this)}if(i===null||i===undefined){i=null}else if(!(i instanceof Array)){i=[i]}if(!t&&!this._thisObject){Error("setThisObject() or provide writeObject when setting writeProperty")}this._writeProperty=e;this._writeObject=t;if(t&&t["Amm.WithEvents"]&&t.hasEvent("cleanup")){t.subscribe("cleanup",this.cleanup,this)}this._writeArgs=i;this._write()},_write:function(){if(this._lockWrite||!this._writeProperty)return;this._lockWrite++;var e=this._writeObject||this._thisObject;Amm.setProperty(e,this._writeProperty,this.getValue(),false,this._writeArgs);this._lockWrite--},getWriteProperty:function(e){return e?[this._writeProperty,this._writeObject,this._writeArgs]:this._writeProperty},getWriteObject:function(){return this._writeObject},getWriteArgs:function(){return this._writeArgs},_handleExpressionValueChange:function(e,t){if(this._lockWrite)return;this._run()},_handleExpressionDestinationChange:function(){if(this._lockWrite)return;this._run()},_access:function(e,t){if(this._isRun)this[t?"_set":"_get"][e]=true;if(!this._expressions[e]){this._expressions[e]=new Amm.Expression(e,this._thisObject);if(t){this._expressions[e].subscribe("writeDestinationChanged",this._handleExpressionDestinationChange,this)}else{this._expressions[e].subscribe("valueChange",this._handleExpressionValueChange,this)}}return this._expressions[e]},get:function(e,t){if(t===undefined)t=this._again;return this._access(e).getValue(t)},set:function(e,t){return this._access(e,true).setValue(t)},_cleanExpressions:function(e){for(var t in this._expressions){if(this._expressions.hasOwnProperty(t)){if(e||!this._get[t]&&!this._set[t]){this._expressions[t].unsubscribe(undefined,undefined,this);this._expressions[t].cleanup();delete this._expressions[t]}}}this._get={};this._set={}},cleanup:function(){this._cleanExpressions(true);if(this._writeObject&&this._writeObject["Amm.Expression"]){this._writeObject.cleanup()}Amm.WithEvents.prototype.cleanup.call(this)}};Amm.extend(Amm.Expression.FunctionHandler,Amm.WithEvents);Amm.Expression.Sync=function(e,t,i,r,n,s,o,a){Amm.Expression.call(this,e,t,i,r,n)};Amm.Expression.Sync.prototype={"Amm.Expression.Sync":"__CLASS__",_translator:null,_errProperty:null,_errObject:null,_writeGetter:null,_writeSetter:null,_writeEvent:null,_lastError:false,setTranslator:function(e){if(!e)e=null;else if(!Amm.getClass(e)){e=Amm.constructInstance(e,"Amm.Translator")}else{Amm.is(e,"Amm.Translator","translator")}var t=this._translator;if(t===e)return;this._translator=e;this._write();return true},getTranslator:function(){return this._translator},setErrProperty:function(e){var t=this._errProperty;if(t===e)return;this._errProperty=e;return true},getErrProperty:function(){return this._errProperty},setErrObject:function(e){var t=this._errObject;if(t===e)return;this._errObject=e;this._handleTranslationError(this._lastError,false,true);return true},getErrObject:function(){return this._errObject},setWriteProperty:function(e,t,i){var r=Amm.Expression.prototype.setWriteProperty.call(this,e,t,i);if(this._writeObject&&this._writeObject["Amm.Expression"]){this._writeObject.subscribe("valueChange",this._handleWriteValueChange,this);return r}if(!this._writeEvent)this._detectWriteProperty();if(this._writeEvent){(this._writeObject||this._expressionThis).subscribe(this._writeEvent,this._handleWriteValueChange,this)}else{throw Error("writeObject doesn't have event for change of writeProperty '"+this._writeProperty+"' so Amm.Expression.Sync cannot function")}},_detectWriteProperty:function(){var e=this._writeObject||this._expressionThis,t={};Amm.detectProperty(e,this._writeProperty,t);this._writeGetter=t.getterName;this._writeSetter=t.setterName;this._writeEvent=t.eventName},_write:function(){var e=this._writeObject||this._expressionThis;if(!e)return;if(this._lockWrite)return;this._lockWrite++;var t=this.getValue(),i=true;if(this._translator&&t!==undefined){var r={};t=this._translator.translateIn(t,r);if(r.error)i=false;this._handleTranslationError(r.error,true)}if(!i){this._lockWrite--;return}if(!this._writeGetter)this._detectWriteProperty();var n=e[this._writeGetter]();if(t===undefined&&n!==undefined){this._setTranslatedValue(n);this._lockWrite--;return}Amm.setProperty(e,this._writeProperty,t,false,this._writeArgs);this._lockWrite--},_setTranslatedValue:function(e){if(!this._translator){this.setValue(e);return}var t={};var i=this._translator.translateOut(e,t);if(!t.error){this.setValue(i)}this._handleTranslationError(t.error||null,false)},_handleTranslationError:function(e,t,i){if(e===this._lastError&&!i)return;this._lastError=e;if(this._errProperty)Amm.setProperty(this._errObject||this._expressionThis,this._errProperty,e)},_handleWriteValueChange:function(e,t){if(this._lockWrite)return;this._lockWrite++;this._setTranslatedValue(e);this._lockWrite--},parse:function(e){Amm.Expression.prototype.parse.call(this,e);if(!this.supportsAssign)throw Error("Amm.Expression.Sync must be assignable, but '"+e+"' is not")},notifyWriteDestinationChanged:function(){if(Amm.Expression.prototype.notifyWriteDestinationChanged.call(this))return true;if(this._writeGetter&&this._hasValue&&this._value===undefined){var e=this._writeObject||this._expressionThis,t;if(e){t=e[this._writeGetter]();if(t!==undefined)this._setTranslatedValue(t)}}}};Amm.extend(Amm.Expression.Sync,Amm.Expression);Amm.DomHolder=function(){};Amm.DomHolder.find=function(e,t,i){var s=Amm.domHolderAttribute,r=[],o={};jQuery(e)[t?"find":"closest"]("["+s+"]").each(function(e,t){var i=t.getAttribute(s).split(" ");for(var r=0,n=i.length;r<n;r++)if(i[r].length)o[i[r]]=1});for(var n in o)if(o.hasOwnProperty(n)){var a=Amm.getItem(n,i);if(a)r.push(a)}return r};Amm.DomHolder.prototype={"Amm.DomHolder":"__CLASS__",_domExclusive:true,_notifyDomNodeConflict:function(e,t){if(this._domExclusive&&!this._domCompat(t)){var i="Element already acquired by a different DomHolder";console.error(i,this,e,t);throw Error(i)}},_domCompat:function(e){var t=this["Amm.ElementBound"]&&e["Amm.ElementBound"]&&this._element&&e._element===this._element;return t},_acquireDomNode:function(e){Amm.registerItem(this);var a=this,l=Amm.domHolderAttribute;jQuery(e).each(function(e,t){var i=t.getAttribute(l)||"",r=i.indexOf(" "+a._amm_id);if(r<0){var n=i.split(" "),s=Amm.getItem(n);for(var e=0,o=s.length;e<o;e++){a._notifyDomNodeConflict(t,s[e]);s[e]._notifyDomNodeConflict(t,a)}n.push(a._amm_id);t.setAttribute(l,n.join(" "))}})},_releaseDomNode:function(e){var t=this,r=" "+t._amm_id,n=Amm.domHolderAttribute;jQuery(e).each(function(e,t){if(t.hasAttribute(n)){var i=t.getAttribute(n).replace(r,"");if(i.length)t.setAttribute(n,i);else t.removeAttribute(n)}})}};Amm.Validator=function(e){Amm.override(this,e)};Amm.Validator.construct=function(e,t,i,r){if(typeof e==="function"){return Amm.constructInstance({func:e},"Amm.Validator.Function",t,i,r)}return Amm.constructInstance(e,"Amm.Validator",t,i,r)};Amm.Validator.instantiate=function(e,t){if(!e[t]["Amm.Validator"])e[t]=Amm.Validator.construct(e[t]);return e[t]};Amm.Validator.iErr=function(e,t,i,r){return Amm.Validator.instantiate(e,t).getError(i,r)};Amm.Validator.prototype={"Amm.Validator":"__CLASS__",_msg:function(e){for(var t=1,i=arguments.length;t<i;t+=2){if(arguments[t]==="%field"&&arguments[t+1]===undefined){arguments[t+1]=Amm.translate("lang.Amm.Validator.value");break}}var r=Array.prototype.slice.apply(arguments);return Amm.translate.apply(Amm,r)},isEmpty:function(e){return e===""||e===null||e===undefined},getError:function(e,t){return null}};Amm.defineLangStrings({"lang.Amm.Validator.value":"Value"});Amm.View={};Amm.View.Html=function(e){Amm.DomHolder.call(this,{})};Amm.View.Html.prototype={"Amm.View.Html":"__CLASS__",_presentationProperty:"_htmlElement",_htmlElement:null,_deferHtmlElementRef:null,_resolveHtmlElement:true,_relativeToView:null,_waitHandler:null,_preInit_htmlView:function(e){if(e&&e.relativeToView){this.setRelativeToView(e.relativeToView)}},setHtmlSource:function(e){var t=jQuery(e);if(!t.length)throw Error("Cannot setHtmlSource: selector '"+e+"' doesn't return any elements");var i=jQuery.parseHTML(t[0].innerHTML.replace(/^\s+|\s+$/g,""))[0];this.setHtmlElement(i)},setHtmlElement:function(e){if(this._resolveHtmlElement||this._relativeToView)e=this._implResolveHtmlElement(e);var t=this._htmlElement;if(t===e)return;if(t){this._releaseDomNode(t)}this._htmlElement=e;this._doSetHtmlElement(e,t);this._observeElementIfPossible();return true},_implResolveHtmlElementRelativeToView:function(e){var t,i;if(this._deferHtmlElementRef["Amm.Builder.Ref"]){this._deferHtmlElementRef.setNode(e.getHtmlElement());t=this._deferHtmlElementRef.resolve(true)}else{i=jQuery(e.getHtmlElement());t=i.find(this._deferHtmlElementRef)[0];if(!t)t=i.closest(this._deferHtmlElementRef)[0]}if(t&&(t instanceof HTMLElement||t.nodeType))this.setHtmlElement(t);else{console.warn(Amm.getClass(this)+" of "+Amm.getClass(this._element)+": cannot resolve HTMLElement relative to view '"+e.id+"' using selector '"+this._deferHtmlElementRef)}this._deferHtmlElementRef=null},_elementChange_htmlView:function(e,t){if(t&&this._waitHandler){Amm.View.Abstract.stopWaitingForView(t,this._waitHandler);this._waitHandler=null}if(e&&this._deferHtmlElementRef){this._resolveOrDeferHtmlElementRelativeToView(this._deferHtmlElementRef)}},_resolveOrDeferHtmlElementRelativeToView:function(e){this._deferHtmlElementRef=e;if(!this._element)return null;var t=this._relativeToView===true?undefined:this._relativeToView;if(this._element){var i=Amm.View.Abstract.waitForView(this._element,t,"Amm.View.Html",this._implResolveHtmlElementRelativeToView,this);this._waitHandler=i}},_implResolveHtmlElement:function(e){if(!e)return null;if(e instanceof HTMLElement||e.nodeType){return e}if(typeof e==="string"||e["Amm.Builder.Ref"]||"$ref"in e){if(e.$ref)e=new Amm.Builder.Ref(e);if(this._relativeToView){return this._resolveOrDeferHtmlElementRelativeToView(e)}if(e["Amm.Builder.Ref"])return e.resolve(true);return jQuery(e)[0]||null}if(e.jquery)return e[0]||null;throw Error("`htmlElement` of Amm.View.Html is expected to be HTMLElement instance"+", string or jQuery result or FALSEable value; provided: "+Amm.describeType(e))},_doSetHtmlElement:function(e,t){},setRelativeToView:function(e){var t=this._relativeToView;if(t===e)return;this._relativeToView=e;return true},getRelativeToView:function(){return this._relativeToView},getHtmlElement:function(){return this._htmlElement},_acquireResources:function(){this._acquireDomNode(this._htmlElement)},_releaseResources:function(){if(this._htmlElement)this._releaseDomNode(this._htmlElement)},_cleanup_AmmViewHtml:function(){this.setHtmlElement(null)}};Amm.extend(Amm.View.Html,Amm.DomHolder);Amm.View.Abstract=function(e){Amm.callMethods(this,"_preInit_",e);Amm.ElementBound.call(this,e);Amm.init(this,e,["element","elementPath"]);if(!this.id)this.id=Amm.getClass(this)};Amm.View.Abstract.waitForView=function(i,r,n,s,o){var a=i.findView(r,n);if(a&&a.getObserving()){s.call(o,a,i);return null}var e=function(){var t;t=function(e){if(r!==undefined&&e.id!==r)return;if(n!==undefined&&!Amm.is(e,n))return;s.call(o,a,i);i.unsubscribe("viewReady",t)};return t}();i.subscribe("viewReady",e);return e};Amm.View.Abstract.stopWaitingForView=function(e,t){e.unsubscribe("viewReady",t)};Amm.View.Abstract.prototype={"Amm.View.Abstract":"__CLASS__",twoWayInit:true,_presentationProperty:null,_observing:null,id:null,getIsReady:function(){return this.getObserving()},getObserving:function(){return this._observing},_doElementChange:function(e,t){if(this._observing)this._endObserve();if(t)t.outViewDeleted(this);Amm.ElementBound.prototype._doElementChange.call(this,e,t);if(e)e.outViewAdded(this);Amm.callMethods(this,"_elementChange_",e,t);this._observeElementIfPossible()},_canObserve:function(){if(!this._presentationProperty)return false;return!!(this._element&&this[this._presentationProperty])},_endObserve:function(){this._observing=false;if(this._element)this._element.unsubscribe(undefined,undefined,this);this._releaseResources()},_observeElementIfPossible:function(){var e=this._canObserve();if(!e){if(this._observing)this._endObserve();return}if(this._observing)return;this._observing=true;this._acquireResources();var t=[],i={};for(var r in this){if(typeof this[r]==="function"){var n=(""+r).slice(0,4);if(n==="setV"||n==="getV"){var s=r[4].toLowerCase()+r.slice(5);if(!i[s]){i[s]=true;this._observeProp(s,"setV"+r.slice(4),t)}}else{if((""+r).slice(0,14)==="_handleElement"){var o=r[14].toLowerCase()+r.slice(15);if(this._element.hasEvent(o))this._element.subscribe(o,this[r],this)}}}}this._initProperties(t);this._element.outViewReady(this);return true},_acquireResources:function(){},_releaseResources:function(){},_observeProp:function(e,t,i){var r={};Amm.detectProperty(this._element,e,r);if(this[t]){if(r.eventName)this._element.subscribe(r.eventName,t,this)}if(r.getterName){r.propName=e;i.push(r)}},_initProperties:function(e){for(var t=0;t<e.length;t++){var i=e[t],r=i.propName;r=r[0].toUpperCase()+r.slice(1);var n="setV"+r,s="getV"+r;var o=this._element[i.getterName]();if(this.twoWayInit&&o===undefined&&i.setterName&&typeof this[s]==="function"){var a=this[s]();if(a!==undefined){this._element[i.setterName](a)}}else{if(typeof this[n]==="function")this[n](o)}}},getSuggestedTraits:function(){return[]}};Amm.extend(Amm.View.Abstract,Amm.ElementBound);Amm.View.Abstract.Collection=function(e){Amm.View.Abstract.call(this,e)};Amm.View.Abstract.Collection.prototype={"Amm.View.Abstract.Collection":"__CLASS__",_observesCollection:false,_collection:null,_requiresElement:false,_collectionProperty:null,_colEv:null,_canObserveCollection:function(){var e=this._collection&&(!this._requiresElement||this._element);if(this._presentationProperty)e=e&&this[this._presentationProperty];return!!e},_observeCollectionIfPossible:function(){var e=this._canObserveCollection();if(e){if(!this._observesCollection){this._beginObserveCollection()}}else{if(this._observesCollection){this._endObserveCollection()}}},_beginObserveCollection:function(){if(this._observesCollection)return;this._observesCollection=true;this._colEv=[];var e="_handleCollection",t=e.length;for(var i in this){if(i[0]==="_"&&i.slice(0,t)===e&&typeof this[i]==="function"){var r=i.charAt(t).toLowerCase()+i.slice(t+1);this._collection.subscribe(r,this[i],this);this._colEv.push(r)}}},_endObserveCollection:function(){if(!this._observesCollection)return;this._observesCollection=false;if(this._colEv){for(var e=0,t=this._colEv.length;e<t;e++)this._collection.unsubscribe(this._colEv[e],undefined,this)}},setCollection:function(e){var t=this._collection;if(t===e)return;if(t)this._endObserveCollection();this._collection=e;this._observeCollectionIfPossible();return true},getCollection:function(){return this._collection},setRequiresElement:function(e){var t=this._requiresElement;if(t===e)return;this._requiresElement=e;this._observeCollectionIfPossible();return true},getRequiresElement:function(){return this._requiresElement},getObservesCollection:function(){return this._observesCollection},setCollectionProperty:function(e){var t=this._collectionProperty;if(t===e)return;if(this._element&&t)this._element.unsubscribe(t+"Change",undefined,this);this._collectionProperty=e;var i=e+"Change";if(this._element&&this._element.hasEvent(i))this._element.subscribe(i,this._onElementCollectionPropertyChange,this);this._checkCollectionProperty();return true},_checkCollectionProperty:function(e){if(!this._element&&!e)return;var t=null;if(this._element){if(this._collectionProperty){t=Amm.getProperty(this._element,this._collectionProperty)}else if(Amm.is(this._element,"Amm.Collection")){t=this._element}}this.setCollection(t)},getCollectionProperty:function(){return this._collectionProperty},_onElementCollectionPropertyChange:function(e,t){this.setCollection(e)},_doElementChange:function(e,t){Amm.View.Abstract.prototype._doElementChange.call(this,e,t);this._checkCollectionProperty(!!t)},_observeElementIfPossible:function(){var e=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);this._observeCollectionIfPossible();if(!e)return e;if(this._collectionProperty){var t=this._collectionProperty+"Change";if(this._element&&this._element.hasEvent(t)){this._element.subscribe(t,this._onElementCollectionPropertyChange,this)}}return e}};Amm.extend(Amm.View.Abstract.Collection,Amm.View.Abstract);Amm.View.Html.Collection=function(e){Amm.registerItem(this);Amm.View.Html.call(this);this._mappingProp="_map_vhc_"+this._amm_id;Amm.View.Abstract.Collection.call(this,e)};Amm.View.Html.Collection.prototype={"Amm.View.Html.Collection":"__CLASS__",debug:false,itemHtmlElementsMustBeOrphans:true,_mappingProp:null,createItemHtml:function(e){return"<div>Overwrite createItemHtml!</div>"},updateItemHtml:function(e,t){return jQuery(this.createItemHtml(e))[0]},_doSetHtmlElement:function(e,t){if(!this._canObserve()&&this._canObserveCollection())this._acquireResources()},getItemHtmlElement:function(e){if(e[this._mappingProp])return e[this._mappingProp];var t=this._createAndBindHtmlNode(e);if(!t[this._mappingProp]){t[this._mappingProp]=e;e[this._mappingProp]=t}return t},getHtmlElementItem:function(e){return e[this._mappingProp]},rebuild:function(){return this._rebuild()},_canObserve:function(){if(!this._presentationProperty)return false;return!!(this._element&&this[this._presentationProperty])},_createAndBindHtmlNode:function(e){var t=this.createItemHtml(e);if(typeof t==="string")t=jQuery(t)[0];if(!t||!t.nodeType)Error("Cannot reliabliy create and bind Html Node");if(t.parentNode&&t.parentNode.nodeType!==11){if(this.itemHtmlElementsMustBeOrphans){Error("createItemHtml() is supposed to create new nodes, but this one already has parentNode")}else{t.parentNode.removeChild(t)}}t[this._mappingProp]=e;e[this._mappingProp]=t;return t},_beginObserveCollection:function(){this._rebuild();Amm.View.Abstract.Collection.prototype._beginObserveCollection.call(this)},_clearContainer:function(){var i=jQuery(this._htmlElement);var r=this._mappingProp;i.contents().each(function(e,t){if(t[r]){if(t[r][r]===t)delete t[r][r];delete t[r]}i[0].removeChild(t)})},_rebuild:function(){if(this.debug)console.log(this.debug,"_rebuild");this._clearContainer();this._insertToContainer()},_insertToContainer:function(e,t,i){i=i||false;e=e||this._collection;for(var r=0;r<e.length;r++){var n=this.getItemHtmlElement(e[r],!i);if(n){if(!t)this._htmlElement.appendChild(n);else this._htmlElement.insertBefore(n,t)}}},_handleCollectionAppendItems:function(e){if(this.debug)console.log(this.debug,"_handleCollectionAppendItems",e.length);this._insertToContainer(e)},_handleCollectionDeleteItem:function(e,t){if(this.debug)console.log(this.debug,"_handleCollectionDeleteItem",e,t._amm_id);var i=this._mappingProp,r=t[i];if(r){if(r.parentNode===this._htmlElement)this._htmlElement.removeChild(r);if(r[i])delete r[i];delete t[i]}},refreshAllItems:function(){if(!this._collection||!this._htmlElement)return;for(var e=0,t=this._collection.length;e<t;e++){this.refreshItem(this._collection[e])}},refreshItem:function(e){if(!this._collection||!this._htmlElement)return;var t=this._mappingProp,i=e[t],r=this.updateItemHtml(e,i);if(!r)return;var n=jQuery(r)[0];if(!n||n===i)return;if(!n.nodeType){Error("updateItemHtml() returned something that is not an HTML Node")}if(n.parentNode&&n.parentNode.nodeType!==11){if(this.itemHtmlElementsMustBeOrphans){Error("updateItemHtml() is supposed to create new nodes, but this one already has parentNode")}else{n.parentNode.removeChild(n)}}if(!jQuery(n).has(i).length){jQuery(i).replaceWith(n)}i[t]=null;n[t]=e;e[t]=n},_handleCollectionItemChange:function(e){this.refreshItem(e)},_handleCollectionSpliceItems:function(e,t,i){if(t.length>=this._htmlElement.childNodes.length){this._rebuild();return}var r=this._htmlElement.childNodes;for(var n=e,s=Math.min(e+t.length,r.length);n<s;n++){this._htmlElement.removeChild(r[e])}this._insertToContainer(i,r[e]);var o=this._mappingProp;for(var n=0,s=t.length;n<s;n++){if(t[n][o]&&!t[n][o].parentNode){if(t[n][o][o])delete t[n][o][o];delete t[n][o]}}},_handleCollectionMoveItem:function(e,t,i){if(this.debug)console.log(this.debug,"_handleCollectionMoveItem",e,t,i._amm_id);var r,n=this._htmlElement.childNodes;var s=n[e];this._htmlElement.removeChild(s);var o=n[t];if(o)this._htmlElement.insertBefore(s,o);else this._htmlElement.appendChild(s)},_handleCollectionClearItems:function(){if(this.debug)console.log(this.debug,"_handleCollectionClearItems");this._clearContainer()},_handleCollectionItemsChange:function(e,t){if(this.debug)console.log(this.debug,"_handleCollectionItemsChange",e.length,t.length);this._rebuild()}};Amm.extend(Amm.View.Html.Collection,Amm.View.Html);Amm.extend(Amm.View.Html.Collection,Amm.View.Abstract.Collection);Amm.View.Html.DisplayParent=function(e){this.requiredElementInterfaces=this.requiredElementInterfaces||[];this.requiredElementInterfaces.push("DisplayParent");delete this._handleCollectionItemChange;Amm.View.Html.Collection.call(this,e)};Amm.View.Html.DisplayParent.prototype={"Amm.View.Html.DisplayParent":"__CLASS__",debug:false,_collectionProperty:"displayChildren",itemHtmlElementsMustBeOrphans:false,scanForItems:true,buildItems:false,scanForDisplayOrder:true,getItemHtmlElement:function(e,t){var i=this._getItemView(e,t);var r=null;if(i)r=i.getHtmlElement();if(!r&&!t){Error("Collection item doesn't have view with htmlElement")}if(!r[this._mappingProp]){r[this._mappingProp]=e;e[this._mappingProp]=r}return r},updateItemHtml:function(e,t){},_getItemView:function(e,t){var i=e.getUniqueSubscribers("Amm.View.Html.Visual");if(!i.length){if(!t)Error("Collection item doesn't have respective Amm.View.Html.Visual view");return null}if(!i.length>1)console.warn("Collection item have more than one Amm.View.Html.Visual view");return i[0]},_getHtmlElementsWithItems:function(){var e=Amm.domHolderAttribute;return jQuery(this._htmlElement).children("["+e+"]").toArray()},_getElementOfHtmlElement:function(e){var t=Amm.domHolderAttribute;var i=(e.getAttribute(t)+"").split(" ");var r=Amm.getItem(i);var n=null;for(var s=0,o=r.length;s<o;s++){if(Amm.is(r[s],"Amm.View.Html.Visual")){n=r[s].getElement();if(n)return n}}return null},_getItemsInContainer:function(){var e=this._getHtmlElementsWithItems();var t=[];for(var i=0,r=e.length;i<r;i++){var n=this._getElementOfHtmlElement(e[i]);if(!n)continue;t.push(n)}return t},_updateCollectionWithFoundItems:function(e){var t=this.scanForItems,i=this.scanForDisplayOrder;if(t&&i){var r=Amm.Array.diff(e,this._collection);if(r.length)this._collection.push.apply(this._collection,r);for(var n=0;n<e.length;n++)e[n].setDisplayOrder(n)}else if(t){var r=Amm.Array.diff(e,this._collection);if(r.length)this._collection.push.apply(this._collection,this._collection.length,e)}else{for(var n=0;n<e.length;n++)e[n].setDisplayOrder(n)}},_scanForItems:function(){if(this.buildItems){var e=new Amm.Builder(jQuery(this._htmlElement));e.build()}var t=this.scanForItems,i=this.scanForDisplayOrder;if(!t&&!i)return;var r=this._getItemsInContainer();if(r.length)this._updateCollectionWithFoundItems(r)},_beginObserveCollection:function(){this._scanForItems();Amm.View.Html.Collection.prototype._beginObserveCollection.call(this)},getSuggestedTraits:function(){return[Amm.Trait.DisplayParent]}};Amm.extend(Amm.View.Html.DisplayParent,Amm.View.Html.Collection);Amm.View.Abstract.Annotated=function(e){this._childViews=[];Amm.View.Abstract.call(this,e);this._requireInterfaces("Annotated")};Amm.View.Abstract.Annotated.prototype={"Amm.View.Abstract.Annotated":"__CLASS__",_childViews:null,enumerateExisting:true,_observeElementIfPossible:function(){var e=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);if(e){if(this.enumerateExisting)this._createExisting()}return e},_createExisting:function(){},_doElementChange:function(e,t){Amm.View.Abstract.prototype._doElementChange.call(this,e,t);if(t)t.getAnnotationsContainer().unsubscribe(undefined,undefined,this);this._clearChildViews();if(e){var i=e.getAnnotationsContainer();i.subscribe("childAdded",this._onAnnotationAdded,this);var r=i.listChildren();for(var n=0;n<r.length;n++){this._createChildViewsOrDefer(i.getChild(r[n]))}}},_clearChildViews:function(){for(var e=this._childViews.length-1;e>=0;e--){this._childViews[e].cleanup();delete this._childViews[e]}},_createViewOnChildContentChange:function(e,t){var i=Amm.event.origin;if(e&&i._annotated_needCreateViews){if(this._createChildViews(i)){i.unsubscribe("contentChange",this._createViewOnChildContentChange,this);i._annotated_needCreateViews=false}}},_createChildViewsOrDefer:function(e){if(!this._createChildViews(e)){e._annotated_needCreateViews=true;e.subscribe("contentChange",this._createViewOnChildContentChange,this)}},_onAnnotationAdded:function(e){this._createChildViewsOrDefer(e)},_createChildViews:function(e,t){},cleanup:function(){this._clearChildViews();Amm.View.Abstract.prototype.cleanup.call(this)}};Amm.extend(Amm.View.Abstract.Annotated,Amm.View.Abstract);Amm.View.Html.Annotated=function(e){Amm.DomHolder.call(this);Amm.View.Abstract.Annotated.call(this,e)};Amm.View.Html.Annotated.prototype={"Amm.View.Html.Annotated":"__CLASS__",annotationClass:"annotation",annotationClassPrefix:"a_",createNodesOnDemand:true,classToId:function(e,t){if(t){var i=e.replace(/^\s+|\s+$/g,"").split(/\s+/);for(var r=0;r<i.length;r++){var n=this.classToId(i[r]);if(n)return n}return null}if(e===this.annotationClass)return null;var s=this.annotationClassPrefix.length,o=null;if(!s)o=e;else if(e.slice(0,s)===this.annotationClassPrefix){o=e.slice(s)}return o},idToClass:function(e){return this.annotationClassPrefix+e},locateChildHtmlElement:function(e,t){if(!this._htmlElement)return null;var i=this.idToClass(e),r="."+this.idToClass(e);if(this.annotationClass)r="."+this.annotationClass+r;var n=jQuery(this._htmlElement).find(r);if(!n.length){if(t){n=jQuery('<div class="'+this.annotationClass+" "+i+'"></div>');jQuery(this._htmlElement).append(n)}else{n=null}}return n},_createExisting:function(){if(!this._htmlElement)return null;var n=this,e={};jQuery(this._htmlElement).find("."+this.annotationClass).each(function(e,t){var i=n.classToId(t.getAttribute("class"),true);var r=n._element.getAnnotationsContainer().getAnnotationElement(i);n._createChildViews(r,true,t)});return e},_createChildViews:function(e,t,i){i=i||this.locateChildHtmlElement(e.getId(),this.createNodesOnDemand);if(!i){if(t)throw Error("Cannot locate child htmlElement for child with id "+e.getId());if(this.createNodesOnDemand){e._annotated_needCreateViews=true}return null}var r=[];if(e["Visual"]){r.push(new Amm.View.Html.Visual({element:e,htmlElement:i}))}r.push(new Amm.View.Html.Content({element:e,htmlElement:i}));return r},_acquireResources:function(){this._acquireDomNode(this._htmlElement)},getSuggestedTraits:function(){return[Amm.Trait.Annotated]}};Amm.extend(Amm.View.Html.Annotated,Amm.View.Html);Amm.extend(Amm.View.Html.Annotated,Amm.View.Abstract.Annotated);Amm.View.Html.StaticDisplayParent=function(e){Amm.View.Html.DisplayParent.call(this,e)};Amm.View.Html.StaticDisplayParent.prototype={"Amm.View.Html.StaticDisplayParent":"__CLASS__",_oldAllowAdd:null,_oldAllowDelete:null,_oldAllowChangeOrder:null,_scanForItems:function(){if(!this.scanForItems){console.warn("Setting Amm.View.Html.StaticDisplayParent::scanForItems to FALSE has no effect; property was reset back to TRUE");this.scanForItems=true}if(!this.scanForDisplayOrder){console.warn("Setting Amm.View.Html.StaticDisplayParent::scanForDisplayOrder to FALSE has no effect; property was reset back to TRUE");this.scanForDisplayOrder=true}return Amm.View.Html.DisplayParent.prototype._scanForItems.apply(this)},_beginObserveCollection:function(){this._oldAllowAdd=this._collection.getAllowAdd();this._oldAllowDelete=this._collection.getAllowDelete();this._oldAllowChangeOrder=this._collection.getAllowChangeOrder();if(!this._oldAllowAdd)this._collection.setAllowAdd(true);if(!this._oldAllowDelete)this._collection.setAllowDelete(true);if(!this._oldAllowChangeOrder)this._collection.setAllowChangeOrder(true);return Amm.View.Html.DisplayParent.prototype._beginObserveCollection.apply(this)},_freezeCollection:function(){this._collection.setAllowAdd(false);this._collection.setAllowDelete(false);this._collection.setAllowChangeOrder(false)},_endObserveCollection:function(){this._collection.setAllowAdd(this._oldAllowAdd);this._collection.setAllowDelete(this._oldAllowDelete);this._collection.setAllowChangeOrder(this._oldAllowChangeOrder);return Amm.View.Html.DisplayParent.prototype._endObserveCollection.apply(this)},_getHtmlElementsWithItems:function(){var e=Amm.domHolderAttribute;var t=jQuery(this._htmlElement).find("["+e+"]");var i=t.not(t.find("["+e+"]"));return i},_updateCollectionWithFoundItems:function(e){if(this._collection.length&&!Amm.Array.equal(this._collection,e)){console.warn("Pre-populated display children are replaced by Amm.View.Html.StaticDisplayParent detection routine")}this._collection.setItems(e);this._freezeCollection()},_rebuild:function(){}};Amm.extend(Amm.View.Html.StaticDisplayParent,Amm.View.Html.DisplayParent);Amm.View.Abstract.Select=function(e){Amm.View.Abstract.call(this,e);this._requireInterfaces("Select")};Amm.View.Abstract.Select.prototype={"Amm.View.Abstract.Select":"__CLASS__",_fieldView:null,_collectionView:null,_observeElementIfPossible:function(){var e=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);if(e)this._doObserveSelect();return e},_createFieldView:function(){},_createCollectionView:function(){},_doObserveSelect:function(){if(!this._collectionView)this._createCollectionView();this._collectionView.setElement(this._element);if(!this._fieldView)this._createFieldView();this._fieldView.setElement(this._element)},_endObserve:function(){this._fieldView.setElement(null);this._collectionView.setElement(null)}};Amm.extend(Amm.View.Abstract.Select,Amm.View.Abstract);Amm.View.Html.Select=function(e){Amm.View.Html.call(this);Amm.View.Abstract.Select.call(this,e)};Amm.View.Html.Select.prototype={"Amm.View.Html.Select":"__CLASS__",_fieldView:null,_collectionView:null,_createFieldView:function(){var e={getVReadOnly:this._fieldView_getVReadOnly,setVReadOnly:this._fieldView_setVReadOnly,htmlElement:this._htmlElement,getVValue:this._fieldView_getVValue,setVValue:this._fieldView_setVValue};this._fieldView=new Amm.View.Html.Input(e);this._fieldView._selectView=this;this._fieldView._receiveEvent=this._fieldView_receiveEvent},_fieldView_getVReadOnly:function(){return false},_fieldView_setVReadOnly:function(e){},_fieldView_receiveEvent:function(e){if(!this._element)return;if(e.type==="change"&&this._element.getReadOnly()){this.setVValue(this._element.getValue());return true}return Amm.View.Html.Input.prototype._receiveEvent.call(this,e)},_fieldView_setVValue:function(e){if(!this._selectView._element)return;var t=this._selectView._collectionView;var i,r;if(!t)return Amm.View.Html.Input.prototype.getVValue.call(this);if(this._element.getMultiple()){for(i=0,r=this._htmlElement.options.length;i<r;i++){var n=t.getHtmlElementItem(this._htmlElement.options[i]);if(!n)continue;this._htmlElement.options[i].selected=Amm.Array.indexOf(n.getValue(),e)>=0}return}for(i=0,r=this._htmlElement.options.length;i<r;i++){var n=t.getHtmlElementItem(this._htmlElement.options[i]);this._htmlElement.options[i].selected=n.getValue()===e}},_fieldView_getVValue:function(){if(this._element.getOptions()===undefined&&this._htmlElement){this._element.setOptions(this._detectOptions(this._htmlElement));return}var e=[];var t=this._element.getMultiple();var i=this._selectView._collectionView;if(!i)return Amm.View.Html.Input.prototype.getVValue.call(this);for(var r=0,n=this._htmlElement.options.length;r<n;r++){if(!this._htmlElement.options[r].selected)continue;var s=i.getHtmlElementItem(this._htmlElement.options[r]);if(!s)continue;var o=s.getValue();if(!t){return o}else e.push(o)}if(!t)return null;return e},_detectOptions:function(e){var t=jQuery(e);var i=[];for(var r=0;r<e.options.length;r++){var n=e.options[r];var s={label:jQuery(n).html(),value:n.value};if(n.disabled)s.disabled=true;s.selected=!!n.selected;i.push(s)}return i},_createCollectionView:function(){var e=this._element.getOptions();if(e===undefined){this._element.setOptions(this._detectOptions(this._htmlElement))}var s=this;var t={collectionProperty:"optionsCollection",htmlElement:this._htmlElement,createItemHtml:function(e){var t=jQuery("<option>"+e.getLabel()+"</option>");var i=e.getValue();if(typeof i!=="object"){t.attr("value",i)}else{t.removeAttr("value")}if(e.getDisabled())t.attr("disabled","disabled");if(e.getSelected())t.attr("selected","selected");if(!e.getVisible())return t.wrap("<span>").parent()[0];else return t[0]},updateItemHtml:function(e,t){var i=false;if(t.tagName==="SPAN"){i=true;t=t.firstChild}var r=!!e.getSelected();t.selected=r;t.disabled=s._element.getReadOnly()&&!r||!!e.getDisabled();var n=e.getValue();if(typeof n!=="object"){t.value=n}else{t.removeAttribute("value")}jQuery(t).html(e.getLabel());if(!e.getVisible()){if(!i)t=jQuery(t).wrap("<span></span>").parent()[0];else t=t.parentNode}else if(i){t.parentNode.removeChild(t)}return t}};this._collectionView=new Amm.View.Html.Collection(t)},_doObserveSelect:function(){Amm.View.Abstract.Select.prototype._doObserveSelect.call(this);this._fieldView.setElement(this._element);this._collectionView.setElement(this._element)},_endObserve:function(){this._fieldView.setElement(null);this._collectionView.setElement(null)},setHtmlElement:function(e){if(e&&e.tagName!=="SELECT"){Error("<select> element must be provided")}return Amm.View.Html.prototype.setHtmlElement.call(this,e)},_doSetHtmlElement:function(e,t){if(this._fieldView)this._fieldView.setHtmlElement(this._htmlElement);if(this._collectionView)this._collectionView.setHtmlElement(this._htmlElement)},getVMultiple:function(){var e=jQuery(this._htmlElement);if(e[0])return!!e.attr("multiple")},setVMultiple:function(e){var t=jQuery(this._htmlElement);if(t[0])t.attr("multiple",e?"multiple":null)},setVReadOnly:function(e){if(this._collectionView)this._collectionView.refreshAllItems()},getVSelectSize:function(){var e=jQuery(this._htmlElement);if(e[0]){return e[0].size||1}},setVSelectSize:function(e){var t=jQuery(this._htmlElement);if(t[0])t.attr("size",e)},getSuggestedTraits:function(){return[Amm.Trait.Select]}};Amm.extend(Amm.View.Html.Select,Amm.View.Html);Amm.extend(Amm.View.Html.Select,Amm.View.Abstract.Select);Amm.View.Abstract.Input=function(e){Amm.View.Abstract.call(this,e);this._requireInterfaces("Focusable","Editor","Lockable")};Amm.View.Abstract.Input.prototype={"Amm.View.Abstract.Input":"__CLASS__",setVFocused:function(e){},getVFocused:function(){},setVReadOnly:function(e){},getVReadOnly:function(){},setVEnabled:function(e){},getVEnabled:function(){},setVValue:function(e){},getVValue:function(){},setVLocked:function(e){}};Amm.extend(Amm.View.Abstract.Input,Amm.View.Abstract);Amm.View.Html.Input=function(e){var t=this;this._handler=function(e){return t._receiveEvent(e,this)};Amm.View.Abstract.Input.call(this,e);Amm.View.Html.call(this);Amm.JQueryListener.call(this,{})};Amm.View.Html.Input.prototype={"Amm.View.Html.Input":"__CLASS__",_eventName:"change focus blur",_blurTimeoutHandler:null,_resolveHtmlElement:false,_watchKeys:false,_receiveEvent:function(e){if(!this._element)return;if(e.type==="focus"){this._element.setFocusedView(this);return true}if(e.type==="blur"){var t=this;if(!this._blurTimeoutHandler)this._blurTimeoutHandler=function(){if(t._element.getFocusedView()===t)t._element.setFocusedView(null)};window.setTimeout(this._blurTimeoutHandler,1);return true}if(!this._element.getReadOnly()){this._element.setValue(this.getVValue())}return true},setVFocusedView:function(e){var t=e===this;var i=jQuery(this._htmlElement);if(i[0]){if(t&&!i.is(":focus"))i.focus();else if(!t&&i.is(":focus"))i.blur()}},getVFocusedView:function(){if(jQuery(this._htmlElement).is(":focus"))return this},setVReadOnly:function(e){var t=jQuery(this._htmlElement);if(t[0]){if(e&&!t[0].hasAttribute("readonly"))t[0].setAttribute("readonly","readonly");else if(!e&&t[0].hasAttribute("readonly"))t[0].removeAttribute("readonly")}},getVReadOnly:function(){var e=jQuery(this._htmlElement)[0];if(e)return e.getAttribute("readonly")},_doSetEnabled:function(e,t){if(e===undefined)e=this._element.getEnabled();if(t===undefined)t=this._element.getLocked();r=!e||t;var i=jQuery(this._htmlElement),r=!e||t;if(i[0]){if(r&&!i[0].hasAttribute("disabled"))i[0].setAttribute("disabled","disabled");else if(!r&&i[0].hasAttribute("disabled"))i[0].removeAttribute("disabled")}},setVEnabled:function(e){this._doSetEnabled(e,undefined)},getVEnabled:function(){var e=jQuery(this._htmlElement)[0];if(e)return!e.hasAttribute("disabled")},setVValue:function(e){if(this._htmlElement){jQuery(this._htmlElement).val(e)}},setVLocked:function(e){this._doSetEnabled(undefined,e)},getVValue:function(){if(this._htmlElement)return jQuery(this._htmlElement).val()},_doSetHtmlElement:function(e){this.setSelector(e)},cleanup:function(){Amm.View.Abstract.Input.prototype.cleanup.call(this);Amm.JQueryListener.prototype.cleanup.call(this);if(this._htmlElement)this._releaseDomNode(this._htmlElement)},_acquireResources:function(){this._acquireDomNode(this._htmlElement)},getSuggestedTraits:function(){return[Amm.Trait.Input]},setUpdateOnKeyUp:function(e){e=!!e;var t=this._eventName;var i=this.getUpdateOnKeyUp();if(e===i)return;if(e&&!i)t+=" keyup";else t=t.replace(/\bkeyup\b/g,"").replace(/ +/," ").replace(/^ +| +$/g,"");this.setEventName(t)},getUpdateOnKeyUp:function(){return!!this._eventName.match(/\bkeyup\b/)}};Amm.extend(Amm.View.Html.Input,Amm.View.Html);Amm.extend(Amm.View.Html.Input,Amm.JQueryListener);Amm.extend(Amm.View.Html.Input,Amm.View.Abstract.Input);Amm.View.Html.StaticDisplayParent.WithContainers=function(e){Amm.View.Html.StaticDisplayParent.call(this,e)};Amm.View.Html.StaticDisplayParent.WithContainers.prototype={"Amm.View.Html.StaticDisplayParent.WithContainers":"__CLASS__"};Amm.extend(Amm.View.Html.StaticDisplayParent.WithContainers,Amm.View.Html.StaticDisplayParent);Amm.View.Html.Default=function(e){Amm.View.Abstract.call(this,e);Amm.View.Html.call(this)};Amm.View.Html.Default.prototype={"Amm.View.Html.Default":"__CLASS__",_defaultViews:null,_replacedMyElement:false,_ownHtmlElement:null,_viewHtmlElements:null,_replaceOwnHtmlElement:true,reportMode:Amm.Builder.PROBLEM_CONSOLE|Amm.Builder.PROBLEM_HTML,setReplaceOwnHtmlElement:function(e){var t=this._replaceOwnHtmlElement;if(t===e)return;if(this._observing){throw new Error("Cannot Amm.View.Html.Default::setReplaceOwnHtmlElement() while getObserving()")}this._replaceOwnHtmlElement=e;return true},getReplaceOwnHtmlElement:function(){return this._replaceOwnHtmlElement},getOwnHtmlElement:function(){return this._ownHtmlElement},setDefaultViews:function(){if(this._defaultViews!==null)throw Error("can setDefaultViews() only once, before element observation")},getDefaultViews:function(){return this._defaultViews?[].concat(this._defaultViews):[]},_observeElementIfPossible:function(){var e=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);if(!e)return e;var t;if(this._defaultViews)t=this._defaultViews;else t=this._element.constructDefaultViews();if(!t||typeof t==="Array"&&!t.length){if(this.reportMode&Amm.Builder.PROBLEM_HTML){this._htmlElement.setAttribute("data-amm-warning","Element has no default view(s)")}if(this.reportMode&Amm.Builder.PROBLEM_CONSOLE){console.warn("Element has no default view(s): ",this._element)}return}this._defaultViews=[];if(typeof t!=="Array")t=[t];var i=[];for(var r=0,n=t.length;r<n;r++){var s=t[r],o;if(!s)continue;if(typeof s==="object"&&("class"in s||Amm.is(s,"Amm.View.Abstract"))){o=[s]}else if(Amm.Builder.isPossibleBuilderSource(s)){o=Amm.Builder.calcPrototypeFromSource(s,false,true)}else{throw new Error("incorrect result returned by Amm.Element.consturctDefaultViews() - cannot construct view")}for(var a=0,l=o.length;a<l;a++){o[a]=Amm.constructInstance(o[a],null,{element:this._element},true,["Amm.View.Html"]);this._defaultViews.push(o[a]);var h=o[a].getHtmlElement();if(h){i.push(h)}}}this._deleteNonTopNodes(i);this._setViewHtmlElements(i);return e},_deleteNonTopNodes:function(e){for(var t=e.length-1;t>=0;t--){if(e[t].parentNode&&e[t].parentNode.tagName){e.splice(t,1)}}},_replaceHtmlNodes:function(e,t){if(this._htmlElement===e[0]){if(!this._ownHtmlElement)this._ownHtmlElement=this._htmlElement;this._htmlElement=t[0]}if(!e[0].parentNode)return;var i;for(i=t.length-1;i>=0;i--){e[0].parentNode.insertBefore(t[i],e[0])}for(i=0;i<e.length;i++){e[i].parentNode.removeChild(e[i])}},_setViewHtmlElements:function(e){var t,i;t=e;if(!this._replaceOwnHtmlElement)return this._replaceContents(e);if(!t||!t.length){if(this._ownHtmlElement)t=[this._ownHtmlElement];else t=[]}i=this._viewHtmlElements;if(!i||!i.length){i=[this._htmlElement]}if(Amm.Array.equal(i,t))return;if(!t.length)return;if(this._observing){if(i.length)this._releaseDomNode(t);this._acquireDomNode(t)}if(i[0]===this._htmlElement&&!this._ownHtmlElement)this._ownHtmlElement=i[0];this._replaceHtmlNodes(i,t);this._viewHtmlElements=e&&e.length?e:null;this._htmlElement=t[0]},_doSetHtmlElement:function(e,t){if(!e||!t||!this._observing)return;var i=this._ownHtmlElement;if(i&&!this._viewHtmlElements){this._releaseDomNode(this._ownHtmlElement);return}var r=[].concat(this._viewHtmlElements);this._setViewHtmlElements([]);this._releaseResources(i);this._htmlElement=e;this._ownHtmlElement=null;this._setViewHtmlElements(r)},_replaceContents:function(e){var t=this._htmlElement.firstChild,i;while(t){i=t.nextSibling;this._htmlElement.removeChild(t);t=i}this._viewHtmlElements=e||null;if(!e)return;for(var r=0;r<e.length;r++){this._htmlElement.appendChild(e[r])}return},_releaseResources:function(){this._setViewHtmlElements([]);if(!this._defaultViews)return;for(var e=0,t=this._defaultViews.length;e<t;e++){this._defaultViews[e].setElement(null);this._defaultViews[e].setHtmlElement(null);this._defaultViews[e].cleanup()}this._defaultViews=null;Amm.View.Html.prototype._releaseResources.call(this)}};Amm.extend(Amm.View.Html.Default,Amm.View.Html);Amm.extend(Amm.View.Html.Default,Amm.View.Abstract);Amm.View.Abstract.Visual=function(e){Amm.View.Abstract.call(this,e);this._requireInterfaces("Visual","ClassName")};Amm.View.Abstract.Visual.prototype={"Amm.View.Abstract.Visual":"__CLASS__",setVVisible:function(e){},getVVisible:function(){},setVDisplayParent:function(e){},getVDisplayParent:function(){},setVDisplayOrder:function(e){},getVDisplayOrder:function(){},setVClassName:function(e){},getVClassName:function(){}};Amm.extend(Amm.View.Abstract.Visual,Amm.View.Abstract);Amm.View.Html.Visual=function(e){Amm.View.Abstract.Visual.call(this,e);Amm.View.Html.call(this)};Amm.View.Html.Visual.defaultDelay=250;Amm.View.Html.Visual.prototype={"Amm.View.Html.Visual":"__CLASS__",delay:undefined,setVVisible:function(e){var t=this.delay;if(t===undefined)t=Amm.View.Html.Visual.defaultDelay;jQuery(this._htmlElement)[e?"show":"hide"](t)},getVVisible:function(){if(!this._htmlElement)return undefined;var e=this._htmlElement.style.display!=="none";return e},setVDisplayParent:function(e){},getVDisplayParent:function(){},setVDisplayOrder:function(e){},getVDisplayOrder:function(){},setVToggleClass:function(e,t){jQuery(this._htmlElement)[t?"addClass":"removeClass"](e)},getVToggleClass:function(e){return jQuery(this._htmlElement).hasClass(e)},setVClassName:function(e){jQuery(this._htmlElement).attr("class",e)},getVClassName:function(){return jQuery(this._htmlElement).attr("class")},cleanup:function(){Amm.View.Abstract.Visual.prototype.cleanup.call(this);if(this._htmlElement)this._releaseDomNode(this._htmlElement)},_acquireResources:function(){this._acquireDomNode(this._htmlElement)},getSuggestedTraits:function(){return[Amm.Trait.Visual]}};Amm.extend(Amm.View.Html.Visual,Amm.View.Html);Amm.extend(Amm.View.Html.Visual,Amm.View.Abstract.Visual);Amm.View.Html.Toggle=function(e){Amm.View.Html.Input.call(this,e)};Amm.View.Html.Toggle.prototype={"Amm.View.Html.Toggle":"__CLASS__",getVIsRadio:function(){return jQuery(this._htmlElement).attr("type")==="radio"?true:undefined},setVIsRadio:function(e){jQuery(this._htmlElement).attr("type",e?"radio":"checkbox")},getVChecked:function(){var e=jQuery(this._htmlElement)[0];if(e)return e.checked},setVChecked:function(e){var t=jQuery(this._htmlElement)[0];if(t)t.checked=!!e},setVValue:function(){},getVValue:function(){},getVCheckedValue:function(){var e=jQuery(this._htmlElement)[0];if(e)return e.value},setVCheckedValue:function(e){var t=jQuery(this._htmlElement)[0];if(t)t.value=e},_receiveEvent:function(e){if(!this._element)return;if(e.type==="change"){if(this._element.getReadOnly()){this.setVChecked(this._element.getChecked());if(this._element.getIsRadio()){var t=this._element.findGroupItems(true,true);for(var i=0,r=t.length;i<r;i++){if(t[i].getChecked()){var n=t[i].getUniqueSubscribers("Amm.View.Html.Toggle");for(var s=0,o=n.length;s<o;s++)n[s].setVChecked(true)}}}}else{this._element.setChecked(this._htmlElement.checked)}return true}return Amm.View.Html.Input.prototype._receiveEvent.call(this,e)},getVGroupName:function(){return jQuery(this._htmlElement).attr("name")},getVGroupParent:function(){return jQuery(this._htmlElement).closest("form")[0]},getSuggestedTraits:function(){return[Amm.Trait.Toggle]}};Amm.extend(Amm.View.Html.Toggle,Amm.View.Html.Input);Amm.View.Html.Variants=function(e){Amm.View.Abstract.call(this,e);Amm.View.Html.call(this,e);Amm.DomHolder.call(this);this._requireInterfaces("InstantiatorOrRepeater")};Amm.View.Html.Variants.ERROR_BOTH_ATTRIBS="HTML definition of variant prototype cannot have both data-amm-default and data-amm-condition";Amm.View.Html.Variants.ERROR_DEFAULT_DEFINED="Default variant prototype was already defined";Amm.View.Html.Variants.ERROR_INVALID_ATTRIBUTE="Attribute data-amm-condition should contain hash value";Amm.View.Html.Variants.prototype={"Amm.View.Html.Variants":"__CLASS__",_observeElementIfPossible:function(){var e=Amm.View.Abstract.prototype._observeElementIfPossible.call(this);if(!e)return e;this._scanHtmlElementAndConfigureInstantiator();return e},_scanHtmlElementAndConfigureInstantiator:function(){var e=Amm.View.Html.Variants.scanNodeForVairants(this._htmlElement);if(!e)return;this._element.reportInstantiatorOptions(e.default,e.conditions,e.prototypes)}};Amm.extend(Amm.View.Html.Variants,Amm.View.Html);Amm.extend(Amm.View.Html.Variants,Amm.View.Abstract);Amm.View.Html.Variants.builderExtension_build=function(e,t,i){var r=Amm.View.Html.Variants.scanNodeForVairants(e);if(!r)return;t.initialInstantiatorOptions=[r.default,r.conditions,r.prototypes]};Amm.View.Html.Variants.scanNodeForVairants=function(e){var t,i;var r=[],n={};var s=null;for(t=0;t<e.childNodes.length;t++){var o=e.childNodes[t];if(!o.hasAttribute)continue;var a=o.hasAttribute("data-amm-default");var l=o.hasAttribute("data-amm-condition");if(a&&l){console.error(Amm.View.Html.Variants.ERROR_BOTH_ATTRIBS,o);throw Error(Amm.View.Html.Variants.ERROR_BOTH_ATTRIBS)}if(a){if(s){console.error(Amm.View.Html.Variants.ERROR_DEFAULT_DEFINED,o,s);throw Error(Amm.View.Html.Variants.ERROR_DEFAULT_DEFINED)}s=o;continue}var h=(window.RJSON||window.JSON).parse(o.getAttribute("data-amm-condition"));if(!(h&&typeof h==="object")){console.error(Amm.View.Html.Variants.ERROR_INVALID_ATTRIBUTE,o);throw Error(o)}i=h._id||"condition_"+r.length;h._id=i;r.push(h);n[i]=o}if(!r.length&&!s)return;return{default:s,conditions:r,prototypes:n}};Amm.View.Abstract.Content=function(e){Amm.View.Abstract.call(this,e);this._requireInterfaces("Content")};Amm.View.Abstract.Content.prototype={"Amm.View.Abstract.Content":"__CLASS__",_elementContentTranslator:null,_contentTranslator:null,_lastContent:undefined,setContentTranslator:function(e){if(e)e=Amm.constructInstance(e,"Amm.Translator");else e=null;var t=this._contentTranslator;if(t===e)return;this._contentTranslator=e;if(this._observing&&this._lastContent!==undefined)this.setVContent(this._lastContent);return true},getContentTranslator:function(){return this._contentTranslator},setVContentTranslator:function(e){this._elementContentTranslator=e;if(!this._contentTranslator&&this._lastContent!==undefined&&this._observing){this.setVContent(this._lastContent)}},_doHandleInTranslationError:function(e,t){},_doHandleOutTranslationError:function(e,t){},setVContent:function(e){this._lastContent=e;var t=this._contentTranslator||this._elementContentTranslator;var i,r={};if(t){i=t.translateOut(e,r);if(r.error)i=this._doHandleInTranslationError(e,r.error)}else{i=e}this._doSetContent(i)},getVContent:function(){var e=this._doGetContent();var t=this._contentTranslator||this._elementContentTranslator;var i,r={};if(t){i=t.translateIn(e,r);if(r.error)i=this._doHandleInTranslationError(e,r.error)}else{i=e}return i},_doSetContent:function(e){},_doGetContent:function(){}};Amm.extend(Amm.View.Abstract.Content,Amm.View.Abstract);Amm.View.Html.Content=function(e){Amm.View.Abstract.Content.call(this,e);Amm.DomHolder.call(this)};Amm.View.Html.Content.prototype={"Amm.View.Html.Content":"__CLASS__",_doSetContent:function(e){jQuery(this._htmlElement).html(e)},_doGetContent:function(){return jQuery(this._htmlElement).html()},getSuggestedTraits:function(){return[Amm.Trait.Content]}};Amm.extend(Amm.View.Html.Content,Amm.View.Html);Amm.extend(Amm.View.Html.Content,Amm.View.Abstract.Content);Amm.Trait.Input=function(){};Amm.Trait.Input.prototype={Focusable:"__INTERFACE__",Editor:"__INTERFACE__",Lockable:"__INTERFACE__",_readOnly:undefined,_focused:undefined,_enabled:true,_value:undefined,_locked:false,_focusedView:null,setValue:function(e){var t=this._value;if(t===e)return;this._value=e;this.outValueChange(e,t);return true},getValue:function(){return this._value},outValueChange:function(e,t){this._out("valueChange",e,t)},setReadOnly:function(e){var t=this._readOnly;if(t===e)return;this._readOnly=e;this.outReadOnlyChange(e,t);return true},getReadOnly:function(){return this._readOnly},outReadOnlyChange:function(e,t){this._out("readOnlyChange",e,t)},setFocused:function(e){e=!!e;var t=this._focused;if(t===e)return;this._focused=e;this.outFocusedChange(e,t);return true},getFocused:function(){return this._focused},outFocusedChange:function(e,t){this._out("focusedChange",e,t)},setFocusedView:function(e){if(!e)e=null;var t=this._focusedView;if(t===e)return;this._focusedView=e;if(e===null)this.setFocused(false);else if(!this._focused)this.setFocused(true);this.outFocusedViewChange(e,t);return true},getFocusedView:function(){return this._focusedView},outFocusedViewChange:function(e,t){this._out("focusedViewChange",e,t)},setEnabled:function(e){var t=this._enabled;if(t===e)return;this._enabled=e;this.outEnabledChange(e,t);return true},getEnabled:function(){return this._enabled},outEnabledChange:function(e,t){this._out("enabledChange",e,t)},setLocked:function(e){var t=this._locked;if(t===e)return;this._locked=e;this.outLockedChange(e,t);return true},getLocked:function(){return this._locked},outLockedChange:function(e,t){this._out("lockedChange",e,t)}};Amm.Trait.Select=function(){};Amm.Trait.Select.valuesAreSame=function(e,t){if(e===undefined&&t!==undefined)return false;if(t===undefined&&e!==undefined)return false;if(e===t)return true;if(e&&e["Amm.Array"])e=e.getItems();if(t&&t["Amm.Array"])t=t.getItems();var i=function(e,t){return e==t?0:1};if(e instanceof Array){if(!(t instanceof Array))return false;if(!Amm.Array.diff(e,t,i).length&&!Amm.Array.diff(t,e,i).length){return true}return false}else{if(t instanceof Array)return false}return!i(e,t)};Amm.Trait.Select.prototype={Select:"__INTERFACE__",options:null,_objectsMapper:null,_selectionCollection:null,_multiple:undefined,_selectSize:undefined,_numChanges:0,_labelProperty:null,_valueProperty:null,_disabledProperty:null,_dummyLabel:null,_dummyValue:null,_dummyOption:null,_optionPrototype:null,_sorter:null,setOptions:function(e){if(!e)e=[];var t=[];if(e instanceof Array||e["Amm.Array"]){t=e}else if(typeof e==="object"){for(var i in e)if(e.hasOwnProperty(i)){t.push({label:e[i],value:i})}}var r=[];for(var i=0;i<t.length;i++){var n;var s=this._optionPrototype?Amm.overrideRecursive({},this._optionPrototype):{};if(typeof t[i]!=="object"){s.label=t[i];s.value=t[i]}else{var o=Amm.getClass(t[i]);if(!o)s=Amm.overrideRecursive(s,t[i]);else n=t[i]}s.component=this.getClosestComponent();r.push(Amm.constructInstance(s,Amm.Trait.Select.Option))}if(this._dummyOption)r.unshift(this._dummyOption);var a=this.getSelectionCollection(),l=this.getValue();if(l instanceof Array)l=[].concat(l);a.beginUpdate();this.getOptionsCollection().setItems(r);if(l!==undefined)a.setValue(l);a.endUpdate();if(!this._multiple&&(this._value===null||this._value===undefined)&&this._selectSize===1){if(this._correctValueForSingleSelect())return}},_updateDummyOption:function(e){var t=null;e=e||this._objectsMapper;if(!this._multiple&&this._dummyLabel!==null&&this._dummyLabel!==undefined){if(this._dummyOption)t=this._dummyOption;else t=new Amm.Trait.Select.Option;t.setLabel(this._dummyLabel);t.setValue(this._dummyValue)}if(e){e.setDestExtra(t?[t]:null);return}if(!this.options)return;if(t&&!this._dummyOption){this.options.splice(0,0,t)}else if(!t&&this._dummyOption){this.options.reject(this._dummyOption)}this._dummyOption=t},getOptions:function(){if(!this.options)return undefined;var e=this.getOptionsCollection().getItems();if(this._dummyOption)return e.slice(1);return e},getOptionsCollection:function(){if(this.options)return this.options;var e={changeEvents:["labelChange","valueChange","disabledChange","visibleChange","selectedChange"],requirements:["Amm.Trait.Select.Option"],indexProperty:"index",observeIndexProperty:true,cleanupOnDissociate:true,sorter:this._sorter};this.options=new Amm.Collection(e);if(this._cleanupList)this._cleanupList.push(this.options);this.getSelectionCollection();this.options.subscribe("itemsChange",this._handleOptionsChange,this);return this.options},outOptionsCollectionChange:function(){},getSelectionCollection:function(){if(this._selectionCollection)return this._selectionCollection;var e={multiple:this._multiple,valueProperty:"value",selectedProperty:"selected"};this._selectionCollection=new Amm.Selection(e);this._selectionCollection.setCollection(this.getOptionsCollection());this._selectionCollection.subscribe("valueChange",this._handleSelfSelectionValueChange,this);this._selectionCollection.setValue(this._value);if(this._cleanupList)this._cleanupList.push(this._selectionCollection);return this._selectionCollection},setSelectSize:function(e){if(e!==undefined){e=parseInt(e)||1;if(e<0)e=1}var t=this._selectSize;if(t===e)return;this._selectSize=e;if(e===1&&!this._multiple&&(this._value===null||this._value===undefined)){if(this.options&&this.options.length){this._correctValueForSingleSelect()}}this.outSelectSizeChange(e,t);return true},getSelectSize:function(){return this._selectSize},outSelectSizeChange:function(e,t){this._out("selectSizeChange",e,t)},_handleSelfSelectionValueChange:function(e,t){if(e===undefined)e=null;if(!Amm.Trait.Select.valuesAreSame(e,this._value)){var i=this._value;this._value=e;if(!this._multiple&&this._value===null&&this._selectSize===1){if(this._correctValueForSingleSelect())return}this._numChanges++;this.outValueChange(e,i)}},_handleOptionsChange:function(e,t){if(!t.length&&e.length&&this._selectSize===1&&this._value===undefined){this._correctValueForSingleSelect()}},_correctValueForSingleSelect:function(){if(this._selectionCollection&&this._selectionCollection.getUpdateLevel()){return}var e=this.getOptionsCollection();for(var t=0,i=e.length;t<i;t++){var r=e[t];if(!r.getDisabled()&&r.getVisible()){this.setValue(r.getValue());return true}}},setMultiple:function(e){e=!!e;var t=this._multiple;if(t===e)return;this._multiple=e;this._updateDummyOption();if(this._selectionCollection)this._selectionCollection.setMultiple(e);this.outMultipleChange(e,t);return true},getMultiple:function(){return this._multiple},outMultipleChange:function(e,t){this._out("multipleChange",e,t)},setObjects:function(e){if(!e){this._detachObjects();return}if(!(e instanceof Array||Amm.is(e,"Amm.Array")))throw new Error("objects must be FALSEable, Array or Amm.Array; provided: "+Amm.describeType(e));if(!this._objectsMapper){this._objectsMapper=this._createObjectsMapper(e)}},getObjects:function(){if(!this._objectsMapper)return null;return this._objectsMapper.getSrc()},getObjectsItems:function(){if(!this._objectsMapper)return[];return this._objectsMapper.getSrc().getItems()},_detachObjects:function(e){if(!this._objectsMapper)return;this._objectsMapper.setSrc([]);this._objectsMapper.cleanup();for(var t=0,i=this._cleanupList.length;t<i;t++){if(this._cleanupList[t]===this._objectsMapper){this._cleanupList[t].splice(t,1);break}}this._objectsMapper=null},outObjectsChange:function(e,t){},setValue:function(e){var t=this._numChanges;this.getSelectionCollection().setValue(e);if(this._numChanges!==t)return true},setLabelProperty:function(e){var t=this._labelProperty;if(t===e)return;this._labelProperty=e;this.outLabelPropertyChange(e,t);this._updateInstantiator();return true},getLabelProperty:function(){return this._labelProperty},outLabelPropertyChange:function(e,t){this._out("labelPropertyChange",e,t)},setValueProperty:function(e){var t=this._valueProperty;if(t===e)return;this._valueProperty=e;this.outValuePropertyChange(e,t);this._updateInstantiator();return true},getValueProperty:function(){return this._valueProperty},setDisabledProperty:function(e){var t=this._disabledProperty;if(t===e)return;this._disabledProperty=e;this.outDisabledPropertyChange(e,t);this._updateInstantiator();return true},getDisabledProperty:function(){return this._disabledProperty},outDisabledPropertyChange:function(e,t){this._out("disabledPropertyChange",e,t)},_objectPropToExp:function(e){if(e.match(/^\w+$/))return"this.origin."+e;return e},_updateInstantiator:function(){if(!this._objectsMapper)return;var e=Amm.getProperty(this._selectionCollection.getItems(),"origin");this._selectionCollection.beginUpdate();this._objectsMapper.setInstantiator(this._createInstantiator());if(e.length){var t=[];for(var i=0,r=this.options.length;i<r;i++){if(Amm.Array.indexOf(this.options[i].getOrigin(),e)<0)continue;t.push(this.options[i])}this._selectionCollection.setItems(t)}this._selectionCollection.endUpdate()},_createInstantiator:function(){var e={class:"Amm.Trait.Select.Option"};if(this._labelProperty){e["in__label"]=this._objectPropToExp(this._labelProperty)}if(this._disabledProperty){e["in__disabled"]=this._objectPropToExp(this._disabledProperty)}if(this._valueProperty){e["in__value"]=this._objectPropToExp(this._valueProperty)}else{e["in__value"]="this.origin"}e["component"]=this.getClosestComponent();if(this._optionPrototype){e=Amm.overrideRecursive(e,this._optionPrototype)}return new Amm.Instantiator.Proto(e,"origin")},_createObjectsMapper:function(e){var t={instantiator:this._createInstantiator(),dest:this.getOptionsCollection()};var i=new Amm.ArrayMapper(t);i.beginUpdate();i.setSrc(e);this._updateDummyOption(i);i.endUpdate();return i},outValuePropertyChange:function(e,t){this._out("valuePropertyChange",e,t)},_cleanup_AmmTraitSelect:function(){this._detachObjects()},setDummyLabel:function(e){var t=this._dummyLabel;if(t===e)return;this._dummyLabel=e;this._updateDummyOption();this.outDummyLabelChange(e,t);return true},getDummyLabel:function(){return this._dummyLabel},outDummyLabelChange:function(e,t){this._out("dummyLabelChange",e,t)},setDummyValue:function(e){var t=this._dummyValue;if(t===e)return;this._dummyValue=e;this._updateDummyOption();this.outDummyValueChange(e,t);return true},getDummyValue:function(){return this._dummyValue},outDummyValueChange:function(e,t){this._out("dummyValueChange",e,t)},setOptionPrototype:function(e){if(!e)e=null;if(typeof e==="string"){e={class:e}}else if(typeof e!=="object"){throw Error("optionProtoype must be null, a string or an object")}var t=this._optionPrototype;if(t===e)return;this._optionPrototype=e;this.outOptionPrototypeChange(e,t);this._updateInstantiator();return true},getOptionPrototype:function(){return this._optionPrototype},outOptionPrototypeChange:function(e,t){this._out("optionPrototypeChange",e,t)},_setClosestComponent_ammTraitSelect:function(e){var t=this.getOptionsCollection();Amm.setProperty(t.getItems(),"component",e)},setSorter:function(e){if(this.options)return this.options.setSorter(e);this._sorter=e},getSorter:function(){if(this.options)return this.options.getSorter();else return this._sorter}};Amm.extend(Amm.Trait.Select,Amm.Trait.Input);Amm.Trait.Select.Option=function(e){Amm.Element.call(this,e)};Amm.Trait.Select.Option.prototype={"Amm.Trait.Select.Option":"__CLASS__",_value:null,_label:null,_disabled:false,_selected:false,_index:null,_origin:null,_visible:true,setValue:function(e){var t=this._value;if(t===e)return;this._value=e;this.outValueChange(e,t);return true},getValue:function(){return this._value},outValueChange:function(e,t){this._out("valueChange",e,t)},setLabel:function(e){var t=this._label;if(t===e)return;this._label=e;this.outLabelChange(e,t);return true},getLabel:function(){return this._label},outLabelChange:function(e,t){this._out("labelChange",e,t)},setDisabled:function(e){e=!!e;var t=this._disabled;if(t===e)return;this._disabled=e;this.outDisabledChange(e,t);if(this._disabled&&this._selected)this.setSelected(false);return true},getDisabled:function(){return this._disabled},outDisabledChange:function(e,t){this._out("disabledChange",e,t)},setSelected:function(e){e=!!e;if(this._disabled||!this._visible)e=false;var t=this._selected;if(t===e)return;this._selected=e;this.outSelectedChange(e,t);return true},getSelected:function(){return this._selected},outSelectedChange:function(e,t){this._out("selectedChange",e,t)},setIndex:function(e){var t=this._index;if(t===e)return;this._index=e;this.outIndexChange(e,t);return true},getIndex:function(){return this._index},outIndexChange:function(e,t){this._out("indexChange",e,t)},setOrigin:function(e){var t=this._origin;if(t===e)return;this._origin=e;this.outOriginChange(e,t);return true},getOrigin:function(){return this._origin},outOriginChange:function(e,t){this._out("originChange",e,t)},setVisible:function(e){e=!!e;var t=this._visible;if(t===e)return;this._visible=e;if(!this._visible&&this._selected)this.setSelected(false);this.outVisibleChange(e,t);return true},getVisible:function(){return this._visible},outVisibleChange:function(e,t){this._out("visibleChange",e,t)}};Amm.extend(Amm.Trait.Select.Option,Amm.Element);Amm.Trait.DisplayParent=function(){};Amm.Trait.DisplayParent.prototype={DisplayParent:"__INTERFACE__",displayChildren:null,_displayChildrenPrototype:null,_passDisplayChildrenToComponent:true,_displayChildrenObservedForComponent:false,__augment:function(e,t){var i={requirements:["Visual"],assocInstance:this,assocProperty:"displayParent",indexProperty:"displayOrder",observeIndexProperty:true,assocEvents:{cleanup:"_handleDisplayChildCleanup"}};if(this._displayChildrenPrototype){Amm.overrideRecursive(i,this._displayChildrenPrototype)}this.displayChildren=new Amm.Collection(i);Amm.Element.regInit(this,"99_DisplayParent_observe",this._observeDisplayChildrenForComponent)},setDisplayChildrenPrototype:function(e){if(!e)e=null;else if(typeof e!=="object"){Error("`displayChildrenPrototype` must be a nullable or an object")}var t=this._displayChildrenPrototype;if(t===e)return;this._displayChildrenPrototype=e;if(this.displayChildren&&this._displayChildrenPrototype){Amm.init(this.displayChildren,this._displayChildrenPrototype)}return true},getDisplayChildrenPrototype:function(){return this._displayChildrenPrototype},getDisplayChildren:function(){return this.displayChildren},setDisplayChildren:function(e){return this.displayChildren.setItems(e)},_observeDisplayChildrenForComponent:function(e){var t=e===undefined?!!(this._closestComponent&&this._passDisplayChildrenToComponent):!!e,i=!!this._displayChildrenObservedForComponent;if(t===i)return;if(t){this.displayChildren.subscribe("spliceItems",this._passDisplayChildrenOnSplice,this)}else{this.displayChildren.unsubscribe("spliceItems",this._passDisplayChildrenOnSplice,this)}this._displayChildrenObservedForComponent=!!t},_passDisplayChildrenOnSplice:function(e,t,i){if(!this._passDisplayChildrenToComponent||!this._closestComponent)return;var r=Amm.Array.symmetricDiff(t,i);var n=Amm.Array.symmetricDiff(i,t);if(r)this._closestComponent.rejectElements(r);if(n){this._closestComponent.acceptElements(n)}},setPassDisplayChildrenToComponent:function(e){e=!!e;var t=this._passDisplayChildrenToComponent;if(t===e)return;this._passDisplayChildrenToComponent=e;if(this._closestComponent){var i=[];i=i.concat(this.displayChildren.getItems());if(this._passDisplayChildrenToComponent){this._closestComponent.acceptElements(i)}else{this._closestComponent.rejectElements(i)}}this._observeDisplayChildrenForComponent();this.outPassDisplayChildrenToComponentChange(e,t);return true},getPassDisplayChildrenToComponent:function(){return this._passDisplayChildrenToComponent},outPassDisplayChildrenToComponentChange:function(e,t){this._out("passDisplayChildrenToComponentChange",e,t)},_findChildElements_DisplayParent:function(e){if(this._passDisplayChildrenToComponent){e.push.apply(e,this.displayChildren.getItems())}},_setClosestComponent_DisplayParent:function(e,t){if(this._passDisplayChildrenToComponent){Amm.Trait.Component.changeComponent(this.displayChildren,e,t)}this._observeDisplayChildrenForComponent()},_cleanup_DisplayParent:function(){this.displayChildren.cleanup()},_handleDisplayChildCleanup:function(e){if(e.getDisplayParent()===this){var t=this.displayChildren.getAllowDelete();var i=this.displayChildren.getAllowChangeOrder();this.displayChildren.setAllowDelete(true);this.displayChildren.setAllowChangeOrder(true);this.displayChildren.reject(e);this.displayChildren.setAllowDelete(t);this.displayChildren.setAllowChangeOrder(i)}}};Amm.Trait.Annotated=function(){this._defaultAnnotations=["label","description","required","error"]};Amm.Trait.Annotated.annotationElementDefaults={BASE:{traits:["Amm.Trait.Content","Amm.Trait.Visual"]},required:{contentTranslator:{class:"Amm.Translator.RequiredMark"}},error:{contentTranslator:{class:"Amm.Translator.Errors"}}};Amm.Trait.Annotated.mergePrototypes=function(e,t,i,r){var n,s;if(e&&t&&t in e)n=e[t];if(t){if(e&&t in e)n=e[t]}else{n=e}if(r){if(i&&r in i)s=i[r]}else{s=i}if(s===null)return null;if(!s)return n;if(!n)return s;if(typeof s!=="object"||typeof n!=="object")return s;return Amm.override({},n,s)};Amm.Trait.Annotated.prototype={Annotated:"__INTERFACE__",_defaultAnnotations:null,_label:undefined,_description:undefined,_required:undefined,_error:undefined,annotationElementDefaults:null,_annotationsContainer:undefined,_annotatedIdChange:function(e,t){if(""+e)this._annotationsContainer.setId(e+"Annotations")},getAnnotationsContainer:function(){if(this._annotationsContainer===undefined){var e=!this["Amm.Element.Composite"],t="annotations";if(e&&""+this._id){t=this._id+"Annotations"}else{t="annotations"}this._annotationsContainer=new Amm.Trait.Annotated.Container({id:t,parent:e?this._parent:this,element:this});if(e)this.subscribe("idChange",this._annotatedIdChange,this);this._assignDefaultAnnotations()}return this._annotationsContainer},getAnnotationElementPrototype:function(e){var t=Amm.Trait.Annotated.annotationElementDefaults,i=this.annotationElementDefaults;var r=Amm.Trait.Annotated.mergePrototypes(t,"BASE",i,"BASE");var n=Amm.Trait.Annotated.mergePrototypes(t,e,i,e);var s=Amm.Trait.Annotated.mergePrototypes(r,null,n,null);return Amm.override({},s)},_assignDefaultAnnotations:function(){if(this._defaultAnnotations instanceof Array){for(var e=0,t=this._defaultAnnotations.length;e<t;e++){var i=this._defaultAnnotations[e];var r=Amm.getProperty(this,i,undefined);if(r!==undefined){this.getAnnotationsContainer().getAnnotationElement(i).setContent(r)}else{var n=this.getAnnotationsContainer().getAnnotationElement(i).getContent();if(n!==undefined)Amm.setProperty(this,i,n)}}}},setLabel:function(e){var t=this._label;if(t===e)return;this._label=e;this.outLabelChange(e,t);return true},getLabel:function(){return this._label},outLabelChange:function(e,t){this._out("labelChange",e,t)},setDescription:function(e){var t=this._description;if(t===e)return;this._description=e;this.outDescriptionChange(e,t);return true},getDescription:function(){return this._description},outDescriptionChange:function(e,t){this._out("descriptionChange",e,t)},setRequired:function(e){var t=this._required;if(t===e)return;this._required=e;this.outRequiredChange(e,t);return true},getRequired:function(){return this._required},outRequiredChange:function(e,t){this._out("requiredChange",e,t)},setError:function(e){var t=this._error;if(t===e)return;this._error=e;this.outErrorChange(e,t);return true},getError:function(){return this._error},outErrorChange:function(e,t){this._out("errorChange",e,t)},listAnnotations:function(){return this.getAnnotationsContainer().listChildren()},hasAnnotation:function(e){return!!this.getAnnotationsContainer().getAnnotationElement(e,true)},getAnnotationValue:function(e){if(e){var t=this.getAnnotationsContainer().getAnnotationElement(e,true);if(t)return t.getContent();return undefined}var i=this.listAnnotations(),r=this.getAnnotationsContainer();var n={};for(var s=0,o=i.length;s<o;s++){var e=i[s];var a=r.getAnnotationElement(e,true);if(a)n[e]=a.getContent()}return n},setAnnotationValue:function(e,t){return this.getAnnotationsContainer().getAnnotationElement(t).setContent(e)}};Amm.Trait.Instantiator=function(){};Amm.Trait.Instantiator.prototype={Instantiator:"__INTERFACE__",InstantiatorOrRepeater:"__INTERFACE__",__augment:function(e,t){Amm.Element.regInit(this,"99.Amm.Trait.Instantiator",function(){if(this["DisplayParent"]!=="__INTERFACE__")throw Error("Instantiator must be also a DisplayParent")});if(t&&t.initialInstantiatorOptions){this._reportedInstantiatorOptions=t.initialInstantiatorOptions;delete t.initialInstantiatorOptions}},_instantiator:null,_src:null,_dest:null,_instantiatorOptions:null,_reportedInstantiatorOptions:null,_construct:function(){if(!this._instantiator||!this._src)return;var e=this._instantiator.construct(this._src);this.setDest(e)},_destruct:function(){if(!this._dest)return;this._dest.setDisplayParent(null);if(this._instantiator){this._instantiator.destruct(this._dest)}this._dest=null},setInstantiator:function(e){if(!e)e=null;else e=Amm.constructInstance(e,"Amm.Instantiator");var t=this._instantiator;if(t===e)return;if(t&&t["Amm.WithEvents"])t.unsubscribe("needRebuild",this._handleInstantiatorNeedRebuild,this);this._instantiator=e;if(e&&e["Amm.WithEvents"]&&e.hasEvent("needRebuild")){e.subscribe("needRebuild",this._handleInstantiatorNeedRebuild,this)}this._reportedInstantiatorOptions=null;this._destruct();this.outInstantiatorChange(e,t);this._construct();return true},getInstantiator:function(){return this._instantiator},outInstantiatorChange:function(e,t){this._out("instantiatorChange",e,t)},setSrc:function(e){var t=this._src;if(t===e)return;this._src=e;this._construct();this.outSrcChange(e,t);return true},getSrc:function(){return this._src},outSrcChange:function(e,t){this._out("srcChange",e,t)},setDest:function(e){var t=this._dest;if(t===e)return;if(e)Amm.is(e,"Visual","dest");this._destruct();this._dest=e;if(this._dest)this._dest.setDisplayParent(this);this.outDestChange(e,t);return true},getDest:function(){return this._dest},outDestChange:function(e,t){this._out("destChange",e,t)},_handleInstantiatorNeedRebuild:function(e,t,i){if(!this._src||i!==this._instantiator)return;if(Amm.Array.indexOf(this._src,e)<0)return;this._construct()},_cleanup_Instantiator:function(){this.setInstantiator(null);this.setSrc(null)},setInstantiatorOptions:function(e){if(!e)e=null;var t=this._instantiatorOptions;if(t===e)return;this._instantiatorOptions=e;if(this._reportedInstantiatorOptions){this.reportInstantiatorOptions.apply(this,this._reportedInstantiatorOptions)}return true},getInstantiatorOptions:function(){return this._instantiatorOptions},reportInstantiatorOptions:function(e,t,i){this._reportedInstantiatorOptions=[e,t,i];var r;if(t&&t.length){r={class:Amm.Instantiator.Variants,defaultPrototype:e,filter:{conditions:t},prototypes:i,allowNullInstance:true}}else{r={class:Amm.Instantiator.Proto,proto:e}}if(this._instantiatorOptions){r=Amm.overrideRecursive(r,this._instantiatorOptions)}this.setInstantiator(Amm.constructInstance(r,Amm.Instantiator.Abstract))}};Amm.Trait.Annotated.Container=function(e){this._requireInterfaces("Annotated");Amm.augment(this,Amm.Trait.Composite);Amm.ElementBound.call(this);Amm.Element.call(this,e)};Amm.Trait.Annotated.Container.prototype={"Amm.Trait.Annotated.Container":"__CLASS__",_cleanupChildren:true,_cleanupWithParent:true,setElement:function(e){if(this._element!==null&&this._element!==e)Error("can setElement() only once in Amm.Trait.Annotated.Container");return Amm.ElementBound.prototype.setElement.call(this,e)},_passAnnotatedContentChange:function(e,t){if(this._element)Amm.setProperty(this._element,Amm.event.origin.getId(),e)},createAnnotationElement:function(e){var t=this._element.getAnnotationElementPrototype(e);t.id=e;t.parent=this;var i=new Amm.Element(t);var r={};if(Amm.detectProperty(this._element,e,r)){i.subscribe("contentChange",this._passAnnotatedContentChange,this);var n=this._element[r.getterName](),s=i.getContent();if(n!==undefined)i.setContent(n);else if(n===undefined&&s!==undefined){this._element[r.setterName](s)}this._element.subscribe(r.eventName,i.setContent,i)}return i},getAnnotationElement:function(e,t){if(this.hasChild(e)||t)return this.getChild(e);return this.createAnnotationElement(e)}};Amm.extend(Amm.Trait.Annotated.Container,Amm.Element);Amm.extend(Amm.Trait.Annotated.Container,Amm.ElementBound);Amm.Trait.Component=function(){this._namedElements={};this._elements=[];this._components=[];this.e={}};Amm.Trait.Component.changeComponent=function(e,t,i){var r=[];if(i!==undefined){for(var n=0,s=e.length;n<s;n++){if(e[n].getComponent()===i){r.push(e[n])}}}else{r=e}if(t){t.acceptElements(r)}else{for(var n=0,s=r.length;n<s;n++){r[n].setComponent(t)}}};Amm.Trait.Component.prototype={Component:"__INTERFACE__",_internalId:"component",_isComponent:true,_namedElements:null,_elements:null,e:null,_components:null,setInternalId:function(e){var t=this._internalId;if(t===e)return;this._internalId=e;this.outInternalIdChange(e,t);this.outRenamedElement(this,e,t);this.outRenamedInScope(this,this,e,t);return true},getInternalId:function(){return this._internalId},outInternalIdChange:function(e,t){this._out("internalIdChange",e,t)},getClosestComponent:function(){return this._isComponent?this:this._component},__augment:function(){Amm.Element.regInit(this,"95_Component_setClosestComponent",this._setClosestComponent)},setIsComponent:function(e){e=!!e;var t=this._isComponent;if(t===e)return;this._isComponent=e;this._setClosestComponent();this._callOwnMethods("_setIsComponent_");if(e){var i=this.findChildElements();if(i.length)this.acceptElements(i)}else{if(this._component)this._component.acceptElements(this.getElements());else this.rejectElements(this.getElements())}this.outIsComponentChange(e,t);return true},getIsComponent:function(){return this._isComponent},outIsComponentChange:function(e,t){this._out("isComponentChange",e,t)},_extractNameEventFromMethodName:function(e){var t="handle__";if(e.indexOf(t)!==0)return;var i=e.slice(t.length).split("__");var r,n;if(i.length===1){r="";n=i[0]}else{r=i[0];n=i.slice(1).join("__")}return[r,n]},_listHandlersForElements:function(){var e={};var t;for(var i in this)if(typeof this[i]==="function"){var t=this._extractNameEventFromMethodName(i);if(!t)continue;if(!e[t[0]])e[t[0]]=[];e[t[0]].push([t[1],i])}return e},_subscribeElement:function(e,t,i,r){var n=e.getId();if((!n||!n.length)&&t)return;var i=i||this._listHandlersForElements();var s=[];if(!t&&i[""])s=i[""];if(i[n])s=s.concat(i[n]);for(var o=0,a=s.length;o<a;o++){if(e.hasEvent(s[o][0])){if(r&&e.getSubscribers(s[o][0],s[o][1],this).length)continue;e.subscribe(s[o][0],s[o][1],this)}}},_unsubscribeElement:function(e,t){var i=e.getSubscribers(undefined,undefined,this);for(var r=0,n=i.length;r<n;r++){var s=i[r],o;if(typeof s[0]!=="string")continue;o=this._extractNameEventFromMethodName(s[0]);if(!o)continue;if(!t||o[0])e.unsubscribe(s[4],s[0],this)}},resubscribeAllElements:function(){var e=this._listHandlersForElements();for(var t=0,i=this._elements.length;t<i;t++){this._subscribeElement(this._elements[t],false,e,true)}},handle__componentChange:function(e,t){var i=Amm.event.origin;if(e===this)this.acceptElements([i]);else if(t===this)this.rejectElements([i])},handle__idChange:function(e,t){var i=Amm.event.origin;if(t){this._deleteNamedElementEntry(i,t);this._unsubscribeElement(i,true)}if(e){if(!this._namedElements[e]){this._namedElements[e]=[]}this._namedElements[e].push(i);if(this._namedElements[e].length===1){this.e[e]=i}else{this.e[e]=this._namedElements[e]}this._subscribeElement(i,true,undefined)}this.outRenamedElement(i,e,t);this.outRenamedInScope(this,i,e,t)},handle__isComponentChange:function(e,t){var i=Amm.event.origin;if(e)this._registerComponent(i);else this._unregisterComponent(i);this.outChildComponentStatusChange(i,e);this.outChildComponentStatusChangeInScope(this,i,e)},outRenamedElement:function(e,t,i){this._out("renamedElement",e,t,i)},handle__cleanup:function(){var e=Amm.event.origin;this.rejectElements([e])},g:function(e,t,i){return this.getNamedElement(e,t,i)},getNamedElement:function(e,t,i){if(!t||t<0)t=0;if(this._internalId&&e===this._internalId&&!t)return this;var r;if(this._namedElements[e]){r=this._namedElements[e][t]}if(!r&&i){var n=this.getAllNamedElements(e,i);if(n&&n[t])r=n[t]}return r},getAllNamedElements:function(e,t){var i;if(e){i=[];if(this._internalId&&e===this._internalId){i.push(this)}if(this._namedElements[e]){i=i.concat(this._namedElements[e])}if(t&&this._component){var r=this._component.getAllNamedElements(e,t);if(this._internalId===e){for(var n=0,s=r.length;n<s;n++){if(r[n]===this){r.splice(n,1);break}}}i=i.concat(r)}return i}i={};if(this._internalId)i[this._internalId]=[this];for(var n in this._namedElements){if(this._namedElements.hasOwnProperty(n)){i[n]=(i[n]||[]).concat(this._namedElements[n])}}if(t&&this._component){var r=this._component.getAllNamedElements(undefined,t);var o=this._id;if(o&&r[o]){for(var a=0,s=r[o].length;a<s;a++)if(r[o][a]===this){r[n].splice(a,1);if(!r[n].length)delete r[n];break}}for(var n in r)if(r.hasOwnProperty(n)){i[n]=(this._namedElements[n]||[]).concat(r[n])}}return i},_includeAllChildren:function(e){var t=[].concat(e);for(var i=0,r=e.length;i<r;i++){if(!e[i]["Component"]||!e[i].getIsComponent()){var n=this._includeAllChildren(e[i].findChildElements());t=t.concat(n)}}return t},acceptElements:function(e){var t=this._includeAllChildren(e),i=[];t=Amm.Array.diff(t,this._elements);if(!t.length)return;this._elements.push.apply(this._elements,t);var r=this._listHandlersForElements();for(var n=0,s=t.length;n<s;n++){this._subscribeElement(t[n],false,r);var o=t[n].getId();if(o){if(!this._namedElements[o]){this._namedElements[o]=[]}this._namedElements[o].push(t[n]);if(this._namedElements[o].length===1){this.e[o]=this._namedElements[o][0]}else{this.e[o]=this._namedElements[o]}}if(t[n].Component==="__INTERFACE__"&&t[n].getIsComponent()){this._registerComponent(t[n])}t[n].setComponent(this);i.push(t[n])}if(i.length){this.outAcceptedElements(i);this.outAcceptedInScope(this,i)}return i},_registerComponent:function(e){this._components.push(e)},outAcceptedElements:function(e){return this._out("acceptedElements",e)},_deleteNamedElementEntry:function(e,t){if(!t)t=e.getId();if(!t)t=e.getId();if(!this._namedElements[t])return;var i=Amm.Array.indexOf(e,this._namedElements[t]);if(i>=0){this._namedElements[t].splice(i,1);if(this._namedElements[t].length===1){this.e[t]=this._namedElements[t][0]}else if(!this._namedElements[t].length){delete this._namedElements[t];delete this.e[t]}return true}},rejectElements:function(e){var t=[];var i=this._includeAllChildren(e),r=this._elements.length;var n=Amm.Array.findDuplicates(this._elements.concat(i),false,null,r,true);for(var s=n.length-1;s>=0;s--){if(n[s][0]>=r)continue;var o=this._elements[n[s][0]],a=o.getId();if(a)this._deleteNamedElementEntry(o,a);this._elements.splice(n[s][0],1);this._unsubscribeElement(o);if(o.getComponent()===this){o.setComponent(null)}if(i[s].Component==="__INTERFACE__"&&i[s].getIsComponent()){this._unregisterComponent(i[s])}t.unshift(o)}if(t.length){this.outRejectedElements(t);this.outRejectedInScope(this,t)}return t},_unregisterComponent:function(e){for(var t=0,i=this._components.length;t<i;t++){if(this._components[t]===e){this._components.splice(t,1);break}}},outRejectedElements:function(e){return this._out("rejectedElements",e)},getElements:function(){return[].concat(this._elements)},_listCall:function(e,t,i){var r=[];for(var n=0,s=e.length;n<s;n++){var o=e[n];if(typeof t==="function")r.push([o,t.apply(o,i)]);else if(typeof o[t]==="function")r.push([o,o[t].apply(o,i)])}return r},callElements:function(e,t){return this._listCall(this._elements,e,Array.prototype.slice.call(arguments,1))},callComponents:function(e,t){return this._listCall(this._components,e,Array.prototype.slice.call(arguments,1))},_cleanup_Component:function(){this._namedElements={};this.e={};var e=this._elements;this._elements=[];for(var t=0,i=e.length;t<i;t++){this._unsubscribeElement(e[t]);e[t].setComponent(null);if(e[t].getCleanupWithComponent()){e[t].cleanup()}}},outAcceptedInScope:function(e,t){var i=this._out("acceptedInScope",e,t);this.callComponents("outAcceptedInScope",e,t);return i},outRejectedInScope:function(e,t){var i=this._out("rejectedInScope",e,t);this.callComponents("outRejectedInScope",e,t);return i},outRenamedInScope:function(e,t,i,r){var n=this._out("renamedInScope",e,t,i,r);this.callComponents("outRenamedInScope",e,t,i,r);return n},outChildComponentStatusChange:function(e,t){return this._out("childComponentStatusChange",e,t)},outChildComponentStatusChangeInScope:function(e,t,i){var r=this._out("childComponentStatusChangeInScope",e,t,i);this.callComponents("outChildComponentStatusChangeInScope",e,t,i);return r},_setComponent_Component:function(e){this.outComponentStackChange()},outComponentStackChange:function(){this.callComponents("outComponentStackChange");this._out("componentStackChange")}};Amm.Trait.Composite=function(){this._children={}};Amm.Trait.Composite.prototype={Composite:"__INTERFACE__",_requiredChildClass:"Amm.Element",_children:null,_cleanupChildren:false,_passChildrenToComponent:true,_autoId:function(e){if(!e._amm_id)Amm.registerItem(e);return(Amm.getClass(e)||"__auto__")+e._amm_id},addChild:function(e){if(!e||typeof e!=="object")Error("`child` must be a non-null object");if(this._requiredChildClass)Amm.is(e,this._requiredChildClass,"child");var t=e.getId();if(!t){t=this._autoId(e);if(!t)Error("`child` doesn't have Id, cannot auto-assign");e.setId(t)}if(this.hasChild(e))return;if(this._children[t]){if(this._children[t]!==e)Error("Parent already has child with id '"+t+"'");else Error("Assertion: hasChild() returned FALSE, but the instance is there!")}e.setParent(this);this._children[t]=e;this._subscribeChild(e);if(this._passChildrenToComponent&&this._closestComponent){this._closestComponent.acceptElements([e])}this.outChildAdded(e);return true},removeChild:function(e){var t=this.hasChild(e),i=e.getParent()===this;if(t){delete this._children[e.getId()];this._unsubscribeChild(e)}if(i){e.setParent(null);if(this._passChildrenToComponent&&this._closestComponent&&e.getComponent()===this._closestComponent){e.setComponent(null)}}this.outChildRemoved(e)},outChildAdded:function(e){this._out("childAdded",e)},outChildRemoved:function(e){this._out("childRemoved",e)},outChildRenamed:function(e,t,i){this._out("childRenamed",e,t,i)},_subscribeChild:function(e){e.subscribe("idChange",this._childIdChange,this)},_unsubscribeChild:function(e){e.unsubscribe("idChange",undefined,this)},_childIdChange:function(e,t){var i=Amm.event.origin;if(this._children[e]&&this._children[e]!==i)Error("Cannot handle _childIdChange to id that is already busy ('"+e+"')");if(this._children[t]===i){delete this._children[t]}else{console.warn("Wtf: childIdChange notification received, but child not found with child id")}this._children[e]=i;this.outChildRenamed(i,e,t)},hasChild:function(e){var t=false,i;if(typeof e!=="object"){i=e;t=!!this._children[i]}else if(e&&typeof e==="object"&&typeof e.getId==="function"){i=e.getId();t=this._children[i]===e}return t},listChildren:function(){if(Object.getOwnPropertyNames)return Object.getOwnPropertyNames(this._children);var e=[];for(var t in this._children){if(this._children.hasOwnProperty(t))e.push(t)}return e},getChild:function(e){return this._children[e]},getChildren:function(){var e=[];for(var t in this._children){if(this._children.hasOwnProperty(t)){e.push(this._children[t])}}return e},setCleanupChildren:function(e){var t=this._cleanupChildren;if(t===e)return;this._cleanupChildren=e;return true},getCleanupChildren:function(){return this._cleanupChildren},setPassChildrenToComponent:function(e){e=!!e;var t=this._passChildrenToComponent;if(t===e)return;this._passChildrenToComponent=e;if(this._closestComponent){if(!this._passChildrenToComponent){Amm.Trait.Component.changeComponent(this.getChildren(),null,this._closestComponent)}else{Amm.Trait.Component.changeComponent(this.getChildren(),this._closestComponent,null)}}this.outPassChildrenToComponentChange(e,t);return true},getPassChildrenToComponent:function(){return this._passChildrenToComponent},outPassChildrenToComponentChange:function(e,t){this._out("passChildrenToComponentChange",e,t)},_findChildElements_Composite:function(e){if(this._passChildrenToComponent){e.push.apply(e,this.getChildren())}},_setClosestComponent_Composite:function(e,t){if(this._passChildrenToComponent){Amm.Trait.Component.changeComponent(this.getChildren(),e,t)}}};Amm.Trait.Field=function(){this._validators=[]};Amm.Trait.Field.VALIDATE_NEVER=0;Amm.Trait.Field.VALIDATE_BLUR=1;Amm.Trait.Field.VALIDATE_CHANGE=2;Amm.Trait.Field.VALIDATE_BLUR_CHANGE=3;Amm.Trait.Field.VALIDATE_EXPRESSIONS=4;Amm.Trait.Field.VALIDATE_INSTANT=8;Amm.Trait.Field.TRANSLATION_ERROR_IN=1;Amm.Trait.Field.TRANSLATION_ERROR_OUT=-1;Amm.Trait.Field.prototype={Field:"__INTERFACE__",_form:null,_fieldName:undefined,_fieldLabel:undefined,_validators:null,_validateMode:Amm.Trait.Field.VALIDATE_CHANGE|Amm.Trait.Field.VALIDATE_EXPRESSIONS,_fieldErrors:undefined,_needValidate:false,_fieldApplied:true,_fieldRequired:undefined,fieldRequiredMessage:"lang.Amm.Validator.Required.msg",_fieldRequiredValidator:null,_fieldEmpty:undefined,_fieldValue:undefined,_fieldSyncsValue:false,_lockFieldValueChange:0,_lockAnnotationSync:0,_fieldTranslator:null,_translationErrorState:null,_fieldSyncWithAnnotations:true,_fieldInSyncWithAnnotations:false,_initValidationExpressions:null,_validationExpressions:null,_fieldIndex:undefined,__augment:function(e,t){Amm.Element.regInit(this,"99.Amm.Trait.Field",function(){if(this._fieldName===undefined){this.subscribe("idChange",this._handleFormElementIdChange,this)}this._fieldSyncsValue=!!Amm.detectProperty(this,"value");if(this._fieldSyncsValue)this.subscribe("valueChange",this._handleFormExtValueChange,this);if(Amm.detectProperty(this,"focused")){this.subscribe("focusedChange",this._handleFieldFocusedChange,this)}if(this["Annotated"]==="__INTERFACE__"&&this._fieldSyncWithAnnotations){this._syncWithAnnotations()}if(this._fieldSyncsValue){if(this._fieldValue===undefined){var e=this.getValue();if(e!==undefined){this._handleFormExtValueChange(e,undefined)}}else{this._syncFieldValueToElement(this._fieldValue)}}})},_syncWithAnnotations:function(){if(!this._fieldInSyncWithAnnotations){this.subscribe("requiredChange",this._handleSelfAnnotationRequiredChange,this);this.subscribe("labelChange",this._handleSelfAnnotationLabelChange,this);this.subscribe("errorChange",this._handleSelfAnnotationErrorChange,this);this._fieldInSyncWithAnnotations=true}if(this._fieldRequired!==undefined)this.setRequired(this._fieldRequired);else if(this._required!==undefined)this.setFieldRequired(this._required);if(this._fieldLabel!==undefined)this.setLabel(this._fieldLabel);else if(this._label!==undefined)this.setFieldLabel(this._label);if(this._fieldErrors!==undefined)this.setError(this._fieldErrors);else if(this._error!==undefined)this.setFieldErrors(this._error)},getFieldSyncsValue:function(){return this._fieldSyncsValue},_handleSelfAnnotationRequiredChange:function(e,t){if(this._lockAnnotationSync)return;if(this._fieldInSyncWithAnnotations&&this._fieldRequired===undefined)this.setFieldRequired(e)},_handleSelfAnnotationLabelChange:function(e,t){if(this._lockAnnotationSync)return;if(this._fieldInSyncWithAnnotations&&this._fieldLabel===undefined){this.setFieldLabel(e)}},_handleSelfAnnotationErrorChange:function(e,t){if(this._lockAnnotationSync)return;if(this._fieldInSyncWithAnnotations&&this._fieldErrors===undefined){this.setFieldErrors(e)}},setForm:function(e){if(e)Amm.is(e,"Form","form");else e=null;var t=this._form;if(t===e)return;if(t){var i=t.fields.strictIndexOf(this);if(i>=0)t.fields.removeAtIndex(i)}if(e){var r=e.fields.strictIndexOf(this);if(r<0)e.fields.accept(this)}this._form=e;this.outFormChange(e,t);return true},outFormChange:function(e,t){return this._out("formChange",e,t)},getForm:function(){return this._form},setFieldName:function(e){var t=this._fieldName;if(t===e)return;if(e===undefined)this.subscribe("idChange",this._handleFormElementIdChange,this);else if(this._fieldName===undefined)this.unsubscribe("idChange",this._handleFormElementIdChange,this);this._fieldName=e;this.outFieldNameChange(e,t);return true},getFieldName:function(){if(this._fieldName===undefined)return this._id;return this._fieldName},_handleElementIdChange:function(e,t){if(this._fieldName===undefined)this.outFieldNameChange(e,t)},outFieldNameChange:function(e,t){this._out("fieldNameChange",e,t)},setFieldIndex:function(e){var t=this._fieldIndex;if(t===e)return;this._fieldIndex=e;this.outFieldIndexChange(e,t);return true},getFieldIndex:function(){return this._fieldIndex},outFieldIndexChange:function(e,t){this._out("fieldIndexChange",e,t)},setFieldLabel:function(e){var t=this._fieldLabel;if(t===e)return;this._fieldLabel=e;if(this._fieldTranslator&&this._fieldTranslator.field===t){this._fieldTranslator.field=e}if(this._fieldErrors)this._revalidate();if(this._fieldInSyncWithAnnotations&&!this._lockAnnotationSync&&this.hasAnnotation("label")){this._lockAnnotationSync++;this.setLabel(this._fieldLabel);this._lockAnnotationSync--}this.outFieldLabelChange(e,t);return true},getFieldLabel:function(){return this._fieldLabel},outFieldLabelChange:function(e,t){return this._out("fieldLabelChange",e,t)},setValidators:function(e){Amm.cleanup(true,this.validators);this._validators=[];if(!e)return;if(!(e instanceof Array)){Error("`validators` must be an Array")}for(var t=0;t<e.length;t++){var i=Amm.Validator.construct(e[t]);if(typeof i.setElement==="function"){i.setElement(this)}else if("element"in i){i.element=this}this._validators.push(i)}this.setNeedValidate(true)},validate:function(e){if(!this._fieldApplied){if(e)return[];return true}if(this._translationErrorState){if(e)return this._fieldErrors?[].concat(this._fieldErrors):[];return false}var t=[];var i=this.getFieldEmpty();var r=this.getFieldValue();var n=this.getFieldLabel();this._doValidate(t,r,i,n);if(e){return t}this.setFieldErrors(t);this.setNeedValidate(false);return!t.length},_doValidate:function(e,t,i,r){var n;if(this._fieldRequiredValidator){n=this._fieldRequiredValidator.getError(t,this.getFieldLabel());if(n){if(this._fieldRequired)e.push(n);i=true}else{i=false}}else{if(i&&this._fieldRequired){e.push(Amm.translate(this.fieldRequiredMessage,"%field",r))}}if(!i){this.outOnValidate(t,e);if(this._validationExpressions){this._applyValidationExpressions(e)}for(var s=0;s<this._validators.length;s++){n=this._validators[s].getError(t,r);if(n)e.push(n)}}},_revalidate:function(){if(this._fieldSyncsValue&&this._translationErrorState===Amm.Trait.Field.TRANSLATION_ERROR_IN){var e=this.getValue();this._handleFormExtValueChange(e,e)}else if(this._fieldSyncsValue&&this._translationErrorState===Amm.Trait.Field.TRANSLATION_ERROR_OUT){this._syncFieldValueToElement(this._fieldValue)}else{this.validate()}},outOnValidate:function(e,t){return this._out("onValidate",e,t)},getValidators:function(){return this._validators},setValidateMode:function(e){var t=this._validateMode;if(t===e)return;this._validateMode=e;if(this._needValidate&&e&Amm.Trait.Field.VALIDATE_INSTANT){this.validate()}return true},getValidateMode:function(){return this._validateMode},setFieldErrors:function(e,t){var i=this._fieldErrors;var r=false;if(e){if(!(e instanceof Array))e=[e];else if(!e.length)e=null}else{if(e!==undefined)e=null}if(t&&this._fieldErrors){if(!e)return;var n=Amm.Array.diff(e,this._fieldErrors);if(!n.length)return;e=[].concat(this._fieldErrors,n)}else{if(i instanceof Array&&e instanceof Array){if(i.length===e.length&&!Amm.Array.symmetricDiff(i,e).length)r=true}}if(i===e||r)return;this._fieldErrors=e;if(this._fieldInSyncWithAnnotations&&!this._lockAnnotationSync&&this.hasAnnotation("error")){this._lockAnnotationSync++;this.setError(e);this._lockAnnotationSync--}this.outFieldErrorsChange(e,i);return true},getFieldErrors:function(){if(!this._fieldApplied)return[];if(this._fieldErrors===undefined)this.validate();return this._fieldErrors?[].concat(this._fieldErrors):null},outFieldErrorsChange:function(e,t){this._out("fieldErrorsChange",e,t)},setFieldApplied:function(e){e=!!e;var t=this._fieldApplied;if(t===e)return;this._fieldApplied=e;this.outFieldAppliedChange(e,t);this.setNeedValidate(true);return true},outFieldAppliedChange:function(e,t){this._out("fieldAppliedChange",e,t)},getFieldApplied:function(){return this._fieldApplied},setFieldSyncWithAnnotations:function(e){e=!!e;var t=this._fieldSyncWithAnnotations;if(t===e)return;this._fieldSyncWithAnnotations=e;if(this._fieldSyncWithAnnotations)this._syncWithAnnotations();return true},getFieldSyncWithAnnotations:function(){return this._fieldSyncWithAnnotations},getFieldInSyncWithAnnotations:function(){return this._fieldInSyncWithAnnotations},setFieldRequired:function(e){e=!!e;var t=this._fieldRequired;if(t===e)return;this._fieldRequired=e;if(this._fieldInSyncWithAnnotations&&!this._lockAnnotationSync&&this.hasAnnotation("required")){this._lockAnnotationSync++;this.setRequired(this._fieldRequired);this._lockAnnotationSync--}this.outFieldRequiredChange(e,t);this.setNeedValidate(true);return true},outFieldRequiredChange:function(e,t){return this._out("fieldRequiredChange",e,t)},getFieldRequired:function(){return this._fieldRequired},setFieldRequiredValidator:function(e){var t=this._fieldRequiredValidator;if(t===e)return;if(e){if(typeof e==="function"){e=new Amm.Validator.Function({func:e})}else{e=Amm.constructInstance(e,"Amm.Validator")}Amm.setField(e,"element",this)}this._fieldRequiredValidator=e;this.setNeedValidate(true);return true},getFieldRequiredValidator:function(){return this._fieldRequiredValidator},setFieldEmpty:function(e){var t=this._fieldEmpty;if(t===e)return;this._fieldEmpty=e;this.outFieldEmptyChange(e,t);return true},_handleFormExtValueChange:function(e,t){if(this._lockFieldValueChange)return;this._lockFieldValueChange=1;this._translationErrorState=0;var i={},r=e;if(this._fieldTranslator){r=this._fieldTranslator.translateIn(e,i)}if(i.error){this._setInTranslationErrorState(r,i.error)}else{this.setFieldValue(r)}this._lockFieldValueChange=0},setFieldValue:function(e){var t=this._fieldValue;if(t===e)return;this._fieldValue=e;this.setFieldEmpty(this._isFieldEmpty(e));this.setNeedValidate(true);this.outFieldValueChange(e,t);if(this._validateMode&Amm.Trait.Field.VALIDATE_CHANGE&&this._needValidate){this.validate()}if(!this._lockFieldValueChange&&this._fieldSyncsValue){this._syncFieldValueToElement(e)}return true},_syncFieldValueToElement:function(e){if(this._lockFieldValueChange||!this._fieldSyncsValue)return;this._translationErrorState=0;this._lockFieldValueChange=1;var t=e,i={};if(this._fieldTranslator){t=this._fieldTranslator.translateOut(e,i)}if(i.error){this._setOutTranslationErrorState(t,i.error)}else{this.setValue(t)}this._lockFieldValueChange=0},_setInTranslationErrorState:function(e,t){this._translationErrorState=Amm.Trait.Field.TRANSLATION_ERROR_IN;this.setFieldValue(e);this.setFieldErrors(t,false)},_setOutTranslationErrorState:function(e,t){this._translationErrorState=Amm.Trait.Field.TRANSLATION_ERROR_OUT;this.setValue(e);this.setFieldErrors(t,false)},getFieldValue:function(){return this._fieldValue},outFieldValueChange:function(e,t){this._out("fieldValueChange",e,t)},_handleFieldFocusedChange:function(e,t){if(t&&!e&&this._validateMode&Amm.Trait.Field.VALIDATE_BLUR&this._needValidate)this.validate()},_isFieldEmpty:function(e){var t=e===undefined||e===null||e==="";return t},getFieldEmpty:function(){if(this._fieldEmpty===undefined){var e=this._isFieldEmpty(this.getFieldValue());this.setFieldEmpty(e)}return this._fieldEmpty},outFieldEmptyChange:function(e,t){this._out("fieldEmptyChange",e,t)},setNeedValidate:function(e){e=!!e;if(this._needValidate===e)return;var t=this._needValidate;this._needValidate=e;this._out("needValidateChange",e,t);if(e&&this._validateMode&Amm.Trait.Field.VALIDATE_INSTANT){this.validate()}return true},outNeedValidateChange:function(e,t){this._out("needValidateChange",e,t)},getNeedValidate:function(){return this._needValidate},setFieldTranslator:function(e){if(e)e=Amm.constructInstance(e,"Amm.Translator");else e=null;var t=this._fieldTranslator;if(t===e)return;if(e&&e.field===undefined)e.field=this.getFieldLabel();this._fieldTranslator=e;if(this._translationErrorState)this._revalidate();return true},getFieldTranslator:function(){return this._fieldTranslator},getTranslationErrorState:function(){return this._translationErrorState},setValidationExpressions:function(e){if(this._validationExpressions){Amm.cleanup(this._validationExpressions)}this._validationExpressions=null;if(!e){return}else if(!(e instanceof Array)){throw Error("`validationExpressions` must be an Array or FALSEable, provided: "+Amm.describeType(e))}if(!e.length){return}this._validationExpressions=[];for(var t=0,i=e.length;t<i;t++){var r=this._createExpression(e[t]);this._validationExpressions.push(r);r.subscribe("valueChange",this._handleValidationExpressionChange,this,t)}},_handleValidationExpressionChange:function(e,t){this.setNeedValidate(true);if(this._needValidate&&this._validateMode&Amm.Trait.Field.VALIDATE_EXPRESSIONS){this.validate()}},_applyValidationExpressions:function(e){if(!this._validationExpressions)return;var t=this.getFieldLabel();for(var i=0,r=this._validationExpressions.length;i<r;i++){var n=this._validationExpressions[i].getValue();if(n){var s=Amm.translate(n+"","%field",t);e.push(s)}}}};Amm.Trait.Visual=function(){};Amm.Trait.Visual.prototype={Visual:"__INTERFACE__",ClassName:"__INTERFACE__",DisplayChild:"__INTERFACE__",_visible:undefined,_displayParent:undefined,_displayOrder:undefined,_className:undefined,setVisible:function(e){var t=this._visible;if(t===e)return;this._visible=e;this.outVisibleChange(e,t);return true},getVisible:function(){return this._visible},outVisibleChange:function(e,t){this._out("visibleChange",e,t)},setDisplayParent:function(e){if(e)Amm.is(e,"DisplayParent","displayParent");else e=null;var t=this._displayParent;if(t===e)return;this._displayParent=e;if(t){var i=t.displayChildren.strictIndexOf(this);if(i>=0)t.displayChildren.removeAtIndex(i)}if(e){var r=e.displayChildren.strictIndexOf(this);if(r<0)e.displayChildren.accept(this)}this.outDisplayParentChange(e,t);return true},getDisplayParent:function(){return this._displayParent},outDisplayParentChange:function(e,t){this._out("displayParentChange",e,t)},setDisplayOrder:function(e){if(typeof e!=="number"){e=parseInt(e);if(isNaN(e))throw Error("`displayOrder` must be a number")}var t=this._displayOrder;if(t===e)return;if(this._displayParent&&e>=this._displayParent.displayChildren.length){e=this._displayParent.displayChildren.length-1}if(e<0)e=0;this._displayOrder=e;this.outDisplayOrderChange(e,t);return true},getDisplayOrder:function(){return this._displayOrder},outDisplayOrderChange:function(e,t){this._out("displayOrderChange",e,t)},setClassName:function(e,t){var i=this._className;var r;if(t){var n=new RegExp("\\s*\\b"+Amm.Util.regexEscape(t)+"\\b\\s*","g");if(this._className===undefined)this._className="";if(!e){if(this._className===undefined)this._className="";r=this._className.replace(n," ").replace(/ {2,}/g," ");if(r[0]===" ")r=r.slice(1);if(r[r.length-1]===" ")r=r.slice(0,-1)}else{if(!n.exec(this._className))r=this._className+" "+t;else r=this._className}}else{r=e}if(r===i)return;this._className=r;this.outClassNameChange(r,i);return true},getClassName:function(e){if(!e)return this._className;return(" "+this._className+" ").indexOf(" "+e+" ")>=0},outClassNameChange:function(e,t){this._out("classNameChange",e,t)}};Amm.Trait.Form=function(e){Amm.Trait.Field.call(this,e)};Amm.Trait.Form.prototype={Form:"__INTERFACE__",invalidFieldsMessage:"lang.Amm.Trait.Form.invalidFieldsMsg",fields:null,_setFormFields:null,_elementsAreFields:true,_displayChildrenAreFields:true,_childrenAreFields:true,_fieldsUpdateLevel:0,_fieldMap:null,_setFieldMap:null,_fieldsChanged:false,_lastNum:null,_beginUpdateFields:function(){this._fieldsUpdateLevel++;this.fields.beginUpdate()},_endUpdateFields:function(){if(!this._fieldsUpdateLevel)Error("Call to _endUpdateFields() w/o corresponding _beginUpdateFields()");this.fields.endUpdate();this._fieldsUpdateLevel--;if(!this._fieldsUpdateLevel&&this._fieldsChanged){this._fieldsChanged=false;this._recalcFields()}},__augment:function(e,t){Amm.Trait.Field.prototype.__augment.call(this,e,t);var i={indexProperty:"fieldIndex",assocProperty:"form",assocInstance:this,assocEvents:{fieldNameChange:this._softRecalc,fieldValueChange:this._softRecalc,fieldAppliedChange:this._softRecalc,needValidateChange:this._fieldNeedValidate},on__spliceItems:[this._softRecalc,this]};if(this._setFormFields){i.items=this._setFormFields.slice();this._setFormFields=null}if("fieldsPrototype"in t){if(typeof t.fieldsPrototype==="object"&&t.fieldsPrototype){Amm.override(i,t.fieldsPrototype)}delete t.fieldsPrototype}this.fields=new Amm.Collection(i);Amm.Element.regInit(this,"99.Amm.Trait.Form",function(){this._beginUpdateFields();if(this._elementsAreFields)this.setElementsAreFields(true,true);if(this._displayChildrenAreFields)this.setDisplayChildrenAreFields(true,true);if(this._childrenAreFields)this.setChildrenAreFields(true,true);this._endUpdateFields()})},_softRecalc:function(){this._recalcFields()},_fieldNeedValidate:function(e){this.setNeedValidate(true)},_recalcFields:function(e){if(this._fieldsUpdateLevel&&!e){this._fieldsChanged=true;return true}this._fieldsChanged=false;var t={},i=[],r=0,n=0,s=false,o=!this._fieldValue,a=0;this._fieldMap={};this._setFieldMap={};for(var l=0,h=this.fields.length;l<h;l++){var u=this.fields[l];var f=u.getFieldValue(),c=u.getFieldName();if(c===undefined||c===null){this._setFieldMap[n]=u;n++;if(!u.getFieldApplied())continue;a++;i.push(f);t[r]=f;this._fieldMap[r]=u;if(!o&&this._fieldValue[r]!==f)o=true;r++}else{this._setFieldMap[c]=u;if(!u.getFieldApplied())continue;a++;s=true;t[c]=f;this._fieldMap[c]=u;if(!o&&this._fieldValue[c]!==t[c])o=true}}if(!o&&a===this._lastNum){return}this._lastNum=a;var _=this._fieldValue;this._fieldValue=s?t:i;if(window.Object&&window.Object.freeze)window.Object.freeze(this._fieldValue);this.outFieldValueChange(this._fieldValue,_);return true},_addFields:function(e){var t=e.slice();for(var i=t.length-1;i>=0;i--){if(t[i]["Field"]!=="__INTERFACE__")t.splice(i,1)}t=Amm.Array.diff(t,this.fields);if(t.length){if(t.length>1)this._beginUpdateFields();this.fields.acceptMany(t);if(t.length>1)this._endUpdateFields()}return t},_delFields:function(e,t,i,r){var n=[];for(var s=0,o=e.length;s<o;s++){if(e[s]["Field"]==="__INTERFACE__")n.push(e[s])}if(t&&n.length&&this._elementsAreFields&&this["Component"]&&this._elements.length){n=Amm.Array.diff(n,this._elements)}if(i&&n.length&&this._childrenAreFields&&this["Composite"]&&this._children.length){for(var a=n.length-1;a>=0;a--){var l=n[a].getId();if(this._children[l]===n[a]){n.splice(a,1)}}}if(r&&n.length&&this._displayChildrenAreFields&&this["DisplayParent"]&&this.displayChildren.length){n=Amm.Array.diff(n,this.displayChildren)}if(!n.length)return;this._beginUpdateFields();var h=[];for(var s=0,o=n.length;s<o;s++){var u=this.fields.indexOf(n[s]);if(u>=0){this.fields.removeAtIndex(u);h.push(n[s])}}this._endUpdateFields();return h},setElementsAreFields:function(e,t){e=!!e;var i=this._elementsAreFields;if(i===e&&!t)return;this._elementsAreFields=e;if(!this.fields||this["Component"]!=="__INTERFACE__")return true;var r=e?"subscribe":"unsubscribe";this[r]("acceptedElements",this._handleFieldComponentAcceptedElements,this);this[r]("rejectedElements",this._handleFieldComponentRejectedElements,this);if(this._elements.length){if(e)this._addFields(this._elements);else this._delFields(this._elements,false,true,true)}return true},_handleFieldComponentAcceptedElements:function(e){this._addFields(e)},_handleFieldComponentRejectedElements:function(e){if(this._childrenAreFields&&this["Composite"]&&this._children.length){e=Amm.Array.diff(e,this._children)}if(e.length&&this._displayChildrenAreFields&&this["DisplayParent"]&&this.displayChildren.length){e=Amm.Array.diff(e,this.displayChildren)}if(e.length)this._delFields(e,false,true,true)},getElementsAreFields:function(){return this._elementsAreFields},setDisplayChildrenAreFields:function(e,t){e=!!e;var i=this._displayChildrenAreFields;if(i===e&&!t)return;this._displayChildrenAreFields=e;if(!this.fields||this["DisplayParent"]!=="__INTERFACE__")return true;var r=e?"subscribe":"unsubscribe";this.displayChildren[r]("spliceItems",this._handleFieldDisplayChildrenSpliceItems,this);if(this.displayChildren.length){if(e)this._addFields(this.displayChildren);else this._delFields(this.displayChildren,true,true,false)}return true},_handleFieldDisplayChildrenSpliceItems:function(e,t,i){var r=Amm.Array.symmetricDiff(t,i);var n=Amm.Array.symmetricDiff(i,t);if(r.length&&n.length)this._beginUpdateFields();if(r.length)this._delFields(r,true,true,false);if(n.length)this._addFields(n);if(r.length&&n.length)this._endUpdateFields()},getDisplayChildrenAreFields:function(){return this._displayChildrenAreFields},setChildrenAreFields:function(e,t){e=!!e;var i=this._childrenAreFields;if(i===e&&!t)return;this._childrenAreFields=e;if(!this.fields||this["Composite"]!=="__INTERFACE__")return true;var r=e?"subscribe":"unsubscribe";this[r]("childAdded",this._handleFieldCompositeChildAdded,this);this[r]("childRemoved",this._handleFieldCompositeChildRemoved,this);var n=this.getChildren();if(n.length){if(e)this._addFields(n);else this._delFields(n,true,false,true)}return true},_handleFieldCompositeChildAdded:function(e){this._addFields([e])},_handleFieldCompositeChildRemoved:function(e){this._delFields([e],true,false,true)},getChildrenAreFields:function(){return this._childrenAreFields},_cleanup_Model:function(){this.fields.cleanup()},_acquirePossibleFields:function(e){pp=[];for(var t=0,i=e.length;t<i;t++){var r=e[t];if(!(r&&r["Field"]==="__INTERFACE__"))continue;if(!(r._parentModel||r===this))continue;pp.push(r)}if(pp.length)this.fields.push.apply(this.fields,pp)},setFields:function(e){if(!this.fields){if(!this._setFormFields)this._setFormFields=e;else{if(!e)this._setFormFields=null;else if(!(e instanceof Array||e["Amm.Array"]))throw Error("`fields` must be an Array or Amm.Array");this._setFormFields=e}return}var t=Amm.Array.diff(this.fields,e);var i=Amm.Array.diff(e,this.fields);if(!t.length&&!i.length)return;this._beginUpdateFields();if(t.length)this._delFields(t,true,true,true);if(e.length)this.fields.acceptMany(e);this._endUpdateFields()},getFields:function(){if(!this.fields){if(!this._setFormFields)this._setFormFields=[];return this._setFormFields}return this.fields},_parseKeyArgs:function(e,t,i){var r=t[e];if(r!==undefined){var n=r,s;if(t.length>e+1){if(!(n instanceof Array))n=[n];n=n.concat(Array.prototype.slice.call(t,e+1))}if(n instanceof Array){s=n.shift();if(!n.length)n=undefined}else{s=n;n=undefined}var o=i?this._setFieldMap[s]:this._fieldMap[s];return[o,s,n]}},setFieldValue:function(e,t){if(!this._fieldMap)this._recalcFields(true);if(t!==undefined){var i=this._parseKeyArgs(1,arguments,true),r=i[0];if(r)return r.setFieldValue(e,i[2]);else return undefined}this._beginUpdateFields();if(typeof e!=="object"||!e)throw Error("`value` must be a hash or an Array; provided: "+Amm.describeType(e));for(var n in e)if(e.hasOwnProperty(n)&&this._setFieldMap[n]){this._setFieldMap[n].setFieldValue(e[n])}this._endUpdateFields()},getFieldValue:function(e){if(this._fieldValue===undefined){this._recalcFields(true)}if(e===undefined)return this._fieldValue;var t=this._parseKeyArgs(0,arguments,false),i=t[0],r=t[1],n=t[2];var s=this._fieldValue[r];if(n){do{var o=n.shift();if(typeof s==="object"&&(s instanceof Array||s)&&o in s){s=s[o]}else{s=undefined}}while(n.length);if(n.length)s=undefined}return s},_doValidate:function(e,t,i,r){Amm.Trait.Field.prototype._doValidate.call(this,e,t,i,r);var n=false;for(var s=0,o=this.fields.length;s<o;s++){if(!this.fields[s].validate())n=true}if(n){e.push(Amm.translate(this.invalidFieldsMessage,"%field",r||Amm.translate("lang.Amm.Trait.Form.form")))}}};Amm.extend(Amm.Trait.Form,Amm.Trait.Field);Amm.defineLangStrings({"lang.Amm.Trait.Form.invalidFieldsMsg":"One or more fields of %field are filled with errors","lang.Amm.Trait.Form.form":"the form"});Amm.Trait.Toggle=function(){};Amm.Trait.Toggle.prototype={Toggle:"__INTERFACE__",_isRadio:undefined,_groupName:undefined,_groupParent:undefined,_checked:undefined,_checkedValue:undefined,_uncheckedValue:undefined,_valueIsStandalone:false,_lockGroup:0,_lockGroupSearch:0,_value:undefined,__augment:function(e){Amm.Element.regInit(this,"99.Amm.Trait.Toggle",this._subscribeToggleToRoot)},setIsRadio:function(e){if(e!==undefined)e=!!e;var t=this._isRadio;if(t===e)return;var i=this._getOwnValue()!==undefined;this._isRadio=e;i=i||this._getOwnValue()!==undefined;this.outIsRadioChange(e,t);if(this._uncheckOtherRadios()||i)this._notifyGroup();return true},getIsRadio:function(){return this._isRadio},outIsRadioChange:function(e,t){this._out("isRadioChange",e,t)},setGroupName:function(e){if(!e)e=undefined;var t=this._groupName;if(t===e)return;var i=this.findGroupItems(false,true);this._groupName=e;if(i.length)this._notifyGroup(i);this.outGroupNameChange(e,t);this._notifyGroup();return true},getGroupName:function(){return this._groupName},outGroupNameChange:function(e,t){this._out("groupNameChange",e,t)},setGroupParent:function(e){if(!e)e=undefined;var t=this._groupParent;if(t===e)return;var i=this.findGroupItems(false,true);this._groupParent=e;if(i.length)this._notifyGroup(i);this.outGroupParentChange(e,t);this._notifyGroup();return true},getGroupParent:function(){return this._groupParent},outGroupParentChange:function(e,t){this._out("groupParentChange",e,t)},_uncheckOtherRadios:function(){if(!this._checked||!this._isRadio)return;var e=this.findGroupItems(true),t=false;if(e.length<=1)return;for(var i=0,r=e.length;i<r;i++){if(e[i]!==this&&e[i].getChecked()){e[i]._uncheckByGroup();t=true}}return t},_uncheckByGroup:function(){this._lockGroup++;this.setChecked(false);this._lockGroup--},setEnabled:function(e){var t=this._getOwnValue()!==undefined;var i=Amm.Trait.Input.prototype.setEnabled.call(this,e);if(i&&(t||this._getOwnValue()!==undefined))this._reportChange();return i},setChecked:function(e){if(e!==undefined)e=!!e;var t=this._checked;if(t===e)return;this._checked=e;this._uncheckOtherRadios();this._reportChange();this.outCheckedChange(e,t);return true},getChecked:function(){return this._checked},outCheckedChange:function(e,t){this._out("checkedChange",e,t)},setCheckedValue:function(e){var t=this._checkedValue;if(t===e)return;this._checkedValue=e;this.outCheckedValueChange(e,t);if(this._checked)this._reportChange();return true},getCheckedValue:function(){return this._checkedValue},outCheckedValueChange:function(e,t){this._out("checkedValueChange",e,t)},setUncheckedValue:function(e){var t=this._uncheckedValue;if(t===e)return;this._uncheckedValue=e;this.outUncheckedValueChange(e,t);if(!this._checked)this._reportChange();return true},getUncheckedValue:function(){return this._uncheckedValue},outUncheckedValueChange:function(e,t){this._out("uncheckedValueChange",e,t)},setValueIsStandalone:function(e){e=!!e;var t=this._valueIsStandalone;if(t===e)return;this._valueIsStandalone=e;var i=this._value;this.outValueIsStandaloneChange(e,t);this._value=e?this._getOwnValue():this._getGroupValue();if(!Amm.Trait.Select.valuesAreSame(i,this._value))this.outValueChange(this._value,i);return true},getValueIsStandalone:function(){return this._valueIsStandalone},outValueIsStandaloneChange:function(e,t){this._out("valueIsStandaloneChange",e,t)},_notifyGroup:function(e,t){if(!e)e=this.findGroupItems();if(arguments.length<2)t=this._getGroupValue(e);for(var i=0,r=e.length;i<r;i++){e[i]._receiveGroupNotification(t,this)}},_reportChange:function(){if(this._valueIsStandalone){var e=this._getOwnValue();if(e!==this._value){var t=this._value;this._value=e;this.outValueChange(this._value,t)}}var i=this._getGroupValue();var r=this.findGroupItems();for(var n=0,s=r.length;n<s;n++){r[n]._receiveGroupNotification(i,this)}},setValue:function(e){var t=this._value;if(this._valueIsStandalone){this._setOwnValue(e)}else{this._setGroupValue(e)}if(!Amm.Trait.Select.valuesAreSame(this._value,t))return true},_receiveGroupNotification:function(e,t){if(this._valueIsStandalone)return;if(!Amm.Trait.Select.valuesAreSame(e,this._value)){var i=this._value;this._value=e;this.outValueChange(e,i)}},_setGroupValue:function(e){var t;if(e instanceof Array)t=e;else{if(e===null||e===undefined)t=[];else t=[e]}var i=this.findGroupItems();var r=false;var n=false;var s,o;for(s=0,o=i.length;s<o;s++){i[s]._lockGroup++}for(s=0,o=i.length;s<o;s++){var a=i[s];if(a["Toggle"]!=="__INTERFACE__")return;var l=a.getIsRadio(),h=Amm.Array.nonStrictIndexOf(a.getCheckedValue(),t)>=0,u=a.getChecked();r=r||h&&u&&l;if(!(l&&r)&&(h&&!u||!h&&u)){if(l&&h)r=true;n=true;a.setChecked(!!h)}}for(s=0,o=i.length;s<o;s++){i[s]._lockGroup--}if(n)this._reportChange();return n},_getGroupValue:function(e){if(!e)e=this.findGroupItems();var t=[],i=0,r=0;for(var n=0,s=e.length;n<s;n++){var o=e[n],a=o._getOwnValue();if(o["Toggle"]!=="__INTERFACE__")continue;if(o.getIsRadio()){r++}else{i++}if(a!==undefined){t.push(a)}}var l=r===0&&i===1||r&&!i;var t;if(l)t=t[0];return t},_setOwnValue:function(e){if(e==this._checkedValue){this.setChecked(true)}else{this.setChecked(false)}},_getOwnValue:function(){if(!this._enabled)return;if(this._checked)return this._checkedValue;if(!this._isRadio)return this._uncheckedValue},findGroupItems:function(e,t){var i=[];if(t)this._lockGroupSearch++;Amm.getRoot().raiseEvent("findToggleGroupItems",this._groupParent,this._groupName,e,i);if(t)this._lockGroupSearch--;return i},_handleFindToggleGroupItems:function(e,t,i,r){if(this._lockGroupSearch)return;if(e===this._groupParent&&t===this._groupName){if(!i||this._isRadio){r.push(this)}}},_subscribeToggleToRoot:function(){Amm.getRoot().subscribe("findToggleGroupItems",this._handleFindToggleGroupItems,this)},_setComponent_Toggle:function(e,t){if(this._groupParent===t||!this._groupParent||this._groupParent.tagName){this.setGroupParent(e)}},_cleanup_Toggle:function(){Amm.getRoot().unsubscribe("findToggleGroupItems",this._handleFindToggleGroupItems,this)}};Amm.extend(Amm.Trait.Toggle,Amm.Trait.Input);Amm.Trait.Content=function(){};Amm.Trait.Content.prototype={Content:"__INTERFACE__",_content:undefined,_contentTranslator:null,setContent:function(e){var t=this._content;if(t===e)return;this._content=e;this.outContentChange(e,t);return true},getContent:function(){return this._content},outContentChange:function(e,t){this._out("contentChange",e,t)},setContentTranslator:function(e){if(e)e=Amm.constructInstance(e,"Amm.Translator");else e=null;var t=this._contentTranslator;if(t===e)return;this._contentTranslator=e;this.outContentTranslatorChange(e,t);return true},getContentTranslator:function(){return this._contentTranslator},outContentTranslatorChange:function(e,t){this._out("contentTranslatorChange",e,t)}};Amm.Trait.Repeater=function(){};Amm.Trait.Repeater.prototype={Repeater:"__INTERFACE__",InstantiatorOrRepeater:"__INTERFACE__",_useFilter:true,_arrayMapperOptions:null,_reportedInstantiatorOptions:null,_withVariantsView:false,_assocProperty:null,_revAssocProperty:null,_repeaterItems:null,__augment:function(e,t){if(typeof t==="object"&&t&&"withVariantsView"in t){this._withVariantsView=!!t.withVariantsView;delete t.withVariantsView}Amm.Element.regInit(this,"99.Amm.Trait.Repeater",function(){if(this["DisplayParent"]!=="__INTERFACE__")throw Error("Repeater must be also a DisplayParent")});if("items"in t){var i=t.items;Amm.Element.regInit(this,"99.Amm.Trait.Repeater.setItems",function(){this.setItems(i)});delete t.items}if(t&&t.initialInstantiatorOptions){this._reportedInstantiatorOptions=t.initialInstantiatorOptions;delete t.initialInstantiatorOptions}},setItems:function(e){if(!e)e=[];else if(!(e instanceof Array)&&!e["Amm.Array"])e=[e];if(this._withVariantsView&&!this._arrayMapper)this._repeaterItems=e;else this.getArrayMapper().setSrc(e)},getItems:function(){return this.getArrayMapper().getSrc()},outItemsChange:function(e,t){return this._out("itemsChange",e,t)},_handleArrayMapperSrcChange:function(e,t){this.outItemsChange(e,t)},getArrayMapper:function(){if(!this._arrayMapper){this._createArrayMapper()}return this._arrayMapper},setArrayMapper:function(e){console.warn("Amm.Trait.Repeater: setArrayMapper() isn't supported; use setArrayMapperOptions() instead")},outArrayMapperChange:function(e,t){return this._out("arrayMapperChange",e,t)},_createArrayMapper:function(){var e=this._arrayMapper,t;this.displayChildren.setCleanupOnDissociate(true);if(e){t=e.getSrcIsOwn()?e.getSrc().getItems():e.getSrc();e.cleanup()}var i=this._calcArrayMapperOptions.apply(this,this._reportedInstantiatorOptions||[]);if(t)i.src=t;else if(this._repeaterItems){i.src=this._repeaterItems;this._repeaterItems=null}if(this._arrayMapperOptions)i=Amm.overrideRecursive(i,this._arrayMapperOptions);var r=Amm.constructInstance(i,Amm.ArrayMapper);this._arrayMapper=r;this.outArrayMapperChange(this._arrayMapper,e)},_calcArrayMapperOptions:function(e,t,i){var r;if((!t||!t.length)&&e){r={class:Amm.Instantiator.Proto,isElement:true,proto:e}}else{r={class:Amm.Instantiator.Variants,prototypes:i||[],defaultPrototype:e||null}}var n={dest:this.displayChildren,filter:{class:Amm.Filter,conditions:t},instantiator:r};if(!t||!t.length)delete n.filter;if(this._assocProperty)n.instantiator.assocProperty=this._assocProperty;if(this._revAssocProperty)n.instantiator.revAssocProperty=this._revAssocProperty;return n},_cleanup_Repeater:function(){this._arrayMapper.cleanup()},setArrayMapperOptions:function(e){if(!e)e=null;var t=this._arrayMapperOptions;if(t===e)return;this._arrayMapperOptions=e;if(this._arrayMapper)this._createArrayMapper();return true},getArrayMapperOptions:function(){return this._arrayMapperOptions},reportInstantiatorOptions:function(e,t,i){this._reportedInstantiatorOptions=[e,t,i];this._createArrayMapper()},setAssocProperty:function(e){var t=this._assocProperty;if(t===e)return;this._assocProperty=e;if(this._arrayMapper)this._createArrayMapper();return true},getAssocProperty:function(){return this._assocProperty},setRevAssocProperty:function(e){var t=this._revAssocProperty;if(t===e)return;this._revAssocProperty=e;if(this._arrayMapper)this._createArrayMapper();return true},getRevAssocProperty:function(){return this._revAssocProperty}};Amm.Util={regexEscape:function(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},trim:function(e){return e.replace(/^\s+|\s+$/g,"")}};Amm.Operator.Unary=function(e,t){Amm.Operator.call(this);this._setOperator(e);if(t!==undefined)this._setOperand("operand",t)};Amm.Operator.Unary.Unary_OPERATORS={"!":function(e){return!e},"-":function(e){return-e}};Amm.Operator.Unary.prototype={"Amm.Operator.Unary":"__CLASS__",_operandOperator:null,_operandValue:null,_operandExists:null,_operator:null,_operatorFn:null,OPERANDS:["operand"],STATE_SHARED:{_operator:true,_operatorFn:true},supportsAssign:false,_setOperator:function(e){var t=Amm.Operator.Unary.Unary_OPERATORS[e];if(!t)Error("Unsupported Unary operator type: '"+e+"'");this._operator=e;this._operatorFn=t},_doEvaluate:function(e){var t=this._getOperandValue("operand",e);return this._operatorFn(t)},setOperand:function(e){this._setOperand("operand",e)},toFunction:function(){var t=this._operandFunction("operand");var i=this._operatorFn;return function(e){return i(t(e))}}};Amm.extend(Amm.Operator.Unary,Amm.Operator);Amm.Operator.ComponentElement=function(e,t,i,r,n){Amm.Operator.call(this);this._componentOnly=r;if(e!==undefined)this._setOperand("component",e);if(t!==undefined)this._setOperand("id",t);if(i!==undefined)this._setOperand("range",i);if(n!==undefined)this._allElements=!!n};Amm.Operator.ComponentElement.prototype={"Amm.Operator.ComponentElement":"__CLASS__",_componentOnly:false,_allElements:false,_componentOperator:null,_componentValue:null,_componentExists:null,_idOperator:null,_idValue:null,_idExists:null,_rangeOperator:null,_rangeValue:null,_rangeExists:null,OPERANDS:["component","id","range"],STATE_SHARED:{_componentOnly:true},supportsAssign:false,getReportsContentChanged:function(){return true},_componentEvents:function(e,t){if(t&&t["Component"])this._unsub(t);if(e&&e["Component"]){var i={acceptedElements:this._acceptedElements,rejectedElements:this._rejectedElements,renamedElement:this._renamedElement};if(this._componentOnly){i["childComponentStatusChange"]=this._childComponentStatusChange}this._sub(e,i)}},_rangeChange:function(e){this._checkArrayChange=e==="*"},_acceptedElements:function(e){if(this._isEvaluating)return;if(this._allElements){this.evaluate();return}if(!this._allElements&&(!this._idExists||!this._idValue))return;var t=false;for(var i=0,r=e.length;i<r;i++){if(e[i].getId()===this._idValue){t=true;break}}if(t)this.evaluate()},_rejectedElements:function(e){return this._acceptedElements(e)},_renamedElement:function(e,t,i){if(this._isEvaluating)return;if(this._allElements){this.evaluate();return}if(!this._idExists||!this._idValue)return;if(t===this._idValue||i===this._idValue)this.evaluate()},_childComponentStatusChange:function(e,t){if(this._isEvaluating)return;if(this._allElements){this.evaluate();return}if(!this._idExists||!this._idValue)return;if(e.getId()===this._idValue||e.getInternalId()===this._idValue)this.evaluate()},setComponent:function(e){this._setOperand("component",e)},setId:function(e){this._setOperand("id",e)},_doEvaluate:function(e){var t=this._getOperandValue("range",e);var i=this._getOperandValue("id",e);var r=this._getOperandValue("component",e);return Amm.Operator.ComponentElement._eval(r,i,t,this._componentOnly,this._allElements)},toFunction:function(){var n=this._operandFunction("component");var s=this._operandFunction("id");var o=this._operandFunction("range");var a=this._componentOnly;var l=this._allElements;return function(e){var t=o(e);var i=s(e);var r=n(e);return Amm.Operator.ComponentElement._eval(r,i,t,a,l)}}};Amm.Operator.ComponentElement._eval=function(e,t,i,r,n){var s=i==="*"||!t&&n;var o=s?[]:undefined;if(!e||!e["Component"]||!e.getIsComponent())return o;if(r){var a;if(!t&&n)a=e.getElements();else a=e.getAllNamedElements(t);var l=[];for(var h=0;h<a.length;h++)if(a[h]["Component"]&&a[h].getIsComponent())l.push(a[h]);return s?l:l[i]}if(s){if(!t&&n)return e.getElements();return e.getAllNamedElements(t)}return e.getNamedElement(t,i)};Amm.extend(Amm.Operator.ComponentElement,Amm.Operator);Amm.Operator.Property=function(e,t,i,r,n){this._isEvaluating++;Amm.Operator.call(this);if(e!==undefined)this._setOperand("object",e);if(t!==undefined)this._setOperand("property",t);if(i!==undefined)this._setOperand("arguments",i);if(n){this._isCall=true;this.supportsAssign=false}if(r!==undefined&&r!==null){this._cacheability=!!r}this._isEvaluating--};Amm.Operator.Property.prototype={"Amm.Operator.Property":"__CLASS__",_objectOperator:null,_objectValue:null,_objectExists:null,_propertyOperator:null,_propertyValue:null,_propertyExists:null,_argumentsOperator:null,_argumentsValue:null,_argumentsExists:null,_isCall:false,_cacheability:null,_eventName:false,supportsAssign:true,OPERANDS:["object","property","arguments"],STATE_SHARED:{_isCall:true,_cacheability:true,supportsAssign:true},setObject:function(e){this._setOperand("object",e)},promoteToCall:function(e,t){if(this._hasValue)Error("Cannot promoteToCall(): already evaluated");this._isEvaluating++;this._isCall=true;this.supportsAssign=false;if(this._argumentsOperator||!(this._arguments===null||this._arguments===undefined))Error("Getter arguments already defined - cannot promote to call");if(t!==undefined&&t!==null){this._cacheability=!!t}if(e!==undefined)this._setOperand("arguments",e);this._isEvaluating--},hasArguments:function(){return this._argumentsOperator||!(this._arguments===null||this._arguments===undefined)},setProperty:function(e){this._setOperand("property",e)},setArguments:function(e){this._setOperand("arguments",e)},_handleObjectCleanup:function(){this._setOperandValue("object",null)},_objectChange:function(e,t){if(e&&!e["Amm.WithEvents"]&&!this._isCall&&this._cacheability===null){this._setNonCacheable(this._nonCacheable|Amm.Operator.NON_CACHEABLE_VALUE)}},_objectEvents:function(e,t){if(t)this._unsub(t);if(!e){this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_VALUE)}else if(this._isCall||e&&!e["Amm.WithEvents"]){var i=this._cacheability;if(i===null)i=this._isCall;if(i){this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_CONTENT)}else{this._setNonCacheable(this._nonCacheable|Amm.Operator.NON_CACHEABLE_CONTENT)}}else{this._subToProp(this._propertyValue);if(e.outCleanup)this._sub(e,"cleanup",this._handleObjectCleanup,undefined,true)}},getReportsContentChanged:function(){return this._cacheability},_subToProp:function(e){if(!e&&e!==0||this._objectValue["Amm.Array"]&&parseInt(e)==e){if(this._nonCacheable)this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_VALUE);return}var t=e+"Change";if(!this._objectValue.hasEvent(t))t=null;if(t){this._sub(this._objectValue,t,undefined,undefined,true);this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_VALUE)}else{this._setNonCacheable(this._nonCacheable|Amm.Operator.NON_CACHEABLE_VALUE)}this._eventName=t},_propertyChange:function(e,t){if(!this._objectValue||!this._objectValue["Amm.WithEvents"])return;if(this._eventName==="spliceItems"&&parseInt(e)==e)return;if(this._eventName)this._unsub(this._objectValue,this._eventName);if(!this._isCall){this._subToProp(e)}else{var i=this._cacheability;if(i===null)i=true;if(i){this._setNonCacheable(this._nonCacheable&~Amm.Operator.NON_CACHEABLE_VALUE)}else{this._setNonCacheable(this._nonCacheable|Amm.Operator.NON_CACHEABLE_VALUE)}}},_doEvaluate:function(e){var t=this._getOperandValue("property",e);if(!t&&t!==0)return;t=""+t;var i=this._getOperandValue("object",e);if(!i)return;var r;if(this._isCall){if(typeof i[t]!=="function")Error("cannot call a non-function property");r=this._getOperandValue("arguments",e);if(r===null||r===undefined)return i[t]();else if(r instanceof Array)return i[t].apply(i,r);else return i[t](r)}var n="get"+t[0].toUpperCase()+t.slice(1);if(typeof i[n]!=="function")return i[t];var r=this._getOperandValue("arguments",e);if(r===null||r===undefined){}else if(r instanceof Array){if(!r.length)r=null}else{r=[r]}if(r)return i[n].apply(i,r);else return i[n]()},toFunction:function(){var s=this._operandFunction("property");var o=this._operandFunction("object");var a=this._operandFunction("arguments");if(this._isCall)return function(e){var t=s(e);if(!t&&t!==0)return;t=""+t;var i=o(e);if(!i)return;if(typeof i[t]!=="function")Error("cannot call a non-function property");var r=a(e);if(r===null||r===undefined)return i[t]();else if(r instanceof Array)return i[t].apply(i,r);return i[t](r)};return function(e){var t=s(e);if(!t&&t!==0)return;t=""+t;var i=o(e);if(!i)return;var r="get"+t[0].toUpperCase()+t.slice(1);if(typeof i[r]!=="function")return i[t];var n=a(e);if(n===null||n===undefined){}else if(n instanceof Array){if(!n.length)n=null}else{n=[n]}if(n)return i[r].apply(i,n);else return i[r]()}},_doSetValue:function(e,t){var i=this._getOperandValue("property");if(!i&&i!==0)return;i=""+i;if(i[0]==="_")return"cannot assign to pseudo-private properties(beginning with '_')";var r=this._getOperandValue("object");if(!r)return"`object` is empty";var n="get"+i[0].toUpperCase()+i.slice(1);var s=i[0].toUpperCase()+i.slice(1);var n="get"+s;var o="set"+s;var a=typeof r[n]==="function";var l=typeof r[o]==="function";if(a&&!l)return"property is read-only (has getter but no setter)";if(t)return false;if(!l){r[i]=e;return}var h=this._getOperandValue("arguments");if(h===null||h===undefined){}else if(h instanceof Array){if(!h.length)h=null}else{h=[h]}if(h){h=[].concat([e],h);r[o].apply(r,h);return}r[o](e)},assignmentFunction:function(){var u=this._operandFunction("property");var f=this._operandFunction("object");var c=this._operandFunction("arguments");return function(e,t){var i=u(e);if(!i)return"`property` is empty";i=""+i;if(i[0]==="_")return"cannot assign to pseudo-private properties(beginning with '_')";var r=f(e);if(!r)return"`object` is empty";var n=i[0].toUpperCase()+i.slice(1);var s="get"+n;var o="set"+n;var a=typeof r[s]==="function";var l=typeof r[o]==="function";if(a&&!l)return"property is read-only (has getter but no setter)";if(!l){r[i]=t;return}var h=c(e);if(h===null||h===undefined){}else if(h instanceof Array){if(!h.length)h=null}else{h=[h]}if(h){h.unshift(t);r[o].apply(r,h);return}r[o](t)}},_isValueObservable:function(e,t){if(e==="arguments")return false;return Amm.Operator.prototype._isValueObservable.call(this,e,t)}};Amm.extend(Amm.Operator.Property,Amm.Operator);Amm.Operator.ChildElement=function(e,t,i,r){Amm.Operator.call(this);if(e!==undefined)this._setOperand("element",e);if(t!==undefined)this._setOperand("id",t);if(i!==undefined)this._setOperand("range",i);if(r!==undefined)this._allElements=!!r};Amm.Operator.ChildElement.prototype={"Amm.Operator.ChildElement":"__CLASS__",_allElements:false,_elementOperator:null,_elementValue:null,_elementExists:null,_idOperator:null,_idValue:null,_idExists:null,_rangeOperator:null,_rangeValue:null,_rangeExists:null,OPERANDS:["element","id","range"],_elementEvents:function(e,t){if(t)this._unsub(t);if(e){var i={childAdded:this._elementChildAdded,childRemoved:this._elementChildRemoved,childRenamed:this._elementChildRenamed};this._sub(e,i)}},_elementChildAdded:function(e){if(this._isEvaluating)return;if(this._allElements||this._idExists&&this._getOperandValue("id")===e.getId()){this.evaluate()}},_elementChildRemoved:function(e){if(this._isEvaluating)return;if(this._hasValue&&(e===this._value||this._value instanceof Array)){this.evaluate()}},_elementChildRenamed:function(e,t,i){if(this._isEvaluating)return;if(this._idExists){var r=this._getOperandValue("id");if(r===t||r===i)this.evaluate()}},_doEvaluate:function(){var e=this._getOperandValue("element");var t=this._getOperandValue("id");var i=this._getOperandValue("range");return Amm.Operator.ChildElement._eval(e,t,i,this._allElements)},toFunction:function(){var t=this._operandFunction("element");var i=this._operandFunction("id");var r=this._operandFunction("range");var n=this._allElements;return function(e){return Amm.Operator.ChildElement._eval(t(e),i(e),r(e),n)}}};Amm.Operator.ChildElement._eval=function(e,t,i,r){var n=i==="*"||!t&&r;var s=n?[]:undefined;var o;if(!n)i=parseInt(i)||0;if(!e||!e["Composite"])return s;if(t){o=e.getChild(t);if(n)o=o?[o]:[];return o}o=e.getChildren();return n?o:o[i]};Amm.extend(Amm.Operator.ChildElement,Amm.Operator);Amm.Operator.Range=function(e){Amm.Operator.call(this);if(e!==undefined)this._setOperand("source",e)};Amm.Operator.Range.prototype={"Amm.Operator.Range":"__CLASS__",_sourceOperator:null,_sourceValue:null,_sourceExists:null,OPERANDS:["source"],supportsAssign:false,getReportsContentChanged:function(){return true},_setSource:function(e){this._setOperand("source",e)},_doEvaluate:function(e){Error("Call to abstract function")},toFunction:function(){Error("Call to abstract function")}};Amm.extend(Amm.Operator.Range,Amm.Operator);Amm.Operator.Range.RegExp=function(e,t){Amm.Operator.Range.call(this);if(e!==undefined)this._setOperand("source",e);if(t!==undefined)this._setOperand("regexp",t)};Amm.Operator.Range.RegExp.prototype={"Amm.Operator.Range.RegExp":"__CLASS__",_regexpOperator:null,_regexpValue:null,_regexpExists:null,OPERANDS:["source","regexp"],supportsAssign:false,_doEvaluate:function(e){var t=this._getOperandValue("source",e);var i=this._getOperandValue("regexp",e);if(!(t&&(t instanceof Array||t["Amm.Array"])&&i instanceof RegExp))return undefined;var r=[];for(var n=0,s=t.length;n<s;n++)if(i.exec(""+t[n])){r.push(t[n])}return r},toFunction:function(){var o=this._operandFunction("source");var a=this._operandFunction("regexp");return function(e){var t=o(e);var i=a(e);if(!(t&&(t instanceof Array||t["Amm.Array"])&&i instanceof RegExp))return undefined;var r=[];for(var n=0,s=t.length;n<s;n++)if(i.exec(""+t[n])){r.push(t[n])}return r}}};Amm.extend(Amm.Operator.Range.RegExp,Amm.Operator.Range);Amm.Operator.Range.Condition=function(e,t,i,r){this._map=[];Amm.Operator.Range.call(this,e);this._value=[];this._nonCacheableIteratorContexts={};if(i!==undefined)this.keyVar=i;if(r!==undefined)this.valueVar=r;var n=new Amm.Operator.Range.Iterator(t,i,r);this._setOperand("iterator",n)};Amm.Operator.Range.Condition.prototype={"Amm.Operator.Range.Condition":"__CLASS__",_iteratorOperator:null,_iteratorValue:null,_iteratorExists:null,_checkArrayChange:true,keyVar:null,valueVar:null,_nonCacheableIteratorContexts:null,_numNonCacheableIteratorContexts:0,_map:null,OPERANDS:["source","iterator"],STATE_SHARED:{keyVar:true,valueVar:true},supportsAssign:false,_setSource:function(e){this._setOperand("source",e)},_sourceEvents:function(e,t){},_sortMap:function(e){var t=e?this._map.slice(0,e):[];t.length=this._map.length;for(var i=e||0,r=this._map.length;i<r;i++){if(!this._map[i]){t.length--;continue}t[this._map[i].i]=this._map[i]}this._map=t},_doEvaluate:function(e){var t=[],i=true;for(var r=0,n=this._map.length;r<n;r++){if(i&&(!this._map[r]||this._map[r].i!==r)){i=false;this._sortMap(r);n=this._map.length;r--}var s=this._map[r].c;if(e){this._iteratorOperator.setContextId(s);this._map[r].v=this._iteratorOperator.getValue(e)}else{var o=this._iteratorOperator._contextId===s?this._iteratorOperator:this._iteratorOperator._contextState[s];if(o._hasValue)this._map[r].v=o._value;else{this._iteratorOperator.setContextId(s);this._map[r].v=this._iteratorOperator.getValue()}}if(this._map[r].v)t.push(this._map[r].o)}return t},toFunction:function(){var l=this._operandFunction("source");var h=this._operandFunction("iterator");var u=this.keyVar||"";var f=this.valueVar||"";var e=function(e){var t=l(e),i=t.length;if(!i)return[];var r=h.vars,n=r[u],s=r[f],o=[];for(var a=0;a<i;a++){r[u]=a;r[f]=t[a];if(h(e))o.push(t[a])}r[u]=n;r[f]=s;return o};return e},_clearIteratorContexts:function(){this._isEvaluating++;this._map=[];for(var e in this._iteratorOperator._contextState){if(e!=="0"&&this._iteratorOperator._contextState.hasOwnProperty(e)&&this._iteratorOperator._contextState[e]){this._iteratorOperator.deleteContext(e)}}this._isEvaluating--},notifyOperandChanged:function(e,t,i,r){if(r===this._iteratorOperator){if(r.parentContextId!==null&&r.parentContextId!==this._contextId)this.setContextId(r.parentContextId);if(this._lockChange)return;var n=r.index;if(this._map[n]&&this._map[n].c===r._contextId&&this._map[n].v!==t){this._map[n].v=t;if(!this._isEvaluating)this.evaluate()}return}Amm.Operator.Range.prototype.notifyOperandChanged.call(this,e,t,i,r)},_buildIteratorContexts:function(){this._isEvaluating++;var e=this._sourceValue,t=e.length,i=this._iteratorOperator;this._map.length=e.length;for(var r=0;r<t;r++){var n={};if(this.keyVar!==null)n[this.keyVar]=r;if(this.valueVar!==null)n[this.valueVar]=e[r];this._iteratorOperator.createContext({index:r,parentContextId:this._contextId,vars:n});this._map[r]={c:this._iteratorOperator._contextId,i:r,o:e[r],v:undefined}}this._isEvaluating--},_adjustIteratorContexts:function(e,t){var i=this._sourceValue||[];if(t===undefined)t=e.cut.length===e.insert.length||i.length<e.insert.length;if(!e.cut.length||!e.insert.length)t=false;if(!i.length){this._clearIteratorContexts();return}if((!e.cut.length||!t)&&e.insert.length===i.length){if(this._map.length)this._clearIteratorContexts();this._buildIteratorContexts();return}this._isEvaluating++;var r=e.index;var n,s=[],o;if(t){var a=[],l;l=Amm.Array.symmetricDiff(e.cut,e.insert,null,a);n=Amm.Array.findNonMatched(a,e.insert.length);o=[];for(var h=0,u=a.length;h<u;h++){if(a[h]===null)s.push(h);else if(a[h]!==h)o.push([h,a[h]])}}else{n=[];for(var h=0;h<e.cut.length;h++){s.push(h)}for(var h=0;h<e.insert.length;h++){n.push(h)}o=[]}var f=this._map,c;var _=e.insert.length-e.cut.length;if(_){for(var h=r+e.cut.length;h<f.length;h++){o.push([h-r,h+_-r])}}var m=this._iteratorOperator;for(var h=0,u=o.length;h<u;h++){c=f[o[h][0]+r];c.i=o[h][1]+r;if(c.c===m._contextId){m.index=c.i}else{m._contextState[c.c].index=c.i}if(this.keyVar){m.setContextId(c.c);m.setVars(c.i,this.keyVar)}}var d=s.length<n.length?s.length:n.length;for(var h=0;h<d;h++){c=f[s[h]+r];c.i=n[h]+r;c.o=e.insert[n[h]];m.setContextId(c.c);m.index=c.i;var p={};if(this.keyVar)p[this.keyVar]=c.i;if(this.valueVar)p[this.valueVar]=c.o;m.setVars(p)}for(var h=n.length;h<s.length;h++){m.deleteContext(f[s[h]+r].c);f[s[h]+r]=null}for(var h=s.length;h<n.length;h++){var p={};if(this.keyVar!==null)p[this.keyVar]=n[h]+r;if(this.valueVar!==null)p[this.valueVar]=e.insert[n[h]];m.createContext({index:n[h]+r,parentContextId:this._contextId,vars:p});f.push({c:m._contextId,i:n[h]+r,o:e.insert[n[h]],v:undefined})}this._map=f;this._sortMap();this._isEvaluating--},_sourceChange:function(e,t){var i=e&&e.length?e:null;var r=t&&t.length?t:null;var n,s,o;if(!r){if(!i)return;s=[];o=i;n=0}else if(!i){s=r?r.slice(0,r.length):[];o=[];n=0}else{var a=Amm.Array.smartDiff(r,i,null,true);if(!a)return;if(a[0]!=="splice")Error("Assertion - should receive only 'splice' event (spliceOnly === true)");s=a[2]?t.slice(a[1],a[1]+a[2]):[];o=a[3];n=a[1]}var l=this._makeChangeInfoForSplice(n,s,o);this._adjustIteratorContexts(l)},notifyOperandContentChanged:function(e,t,i){if(e==="source"){this._adjustIteratorContexts(t,true)}return Amm.Operator.prototype.notifyOperandContentChanged.call(this,e,t,i)},_constructContextState:function(){var e=Amm.Operator.Range.prototype._constructContextState.call(this);e._map=[];e._value=[];e._nonCacheableIteratorContexts={};return e},_propagateContext:function(e,t,i){if(t===this._iteratorOperator){if(this._contextId!==t.parentContextId){if(!i)this.setContextId(t.parentContextId);return}return}return Amm.Operator.Range.prototype._propagateContext.call(this,e,t,i)},notifyOperandNonCacheabilityChanged:function(e,t,i){if(i===this._iteratorOperator){if(i.parentContextId!==this._contextId)return;var r=i._contextId;if(t){this._nonCacheableIteratorContexts[r]=true;this._numNonCacheableIteratorContexts++}else{delete this._nonCacheableIteratorContexts[r];this._numNonCacheableIteratorContexts--}}return Amm.Operator.prototype.notifyOperandNonCacheabilityChanged.call(this,e,t,i)},_checkNonCacheableIterator:function(){for(var e in this._nonCacheableIteratorContexts){if(this._nonCacheableIteratorContexts.hasOwnProperty(e)){this._iteratorOperator.setContextId(e);this._iteratorOperator.checkForChanges()}}},_checkNonCacheableOperators:function(){if(this._hasNonCacheable<=!!this._nonCacheable)return;for(var e=0,t=this.OPERANDS.length;e<t;e++){var i="_"+this.OPERANDS[e]+"Operator";if(this[i]===this._iteratorOperator){if(this._numNonCacheableIteratorContexts)this._checkNonCacheableIterator();continue}if(!this[i])continue;if(this[i]._contextId!==this._contextId){this._propagateContext(i,this[i],true)}if(this[i]._hasNonCacheable){this[i].checkForChanges()}}}};Amm.extend(Amm.Operator.Range.Condition,Amm.Operator.Range);Amm.Operator.Range.All=function(e){Amm.Operator.Range.call(this,e)};Amm.Operator.Range.All.prototype={"Amm.Operator.Range.All":"__CLASS__",_sourceOperator:null,_sourceValue:null,_sourceExists:null,OPERANDS:["source"],supportsAssign:false,_doEvaluate:function(e){var t=this._getOperandValue("source",e);if(t===null)return[];if(t===undefined)return undefined;if(t instanceof Array||t["Amm.Array"])return t;return[t]},toFunction:function(){var i=this._operandFunction("source");return function(e){var t=i(e);if(t===null)return[];if(t===undefined)return undefined;if(t instanceof Array||t["Amm.Array"])return t;return[t]}}};Amm.extend(Amm.Operator.Range.All,Amm.Operator.Range);Amm.Operator.Range.Iterator=function(e,t,i){Amm.Operator.VarsProvider.call(this,e);this.keyVar=t||null;this.valueVar=i||null};Amm.Operator.Range.Iterator.prototype={"Amm.Operator.Range.Iterator":"__CLASS__",keyVar:null,valueVar:null,index:null,parentContextId:null,supportsAssign:false,STATE_SHARED:{keyVar:true,valueVar:true},_doEvaluate:function(e){var t=this._getOperandValue("operator",e);if(t===undefined)return t;return!!t}};Amm.extend(Amm.Operator.Range.Iterator,Amm.Operator.VarsProvider);Amm.Operator.Range.Slice=function(e,t,i){Amm.Operator.Range.call(this);if(e!==undefined)this._setOperand("source",e);if(t!==undefined)this._setOperand("start",t);if(i!==undefined)this._setOperand("end",i)};Amm.Operator.Range.Slice.prototype={"Amm.Operator.Range.Slice":"__CLASS__",_startOperator:null,_startValue:null,_startExists:null,OPERANDS:["source","start","end"],supportsAssign:false,_doEvaluate:function(e){var t=this._getOperandValue("source",e);var i=this._getOperandValue("start",e);var r=this._getOperandValue("end",e);if(!i&&typeof i!=="number")i=null;if(!r&&typeof r!=="number")r=null;if(t&&(t instanceof Array||t["Amm.Array"])){return t.slice(i,r)}return undefined},toFunction:function(){var n=this._operandFunction("source");var s=this._operandFunction("start");var o=this._operandFunction("end");return function(e){var t=n(e);var i=s(e);var r=o(e);if(!i&&typeof i!=="number")i=null;if(!r&&typeof r!=="number")r=null;if(t&&(t instanceof Array||t["Amm.Array"])){return t.slice(i,r)}return undefined}}};Amm.extend(Amm.Operator.Range.Slice,Amm.Operator.Range);Amm.Operator.Range.Index=function(e,t){Amm.Operator.Range.call(this);if(e!==undefined)this._setOperand("source",e);if(t!==undefined)this._setOperand("index",t)};Amm.Operator.Range.Index.prototype={"Amm.Operator.Range.Index":"__CLASS__",_indexOperator:null,_indexValue:null,_indexExists:null,OPERANDS:["source","index"],supportsAssign:false,_doEvaluate:function(e){var t=this._getOperandValue("source",e);var i=this._getOperandValue("index",e);if(t&&(t instanceof Array||t["Amm.Array"])){return t[i]}if(!i)return t;return undefined},toFunction:function(){var r=this._operandFunction("source");var n=this._operandFunction("index");return function(e){var t=r(e);var i=n(e);if(t&&(t instanceof Array||t["Amm.Array"])){return t[i]}if(!i)return t;return undefined}}};Amm.extend(Amm.Operator.Range.Index,Amm.Operator.Range);Amm.Operator.Binary=function(e,t,i){Amm.Operator.call(this);this._setOperator(t);if(e!==undefined)this._setOperand("left",e);if(i!==undefined)this._setOperand("right",i)};Amm.Operator.Binary.BINARY_OPERATORS={"!==":function(e,t){return e!==t},"===":function(e,t){return e===t},"==":function(e,t){return e==t},"!=":function(e,t){return e!=t},"+":function(e,t){return e+t},"-":function(e,t){return e-t},"*":function(e,t){return e*t},"%":function(e,t){return e%t},"/":function(e,t){return e/t},">":function(e,t){return e>t},"<":function(e,t){return e<t},"<=":function(e,t){return e<=t},">=":function(e,t){return e>=t},"&":function(e,t){return e&t},"|":function(e,t){return e|t},"&&":function(e,t){return e&&t},"||":function(e,t){return e||t}};Amm.Operator.Binary.prototype={"Amm.Operator.Binary":"__CLASS__",_leftOperator:null,_leftValue:null,_leftExists:null,_operator:null,_operatorFn:null,_rightOperator:null,_rightValue:null,_rightExists:null,OPERANDS:["left","right"],STATE_SHARED:{_operator:true,_operatorFn:true},supportsAssign:false,_setOperator:function(e){var t=Amm.Operator.Binary.BINARY_OPERATORS[e];if(!t)Error("Unsupported binary operator type: '"+e+"'");this._operator=e;this._operatorFn=t},_doEvaluate:function(e){var t=this._getOperandValue("left",e);var i=this._getOperandValue("right",e);return this._operatorFn(t,i)},setLeft:function(e){this._setOperand("left",e)},setRight:function(e){this._setOperand("right",e)},toFunction:function(){var t=this._operandFunction("left");var i=this._operandFunction("right");var r=this._operatorFn;return function(e){return r(t(e),i(e))}}};Amm.extend(Amm.Operator.Binary,Amm.Operator);Amm.Operator.FunctionCall=function(e,t,i){Amm.Operator.call(this);if(e!==undefined)this._setOperand("func",e);if(t!==undefined)this._setOperand("args",t);this._cacheability=!!i;if(i!==undefined&&i!==null&&!i){this._setNonCacheable(Amm.Operator.NON_CACHEABLE_VALUE)}};Amm.Operator.FunctionCall.prototype={"Amm.Operator.FunctionCall":"__CLASS__",_funcOperator:null,_funcValue:null,_funcExists:null,_argsOperator:null,_argsValue:null,_argsExists:null,_cacheability:null,OPERANDS:["func","args"],STATE_SHARED:{_cacheability:true},getReportsContentChanged:function(){return this._cacheability},_doEvaluate:function(e){var t=this._getOperandValue("func",e);if(!t)return;if(typeof t!=="function")Error("cannot call: operand is not a function");var i=this._getOperandValue("args",e);if(i===null||i===undefined||i instanceof Array&&!i.length){return t()}else{if(i instanceof Array)return t.apply(window,i);else return t(i)}},toFunction:function(){var r=this._operandFunction("func");var n=this._operandFunction("args");return function(e){var t=r(e);if(!t)return;if(typeof t!=="function")Error("cannot call: operand is not a function");var i=n(e);if(i===null||i===undefined||i instanceof Array&&!i.length){return t()}else{if(i instanceof Array)return t.apply(window,i);else return t(i)}}},_isValueObservable:function(e,t){if(e==="args")return false;return Amm.Operator.prototype._isValueObservable.call(this,e,t)}};Amm.extend(Amm.Operator.FunctionCall,Amm.Operator);Amm.Operator.ScopeElement=function(e,t,i,r,n){Amm.Operator.call(this);this._componentOnly=r;if(e!==undefined)this._setOperand("origin",e);if(t!==undefined)this._setOperand("id",t);if(i!==undefined)this._setOperand("range",i);if(n!==undefined)this._allElements=!!n};Amm.Operator.ScopeElement.prototype={"Amm.Operator.ScopeElement":"__CLASS__",_componentOnly:false,_allElements:false,_originOperator:null,_originValue:null,_originExists:null,_idOperator:null,_idValue:null,_idExists:null,_rangeOperator:null,_rangeValue:null,_rangeExists:null,_component:null,OPERANDS:["origin","id","range"],STATE_SHARED:{_componentOnly:true},supportsAssign:false,getReportsContentChanged:function(){return true},_originEvents:function(e,t){if(t&&t["Amm.Element"]){this._unsub(t,"closestComponentChange")}if(e&&e["Amm.Element"]){this._sub(e,"closestComponentChange",this._originComponentChange)}},_originChange:function(e){if(e&&e["Amm.Element"])this._setComponent(e.getClosestComponent())},_originComponentChange:function(e){this._setComponent(e)},_rangeChange:function(e){this._checkArrayChange=e==="*"},_setComponent:function(e){if(!e)e=null;var t=this._component;if(t===e)return;if(t){this._unsub(t,"acceptedInScope");this._unsub(t,"rejectedInScope");this._unsub(t,"renamedInScope");this._unsub(t,"componentStackChange");if(this._componentOnly){this._unsub(t,"childComponentStatusChangeInScope")}}this._component=e;if(this._component){var i={acceptedInScope:this._acceptedInScope,rejectedInScope:this._rejectedInScope,renamedInScope:this._renamedInScope,componentStackChange:this._componentStackChange};if(this._componentOnly){i["childComponentStatusChangeInScope"]=this._childComponentStatusChangeInScope}this._sub(e,i)}if(this._isEvaluating)return;this.evaluate()},_acceptedInScope:function(e,t){if(this._isEvaluating)return;if(this._allElements){this.evaluate();return}if(!this._idExists||!this._idValue)return;var i=false;for(var r=0,n=t.length;r<n;r++){if(t[r].getId()===this._idValue){i=true;break}}if(i)this.evaluate()},_rejectedInScope:function(e,t){return this._acceptedInScope(e,t)},_renamedInScope:function(e,t,i,r){if(this._isEvaluating)return;if(this._allElements){this.evaluate();return}if(!this._idExists||!this._idValue)return;if(i===this._idValue||r===this._idValue)this.evaluate()},_componentStackChange:function(){if(this._isEvaluating)return;this.evaluate()},_childComponentStatusChangeInScope:function(e,t,i){if(this._isEvaluating)return;if(this._allElements){this.evaluate();return}if(!this._idExists||!this._idValue)return;if(t.getId()===this._idValue||t.getInternalId()===this._idValue)this.evaluate()},setOrigin:function(e){this._setOperand("origin",e)},setId:function(e){this._setOperand("id",e)},_doEvaluate:function(e){var t=this._getOperandValue("range",e);var i=this._getOperandValue("id",e);var r=this._getOperandValue("origin",e);return Amm.Operator.ScopeElement._eval(r,i,t,this._componentOnly,this._allElements)},toFunction:function(){var n=this._operandFunction("origin");var s=this._operandFunction("id");var o=this._operandFunction("range");var a=this._allElements;var l=this._componentOnly;return function(e){var t=o(e);var i=s(e);var r=n(e);return Amm.Operator.ScopeElement._eval(r,i,t,l,a)}}};Amm.Operator.ScopeElement._eval=function(e,t,i,r,n){var s=i==="*"||!t&&n;var o=s?[]:undefined;if(!e||!e["Amm.Element"])return o;if(!t&&!n)return o;var a=e.getClosestComponent();if(!a)return o;if(r){var l;if(!t&&n){var h=a.getAllNamedElements();l=[];for(var u in h)if(h.hasOwnProperty(u)){l=l.concat(h[u])}}else{l=a.getAllNamedElements(t,true)}var f=[];for(var u=0;u<l.length;u++)if(l[u]["Component"]&&l[u].getIsComponent())f.push(l[u]);return s?f:f[i]}if(s)return a.getAllNamedElements(t,true);return a.getNamedElement(t,i,true)};Amm.extend(Amm.Operator.ScopeElement,Amm.Operator);Amm.Operator.Conditional=function(e,t,i){Amm.Operator.call(this);if(e!==undefined)this._setOperand("condition",e);if(t!==undefined)this._setOperand("trueValue",t);if(i!==undefined)this._setOperand("falseValue",i)};Amm.Operator.Conditional.prototype={"Amm.Operator.Condition":"__CLASS__",_conditionOperator:null,_conditionValue:null,_conditionExists:null,_trueValueOperator:null,_trueValueValue:null,_trueValueExists:null,_falseValueOperator:null,_falseValueValue:null,_falseValueExists:null,OPERANDS:["condition","trueValue","falseValue"],supportsAssign:false,_doEvaluate:function(e){var t=this._getOperandValue("condition",e);var i=t?this._getOperandValue("trueValue",e):this._getOperandValue("falseValue",e);return i},setCondition:function(e){this._setOperand("condition",e)},setTrueValue:function(e){this._setOperand("trueValue",e)},setFalseValue:function(e){this._setOperand("falseValue",e)},toFunction:function(){var t=this._operandFunction("condition");var i=this._operandFunction("trueValue");var r=this._operandFunction("falseValue");return function(e){return t(e)?i(e):r(e)}}};Amm.extend(Amm.Operator.Conditional,Amm.Operator);Amm.Operator.Var=function(e){Amm.Operator.call(this);if(e!==undefined)this._setOperand("varName",e)};Amm.Operator.Var.prototype={"Amm.Operator.Var":"__CLASS__",_varNameOperator:null,_varNameValue:null,_varNameExists:null,_varsProvider:null,_varsProviderContextId:null,OPERANDS:["varName"],STATE_SHARED:{_varsProvider:true},supportsAssign:true,notifyProviderVarsChange:function(e,t,i,r){if(this._varNameValue&&i&&this._varNameValue!==i){Error("WTF - we shouldn't received wrong varsChange notification")}if(this._expression&&this._expression.getUpdateLevel()){this._expression.queueUpdate(this)}else{this.evaluate()}},setExpression:function(e){Amm.Operator.prototype.setExpression.call(this,e);this._varsProvider=e;this._varsProviderContextId=e._contextId;for(var t=this._parent;t;t=t._parent){if(t["Amm.Operator.VarsProvider"]){this._varsProvider=t;this._varsProviderContextId=t._contextId;break}}if(this._varsProvider&&this._varNameExists&&this._varNameValue){this._varsProvider.addConsumer(this,this._varNameValue+"")}},_initContextState:function(e,t){Amm.Operator.prototype._initContextState.call(this,e,t);if(t&&this._varsProvider){this._varsProviderContextId=this._varsProvider._contextId}},_doEvaluate:function(e){var t=this._getOperandValue("varName",e);if(!t)return;if(!this._varsProvider){this._hasValue=false;return}var i;if(this._varsProviderContextId&&this._varsProviderContextId!==this._varsProvider._contextId){i=this._varsProvider._contextId;this._varsProvider.setContextId(this._varsProviderContextId)}var r=this._varsProvider.getVars(t);if(i)this._varsProvider.setContextId(i);return r},_varNameChange:function(e,t,i){if(!this._varsProvider)return;var r;if(this._varsProviderContextId&&this._varsProviderContextId!==this._varsProvider._contextId){r=this._varsProvider._contextId;this._varsProvider.setContextId(this._varsProviderContextId)}if(t)this._varsProvider.deleteConsumer(this,t);if(e)this._varsProvider.addConsumer(this,e);if(r)this._varsProvider.setContextId(r)},_doSetValue:function(e,t){var i=this._getOperandValue("varName");if(!i&&i!==0)return"`varName` is empty";if(!this._varsProvider)return"expression not provided";if(t)return"";var r;if(this._varsProviderContextId&&this._varsProviderContextId!==this._varsProvider._contextId){r=this._varsProvider._contextId;this._varsProvider.setContextId(this._varsProviderContextId)}this._varsProvider.setVars(e,i);if(r)this._varsProvider.setContextId(r)},setVarName:function(e){this._setOperand("varName",e)},toFunction:function(){var i=this._operandFunction("varName");return function(e){var t=i(e);if(!t)return;return e.vars[t]}},assignmentFunction:function(){var r=this._operandFunction("varName");return function(e,t){var i=r(e);if(!i&&i!==0)return"`varName` is empty";e.vars[i]=t}},_partialCleanup:function(){if(this._expression&&this._varsProvider){this._expression.unsubscribeOperator(this._expression,"varsChange",this)}if(this._varsProvider&&this._varsProvider.hasContext(this._varsProviderContextId)){var e;if(this._varsProviderContextId&&this._varsProviderContextId!==this._varsProvider._contextId){e=this._varsProvider._contextId;this._varsProvider.setContextId(this._varsProviderContextId)}this._varsProvider.deleteConsumer(this,this._varNameValue+"");if(e)this._varsProvider.setContextId(e)}Amm.Operator.prototype._partialCleanup.call(this)}};Amm.extend(Amm.Operator.Var,Amm.Operator);Amm.Operator.ExpressionThis=function(){Amm.Operator.call(this)};Amm.Operator.ExpressionThis.prototype={"Amm.Operator.ExpressionThis":"__CLASS__",setExpression:function(e){Amm.Operator.prototype.setExpression.call(this,e);this._sub(e,"expressionThisChange");this._defaultHandler()},_initContextState:function(e,t){Amm.Operator.prototype._initContextState.call(this,e,t);if(t&&this._expression){this._sub(this._expression,"expressionThisChange");this._defaultHandler()}},_doEvaluate:function(e){if(!this._expression){this._hasValue=false;return}return this._expression.getExpressionThis()},toFunction:function(){return function(e){return e.expressionThis}}};Amm.extend(Amm.Operator.ExpressionThis,Amm.Operator);Amm.Operator.List=function(e){this.OPERANDS=[];Amm.Operator.call(this);if(e!==undefined)this.setItems(e)};Amm.Operator.List.prototype={"Amm.Operator.List":"__CLASS__",_length:0,OPERANDS:null,STATE_SHARED:{_length:true},_getContextState:function(){var e=Amm.Operator.prototype._getContextState.call(this);for(var t=0;t<this._length;t++){var i="_"+t+"Value",r="_"+t+"Operator",n="_"+t+"Exists",s="_"+t+"Observe";e[i]=this[i];e[0]=this[r];e[n]=this[n];e[s]=this[s]}return e},getReportsContentChanged:function(){return true},setItems:function(e){if(!(e instanceof Array))Error("items must be an Array");var t=this._length,i=e.length;for(var r=i;r<t;r++){var n="_"+r+"Value",s="_"+r+"Operator",o="_"+r+"Exists",a="_"+r+"Observe";if(this[s])this[s].cleanup();delete this[s];delete this[n];delete this[o];delete this[a]}this._isEvaluating++;this.OPERANDS=[];for(var r=0;r<i;r++){this._setOperand(r,e[r]);this.OPERANDS.push(r)}this._length=i;this._isEvaluating--},_doEvaluate:function(e){var t=[],i=!!this._value&&this._length===this._value.length,r;for(var n=0;n<this._length;n++){t.push(r=this._getOperandValue(n,e));i=i&&this._value[n]===r}if(i){return this._value}return t},toFunction:function(){var r=[];for(var e=0;e<this._length;e++)r.push(this._operandFunction(e));var n=r.length;return function(e){var t=[];for(var i=0;i<n;i++)t.push(r[i]());return t}}};Amm.extend(Amm.Operator.List,Amm.Operator);Amm.Validator.Function=function(e){Amm.Validator.call(this,e)};Amm.Validator.Function.prototype={"Amm.Validator.Function":"__CLASS__",element:null,func:null,message:"lang.Amm.Validator.Function.msg",getError:function(e,t){var i={message:null},r=null;if(typeof this.func==="function"){r=this.func(e,t,i,this.element);if(typeof r==="string"){r=Amm.translate(r,"%field",t)}else if(!r&&r!==undefined){r=Amm.translate(i.message||this.message,"%field",t)}else{return}}else{Error("Amm.Validator.Function: this.`func` not set (or not a function)")}return r}};Amm.extend(Amm.Validator.Function,Amm.Validator);Amm.defineLangStrings({"lang.Amm.Validator.Function.msg":"%field is invalid"});Amm.Validator.Number=function(e){Amm.Validator.call(this,e)};Amm.Validator.Number.prototype={"Amm.Validator.Number":"__CLASS__",allowEmpty:true,strict:true,allowFloat:true,gt:null,ge:null,lt:null,le:null,msgMustBeNumber:"lang.Amm.Validator.Number.msgMustBeNumber",msgMustBeInteger:"lang.Amm.Validator.Number.msgMustBeInteger",msgMustBeGt:"lang.Amm.Validator.Number.msgMustBeGt",msgMustBeGe:"lang.Amm.Validator.Number.msgMustBeGe",msgMustBeLt:"lang.Amm.Validator.Number.msgMustBeLt",msgMustBeLe:"lang.Amm.Validator.Number.msgMustBeLe",getError:function(e,t){var i=this.isEmpty(e);if(i){if(this.allowEmpty)return;return this._msg(this.msgMustBeNumber,"%field",t)}var r=parseInt(e);var n=parseFloat(e);var s=n!=e&&r!=e;if(isNaN(r)||this.strict&&s){return this._msg(this.msgMustBeNumber,"%field",t)}if(r!=n&&!this.allowFloat){return this._msg(this.msgMustBeInteger,"%field",t)}var o=this.allowFloat?n:r;var a;a=this.gt;if(a!==null&&!(o>a)){return this._msg(this.msgMustBeGt,"%field",t,"%val",a)}a=this.ge;if(a!==null&&!(o>=a)){return this._msg(this.msgMustBeGe,"%field",t,"%val",a)}a=this.lt;if(a!==null&&!(o<a)){return this._msg(this.msgMustBeLt,"%field",t,"%val",a)}a=this.le;if(a!==null&&!(o<=a)){return this._msg(this.msgMustBeLe,"%field",t,"%val",a)}}};Amm.extend(Amm.Validator.Number,Amm.Validator);Amm.defineLangStrings({"lang.Amm.Validator.Number.msgMustBeNumber":"%field must be a number","lang.Amm.Validator.Number.msgMustBeInteger":"%field must be an integer number","lang.Amm.Validator.Number.msgMustBeGt":"%field must be higher than %val","lang.Amm.Validator.Number.msgMustBeGe":"%field must not be less than %val","lang.Amm.Validator.Number.msgMustBeLt":"%field must be less than %val","lang.Amm.Validator.Number.msgMustBeLe":"%field must not exceed %val"});Amm.Validator.Required=function(e){Amm.Validator.call(this,e)};Amm.Validator.Required.prototype={"Amm.Validator.Required":"__CLASS__",message:"lang.Amm.Validator.Required.msg",getError:function(e,t){var i=this.isEmpty(e);if(!i)return;return this._msg(this.message,"%field",t)}};Amm.extend(Amm.Validator.Required,Amm.Validator);Amm.defineLangStrings({"lang.Amm.Validator.Required.msg":"%field is required"});Amm.Instantiator.Proto=function(e,t,i){Amm.Instantiator.call(this);if(typeof e!=="object"||e&&!e.proto){e={proto:e}}if(e&&Amm.Builder.isPossibleBuilderSource(e.proto)){this.isElement=true}if(t)e.assocProperty=t;if(i)e.revAssocProperty=i;Amm.init(this,e)};Amm.Instantiator.Proto.prototype={"Amm.Instantiator.Proto":"__CLASS__",proto:null,isElement:false,assocProperty:null,revAssocProperty:null,construct:function(e){if(!this.proto)throw Error("`proto` must be set");var t=this.proto;var i;if(this.isElement)i=new Amm.Element(t);else i=Amm.constructInstance(t,null);if(this.assocProperty)Amm.setProperty(i,this.assocProperty,e);if(this.revAssocProperty)Amm.setProperty(e,this.revAssocProperty,i);return i},destruct:function(e){if(e.cleanup){e.cleanup()}}};Amm.extend(Amm.Instantiator.Proto,Amm.Instantiator);Amm.Instantiator.Variants=function(e){this._prototypes={};this._matches=[];this._objects=[];this._instances=[];Amm.Instantiator.call(this);Amm.WithEvents.call(this,e)};Amm.Instantiator.Variants.prototype={"Amm.Instantiator.Variants":"__CLASS__",_defaultPrototype:null,_prototypes:null,_overrideDefaultPrototype:false,_matches:null,_objects:null,_instances:null,_filter:null,_filterIsAggregate:false,_subscribeFilter:true,_allowNullInstance:false,_assocProperty:null,_revAssocProperty:null,setPrototypes:function(e,t){if(!e||typeof e!=="object")throw Error("`prototypes` must be a non-null object");if(t!==undefined){this._prototypes[t]=Amm.override({},e);return}this._prototypes=Amm.override({},e)},getPrototypes:function(e){if(e===undefined)return this._prototypes;return this._prototypes[e]},setDefaultPrototype:function(e){if(typeof e!=="object"){throw Error("`defaultPrototype` must be a null or an object")}if(!e){this._defaultPrototype=null}else{this._defaultPrototype=Amm.override({},e)}},getDefaultPrototype:function(){return this._defaultPrototype},setOverrideDefaultPrototype:function(e){e=!!e;var t=this._overrideDefaultPrototype;if(t===e)return;this._overrideDefaultPrototype=e;return true},getOverrideDefaultPrototype:function(){return this._overrideDefaultPrototype},construct:function(e,t){var i=this._findObject(e);if(t===undefined&&this._filter&&this._subscribeFilter&&i>=0){t=this._filter.getMatch(e)}else if(t===undefined&&this._filter){t=this._filter.evaluateMatch(e)}var r=this._build(e,t);if(!e)return r;if(i>=0){this._matches[i]=t}else{i=this._objects.length;this._objects.push(e);this._matches.push(t);this._instances[i]=[];this._subscribeObject(e);if(this._filter&&this._subscribeFilter){this._filter.observeObject(e)}}if(!r&&this._instances[i][0]!==null){this._instances[i].unshift(null)}if(r){if(this._instances[i][0]===null){this._instances[i].splice(0,1)}this._instances[i].push(r);this._subscribeInstance(r)}return r},_build:function(e,t){var i,r=this._defaultPrototype;if(this._prototypes[t]){i=this._prototypes[t];if(Amm.Builder.isPossibleBuilderSource(i)){i=Amm.Builder.calcPrototypeFromSource(i,false)}if(r&&this._overrideDefaultPrototype){r=this._defaultPrototype;if(Amm.Builder.isPossibleBuilderSource(r)){r=Amm.Builder.calcPrototypeFromSource(r,false)}i=Amm.override({},r,i)}else{i=Amm.override({},i)}}else{if(!this._defaultPrototype){if(!this._allowNullInstance){throw Error("No prototype for match '"+t+"' and `defaultPrototype` not set!")}return null}if(Amm.Builder.isPossibleBuilderSource(r)){r=Amm.Builder.calcPrototypeFromSource(r,false)}else{i=Amm.override({},r)}}var n=this._assocProperty,s=this._revAssocProperty;if("__assocProperty"in i){n=i.__assocProperty;delete i.__assocProperty}if("__revAssocProperty"in i){s=i.__revAssocProperty;delete i.__revAssocProperty}var o=Amm.constructInstance(i);if(n)Amm.setProperty(o,n,e);if(s&&typeof e==="object"&&e){Amm.setProperty(e,s,o)}return o},destruct:function(e){this.forgetInstance(e);if(e.cleanup){e.cleanup()}},setMatches:function(e,t){if(!e.length||!this._objects.length)return;if(t.length!==e.length)throw Exception("`objects` and `matches` must have same length (are: "+e.length+" and "+t.length+")");var i=[],r=[];var n=Amm.Array.findDuplicates([].concat(this._objects,e),false,null,this._objects.length);if(!n.length)return;var s,o,a,l;for(s=0,o=n.length;s<o;s++){var a=n[s][0],l=n[s][1]-this._objects.length;if(this._matches[a]===t[l])continue;var h=this._matches[a]in this._prototypes,u=t[l]in this._prototypes;this._matches[a]=t[l];if(!u&&!h)continue;i.push(this._objects[a]);r.push(this._matches[a])}if(!i.length)return;this.outNeedRebuild(i,r,this)},outNeedRebuild:function(e,t,i){this._out("needRebuild",e,t,i)},cleanup:function(){if(this._filter)this.setFilter(null);Amm.WithEvents.prototype.cleanup.call(this);this._objects=[];this._matches=[];for(var e=0,t=this._instances.length;e<t;e++){this._instances[e]=[]}this._instances=[];this._prototypes={};this._defaultPrototype={}},setFilter:function(e){var t=false;if(e){if(typeof e==="object"&&!e["Amm.Filter"]){e=Amm.constructInstance(e,"Amm.Filter");t=true}}else{e=null}var i=this._filter;if(i===e)return;if(this._filter){if(this._filterIsAggregate)this._filter.cleanup();else if(this._subscribeFilter)this._subFilter(true)}this._filterIsAggregate=t;this._filter=e;if(this._filter&&this._subscribeFilter){this._subFilter();this.setMatches(this._filter.getObservedObjects(),this._filter.getMatches())}return true},getFilter:function(){return this._filter},setSubscribeFilter:function(e){e=!!e;var t=this._subscribeFilter;if(t===e)return;this._subscribeFilter=e;if(this._filter)this._subFilter(!this._subscribeFilter);return true},getSubscribeFilter:function(){return this._subscribeFilter},getFilterIsAggregate:function(){return this._filterIsAggregate},hasObject:function(e){return this._findObject(e)>=0},hasInstance:function(e){return!!this._findInstance(e)},forgetObject:function(e){var t=this._findObject(e);if(t<0)return;this._forgetObject(t);return true},forgetInstance:function(e){if(!e)return;var t=this._findInstance(e);if(!t)return;this._unsubscribeInstance(e);this._instances[t[0]].splice(t[1],1);if(!this._instances[t[0]].length){this._forgetObject(t[0])}return true},getInstances:function(e){var t=this._findObject(e);if(t<0)return[];return[].concat(this._instances[t])},_subFilter:function(e){if(e){this._filter.unsubscribe("matchesChange",this.handleFilterMatchesChange,this);this._filter.setObservedObjects([]);return}this._filter.setObservedObjects(this._objects);this._filter.subscribe("matchesChange",this.handleFilterMatchesChange,this)},handleFilterMatchesChange:function(e,t,i){var r=[],n=[],s=[];for(var o=0,a=e.length;o<a;o++){if(i[o]===undefined||t[o]===undefined)continue;r.push(e[o]);n.push(t[o])}if(r.length)this.setMatches(r,n)},_findObject:function(e){if(typeof e!=="object"||!e)return-1;return Amm.Array.indexOf(e,this._objects)},_findInstance:function(e){var t,i,r,n;for(t=0,r=this._instances.length;t<r;t++){for(i=0,n=this._instances[t].length;i<n;i++){if(this._instances[t][i]===e)return[t,i]}}return null},_forgetObject:function(e){var t=this._objects[e],i=this._instances[e];if(this._filter)this._filter.unobserveObject(t);this._objects.splice(e,1);this._instances.splice(e,1);if(i.length)this._unsubscribeInstance(i,true);this._unsubscribeObject(t)},_subscribeObject:function(e){if(!e||typeof e!=="object")return;if(e["Amm.WithEvents"]&&e.hasEvent("cleanup")){e.subscribe("cleanup",this._handleObjectCleanup,this)}},_unsubscribeObject:function(e){if(e["Amm.WithEvents"]&&e.hasEvent("cleanup")){e.unsubscribe("cleanup",this._handleObjectCleanup,this)}},_forgetObjectsWithoutInstances:function(){for(var e=this._objects.length-1;e>=0;e--){if(this._instances[e][0]!==null)continue;this._instances[e].splice(0,1);if(this._instances[e].length)continue;this._forgetObject(e)}},_unsubscribeInstance:function(e,t){if(t){for(var i=0,r=e.length;i<r;i++)this._unsubscribeInstance(e[i]);return}if(e["Amm.WithEvents"]&&e.hasEvent("cleanup")){e.unsubscribe("cleanup",this._handleInstanceCleanup,this)}},_subscribeInstance:function(e){if(e["Amm.WithEvents"]&&e.hasEvent("cleanup")){e.subscribe("cleanup",this._handleInstanceCleanup,this)}},_handleObjectCleanup:function(){this.forgetObject(Amm.event.origin)},_handleInstanceCleanup:function(){this.forgetInstance(Amm.event.origin)},setAllowNullInstance:function(e){e=!!e;var t=this._allowNullInstance;if(t===e)return;this._allowNullInstance=e;if(!e)this._forgetObjectsWithoutInstances();return true},getAllowNullInstance:function(){return this._allowNullInstance},setAssocProperty:function(e){if(!e)e=null;var t=this._assocProperty;if(t===e)return;this._assocProperty=e;return true},getAssocProperty:function(){return this._assocProperty},setRevAssocProperty:function(e){if(!e)e=null;var t=this._revAssocProperty;if(t===e)return;this._revAssocProperty=e;return true},getRevAssocProperty:function(){return this._revAssocProperty}};Amm.extend(Amm.Instantiator.Variants,Amm.Instantiator);Amm.extend(Amm.Instantiator.Variants,Amm.WithEvents);Amm.Selection=function(e){Amm.Collection.call(this,e)};Amm.Selection.ERR_NOT_IN_OBSERVED_COLLECTION="Not in observed collection.";Amm.Selection.prototype={"Amm.Selection":"__CLASS__",_multiple:true,_valueProperty:null,_selectedProperty:null,_sameOrder:false,_collection:null,_unselectOnItemValueChange:false,_cacheValue:true,_value:undefined,_suppressValueChangeEvent:0,_selfSubscribed:false,setCollection:function(e){var t=this._collection;var i;if(t===e)return;if(t){this._unobserveCollection()}this._collection=e;if(this._selectedProperty){i=this._findSelectedItems()}else{i=[]}if(!this._multiple)i.splice(1,i.length);this.setItems(i);this.outCollectionChange(e,t);if(e){this._observeCollection()}return true},getCollection:function(){return this._collection},outCollectionChange:function(e,t){this._out("collectionChange",e,t)},setMultiple:function(e){e=!!e;var t=this._multiple;if(t===e)return;var i=this._value===undefined?this.getValue(true):this._value;this._multiple=e;if(!e&&this.length>1){this._suppressValueChangeEvent++;this.splice(1,this.length-1);this._suppressValueChangeEvent--}var r=this.getValue(true);if(this._valueProperty)this._value=r;if(this._subscribers.valueChange){this.outValueChange(r,i)}this.outMultipleChange(e,t);return true},getMultiple:function(){return this._multiple},outMultipleChange:function(e,t){this._out("multipleChange",e,t)},setValue:function(e){this.beginUpdate();var t;if(e===undefined||e===null){t=true;if(this._multiple)e=[]}else{if(e instanceof Array||e["Amm.Array"]){t=!e.length}else{e=[e]}}var i;if(t)i=[];else i=this._findItemsWithValue(e);this.setItems(i);this.endUpdate()},getValue:function(e){if(!this.length)return this._multiple?[]:null;var t;if(!this._valueProperty){t=this.getItems();if(!this._multiple){t=t[0]}}else{if(!this._cacheValue||e||this._value===undefined){t=this._value=this._collectValueProperty(this,true)}else{t=this._value}}return t},outValueChange:function(e,t){if(this._suppressValueChangeEvent||this._updateLevel)return;this._out("valueChange",e,t)},setValueProperty:function(e){var t=this._valueProperty;if(t===e)return;if(this._collection&&t)this._unsubscribeCollectionItems(this._collection,false,true);this._valueProperty=e;this.clearItems();if(!this._valueProperty)this._value=undefined;if(this._collection&&e)this._subscribeCollectionItems(this._collection,false,true);return true},getValueProperty:function(){return this._valueProperty},setCacheValue:function(e){e=!!e;var t=this._cacheValue;if(t===e)return;this._cacheValue=e;return true},getCacheValue:function(){return this._cacheValue},setUnselectOnItemValueChange:function(e){var t=this._unselectOnItemValueChange;if(t===e)return;this._unselectOnItemValueChange=e;return true},getUnselectOnItemValueChange:function(){return this._unselectOnItemValueChange},setSelectedProperty:function(e){var t=this._selectedProperty;if(t===e)return;if(t&&this._collection)this._unsubscribeCollectionItems(this._collection,true);this._selectedProperty=e;if(e&&this._collection){if(!this.length)this.setItems(this._findSelectedItems());else this._setItemsSelectedProperty();this._subscribeCollectionItems(this._collection,true)}return true},getSelectedProperty:function(){return this._selectedProperty},setSameOrder:function(e){e=!!e;var t=this._sameOrder;if(t===e)return;this._sameOrder=e;if(this._sameOrder){this.setSortProperties(null);this.setSortFn(null);if(this._collection){this._collection.subscribe("reorderItems",this._handleCollectionReorderItems,this);this._maintainOrder()}}else{if(this._collection){this._collection.unsubscribe("reorderItems",this._handleCollectionReorderItems,this)}}return true},getSameOrder:function(){return this._sameOrder},sort:function(e){if(this._sameOrder)Error("Refusing to sort() when `sameOrder` === true");return Amm.Collection.prototype.sort.call(this,e)},_collectValueProperty:function(e,t,i){e=e||this;var r=[],n=e.length;for(var s=0;s<n;s++){var o=e[s];if(o!==i){var a=Amm.getProperty(o,this._valueProperty);if(a!==undefined&&a!==null)r.push(a)}}if(t&&!this._multiple)r=r.length?r[0]:null;return r},_findItemsWithValue:function(e){if(!this._multiple&&!(e instanceof Array)){if(e===undefined||e===null)e=[];else e=[e]}if(!this._collection||!e.length)return[];if(!this._valueProperty)return this._collection.intersect(e,true);var t=[];for(var i=0,r=this._collection.length;i<r;i++){var n=this._collection[i],s=Amm.getProperty(n,this._valueProperty);if(Amm.Array.indexOf(s,e)>=0)t.push(n)}return t},_findSelectedItems:function(){if(!this._collection)return[];var e=[];for(var t=0,i=this._collection.length;t<i;t++){var r=this._collection[t],n=Amm.getProperty(r,this._selectedProperty);if(n)e.push(r)}return e},_setItemsSelectedProperty:function(){for(var e=0,t=this._collection.length;e<t;e++){Amm.setProperty(this._collection[e],this._selectedProperty,this.hasItem(this._collection[e]))}},_handleCollectionSpliceItems:function(e,t,i){var r=Amm.Array.symmetricDiff(t,i);var n=Amm.Array.symmetricDiff(i,t);this._unsubscribeCollectionItems(r);this._subscribeCollectionItems(n);var s=this.intersect(r,true);var o=Amm.Array.diff(n,this);if(!o.length&&!s.length)return;var a=o.length&&(this._selectedProperty||this._valueProperty&&this.length&&this._multiple);this.beginUpdate();for(var l=0,h=s.length;l<h;l++)this.reject(s[l],false);if(a){var u=[];var f=this._valueProperty?this.getValue():null;for(var l=0,h=o.length;l<h;l++){var c=o[l];if(this._selectedProperty&&Amm.getProperty(c,this._selectedProperty))u.push(c);else if(this._valueProperty&&f&&Amm.Array.indexOf(Amm.getProperty(c,this._valueProperty),f)>=0)u.push(c)}if(u.length){this.acceptMany(u);if(this._sameOrder)this._maintainOrder(true)}}this.endUpdate()},_handleCollectionReorderItems:function(e,t,i){if(!this.length)return;var r=this.getItems();var n=Amm.Array.findDuplicates(r.concat(this._collection.slice(e,e+t)),true,undefined,this.length);if(n.length){this._maintainOrder()}},_maintainOrder:function(e){if(!this._sameOrder||!this.length)return;var t=this.getItems(),i=this._collection.intersect(t,true);var r=null,n=null;if(t.length!==i.length){console.warn("We have problem: it turned some elements disappeared from `collection` when only order might change");this.setItems(i);return}for(var s=0,o=t.length;s<o;s++){if(t[s]!==i[s]){if(r===null)r=s;n=s;this[s]=i[s]}}if(r!==null&&!e){if(this._indexProperty)this._reportIndexes(t,r,n+1);if(!this._updateLevel)this.outReorderItems(r,n-r+1,t.slice(r,n+1))}},_observeCollection:function(){this._collection.subscribe("spliceItems",this._handleCollectionSpliceItems,this);if(this._sameOrder)this._collection.subscribe("reorderItems",this._handleCollectionReorderItems,this);this._subscribeCollectionItems(this._collection)},_unobserveCollection:function(){this._collection.unsubscribe("spliceItems",this._handleCollectionSpliceItems,this);if(this._sameOrder)this._collection.unsubscribe("reorderItems",this._handleCollectionReorderItems,this);this._unsubscribeCollectionItems(this._collection)},_subscribeCollectionItems:function(e,t,i,r){if(!this._valueProperty)t=true;var n,s,o;o=r?"unsubscribe":"subscribe";if(!this._selectedProperty)i=true;if(t&&i)return;if(!t)n=this._valueProperty+"Change";if(!i)s=this._selectedProperty+"Change";for(var a=0,l=e.length;a<l;a++){var h=e[a];if(!h[o])continue;if(r||h.hasEvent){if(n&&(r||h.hasEvent(n))){h[o](n,this._handleItemValuePropertyChange,this)}if(s&&(r||h.hasEvent(s)))h[o](s,this._handleItemSelectedPropertyChange,this)}}},canAccept:function(e,t,i){i=i||{};if(!this._collection||!this._collection.hasItem(e)){i.error=Amm.Selection.ERR_NOT_IN_OBSERVED_COLLECTION;return false}return Amm.Collection.prototype.canAccept.call(this,e,t,i)},_unsubscribeCollectionItems:function(e,t,i){return this._subscribeCollectionItems(e,t,i,true)},_handleItemValuePropertyChange:function(e,t){var i=Amm.event.origin;var r=this.hasItem(i);var n=this._value;var s=Amm.Array.indexOf(e,this._collectValueProperty(this,false,i))>=0;if(s&&!r){this.accept(i)}else if(!s&&r){if(this._unselectOnItemValueChange){this.reject(i)}else{this._value=this._collectValueProperty(this,true);if(this._valueProperty&&this._subscribers.valueChange){this.outValueChange(this._value,n)}}}},_handleItemSelectedPropertyChange:function(e,t){this.beginUpdate();var i=Amm.event.origin;var r=this.hasItem(i);if(r&&!e){this.reject(i);this.endUpdate();return}else if(!r&&e){if(this._multiple)this.accept(i);else this.setItems([i])}this.endUpdate()},_subscribeFirst_valueChange:function(){if(this._valueProperty)this._value=this._collectValueProperty(this.getItems(),true);this._selfSubscribed=true;this.subscribe("itemsChange",this._handleSelfItemsChange,this)},_unsubscribeLast_valueChange:function(){this._selfSubscribed=false;this.unsubscribe("itemsChange",this._handleSelfItemsChange,this)},_handleSelfItemsChange:function(e,t){var i,r;if(!this._valueProperty){if(this._multiple){r=e;i=t}else{i=t[0]||null;r=e[0]||null}}else{if(this._value!==undefined){i=this._value}else{i=this._collectValueProperty(t,true)}this._value=r=this._collectValueProperty(e,true)}this.outValueChange(r,i)},_associate:function(e,t,i){var r;r=Amm.Collection.prototype._associate.call(this,e,t,i);if(!this._selfSubscribed)this._value=undefined;if(this._selectedProperty){Amm.setProperty(e,this._selectedProperty,true)}return r},_dissociate:function(e){var t;t=Amm.Collection.prototype._dissociate.call(this,e);if(!this._selfSubscribed)this._value=undefined;if(this._selectedProperty){Amm.setProperty(e,this._selectedProperty,false)}return t},_oldValue:null,_doBeginUpdate:function(){Amm.Collection.prototype._doBeginUpdate.call(this);this._oldValue=this.getValue();if(this._oldValue instanceof Array)this._oldValue=[].concat(this._oldValue)},_doEndUpdate:function(){this._suppressValueChangeEvent++;Amm.Collection.prototype._doEndUpdate.call(this);this._suppressValueChangeEvent--;if(this._updateLevel)return;var e=this.getValue(),t=this._oldValue;if(e instanceof Array&&t instanceof Array&&Amm.Array.equal(e,t))return;if(e===t)return;this.outValueChange(e,t)}};Amm.extend(Amm.Selection,Amm.Collection);Amm.ArrayMapper=function(e){this._srcEntries=[];this._destEntries=[];this.beginUpdate();Amm.WithEvents.call(this,e);this.endUpdate()};Amm.ArrayMapper.SORT_NONE=0;Amm.ArrayMapper.SORT_DIRECT=1;Amm.ArrayMapper.SORT_REVERSE=-1;Amm.ArrayMapper._SRC_ITEM=0;Amm.ArrayMapper._SRC_INDEX=1;Amm.ArrayMapper._SRC_REF_TO_DEST=2;Amm.ArrayMapper._DEST_REF_TO_SRC=0;Amm.ArrayMapper._DEST_PASS=1;Amm.ArrayMapper._DEST_SORT_VALUE=2;Amm.ArrayMapper._DEST_IN_SLICE=3;Amm.ArrayMapper._DEST_ITEM=4;Amm.ArrayMapper.prototype={"Amm.ArrayMapper":"__CLASS__",_src:null,_srcIsOwn:null,_dest:null,_destIsOwn:false,_srcPrototype:null,_destPrototype:null,srcClass:"Amm.Array",destClass:"Amm.Array",_filter:null,_filterIsFn:null,_sort:Amm.ArrayMapper.SORT_DIRECT,_sortIsFn:null,_offset:0,_length:undefined,_hasSlice:false,_instantiator:null,_instantiatorIsFn:null,_srcEntries:null,_destEntries:null,_destExtra:null,_updateLevel:0,_applyFilter:false,_applySort:false,_applySlice:false,setSrc:function(e){if(e instanceof Array){if(this._src&this._srcIsOwn){return this._src.setItems(e)}else{e=this._createSrc(e)}}else if(!e){e=this._createSrc()}var t=this._src;if(t===e)return;Amm.is(e,this.srcClass,"src");Amm.is(e,"Amm.Array","src");this._srcIsOwn=e._ammArrayMapper===this;this._src=e;if(e)this._subscribeSrc(e);if(this._dest){this._rebuild()}if(e)this._subscribeSrc(e);this.outSrcChange(e,t);if(t)this._cleanupCollectionIfOwn(t);return true},getSrc:function(){if(!this._src)this.setSrc(null);return this._src},outSrcChange:function(e,t){this._out("srcChange",e,t)},setSrcPrototype:function(e){var t=this._srcPrototype;if(t===e)return;this._srcPrototype=e;return true},getSrcPrototype:function(){return this._srcPrototype},getSrcIsOwn:function(){return this._srcIsOwn},_createSrc:function(e){var t=this._srcPrototype?Amm.override({},this._srcPrototype):{};if(e)t.items=e;var i=Amm.constructInstance(t,this.srcClass);i._ammArrayMapper=this;return i},setDest:function(e){if(!e){e=this._createDest()}var t=this._dest;if(t===e)return;Amm.is(e,this.destClass,"dest");Amm.is(e,"Amm.Array","dest");this._destIsOwn=e._ammArrayMapper===this;this._dest=e;this._rebuild();this.outDestChange(e,t);if(t)this._cleanupCollectionIfOwn(t);return true},setDestExtra:function(e){if(e===this._destExtra)return;if(e instanceof Array&&!e.length)e=null;else if(!e)e=null;if(this._destExtra instanceof Array&&e instanceof Array&&Amm.Array.equal(e,this._destExtra))return;this._destExtra=e;this._remap()},getDestExtra:function(){return this._destExtra},getDest:function(){if(!this._dest)this.setDest(null);return this._dest},outDestChange:function(e,t){this._out("destChange",e,t)},setDestPrototype:function(e){var t=this._destPrototype;if(t===e)return;this._destPrototype=e;return true},getDestPrototype:function(){return this._destPrototype},getDestIsOwn:function(){return this._destIsOwn},_createDest:function(){var e=this._destPrototype?this._destPrototype:{};var t=Amm.constructInstance(e,this.destClass);t._ammArrayMapper=this;return t},setFilter:function(e){if(!e)e=null;var t=this._filter;if(t===e)return;if(!e){}else if(typeof e==="object"){e=Amm.constructInstance(e,"Amm.Filter",e);this._filterIsFn=false}else if(typeof e==="function"){this._filterIsFn=true}else throw Error("`filter` must be an object, a function or a null");if(this._filter&&!this._filterIsFn)this._unsubscribeFilter();this._filter=e;if(this._filter&&!this._filterIsFn)this._subscribeFilter();this.applyFilter();return true},_subscribeFilter:function(){if(this._src)this._filter.setObservedObjects(this._src.getItems());this._filter.subscribe("matchesChange",this._handleFilterMatchesChange,this)},_unsubscribeFilter:function(){this._filter.unsubscribe("matchesChange",this._handleFilterMatchesChange,this);this._filter.setObservedObjects([])},_subscribeSort:function(){if(this._src)this._sort.setObservedObjects(this._src.getItems());this._sort.subscribe("matchesChange",this._handleSortMatchesChange,this);this._sort.subscribe("needSort",this._handleSortNeedSort,this)},_unsubscribeSort:function(){this._sort.unsubscribe("matchesChange",this._handleFilterMatchesChange,this);this._sort.unsubscribe("needSort",this._handleSortNeedSort,this);this._sort.setObservedObjects([])},_handleFilterMatchesChange:function(e,t){if(e.length>1)this.beginUpdate();var i,r;for(i=0,r=e.length;i<r;i++){var n=e[i],s=t[i];if(s!==undefined)this.applyFilter(n,s)}if(e.length>1)this.endUpdate()},_handleSortMatchesChange:function(e,t){if(e.length>1)this.beginUpdate();var i,r;for(i=0,r=e.length;i<r;i++){var n=e[i],s=t[i];if(s!==undefined)this.applySort(n,s)}if(e.length>1)this.endUpdate()},_handleSortNeedSort:function(){this._remap()},getFilter:function(){return this._filter},applyFilter:function(e,t){if(!this._src)return;if(e===undefined){if(this._updateLevel)this._applyFilter=true;else{this._recalcAllFilter();this._remap()}return}if(!this._filter)return;var i=0;while((i=Amm.Array.indexOf(e,this._src,i))>=0){var r=this._srcEntries[i][Amm.ArrayMapper._SRC_REF_TO_DEST];var n=r[Amm.ArrayMapper._DEST_PASS];var s=t===undefined?this._getFilterValue(r[Amm.ArrayMapper._DEST_ITEM]):t;if(n!=s&&this._instantiator&&this._instantiator["Amm.Instantiator.Variants"]&&!this._instantiator.getFilter()){this._instantiator.setMatches([e],[s])}if(!!n!==!!s){r[Amm.ArrayMapper._DEST_PASS]=s;if(!this._updateLevel)this._remap()}if(this._src.getUnique())break}},setSort:function(e){if(!e)e=null;var t=this._sort;if(t===e)return;if(!e){}else if(typeof e==="object"){e=Amm.constructInstance(e,"Amm.Sorter");this._sortIsFn=false;if(this._sort&&this._sort["Amm.Sorter"])this._unsubscribeSort()}else if(typeof e==="function"){this._sortIsFn=true}else if(!(e===Amm.ArrayMapper.SORT_DIRECT||e===Amm.ArrayMapper.SORT_REVERSE)){throw Error("`sort` must be an object, a function, Amm.ArrayMapper.SORT_ constant or a null")}this._sort=e;if(e&&e["Amm.Sorter"])this._subscribeSort();this.applySort();return true},getSort:function(){return this._sort},applySort:function(e,t){if(!this._src)return;if(e===undefined){if(this._updateLevel)this._applySort=true;else{this._recalcAllSort();this._remap()}return}if(!this._sort)return;var i=0;while((i=Amm.Array.indexOf(e,this._src,i))>=0){var r=this._srcEntries[i][Amm.ArrayMapper._SRC_REF_TO_DEST];var n=r[Amm.ArrayMapper._DEST_SORT_VALUE];var s=t===undefined?this._getSortValue(i):t;if(n!==s){r[Amm.ArrayMapper._DEST_SORT_VALUE]=t;if(!this._updateLevel)this._remap()}if(this._src.getUnique())break}},_recalcAllSort:function(){var e,t,i;for(var r=0,n=this._destEntries.length;r<n;r++){e=this._destEntries[r][Amm.ArrayMapper._DEST_REF_TO_SRC];if(!this._sort)i=null;else{i=this._getSortValue(e[Amm.ArrayMapper._SRC_ITEM],e[Amm.ArrayMapper._SRC_INDEX])}t=this._destEntries[r][Amm.ArrayMapper._DEST_SORT_VALUE]!==i;this._destEntries[r][Amm.ArrayMapper._DEST_SORT_VALUE]=i}this._applySort=false;if(this._sort&&t&&!this._updateLevel)this._remap()},_recalcAllFilter:function(){var e,t,i,r=[],n=[];var s;s=this._instantiator&&this._instantiator["Amm.Instantiator.Variants"]&&!this._instantiator.getFilter();for(var o=0,a=this._destEntries.length;o<a;o++){e=this._destEntries[o][Amm.ArrayMapper._DEST_REF_TO_SRC];if(!this._filter)i=true;else{i=this._getFilterValue(e[Amm.ArrayMapper._SRC_ITEM])}t=this._destEntries[o][Amm.ArrayMapper._DEST_PASS]!==i;if(t&&s){r.push(e[Amm.ArrayMapper._SRC_ITEM]);n.push(i)}this._destEntries[o][Amm.ArrayMapper._DEST_PASS]=i}this._applyFilter=false;if(r.length)this._instantiator.setMatches(r,n);if(t&&!this._updateLevel)this._remap()},_getSortValue:function(e,t){if(!this._sort)return null;if(this._sort===Amm.ArrayMapper.SORT_DIRECT)return t;if(this._sort===Amm.ArrayMapper.SORT_REVERSE)return-t;if(this._sortIsFn)return this._sort(e,t);return this._sort.calcSortValue(e,t)},setOffset:function(e){if(!e)e=0;if(typeof e!=="number"){e=parseInt(e)}if(isNaN(e))throw Error("`offset` must be a number");var t=this._offset;if(t===e)return;this._offset=e;var i=this._hasSlice;this._hasSlice=!(!this._offset&&this._length===null);if(this._hasSlice||i){if(this._updateLevel){this._applySlice=true}else{this._remap()}}this.outOffsetChange(e,t);return true},getOffset:function(){return this._offset},outOffsetChange:function(e,t){this._out("offsetChange",e,t)},setLength:function(e){if(e===null||e===undefined||e===false||e===""){e=null}else{if(typeof e!=="number")e=parseInt(e)}if(isNaN(e))throw Error("`length` must be null/undefined/false/empty string or a number");var t=this._length;if(t===e)return;this._length=e;var i=this._hasSlice;this._hasSlice=!(!this._offset&&this._length===null);if(this._hasSlice||i){if(this._updateLevel){this._applySlice=true}else{this._remap()}}this.outLengthChange(e,t);return true},getLength:function(){return this._length},outLengthChange:function(e,t){this._out("lengthChange",e,t)},setInstantiator:function(e){var t=this._instantiator;var i;if(!e)e=null;else if(typeof e==="function"){i=true}else if(typeof e==="object"){if(e["class"])e=Amm.constructInstance(e);Amm.meetsRequirements(e,[["construct","destruct"]],"instantiator");i=false}else{throw Error("`instantiator` must be an object, a function or a null")}if(t===e)return;this.beginUpdate();this._destructAll();this._unsubscribeInstantiator();this._instantiatorIsFn=i;this._instantiator=e;this._subscribeInstantiator();this._constructAll();this.endUpdate();return true},_subscribeInstantiator:function(){if(!(this._instantiator&&this._instantiator["Amm.Instantiator.Variants"]))return;this._instantiator.subscribe("needRebuild",this._handleInstantiatorNeedRebuild,this);if(this._filter&&this._filter["Amm.Filter"]){this._filter.subscribe("matchesChange",this._setInstantiatorMatches,this)}},_unsubscribeInstantiator:function(){if(!(this._instantiator&&this._instantiator["Amm.Instantiator.Variants"]))return;this._instantiator.unsubscribe("needRebuild",this._handleInstantiatorNeedRebuild,this);if(this._filter&&this._filter["Amm.Filter"]){this._filter.unsubscribe("matchesChange",this._setInstantiatorMatches,this)}},_setInstantiatorMatches:function(e,t,i){if(this._instantiator.getFilter())return;this._instantiator.handleFilterMatchesChange(e,t,i)},_handleInstantiatorNeedRebuild:function(e,t){var i,r,n,s,o,a=-1,l,h,u,f;h=this._src.getUnique();if(e.length>1||!h){this._dest.beginUpdate()}for(i=0,r=e.length;i<r;i++){u=t[i];if(!u)continue;l=e[i];while((n=Amm.Array.indexOf(l,this._src,n))>=0){s=this._srcEntries[n][Amm.ArrayMapper._SRC_REF_TO_DEST];o=s[Amm.ArrayMapper._DEST_ITEM];if(!o)continue;a=Amm.Array.indexOf(o,this._dest,a);if(a<0)continue;f=this._construct(l,u);this._dest.setItem(a,f);this._destruct(o);s[Amm.ArrayMapper._DEST_ITEM]=f;if(h)break}}if(e.length>1||!this._src.getUnique())this._dest.endUpdate()},_construct:function(e,t){if(!this._instantiator)return e;if(this._instantiatorIsFn)return this._instantiator(e,this);if(this._instantiator.getFilter){var i=this._instantiator.getFilter();if(i&&i!==this._filter)t=undefined}return this._instantiator.construct(e,t,this)},_destruct:function(e){if(!this._instantiator||this._instantiatorIsFn)return;return this._instantiator.destruct(e,this)},_destructAll:function(e){e=e||this._destEntries;if(!e)return;for(var t=0,i=this._destEntries.length;t<i;t++){var r=this._destEntries[t][Amm.ArrayMapper._DEST_ITEM];if(!r)continue;if(this._instantiator)this._destruct(r);e[t][Amm.ArrayMapper._DEST_ITEM]=null}},_constructAll:function(e){e=e||this._destEntries;if(!e)return;for(var t=0,i=e.length;t<i;t++){if(e[t][Amm.ArrayMapper._DEST_ITEM])continue;if(!e[t][Amm.ArrayMapper._DEST_IN_SLICE])continue;var r=e[t][Amm.ArrayMapper._DEST_REF_TO_SRC][Amm.ArrayMapper._SRC_ITEM];var n=e[t][Amm.ArrayMapper._DEST_PASS];var s=this._instantiator?this._construct(r,n):r;e[t][Amm.ArrayMapper._DEST_ITEM]=s}},getInstantiator:function(){return this._instantiator},_cleanupCollectionIfOwn:function(e){if(e&&e._ammArrayMapper===this){delete e._ammArrayMapper;e.cleanup();return true}},_subscribeSrc:function(e,t){var i=t?"unsubscribe":"subscribe";e[i]("spliceItems",this._handleSrcSpliceItems,this)},_getFilterValue:function(e){if(!this._filter)return true;if(this._filterIsFn)return this._filter(e,this);else return this._filter.getMatch(e)},getUpdateLevel:function(){return this._updateLevel},beginUpdate:function(){this._updateLevel++;if(this._dest)this._dest.beginUpdate()},endUpdate:function(){if(!this._updateLevel)throw Error("Call to endUpdate() w/o corresponding beginUpdate()");this._updateLevel--;if(!this._updateLevel){if(this._applyFilter)this._recalcAllFilter();if(this._applySort)this._recalcAllSort();this._remap()}if(this._dest&&this._dest.getUpdateLevel()>this._updateLevel)this._dest.endUpdate()},_handleSrcSpliceItems:function(e,t,i){this.beginUpdate();if(this._filter&&!this._filterIsFn)this._filter.beginUpdate();if(this._sort&&typeof this._sort==="object")this._sort.beginUpdate();var r=Amm.Array.calcChanges(t,i,this._src.getComparison(),e,this._src.getUnique());var n,s;var o=[],a,l,h,u,f,c,_,m,d,p;o.length=i.length;for(n=0,s=r.added.length;n<s;n++){a=r.added[n][0];l=r.added[n][1];u=[a,l,null];if(a&&typeof a==="object"){if(this._filter&&!this._filterIsFn)this._filter.observeObject(a);if(this._sort&&this._sort["Amm.Sorter"]){this._sort.observeObject(a)}}f=[u,m=this._filter?this._getFilterValue(a):true,this._getSortValue(a,l),d=this._hasSlice?undefined:true,null];f[Amm.ArrayMapper._DEST_ITEM]=null;this._destEntries.push(f);u[Amm.ArrayMapper._SRC_REF_TO_DEST]=f;o[l-e]=u}for(n=0,s=r.deleted.length;n<s;n++){a=r.deleted[n][0];l=r.deleted[n][1];u=this._srcEntries[l];f=u[Amm.ArrayMapper._SRC_REF_TO_DEST];_=f[Amm.ArrayMapper._DEST_REF_TO_SRC];if(_!==undefined){if(_!==a&&this._instantiator)this._destruct(_)}f.splice(0,f.length);c=Amm.Array.indexOf(f,this._destEntries);u.splice(0,u.length);if(c>=0)this._destEntries.splice(c,1);if(a&&typeof a==="object"){if(this._filter&&!this._filterIsFn)this._filter.unobserveObject(a);if(this._sort&&this._sort["Amm.Sorter"])this._sort.unobserveObject(a)}}for(n=0,s=r.moved.length;n<s;n++){a=r.moved[n][0];l=r.moved[n][1];h=r.moved[n][1];u=this._srcEntries[l];u[Amm.ArrayMapper._SRC_INDEX]=h;f=u[Amm.ArrayMapper._SRC_REF_TO_DEST];f[Amm.ArrayMapper._DEST_SORT_VALUE]=this._getSortValue(a,h);o[h-e]=u}for(n=0,s=r.same.length;n<s;n++){l=r.same[n][1];u=this._srcEntries[l];o[l-e]=u}if(t.length!==i.length){p=i.length-t.length;for(n=e+t.length;n<this._srcEntries.length;n++){u=this._srcEntries[n];u[Amm.ArrayMapper._SRC_INDEX]=n+p;if(this._sort){a=u[Amm.ArrayMapper._SRC_ITEM];f=u[Amm.ArrayMapper._SRC_REF_TO_DEST];f[Amm.ArrayMapper._DEST_SORT_VALUE]=this._getSortValue(a,n+p)}}}this._srcEntries.splice.apply(this._srcEntries,[e,t.length].concat(o));this._remap();if(this._sort&&typeof this._sort==="object")this._sort.endUpdate();if(this._filter&&!this._filterIsFn)this._filter.endUpdate();this.endUpdate()},_cleanAll:function(){if(!this._srcEntries)return;var e,t,i,r,n;for(e=this._srcEntries.length-1;e>=0;e--){i=this._srcEntries[e];r=i[Amm.ArrayMapper._SRC_REF_TO_DEST];n=r[Amm.ArrayMapper._DEST_ITEM];if(this._instantiator&&!this._instantiatorIsFn&&n&&n!==i[Amm.ArrayMapper._SRC_ITEM]){this._destruct(n)}i.splice(0,i.length);r.splice(0,r.length);if(this._dest)this._dest.setItems([]||this._destExtra)}this._srcEntries=[];this._destEntries=[]},_rebuild:function(){this.beginUpdate();this._cleanAll();if(this._src)this._handleSrcSpliceItems(0,[],this._src.getItems());this.endUpdate()},_remap:function(){if(!this._destEntries)return;this._applySort=false;this._applyFilter=false;this._applySlice=false;var e=[],t,i,r,n,s=Amm.ArrayMapper._DEST_PASS,o=Amm.ArrayMapper._DEST_IN_SLICE,a=Amm.ArrayMapper._DEST_ITEM,l=Amm.ArrayMapper._DEST_REF_TO_SRC,h=Amm.ArrayMapper._SRC_ITEM,u;if(this._sort){u=Amm.ArrayMapper._DEST_SORT_VALUE;if(this._sort["Amm.Sorter"]){var f=this._sort;this._destEntries.sort(function(e,t){return f.compareMatches(e[u],t[u])})}else{this._destEntries.sort(function(e,t){return e[u]-t[u]})}}var c,e=[];if(this._hasSlice)c=[];for(t=0,r=this._destEntries.length;t<r;t++){n=this._destEntries[t];i=!this._filter||n[s];if(!i){n[o]=false;if(n[a]){if(this._instantiator)this._destruct(n[a]);n[a]=null}}else if(!this._hasSlice){n[o]=true;if(!n[a]){n[a]=this._instantiator?this._construct(n[l][h],i):n[l][h]}e.push(n[a])}else{n[o]=undefined;c.push(n)}}if(!this._hasSlice){if(this._destExtra){e=this._destExtra.concat(e)}this.getDest().setItems(e);return}var _=this._getSlice(c.length);var m=c.splice(_[0],_[1]-_[0]);for(t=0,r=m.length;t<r;t++){n=m[t];n[o]=true;if(!n[a]){n[a]=this._instantiator?this._construct(n[l][h],n[s]):n[l][h]}e.push(n[a])}for(t=0,r=c.length;t<r;t++){n=c[t];n[o]=false;if(n[a]){if(this._instantiator)this._destruct(n[a]);n[a]=null}}if(this._destExtra){e=this._destExtra.concat(e)}this.getDest().setItems(e)},_getSlice:function(e){var t=this._offset,i=this._length;if(i===0)return[0,0];var r=t||0;if(r<0)r=e+r;if(r<0)r=0;var n;if(!i)n=e;else if(i<0){n=e+i;if(n<0)n=0}else n=r+i;if(n<r)return[0,0];return[r,n]},cleanup:function(){if(this._filter&&!this._filterIsFn){this._unsubscribeFilter();this._filter=null}if(this._sort&&this._sort["Amm.Sorter"]){this._unsubscribeSort();this._sort=null}this._cleanAll();if(this._src)this._cleanupCollectionIfOwn(this._src);if(this._dest)this._cleanupCollectionIfOwn(this._dest);Amm.WithEvents.prototype.cleanup.call(this)},_getArrayItems:function(e,t){return e.map(function(e){return e?e[t]:undefined})}};Amm.extend(Amm.ArrayMapper,Amm.WithEvents);